/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
        (c) Copyright 2009-2021 SAP SE. All rights reserved
    
 */
sap.ui.define(["./NavError","./SelectionVariant","./library","sap/ui/base/Object","sap/ui/core/UIComponent","sap/ui/core/routing/HashChanger","sap/base/util/extend","sap/base/util/isEmptyObject","sap/base/Log","sap/base/assert","sap/base/util/merge","sap/ui/thirdparty/URI","sap/ui/util/openWindow"],function(e,t,a,n,r,i,o,s,l,p,c,f,u){"use strict";var v=a.NavType;var d=a.ParamHandlingMode;var h=a.SuppressionBehavior;var m=a.Mode;return n.extend("sap.fe.navigation.NavigationHandler",{metadata:{publicMethods:["navigate","parseNavigation","storeInnerAppState","storeInnerAppStateAsync","storeInnerAppStateWithImmediateReturn","processBeforeSmartLinkPopoverOpens","processBeforeSemanticLinkPopoverOpens","mixAttributesAndSelectionVariant","setModel","getTechnicalParameters","setTechnicalParameters","replaceHash","constructContextUrl"]},constructor:function(t,a,n){if(!t){throw new e("NavigationHandler.INVALID_INPUT")}if(t instanceof r){this.oRouter=t.getRouter();this.oComponent=t}else{if(typeof t.getOwnerComponent!=="function"){throw new e("NavigationHandler.INVALID_INPUT")}this.oRouter=this._getRouter(t);this.oComponent=t.getOwnerComponent()}if(this.oComponent&&this.oComponent.getAppComponent){this.oComponent=this.oComponent.getAppComponent()}if(typeof this.oRouter==="undefined"||typeof this.oComponent==="undefined"||typeof this.oComponent.getComponentData!=="function"){throw new e("NavigationHandler.INVALID_INPUT")}this.IAPP_STATE="sap-iapp-state";this.sDefaultedParamProp="sap-ushell-defaultedParameterNames";this.sSAPSystemProp="sap-system";this._aTechnicalParamaters=["hcpApplicationId"];this._oLastSavedInnerAppData={sAppStateKey:"",oAppData:{},iCacheHit:0,iCacheMiss:0};this._rIAppStateOld=new RegExp("/"+this.IAPP_STATE+"=([^/?]+)");this._rIAppStateOldAtStart=new RegExp("^"+this.IAPP_STATE+"=([^/?]+)");this._rIAppStateNew=new RegExp("[?&]"+this.IAPP_STATE+"=([^&]+)");if(n===d.URLParamWins||n===d.InsertInSelOpt){this.sParamHandlingMode=n}else{this.sParamHandlingMode=d.SelVarWins}if(a===m.ODataV2){this._sMode=a}},_getAppNavigationService:function(){return sap.ushell.Container.getService("CrossApplicationNavigation")},_getAppNavigationServiceAsync:function(){return sap.ushell.Container.getServiceAsync("CrossApplicationNavigation").then(function(e){return e}).catch(function(){l.error("NavigationHandler: CrossApplicationNavigation is not available.");throw new e("NavigationHandler.NO.XAPPSERVICE")})},_getRouter:function(e){return r.getRouterFor(e)},registerNavigateCallback:function(e){this._navigateCallback=e},navigate:function(a,n,r,i,o,s,p){var c,f,v,d,h,m=false,S={},g=this;d=this.oComponent.getComponentData();if(d){h=d.startupParameters;if(h&&h["sap-ushell-next-navmode"]&&h["sap-ushell-next-navmode"].length>0){m=h["sap-ushell-next-navmode"][0]==="explace"}}if(p&&(p==="inplace"||p==="explace")){m=p==="explace"}else if(p){throw new e("NavigationHandler.INVALID_NAV_MODE")}if(s===undefined||s===null){v={}}else{v=s}if(typeof r==="string"){c=r}else if(typeof r==="object"){var y=this._splitInboundNavigationParameters(new t,r,[]).oNavigationSelVar;c=y.toJSONString()}else{throw new e("NavigationHandler.INVALID_INPUT")}S.selectionVariant=new t(c);if(typeof r==="string"){S.selectionVariant=this._removeTechnicalParameters(S.selectionVariant)}S.selectionVariant=S.selectionVariant&&S.selectionVariant.toJSONObject();S=this._removeMeasureBasedInformation(S);S=this._checkIsPotentiallySensitive(S);if(S.selectionVariant){f=this._getURLParametersFromSelectionVariant(new t(S.selectionVariant));c=new t(S.selectionVariant).toJSONString()}else{f={};c=null}var A={target:{semanticObject:a,action:n},params:f||{}};var _=function(e){if(!v.selectionVariant){v.selectionVariant=c}var t=function(){var t=e.hrefForExternalAsync(A,g.oComponent);t.then(function(e){u(e)}).catch(function(e){l.error("Error while retireving hrefForExternal : "+e)})};v=g._removeMeasureBasedInformation(v);return g._fnSaveAppStateAsync(v,o).then(function(a){if(a){A.appStateKey=a.appStateKey;if(p=="explace"){t()}else{var n=e.toExternal(A,g.oComponent);if(g._navigateCallback){g._navigateCallback(n)}}}})};var V=function(e){g.storeInnerAppStateAsync(i,true).then(function(t){if(t){g.replaceHash(t)}return _(e)}).catch(function(e){if(o){o(e)}})};if(p){A.params["sap-ushell-navmode"]=m?"explace":"inplace"}g._getAppNavigationServiceAsync().then(function(t){var a=t.isNavigationSupported([A],g.oComponent);a.done(function(a){if(a[0].supported){if(!m){V(t)}else{_(t)}}else if(o){var n=new e("NavigationHandler.isIntentSupported.notSupported");o(n)}});if(o){a.fail(function(){var e=g._createTechnicalError("NavigationHandler.isIntentSupported.failed");o(e)})}}).catch(function(e){o(e)})},parseNavigation:function(){var e=i.getInstance().getHash();var a=this._getInnerAppStateKey(e);var n=this.oComponent.getComponentData();if(n===undefined){l.warning("The navigation Component's data was not set properly; assuming instead that no parameters are provided.");n={}}var r=n.startupParameters;var o=[];if(r&&r[this.sDefaultedParamProp]&&r[this.sDefaultedParamProp].length>0){o=JSON.parse(r[this.sDefaultedParamProp][0])}var s=jQuery.Deferred();var p=this;var c=function(e,a,n,r){var i=p._splitInboundNavigationParameters(new t,e,a);if(i.oNavigationSelVar.isEmpty()&&i.oDefaultedSelVar.isEmpty()){if(r===v.xAppState){var o=p._createTechnicalError("NavigationHandler.getDataFromAppState.failed");n.reject(o,e||{},v.xAppState)}else{n.resolve({},e,v.initial)}}else{var s={};s.selectionVariant=i.oNavigationSelVar.toJSONString();s.oSelectionVariant=i.oNavigationSelVar;s.oDefaultedSelectionVariant=i.oDefaultedSelVar;s.bNavSelVarHasDefaultsOnly=i.bNavSelVarHasDefaultsOnly;n.resolve(s,e,r)}};if(a){this._loadAppState(a,s)}else{var f=n["sap-xapp-state"]!==undefined;if(f){var u=this;this._getAppNavigationServiceAsync().then(function(e){var a=e.getStartupAppState(u.oComponent);a.done(function(e){var a=e.getData();var n;if(a){try{a=JSON.parse(JSON.stringify(a))}catch(e){n=p._createTechnicalError("NavigationHandler.AppStateData.parseError");s.reject(n,r,v.xAppState);return s.promise()}}if(a){var i=new t(a.selectionVariant);var l=p._splitInboundNavigationParameters(i,r,o);a.selectionVariant=l.oNavigationSelVar.toJSONString();a.oSelectionVariant=l.oNavigationSelVar;a.oDefaultedSelectionVariant=l.oDefaultedSelVar;a.bNavSelVarHasDefaultsOnly=l.bNavSelVarHasDefaultsOnly;s.resolve(a,r,v.xAppState)}else if(r){c(r,o,s,v.xAppState)}else{n=p._createTechnicalError("NavigationHandler.getDataFromAppState.failed");s.reject(n,r||{},v.xAppState)}});a.fail(function(){var e=p._createTechnicalError("NavigationHandler.getStartupState.failed");s.reject(e,{},v.xAppState)})}).catch(function(){var e=p._createTechnicalError("NavigationHandler._getAppNavigationServiceAsync.failed");s.reject(e,{},v.xAppState)})}else if(r){c(r,o,s,v.URLParams)}else{s.resolve({},{},v.initial)}}return s.promise()},setTechnicalParameters:function(t){if(!t){t=[]}if(!Array.isArray(t)){l.error("NavigationHandler: parameter incorrect, array of strings expected");throw new e("NavigationHandler.INVALID_INPUT")}this._aTechnicalParamaters=t},getTechnicalParameters:function(){return this._aTechnicalParamaters.concat([])},_isTechnicalParameter:function(e){if(e){if(!(e==="sap-ui-fe-variant-id"||e==="sap-ui-fe-table-variant-id"||e==="sap-ui-fe-chart-variant-id"||e==="sap-ui-fe-filterbar-variant-id")){if(e.toLowerCase().indexOf("sap-")===0){return true}else if(this._aTechnicalParamaters.indexOf(e)>=0){return true}}}return false},_isFEParameter:function(e){return e.toLowerCase().indexOf("sap-ui-fe")===0},_removeTechnicalParameters:function(e){var t,a;var n=e.getSelectOptionsPropertyNames();for(a=0;a<n.length;a++){t=n[a];if(this._isTechnicalParameter(t)){e.removeSelectOption(t)}}return e},_splitInboundNavigationParameters:function(a,n,r){if(!Array.isArray(r)){throw new e("NavigationHandler.INVALID_INPUT")}var i,o;var s={};for(i in n){if(!n.hasOwnProperty(i)){continue}if(this._isTechnicalParameter(i)||this._isFEParameter(i)){continue}if(typeof n[i]==="string"){s[i]=n[i]}else if(Array.isArray(n[i])&&n[i].length===1){s[i]=n[i][0]}else if(Array.isArray(n[i])&&n[i].length>1){s[i]=n[i]}else{throw new e("NavigationHandler.INVALID_INPUT")}}var l=new t;var p=new t;var c=a.getParameterNames().concat(a.getSelectOptionsPropertyNames());for(o=0;o<c.length;o++){i=c[o];if(i in s){if(r.indexOf(i)>-1){p.massAddSelectOption(i,a.getValue(i));this._addParameterValues(l,i,"I","EQ",s[i])}else{switch(this.sParamHandlingMode){case d.SelVarWins:p.massAddSelectOption(i,a.getValue(i));break;case d.URLParamWins:this._addParameterValues(p,i,"I","EQ",s[i]);break;case d.InsertInSelOpt:p.massAddSelectOption(i,a.getValue(i));this._addParameterValues(p,i,"I","EQ",s[i]);break;default:throw new e("NavigationHandler.INVALID_INPUT")}}}else if(r.indexOf(i)>-1){l.massAddSelectOption(i,a.getValue(i))}else{p.massAddSelectOption(i,a.getValue(i))}}for(i in s){if(c.indexOf(i)>-1){continue}if(r.indexOf(i)>-1){this._addParameterValues(l,i,"I","EQ",s[i])}else{this._addParameterValues(p,i,"I","EQ",s[i])}}var f=false;if(p.isEmpty()){f=true;var u=l.getSelectOptionsPropertyNames();for(o=0;o<u.length;o++){p.massAddSelectOption(u[o],l.getValue(u[o]))}}return{oNavigationSelVar:p,oDefaultedSelVar:l,bNavSelVarHasDefaultsOnly:f}},_addParameterValues:function(e,t,a,n,r){if(Array.isArray(r)){for(var i=0;i<r.length;i++){e.addSelectOption(t,a,n,r[i])}}else{e.addSelectOption(t,a,n,r)}},replaceHash:function(e){var t=this.oRouter.oHashChanger?this.oRouter.oHashChanger:i.getInstance();var a=t.getHash();var n=this._replaceInnerAppStateKey(a,e);t.replaceHash(n)},storeInnerAppStateAsync:function(e,t,a){if(typeof t!=="boolean"){t=true}var n=this;var r=jQuery.Deferred();var o=function(e){var t=n.oRouter.oHashChanger?n.oRouter.oHashChanger:i.getInstance();var a=t.getHash();var r=n._replaceInnerAppStateKey(a,e);t.replaceHash(r)};if(s(e)){r.resolve("");return r.promise()}var p=this._oLastSavedInnerAppData.sAppStateKey;var c=JSON.stringify(e)===JSON.stringify(this._oLastSavedInnerAppData.oAppData);if(c&&p){this._oLastSavedInnerAppData.iCacheHit++;o(p);r.resolve(p);return r.promise()}this._oLastSavedInnerAppData.iCacheMiss++;var f=function(i){if(!a&&!t){o(i)}n._oLastSavedInnerAppData.oAppData=e;n._oLastSavedInnerAppData.sAppStateKey=i;r.resolve(i)};var u=function(e){r.reject(e)};this._saveAppStateAsync(e,f,u).then(function(e){if(e!==undefined){if(!a&&t){o(e)}}}).catch(function(){l.error("NavigationHandler._saveAppStateAsync failed")});return r.promise()},storeInnerAppState:function(e,t){l.error("Deprecated API call of 'sap.fe.navigation.NavigationHandler.storeInnerAppState'. Please use 'storeInnerAppStateAsync' instead",null,"sap.fe.navigation.NavigationHandler");if(typeof t!=="boolean"){t=true}var a=this;var n=jQuery.Deferred();var r=function(e){var t=a.oRouter.oHashChanger?a.oRouter.oHashChanger:i.getInstance();var n=t.getHash();var r=a._replaceInnerAppStateKey(n,e);t.replaceHash(r)};if(s(e)){n.resolve("");return n.promise()}var o=this._oLastSavedInnerAppData.sAppStateKey;var p=JSON.stringify(e)===JSON.stringify(this._oLastSavedInnerAppData.oAppData);if(p&&o){this._oLastSavedInnerAppData.iCacheHit++;r(o);n.resolve(o);return n.promise()}this._oLastSavedInnerAppData.iCacheMiss++;var c=function(i){if(!t){r(i)}a._oLastSavedInnerAppData.oAppData=e;a._oLastSavedInnerAppData.sAppStateKey=i;n.resolve(i)};var f=function(e){n.reject(e)};var u=this._saveAppState(e,c,f);if(u!==undefined){if(t){r(u)}}return n.promise()},storeInnerAppStateWithImmediateReturn:function(e,t){l.error("Deprecated API call of 'sap.fe.navigation.NavigationHandler.storeInnerAppStateWithImmediateReturn'. Please use 'storeInnerAppStateAsync' instead",null,"sap.fe.navigation.NavigationHandler");if(typeof t!=="boolean"){t=false}var a=this;var n=jQuery.Deferred();if(s(e)){return{appStateKey:"",promise:n.resolve("")}}var r=this._oLastSavedInnerAppData.sAppStateKey;var i=JSON.stringify(e)===JSON.stringify(this._oLastSavedInnerAppData.oAppData);if(i&&r){this._oLastSavedInnerAppData.iCacheHit++;return{appStateKey:r,promise:n.resolve(r)}}this._oLastSavedInnerAppData.iCacheMiss++;var o=function(r){if(!t){a.replaceHash(r)}a._oLastSavedInnerAppData.oAppData=e;a._oLastSavedInnerAppData.sAppStateKey=r;n.resolve(r)};var p=function(e){n.reject(e)};var c=this._saveAppState(e,o,p);return{appStateKey:c,promise:n.promise()}},processBeforeSmartLinkPopoverOpens:function(e,a,n,r){var i=jQuery.Deferred();var o;if(e!=undefined){o=e.semanticAttributes}var s,l=this;if(r===undefined){s={}}else{s=r}var p=function(a,n){n=s.selectionVariant||n||"{}";var r=h.raiseErrorOnNull|h.raiseErrorOnUndefined;var o=l.mixAttributesAndSelectionVariant(a,n,r);n=o.toJSONString();var p={};p.selectionVariant=o.toJSONObject();p=l._removeMeasureBasedInformation(p);p=l._checkIsPotentiallySensitive(p);a=p.selectionVariant?l._getURLParametersFromSelectionVariant(new t(p.selectionVariant)):{};var c=function(t){if(e===undefined){i.resolve(a,t)}else{e.setSemanticAttributes(a);e.setAppStateKey(t);e.open();i.resolve(e)}};var f=function(e){i.reject(e)};s.selectionVariant=n;s=l._removeMeasureBasedInformation(s);l._saveAppStateAsync(s,c,f)};if(n){var c=this.storeInnerAppStateAsync(n,true);c.done(function(){p(o,a)});c.fail(function(e){i.reject(e)})}else{p(o,a)}return i.promise()},_getAppStateKeyAndUrlParameters:function(e){return this.processBeforeSmartLinkPopoverOpens(undefined,e,undefined,undefined)},_mixAttributesToSelVariant:function(t,a,n){for(var r in t){if(t.hasOwnProperty(r)){var i=t[r];if(i instanceof Date){i=i.toJSON()}else if(Array.isArray(i)||i&&typeof i==="object"){i=JSON.stringify(i)}else if(typeof i==="number"||typeof i==="boolean"){i=i.toString()}if(i===""){if(n&sap.fe.navigation.SuppressionBehavior.ignoreEmptyString){l.info("Semantic attribute "+r+" is an empty string and due to the chosen Suppression Behiavour is being ignored.");continue}}if(i===null){if(n&sap.fe.navigation.SuppressionBehavior.raiseErrorOnNull){throw new e("NavigationHandler.INVALID_INPUT")}else{l.warning("Semantic attribute "+r+" is null and ignored for mix in to selection variant");continue}}if(i===undefined){if(n&sap.fe.navigation.SuppressionBehavior.raiseErrorOnUndefined){throw new e("NavigationHandler.INVALID_INPUT")}else{l.warning("Semantic attribute "+r+" is undefined and ignored for mix in to selection variant");continue}}if(typeof i==="string"||i instanceof String){a.addSelectOption(r,"I","EQ",i)}else{throw new e("NavigationHandler.INVALID_INPUT")}}}return a},mixAttributesAndSelectionVariant:function(e,a,n){var r=new t(a);var i=new t;var o=this;if(r.getFilterContextUrl()){i.setFilterContextUrl(r.getFilterContextUrl())}if(r.getParameterContextUrl()){i.setParameterContextUrl(r.getParameterContextUrl())}if(Array.isArray(e)){e.forEach(function(e){o._mixAttributesToSelVariant(e,i,n)})}else{this._mixAttributesToSelVariant(e,i,n)}var s=r.getParameterNames();var l;for(l=0;l<s.length;l++){if(!i.getSelectOption(s[l])){i.addSelectOption(s[l],"I","EQ",r.getParameter(s[l]))}}var p=r.getSelectOptionsPropertyNames();for(l=0;l<p.length;l++){var c=r.getSelectOption(p[l]);if(!i.getSelectOption(p[l])){for(var f=0;f<c.length;f++){i.addSelectOption(p[l],c[f].Sign,c[f].Option,c[f].Low,c[f].High)}}}return i},_ensureSelectionVariantFormatString:function(e){if(e===undefined){return undefined}var t=e;if(typeof e==="object"){t=JSON.stringify(e)}return t},_fnHandleAppStatePromise:function(e,t,a){e.promise.done(function(){if(t){t(e.appStateKey)}});if(a){var n=this;e.promise.fail(function(){var e=n._createTechnicalError("NavigationHandler.AppStateSave.failed");a(e)})}},_saveAppStateAsync:function(e,t,a){var n=this;return this._fnSaveAppStateAsync(e,a).then(function(e){if(e){n._fnHandleAppStatePromise(e,t,a);return e.appStateKey}return undefined})},_saveAppState:function(e,t,a){var n=this._saveAppStateWithImmediateReturn(e,a);if(n){this._fnHandleAppStatePromise(n,t,a);return n.appStateKey}return undefined},_fnSaveAppStateWithImmediateReturn:function(e,t,a){var n=t.getKey();var r=this._fetchAppDataForSave(e,a);if(!r){return undefined}t.setData(r);var i=t.save();return{appStateKey:n,promise:i.promise()}},_fetchAppDataForSave:function(e,t){var a={};if(e.hasOwnProperty("selectionVariant")){a.selectionVariant=e.selectionVariant;if(e.selectionVariant){if(typeof e.selectionVariant==="string"){try{a.selectionVariant=JSON.parse(e.selectionVariant)}catch(e){var n=this._createTechnicalError("NavigationHandler.AppStateSave.parseError");if(t){t(n)}return undefined}}}}if(this._sMode===m.ODataV2){a=o({selectionVariant:{},tableVariantId:"",customData:{}},a);if(e.tableVariantId){a.tableVariantId=e.tableVariantId}if(e.customData){a.customData=e.customData}if(e.presentationVariant){a.presentationVariant=e.presentationVariant}if(e.valueTexts){a.valueTexts=e.valueTexts}if(e.semanticDates){a.semanticDates=e.semanticDates}}else{var r=Object.assign({},e);a=c(r,a)}a=this._checkIsPotentiallySensitive(a);return a},_fnSaveAppStateAsync:function(e,t){var a=this;return this._getAppNavigationServiceAsync().then(function(e){return e.createEmptyAppStateAsync(a.oComponent)}).then(function(n){return a._fnSaveAppStateWithImmediateReturn(e,n,t)}).catch(function(e){if(t){t(e)}})},_saveAppStateWithImmediateReturn:function(e,t){var a=this._getAppNavigationService().createEmptyAppState(this.oComponent);return this._fnSaveAppStateWithImmediateReturn(e,a,t)},_loadAppState:function(e,a){var n=this;this._getAppNavigationServiceAsync().then(function(r){var i=r.getAppState(n.oComponent,e);i.done(function(r){var i={};var o=r.getData();if(typeof o==="undefined"){var s=n._createTechnicalError("NavigationHandler.getDataFromAppState.failed");a.reject(s,{},v.iAppState)}else if(n._sMode===m.ODataV2){i={selectionVariant:"{}",oSelectionVariant:new t,oDefaultedSelectionVariant:new t,bNavSelVarHasDefaultsOnly:false,tableVariantId:"",customData:{},appStateKey:e,presentationVariant:{},valueTexts:{},semanticDates:{}};if(o.selectionVariant){i.selectionVariant=n._ensureSelectionVariantFormatString(o.selectionVariant);i.oSelectionVariant=new t(i.selectionVariant)}if(o.tableVariantId){i.tableVariantId=o.tableVariantId}if(o.customData){i.customData=o.customData}if(o.presentationVariant){i.presentationVariant=o.presentationVariant}if(o.valueTexts){i.valueTexts=o.valueTexts}if(o.semanticDates){i.semanticDates=o.semanticDates}}else{i=c(i,o);if(o.selectionVariant){i.selectionVariant=n._ensureSelectionVariantFormatString(o.selectionVariant);i.oSelectionVariant=new t(i.selectionVariant)}}a.resolve(i,{},v.iAppState)});i.fail(function(){var e=n._createTechnicalError("NavigationHandler.getAppState.failed");a.reject(e,{},v.iAppState)})}).catch(function(){var e=n._createTechnicalError("NavigationHandler._getAppNavigationServiceAsync.failed");a.reject(e,{},v.iAppState)})},_getInnerAppStateKey:function(e){if(!e){return undefined}var t=this._rIAppStateNew.exec(e);if(t===null){t=this._rIAppStateOld.exec(e)}if(t===null){t=this._rIAppStateOldAtStart.exec(e)}if(t===null){return undefined}return t[1]},_replaceInnerAppStateKey:function(e,t){var a=this.IAPP_STATE+"="+t;if(!e){return"?"+a}var n=function(e){if(e.indexOf("?")!==-1){return e+"&"+a}return e+"?"+a};if(!this._getInnerAppStateKey(e)){return n(e)}if(this._rIAppStateNew.test(e)){return e.replace(this._rIAppStateNew,function(e){return e.replace(/\=.*/gi,"="+t)})}var r=function(e,t){t=t.replace(e,"");return n(t)};if(this._rIAppStateOld.test(e)){return r(this._rIAppStateOld,e)}if(this._rIAppStateOldAtStart.test(e)){return r(this._rIAppStateOldAtStart,e)}p(false,"internal inconsistency: Approach of sap-iapp-state not known, but _getInnerAppStateKey returned it");return undefined},_getURLParametersFromSelectionVariant:function(a){var n={};var r=0;var i;if(typeof a==="string"){i=new t(a)}else if(typeof a==="object"){i=a}else{throw new e("NavigationHandler.INVALID_INPUT")}var o=i.getSelectOptionsPropertyNames();for(r=0;r<o.length;r++){var s=i.getSelectOption(o[r]);if(s.length===1&&s[0].Sign==="I"&&s[0].Option==="EQ"){n[o[r]]=s[0].Low}}var l=i.getParameterNames();for(r=0;r<l.length;r++){var p=i.getParameter(l[r]);n[l[r]]=p}return n},_createTechnicalError:function(t){return new e(t)},setModel:function(e){this._oModel=e},_getModel:function(){return this._oModel||this.oComponent.getModel()},_removeAllProperties:function(e){if(e){if(e.selectionVariant){e.selectionVariant=null}if(e.valueTexts){e.valueTexts=null}if(e.semanticDates){e.semanticDates=null}}},_removeProperties:function(e,t,a){if(e.length&&a&&(a.selectionVariant||a.valueTexts||a.semanticDates)){e.forEach(function(e){if(a.selectionVariant.SelectOptions){a.selectionVariant.SelectOptions.some(function(t,n){if(e===t.PropertyName){a.selectionVariant.SelectOptions.splice(n,1);return true}return false})}if(a.valueTexts&&a.valueTexts.Texts){a.valueTexts.Texts.forEach(function(t){if(t.PropertyTexts){t.PropertyTexts.some(function(a,n){if(e===a.PropertyName){t.PropertyTexts.splice(n,1);return true}return false})}})}if(a.semanticDates&&a.semanticDates.Dates){a.semanticDates.Dates.forEach(function(t,n){if(e===t.PropertyName){a.semanticDates.Dates.splice(n,1)}})}})}if(t.length&&a&&a.selectionVariant&&a.selectionVariant.Parameters){t.forEach(function(e){a.selectionVariant.Parameters.some(function(t,n){if(e===t.PropertyName||"$Parameter."+e===t.PropertyName){a.selectionVariant.Parameters.splice(n,1);return true}return false})})}},_isTermTrue:function(e,t){var a=function(e){if(e){return e.Bool?e.Bool!=="false":true}return false};return!!e[t]&&a(e[t])},_isExcludedFromNavigationContext:function(e){return this._isTermTrue(e,"com.sap.vocabularies.UI.v1.ExcludeFromNavigationContext")},_isPotentiallySensitive:function(e){return this._isTermTrue(e,"com.sap.vocabularies.PersonalData.v1.IsPotentiallySensitive")},_isMeasureProperty:function(e){return this._isTermTrue(e,"com.sap.vocabularies.Analytics.v1.Measure")},_isToBeExcluded:function(e){return this._isPotentiallySensitive(e)||this._isExcludedFromNavigationContext(e)},constructContextUrl:function(t,a){if(!t){throw new e("NavigationHandler.NO_ENTITY_SET_PROVIDED")}if(a===undefined){a=this._getModel()}return this._constructContextUrl(a)+"#"+t},_constructContextUrl:function(e){var t;if(e&&e.isA("sap.ui.model.odata.v2.ODataModel")){t=e._getServerUrl()}else if(e&&e.isA("sap.ui.model.odata.v4.ODataModel")){var a=new f(e.sServiceUrl).absoluteTo(document.baseURI);t=new f("/").absoluteTo(a).toString()}if(t&&t.lastIndexOf("/")===t.length-1){t=t.substr(0,t.length-1)}return t+e.sServiceUrl+"/$metadata"},_checkIsPotentiallySensitive:function(e){var t=e;if(e&&e.selectionVariant&&(e.selectionVariant.FilterContextUrl&&e.selectionVariant.SelectOptions||e.selectionVariant.ParameterContextUrl&&e.selectionVariant.Parameters)){var a=this._getModel();if(this.oComponent&&a&&a.isA("sap.ui.model.odata.v2.ODataModel")){var n=[],r=[],i,s,p,c,f,u,v=[],d=[];s=a.getMetaModel();if(a.getServiceMetadata()&&s&&s.oModel){if(e.selectionVariant.FilterContextUrl){v=e.selectionVariant.FilterContextUrl.split("#")}if(v.length===2&&e.selectionVariant.SelectOptions&&this._constructContextUrl(a).indexOf(v[0])===0){p=s.getODataEntitySet(v[1]);if(p){c=s.getODataEntityType(p.entityType)}else{c=s.getODataEntityType(v[1])}if(c){if(c&&c.property){for(i=0;i<c.property.length;i++){if(this._isToBeExcluded(c.property[i])){n.push(c.property[i].name)}}}if(c.navigationProperty){for(i=0;i<c.navigationProperty.length;i++){u=s.getODataAssociationEnd(c,c.navigationProperty[i].name);if(!u||u.type===e.selectionVariant.FilterContextUrl){continue}if(u.multiplicity==="1"||u.multiplicity==="0..1"){f=s.getODataEntityType(u.type);if(f&&f.property){for(var h=0;h<f.property.length;h++){if(this._isToBeExcluded(f.property[h])){n.push(c.navigationProperty[i].name+"."+f.property[h].name)}}}}}}}}if(e.selectionVariant.ParameterContextUrl){d=e.selectionVariant.ParameterContextUrl.split("#")}if(d.length===2&&e.selectionVariant.Parameters&&this._constructContextUrl(a).indexOf(d[0])===0){p=s.getODataEntitySet(d[1]);if(p){c=s.getODataEntityType(p.entityType)}else{c=s.getODataEntityType(v[1])}if(c){if(c.property){for(i=0;i<c.property.length;i++){if(this._isToBeExcluded(c.property[i])){r.push(c.property[i].name)}}}}}if(n.length||r.length){t=o(true,{},t);this._removeProperties(n,r,t)}}else{this._removeAllProperties(t);l.error("NavigationHandler: oMetadata are not fully loaded!")}}else if(this.oComponent&&a&&a.isA("sap.ui.model.odata.v4.ODataModel")){return this._removeSensitiveDataForODataV4(t)}}return t},_removeMeasureBasedInformation:function(e){var t=e;if(e.selectionVariant){if(typeof e.selectionVariant==="string"){try{t.selectionVariant=JSON.parse(e.selectionVariant)}catch(e){l.error("NavigationHandler: _removeMeasureBasedInformation parse error")}}t=this._removeMeasureBasedProperties(t)}return t},_removeMeasureBasedProperties:function(e){var t=e,a=[],n=[];var r,i,s,p,c,f,u,v=[],d=[];if(e&&e.selectionVariant&&(e.selectionVariant.FilterContextUrl&&e.selectionVariant.SelectOptions||e.selectionVariant.ParameterContextUrl&&e.selectionVariant.Parameters)){i=this._getModel();if(this.oComponent&&i&&i.isA("sap.ui.model.odata.v2.ODataModel")){s=i.getMetaModel();if(i.getServiceMetadata()&&s&&s.oModel){if(e.selectionVariant.FilterContextUrl){v=e.selectionVariant.FilterContextUrl.split("#")}if(v.length===2&&e.selectionVariant.SelectOptions&&this._constructContextUrl(i).indexOf(v[0])===0){p=s.getODataEntitySet(v[1]);if(p){c=s.getODataEntityType(p.entityType)}else{c=s.getODataEntityType(v[1])}if(c){if(c&&c.property){for(r=0;r<c.property.length;r++){if(this._isMeasureProperty(c.property[r])){a.push(c.property[r].name)}}}if(c.navigationProperty){for(r=0;r<c.navigationProperty.length;r++){u=s.getODataAssociationEnd(c,c.navigationProperty[r].name);if(!u||u.type===e.selectionVariant.FilterContextUrl){continue}if(u.multiplicity==="1"||u.multiplicity==="0..1"){f=s.getODataEntityType(u.type);if(f&&f.property){for(var h=0;h<f.property.length;h++){if(this._isMeasureProperty(f.property[h])){a.push(c.navigationProperty[r].name+"."+f.property[h].name)}}}}}}}}if(e.selectionVariant.ParameterContextUrl){d=e.selectionVariant.ParameterContextUrl.split("#")}if(d.length===2&&e.selectionVariant.Parameters&&this._constructContextUrl(i).indexOf(d[0])===0){p=s.getODataEntitySet(d[1]);if(p){c=s.getODataEntityType(p.entityType)}else{c=s.getODataEntityType(v[1])}if(c){if(c.property){for(r=0;r<c.property.length;r++){if(this._isMeasureProperty(c.property[r])){n.push(c.property[r].name)}}}}}if(a.length||n.length){t=o(true,{},t);this._removeProperties(a,n,t)}}else{this._removeAllProperties(t);l.error("NavigationHandler: oMetadata are not fully loaded!")}}else if(this.oComponent&&i&&i.isA("sap.ui.model.odata.v4.ODataModel")){return this._removeSensitiveDataForODataV4(t,true)}}return t},_removeSensitiveDataForODataV4:function(e,a){var n=this,r,i=new t(e.selectionVariant),o=this._getModel();if(!o.getMetaModel().getObject("/")){this._removeAllProperties(e);l.error("NavigationHandler: oMetadata are not fully loaded!");return e}if(e.selectionVariant.FilterContextUrl){r=e.selectionVariant.FilterContextUrl.split("#")}if(r.length===2&&e.selectionVariant.SelectOptions&&this._constructContextUrl(o).indexOf(r[0])===0){i.removeSelectOption("@odata.context");i.removeSelectOption("@odata.metadataEtag");i.removeSelectOption("SAP__Messages");var s=r[1],p=o.getMetaModel(),c=i.getPropertyNames()||[],f=function(e,t,r){var i;t=t||s;i=p.getObject("/"+t+"/"+e+"@");if(i){if(a&&i["@com.sap.vocabularies.Analytics.v1.Measure"]||n._checkPropertyAnnotationsForSensitiveData(i)){return true}else if(i["@com.sap.vocabularies.Common.v1.FieldControl"]){var o=i["@com.sap.vocabularies.Common.v1.FieldControl"];if(o["$EnumMember"]&&o["$EnumMember"].split("/")[1]==="Inapplicable"){return true}}}return false};for(var u=0;u<c.length;u++){var v=c[u];if(f(v,s)){i.removeSelectOption(v)}}e.selectionVariant=i.toJSONObject()}return e},_checkPropertyAnnotationsForSensitiveData:function(e){return e["@com.sap.vocabularies.PersonalData.v1.IsPotentiallySensitive"]||e["@com.sap.vocabularies.UI.v1.ExcludeFromNavigationContext"]}})});
//# sourceMappingURL=NavigationHandler.js.map