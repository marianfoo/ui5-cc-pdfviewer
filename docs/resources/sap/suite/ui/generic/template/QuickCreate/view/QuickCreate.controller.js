sap.ui.define(["../../js/QuickTemplates/QuickActionBaseController","../../js/QuickTemplates/QuickCreateAPI","sap/m/MessageToast","../../js/QuickTemplates/AnnotationHelper","sap/ui/model/odata/AnnotationHelper","../../js/QuickTemplates/ODataModelHelper","sap/ui/model/json/JSONModel","sap/ui/model/Context","sap/base/util/each","sap/suite/ui/generic/template/genericUtilities/polyFill"],function(e,t,i,n,r,s,a,o,h){"use strict";var l=e.extend("sap.suite.ui.generic.template.QuickCreate.view.QuickCreate",{onInit:function(){if(!this._bIsInitialized){e.prototype.onInit.apply(this);this._focusableElement="";this.oQuickCreateAPI=this.oComponent.oQuickCreateAPI;this.oTransactionController=this.oComponent.getTransactionController();if(this.oQuickCreateAPI){this.oQuickCreateAPI.setRootView(this.getView())}this.sDraftEntityPath=this.oQuickCreateAPI?this.oQuickCreateAPI.getQuickCreateItem().draftid:undefined;this.bIsCreator=this.oQuickCreateAPI?this.oQuickCreateAPI.isCurrentUserCreator():true;this.sQuickCreateUserName=this.oQuickCreateAPI?this.oQuickCreateAPI.getQuickCreateItem().createdByName:"";this.bFormEnabled=this.bIsCreator;this._sDeferredGroupId="QuickCreateChanges";var t=new a({});this._sQuickCreateUIModelName="quickCreate";this.getView().setModel(t,this._sQuickCreateUIModelName);this.getView().getModel(this._sQuickCreateUIModelName).setProperty("/draftExists",true);this.getView().getModel(this._sQuickCreateUIModelName).setProperty("/quickCreateUser",this.sQuickCreateUserName);if(!this.bDraftEnabled){this.getView().getModel().setDeferredGroups([this._sDeferredGroupId])}if(this.oQuickCreateAPI){this.oQuickCreateAPI.attachAutofillLineItems(this._onLineItemsFound,this)}if(typeof this.oComponent.onQCViewInit==="function"){this.oComponent.onQCViewInit(this)}}},onExit:function(){if(this._bIsBeingDestroyed||this._bDestroyed){return}this._bIsBeingDestroyed=true;if(this.oQuickCreateAPI){this.oQuickCreateAPI.destroy()}if(e.prototype.onExit){e.prototype.onExit.apply(this)}this._bDestroyed=true;delete this._bIsBeingDestroyed},onBeforeRendering:function(){e.prototype.onBeforeRendering.apply(this);if(!this.getView().getModel("ui")){var t=new a({});this.getView().setModel(t,"ui")}this.getView().getModel("ui").setProperty("/enabled",this.bFormEnabled);this.getView().getModel("ui").setProperty("/editable",true);if(typeof this.oComponent.onQCBeforeRendering==="function"){this.oComponent.onQCBeforeRendering(this.getView())}},onAfterRendering:function(){this.getView().getModel("ui").setProperty("/createenabled",true);this._checkForMandatoryFields(true);if(this._focusableElement){this._focusableElement.focus();this._clearFocusableElement()}},_clearFocusableElement:function(){this._focusableElement=""},_onMetaModelLoaded:function(){var e=this;this.setBusy(true);if(this.sDraftEntityPath){var t=new o(this.getView().getModel(),this.sDraftEntityPath);if(this.bDraftEnabled&&!this.bIsCreator){t._bLocalBinding=true}else if(!this.bDraftEnabled){t._bLocalBinding=true}if(t._bLocalBinding){if(this.oQuickCreateAPI){this.oQuickCreateAPI.loadQuickCreateModelFromJSON().then(function(){if(t.getObject()){this.getView().getModel(this._sQuickCreateUIModelName).setProperty("/draftExists",true)}else{this.getView().getModel(this._sQuickCreateUIModelName).setProperty("/draftExists",false)}this.bindView(t)}.bind(this))}}else{this.getView().getModel().read(this.sDraftEntityPath,{success:function(e,i){this.getView().getModel(this._sQuickCreateUIModelName).setProperty("/draftExists",true);this.bindView(t)}.bind(this),error:function(e){this.getView().getModel(this._sQuickCreateUIModelName).setProperty("/draftExists",false);this.bindView(t)}.bind(this)})}}else if(this.bDraftEnabled){this.oDraftController.createNewDraftEntity(this.sEntitySet,"/"+this.sEntitySet).then(function(t){if(e.oQuickCreateAPI){e.oQuickCreateAPI.updateDraftID(t.context.getPath())}e.bindView(t.context)},this.onError.bind(this))}else{var i=this.getView().getModel().createEntry("/"+this.sEntitySet,{groupId:this._sDeferredGroupId});i._bLocalBinding=true;if(this.oQuickCreateAPI){this.oQuickCreateAPI.updateDraftID(i.getPath())}this._initializeObject(i,"FieldGroup");this.bindView(i)}},_checkForMandatoryFields:function(e){var t=true;var i=this.getView().byId("QuickCreateSmartForm").getSmartFields();for(var n=0;n<i.length;n++){if(i[n].getMandatory()&&i[n].getValue()===""){t=false;break}}if(t&&e){var r=this.getView().byId("QuickCreateSmartForm").check();if(r.length>0){t=false}}this.getView().getModel("ui").setProperty("/createenabled",t)},onChange:function(e){this._checkForMandatoryFields(false);if(this.bDraftEnabled){var t=this.getView().getElementBinding();var i=this;this.getView().getModel("ui").setProperty("/createenabled",false);var n=new Promise(function(i,n){var r=this.oComponent.getEntitySet();var s=e.getSource().getBindingPath("value");var a=e.getSource();var o=null;if(a){o=this.oComponent.getApplicationController()}else{o=this.oComponent.getTransactionController()}o.propertyChanged(r,s,t,a).then(function(){if(i){i()}},function(){if(n){n()}})}.bind(this));n.then(function(){i._checkForMandatoryFields(true);t.refresh()})}else{this._checkForMandatoryFields(true)}},onCreatePress:function(e){var t=this;this._createButton=e.getSource();this._createButton.setEnabled(false);this.setBusy(true);var n=function(e){t.setBusy(false);var n=null;var r=[];var a={key:"__metadata",matchCallback:function(e,t,i){r.push(t);return false}};s.findObjects(e,a);var l=t.oEntityTypeMeta.namespace+"."+t.oEntityTypeMeta.name;h(r,function(e,i){if(!n&&i.__metadata&&i.__metadata.type===l){var r=t.getView().getModel().getKey(i);n=new o(t.getView().getModel(),"/"+r)}});if(n){i.show(t.formatI18NMessage("QuickCreate_Success_CreateObject"));if(t.oQuickCreateAPI){t.oQuickCreateAPI.objectCreated(n)}}else{this._showErrorMessage({message:t.formatI18NMessage("QuickCreate_No_Created_Object")})}};var r=function(e){t.setBusy(false);if(t._createButton){t._createButton.setEnabled(true)}t.onError(e)};var a;if(this.bDraftEnabled){var l=function(){t.oDraftController.activateDraftEntity(t.getView().getBindingContext()).then(n,r)};if(typeof this.oComponent.onQCBeforeCreate==="function"){a=this.oComponent.onQCBeforeCreate(this.getView().getBindingContext(),this.getView().getBindingContext().getObject())}if(a&&a instanceof Promise){a.then(l,r)}else{l()}}else{var u=this.getView().getBindingContext();var c=this.getView().getModel().getProperty(u.getPath(),u,true);var d={key:"results",matchCallback:function(e,t,i){if(t.__nestedKey&&Array.isArray(i)){e[t.__nestedKey]=i}return true},maxNestedLevel:5};s.findObjects(c,d);d={key:"__metadata",matchCallback:function(e,t,i){delete t["__metadata"];return true},maxNestedLevel:5};s.findObjects(c,d);var f=function(){t.getView().getModel().create("/"+t.sEntitySet,c,{success:n,error:r})};if(typeof this.oComponent.onQCBeforeCreate==="function"){a=this.oComponent.onQCBeforeCreate(u,c)}if(a&&a instanceof Promise){a.then(f,r)}else{f()}}},onAddLineItemPress:function(e){this._getLineItemsTableFromEvent(e);var t=this;this._focusableElement=e.oSource;this.setBusy(true);var i=this.getView().getBindingContext();var n=function(e){t._createLineItem(i).then(function(e){t._refreshLineItems();if(t.oQuickCreateAPI){t.oQuickCreateAPI.calculateViewHeight(t.getView(),true)}t.setBusy(false)},t.onError.bind(t))};if(this.bDraftEnabled){this.oTransactionController.triggerSubmitChanges().then(function(e){n(e)},this.onError.bind(this))}else{n()}},onRemoveLineItemPress:function(e){var t=this;this.setBusy(true);var i=e.getSource().getBindingContext();if(this.bDraftEnabled){this.oTransactionController.triggerSubmitChanges().then(function(e){t._deleteLineItem(i)},function(e){this.setBusy(false);this.onError(e)}.bind(this))}else{this.getView().getModel().deleteCreatedEntry(i);this.setBusy(false);if(this.oQuickCreateAPI){this.oQuickCreateAPI.calculateViewHeight(this.getView(),false)}this._refreshLineItems()}},bindView:function(t){this.setBusy(false);if(this.getView().getModel(this._sQuickCreateUIModelName).getProperty("/draftExists")===false){return}if(t._bLocalBinding){this._setBindingContext(t);this._refreshLineItems()}else{e.prototype.bindView.apply(this,arguments)}this._updateFieldControl(t)},hasLineItemAnnotation:function(){var e=this._getFormatterInterface();var t=n.getMetaModelContextForFacetType(e,this.oEntityTypeMeta.namespace+"."+this.oEntityTypeMeta.name,"LineItem");return t!==null},_onLineItemsFound:function(e){if(!this.hasLineItemAnnotation()){return}var t=e.getParameter("numberOfLineItems");if(t<=0){return}this.setBusy(true);var i=this.getView().getBindingContext();var n=[];for(var r=0;r<t;r++){n.push(this._createLineItem(i))}Promise.all(n).then(function(e){this._refreshLineItems();this.setBusy(false)}.bind(this))},_createLineItem:function(e){var t=this;var i=this._getFormatterInterface(e);var s=this.getView().getModel().getMetaModel();var a=n.getMetaModelContextForFacetType(i,this.oEntityTypeMeta.namespace+"."+this.oEntityTypeMeta.name,"LineItem");var o=r.getNavigationPath(a);o=o.replace(/[{}]/g,"");var h=s.getODataAssociationEnd(this.oEntityTypeMeta,o);var l=s.getODataEntityType(h.type);if(this.bDraftEnabled){return this.oDraftController.createNewDraftEntity(l.name,e.sPath+"/"+o)}else{return new Promise(function(i,n){var r=t.getView().getModel().createEntry(e.sPath+"/"+o,{groupId:t._sDeferredGroupId});t._initializeObject(r,"LineItem");i(r)})}},_deleteLineItem:function(e){this.oTransactionController.deleteEntity(e).then(function(e){this._refreshLineItems();this.setBusy(false);if(this.oQuickCreateAPI){this.oQuickCreateAPI.calculateViewHeight(this.getView(),false)}}.bind(this),function(e){this.setBusy(false);this.onError(e)}.bind(this))},_onSmartFieldAfterRendering:function(e){if(typeof e.srcControl.setEnabled=="function"){e.srcControl.setEnabled(this.bFormEnabled)}if(this.oQuickCreateAPI){this.oQuickCreateAPI.calculateViewHeight(this.getView(),true)}document.querySelectorAll(".copilotQuickCreateContainerBox .sapQuickCreateFieldGroup label").forEach(function(e){e.style.textAlign=""});document.querySelectorAll(".sapQuickActionCreateButtonContainer > div").forEach(function(e){e.classList.add("sapUiSmallMarginEnd")});document.querySelectorAll(".sapQuickActionCreateButtonContainer .sapMBtnInner").forEach(function(e){e.style.padding="0"})},_refreshLineItems:function(){if(this._lineItemsTable){var e=this.getView().getBindingContext();if(e&&e._bLocalBinding){s.restoreLineItemReferences(this.oEntityTypeMeta.namespace+"."+this.oEntityTypeMeta.name,e);this._lineItemsTable.getModel().updateBindings()}else{this._lineItemsTable.getModel().refresh()}}},onTableUpdateStarted:function(e){this._getLineItemsTableFromEvent(e)},_getLineItemsTableFromEvent:function(e){if(!this._lineItemsTable&&e&&e.getSource){var t=e.getSource();while(t){if(t instanceof sap.m.Table){this._lineItemsTable=t;return}if(typeof t.getParent==="function"){t=t.getParent()}else{return}}}},onTableUpdateFinished:function(e){this._updateFieldControl()},_initializeObject:function(e,t){var i=this.getView().getBindingContext()?this.getView().getBindingContext():e;var r=n.getAllPropertyPathsFromFacet(i,t);if(r&&r.length>0){s.initializeObjectProperties(e,r,{groupId:this._sDeferredGroupId})}},_updateFieldControl:function(e){var t=e?e:this.getView().getBindingContext();if(t&&this.getView().getModel().getProperty(t.getPath()+"/Update_mc")!==undefined){this.getView().getModel().setProperty(t.getPath()+"/Update_mc",true)}}});return l},true);
//# sourceMappingURL=QuickCreate.controller.js.map