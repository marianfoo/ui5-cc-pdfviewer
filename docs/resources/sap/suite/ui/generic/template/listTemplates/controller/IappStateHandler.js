sap.ui.define(["sap/ui/base/Object","sap/ui/generic/app/navigation/service/SelectionVariant","sap/ui/Device","sap/ui/comp/state/UIState","sap/suite/ui/generic/template/listTemplates/listUtils","sap/ui/core/mvc/ControllerExtension","sap/suite/ui/generic/template/genericUtilities/FeLogger","sap/base/util/deepEqual","sap/base/util/extend","sap/base/util/deepExtend","sap/suite/ui/generic/template/genericUtilities/FeError","sap/suite/ui/generic/template/listTemplates/semanticDateRangeTypeHelper"],function(t,e,a,r,i,n,o,l,s,c,p,u){"use strict";var S="listTemplates.controller.IappStateHandler";var f=new o(S).getLogger();function m(t,o,m){var d=m.oServices.oApplication.getNavigationHandler();var g="sap.suite.ui.generic.template.customData";var v="sap.suite.ui.generic.template.genericData";var y="sap.suite.ui.generic.template.extensionData";var b="visual";var V="compact";var F;var C=false,h=false,D=null,P;var I=null;var O=m.oComponentUtils.getSettings();var w=null;var N={appStateKey:"",urlParams:{}};var M={};var A="sap-iapp-state";if(!t.oSmartFilterbar.isLiveMode()){t.oSmartFilterbar.setSuppressSelection(true)}var U=o.byId("template::Page");var T=m.oCommonUtils.getControlStateWrapper(U);T.attachStateChanged(function(){it()});var E,_;_=t.oSmartChart&&m.oCommonUtils.getControlStateWrapper(t.oSmartChart);E=t.oSmartTable&&m.oCommonUtils.getControlStateWrapper(t.oSmartTable);function x(){return F.then(function(){if(N.appStateKey){return{"sap-iapp-state":[N.appStateKey]}}return N.urlParams})}function B(e){if(e&&e.editStateFilter!==undefined){var r=o.byId("editStateFilter");if(r){r.setSelectedKey(e.editStateFilter===null?0:e.editStateFilter)}}var i=t.oController.getOwnerComponent().getModel("_templPriv");if(e.chartVariantId&&t.oSmartChart){t.oSmartChart.setCurrentVariantId(e.chartVariantId)}if(e.filterMode){i.setProperty("/alp/filterMode",e.filterMode);t.filterBarController.handleFilterSwitch(e.filterMode)}else{K()}if(e.contentView){var n=i.getProperty("/alp/enableHybridMode");if(n===false&&e.contentView==="charttable"){i.setProperty("/alp/contentView","chart")}else{(a.system.phone||a.system.tablet&&!a.system.desktop)&&e.contentView==="charttable"?i.setProperty("/alp/contentView","chart"):i.setProperty("/alp/contentView",e.contentView)}}if(e.autoHide){i.setProperty("/alp/autoHide",e.autoHide)}}function H(t){if(!t){return}var e=true;var a=function(a){if(!(a instanceof n)){throw new p(S,"State must always be retrieved with respect to a ControllerExtension")}var r=a.getMetadata().getNamespace();if(!e){throw new p(S,"State must always be restored synchronously")}return t[r]};o.templateBaseExtension.restoreExtensionAppStateData(a);e=false}function L(t){t=t||{};if(t.hasOwnProperty(g)&&t.hasOwnProperty(v)){B(t[v]);tt(t[g]);H(t[y])}else{if(t._editStateFilter!==undefined){B({editStateFilter:t._editStateFilter});delete t._editStateFilter}K();tt(t)}if(t[v]){if(t[v].variantDirty===undefined){t[v].variantDirty=true}o.byId("template::PageVariant")&&o.byId("template::PageVariant").currentVariantSetModified(t[v].variantDirty)}}function J(){var t=m.oComponentUtils.getTemplatePrivateModel();return t.getProperty("/generic/bDataAreShownInTable")}function k(e){if(t.oSmartFilterbar.isPending()){var a=function(r){var i=r.getParameters();if(!i.pendingValue){t.oSmartFilterbar.detachPendingChange(a);L(e)}};t.oSmartFilterbar.attachPendingChange(a)}else{L(e)}}function K(){var e=t.oController.getOwnerComponent().getModel("_templPriv"),a=t.oSmartFilterbar.isCurrentVariantStandard()?t.oController.getOwnerComponent().getDefaultFilterMode():e.getProperty("/alp/filterMode");if(!(a===b||a===V)){f.error("Defaulting to Visual filter due to incorrect value of defaultFilterMode in App descriptor");a=b}if(a===b&&t.hideVisualFilter){f.error("Visual filter is hidden defaulting to compact");a=V}t.filterBarController.setDefaultFilter(a)}function R(e){var a=t.oController.getOwnerComponent().getProperty("smartVariantManagement");if(a){var r=e["sap-ui-fe-variant-id"];if(r&&r[0]){t.oSmartFilterbar.getSmartVariant().setCurrentVariantId(r[0])}}else{var i=e["sap-ui-fe-variant-id"],n=e["sap-ui-fe-filterbar-variant-id"],o=e["sap-ui-fe-chart-variant-id"],l=e["sap-ui-fe-table-variant-id"];j(n&&n[0],o&&o[0],l&&l[0],i&&i[0])}}function j(e,a,r,i){if(e||i){t.oSmartFilterbar.getSmartVariant().setCurrentVariantId(e||i)}if(t.oSmartChart&&(a||i)){t.oSmartChart.attachAfterVariantInitialise(function(e){t.oSmartChart.setCurrentVariantId(a||i)});t.oSmartChart.setCurrentVariantId(a||i)}if(t.oSmartTable&&(r||i)){t.oSmartTable.attachAfterVariantInitialise(function(e){t.oSmartTable.setCurrentVariantId(r||i)});t.oSmartTable.setCurrentVariantId(r||i)}}function W(a,r,n){t.oSmartFilterbar.setSuppressSelection(false);var s=a.appStateKey||"";if(C){return}w=s;C=true;t.sNavType=n;var c=!s&&r||{};t.oSmartFilterbar.resumeSetFilterData();R(c);if(n!==sap.ui.generic.app.navigation.service.NavType.iAppState&&a.presentationVariant!==undefined){Q(a.presentationVariant)}if(n!==sap.ui.generic.app.navigation.service.NavType.initial){var p=a&&a.bNavSelVarHasDefaultsOnly;var S=new e(a.selectionVariant);var f=a.semanticDates;M=JSON.parse(a.selectionVariant);if(S.getSelectOptionsPropertyNames().indexOf("DisplayCurrency")===-1&&S.getSelectOptionsPropertyNames().indexOf("P_DisplayCurrency")===-1&&S.getParameterNames().indexOf("P_DisplayCurrency")===-1){X(S,a)}if(!p||t.oSmartFilterbar.isCurrentVariantStandard()){var d={selectionVariant:S,semanticDates:f};var g=t.oSmartFilterbar.getUiState();var y=new e(JSON.stringify(g.getSelectionVariant()));if(n!==sap.ui.generic.app.navigation.service.NavType.iAppState){t.oController.modifyStartupExtension(d);if(t.oSmartFilterbar.isCurrentVariantStandard()){d.semanticDates=u.addSemanticDateRangeDefaultValue(O,t.oSmartFilterbar,d.semanticDates,d.urlParameters||{});d.semanticDates.Dates.forEach(function(t){d.selectionVariant.addSelectOption(t.PropertyName,"I","EQ","")})}}var V=t.oSmartFilterbar.getAllFilterItems().map(function(t){return t.getName()});var F=a.oSelectionVariant.toJSONObject().SelectOptions.filter(function(t){return V.includes(t.PropertyName)});if(!G(y.toJSONObject().SelectOptions,F)){o.byId("template::PageVariant")&&o.byId("template::PageVariant").currentVariantSetModified(true)}if(p){var D=i.getMergedVariants([new e(JSON.stringify(t.oSmartFilterbar.getUiState().getSelectionVariant())),d.selectionVariant]);d.selectionVariant=D}rt(d.selectionVariant);at(d)}else{var P=new e(JSON.stringify(t.oSmartFilterbar.getUiState().getSelectionVariant())),A=P.getSelectOption("sap.suite.ui.generic.template.customData"),U=P.getSelectOption("sap.suite.ui.generic.template.genericData");x=t.oSmartFilterbar.getUiState().getSemanticDates();z(P,A,U,true);var d={selectionVariant:P,semanticDates:x};t.oController.modifyStartupExtension(d);if(t.oSmartFilterbar.isCurrentVariantStandard()){u.addSemanticDateRangeDefaultValue(O,t.oSmartFilterbar,d.semanticDates,d.urlParameters||{})}z(d.selectionVariant,A,U,false);if(!l(d.selectionVariant,new e(JSON.stringify(t.oSmartFilterbar.getUiState().getSelectionVariant())))){rt(d.selectionVariant);at(d)}}if(a.tableVariantId&&t.oSmartTable){t.oSmartTable.setCurrentVariantId(a.tableVariantId)}var T=t.oController.getOwnerComponent().getModel("_templPriv");if(n===sap.ui.generic.app.navigation.service.NavType.xAppState&&T.getProperty("/alp/filterMode")===b){et()}if(a.customData){var E=a.customData;k(E);if(E.hasOwnProperty(v)){var _=E[v];gt(_.controlStates)}}else{K()}if(!p){t.oSmartFilterbar.checkSearchAllowed(t);if(t.oController.getView().getModel("_templPriv").getProperty("/alp/searchable")){h=true;t.oSmartFilterbar.search()}}N={appStateKey:s,urlParams:c}}else{var S=new e(JSON.stringify(t.oSmartFilterbar.getUiState().getSelectionVariant())),A=S.getSelectOption("sap.suite.ui.generic.template.customData"),U=S.getSelectOption("sap.suite.ui.generic.template.genericData"),x=t.oSmartFilterbar.getUiState().getSemanticDates();z(S,A,U,true);var d={selectionVariant:S,semanticDates:x};t.oController.modifyStartupExtension(d);d.semanticDates=u.addSemanticDateRangeDefaultValue(O,t.oSmartFilterbar,d.semanticDates,d.urlParameters||{});d.semanticDates.Dates.forEach(function(t){d.selectionVariant.addSelectOption(t.PropertyName,"I","EQ","")});z(d.selectionVariant,A,U,false);if(!l(d.selectionVariant,new e(JSON.stringify(t.oSmartFilterbar.getUiState().getSelectionVariant())))){rt(d.selectionVariant);at(d)}if(t.oSmartFilterbar.isLiveMode()||t.oSmartFilterbar.isCurrentVariantExecuteOnSelectEnabled()){t.oSmartFilterbar.checkSearchAllowed(t);if(t.oController.getView().getModel("_templPriv").getProperty("/alp/searchable")){h=true}}K()}lt();I=null;if(!t.oSmartFilterbar.isLiveMode()){var B=dt();if(!B||!q()){m.oComponentUtils.hidePlaceholder()}}else{if(!q()){m.oComponentUtils.hidePlaceholder()}}if(!h){ut()}else{C=false}if(a.bNavSelVarHasDefaultsOnly){o.byId("template::PageVariant").currentVariantSetModified(true)}else{o.byId("template::PageVariant").currentVariantSetModified(false)}}function G(t,e){return l(t.map(JSON.stringify).sort(),e.map(JSON.stringify).sort())}function Q(e){var a=typeof e==="string"?JSON.parse(e):e;var r=a&&a.SortOrder;if(t.oSmartTable){var i=t.oTemplateUtils.oServices.oPresentationControlHandlerFactory.getPresentationControlHandler(t.oSmartTable);i.applyNavigationSortOrder(r)}if(t.oSmartChart){var n=t.oTemplateUtils.oServices.oPresentationControlHandlerFactory.getPresentationControlHandler(t.oSmartChart);n.applyNavigationSortOrder(r)}}function q(){var e=t.oSmartFilterbar.determineMandatoryFilterItems();var a=t.oSmartFilterbar.getFiltersWithValues();return e.every(function(t){return a.includes(t)})}function z(t,e,a,r){if(r){if(e){t.removeSelectOption("sap.suite.ui.generic.template.customData")}if(a){t.removeSelectOption("sap.suite.ui.generic.template.genericData")}}else{if(e){t.massAddSelectOption("sap.suite.ui.generic.template.customData",e)}if(a){t.massAddSelectOption("sap.suite.ui.generic.template.genericData",a)}}}function X(e,a){var r=t.oSmartFilterbar.determineMandatoryFilterItems(),i;for(var n=0;n<r.length;n++){if(r[n].getName().indexOf("P_DisplayCurrency")!==-1){if(a.oDefaultedSelectionVariant.getSelectOption("DisplayCurrency")&&a.oDefaultedSelectionVariant.getSelectOption("DisplayCurrency")[0].Low){i=a.oDefaultedSelectionVariant.getSelectOption("DisplayCurrency")[0].Low}if(i){e.addParameter("P_DisplayCurrency",i)}if(t.alr_visualFilterBar&&i){t.alr_visualFilterBar.setDisplayCurrency(i)}break}}}function Y(){var e={};e[g]={};var a=t.oController.getOwnerComponent().getModel("_templPriv");var r=t.chartController&&s({},t.chartController._chartInfo);if(r&&r.chartSelection){delete r.chartSelection}var i={};if(_){i[t.oSmartChart.getId()]=_.getState()}if(E){i[t.oSmartTable.getId()]=E.getState()}i[U.getId()]=T.getState();e[v]={chartVariantId:t.oSmartChart&&t.oSmartChart.getCurrentVariantId(),filterMode:a.getProperty("/alp/filterMode"),contentView:a.getProperty("/alp/contentView"),autoHide:a.getProperty("/alp/autoHide"),chartInfo:r,variantDirty:o.byId("template::PageVariant")&&o.byId("template::PageVariant").currentVariantGetModified(),controlStates:i};var l=o.byId("editStateFilter");if(l){e[v].editStateFilter=l.getSelectedKey()}o.getCustomAppStateDataExtension(e[g]);var c;var u=true;var f=function(t,e){if(!(t instanceof n)){throw new p(S,"State must always be set with respect to a ControllerExtension")}if(!u){throw new p(S,"State must always be provided synchronously")}if(e){c=c||Object.create(null);var a=t.getMetadata().getNamespace();c[a]=e}};o.templateBaseExtension.provideExtensionAppStateData(f);u=false;if(c){e[y]=c}return e}function Z(){return M}function $(){var e=t.oSmartFilterbar.getUiState(),a=e.getSelectionVariant(),r=e.getSemanticDates(),i=o.getVisibleSelectionsWithDefaults();for(var n=0;n<i.length;n++){if(!a.getValue(i[n])){a.addSelectOption(i[n],"I","EQ","")}}if(t.oController.byId("template::PageVariant").currentVariantGetModified()&&a.SelectionVariantID){a.SelectionVariantID=""}return{selectionVariant:JSON.stringify(a),semanticDates:r,tableVariantId:t.oSmartTable&&t.oSmartTable.getCurrentVariantId(),customData:Y()}}function tt(t){o.restoreCustomAppStateDataExtension(t||{})}function et(){var e=c({},t.oSmartFilterbar.getFilterData(true)),a=t.oController.getOwnerComponent().getModel("_filter");a.setData(e);t.filterBarController._updateFilterLink()}function at(e){t.oSmartFilterbar.clearVariantSelection();t.oSmartFilterbar.clear();P=e.selectionVariant;st(e.selectionVariant.toJSONObject(),e.semanticDates,true,false)}function rt(e){var a=e.getParameterNames().concat(e.getSelectOptionsPropertyNames());for(var r=0;r<a.length;r++){t.oSmartFilterbar.addFieldToAdvancedArea(a[r])}if(t.alr_visualFilterBar&&t.bVisualFilterInitialised){t.alr_visualFilterBar.addVisualFiltersToBasicArea(a)}}function it(){if(t._bIsStartingUp){return}if(C){return}var e=$();try{I=d.storeInnerAppStateWithImmediateReturn(e,true)}catch(t){f.error("AnalyticalListPage.fnStoreCurrentAppStateAndAdjustURL: "+t)}if(I instanceof sap.ui.generic.app.navigation.service.NavError){I=null;return}if(t.oTemplateUtils.oComponentUtils.isComponentActive()&&I){t.oTemplateUtils.oServices.oApplication.navigateByExchangingQueryParam(A,I.appStateKey)}if(I&&w!==I.appStateKey){N.appStateKey=I.appStateKey;I=null}}function nt(){var e=t.oController.getOwnerComponent().getModel("_templPriv");if(e.getProperty("/alp/filterMode")===b){if(t.alr_visualFilterBar&&t.alr_visualFilterBar.bIsInitialised&&e.getProperty("/alp/searchable")===false){t.oSmartFilterbar.showAdaptFilterDialog("group")}}}function ot(){if(t.oSmartFilterbar.isInitialised()){t.oSmartFilterbar.checkSearchAllowed(t)}}function lt(){var e=t.oController.getOwnerComponent().getModel("_filter");e.setData(c({},t.oSmartFilterbar.getFilterData(true)));t.filterBarController._updateFilterLink()}function st(e,a,i,n){var o=new r({selectionVariant:e,semanticDates:a});t.oSmartFilterbar.setUiState(o,{replace:i,strictMode:n})}function ct(t){F=d.parseNavigation()}function pt(){try{var t=new Promise(function(t){D=t;F.done(W);F.fail(function(e,a,r){f.warning(e.getErrorCode()+"app state could not be parsed - continuing with empty state");W({},a,sap.ui.generic.app.navigation.service.NavType.initial);t()})});return t}catch(t){mt()}}function ut(){C=false;D()}function St(){return P}function ft(e){if(!e){var a=t.oIappStateHandler.fnGetStartUpSelectionVariant();if(a){var r=a.getParameterNames().concat(a.getSelectOptionsPropertyNames());t.alr_visualFilterBar.addVisualFiltersToBasicArea(r)}}t.alr_visualFilterBar.updateVisualFilterBindings(true);if(t.oSmartFilterbar.isCurrentVariantStandard()){t.oIappStateHandler.fnCheckMandatory();t.oIappStateHandler.fnCheckToLaunchDialog()}}function mt(){K();lt();if(t.alr_visualFilterBar&&t.alr_visualFilterBar.bIsInitialised){t.oIappStateHandler.fnUpdateVisualFilterBar(true)}}function dt(){var e=false;if(t.oSmartFilterbar.isCurrentVariantStandard()){t.oSmartFilterbar.checkSearchAllowed(t);if(t.oController.getView().getModel("_templPriv").getProperty("/alp/searchable")){var a=t.oController.getOwnerComponent();var r=a.getDataLoadSettings();var i=r?r.loadDataOnAppLaunch:"ifAnyFilterExist";if(i==="ifAnyFilterExist"){var n=t.oSmartFilterbar.getFiltersWithValues();e=n.length?true:false}else if(i==="always"){e=true}else if(i==="never"){e=false}if(e){t.oSmartFilterbar.getSmartVariant().setExecuteOnStandard(true);e=t.oSmartFilterbar.getSmartVariant().getExecuteOnStandard()}}}var o=t.oSmartFilterbar.isCurrentVariantExecuteOnSelectEnabled();if(o||e){t.oSmartFilterbar.search()}return e}function gt(e){if(_){_.setState(e&&e[t.oSmartChart.getId()])}if(E){E.setState(e&&e[t.oSmartTable.getId()])}T.setState(e&&e[U.getId()])}return{areDataShownInTable:J,getFilterState:Y,fnCheckMandatory:ot,fnCheckToLaunchDialog:nt,getCurrentAppState:$,fnUpdateSVFB:lt,fnSetDefaultFilter:K,fnRestoreFilterState:k,getUrlParameterInfo:x,onSmartFilterBarInitialise:ct,onSmartFilterBarInitialized:pt,fnStoreCurrentAppStateAndAdjustURL:it,fnSetFiltersUsingUIState:st,fnResolveStartUpPromise:ut,fnGetStartUpSelectionVariant:St,fnUpdateVisualFilterBar:ft,fnOnError:mt,getInitialNavigationContext:Z}}return t.extend("sap.suite.ui.generic.template.listTemplates.controller.IappStateHandler",{constructor:function(t,e,a){s(this,m(t,e,a))}})});
//# sourceMappingURL=IappStateHandler.js.map