sap.ui.define(["sap/ui/base/Object","sap/ui/core/ExtensionPoint","sap/base/util/extend","sap/ui/comp/smartform/Group","sap/ui/comp/smartform/GroupElement","sap/ui/comp/smartmultiedit/Field","sap/ui/comp/smartform/SmartForm","sap/ui/comp/smartmultiedit/Container","sap/suite/ui/generic/template/genericUtilities/testableHelper","sap/suite/ui/generic/template/js/StableIdHelper","sap/suite/ui/generic/template/lib/MessageUtils","sap/m/MessageBox","sap/suite/ui/generic/template/genericUtilities/FeLogger"],function(e,t,n,i,a,o,r,s,l,u,g,p,c){"use strict";function d(e,n,d){var f,v;var E=d.oCommonUtils;var m;var C="ListReport.controller.MultiEditHandler";var S=new c(C);var h=S.getLogger();function y(){var t=e.oPresentationControlHandler.getSelectedContexts();f=t.filter(E.isContextEditable);if(t.length===f.length){M(f)}else if(f.length===0&&t.length===1){p.error(E.getText("OBJECT_NOT_EDITABLE"))}else{var n=f.length===1?"EDIT_REMAINING":"EDIT_REMAINING_PLURAL";var i=E.getText(n,[t.length-f.length,t.length,f.length]);var a=E.getText("MULTI_EDIT");var o=E.getText("CANCEL");p.warning(i,{actions:[a,o],emphasizedAction:a,onClose:function(e){if(e===a){M(f)}},contentWidth:"30rem"})}}function M(a){var o;if(d.oComponentUtils.getSettings().quickVariantSelectionX){o=e.oMultipleViewsHandler&&e.oMultipleViewsHandler.getSelectedKey()}var r=u.getStableId({type:"ListReportAction",subType:"MultiEditDialog",sQuickVariantKey:o});var s=n.byId(r);s.setVisible(true);var l=E.getText("MULTI_EDIT_DIALOG_TITLE",a.length);var g=new sap.ui.model.json.JSONModel;g.setProperty("/title",l);s.setModel(g,"localModel");v=false;var p=n.getOwnerComponent().getTableSettings();if(d.oComponentUtils.getSettings().quickVariantSelectionX){var c=d.oComponentUtils.getSettings().quickVariantSelectionX.variants||{};for(var f in c){if(c[f].key===o){p=c[f].tableSettings?c[f].tableSettings:p}}}var C="MultiEditFieldsExtension"+"|"+e.oPresentationControlHandler.getEntitySet()+(o?"|"+o:"");var S=d.oComponentUtils.getViewExtensions()||{};m=S[C];if(!p.multiEdit.annotationPath){v=true;if(m){t.load({container:n.getView(),name:C,async:true}).then(function(e){var t=new i({groupElements:[e]});T(s,t)})}else{T(s)}}else{var h=s.getContent()[0];h.resetContainer();s.getContent()[0].setContexts(a);s.open()}}function T(t,n){var l=x();var u=new i;l.forEach(function(e){var t=new a;var n=new o({propertyName:e.data("p13nData").leadingProperty,useApplyToEmptyOnly:false});t.addElement(n);u.addGroupElement(t)});var g=new r;if(n){g.addGroup(n)}g.addGroup(u);var p=new s;var c=e.oPresentationControlHandler.getEntitySet();p.setEntitySet(c);p.setLayout(g);t.addContent(p);var d=t.getContent()[0];d.resetContainer();t.getContent()[0].setContexts(f);t.open()}function x(){var t=n.getOwnerComponent().getModel().getMetaModel();var i=t.getODataEntityType(t.getODataEntitySet(e.oPresentationControlHandler.getEntitySet()).entityType);return e.oPresentationControlHandler.getVisibleProperties().filter(function(e){var n=e.data("p13nData")&&e.data("p13nData").columnKey;var a=t.getODataProperty(i,e.data("p13nData").leadingProperty);if(a){return e.getVisible()&&n.indexOf("DataFieldForAnnotation")<0&&!e.data("p13nData").actionButton&&!!e.data("p13nData").leadingProperty&&a["sap:updatable"]!=="false"&&(!a["Org.OData.Core.V1.Immutable"]||a["Org.OData.Core.V1.Immutable"].Bool==="false")}})}function D(t){var i=t.getSource().getParent();var a=i.getContent()[0];var o=a.getErroneousFieldsAndTokens();o.then(function(t){if(t.length===0){var o;var r=function(e,t){var n=t.getPropertyName(),i=t.getUnitOfMeasurePropertyName();o[n]=e[n];if(t.isComposite()){o[i]=e[i]}};a.getAllUpdatedContexts(true).then(function(t){var s=[];var l=a.getFields().filter(function(e){return!e.isKeepExistingSelected()});if(l&&l.length>0||m){t.forEach(function(e){o={};l.forEach(r.bind(null,e.data));s.push({sContextPath:e.context.getPath(),oUpdateData:o})});var u=n.beforeMultiEditSaveExtension(s);if(u){var c=d.oServices.oApplication.getBusyHelper();c.setBusy(u);u.then(function(){I(i);e.oPresentationControlHandler.refresh()}).catch(function(){I(i)});return}else if(m){h.error("beforeMultiEditSaveExtension implementation is missing while using MultiEditFieldsExtension");return}I(i);var f=d.oServices.oCRUDManager.updateMultipleEntities(s);f.then(function(t){if(t.length>0){e.oPresentationControlHandler.refresh();if(t.length===s.length){g.showSuccessMessageIfRequired(E.getText("OBJECT_SAVED"),d.oServices)}else{var n=E.getText("PARTIAL_UPDATE",[t.length,s.length]);d.oServices.oApplication.showMessageBox(n,{icon:p.Icon.SUCCESS,title:E.getText("ST_SUCCESS")})}}})}else{I(i);g.showSuccessMessageIfRequired(E.getText("OBJECT_NOT_MODIFIED"),d.oServices)}})}})}function P(e){var t=e.getSource().getParent();I(t)}function I(e){e.close();if(v){e.destroyContent()}}var D=l.testable(D,"fnOnSaveMultiEditDialog");return{onMultiEditButtonPress:y,onSaveMultiEditDialog:D,onCancelMultiEditDialog:P}}return e.extend("sap.suite.ui.generic.template.ListReport.controller.MultiEditHandler",{constructor:function(e,t,i){n(this,d(e,t,i))}})});
//# sourceMappingURL=MultiEditHandler.js.map