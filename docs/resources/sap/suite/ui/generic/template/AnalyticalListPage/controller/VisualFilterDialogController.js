sap.ui.define(["sap/m/Button","sap/m/Label","sap/m/Dialog","sap/m/Bar","sap/m/SearchField","sap/m/Text","sap/m/Toolbar","sap/m/ToolbarSpacer","sap/m/Title","sap/m/VBox","sap/m/HBox","sap/m/CheckBox","sap/m/Link","sap/m/List","sap/m/CustomListItem","sap/m/StandardListItem","sap/m/Popover","sap/ui/layout/GridData","sap/ui/core/mvc/Controller","sap/suite/ui/generic/template/AnalyticalListPage/util/FilterUtil","sap/suite/ui/generic/template/AnalyticalListPage/util/V4Terms","sap/ui/model/Filter","sap/suite/ui/generic/template/AnalyticalListPage/controller/DropDownController","sap/suite/ui/generic/template/AnalyticalListPage/controller/DynamicDateRangeController","sap/m/OverflowToolbarButton","sap/ui/model/json/JSONModel","sap/m/OverflowToolbar","sap/m/OverflowToolbarLayoutData","sap/ui/core/CustomData","sap/ui/Device","sap/m/library","sap/ui/core/library","sap/ui/model/FilterOperator","sap/m/DatePicker","sap/suite/ui/generic/template/genericUtilities/FeLogger","sap/ui/core/InvisibleText","sap/base/util/deepEqual","sap/suite/ui/generic/template/js/StableIdHelper","sap/base/util/extend","sap/base/util/deepExtend","sap/m/DynamicDateRange"],function(e,t,i,r,a,o,l,s,n,p,d,g,u,c,f,m,h,C,v,F,S,L,_,y,D,T,I,b,P,w,B,V,M,A,x,O,R,E,N,U,H){"use strict";var k=B.ListSeparators;var j=new x("AnalyticalListPage.controller.VisualFilterDialogController");var W=j.getLogger();var G=j.Level;var J="_BASIC";var z="100%";var Q=.33;var q=.5;var K=v.extend("sap.suite.ui.generic.template.AnalyticalListPage.controller.VisualFilterDialogController",{init:function(e){W.setLevel(G.WARNING,"VisualFilter");this.oState=e;this.oRb=e.alr_visualFilterContainer.getModel("i18n").getResourceBundle()},_createForm:function(){this._searchTriggered=false;this._restoreTriggered=false;var e=new T;var t=this.oState.alr_visualFilterBar.getModel("_visualFilterConfigModel");this._initialFilters=this.oState.alr_visualFilterBar.getModel("_filter").getJSON();this.oConfig=JSON.parse(t.getJSON());e.setData(this.oConfig);this.filterCompList=[];this.filterChartList=[];this._buildFiltersFromConfig(true);this._setVisualFiltersToActive();var i=new T;i.setData(JSON.parse(this._initialFilters));this.oVerticalBox=new p;this.oVerticalBox.setModel(this.oState.oController.getView().getModel("_templPriv"),"_templPriv");this.oVerticalBox.setModel(this.oState.oController.getView().getModel());this.oVerticalBox.setModel(this.oState.oController.getView().getModel("i18n"),"i18n");this.oVerticalBox.setModel(i,"_dialogFilter");this.oVerticalBox.setModel(e,"_visualFilterDialogModel");this._addGroupsAndFilters();this.oVerticalBox.addEventDelegate({onAfterRendering:function(e){if(e.srcControl&&e.srcControl.getParent()){e.srcControl.getParent().isPopupAdaptationAllowed=function(){return true}}}});return this.oVerticalBox},_toggle:function(e){var t=this.oState.oController.getView().getModel("_templPriv");if(e&&e==="visual"){t.setProperty("/alp/filterDialogMode","visual");if(this.oState.alr_visualFilterBar.getLazyLoadVisualFilter()){this.oState.alr_visualFilterBar.updateVisualFilterBindings.apply(this,[true,true])}}else{t.setProperty("/alp/filterDialogMode","group");if(!this.oState.alr_visualFilterBar.getAssociateValueListsCalled()){this.oState.alr_visualFilterBar.setAssociateValueListsCalled(true);this.oState.oSmartFilterbar.associateValueLists()}}},_searchDialog:function(){this._searchTriggered=true;if(this.bSearchPendingAfterDialogFilterChange){this.bSearchPendingAfterDialogFilterChange=false;this.oState.oSmartFilterbar.search()}},_updateFilterBarFromDialog:function(){var e=this.oState.alr_visualFilterBar.getModel("_filter"),t=this.oVerticalBox.getModel("_dialogFilter"),i=R(e.getJSON(),t.getJSON());if(!i){e.setData(JSON.parse(t.getJSON()))}var r=this.oState.alr_visualFilterBar.getModel("_visualFilterConfigModel"),a=this._getDialogConfigModel(),o=R(r.getJSON(),a.getJSON());if(!o){r.setData(JSON.parse(a.getJSON()));this.oState.alr_visualFilterBar.updateVisualFilterBindings(true)}if(this.oState.alr_visualFilterBar.getLazyLoadVisualFilter()){this.oState.alr_visualFilterBar.updateVisualFilterBindings(true)}},_closeDialog:function(e){if(e.getParameter("context")==="SEARCH"){this._updateFilterBarFromDialog();if(this._restoreTriggered){this._restoreTriggered=false;this.oState.filterBarController._afterSFBVariantLoad()}}this.oVerticalBox.destroyItems()},_restoreDialog:function(){var e=this.oState.alr_visualFilterBar._oCurrentVariant.config;if(e){this.oConfig.filterCompList.forEach(function(t){if(e[t.component.properties.parentProperty]){U(t,e[t.component.properties.parentProperty])}})}else{this.oConfig=this.oState.alr_visualFilterBar._getStandardVariantConfig()}this._getDialogConfigModel().setData(this.oConfig);this._reloadForm();this._restoreTriggered=true;this.bSearchPendingAfterDialogFilterChange=false},_cancelDialog:function(){if(this.bSearchPendingAfterDialogFilterChange){this.bSearchPendingAfterDialogFilterChange=false}},_buildFiltersFromConfig:function(e){var t;this.filterCompList=[];this.filterChartList=[];for(t=0;t<this.oConfig.filterCompList.length;t++){var i=this.oConfig.filterCompList[t].component.properties.sortOrder;if(i.constructor===Object&&i.value){this.oConfig.filterCompList[t].component.properties.sortOrder=i.value}this.filterCompList.push({obj:{shownInFilterBar:this.oConfig.filterCompList[t].shownInFilterBar,shownInFilterDialog:this.oConfig.filterCompList[t].shownInFilterDialog,cellHeight:this.oConfig.filterCompList[t].cellHeight,component:{type:this.oConfig.filterCompList[t].component.type,cellHeight:this.oConfig.filterCompList[t].component.cellHeight},group:{label:this.oConfig.filterCompList[t].group.label,name:this.oConfig.filterCompList[t].group.name}},searchVisible:e===true||this.oConfig.filterCompList[t].searchVisible===undefined||this.oConfig.filterCompList[t].searchVisible})}},_setVisualFiltersToActive:function(){var e=JSON.parse(this._initialFilters);for(var t=0;t<this.oConfig.filterCompList.length;t++){var i=this.oConfig.filterCompList[t];var r=i.component.properties.parentProperty;if(typeof e[r]==="string"&&e[r]){i.component.properties.activeVisualFilters=true}else if(typeof e[r]==="object"&&e[r]&&e[r].items.length){i.component.properties.activeVisualFilters=true}else{i.component.properties.activeVisualFilters=false}}},_rebuildConfig:function(){var e;var t={filterCompList:[]};for(e=0;e<this.filterCompList.length;e++){t.filterCompList.push({shownInFilterBar:this.filterCompList[e].obj.shownInFilterBar&&this.filterCompList[e].obj.shownInFilterDialog,shownInFilterDialog:this.filterCompList[e].obj.shownInFilterDialog,cellHeight:this.filterCompList[e].obj.cellHeight,group:{label:this.filterCompList[e].obj.group.label,name:this.filterCompList[e].obj.group.name},component:{type:this.filterCompList[e].obj.component.type,cellHeight:this.filterCompList[e].obj.component.cellHeight,properties:{scaleFactor:this.filterChartList[e].getScaleFactor(),numberOfFractionalDigits:this.filterChartList[e].getNumberOfFractionalDigits(),sortOrder:this.filterChartList[e].getSortOrder(),filterRestriction:this.oConfig.filterCompList[e].component.properties.filterRestriction,entitySet:this.filterChartList[e].getEntitySet(),isDropDown:this.oConfig.filterCompList[e].component.properties.isDropDown,width:this.oConfig.filterCompList[e].component.properties.width,height:this.oConfig.filterCompList[e].component.properties.height,dimensionField:this.filterChartList[e].getDimensionField(),dimensionFieldDisplay:this.filterChartList[e].getDimensionFieldDisplay(),dimensionFieldIsDateTime:this.filterChartList[e].getDimensionFieldIsDateTime(),dimensionFilter:this.filterChartList[e].getDimensionFilter(),unitField:this.filterChartList[e].getUnitField(),isCurrency:this.filterChartList[e].getIsCurrency(),isMandatory:this.oConfig.filterCompList[e].component.properties.isMandatory,measureField:this.filterChartList[e].getMeasureField(),outParameter:this.oConfig.filterCompList[e].component.properties.outParameter,inParameters:this.oConfig.filterCompList[e].component.properties.inParameters,parentProperty:this.oConfig.filterCompList[e].component.properties.parentProperty,chartQualifier:this.oConfig.filterCompList[e].component.properties.chartQualifier}}})}return t},_reloadForm:function(){this.oVerticalBox.destroyItems();this._buildFiltersFromConfig();this._addGroupsAndFilters()},_addGroupsAndFilters:function(){var e;var i;var r;var a=[];var l=0;for(e=0;e<this.filterCompList.length;e++){if(!Array.isArray(this.filterCompList[e])){if(this.filterCompList[e].searchVisible===false){continue}if(!(a.indexOf(this.filterCompList[e].obj.group.name)>-1)){if(r){this.oVerticalBox.addItem(r)}i=this.filterCompList[e].obj.group.name;a.push(i);r=new c({showSeparators:"None",showNoData:false});r.setWidth("100%");r.setLayoutData(new C({span:"L12 M12 S12"}));r.addStyleClass("sapUiSmallMarginTop");l++;this._addGroupToolbar(r,this.filterCompList[e].obj.group.label,this.filterCompList[e].obj.group.name)}if(this.filterCompList[e].obj.shownInFilterDialog){this.filterCompList[e].toolbar=this._addChartCustomToolbar(this.oConfig.filterCompList[e],e);var s=this,n=new p,u=this.oConfig.filterCompList[e].component.properties.parentProperty;n.setModel(this._getDialogConfigModel(),"_visualFilterDialogModel");n.bindAggregation("items",{path:"_visualFilterDialogModel>/filterCompList",factory:function(e,t){var i=t.getProperty("component/type"),r=t.getProperty("component/properties"),a=t.getPath().split("/")[2];this.filterChartList[a]=this._addChart(i,r,a);return this.filterChartList[a]}.bind(this),filters:new L("component/properties/parentProperty",M.EQ,u)});u=F.getParameter(u);var m="visualFilterDialogInvisibleText"+u;var h=new O({id:m});var v=this.filterChartList[e].getParentProperty().replace(/[^\w]/gi,"")+"checkBox";var S=[new p({items:[s.filterCompList[e].toolbar,n,h]}).setWidth("100%").addStyleClass("sapUiSmallMarginBegin")];if(w.system.desktop){S.splice(0,0,new p({items:[new t({text:"{i18n>SHOW_ON_FILTER_BAR}",labelFor:v,wrapping:true}).addStyleClass("sapUiTinyMarginTop"),new g({id:v,text:"",selected:s.oConfig.filterCompList[e].shownInFilterBar}).data("idx",e).attachSelect(null,s._onCheckBoxSelect,s)]}).setAlignItems("Center"));S[0].setWidth("20%");S[1].setWidth("80%")}var _=new d({items:S}).addStyleClass("sapUiSmallMarginTop").setWidth("100%");if(w.system.desktop){F._updateVisualFilterAria(_&&_.getItems()[1])}else{F._updateVisualFilterAria(_&&_.getItems()[0])}var y=new f({id:E.getStableId({type:"VisualFilterDialog",subType:"FilterItemContainer",sProperty:u}),content:_});y.attachBrowserEvent("keyup",F.onKeyUpVisualFilter.bind(F));y.attachBrowserEvent("keydown",F.onKeyDownVisualFilter.bind(F,this.oState.oSmartFilterbar));r.addItem(y)}}if(r){this.oVerticalBox.addItem(r)}}if(l==1&&i===J){F.executeFunction(r,"mAggregations.headerToolbar.setVisible",[false])}if(this.oVerticalBox.getItems()&&!this.oVerticalBox.getItems().length){var D=new o({text:"{i18n>NODATA_ADAPTFILTERDIALOG}",width:"100%",textAlign:V.TextAlign.Center}).addStyleClass("sapUiSmallMarginTopBottom");this.oVerticalBox.addItem(D)}},_onCheckBoxSelect:function(e){var t=e.getSource().data("idx");this.selectCheckBox(t,e.getSource().getSelected());if(this.currentDropdownSelection==="visible"||this.currentDropdownSelection==="visibleactive"){this._reloadForm()}},_addGroupToolbar:function(e,t,i){var r=new n({text:t}).addStyleClass("sapSmartTemplatesAnalyticalListPageVFDialogGroupTitle");var a=new l({content:[r,new s]});if(i!=J){a.addContent(this._createMoreFiltersLink(i,r))}e.setHeaderToolbar(a)},selectCheckBox:function(e,t){var i=this._getDialogConfigModel();var r=U({},i);r.setProperty("/filterCompList/"+e+"/shownInFilterBar",t);r.setProperty("/filterCompList/"+e+"/searchVisible",t);i.setData(r.getData());this.oConfig=i.getData();this.oState.oSmartFilterbar._oVariantManagement.currentVariantSetModified(true)},_formatTitle:function(e,t){var i=this.oVerticalBox.getModel("i18n").getResourceBundle();var r=e.titleMD;var a=e.titleUnitCurr;if(t==="tooltipMD"){return a==""?r:i.getText("VIS_FILTER_TITLE_MD_WITH_UNIT_CURR",[r,a])}else if(t==="titleUnitCurr"){return a.length>0?"| "+a:""}},_addChartCustomToolbar:function(t,i){var r=this;var a=this.oState.oController.getView().getModel("@i18n");var o=t.component.properties.parentProperty,l=t.component.properties,p=F.getPropertyNameDisplay(this.oState.alr_visualFilterBar.getModel(),t.component.properties.entitySet,t.component.properties.dimensionField,a),d=o.replace(/[^\w]/gi,""),u=this.oState.alr_visualFilterBar._oMetadataAnalyser.getEntityTypeNameFromEntitySetName(t.component.properties.entitySet),c=t.component.properties.sortOrder[0].Descending.Boolean,f=F.readProperty(t,"component.type")==="Line"&&F.readProperty(t,"component.properties.dimensionFieldIsDateTime"),m=this.oState.alr_visualFilterBar._resolveChartType(t.component.type),h=this._getChartTypeIconLink(m),C=this.oVerticalBox.getModel("i18n").getResourceBundle(),v=r._getChartTitle(t,i),S=new n({text:v.titleMD,tooltip:this._formatTitle(v,"tooltipMD"),titleStyle:V.TitleLevel.H6}),L=new n({text:this._formatTitle(v,"titleUnitCurr"),tooltip:"",titleStyle:V.TitleLevel.H6});if(this.oConfig.filterCompList[i].component.properties.isMandatory){S.addStyleClass("sapSmartTemplatesAnalyticalListPageRequired")}var T=function(){var e=this.oConfig.filterCompList[i].component.properties.entitySet,t=this._getVisibleMeasureList(e),r=Object.keys(t).length>1;if(!r){W.warning("Change measure button has been disabled in the dialog as only one visible measure exists in the collection "+e)}return r};var M=this.oState.oSmartFilterbar.determineFilterItemByName(t.component.properties.parentProperty).getControl();this.oState.oSmartFilterbar.ensureLoadedValueHelp(t.component.properties.parentProperty);var x=M.getShowValueHelp&&M.getShowValueHelp()&&!l.dimensionFieldIsDateTimeOffset,O=M instanceof A,R=M.getMetadata&&M.getMetadata().getName()==="sap.m.DateTimePicker",N=this.oState.alr_visualFilterBar.getFilterSettings()&&this.oState.alr_visualFilterBar.getFilterSettings().dateSettings?this.oState.alr_visualFilterBar.getFilterSettings().dateSettings:null,O=M instanceof A,U=false,k=null;if(!O&&M instanceof H&&N&&Object.keys(N).length>0&&l["filterRestriction"]==="single"){if(N.useDateRange){U=true}else if(!N.useDateRange&&(N.selectedValues||N.fields&&Object.keys(N.fields).length>0&&!N.fields[o])){U=true;var j=r.oState.alr_visualFilterBar.getSmartFilterBarControlOptions(o);k=y.createDynamicDateRange(j)}}var G="";if(O&&!R){G="sap-icon://appointment-2"}else if(U){G="sap-icon://check-availability"}var J=l.isDropDown?"sap-icon://slim-arrow-down":"",z=x?"sap-icon://value-help":G||J,Q=this.oState.alr_visualFilterBar.getView().sId,q;if(l.isParameter){q=F.getParameter(o)}else{q=l.parentProperty}var K=Q+"--"+E.getStableId({type:"VisualFilterDialog",subType:"ValueHelpButton",sProperty:q}),Y,$=[new e({type:"Transparent",icon:"sap-icon://line-chart-time-axis",visible:false,press:function(e){r._showLineChartTimeAxisPopup(e)}}).data("idx",i),new e({id:K,type:"Transparent",icon:x||l.isDropDown||O||U?z:"",customData:[new P({key:"isF4Enabled",value:x||l.isDropDown||O||U?true:false})],visible:{path:"_dialogFilter>/"+o,formatter:function(e){if(x||l.isDropDown||O&&!R||U){return true}else{if(!e){return false}if(typeof e==="object"){if(e instanceof Date){return true}return e.value||e.items&&e.items.length||e.ranges&&e.ranges.length?true:false}return true}}},text:{path:"_dialogFilter>/"+o,formatter:function(e){var t=r.filterChartList[i];var a=t.getFilterRestriction();Y=0;if(e){if(a==="single"&&!U){Y=1}else{if(typeof e==="object"){if(e.value){Y++}if(e.items){Y+=e.items.length}if(e.ranges){Y+=e.ranges.length}}else{Y++}}}return Y?"("+Y+")":""}},enabled:{path:"_visualFilterDialogModel>/filterCompList/"+i+"/showChartOverlay",formatter:function(e){return!e}},press:function(e){if(x){if(!r.oState.alr_visualFilterBar.getAssociateValueListsCalled()){r.oState.alr_visualFilterBar.setAssociateValueListsCalled(true);r.oState.oSmartFilterbar.attachEventOnce("valueListAnnotationLoaded",function(){M.fireValueHelpRequest()});r.oState.oSmartFilterbar.associateValueLists()}else{M.fireValueHelpRequest()}}else if(l.isDropDown){var t=r.oState.alr_visualFilterBar._isDimensionFieldFilterable(this.getModel(),l.entitySet,l.dimensionField),i=this.getModel("visualFilter")||this.getModel();_.createDropdown(e.getSource(),r.filterChartList[e.getSource().data("idx")],i,p,l,t)}else if(O&&!R){}else if(U){y.openDynamicDateRange(e.getSource(),r.filterChartList[e.getSource().data("idx")])}else{sap.suite.ui.generic.template.AnalyticalListPage.controller.VisualFilterDialogController.launchAllFiltersPopup(e.getSource(),r.filterChartList[e.getSource().data("idx")],e.getSource().getModel("i18n"))}},tooltip:{path:"_dialogFilter>/"+o,formatter:function(){return F.getTooltipForValueHelp(x,p,C,Y,O||U)}},layoutData:new b({priority:B.OverflowToolbarPriority.NeverOverflow}),ariaHasPopup:V.aria.HasPopup.Dialog}).data("idx",i),new D({id:Q+"--template::VisualFilterDialog::SortOrderChangeButton::"+u+"::"+d,type:"Transparent",icon:c?"sap-icon://sort-descending":"sap-icon://sort-ascending",visible:!f,tooltip:"{i18n>VISUAL_FILTER_SORT_ORDER}",text:"{i18n>VISUAL_FILTER_SORT_ORDER}",press:function(e){r._showChartSortPopup(e)},layoutData:new b({closeOverflowOnInteraction:false,priority:!w.system.desktop?B.OverflowToolbarPriority.AlwaysOverflow:B.OverflowToolbarPriority.High}),ariaHasPopup:V.aria.HasPopup.Dialog}).data("idx",i),new D({id:Q+"--template::VisualFilterDialog::ChartTypeChangeButton::"+u+"::"+d,type:"Transparent",icon:h,tooltip:"{i18n>VISUAL_FILTER_CHART_TYPE}",text:"{i18n>VISUAL_FILTER_CHART_TYPE}",press:function(e){r._showChartTypesPopup(e)},layoutData:new b({closeOverflowOnInteraction:false,priority:!w.system.desktop?B.OverflowToolbarPriority.AlwaysOverflow:B.OverflowToolbarPriority.High}),ariaHasPopup:V.aria.HasPopup.Dialog}).data("idx",i),new D({id:Q+"--template::VisualFilterDialog::MeasureChangeButton::"+u+"::"+d,type:"Transparent",icon:"sap-icon://measure",tooltip:"{i18n>VISUAL_FILTER_MEASURE}",text:"{i18n>VISUAL_FILTER_MEASURE}",enabled:T.apply(r),press:function(e){r._showChartMeasuresPopup(e)},layoutData:new b({closeOverflowOnInteraction:false,priority:!w.system.desktop?B.OverflowToolbarPriority.AlwaysOverflow:B.OverflowToolbarPriority.High}),ariaHasPopup:V.aria.HasPopup.Dialog}).data("idx",i)];if((w.system.tablet||w.system.phone)&&!w.system.desktop){$.splice(2,0,new g({tooltip:"{i18n>SHOW_ON_FILTER_BAR}",text:"{i18n>SHOW_ON_FILTER_BAR}",selected:r.oConfig.filterCompList[i].shownInFilterBar,layoutData:new b({closeOverflowOnInteraction:false,priority:B.OverflowToolbarPriority.AlwaysOverflow})}).data("idx",i).attachSelect(null,r._onCheckBoxSelect,r));$[2].addStyleClass("sapSmartTemplatesAnalyticalListPageVFDShowInFilterBarCozy")}var X=new I({design:B.ToolbarDesign.Transparent,content:[S,L,new s,$,k]}).addStyleClass("sapSmartTemplatesAnalyticalListPageFilterDialogTitleToolbar");X.getContent()[0].addStyleClass("sapUiTinyMarginTop");X.getContent()[0].addStyleClass("sapSmartTemplatesAnalyticalListPageVFDialogChartTitle");X.getContent()[1].addStyleClass("sapUiTinyMarginTop");X.setWidth("100%");return X},_addChart:function(e,t,i){var r;var a=this;var o=t.selectFilters&&t.selectFilters.SelectOptions;var l={selectFilters:t.selectFilters,scaleFactor:t.scaleFactor,numberOfFractionalDigits:t.numberOfFractionalDigits,sortOrder:t.sortOrder,filterRestriction:t.filterRestriction,isDropDown:t.isDropDown,width:z,height:t.height,labelWidthPercent:Q,entitySet:t.entitySet,dimensionField:t.dimensionField,dimensionFieldDisplay:t.dimensionFieldDisplay,dimensionFieldIsDateTime:t.dimensionFieldIsDateTime,dimensionFieldIsDateTimeOffset:t.dimensionFieldIsDateTimeOffset,unitField:t.unitField,isCurrency:t.isCurrency,isMandatory:t.isMandatory,measureField:t.measureField,dimensionFilter:t.dimensionFilter,outParameter:t.outParameter,inParameters:t.inParameters,parentProperty:t.parentProperty,textArrangement:t.textArrangement,chartQualifier:t.chartQualifier,lazyLoadVisualFilter:this.oState.alr_visualFilterBar.getLazyLoadVisualFilter()};var s="/filterCompList/"+i;if(e==="Donut"){l.labelWidthPercent=q}e=this.oState.alr_visualFilterBar._resolveChartType(e);var r=this.oState.alr_visualFilterBar._createFilterItemOfType(e,l,false);r.data("isDialogFilterItem","true");r.setModel(this.oVerticalBox.getModel("_dialogFilter"),"_dialogFilter");r.setModel(this._getDialogConfigModel(),"_visualFilterDialogModel");r.data("idx",i);r.addCustomData(new P({key:"sPath",value:s}));if(l.dimensionFieldIsDateTime){r.addCustomData(new P({key:"stringdate",value:t.stringdate}))}r.bindProperty("visible",{path:"_visualFilterDialogModel>/filterCompList/"+i+"/showChartOverlay",formatter:function(e){return!e}});r.bindProperty("dimensionFilter",{path:"_dialogFilter>/"+r.getParentProperty()});var n=r.getInParameters(),p=[];if(n&&n.length>0){n.forEach(function(e){p.push({path:"_dialogFilter>/"+e.localDataProperty})})}if(a.oState.alr_visualFilterBar.getEntitySet()===r.getEntitySet()){var d=a.oState.alr_visualFilterBar._smartFilterContext.determineMandatoryFilterItems();if(d&&d.length>0){d.forEach(function(e){if(!e.data("isCustomField")){p.push({path:"_dialogFilter>/"+e.getName()})}})}}if(p&&p.length>0){r.bindProperty("dimensionFilterExternal",{parts:p,formatter:function(){var e=this.getInParameters()||[],t=this.getParentProperty();var i,r;if(a.oState.alr_visualFilterBar.getEntitySet()===this.getEntitySet()){var l=a.oState.alr_visualFilterBar._smartFilterContext.determineMandatoryFilterItems();l.forEach(function(t){var i=t.getName();var r=e&&e.some(function(e){return e.localDataProperty===i});if(i.indexOf("$Parameter")===-1&&!r){e.push({localDataProperty:i,valueListProperty:i})}})}if(!(a.oState.alr_visualFilterBar.getEntitySet()===this.getEntitySet()&&a.oState.alr_visualFilterBar._smartFilterContext.getAnalyticBindingPath()!=="")&&(a.oState.alr_visualFilterBar._smartFilterContext.getAnalyticBindingPath()===""||a.oState.alr_visualFilterBar._smartFilterContext.getAnalyticBindingPath().indexOf("P_DisplayCurrency")!=-1)){var s=this.getMeasureField();var n=a.oState.alr_visualFilterBar.getModel();var p=n.getMetaModel();var d=p.getODataEntityType(a.oState.alr_visualFilterBar._oMetadataAnalyser.getEntityTypeNameFromEntitySetName(this.getEntitySet()));var g=p.getODataEntitySet(this.getEntitySet());var u=p.getODataProperty(d,s);var c=a.oState.alr_visualFilterBar.getProperty("displayCurrency");var f=u&&u[S.ISOCurrency];if(c&&f){var m=f.Path;for(var h=e.length-1;h>-1;h--){var C=e[h].valueListProperty;var v=e[h].localDataProperty;if(C===m){var _=a.oState.alr_visualFilterBar._smartFilterContext.getFilterData();if(!_[v]){r=p.getODataProperty(d,m);var y=r&&F.isPropertyNonFilterable(g,r.name);if(!y){i=new L({aFilters:[new L({path:m,operator:"EQ",value1:c,value2:undefined})],and:false})}}break}}}}if(this._chart instanceof sap.suite.ui.microchart.InteractiveDonutChart){this._inParameterFilterList=new L({aFilters:[],bAnd:true})}return a.oState.alr_visualFilterBar._getFiltersForFilterItem(e,t,i,m,o,this._inParameterFilterList)}})}else if(o&&o.length>0){var g=new L({aFilters:[],bAnd:true});for(var u in o){var c=o[u];g=this.oState.alr_visualFilterBar.fnAddSelectOptionsToFilters(c,g)}r.setProperty("dimensionFilterExternal",g)}r.attachBeforeRebindVisualFilter(function(e){var t=e.getParameters();var i=t.sEntityType;var r=t.sDimension;var o=t.sMeasure;var l=t.oContext;var s=a.oState.oController;s.onBeforeRebindVisualFilterExtension(i,r,o,l)});r._updateBinding();r._bAllowBindingUpdateOnPropertyChange=true;r.attachFilterChange(function(e){a.oState.alr_visualFilterBar.fireFilterChange()});r.attachTitleChange(function(e){var t=e.getSource().data("idx");if(a.filterCompList[t].toolbar.getContent().length>0){if(l.isMandatory){a.filterCompList[t].toolbar.getContent()[0].addStyleClass("sapSmartTemplatesAnalyticalListPageRequired")}var i=a.filterCompList[t].toolbar.getContent()[0];var r=a.filterCompList[t].toolbar.getContent()[1];var o=a._getChartTitle(a.filterCompList[t].obj,t);i.setText(o.titleMD);var s=a._formatTitle(o,"tooltipMD");i.setTooltip(s);r.setText(a._formatTitle(o,"titleUnitCurr"));var n=o.titleUnitCurr.split(" ");if(o.titleUnitCurr==""){r.setVisible(false)}else{r.setVisible(true);var p=n.length>1?"4.15rem":"2.4rem";r.setWidth(p)}}if(a.filterChartList[t].data("needsToUpdateAria")==="true"){F._updateVisualFilterAria(a.filterChartList[t].getParent().getParent())}});return r},_createMoreFiltersLink:function(e,t){var i=this;var r=0;var a;var o=new u;for(a=0;a<this.filterCompList.length;a++){if(this.filterCompList[a].searchVisible&&this.filterCompList[a].obj.group.name===e&&!this.filterCompList[a].obj.shownInFilterDialog){r++}}if(r>0){o.setText(this.oRb.getText("FILTER_BAR_SHOW_MORE_FILTERS",[r]))}else{o.setText(this.oRb.getText("FILTER_BAR_SHOW_CHANGE_FILTERS"))}o.attachPress(function(t){i._createAddRemoveFiltersDialog(e,o)});if(t){o.addAriaLabelledBy(t)}return o},_showChartMeasuresPopup:function(e){var t=this;var i=e.getSource().data("idx");var r=this.filterChartList[i].getProperty("entitySet");var a=sap.suite.ui.generic.template.AnalyticalListPage.controller.VisualFilterDialogController._createPopoverDialog(e.getSource().getModel("i18n"),"VISUAL_FILTER_MEASURES");var o=e.getSource().getModel("@i18n");if(o){a.setModel(o,"@i18n")}var l=new c({mode:B.ListMode.SingleSelectLeft,includeItemInSelection:true});l.data("idx",i);a.addContent(l);var s=this._getVisibleMeasureList(r);l.addStyleClass("sapUiSizeCompact");if(s){for(var n in s){var p=new m({title:s[n].label?s[n].label:s[n].name,tooltip:s[n].fieldInfo&&s[n].fieldInfo.quickInfo||s[n].label||s[n].name}).data("measureName",s[n].name);l.addItem(p);if(this.filterChartList[i].getMeasureField()===s[n].name){l.setSelectedItem(p)}}}l.attachSelectionChange(function(e){var i=e.getSource().data("idx"),r=e.getSource().getSelectedItem().data("measureName");t.filterChartList[i].setProperty("unitField",s[r].fieldInfo.unit);var o=t.filterCompList[i].toolbar.getContent()[0];var l=t.filterCompList[i].toolbar.getContent()[1];var n=t._getChartTitle(t.filterCompList[i].obj,i);o.setText(n.titleMD);l.setText(t._formatTitle(n,"titleUnitCurr"));t.oConfig.filterCompList[i].component.properties.measureField=r;if(!t.filterChartList[i]._chart.getPoints){var p=U([],t.filterChartList[i].getSortOrder());p[0].Field.String=r;t.filterChartList[i].setSortOrder(p);t._updateVisualFilterConfigModel(i,"/component/properties/sortOrder",p)}var d={bUpdateBinding:true,value:r};t.filterChartList[i].setMeasureField(d);t._updateVisualFilterConfigModel(i,"/component/properties/measureField",d);t._updateVisualFilterConfigModel(i,"/component/properties/measureField",r);t._updateVisualFilterConfigModel(i,"/component/properties/unitField",s[r].fieldInfo.unit);if(a){a.close()}});a.attachAfterClose(function(){a.destroy();a=null});a.openBy(e.getSource())},_showChartTypesPopup:function(e){var t=this,i=e.getSource(),r=i.getModel("i18n"),a=sap.suite.ui.generic.template.AnalyticalListPage.controller.VisualFilterDialogController._createPopoverDialog(r,"VISUAL_FILTER_CHART_TYPES"),o=this.oState.alr_visualFilterBar._getSupportedFilterItemList(),l=[];for(var s=0;s<o.length;s++){var n=o[s];var p=new m({title:"{i18n>"+n.textKey+"}",icon:n.iconLink,selected:i.getIcon()===n.iconLink}).data("type",n.type);l.push(p)}var d=new c({mode:B.ListMode.SingleSelectMaster,items:l});d.data("button",i);d.addStyleClass("sapUiSizeCompact");d.setModel(r,"i18n");a.addContent(d);d.attachSelectionChange(function(e){var i=e.getSource().data("button").data("idx"),r=e.getSource().getSelectedItem().data("type"),o=t.filterChartList[i],l=o.getDimensionField(),s=o.getMeasureField(),n=o.getDimensionFieldIsDateTime(),p=F.readProperty(t.oConfig,"filterCompList."+i+".component.properties.sortOrder.0.Field.String"),d=t._getDialogConfigModel(),g=d.getProperty("/filterCompList/"),u=U({},g[i]),c=F.readProperty(u,"component.properties.sortOrder.0.Field.String");e.getSource().data("button").setIcon(t._getChartTypeIconLink(r));if(p&&c){if(r==="Line"){t.oConfig.filterCompList[i].component.properties.sortOrder[0].Field.String=l;u.component.properties.sortOrder[0].Field.String=l;if(n){t.bSortOrder=t.oConfig.filterCompList[i].component.properties.sortOrder[0].Descending.Boolean;t.oConfig.filterCompList[i].component.properties.sortOrder[0].Descending.Boolean=true;u.component.properties.sortOrder[0].Descending.Boolean=true;t.bIsTimeBasedLine=true}}else{t.oConfig.filterCompList[i].component.properties.sortOrder[0].Field.String=s;u.component.properties.sortOrder[0].Field.String=s;if(t.bIsTimeBasedLine){t.oConfig.filterCompList[i].component.properties.sortOrder[0].Descending.Boolean=t.bSortOrder;u.component.properties.sortOrder[0].Descending.Boolean=t.bSortOrder;t.bIsTimeBasedLine=false}}}u.component.type=r;d.setProperty("/filterCompList/"+i,u);t.oState.oSmartFilterbar._oVariantManagement.currentVariantSetModified(true);t.oState.alr_visualFilterBar.updateVisualFilterBindings.apply(t,[true,true]);if(a){a.close()}});a.attachAfterClose(function(){a.destroy();a=null});a.openBy(e.getSource())},_showLineChartTimeAxisPopup:function(e){var t=e.getSource().data("idx");var i=e.getSource();var r=sap.suite.ui.generic.template.AnalyticalListPage.controller.VisualFilterDialogController._createPopoverDialog(e.getSource().getModel("i18n"),"VISUAL_FILTER_LINE_CHART_TIME_LINE");var a=new c({mode:B.ListMode.SingleSelectLeft,items:[new m({title:"{i18n>VISUAL_FILTER_LINE_CHART_TIME_LINE_DAYS}"}).data("idx",t),new m({title:"{i18n>VISUAL_FILTER_LINE_CHART_TIME_LINE_MONTH}"}).data("idx",t),new m({title:"{i18n>VISUAL_FILTER_LINE_CHART_TIME_LINE_QUARTERS}"}).data("idx",t),new m({title:"{i18n>VISUAL_FILTER_LINE_CHART_TIME_LINE_YEARS}"}).data("idx",t)]});a.data("button",i);a.addStyleClass("sapUiSizeCompact");r.addContent(a);a.attachSelectionChange(function(e){r.close()});r.attachAfterClose(function(){r.destroy();r=null});r.openBy(e.getSource())},_showChartSortPopup:function(e){var t=this;var i=e.getSource().data("idx");var r=e.getSource();var a=e.getSource().getModel("i18n");var o=sap.suite.ui.generic.template.AnalyticalListPage.controller.VisualFilterDialogController._createPopoverDialog(a,"VISUAL_FILTER_SORTING");var l=new c({mode:B.ListMode.SingleSelectLeft,includeItemInSelection:true,items:[new m({title:a.getResourceBundle().getText("VISUAL_FILTER_SORTING_ASCENDING")}).data("idx",i),new m({title:a.getResourceBundle().getText("VISUAL_FILTER_SORTING_DESCENDING")}).data("idx",i)]});l.data("button",r);l.addStyleClass("sapUiSizeCompact");if(this.filterChartList[i].getSortOrder()[0].Descending.Boolean){l.setSelectedItem(l.getItems()[1],true)}else{l.setSelectedItem(l.getItems()[0],true)}o.addContent(l);l.attachSelectionChange(function(e){var i=e.getSource().data("button");var r=i.data("idx");var a=U([],t.filterChartList[r].getSortOrder());a[0].Descending.Boolean=e.getSource().getItems()[1].isSelected();if(a[0].Descending.Boolean){i.setIcon("sap-icon://sort-descending")}else{i.setIcon("sap-icon://sort-ascending")}var l={bUpdateBinding:true,value:a};t.filterChartList[r].setSortOrder(l);t._updateVisualFilterConfigModel(r,"/component/properties/sortOrder",l);t._updateVisualFilterConfigModel(r,"/component/properties/sortOrder",a);if(o){o.close()}});o.attachAfterClose(function(){o.destroy();o=null});o.openBy(e.getSource())},_createAddRemoveFiltersDialog:function(t,o){var l;var s=this;var n=new i;n.setTitle(this.oRb.getText("SELECT_FILTER_FIELDS"));n.addStyleClass("sapUiPopupWithPadding");n.addStyleClass("sapUiCompAddRemoveFilterDialog");n.addStyleClass("sapUiSizeCompact");n.setVerticalScrolling(true);var p=new r;var d=new a({placeholder:this.oRb.getText("FILTER_BAR_SEARCH")});this._oSearchField=d;d.attachLiveChange(function(e){s._onAddRemoveFiltersSearch(e)});p.addContentRight(d);n.setSubHeader(p);this.addRemoveList=new c({mode:B.ListMode.MultiSelect});this.addRemoveList.setShowSeparators(k.None);n.addContent(this.addRemoveList);for(l=0;l<this.filterCompList.length;l++){if(this.filterCompList[l].obj.group.name===t&&this.filterCompList[l].searchVisible){var g=this._getChartTitle(this.filterCompList[l].obj,l,true);var u=new m({title:g.titleMD}).data("idx",l);this.addRemoveList.addItem(u);if(this.filterCompList[l].obj.shownInFilterDialog){this.addRemoveList.setSelectedItem(u,true)}}}this.addRemoveList.attachSelectionChange(function(e){if(e){var t=e.getParameters();if(t){var i=t.listItem;var r=i.data("idx");if(i){var a={bVisible:t.selected,propertyName:s.oConfig.filterCompList[r].component.properties.parentProperty};s.oState.alr_visualFilterBar.fireFilterChange(a)}}}});var f=new e({text:this.oRb.getText("OK")});f.attachPress(function(){var e;var t=s.addRemoveList.getItems();var i=s._getDialogConfigModel(),r=U({},i);for(e=0;e<t.length;e++){var a=t[e].data("idx");var o=t[e].isSelected();r.setProperty("/filterCompList/"+a+"/shownInFilterBar",o);r.setProperty("/filterCompList/"+a+"/shownInFilterDialog",o)}i.setData(r.getData());s.oConfig=JSON.parse(i.getJSON());s.oState.alr_visualFilterBar.updateVisualFilterBindings.apply(this,[true,true]);s.oState.oSmartFilterbar._oVariantManagement.currentVariantSetModified(true);s._reloadForm();n.close()});n.addAggregation("buttons",f);n.setInitialFocus(this._oSearchField);n.setContentHeight("23.25rem");var h=new e({text:this.oRb.getText("FORM_PERS_DIALOG_CANCEL"),press:function(){n.close()}});n.addAggregation("buttons",h);n.attachAfterClose(function(){n.destroy();n=null});n.open()},_onAddRemoveFiltersSearch:function(e){var t;if(!e){return}var i=e.getParameters();if(!i){return}var r=(i.newValue?i.newValue:"").toLowerCase();var a=this.addRemoveList.getItems();for(t=0;t<a.length;t++){var o=a[t].getTitle().toLowerCase();a[t].setVisible(o.indexOf(r)>=0)}},_getChartTypeIconLink:function(e){var t=this.oState.alr_visualFilterBar._getSupportedFilterItemMap();var i=t[e];return!i?"":i.iconLink},_getChartTitle:function(e,t,i){var r=this.oState.oController.getView().getModel("@i18n");var a="";if(this.filterChartList[t]){if(i){e.component.properties=this.filterChartList[t].getP13NConfig();a=this.oState.alr_visualFilterBar.getTitleByFilterItemConfig(e)}else{a=this.filterChartList[t].getTitle(r)}}else{e.component.properties=this.oConfig.filterCompList[t].component.properties;a=this.oState.alr_visualFilterBar.getTitleByFilterItemConfig(e)}return a},_adjustToolbarIcons:function(e){if(this.filterCompList[e].obj.component.type==="Line"){this.filterCompList[e].toolbar.getContent()[1].getItems()[1].setVisible(true);this.filterCompList[e].toolbar.getContent()[1].getItems()[2].setVisible(false)}else{this.filterCompList[e].toolbar.getContent()[1].getItems()[1].setVisible(false);this.filterCompList[e].toolbar.getContent()[1].getItems()[2].setVisible(true)}},_updateVisualFilterConfigModel:function(e,t,i,r){var a=this._getDialogConfigModel();a.setProperty("/filterCompList/"+e+t,i);if(r){var o=U({},a.getProperty("/filterCompList/"+e));a.setProperty("/filterCompList/"+e,o);this.oState.alr_visualFilterBar.updateVisualFilterBindings.apply(this,[true,true])}this.oConfig=a.getData();this.oState.oSmartFilterbar._oVariantManagement.currentVariantSetModified(true)},_getVisibleMeasureList:function(e){var t={},i=this.oState.alr_visualFilterBar._getMeasureMap()[e];for(var r in i){var a=i[r];if(!(a.fieldInfo[S.Hidden]&&a.fieldInfo[S.Hidden].Bool==="true")){t[a.name]=a}}return t},_triggerSearchInFilterDialog:function(e){var t=(e?e:"").toLowerCase();for(var i=0;i<this.oConfig.filterCompList.length;i++){var r=this.oConfig.filterCompList[i].component.properties;var a=this._getChartTitle(this.oConfig.filterCompList[i],i).titleMD.toLowerCase();var o=this._getLabelForDimensionsAndMeasures(r,r.parentProperty),l=this._getLabelForDimensionsAndMeasures(r,r.measureField),s=o.indexOf(t)>=0||l.indexOf(t)>=0||a.indexOf(t)>=0;this.oConfig.filterCompList[i].searchVisible=s}this._reloadForm()},_triggerDropdownSearch:function(e){this.currentDropdownSelection=e;for(var t=0;t<this.oConfig.filterCompList.length;t++){var i=this.oConfig.filterCompList[t];if(e==="all"||e==="visible"&&i.shownInFilterBar||e==="active"&&i.component.properties.activeVisualFilters||e==="visibleactive"&&i.shownInFilterBar&&i.component.properties.activeVisualFilters||e==="mandatory"&&i.component.properties.isMandatory){i.searchVisible=true}else{i.searchVisible=false}}this._reloadForm()},_getDialogConfigModel:function(){return this.oVerticalBox.getModel("_visualFilterDialogModel")},_getLabelForDimensionsAndMeasures:function(e,t){var i=this.oState.alr_visualFilterBar._oMetadataAnalyser,r=this.oVerticalBox.getModel().getMetaModel(),a=i.getEntityTypeNameFromEntitySetName(e.entitySet),o=r.getODataEntityType(a),l=r.getODataProperty(o,t)&&r.getODataProperty(o,t)[S.Label];l=l&&l.String?l.String:"";return l}});sap.suite.ui.generic.template.AnalyticalListPage.controller.VisualFilterDialogController._createPopoverDialog=function(e,t){if(this._oPopoverDialog){this._oPopoverDialog.destroy()}this._oPopoverDialog=new h;this._oPopoverDialog.setTitle(e.getResourceBundle().getText(t));this._oPopoverDialog.setPlacement(sap.m.PlacementType.PreferredBottomOrFlip);this._oPopoverDialog.addStyleClass("sapUiPopupWithPadding");return this._oPopoverDialog};sap.suite.ui.generic.template.AnalyticalListPage.controller.VisualFilterDialogController._createFilterItemSelectedList=function(e,t){var i=new c({mode:B.ListMode.Delete}),r,a=e.getFilterRestriction();i.data("chart",e);if(a==="multiple"){r=U({},e.getDimensionFilter());var o=r&&r.items?r.items:undefined,l=r&&r.ranges?r.ranges:undefined,s=r&&r.value?r.value:null;r=U({},e.getDimensionFilter());if(o){for(var n=0;n<o.length;n++){var p=new m({title:o[n].text?o[n].text:o[n].key});if(p){p.addCustomData(new P({key:"items",value:n}))}i.addItem(p)}}if(l){for(var n=0;n<l.length;n++){var p=new m({title:l[n].tokenText?l[n].tokenText:F.createTitleFromCode(l[n])});p.addCustomData(new P({key:"ranges",value:n}));i.addItem(p)}}if(s){var p=new m({title:s});p.addCustomData(new P({key:"value"}));i.addItem(p)}}else{i.addItem(new m({title:e.getDimensionFilter()}))}i.attachDelete(function(e){var r=e.getParameter("listItem"),o=i.data("chart"),l;if(a==="single"){l=null}else{l=U({},o.getDimensionFilter());var s=r.getCustomData()[0],n=s.getKey(),p=l[n];if(n!=="value"){var d=s.getValue();p.splice(d,1)}else{l.value=null}}i.removeItem(r);o.setDimensionFilter(l);o.fireFilterChange();t.removeContent(i);var g=sap.suite.ui.generic.template.AnalyticalListPage.controller.VisualFilterDialogController._createFilterItemSelectedList(o,t);if(g.getItems().length>0){t.addContent(g);t.focus()}else{t.close()}});return i};sap.suite.ui.generic.template.AnalyticalListPage.controller.VisualFilterDialogController.launchAllFiltersPopup=function(t,i,a){var o=sap.suite.ui.generic.template.AnalyticalListPage.controller.VisualFilterDialogController._createPopoverDialog(a,"VISUAL_FILTER_ALL_SELECTED_FILTERS"),l=sap.suite.ui.generic.template.AnalyticalListPage.controller.VisualFilterDialogController._createFilterItemSelectedList(i,o);o.addContent(l);o.addStyleClass("sapUiSizeCompact");o.addStyleClass("sapSmartTemplatesAnalyticalListPageSelectedLinkDialog");var s=new r;var n=new e({text:a.getResourceBundle().getText("CLEAR_FILTERS_ALL"),press:function(e){var t=l.data("chart"),i=t.getFilterRestriction(),r;if(i==="multiple"){r=U({},t.getDimensionFilter());r.items=[];r.ranges=[];r.value=null}else{r=null}o.removeContent(l);t.setDimensionFilter(r);t.fireFilterChange();o.close()}});s.addContentRight(n);o.setFooter(s);o.attachAfterClose(function(){o.destroy();o=null});o.openBy(t)};return K});
//# sourceMappingURL=VisualFilterDialogController.js.map