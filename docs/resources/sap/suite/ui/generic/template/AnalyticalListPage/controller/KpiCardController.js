sap.ui.define(["sap/ui/core/Fragment","sap/ui/core/mvc/Controller","sap/ui/model/json/JSONModel","sap/ui/thirdparty/d3","sap/suite/ui/generic/template/AnalyticalListPage/util/KpiUtil","sap/suite/ui/generic/template/AnalyticalListPage/util/V4Terms","sap/ui/generic/app/navigation/service/SelectionVariant","sap/m/MessageBox","sap/ui/model/analytics/odata4analytics"],function(t,e,a,i,n,r,o,s,l){"use strict";var c,g,d,v;var p=e.extend("sap.suite.ui.generic.template.AnalyticalListPage.controller.KpiCardController",{onInit:function(t){sap.ui.require(["sap/ovp/cards/CommonUtils"],function(t){d=t})},onExit:function(){},onBeforeRendering:function(){var t=this.getView();var e=t.data("qualifierSettings");var a=e.qualifier;var i=t.getModel();var n=i.getMetaModel();var r=n.getODataEntitySet(e.entitySet);var o=n.getODataEntityType(r.entityType);var s=t.data("mergedSelectionVariant");var l=t.data("kpiAnnotationPath");var c=t.data("selectionPresentationVariantPath");var g=t.data("dataPointPath");var p="kpiCard"+a;var h={cards:{}};h["cards"][p]={model:e.model,template:"sap.ovp.cards.charts.analytical",settings:{title:t.data("kpiTitle"),entitySet:e.entitySet,showFilterInHeader:true,navigation:"chartNav",bEnableStableColors:e.enableStableColors,colorPalette:e.colorPalette}};var u=v.getOwnerComponent();var S=u&&u.getChartSettings()&&u.getChartSettings().showDataLabel;h["cards"][p]["settings"].showDataLabel=S;if(o[g]&&o[g].hasOwnProperty("Description")){h["cards"][p]["settings"].subTitle=o[g]["Description"].String}if(l){h["cards"][p].settings.kpiAnnotationPath=l;d.createCardComponent(t,h,"template::ALPcardContainer",s)}else{h["cards"][p].settings.dataPointAnnotationPath=g;h["cards"][p].settings.selectionPresentationAnnotationPath=c;var f=function(){var e=t.getModel("detailNavigation");if(e){var a=e.getProperty("/target");var i=e.getProperty("/action");if(a&&i){return true}}return false};d.createCardComponent(t,h,"template::ALPcardContainer",s,f)}d.onHeaderClicked=function(e){this.handleNavigationPress(t)}.bind(this);d.onContentClicked=function(e){var a=e.getObject();this.handleNavigationPress(t,a)}.bind(this)},handleNavigationPress:function(t,e){var a=t.getModel("detailNavigation");if(a){var i=a.getProperty("/target");var n=a.getProperty("/action");var r=t.getParent();r.setModal(true);if(i&&n){var l={semanticObject:i,action:n};this._oSelectionVariant=new o;var d=JSON.parse(a.getProperty("/parameters"));this._createNavigationContext(d,true);this._getSelectOptionsFromAnnotation(t);if(e){this._createNavigationContext(e)}v.adaptNavigationParameterExtension(this._oSelectionVariant,l);this._constructContextURL();if(this._sParameterContextURL){this._oSelectionVariant.setParameterContextUrl(this._sParameterContextURL)}if(this._sFilterContextURL){this._oSelectionVariant.setFilterContextUrl(this._sFilterContextURL)}c.setModel(this.getView().getModel());this._oSelectionVariant=this._oSelectionVariant.toJSONString();c.navigate(i,n,this._oSelectionVariant,null,function(t){if(t instanceof sap.ui.generic.app.navigation.service.NavError){if(t.getErrorCode()==="NavigationHandler.isIntentSupported.notSupported"){s.show(g.getText("ST_NAV_ERROR_NOT_AUTHORIZED_DESC"),{title:g.getText("ST_GENERIC_ERROR_TITLE"),onClose:function(){r.setModal(false)}})}else{s.show(t.getErrorCode(),{title:g.getText("ST_GENERIC_ERROR_TITLE"),onClose:function(){r.setModal(false)}})}}})}}},_assignSmartTemplateDependencies:function(t,e){g=t.oCommonUtils;v=e;c=t.oServices.oApplication.getNavigationHandler()},_createNavigationContext:function(t,e){var a=Object.keys(t);for(var i=0;i<a.length;i++){var n=a[i];if(!t[n]&&t[n]!==""){return}if(e){this._oSelectionVariant.addParameter(n,t[n])}else{if(this._oSelectionVariant.getSelectOption(n)){this._oSelectionVariant.removeSelectOption(n)}this._oSelectionVariant.addSelectOption(n,"I","EQ",t[n])}}},_getSelectOptionsFromAnnotation:function(t){var e=this;var a=t.data("qualifierSettings").filterable;if(a){var i=t.data("mergedSelectionVariant");var n=this._oSelectionVariant.getParameterNames();if(n){for(var r=0;r<n.length;r++){if(!i.getParameter(n[r])){i.addParameter(n[r],this._oSelectionVariant.getParameter(n[r]))}}}this._oSelectionVariant=i;return}var o=t.data("selectionVariant");var s=o.SelectOptions;var l=o.Parameters;if(l&&l.length){l.forEach(function(t){var a=t.PropertyName.PropertyPath;var i=t.PropertyValue.String;if(e._oSelectionVariant.getParameter(a)){e._oSelectionVariant.removeParameter(a)}e._oSelectionVariant.addParameter(a,i)})}if(s&&s.length){s.forEach(function(t){var a=t.PropertyName.PropertyPath;var i=t.Ranges;i.forEach(function(t){var i=t.Low.String;var n=t.High&&t.High.String?t.High.String:null;var r=t.Sign.EnumMember.split("/")[1];var o=t.Option.EnumMember.split("/")[1];e._oSelectionVariant.addSelectOption(a,r,o,i,n)})})}},_constructContextURL:function(){if(this._sFilterContextURL||this._sParameterContextURL){return}var t=this.getView();var e=t.data("qualifierSettings");var a=t.getModel();var i=a.getMetaModel();var n=i.getODataEntitySet(e.entitySet);var r=new l.Model(l.Model.ReferenceByModel(a));var o=r.findQueryResultByName(n.name);var s=o&&o.getParameterization();if(s){this._sParameterContextURL=c.constructContextUrl(s.getEntitySet().getQName(),a)}this._sFilterContextURL=c.constructContextUrl(n.name,a)}});return p});
//# sourceMappingURL=KpiCardController.js.map