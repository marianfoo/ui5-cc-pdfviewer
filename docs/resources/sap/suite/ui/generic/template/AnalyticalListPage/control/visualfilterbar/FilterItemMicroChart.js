sap.ui.define(["sap/ui/core/Control","sap/ui/model/Sorter","sap/ui/model/analytics/odata4analytics","sap/suite/ui/generic/template/AnalyticalListPage/util/FilterUtil","sap/ui/core/format/NumberFormat","sap/suite/ui/generic/template/AnalyticalListPage/util/V4Terms","sap/ui/core/format/DateFormat","sap/suite/ui/generic/template/genericUtilities/FeLogger","sap/suite/ui/generic/template/AnalyticalListPage/util/CriticalityUtil","sap/suite/ui/generic/template/listTemplates/listUtils","sap/base/util/extend","sap/base/util/deepExtend"],function(e,t,i,r,a,s,n,l,o,u,g,p){"use strict";var f=new l("AnalyticalListPage.control.visualfilterbar.FilterItemMicroChart").getLogger();var c="Donut";var d="Line";var h="Bar";var m="__IS_OTHER__";var y=e.extend("sap.suite.ui.generic.template.AnalyticalListPage.control.visualfilterbar.FilterItemMicroChart",{metadata:{properties:{selectFilters:{type:"any",group:"Misc",defaultValue:null},filterRestriction:{type:"string",group:"Misc",defaultValue:null},entitySet:{type:"string",group:"Misc",defaultValue:null},lazyLoadVisualFilter:{type:"boolean",group:"Misc",defaultValue:true},dimensionField:{type:"string",group:"Misc",defaultValue:null},dimensionFieldIsDateTime:{type:"boolean",group:"Misc",defaultValue:false},dimensionFieldIsDateTimeOffset:{type:"boolean",group:"Misc",defaultValue:false},dimensionFieldDisplay:{type:"string",group:"Misc",defaultValue:null},dimensionFilter:{type:"any",group:"Misc",defaultValue:null},dimensionFilterExternal:{type:"sap.ui.model.Filter",group:"Misc",defaultValue:null},measureField:{type:"string",group:"Misc",defaultValue:null},unitField:{type:"string",group:"Misc",defaultValue:null},isCurrency:{type:"boolean",group:"Misc",defaultValue:false},isMandatory:{type:"boolean",group:"Misc",defaultValue:false},isDropDown:{type:"boolean",group:"Misc",defaultValue:false},width:{type:"sap.ui.core.CSSSize",group:"Dimension",defaultValue:null},height:{type:"sap.ui.core.CSSSize",group:"Dimension",defaultValue:null},title:{type:"string",group:"Misc",defaultValue:""},outParameter:{type:"string",group:"Misc",defaultValue:null},inParameters:{type:"object[]",group:"Misc",defaultValue:null},parentProperty:{type:"string",group:"Misc",defaultValue:null},sortOrder:{type:"object[]",group:"Misc",defaultValue:null},scaleFactor:{type:"string",group:"Misc",defaultValue:null},numberOfFractionalDigits:{type:"string",group:"Misc",defaultValue:null},textArrangement:{type:"string",group:"Misc",defaultValue:sap.ui.comp.smartfilterbar.DisplayBehaviour.descriptionAndId},chartQualifier:{type:"string",group:"Misc",defaultValue:null},smartFilterId:{type:"string",group:"Misc",defaultValue:null},isParameter:{type:"boolean",group:"Misc",defaultValue:false},stringdate:{type:"string",group:"Misc",defaultValue:""}},aggregations:{control:{type:"sap.ui5.controls.microchart",multiple:false}},events:{filterChange:{},titleChange:{},beforeRebindVisualFilter:{}}},renderer:{apiVersion:2,render:function(e,t){e.openStart("div",t);e.style("width","100%");document.body.classList.contains("sapUiSizeCozy")?e.style("height","9.9rem"):e.style("height","7.9rem");e.openEnd();e.renderControl(t.getAggregation("control"));e.close("div")}}});y.prototype._formattingId="__UI5__ShortIntegerMaxFraction2";y.prototype._maxFractionalDigits=2;y.prototype._maxFractionalDigitsValsLessThanZero=7;y.prototype._minFractionalDigits=0;y.prototype._isTriggeredBySync=false;y.prototype._multiUnit=false;y.prototype.technicalIssueMessage="M_VISUAL_FILTERS_ERROR_DATA_TEXT";y.prototype.noDataIssueMessage="NO_DATA_FOUND_OVERLAY_MESSAGE";y.prototype.multipleCurrencyMessage="M_VISUAL_FILTERS_MULTIPLE_CURRENCY";y.prototype.multipleUnitMessage="M_VISUAL_FILTERS_MULTIPLE_UNIT";y.prototype.hiddenMeasureMessage="M_VISUAL_FILTER_HIDDEN_MEASURE";y.prototype.invalidMeasureForDonutMessage="INVALID_MEASURE_DONUT_MESSAGE";y.prototype.valuehelpAllMandatoryFilters={};y.prototype.oDataQueryOptions=["$select","$top","$expand","$inlinecount","$orderby","$filter","$skip","$format"];y.prototype.missingMandatoryField="M_VISUAL_FILTERS_PROVIDE_FILTER_VAL_SINGLEVF";y.prototype.missingMultipleMandatoryFields="M_VISUAL_FILTERS_PROVIDE_FILTER_VAL_MULTIPLEVF";y.prototype.init=function(){this._bAllowBindingUpdateOnPropertyChange=false;this._attachChartEvents()};y.prototype._attachChartEvents=function(){var e=this;this._chart.addEventDelegate({onAfterRendering:function(){if(e._getChartAggregations().length){if(e._multiUnit){var t=r.getPropertyNameDisplay(e.getModel(),e.getEntitySet(),e.getDimensionField(),e.getModel("@i18n"));e.applyOverlay(e.getIsCurrency()?e.multipleCurrencyMessage:e.multipleUnitMessage,t);if(e.data("isDialogFilterItem")==="true"){r._updateVisualFilterAria(e.getParent().getParent())}}}}});this._chart.attachSelectionChanged(this._onSelectionChanged,this)};y.prototype._getCurrentSelectedChart=function(e){if(this._chart.getPoints){return e?d:"point"}else if(this._chart.getSegments){return e?c:"segment"}else if(this._chart.getBars){return e?h:"bar"}};y.prototype._getCustomData=function(e){var t=this._getCurrentSelectedChart();var i=t?e.getParameter(t):undefined;if(t&&i){var a=i.getCustomData(),s=a[0].getValue(),n;if(s instanceof Date){s=this.getDimensionFieldIsDateTimeOffset()?s:r.convertLocalDatetoUTCDate(s)}else if(this.getDimensionFieldIsDateTime()&&this._isStringDateType()=="yearmonth"){n=s}else if(i.getLabel()===this._getI18nText("NOT_ASSIGNED")){n=""}else{n=i&&i.getLabel()}var l={dimValue:s,dimValueDisplay:n};return l}};y.prototype._getEntityParameters=function(e,t){var i={};if(this.getSmartFilterId()){var r=sap.ui.getCore().byId(this.getSmartFilterId());var a=u.getSelectionVariantParameterNamesWithoutNavigation(this.getSelectFilters()&&this.getSelectFilters().Parameters);var s=r.getEntitySet()===t?r.getAnalyticalParameters():[];var n=this.getSelectFilters()&&this.getSelectFilters().SelectOptions;var l=this.checkSearchable(e,t,r,a,n);if(l.aMandatoryFilter.length===1){this.applyOverlay(this.missingMandatoryField,l.aMandatoryFilter[0]);return}if(!l.bIsMandatoryFilter){this.applyOverlay(this.missingMultipleMandatoryFields);return}if(a){a.forEach(function(e){i[e.PropertyName.PropertyPath]=e.PropertyValue.String})}if(s){var o=r.getUiState().getSelectionVariant().Parameters;var g={};o&&o.map(function(e){g[e.PropertyName]=e.PropertyValue});var p=JSON.parse(r.data("dateFormatSettings"));s.forEach(function(e){var t=g[e.name];if(t){if(e.type==="Edm.Time"&&t instanceof Date){if(p&&!p.UTC){t=new Date(t.valueOf()+t.getTimezoneOffset()*60*1e3)}t={__edmType:"Edm.Time",ms:((t.getHours()*60+t.getMinutes())*60+t.getSeconds())*1e3+t.getMilliseconds()}}else if(p&&p.UTC&&t instanceof Date){t=this._getDateInUTCOffset(t)}else if(isNaN(t)&&!isNaN(Date.parse(t))&&t.indexOf("Z")!==t.length-1){t=t.split("T")[0]+"T00:00:00Z"}i[e.name]=t}else if(e.type==="Edm.String"&&e["sap:parameter"]==="optional"){i[e.name]=""}}.bind(this))}return i}return};y.prototype._executeRebindVisualFilterExtension=function(e,t,i,r,a){var s={sEntityType:e,sDimension:t,sMeasure:i,oContext:{filters:r,queryParameters:{},sorters:this._sorters,entityParameters:a,groupId:undefined}};this.fireBeforeRebindVisualFilter(s);return s.oContext};y.prototype._onSelectionChanged=function(e){var t=e.getSource().getParent().getBindingContext("_visualFilterDialogModel");if(t){var i=t.getObject("component");i.properties.activeVisualFilters=e.getParameter("selected")}var r=this.getFilterRestriction(),a=this._getCustomData(e),s=e.getParameter("selected"),n=r==="single"&&a.dimValue===m&&s;if(a.dimValue===m&&s&&this.getIsDropDown()){e.getParameter("segment").setSelected(false);return}if(n){e.getParameter("segment").setSelected(false)}if(s&&a.dimValue===m&&r==="multiple"||s&&a.dimValue!==m){this._onChartSelectData(e)}else if(!s){this._onChartDeselectData(e)}};y.prototype._onChartSelectData=function(e){var t,i=this.getFilterRestriction();if(i==="multiple"){t=p({items:[],ranges:[],value:null},this.getDimensionFilter());var a=this._getCustomData(e),s=this._getCurrentSelectedChart(true);if(s===c){t=this._applyDonutChartSelections(a,t)}else if(a.dimValue instanceof Date){t.ranges.push({exclude:false,keyField:this.getDimensionField(),operation:"EQ",value1:a.dimValue,value2:null})}else if(a.dimValue===""){t.ranges.push({exclude:false,keyField:this.getDimensionField(),operation:"Empty",value1:a.dimValue,value2:null})}else{t.items.push({key:a.dimValue,text:a.dimValueDisplay})}}else{t=this.getDimensionFilter();if(t){t=null;var n=e.getParameter("bar")||e.getParameter("point")||e.getParameter("segment");this._setSelectedAggregation(n);n.setSelected(true)}var a=this._getCustomData(e);if(this.getDimensionFieldIsDateTime()&&this.getDimensionFilter()instanceof Object){t=p({},this.getDimensionFilter());t.conditionTypeInfo.data.operation="DATE";if(this._isStringDateType()=="yearmonthday"){t.conditionTypeInfo.data["value1"]=r.formatStringDate(a.dimValue)}else{t.conditionTypeInfo.data["value1"]=a.dimValue}t.ranges=[]}else{t=a.dimValue}}this.setDimensionFilter(t);this.fireFilterChange()};y.prototype._setSelectedAggregation=function(e){var t=this._chart.setSelectedBars||this._chart.setSelectedPoints||this._chart.setSelectedSegments;t.call(this._chart,e)};y.prototype._getChartAggregations=function(){var e=this._chart.getPoints||this._chart.getSegments||this._chart.getBars;return e.call(this._chart)};y.prototype._onChartDeselectData=function(e){var t=this;var i,a=this.getFilterRestriction(),s=this._getCustomData(e),n=[],l=[];if(a==="single"){i=null}else{i=p({},this.getDimensionFilter());var o=i&&i.items?i.items:undefined,u=i&&i.ranges?i.ranges:undefined,g=i&&i.value?i.value:null;if(o){o.forEach(function(e){var t=r.getResolvedDimensionValue(e.key),i=r.getResolvedDimensionValue(s.dimValue);if(t!==i){n.push(e)}})}i.items=n;if(g){if(s.dimValue===g){i.value=null}}if(u){u.forEach(function(e){if(e.operation==="EQ"&&s.dimValue!==m&&e.exclude){l.push(e)}else if(e.operation==="EQ"&&!e.exclude){if(e.value1 instanceof Date&&s.dimValue instanceof Date){if(t.getDimensionFieldIsDateTimeOffset()){if(r.getDateTimeInMedium(e.value1)!==r.getDateTimeInMedium(s.dimValue)){l.push(e)}}else if(r.getDateInMedium(e.value1)!==r.getDateInMedium(s.dimValue)){l.push(e)}}else if(typeof e.value1==="string"&&s.dimValue instanceof Date){if(r.getDateTimeInMedium(new Date(e.value1))!==r.getDateTimeInMedium(s.dimValue)){l.push(e)}}else if(e.value1!==s.dimValue){l.push(e)}}else if(e.operation!=="EQ"&&!e.exclude&&e.value1!==s.dimValue){l.push(e)}})}i.ranges=l}this.setDimensionFilter(i);this.fireFilterChange()};y.prototype._updateBinding=function(){if(r.isVisualFilterLazyLoaded(this)){return}this.applyOverlay();this._chart.setBusy(true);var e=this._getCurrentSelectedChart(true);var t=e===c;if(e===d){this._chart.unbindPoints()}else if(e===h){this._chart.unbindBars()}else if(t){this._chart.unbindSegments()}var i=this.getEntitySet(),a=this.getDimensionField(),s=this.getDimensionFieldDisplay(),n=this.getMeasureField(),l=this.getUnitField(),u=this.getDimensionFilterExternal(),p=[],m=this.getSortOrder(),y=this.getModel(),_=y.getMetaModel(),v=this._getSorter(m);this._sorters=v.sorter;p=v.sortFields;if(!i||!n||!a||!s){return}if(this._determineHiddenVisualFilter(_,i,n)){var F=r.getPropertyNameDisplay(y,i,n,this.getModel("@i18n"));this.applyOverlay(this.hiddenMeasureMessage,F);return}if(l){var D=r.getUnitFieldText(this.getModel(),i,l);if(D&&r.IsNavigationProperty(this.getModel(),i,D)){var M=D.split("/")[0]}}if(t){if(this._determineIfInvalidMeasure(_,i,n)){this.applyOverlay(this.invalidMeasureForDonutMessage);return}}var S=[n,a],I=r.IsNavigationProperty(this.getModel(),i,s)?s.split("/")[0]:null,T=r.getKeysForNavigationEntitySet(_,this.getEntitySet(),I),S=r.getVisualFilterSelectFields(n,a,s,l,p,T,D);var V=t&&this._inParameterFilterList&&this._inParameterFilterList.aFilters&&this._inParameterFilterList.aFilters.length?[this._inParameterFilterList]:[];var P=[];if(u&&u.aFilters&&u.aFilters.length>0){P=[u]}var E=this;var b=!t&&this.getFixedCount();var y=this.getModel(),O=this.getModel("visualFilter")||y;var L=this._getEntityParameters(y,i);if(!(L instanceof Object)){return}var R=this._executeRebindVisualFilterExtension(i,a,n,P,L),C=R.groupId,U="/"+i;if(y){var A=o.getDataPoint(y,this);this.setNumberOfFractionalDigits(null);if(A){A.ValueFormat&&A.ValueFormat.ScaleFactor?this.setScaleFactor(r.getPrimitiveValue(A.ValueFormat.ScaleFactor)):this.setScaleFactor(null);A.ValueFormat&&A.ValueFormat.NumberOfFractionalDigits?this.setNumberOfFractionalDigits(r.getPrimitiveValue(A.ValueFormat.NumberOfFractionalDigits)):this.setNumberOfFractionalDigits(null);var N=o.getCriticalityRefProperties(A)}U=this._getBindingPathforVisualFilter(y,i,L);if(!U){return}if(this._oObject){this._oObject.abort()}if(this._oTop4ReadObject){this._oTop4ReadObject.abort()}if(this._oTotalReadObject){this._oTotalReadObject.abort()}if(this._determineInteger(_,i,n)){this.setNumberOfFractionalDigits(0)}var x={};var B={async:true,filters:P,urlParameters:x};if(C){B.groupId=C}if(!t){g(B,{sorters:this._sorters,success:function(e,t){E._oObject=null;if(A&&(A.Criticality||A.CriticalityCalculation)){e=o.CalculateCriticality(A,e,E.getMeasureField())}else{e=o.CalculateDimensionCriticality(y,E.getDimensionField(),E.getEntitySet(),e)}E._onDataReceived(e)},error:function(e){f.error("Error reading URL:"+e.message);if(e&&e.statusCode!==0&&e.statusText!=="abort"){E.applyOverlay(E.technicalIssueMessage);E._oObject=null}}});this._updateBindingInfo(B,S,N,b,R,I,M,t);this._fetchData(O,U,B,t)}else{this._updateBindingInfo(B,[n],N,1,R,I,M,t,true,V);var j=this._fetchData(O,U,B,t,true,A);B.filters=P;this._updateBindingInfo(B,S,N,4,R,I,M,t,false);var w=this._fetchData(O,U,B,t,false,A);Promise.all([w,j]).then(function(e){var t=e[0].data;var i=e[0].iDataLength;var r=e[1].data;var a=e[1].iDataLength;if(!i){E.applyOverlay(E.noDataIssueMessage)}else if(i<=3){E._onDataReceived(t)}else if(i>3){if(a){E._onDataReceived(t,r)}else{E.applyOverlay(E.noDataIssueMessage)}}},function(e){var t=e.error;var i=e.bToFetchTotalData;if(!t||t.statusCode!==0&&t.statusText!=="abort"){if(i===true){E._oTotalReadObject=null}else{E._oTop4ReadObject=null}E.applyOverlay(E.technicalIssueMessage)}})}}};y.prototype._updateBindingInfo=function(e,t,i,r,a,s,n,l,o,u){e.urlParameters={$select:i?[i].concat(t).join(","):t.join(","),$top:r};if(Object.keys(a.queryParameters).length>0){Object.keys(a.queryParameters).forEach(function(t){if(this.oDataQueryOptions.indexOf(t)<0){e.urlParameters[t]=a.queryParameters[t]}}.bind(this))}if(l?s&&!o:s){g(e.urlParameters,{$expand:s})}if(l?n&&!o:n){g(e.urlParameters,{$expand:n})}if(l&&!o){e.sorters=this._sorters}else if(l&&o){e.filters=u}};y.prototype._fetchData=function(e,t,i,r,a,s){var n=this;if(r){return new Promise(function(r,l){if(!e){l({error:null,bToFetchTotalData:a})}i.success=function(e,t){if(a===true){n._oTotalReadObject=null}else{n._oTop4ReadObject=null}if(s&&(s.Criticality||s.CriticalityCalculation)){e=o.CalculateCriticality(s,e,n.getMeasureField())}else if(!a){e=o.CalculateDimensionCriticality(n.getModel(),n.getDimensionField(),n.getEntitySet(),e)}var i=e&&e.results&&e.results.length?e.results.length:0;r({data:e,iDataLength:i})};i.error=function(e,t){l({error:e,bToFetchTotalData:t})};if(a){n._oTotalReadObject=e.read(t,i)}else{n._oTop4ReadObject=e.read(t,i)}})}this._oObject=e.read(t,i)};y.prototype._getSorter=function(e){var i=[],r=[],a=[];for(var s=0;s<e.length;s++){i[s]=e[s].Field.String;r[s]=e[s].Descending.Boolean;a.push(new t(i[s],r[s]))}var n={sorter:a,sortFields:i};return n};y.prototype._getNumberFormatter=function(e){var t=a.getIntegerInstance({style:"short",showScale:false,shortRefNumber:e});return t};y.prototype.setWidth=function(e){this.setProperty("width",e)};y.prototype.setHeight=function(e){this.setProperty("height",e)};y.prototype.setEntitySet=function(e){this.setProperty("entitySet",e)};y.prototype.setDimensionField=function(e){this.setProperty("dimensionField",e)};y.prototype.setDimensionFieldIsDateTime=function(e){this.setProperty("dimensionFieldIsDateTime",e)};y.prototype.setDimensionFieldDisplay=function(e){this.setProperty("dimensionFieldDisplay",e)};y.prototype.setMeasureField=function(e){if(e&&e.constructor===Object){if(e.value){this.setProperty("measureField",e.value)}if(e.bUpdateBinding){this._updateBinding()}}else if(e&&e.constructor===Array){this.setProperty("measureField",e)}else{this.setProperty("measureField",e)}};y.prototype.setUnitField=function(e){this.setProperty("unitField",e)};y.prototype.setSortOrder=function(e){if(e&&e.constructor===Object){if(e.value){this.setProperty("sortOrder",e.value)}if(e.bUpdateBinding){this._updateBinding()}}else if(e&&e.constructor===Array){this.setProperty("sortOrder",e)}else{this.setProperty("sortOrder",e)}};y.prototype.setDimensionFilterExternal=function(e){this.setProperty("dimensionFilterExternal",e);if(this._bAllowBindingUpdateOnPropertyChange){this._updateBinding()}};y.prototype.getP13NConfig=function(){var e=["width","height","filterRestriction","isDropDown","sortOrder","measureField","scaleFactor","numberOfFractionalDigits","chartQualifier","entitySet","dimensionField","dimensionFieldDisplay","dimensionFieldIsDateTime","dimensionFilter","unitField","isCurrency","isMandatory","outParameter","inParameters","parentProperty"];var t={};for(var i=0;i<e.length;i++){var r=e[i];t[r]=this.getProperty(r);if((r=="outParameter"||r=="inParameters")&&t[r]==""){t[r]=undefined}}return t};y.prototype.setDimensionFilter=function(e,t){this.setProperty("dimensionFilter",e,true)};y.prototype._onDataReceived=function(e){if(!e){return}this.data("sOverlay","none");if(!this.getParent()){this.data("needsToUpdateAria","true")}else{this.data("needsToUpdateAria","false");if(this.data("isDialogFilterItem")==="true"){r._updateVisualFilterAria(this.getParent().getParent())}}this._determineUnit(e);this._getShortRefNumber(e.slice(0))};y.prototype._determineUnit=function(e){this._multiUnit=false;var t=this.getUnitField();if(t){var i=e[0][t];for(var a=1;a<e.length;a++){if(e[a].dimensionValue!==m){var s=e[a][t]}if(s!=i){if(e.length>1){this._multiUnit=true}break}i=s}var n=r.getUnitFieldText(this.getModel(),this.getEntitySet(),t);if(n&&r.IsNavigationProperty(this.getModel(),this.getEntitySet(),n)){var l=n.split("/")[0],o=n.split("/")[1];this._applyUnitValue(this._multiUnit?"":i+" ("+e[0][l][o]+")");return}if(n){n=e[0][n];this._applyUnitValue(this._multiUnit?"":i+" ("+n+")")}else{this._getUnitTextFromValueList(t,i)}}else{this._applyUnitValue("")}};y.prototype._getUnitTextFromValueList=function(e,t){var i=this;var a=this.getModel().getMetaModel();var s=a.getODataEntitySet(this.getEntitySet());var n=a.getODataEntityType(s.entityType);var l=a.getODataProperty(n,e);if(l["com.sap.vocabularies.Common.v1.ValueList"]){var o=l["com.sap.vocabularies.Common.v1.ValueList"].CollectionPath?l["com.sap.vocabularies.Common.v1.ValueList"].CollectionPath.String:"";var u=l["com.sap.vocabularies.Common.v1.ValueList"].Parameters&&l["com.sap.vocabularies.Common.v1.ValueList"].Parameters[0].ValueListProperty?l["com.sap.vocabularies.Common.v1.ValueList"].Parameters[0].ValueListProperty.String:""}if(o&&u){var p=r.getUnitFieldText(this.getModel(),o,u);if(p){var c="/"+o;var d=new sap.ui.model.Filter({path:u,operator:"EQ",value1:t});var h=[];h.push(d);this.aSelectFields=[];this.aSelectFields.push(u);this.aSelectFields.push(p);this.prevUnit=t;var m={$select:this.aSelectFields};var y={async:true,filters:h,urlParameters:m};g(y,{success:function(e,t){i._oObject=null;i._onValueListUnitDataReceived(e)},error:function(e){f.error("Error reading URL:"+e);if(e&&e.statusCode!==0&&e.statusText!=="abort"){i.applyOverlay(i.technicalIssueMessage);i._oObject=null}}});this._oObject=this.getModel().read(c,y)}}else{this._applyUnitValue(this._multiUnit?"":t)}};y.prototype._onValueListUnitDataReceived=function(e){var t=e.results[0];if(t[this.aSelectFields[0]]==this.prevUnit){var i=t[this.aSelectFields[1]]}this._applyUnitValue(this.prevUnit+" ("+i+")")};y.prototype._applyUnitValue=function(e){if(this._lastUnitValue!=e){this._lastUnitValue=e;this.fireTitleChange()}};y.prototype._getShortRefNumber=function(e){this._scaleValue="";this._shortRefNumber=undefined;var t=this.getScaleFactor(),i;if(!t){var r=this._getScaleFactorFromMedian(e);t=r.iShortRefNumber;i=r.scale}else{var a=this._getNumberFormatter(t);i=a.getScale()?a.getScale():""}this._shortRefNumber=t;this._scaleValue=i;this.fireTitleChange()};y.prototype._getScaleFactorFromMedian=function(e){var t=this.getMeasureField();e.sort(function(e,i){if(Number(e[t])<Number(i[t])){return-1}if(Number(e[t])>Number(i[t])){return 1}return 0});var i=e.length/2,r=i%1===0?(parseFloat(e[i-1][t])+parseFloat(e[i][t]))/2:parseFloat(e[Math.floor(i)][t]),a=r,s;for(var n=0;n<14;n++){s=Math.pow(10,n);if(Math.round(Math.abs(a)/s)<10){break}}var l=this._getNumberFormatter(s);for(var n=0;n<e.length;n++){var o=e[n],u=l.format(o[t]),g=u.split(".");if(!g[1]&&parseInt(g[0],10)===0||g[1]&&parseInt(g[0],10)===0&&g[1].indexOf("0")===0||u/1e3>=1e3){s=undefined;break}}return{iShortRefNumber:s,scale:s?l.getScale():""}};y.prototype._getScaleFactor=function(e){var e=parseFloat(e);var t=this._minFractionalDigits;for(var i=0;i<14;i++){var r=Math.pow(10,i);if(Math.round(Math.abs(e)/r,t-1)<10){return r}}return undefined};y.prototype.getTitle=function(e){var t=this.getModel();if(!t){return""}var i=r.getPropertyNameDisplay(t,this.getEntitySet(),this.getMeasureField(),e);var a=r.getPropertyNameDisplay(t,this.getEntitySet(),this.getDimensionField(),e);var s=this._lastUnitValue?this._lastUnitValue:"";var n=this._scaleValue?this._scaleValue:"";var l=this.getModel("i18n");if(!l){return""}var o=l.getResourceBundle();var u=o.getText("VIS_FILTER_TITLE_MD",[i,a]);var g=n+" "+s;g=g.trim();g=g.indexOf("%")>-1?"":g;var p=r.getPropertyNameDisplay(t,this.getEntitySet(),this.getMeasureField(),e,true);var f=r.getPropertyNameDisplay(t,this.getEntitySet(),this.getDimensionField(),e,true);var c=o.getText("VIS_FILTER_TITLE_MD",[p,f]);var d={titleMD:u,titleUnitCurr:g,titleQuickInfo:c};return d};y.prototype.getFormattedNumber=function(e,t){var i=this.getNumberOfFractionalDigits();if(i===""||i===undefined){i="1"}else{if(Number(i)>1){i="1"}}var r=a.getFloatInstance({style:"short",decimals:Number(i),showScale:t,shortRefNumber:this._shortRefNumber,minFractionDigits:this._minFractionalDigits,maxFractionDigits:this._maxFractionalDigits});return r.format(parseFloat(e))};y.prototype._getFormattedNumberWithUoM=function(e,t,i){t=t?t:"";i=i?" ("+i+")":"";var r=sap.ui.getCore().getConfiguration().getFormatSettings().getFormatLocale();var s=a.getFloatInstance({maxFractionDigits:3,groupingEnabled:true},r).format(e);return t==="%"?s+"%":s+" "+t+i};y.prototype._getDisplayedValue=function(e,t){var i=this._scaleValue==="",r=this.getFormattedNumber(e,i),a=t==="%";return a?r+"%":""+r};y.prototype._getToolTip=function(e,t,i,r,a){var s=this.getModel("i18n");if(!s){return""}var n=s.getResourceBundle();var l=this._getFormattedNumberWithUoM(t,i,r);var o;switch(a){case"Good":o=n.getText("VIS_FILTER_TOOLTIP_STATUS_GOOD");break;case"Error":o=n.getText("VIS_FILTER_TOOLTIP_STATUS_ERROR");break;case"Critical":o=n.getText("VIS_FILTER_TOOLTIP_STATUS_CRITICAL");break;default:o="Neutral"}if(o==="Neutral"){return e+" "+l}else{return e+" "+l+"\n"+o}};y.prototype._getSelected=function(e,t){var i=false,a=this.getFilterRestriction(),s=[];if(e){if(a==="multiple"){if(e.items){e.items.forEach(function(e){var a=r.getResolvedDimensionValue(e.key),s=r.getResolvedDimensionValue(t);if(a===s){i=true}})}if(e.value&&e.value===t){i=true;return i}if(e.ranges){var s=e.ranges.filter(function(e){if(e.exclude&&(e.operation==="EQ"||e.operation==="Empty")){return e}});for(var n=0;n<e.ranges.length;n++){var l=e.ranges[n];if((l.operation==="EQ"||l.operation==="Empty")&&(l.value1||l.value1==="")&&!l.exclude){if(l.value1 instanceof Date&&t instanceof Date){if(this.getDimensionFieldIsDateTimeOffset()){if(r.getDateTimeInMedium(l.value1)===r.getDateTimeInMedium(t)){i=true;break}}else if(r.getDateInMedium(l.value1)===r.getDateInMedium(t)){i=true;break}}else if(l.value1===t||this._isDateTimeFieldSelected(l.value1,t)){i=true;break}}}if(i){for(var n=0;n<s.length;n++){if(s[n].value1===t&&s[n].operation==="EQ"){i=false;break}}}if(s.length===2&&t===m){var o=0,u=this._chart.getSegments();u.forEach(function(e){var t=e.getCustomData()[0].getValue();s.forEach(function(e){if(e.value1.indexOf(t)>-1){o++}})});if(o===2){i=true}}}}else if(e instanceof Date&&t instanceof Date){if(this.getDimensionFieldIsDateTimeOffset()){if(r.getDateTimeInMedium(e)===r.getDateTimeInMedium(t)){i=true}}else if(r.getDateInMedium(e)===r.getDateInMedium(t)){i=true}}else if(e&&e===t){i=true}else if(this._isDateTimeFieldSelected(e,t)){i=true}}return i};y.prototype._isDateTimeFieldSelected=function(e,t){if(this.getDimensionFieldIsDateTime()){if(typeof e==="string"&&t instanceof Date){if(r.getDateInMedium(new Date(e))===r.getDateInMedium(t)){return true}}else if(e instanceof Date&&typeof t==="string"){var i=n.getDateInstance({pattern:"yyyyMMdd"});var a=i.parse(t);if(r.getDateInMedium(a)===r.getDateInMedium(e)){return true}}else if(e instanceof Object&&t instanceof Date){if(e.ranges.length&&r.getDateInMedium(e.ranges[0].value1)===r.getDateInMedium(t)){return true}}else if(e instanceof Object&&typeof t==="string"){var i=n.getDateInstance({pattern:"yyyyMMdd"});var a=i.parse(t);if(e.ranges.length&&r.getDateInMedium(e.ranges[0].value1)===r.getDateInMedium(a)){return true}}}else if(this.getDimensionFieldIsDateTimeOffset()){if(typeof e==="string"&&t instanceof Date){if(r.getDateTimeInMedium(new Date(e))===r.getDateTimeInMedium(t)){return true}}}return false};y.prototype._getLabel=function(e,t,i){if(this.getDimensionFieldIsDateTime()){if(t&&t!=m){e=t}var a=this._getCurrentSelectedChart(true);if(e instanceof Date){return r.getDateInMedium(r.convertLocalDatetoUTCDate(e))}else if(this._isStringDateType()=="yearmonthday"){return t===m?e:r.formatStringDate(e,a,i)}else if(this._isStringDateType()=="yearmonth"){return t===m?e:r.formatStringDateYearMonth(e,a,i)}else if(this._isStringDateType()=="yearweek"){return t===m?e:r.formatStringDateYearWeek(e,a,i)}else if(this._isStringDateType()=="yearquarter"){return t===m?e:r.formatStringDateYearQuarter(e,a,i)}else if(this._isStringDateType()=="fiscalyearperiod"){return t===m?e:r.formatStringFiscalYearPeriod(e,a,i)}else{return e}}else if(this.getDimensionFieldIsDateTimeOffset()){return r.getDateTimeInMedium(e)}else{var s=this.getTextArrangement();return r.getTextArrangement(e,t,s)}};y.prototype._getChartAggregationSettings=function(e){var t=sap.ui.getCore().byId(this.getSmartFilterId());var i=e===c?"dimensionValue":this.getDimensionField(),a=this.getDimensionFieldDisplay(),s=this.getMeasureField(),n=this.getUnitField(),l=n&&r.getUnitFieldText(this.getModel(),this.getEntitySet(),n),o=i===a?[a]:[a,i],u=i===a?[a,s,""]:[a,s,i],g=n?u.push(n):u,g=l?u.push(l):u,p=this,f={label:{parts:o,formatter:function(e,t){return p._getLabel(e,t,false)||p._getI18nText("NOT_ASSIGNED")}},value:{path:s,formatter:function(e){return parseFloat(e)}},color:"{color}",displayedValue:{parts:[s,n],formatter:function(e,t){return p._getDisplayedValue(e,t)}},tooltip:{parts:g.constructor===Array?g:u,formatter:function(e,t,i,r,a){e=e||e===""||e===0?e:"";i=i||i===""||i===0?i:"";i=i.constructor===Object?"":i;e=p._getLabel(e,i,false)||p._getI18nText("NOT_ASSIGNED");return p._getToolTip(e,t,r,a,this.getColor())}},selected:{parts:t.isDialogOpen()?["_dialogFilter>/"+p.getParentProperty(),i]:["_filter>/"+p.getParentProperty(),i],formatter:function(e,t){if(t instanceof Date){t=p.getDimensionFieldIsDateTimeOffset()?t:r.convertLocalDatetoUTCDate(t)}return p._getSelected(e,t)}},customData:{Type:"sap.ui.core.CustomData",key:i,value:"{"+i+"}"}};if(e===d&&p._isStringDateType()&&p._isStringDateType()!=="year"){f.secondaryLabel={parts:o,formatter:function(e,t){return p._getLabel(e,t,true)}}}return f};y.prototype.applyOverlay=function(e,t){if(e){this._chart.setShowError(true);this._chart.setErrorMessageTitle(this._getI18nText("M_VISUAL_FILTERS_ERROR_MESSAGE_TITLE"));this._chart.setErrorMessage(this.getModel("i18n").getResourceBundle().getText(e,t));this._chart.setBusy(false);this.data("sOverlay","true");if(this.data("isDialogFilterItem")==="true"){this.data("needsToUpdateAria","true")}this.fireTitleChange()}else{this._chart.setShowError(false);this._chart.setErrorMessageTitle("");this._chart.setErrorMessage("")}};y.prototype.considerAnalyticBinding=function(e,t){if(t&&t.getAnalyticBindingPath&&t.getConsiderAnalyticalParameters()){try{var i=t.getAnalyticBindingPath();if(i){return i}}catch(e){f.warning("Mandatory parameters have no values")}}return e};y.prototype._getBindingPathforVisualFilter=function(e,t,r){var a="";var s=new i.Model(i.Model.ReferenceByModel(e));var n=s.findQueryResultByName(t);var l=new i.QueryResultRequest(n);var o=n&&n.getParameterization();if(o){l.setParameterizationRequest(new i.ParameterizationRequest(o));if(r){Object.keys(r).forEach(function(e){l.getParameterizationRequest().setParameterValue(e,r[e])})}}try{a=l.getURIToQueryResultEntitySet()}catch(e){n=l.getQueryResult();a="/"+n.getEntitySet().getQName();f.error("getEntitySetPathWithParameters","binding path with parameters failed - "+e||e.message)}return a};y.prototype.checkSearchable=function(e,t,a,s,n){var l=new i.Model(i.Model.ReferenceByModel(e));var o=l.findQueryResultByName(t);var u=o&&o.getParameterization(),g=[],p={bIsMandatoryFilter:true};p=r.checkManditoryFieldsFilled(a);if(p.aMandatoryFilter.length===1){y.prototype.missingMandatoryField="M_VISUAL_FILTERS_PROVIDE_FILTER_VAL_SINGLEVF";return p}if(!p.bIsMandatoryFilter){y.prototype.missingMultipleMandatoryFields="M_VISUAL_FILTERS_PROVIDE_FILTER_VAL_MULTIPLEVF";return p}if(u){var f=[];var c=u.getAllParameters();for(var d in c){if(!c[d].isOptional()){f.push(c[d].getName())}}f.forEach(function(e){s&&s.forEach(function(t){if(t.PropertyName.PropertyPath===e&&t.PropertyValue.String){g.push("$Parameter."+t.PropertyName.PropertyPath)}})});y.prototype.missingMultipleMandatoryFields="REQUIRED_VH_FIELDS_OVERLAY_MESSAGE";if(a.getEntitySet()===t){y.prototype.missingMultipleMandatoryFields="M_VISUAL_FILTERS_PROVIDE_FILTER_VAL_MULTIPLEVF";var h=a.getFilterData(true);f.forEach(function(e){if(h["$Parameter."+e]&&g.indexOf("$Parameter."+e)<0){g.push("$Parameter."+e)}})}if(f.length!==g.length){p.bIsMandatoryFilter=false;return p}}if(a.getEntitySet()===t){y.prototype.missingMultipleMandatoryFields="M_VISUAL_FILTERS_PROVIDE_FILTER_VAL_MULTIPLEVF";var m=a.determineMandatoryFilterItems();var m=m.filter(function(e){return!e._bIsParameter});p.bIsMandatoryFilter=m.every(function(e){return r.checkFilterHasValueFromSelectionVariantOrSmartFilterBar(e.getName(),e.getName(),n,a)})}else{y.prototype.missingMultipleMandatoryFields="REQUIRED_VH_FIELDS_OVERLAY_MESSAGE";var _;if(!y.prototype.valuehelpAllMandatoryFilters[t]){y.prototype.valuehelpAllMandatoryFilters[t]=r.getAllMandatoryFilters(e,t)}_=r.getAllMandatoryFiltersMapping(y.prototype.valuehelpAllMandatoryFilters[t],this.getInParameters());p.bIsMandatoryFilter=_.aMappedFilterList.every(function(e){return r.checkFilterHasValueFromSelectionVariantOrSmartFilterBar(e.valueListProperty,e.localDataProperty,n,a)});if(!p.bIsMandatoryFilter){return p}p.bIsMandatoryFilter=_.aMappingMissingFilterList.every(function(e){var t=n&&r.checkFilterHasValueFromSelectionVariant(n,e);return t})}return p};y.prototype._getDateInUTCOffset=function(e){return new Date(e.valueOf()-e.getTimezoneOffset()*60*1e3)};y.prototype._isStringDateType=function(){var e=this.getCustomData();var t;e.forEach(function(e){if(e.getKey()=="stringdate"){t=e.getValue()}});return t};y.prototype._determineHiddenVisualFilter=function(e,t,i){var r=this._getMeasureProperty(e,t,i);if(r[s.Hidden]&&r[s.Hidden].Bool==="true"){return true}};y.prototype._determineIfInvalidMeasure=function(e,t,i){var r=this._getMeasureProperty(e,t,i);if(r["com.sap.vocabularies.Analytics.v1.AccumulativeMeasure"]&&r["com.sap.vocabularies.Analytics.v1.AccumulativeMeasure"].Bool==="false"){return true}return false};y.prototype._getMeasureProperty=function(e,t,i){var r=e.getODataEntityType(e.getODataEntitySet(t).entityType);var a=e.getODataProperty(r,i);return a};y.prototype._determineInteger=function(e,t,i){var a=false;var s=this._getMeasureProperty(e,t,i);if(s.type&&r.isInteger(s.type)){a=true}return a};y.prototype._getI18nText=function(e){var t=this.getModel("i18n");if(!t){return""}var i=t.getResourceBundle();return i.getText(e)};return y},true);
//# sourceMappingURL=FilterItemMicroChart.js.map