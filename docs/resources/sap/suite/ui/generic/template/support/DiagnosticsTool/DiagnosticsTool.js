sap.ui.define(["sap/ui/core/support/Plugin","sap/ui/core/format/DateFormat","sap/ui/model/json/JSONModel","sap/m/MessageToast","sap/suite/ui/generic/template/support/lib/CommonChecks","sap/suite/ui/generic/template/support/lib/CommonMethods","sap/suite/ui/generic/template/genericUtilities/testableHelper","sap/base/util/extend","sap/ui/core/mvc/XMLView"],function(e,t,a,n,i,o,s,r,u){"use strict";var p="sapUiSupportFioriElementsPluginALPLROP";window.diagnosticToolSpace={};function l(e){var n,r,l=p+"-View",f=[],c=sap.ui.getCore().getEventBus(),d,v,m,g,h,S=10,b;function R(){return p}function w(e){var a=t.getDateInstance({source:{pattern:"YYYYMMdd"},style:"short"});return a.format(a.parse(String(e).substring(0,8)))}function A(e){var t=window.location.origin;var a=window.location.pathname;var n=e||i.getComponentIDByStructure();if(n){d=i.getManifestPath(n);if(d){var o=i.getManifestURL(t,a,d);if(o){return o}}}return""}function D(e,t,a,n,i){if(e==="string"){f.push({order:a,name:t,type:e,value:n});return true}else if(e==="link"){f.push({order:a,name:t,type:e,value:n,target:i});return true}else if(e==="group"){f.push({order:a,name:t,type:e});return true}return false}function O(e,t,a){return D("string",e,t,a,"")}function E(e,t,a,n){return D("link",e,t,a,n)}function I(e,t){return D("group",e,t,"","")}function C(e){if(!(e&&o.hasObjectContent(e))){return undefined}if(!(e.getMetadata()&&o.hasObjectContent(e.getMetadata()))){return undefined}var t=e.getMetadata();if(!(t.getManifest()&&o.hasObjectContent(t.getManifest()))){return undefined}return t.getManifest()}function L(e){f=[];O("Error",0,e);H()}function P(e){try{var t=i.getUI5VersionInfo();if(t&&o.hasObjectContent(t)){O("OpenUI5 Version",e,t.version+" (built at "+w(t.buildTimestamp)+")");return true}else{O("OpenUI5 Version",e,"ERROR: OpenUI5 version is not available!");return false}}catch(t){O("OpenUI5 Version",e,sap.ui.version+', detailed UI5 version info is not available! Possible reason: missing file "sap-ui-version.json"');return true}}function j(e){var t=o.getApplicationName(window.location.href);if(t){E("Application URL",e,"#"+t,window.location.href);return true}else{O("Application URL",e,"ERROR: Could not extract application name (#semanticObject-action) from URL!");return false}}function M(e){if(d&&v){var t=d;if(d.indexOf("./")===0){t=d.substring(2,d.length)}E("Manifest",e,t,v);return true}else{O("Manifest",e,"ERROR: Could not generate link to manifest.json! Possible reason: The application did not finish loading or is not a Fiori Elements application.");return false}}function N(e){if(!g){return false}var t=i.getRegistrationIDsByManifest(g);if(t&&Array.isArray(t)&&t.length>0){O(t.length>1?"Fiori IDs":"Fiori ID",e,o.concatStrings(t));return true}return false}function y(e){var t=i.getApplicationComponentByManifest(g);if(t){O("Application Component (ACH)",e,t);return true}else{O("Application Component (ACH)",e,"ERROR: Path /sap.app/ach not found in manifest.json! Possible reason: Invalid manifest.json");return false}}function F(e){var t=i.getApplicationIDByManifest(g);if(t){O("Application ID",e,t);return true}else{O("Application ID",e,"ERROR: Path /sap.app/id not found in manifest.json! Possible reason: Invalid manifest.json");return false}}function U(e){if(g){var t=i.getFloorplanByManifest(g)}else{t=i.getFloorplanByStructure()}if(!i.isValidFloorplan(t)){t=i.mFloorplans.UNKNOWN}if(t===i.mFloorplans.UNKNOWN){O("Floorplan Component (ACH)",e,i.getTicketComponentForFloorplan(t)+" (ERROR: Unknown floorplan! Possible reason: Invalid manifest.json)");return false}else{O("Floorplan Component (ACH)",e,i.getTicketComponentForFloorplan(t)+" ("+t+")");return true}}function T(e,t){if(!(g&&o.hasObjectContent(g))){return false}if(!(g["sap.app"]&&g["sap.app"].dataSources&&g["sap.app"].dataSources[e])){O("OData Service Metadata",t,"ERROR: Data source "+e+" not found at /sap.app/dataSources/"+e+" in manifest.json! Possible reason: Invalid manifest.json");return false}if(!g["sap.app"].dataSources[e].uri){O("OData Service Metadata",t,"ERROR: Data source URI not found at /sap.app/dataSources/"+e+"/uri in manifest.json! Possible reason: Invalid manifest.json");return false}var a=g["sap.app"].dataSources[e].uri;if(a.lastIndexOf("/")!==a.length-1){a+="/"}a+="$metadata";E("OData Metadata",t,a,window.location.origin+a);return true}function k(e,t){if(!(g&&o.hasObjectContent(g)&&m)){return false}if(!(g["sap.app"]&&g["sap.app"].dataSources&&g["sap.app"].dataSources[e])){O("Annotations",t,"ERROR: Data source "+e+" not found at /sap.app/dataSources/"+e+" in manifest.json! Possible reason: Invalid manifest.json");return false}if(!(g["sap.app"].dataSources[e].settings&&g["sap.app"].dataSources[e].settings.annotations&&g["sap.app"].dataSources[e].settings.annotations!==[])){O("Annotations",t,"ERROR: Data source "+e+" has no annotations at /sap.app/dataSources/"+e+"/settings/annotations in manifest.json! Possible reason: Invalid manifest.json");return false}var a=g["sap.app"].dataSources[e].settings.annotations;a=a.reverse();for(var n in a){if(!a.hasOwnProperty(n)){continue}var i=a[n];if(g["sap.app"].dataSources[i]){var s=g["sap.app"].dataSources[i].uri;if(!s){continue}var r="";var u="";if(s.indexOf("/")===0){u="Backend Annotation";r=window.location.origin}else{u="Local Annotation";r=m;if(r.lastIndexOf("/")!==r.length-1){r+="/"}}u+=" (Prio. "+parseInt(parseInt(n,10)+1,10)+")";E(u,t,g["sap.app"].dataSources[i].uri,r+g["sap.app"].dataSources[i].uri)}}return true}function V(e){if(!g){return}var t=0;function a(e){t+=.01;return e+t}if(!(g["sap.ui5"]&&g["sap.ui5"].models)){O("Data Sources",e,"ERROR: Path /sap.ui5/models not found in manifest.json! Possible reason: Invalid manifest.json");return}var n=g["sap.ui5"].models;var i=[];for(var s in n){if(!n.hasOwnProperty(s)){continue}if(n[s]&&n[s].dataSource&&n[s].dataSource!==""){var r=false;for(var u in i){if(!i.hasOwnProperty(u)){continue}if(i[u].dataSource===n[s].dataSource){r=true;break}}var p=s===""?"mainService":s;if(!r){i.push({models:[p],dataSource:n[s].dataSource})}else{i[u].models.push(p)}}}if(i.length===0){O("Data Sources",e,"ERROR: No models with data sources found in manifest.json! Possible reason: Invalid manifest.json");return}for(var l in i){if(!i.hasOwnProperty(l)){continue}if(!(g["sap.app"]&&g["sap.app"].dataSources)){O("Data Sources",e,"ERROR: No data sources found at /sap.app/dataSources in manifest.json! Possible reason: Invalid manifest.json");return}if(!g["sap.app"].dataSources[i[l].dataSource]){O("Data Sources",e,"ERROR: Data source "+i[l].dataSource+" not found at /sap.app/dataSources/"+i[l].dataSource+" in manifest.json! Possible reason: Invalid manifest.json");return}I(o.concatStrings(i[l].models),a(e));T(i[l].dataSource,a(e));k(i[l].dataSource,a(e))}}function G(e){var t=sap.ui.getCore().byId(e);if(t){return Promise.resolve(t)}return u.create({id:e,viewName:"sap.suite.ui.generic.template.support.DiagnosticsTool.view.DiagnosticsTool",viewData:{plugin:n}})}function x(){G(l).then(function(e){e.placeAt(p);var t=new a;e.setModel(t,"data")})}function B(){n=this;r=window.location.hash.slice(1);if(e.isToolStub()){if(!e.hasListeners(p+"SetData")){e.attachEvent(p+"SetData",_)}if(!e.hasListeners(p+"UpdateStatus")){e.attachEvent(p+"UpdateStatus",q)}if(!e.hasListeners(p+"ShowDataRefreshed")){e.attachEvent(p+"ShowDataRefreshed",z)}window.diagnosticToolSpace.fioriElementsPluginID=p;x()}else{if(!e.hasListeners(p+"GetData")){e.attachEvent(p+"GetData",$)}c.unsubscribe("elements","ViewRendered",Z);c.unsubscribe("elements","ViewRenderingStarted",Z);c.subscribe("elements","ViewRendered",Z);c.subscribe("elements","ViewRenderingStarted",Z);if("onhashchange"in window){window.addEventListener("hashchange",ee)}}$()}function K(){if(e.isToolStub()){window.diagnosticToolSpace.fnFEPluginToolInstanceExit=undefined;e.detachEvent(p+"SetData",_);e.detachEvent(p+"UpdateStatus",q);e.detachEvent(p+"ShowDataRefreshed",z);G(l).then(function(e){e.destroy()})}else{window.diagnosticToolSpace.fnFEPluginAppInstanceExit=undefined;e.detachEvent(p+"GetData",$);c.unsubscribe("elements","ViewRendered",Z);c.unsubscribe("elements","ViewRenderingStarted",Z);if("onhashchange"in window){window.removeEventListener("hashchange",ee)}}}function W(){e.sendEvent(p+"GetData",{})}function H(){var t={};t.origin=window.location.origin;t.url=window.location.href;var n=new a;f.sort(o.getDynamicComparator("order"));t.properties=f;var i=(new Date).toLocaleTimeString([],{hour12:false,hour:"2-digit",minute:"2-digit",second:"2-digit"});t.retrieval=i;var s=true;if(!f||f.length===0){s=false}t.copyEnabled=s;var r=o.getApplicationStatus();if(!r){o.setApplicationStatus(o.mApplicationStatus.UNKNOWN);r=o.mApplicationStatus.UNKNOWN}t.status=r;var u="";if(r===o.mApplicationStatus.FAILED){u="The application did not finish loading or is no Fiori Elements application! The shown data below could be collected anyway. If the application finishes loading, the data will be updated automatically."}t.statusMessage=u;n.setData(t);e.sendEvent(p+"SetData",t)}function Y(t,a){e.sendEvent(p+"UpdateStatus",{timeLeft:t,status:a})}function J(){e.sendEvent(p+"ShowDataRefreshed",{})}function X(e){if(v){m=i.getRootPath(v)}f=[];H();P(1);j(2);M(3);H();if(e&&g&&o.hasObjectContent(g)){N(3);y(4);U(5);V(6);H();J()}else if(v){o.getFileFromURI(v).then(function(e){g=e;N(3);F(4);y(5);U(6);V(7)}).catch(function(){O("Manifest",3,"ERROR: Could not access manifest.json even though link could be generated! Possible reason: missing permission to access file.")}).finally(function(){H();J()})}}function $(){g=undefined;v=undefined;m=undefined;var e=o.getApplicationStatus();var t=o.getAppComponent();var a=false;if(!(e&&o.isValidApplicationStatus(e))){e=o.mApplicationStatus.UNKNOWN}if(e===o.mApplicationStatus.LOADING){Z();return}else if(e===o.mApplicationStatus.FAILED){var n=C(t);if(n&&o.hasObjectContent(n)){g=n;if(g&&g["sap.app"]&&g["sap.app"].id){v=A(g["sap.app"].id);if(!v){a=true}}else{a=true}}else{L("Could not load any data because manifest and component of current application are unknown!");J();return}}else if(e===o.mApplicationStatus.RENDERED){v=A();if(!v){n=C(t);if(n&&o.hasObjectContent(n)){g=n;if(g&&g["sap.app"]&&g["sap.app"].id){v=A(g["sap.app"].id);if(!v){a=true}}else{a=true}}else{L("Could not load any data because manifest and component of current application are unknown!");J();return}}}else if(e===o.mApplicationStatus.UNKNOWN){if(i.getFloorplanByStructure()!==i.mFloorplans.UNKNOWN){g=i.getManifestByStructure();if(g&&o.hasObjectContent(g)){if(g&&g["sap.app"]&&g["sap.app"].id){v=A(g["sap.app"].id);if(!v){a=true}}else{a=true}}}else{L("Could not load any data because manifest and component of current application are unknown!");J();return}}X(a)}function _(e){var t=new a;t.setJSON(JSON.stringify(e.getParameters()));G(l).then(function(e){e.setModel(t,"data");e.invalidate()})}function q(e){var t=e.getParameters();G(l).then(function(e){e.getController().updateStatus(t.timeLeft,t.status)})}function z(){G(l).then(function(e){e.getController().showDataRefreshed()})}function Q(){var e=o.getApplicationStatus();if(b>0){Y(b,e)}else{b=S;o.setApplicationStatus(o.mApplicationStatus.FAILED);Y(0,o.mApplicationStatus.FAILED);h.removeListener(Q);h=undefined;$()}b--}function Z(e,t){if(t==="ViewRenderingStarted"||!t&&o.getApplicationStatus()===o.mApplicationStatus.LOADING){o.setApplicationStatus(o.mApplicationStatus.LOADING);if(!h){b=S;h=new sap.ui.core.IntervalTrigger(1e3);h.addListener(Q)}}else if(t==="ViewRendered"){o.setApplicationStatus(o.mApplicationStatus.RENDERED);b=S;if(h){h.removeListener(Q);h=undefined}$()}}function ee(e){function t(e){for(var t=0;t<e.length;t++){if(e[t]==="/"||e[t]==="&"||e[t]==="?"||e[t]==="~"){return t}}return e.length}function a(e,a){if(!e||!a){return false}if(e===a){return true}var n=t(e);var i=t(a);if(n!==i){return false}else if(e.substr(0,n)===a.substr(0,i)){return true}return false}var n,i,s=false;if(e.originalEvent.oldURL&&e.originalEvent.newURL){n=e.originalEvent.oldURL.split("#")[1];i=e.originalEvent.newURL.split("#")[1]}else{n=r;i=window.location.hash.slice(1);r=i}if(n.length>=i.length){s=a(i,n)}else{s=a(n,i)}if(!s){o.setApplicationStatus(o.mApplicationStatus.LOADING);o.setAppComponent(undefined);Z();b=S/2}}function te(){return e}function ae(){return f}function ne(){f=[]}function ie(e){g=e}function oe(e){v=e}function se(e){d=e}function re(e){m=e}var w=s.testable(w,"DiagnosticsTool_fnFormatDate");var C=s.testable(C,"fnGetManifestFromAppComponent");var D=s.testable(D,"fnAddToData");var O=s.testable(O,"fnAddStringToData");var E=s.testable(E,"fnAddLinkToData");var I=s.testable(I,"fnAddGroupHeaderToData");var L=s.testable(L,"fnDisplayError");var P=s.testable(P,"fnAddVersionInfo");var M=s.testable(M,"fnAddManifestLink");var y=s.testable(y,"fnAddApplicationComponent");var U=s.testable(U,"fnAddFloorplanComponent");var T=s.testable(T,"fnAddODataServiceMetadataLink");var k=s.testable(k,"fnAddAnnotationsLinks");var V=s.testable(V,"fnAddDataSources");var N=s.testable(N,"fnAddFioriID");var F=s.testable(F,"fnAddApplicationID");var te=s.testable(te,"fnGetSupportStub");var ae=s.testable(ae,"fnGetData");var ne=s.testable(ne,"fnResetData");var ie=s.testable(ie,"fnSetManifest");var oe=s.testable(oe,"fnSetManifestURL");var se=s.testable(se,"fnSetManifestPath");var re=s.testable(re,"fnSetsRootPath");return{init:B,exit:K,getId:R,onRefresh:W}}return e.extend("sap.suite.ui.generic.template.support.DiagnosticsTool.DiagnosticsTool",{constructor:function(t){e.apply(this,[p,"SAP Fiori Elements",t]);r(this,l(t))}})});
//# sourceMappingURL=DiagnosticsTool.js.map