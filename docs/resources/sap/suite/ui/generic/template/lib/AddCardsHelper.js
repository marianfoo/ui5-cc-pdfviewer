sap.ui.define(["sap/m/p13n/Popup","sap/m/p13n/SelectionPanel","sap/suite/ui/generic/template/genericUtilities/metadataAnalyser","sap/suite/ui/generic/template/lib/filterHelper","sap/fe/navigation/SelectionVariant"],function(e,a,t,n,r){"use strict";var i={};i.showColumnsForCardGeneration=function(e,a){return new Promise(function(t,n){var r=e["entityType"];var i=e["currentControlHandler"].getModel().getMetaModel();var o=[];e["currentControlHandler"].getVisibleProperties().filter(function(e){var a=e.data("p13nData")&&e.data("p13nData").columnKey;var t=i.getODataProperty(r,e.data("p13nData").leadingProperty);if(t&&(t.type==="Edm.Date"||t.type==="Edm.DateTime"||t.type==="Edm.DateTimeOffset")){return}if(t&&t["sap:label"]){if(e.getVisible()&&(a.indexOf("DataFieldForAnnotation")<0&&!e.data("p13nData").actionButton&&!!e.data("p13nData").leadingProperty)){var n={visible:false,name:t.name,label:t["sap:label"]};o.push(n)}}});R(o,a,e,t)})};i.createAnalyticalCardForPreview=function(e){return o(e)};var o=function(e,a){var t=e["component"];var n=t.getAppComponent().getMetadata();var r=n.getManifestEntry("sap.ui");var i=n.getManifestEntry("sap.app");var o={};var u="user."+i.id+"."+Date.now();i.type="card";i.id=u;o["sap.app"]=i;o["sap.ui"]=r;o["sap.card"]=s(e,a);o["sap.insights"]=l(e);return o};var s=function(e,a){var t={};var n=e["component"].getMetadata().getName();t["type"]=u(n);t["configuration"]=c(e);t["data"]=S(e,t);t["header"]=D(e,t);t["extension"]="module:sap/insights/CardExtension";if(t.type==="Analytical"){t["content"]=T(e,t)}else{t["content"]=P(e,t,a)}i.getCardActions(e,t);return t};var l=function(e){var a=e["component"],t=a.getAppComponent().getMetadata(),n=t.getManifestEntry("sap.app"),r=n.id,i="RT";return{parentAppId:r,cardType:i,versions:{ui5:sap.ui.version+"-"+sap.ui.getVersionInfo().buildTimestamp}}};var u=function(e){switch(e){case"sap.suite.ui.generic.template.ListReport.Component":return"Table";case"sap.suite.ui.generic.template.AnalyticalListPage.Component":return"Analytical";default:return"List"}};var c=function(e){var a={};var t=e["component"];var n=t.getModel().sServiceUrl;a["parameters"]=p(e)["filters"];a["destinations"]={service:{name:"(default)",defaultUrl:"/"}};a["csrfTokens"]={token1:{data:{request:{url:"{{destinations.service}}"+n,method:"HEAD",headers:{"X-CSRF-Token":"Fetch"}}}}};return a};var p=function(e){var a={filters:{}},i=a.filters,o=e.oSmartFilterbar,s=o&&o.getModel(),l=e.view.getModel(),u=e.entityType,c=[],p=[],f=[],h=[],S,D=[],P=[],T=[];if(s){var b=t.checkAnalyticalParameterisedEntitySet(s,u&&u.name);if(b){var O=t.getParametersByEntitySet(s,u&&u.name);if(O.entitySetName){T=O.parameters||[]}}}var C=t.getParametersByEntitySet(l,e.entitySet.name,true).parameters;var x="";C.forEach(function(a){var t=d(a);var r=n.getParameterDefaultValue(s,u,t,e);var p=n.getParameterDefaultValue(l,e.entitySet,t,e);var v=r||p||a.defaultValue||"";var m=n.getParameterActualValue(a.name,o);x=n.getLabelForConfigParams(a.name,o,i,e,v);var g=n.IsSemanticDateRangeValid(e,a);if(g){n.setFilterRestrictionToSemanticDateRange(a,true);v=n.getDateRangeDefaultValue(e,a.name)||v;m=n.getDateRangeValue(m,a,true)||m;if(x&&typeof x==="string"){x=x.substring(0,x.indexOf("(")-1)}else if(v){x=v;n.getLabelForConfigParams(a.name,o,i,e,v,true)}}if(t){f.push(a.name)}i[a.name]={value:m?m:v,type:n.getPropertyType(a),description:a&&a.description,label:x};i[a.name]["description"]=y(a,"description");c.push(a.name);D.push(a.name)});T=T.filter(function(e){return!D.includes(e)});if(u&&u.property){P=m(u.property,T)}for(var V=0;V<P.length;V++){var E=P[V],R="";var M=g(E,u.property);var A=d(M);var I=n.getFilterDefaultValue(E.name,u)||E.defaultValue||"";var F=n.getParameterActualValue(E.name,o);if(D.includes(E.name)){x=n.getLabelForConfigParams(E.name,o,i,e,I);var L=n.IsSemanticDateRangeValid(e,E);if(L){n.setFilterRestrictionToSemanticDateRange(E,true);I=n.getDateRangeDefaultValue(e,E.name)||I;F=n.getDateRangeValue(F,E,true)||F;if(x&&typeof x==="string"){x=x.substring(0,x.indexOf("(")-1)}else if(I){x=I;n.getLabelForConfigParams(E.name,o,i,e,I,true)}}i[E.name]={value:F?F:I,type:n.getPropertyType(E),description:E&&E.description,label:x};if(A){f.push(A)}c.push(E.name)}else{S=new r;var N=n.getLabelForConfigParams(E.name,o,i,e,I);var L=n.IsSemanticDateRangeValid(e,E);if(L){n.setFilterRestrictionToSemanticDateRange(E,false);n.addDateRangeValueToSV(e,E,I,S,N)}else{if(F){n.addFiltervalues(o,E.name,S,N)}else if(I){var w=n.getRelatedTextToRange({Low:I},N,o,E.name);S.addSelectOption(E.name,"I","EQ",I,null,w)}else{S.addSelectOption(E.name,"I","EQ",R)}}i[E.name]={value:S.toJSONString(),type:n.getPropertyType(E),description:E&&E.description};i[E.name].value=n.enhanceVariant(i[E.name].value);if(A){h.push(A)}p.push(E.name)}i[E.name]["description"]=y(E,"description")}var $=e["oFECustomFilterData"];if($){S=new r;S.addSelectOption($.name,"I","EQ",$.value);i[$.name]={value:S.toJSONString(),type:"string",description:""};i[$.name].value=n.enhanceVariant(i[$.name].value);p.push($.name)}var _=o.getBasicSearchName(),k=o.getBasicSearchValue();if(k){S=new r;S.addSelectOption(_,"I","EQ",k);i[_]={value:S.toJSONString(),type:"string",description:""};i[_].value=n.enhanceVariant(i[_].value);p.push(_)}var U=v(p);var B=v(c);var H=v(f);var J=v(h);n.updateRangeValue(i);i["_relevantODataFilters"]={value:U};i["_relevantODataParameters"]={value:B};i["_mandatoryODataParameters"]={value:H};i["_mandatoryODataFilters"]={value:J};return a};var v=function(e){return e&&e.filter(function(a,t){return e.indexOf(a)===t})};var m=function(e,a){var t=e.filter(function(e){return f(e)})||[];if(a&&a.length>0){e.forEach(function(e){var n="P_"+e.name;if(a.includes(n)){t.push(e)}})}return t};var f=function(e){return e["sap:filterable"]?e["sap:filterable"]!=="false":true};var g=function(e,a){if(a&&a.length){var t=a.filter(function(a){return a.name===e.name});return t&&t[0]}};var d=function(e){var a=[];if(e&&e.extensions){a=e.extensions;for(var t=0;t<a.length;t++){if(a[t].name==="parameter"&&a[t].value==="mandatory"){return e.name}else if(a[t].name==="required-in-filter"&&a[t].value==="true"){return e.name}}}};var y=function(e,a){var t;if(e&&e[a]){return e[a]}else if(e&&e.extensions){t=e.extensions;for(var n=0;n<t.length;n++){if(t[n].name===a){return t[n].value}}}return undefined};var h=function(e,a){if(e&&a){if(e.indexOf("?")===-1){e+="?"+a}else{e+="&"+a}}return e};var S=function(e,a){var t={};var n=e["component"],r=e["component"].getMetadata().getName();var i=n.getModel().sServiceUrl;var o=i;var s=e["currentControlHandler"];var l="";if(s.getBinding()){l=s.getBinding().getDownloadUrl()}if(r==="sap.suite.ui.generic.template.ListReport.Component"){var u="$top=15";l=h(l,u)}var c="$inlinecount=allpages";l=h(l,c);var p={};p.content={method:"GET",url:l,headers:{Accept:"application/json"}};t["request"]={url:"{{destinations.service}}"+o+"/$batch",method:"POST",headers:{"X-CSRF-Token":"{{csrfTokens.token1}}"},batch:p};return t};var D=function(e,a){var t=e["currentControlHandler"].getToolbar();var n=e["component"].getMetadata().getName(),r=t.getTitleControl()&&t.getTitleControl().getText();if(r&&r.indexOf("(")>-1&&n==="sap.suite.ui.generic.template.ListReport.Component"){var i=r.split("(");r=i[0].trim()}var o="__count";var s={text:"{= ${"+o+"} === '0' ? '' : ${"+o+"} }"};var l={title:r,subTitle:"",actions:{},status:s,data:{path:"/content/d"}};return l};var P=function(e,a,t){var n=E(e,t);var r={data:{path:"/content/d/results"},maxItems:15,row:{columns:n,actions:{}}};return r};var T=function(e,a){var t={},n=e["currentControlHandler"],r=n.getInnerChart(),i=n.getBinding().getMeasureDetails(),o=n.getBinding().getDimensionDetails();t["data"]={path:"/content/d/results"};t["chartType"]=C(r);t["measures"]=x(i);t["dimensions"]=V(o);t["feeds"]=O(t);t["chartProperties"]=b(r);t["actionableArea"]="Chart";t["actions"]={};return t};var b=function(e){var a=e.mProperties.vizProperties;a["categoryAxis"]["title"]["visible"]=true;a["valueAxis"]["title"]["visible"]=true;return a};var O=function(e){var a=[],t=[];for(var n in e["measures"]){a.push(e["measures"][n].name)}for(var n in e["dimensions"]){t.push(e["dimensions"][n].name)}return[{type:"Dimension",uid:e.chartType==="Donut"?"color":"categoryAxis",values:t},{type:"Measure",uid:e.chartType==="Donut"?"size":"valueAxis",values:a}]};var C=function(e){var a;switch(e.getChartType()){case"line":a="Line";break;case"donut":a="Donut";break;case"stacked_column":a="stacked_column";break;default:a="Line";break}return a};var x=function(e){var a=[];for(var t in e){var n=e[t];a.push({name:n.analyticalInfo.name,value:"{"+n.analyticalInfo.measurePropertyName+"}"})}return a};var V=function(e){var a=[];for(var t in e){var n=e[t];a.push({name:n.name,value:"{"+n.analyticalInfo.name+"}"})}return a};i.getCardActions=function(e,a){var t=window.hasher.getHash(),n=t.split("&/")[0];if(n.includes("?")){n=n.split("?")[0].split("-")}else{n=n.split("-")}var r={parameters:{ibnTarget:{semanticObject:n[0],action:n[1]},sensitiveProps:[],ibnParams:{}}};var i=[{type:"Navigation",parameters:"{= extension.formatters.getNavigationContext(${parameters>/headerState/value})}"}];var o=JSON.parse(JSON.stringify(r));var s=[{type:"Navigation",parameters:"{= extension.formatters.getNavigationContext(${parameters>/contentState/value}, ${})}"}];a.configuration.parameters.headerState={value:JSON.stringify(r)};a.configuration.parameters.contentState={value:JSON.stringify(o)};a.header.actions=i;if(a.type==="Analytical"){a.content.actions=s}else{var l=e["component"].getModel("_templPriv");if(!l.getProperty("/listReport/bSupressCardRowNavigation")){a.content.row.actions=s}}};var E=function(e,a){var t=e["entityType"];var n=e["currentControlHandler"].getModel().getMetaModel();var r=[];e["currentControlHandler"].getVisibleProperties().filter(function(e){var i=e.data("p13nData")&&e.data("p13nData").columnKey;var o=e.data("p13nData")&&e.data("p13nData").description||"";var s=n.getODataProperty(t,e.data("p13nData").leadingProperty);if(s&&a.indexOf(s.name)>-1){if(e.getVisible()&&(i.indexOf("DataFieldForAnnotation")<0&&!e.data("p13nData").actionButton&&!!e.data("p13nData").leadingProperty)){var l={};o="{"+o+"}";var u="{"+s.name+"}";var c="";if(s["Org.OData.Measures.V1.ISOCurrency"]&&s["Org.OData.Measures.V1.ISOCurrency"].Path){u=u.concat(" "+"{"+c+s["Org.OData.Measures.V1.ISOCurrency"].Path+"}")}if(s["Org.OData.Measures.V1.Unit"]&&s["Org.OData.Measures.V1.Unit"].Path){u=u.concat(" "+"{"+c+s["Org.OData.Measures.V1.Unit"].Path+"}")}if(s["com.sap.vocabularies.Common.v1.Text"]&&s["com.sap.vocabularies.Common.v1.Text"].Path){var p=s["com.sap.vocabularies.Common.v1.Text"]["com.sap.vocabularies.UI.v1.TextArrangement"];var v=p&&p.EnumMember.split("/")[1];if(v==="TextOnly"){u="{= $"+o+" === '' ? '' : $"+o+"}"}else if(v==="TextLast"){u="{= $"+u+" === '' ? '' : $"+u+"}"+"{= $"+o+" === '' ? '' : ' (' + ($"+o+") + ')'}"}else if(v==="TextSeparate"){u="{= $"+u+" === '' ? '' : $"+u+"}"}else{u="{= $"+o+" === '' ? '' : $"+o+"}"+"{= $"+u+" === '' ? '' : ' (' + ($"+u+") + ')'}"}}if(s["com.sap.vocabularies.UI.v1.IsImageURL"]&&s["com.sap.vocabularies.UI.v1.IsImageURL"].Bool==="true"){l["title"]=s["com.sap.vocabularies.Common.v1.Label"].String||s["sap:label"];l["icon"]={src:"{"+s.name+"}"}}else{l["title"]=s["com.sap.vocabularies.Common.v1.Label"].String||s["sap:label"];l["value"]=u}r[a.indexOf(s.name)]=l}}});return r};function R(t,n,r,i){var s=r["component"].getModel("i18n").getResourceBundle();var l=new a({title:s.getText("ST_CARDS_SELECTIONPANEL_TITLE"),showHeader:true,messageStrip:new sap.m.MessageStrip({text:s.getText("ST_CARDS_SELECTIONPANEL_MESSAGESTRIP")}),change:function(e){var a=l.getP13nData();var t=l.getP13nData(true).length;if(t>3){var n=a.find(function(a){return a.name===e.getParameter("item").name});n.visible=false}l.setP13nData(a)}});l.setP13nData(t);var u=new e({title:s.getText("ST_CARDS_SELECTIONPOPUP_TITLE"),panels:[l],close:function(e){if(e.getParameter("reason")==="Ok"){var a=e.getSource().getPanels()[0].getSelectedFields();i(o(r,a))}}});u.open(n)}return i});
//# sourceMappingURL=AddCardsHelper.js.map