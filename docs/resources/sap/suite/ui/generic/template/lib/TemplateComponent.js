sap.ui.define(["sap/ui/core/library","sap/ui/core/Component","sap/ui/core/UIComponent","sap/ui/model/json/JSONModel","sap/ui/model/resource/ResourceModel","sap/ui/Device","sap/suite/ui/generic/template/lib/reuseComponentHelper","sap/ui/core/CustomData","sap/suite/ui/generic/template/lib/StableIdDefinition","sap/suite/ui/generic/template/js/StableIdHelper","sap/suite/ui/generic/template/genericUtilities/FeLogger","sap/suite/ui/generic/template/js/AnnotationHelper","sap/base/util/extend","sap/base/util/deepExtend","sap/suite/ui/generic/template/genericUtilities/CacheHelper","sap/suite/ui/generic/template/genericUtilities/FeError","sap/ui/core/mvc/XMLView"],function(e,t,n,o,a,r,i,s,p,l,u,m,d,g,c,v,f){"use strict";var C="lib.TemplateComponent";var y=new u(C).getLogger();var b=e.mvc.ViewType;function h(e){var t=new a({bundleName:"sap/suite/ui/generic/template/lib/i18n/i18n"});var n=[];var o=e.getAppComponent().getModel("i18n|"+e.getMetadata().getComponentName()+"|"+e.getEntitySet());if(o){n.push(o)}var r=e.getModel("i18n");if(r){n.push(r)}var i=e.getModel("@i18n");if(i){n.push(i)}var s=true;for(var p="i18n";s;){p=p+"||Parent";s=e.getModel(p);if(s){n.push(s)}}for(var l=n.length-1;l>=0;l--){t.enhance(n[l].getResourceBundle())}e.setModel(t,"i18n")}function S(e,t){var n=e.oComponent.getAppComponent().getManifestEntry("sap.ui5");var o=n.extends&&n.extends.extensions&&n.extends.extensions["sap.ui.controllerExtensions"];var a=e.methods.oComponentData.templateName+"#"+e.oComponent.getAppComponent().getMetadata().getComponentName()+"::"+e.methods.oComponentData.templateName+"::"+e.oComponent.getEntitySet();o=o&&(o[a]||o[e.methods.oComponentData.templateName]);var r=o&&o["sap.ui.generic.app"];var i=e.oComponent.getEntitySet();var s=r&&r[i]&&r[i].Actions;var p={};var l=D(e.oComponent);if(s){if(l){w(p,s,l)}else{M(p,s)}}else{var u=r&&r[i]&&r[i]["Sections"];for(var m in u){s=u[m]["Actions"];if(s){M(p,s)}}}e.oComponent.getModel("_templPriv").setProperty("/generic/listCommons/breakoutActionsEnabled",p)}function D(e){var t;var n=e.getAppComponent().getConfig();var o=n&&n.pages[0]&&n.pages[0].component&&n.pages[0].component.settings;if(o&&o.quickVariantSelectionX){t=o.quickVariantSelectionX.variants}return t}function w(e,t,n){var o;for(var a in t){o=true;if(t[a].requiresSelection){o=false}for(var r in n){var i=t[a].id;var s=n[r];var p=m.getSuffixFromIconTabFilterKey(s);if(p){i=i.concat(p)}e[i]={enabled:o}}}}function M(e,t){var n;for(var o in t){n=true;if(t[o].requiresSelection){n=false}e[t[o].id]={enabled:n}}}function A(e){if(e.oComponent.getAppComponent().getMetadata().getComponentName()===""||e.methods.oComponentData.templateName===""||e.oComponent.getEntitySet()===""){}return e.oComponent.getAppComponent().getMetadata().getComponentName()+"::"+e.methods.oComponentData.templateName+"::"+e.oComponent.getEntitySet()}function E(e,t){if(e.level===0){return[]}var n=t[e.parentRoute];var o=E(n,t);o.push(n);return o}function T(e,t,n,a){var i=t.oComponent;var s=t.oAppComponent;var u=t.oTemplateContract.mRoutingTree[t.route];var m=i.getEntitySet();var g=t.utils.isDraftEnabled();var c=s.getTransactionController().getDraftController();var v=c.getDraftContext();var f=s.getModel();var C=function(e){return v.isDraftEnabled(e)};var y=d({},u.page.component.settings);delete y.appComponent;delete y.entitySet;delete y.navigationProperty;y.subPages=u.page.pages;y.routeConfig=t.routeConfig;var b=s.getInternalManifest();return new o({entitySet:m,entityType:e,treeNode:u,treeNodeAncestors:E(u,t.oTemplateContract.mRoutingTree),routingSpec:t.routingSpec,"sap-ui-debug":window["sap-ui-debug"],isDraftEnabled:g,checkIsDraftEnabled:C,settings:y,manifest:b,metaModel:n,templateSpecific:a&&a(n,y,r,m,b,f,v),appComponentName:s.getMetadata().getComponentName(),stableId:{definition:p,aParameter:[],getStableId:l.getStableId},variables:[]})}function R(e,t){var n=e.oComponent,a=e.createViewController,i=e.methods&&e.methods.getTemplateSpecificParameters,p=e.oAppComponent.getModel(),l,u,m,d,g,c=e.routingSpec&&e.routingSpec.noOData;if(c){l=new o({entitySet:{},entityType:{}});d=l.createBindingContext("/entitySet");g=l.createBindingContext("/entityType")}else{l=p&&p.getMetaModel();u=p&&n.getEntitySet();var D=u&&l.getODataEntitySet(u);m=D&&D.entityType;if(!m){return Promise.reject(new v(C,"Unknown entityset "+u))}d=l.createBindingContext(l.getODataEntitySet(u,true));g=l.createBindingContext(l.getODataEntityType(m,true))}h(n);S(e,p);var w=A(e);var M=sap.ui.getCore().byId(w);if(M){y.warning("View with ID: "+w+" already exists - old view is getting destroyed now!");try{M.destroy()}catch(e){y.warning("Error destroying view: "+e)}M=null}var E=new o(r);E.setDefaultBindingMode("OneWay");e.oParameterModel=T(m,e,l,i);return n.runAsOwner(function(){var n={setAdditionalCacheData:function(t){e.preprocessorsData=t},getAdditionalCacheData:function(){return e.preprocessorsData}};var o={preprocessors:{xml:{bindingContexts:{entitySet:d,entityType:g},models:{device:E,appSettings:e.oTemplateContract.appSettings,entitySet:l,entityType:l,parameter:e.oParameterModel},preprocessorsData:e.preprocessorsData}},id:w,type:b.XML,viewName:e.methods.oComponentData.templateName,height:"100%",cache:{keys:t,additionalData:n}};var r={key:"sap-ui-custom-settings",value:{"sap.ui.dt":{designtime:e.methods.oComponentData.designtimePath}}};o.customData=[new s(r)];o.controller=a();return f.create(o)})}function I(e,t,n){var o=e.oController.extensionAPI;var a=d({},o);if(o.getNavigationController){var r=d({},o.getNavigationController());var i=r.navigateInternal;r.navigateInternal=function(n,o){var a=o&&!o.isAbsolute&&o.routeName;if(a){e.utils.navigateRoute(a,n,t,o&&o.replaceInHistory)}else{i(n,o)}};a.getNavigationController=function(){return r}}a.getCommunicationObject=function(t){return t===1?n.communicationObject:e.utils.getCommunicationObject(t)};(e.methods.enhanceExtensionAPI4Reuse||Function.prototype)(a,n);return a}function x(e,t,n,o,a){o.extensionAPI=I(e,n,o);i.transferEmbeddedComponentProxy(e,t,n,o,a);var r=e.oController.byId(o.containerId);var s=r&&r.getSettings();var p=a.getMetadata().getAllProperties();for(var l in s){if((l==="uiMode"||l==="semanticObject"||l.startsWith("st"))&&!p[l]){delete s[l]}}a.applySettings(s);r.setComponent(a)}function P(e,n,o){return o.componentUsage?e.createComponent({usage:o.componentUsage,id:n}):e.runAsOwner(function(){return t.create({name:o.componentName,id:n})})}function N(e){var t=e.oTemplateContract.mRoutingTree[e.route];e.reuseComponentsReady=new Promise(function(n,o){var a=Object.create(null);var r=n.bind(null,a);var i=function(e,t){y.error("Failed to load reuse component for key "+e,t instanceof Error?t.message:"","sap.suite.ui.generic.template.lib.TemplateComponent")};e.viewRegistered.then(function(){var n=[];for(var s in t.embeddedComponents){var p=t.embeddedComponents[s];var l=p.sectionId&&e.oController.byId(p.sectionId);if(l&&l.isStashed()){delete t.embeddedComponents[s]}else{var u=e.oController.createId(p.componentId);var m=P(e.oAppComponent,u,p);e.oComponent.registerForDestroy(m);n.push(m);m.catch(i.bind(null,s));m.then(x.bind(null,e,a,s,p))}}Promise.all(n).then(r,function(t){var n=e.oAppComponent.getNavigationController();n.navigateToMessagePage({text:e.oTemplateContract.getText("ST_ERROR"),description:t instanceof Error?t.message:""});o()})},o)});t.willBeDisplayed.then(e.oTemplateContract.oBusyHelper.setBusy.bind(null,e.reuseComponentsReady,undefined,undefined,true));e.reuseComponentsReady.then(function(t){e.reuseComponentsReady={then:function(e){return Promise.resolve(e(t))}}})}var O=n.extend("sap.suite.ui.generic.template.lib.TemplateComponent",{metadata:{properties:{entitySet:{type:"string",defaultValue:null},navigationProperty:{type:"string",defaultValue:null},appComponent:{type:"object",defaultValue:null},isRefreshRequired:{type:"boolean",defaultValue:false},isLeaf:{type:"boolean"}},library:"sap.suite.ui.generic.template"},init:function(){(n.prototype.init||Function.prototype).apply(this);var e=new o({editable:false,enabled:false});this.setModel(e,"ui");var t=this.getComponentData();var a=t.registryEntry;var r=a.oTemplateContract.mRoutingTree[a.route];var i=Object.create(null);for(var s in r.embeddedComponents){i[s]={hidden:!!r.embeddedComponents[s].definition.hiddenByDefault}}var p=new o({generic:{isActive:false,listCommons:{},viewLevel:a.viewLevel,controlProperties:{},supportedIntents:{},embeddedComponents:i}});p.setDefaultBindingMode("TwoWay");this.setModel(p,"_templPriv");N(a)},getExtensionComponent:function(){return this.getAppComponent()},getManifestEntry:function(e){var t=n.prototype.getManifestEntry.apply(this,arguments);if(/^\/sap\.ui5\/componentUsages(\/.+)?$/.test(e)){t=g({},t,n.prototype.getManifestEntry.apply(this.getAppComponent(),arguments))}return t},getComponentContainer:function(){return this.oContainer},onBeforeRendering:function(e){if(e){var t=e.oComponent.getComponentContainer();var n=e.oAppComponent;var o=!e.createViewStarted&&t&&t.getModel();if(o&&!e.oComponent.isDestroyed()){var a=c.getCacheKeyPartsAsyc(o);e.createViewStarted=true;var r=R(e,a);var i=r.then(function(o){y.debug("Creation of view "+o.getId()+" finished");if(e.utils.isDraftEnabled()){var r=e.utils.getRootExpand();if(r){var i=e.oComponent.getEntitySet();c.writeToLocalStorageAsync(n.getId(),i,a,r)}}if(!e.oComponent.isDestroyed()){e.oComponent.setAggregation("rootControl",o);e.fnViewRegisteredResolve();t.invalidate()}return o});r.catch(function(t){if(!e.oComponent.isDestroyed()){e.fnViewRegisteredResolve(t||{})}});e.oComponent.registerForDestroy(i)}}},getRouter:function(){if(this.getAppComponent()){return this.getAppComponent().getRouter()}return n.prototype.getRouter.apply(this,arguments)}});return O});
//# sourceMappingURL=TemplateComponent.js.map