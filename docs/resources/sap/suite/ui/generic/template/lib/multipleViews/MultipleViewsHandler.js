sap.ui.define(["sap/ui/base/Object","sap/ui/model/Filter","sap/suite/ui/generic/template/lib/multipleViews/MultipleTablesModeHelper","sap/suite/ui/generic/template/lib/multipleViews/SingleTableModeHelper","sap/ui/generic/app/navigation/service/SelectionVariant","sap/suite/ui/generic/template/genericUtilities/metadataAnalyser","sap/suite/ui/generic/template/genericUtilities/FeLogger","sap/suite/ui/generic/template/genericUtilities/testableHelper","sap/base/util/extend","sap/base/security/encodeURL","sap/ui/comp/util/DateTimeUtil","sap/base/util/isEmptyObject"],function(e,t,r,n,a,i,o,s,l,u,p,c){"use strict";var f=new o("lib.multipleViews.MultipleViewsHandler").getLogger();function g(e,o,g){var m=Object.create(null);var d=o.oComponentUtils.getTemplatePrivateModel();var v=g.pathInTemplatePrivateModel+"/items";var S=g.pathInTemplatePrivateModel+"/selectedKey";d.setProperty(g.pathInTemplatePrivateModel,Object.create(null));d.setProperty(v,Object.create(null));var y=new(g.mode==="single"?n:r)(e,o,g);d.setProperty(g.pathInTemplatePrivateModel+"/mode",y.getMode());var h;var C=new Promise(function(e){h=e});var b=o.oServices.oApplication.getBusyHelper().getBusyDelay();var P=e.getOwnerComponent().getModel();var O;var T;var E=[];var F;function M(){if(T){var e=g.getSearchValue&&g.getSearchValue();var t=e?{search:e}:{};for(var r in m){var n=m[r];var a=n.getPath();n.numberOfUpdates++;n.updateStartFunction(n.numberOfUpdates);P.read(a+"/$count",{urlParameters:t,filters:n.getFiltersForCount&&n.getFiltersForCount(),groupId:"updateMultipleViewsItemsCounts",success:n.updateSuccessFunction.bind(null,n.numberOfUpdates),error:n.errorFunction.bind(null,n.numberOfUpdates)})}}}function w(e,t){var r="";var n=t["parameters"];if(!t||!t.entitySetName||!t.navPropertyName||n.length<1){r="/"+e.name;return r}var i=g.smartFilterBar&&g.smartFilterBar.getAnalyticalParameters();if(i&&i.length>0){var o=g.smartFilterBar&&g.smartFilterBar.getUiState({allFilters:false});var s=o?JSON.stringify(o.getSelectionVariant()):"{}";var l=new a(s);var c=[];n.forEach(function(e){i.forEach(function(t){if(t&&t.name===e){var r=t.name;var n=l.getParameter(r);if(t.type==="Edm.DateTime"||t.type==="Edm.DateTimeOffset"){n=new Date(n);n=p.localToUtc(n)}else if(t.type==="Edm.String"&&t["sap:parameter"]==="optional"){if(n===undefined){n=""}}n=u(t.control.getModel().formatValue(n,t.type));c.push(r+"="+n)}})});r="/"+t.entitySetName+"("+c.join(",")+")/"+t.navPropertyName}else{r="/"+e.name;f.error("SelectionParameters","There are no parameters to resolve");return r}return r}function I(t){var r;var n=t.getEntitySet();var a=e.getOwnerComponent();if(g.smartFilterBar&&g.smartFilterBar.getConsiderAnalyticalParameters&&g.smartFilterBar.getConsiderAnalyticalParameters()){var o=P.getMetaModel();var s=o.getODataEntitySet(n);var l=a.getAppComponent();var u=i.getParametersByEntitySet(l.getModel(),n);r=g.resolveParameterizedEntitySet?g.resolveParameterizedEntitySet(s,u):w(s,u);return r}var p=t.getBindingPath();r=p?p:"/"+n;var c=a.getComponentContainer();var f=c.getElementBinding();return f?f.getPath()+"/"+r:r}function U(e,r){var n=P.getMetaModel();var a=n.getODataEntityType(n.getODataEntitySet(e.getEntitySet()).entityType);var i=[],o;var s=r.variantAnnotationPath;if(s){var l=a[s];if(!l){return[]}if(!l.SelectOptions&&l.SelectionVariant){l=l.SelectionVariant;if(l.Path){s=l.Path.split("@")[1];l=s&&a[s]}}if(l.AnnotationPath){o=l.AnnotationPath.split("@")[1];l=a[o]}for(var u in l.SelectOptions){if(l.SelectOptions[u].PropertyName){var p=l.SelectOptions[u].PropertyName.PropertyPath;for(var c in l.SelectOptions[u].Ranges){var f=l.SelectOptions[u].Ranges[c].Sign&&l.SelectOptions[u].Ranges[c].Sign.EnumMember;var g=l.SelectOptions[u].Ranges[c].Option&&l.SelectOptions[u].Ranges[c].Option.EnumMember;g=f?V(f.replace("com.sap.vocabularies.UI.v1.SelectionRangeSignType/",""),g.replace("com.sap.vocabularies.UI.v1.SelectionRangeOptionType/","")):g.replace("com.sap.vocabularies.UI.v1.SelectionRangeOptionType/","");var m=l.SelectOptions[u].Ranges[c].Low;var d=l.SelectOptions[u].Ranges[c].High;var v=Object.keys(m)[0];if(d){var S=Object.keys(d)[0];i.push(new t(p,g,m[v],d[S]))}else{i.push(new t(p,g,m[v]))}}}}}return i}function V(e,t){var r;var n=new Map([["EQ","NE"],["BT","NB"],["CP","NP"],["LE","GT"],["GE","LT"],["NE","EQ"],["NB","BT"],["NP","CP"],["GT","LE"],["LT","GE"]]);if(e==="I"){r=t}else if(e==="E"){if(n.has(t)){r=n.get(t)}else{r=t}}return r}function B(e){for(var t in m){var r=m[t];if(r.presentationControlHandler.getEntitySet()===e){return t}}return""}function R(e){return!!B(e)}function H(e){return e&&x().presentationControlHandler.getEntitySet()!==e&&B(e)||F}function A(e,t){var r=e.filters.slice(0);var n=x();e.filters=K(e.filters,n,t,false);if(T){for(var a in m){var i=m[a];N(r,i,t)}}}function N(e,t,r){t.getFiltersForCount=function(){return K(e,t,r,true)}}function K(e,t,r,n){if(y.getFiltersAdaptedFromItem){e=y.getFiltersAdaptedFromItem(e,t,r,n)}return e.concat(t.selectionVariantFilters)}function x(){return m[F]}function D(e,t){return y.formatMessageStrip(e,t)}function j(){return F}function L(){return y.getMode()}function G(e){if(!e){e=O}F=e;d.setProperty(S,F)}function z(){return y.getContentForIappState(F)}function W(e){var t;if(!e){return""}if(e.state==="error"){return o.oCommonUtils.getText("SEG_BUTTON_ERROR",e.text)}if(e.state===""||e.state==="busy"){var r=sap.ui.core.format.NumberFormat.getIntegerInstance({groupingEnabled:true});t=r.format(e.count)}return o.oCommonUtils.getText("SEG_BUTTON_TEXT",[e.text,e.state==="busyLong"?"...":t])}function _(e){F=y.getSelectedKeyAndRestoreFromIappState(e);if(m[F]){d.setProperty(S,F)}}var k={getState:j,setState:G,attachStateChanged:re};function q(){return y.getSFBVariantContentStateWrapper(k)}function Q(){return y.getGeneralContentStateWrapper(k)}function J(){return m[F].templateSortOrder}function X(e){var t=x();if(e!==2){t.presentationControlHandler.rebind()}if(e>1){if(g.refreshModelOnTableRefresh){var r=o.oCommonUtils.refreshModel(t.presentationControlHandler.getEntitySet());if(r){te(t.presentationControlHandler)}}t.presentationControlHandler.refresh()}}function $(e,t,r){var n=Array.isArray(t);var a=o.oComponentUtils.isComponentActive();if(n&&t.length===0||r&&c(r)){return}y.refreshOperation(e,t,r,F,n,a,X)}function Y(e,t){if(y.setControlVariant){y.setControlVariant(e,t)}}function Z(e,t,r,n){return o.oCommonUtils.getCustomDataText(e).then(function(e){r.text=e;n.text=e;return{modelEntry:r,pathToTheItem:t}})}function ee(e){d.setProperty(e.pathToTheItem,e.modelEntry)}function te(e){if(y.refreshSiblingControls){y.refreshSiblingControls(e)}}function re(e){E.push(e)}function ne(){return Object.keys(m)}(function(){s.testable(function(){return y},"getImplementingHelper");s.testable(function(){return T},"getShowCounts");s.testable(function(){return m[F]},"getCurrentViewMeta");var e=function(e,t,r,n){if(e.numberOfUpdates!==r){return}var a=v+"/"+e.switchingKey;var i=l({},d.getProperty(a));if(!i.state&&t=="busy"){setTimeout(function(){if(d.getProperty(a).state==="busy"){i=l({},d.getProperty(a));i.state="busyLong";d.setProperty(a,i)}},b)}i.state=t;if(!t){i.count=n}d.setProperty(a,i)};g.getSwitchingControlAsync().then(function(t){var r=t?t.getItems():[];for(var n=0;n<r.length;n++){var a=r[n];var i=a.getKey();if(n===0){O=i}var s={presentationControlHandler:g.presentationControlHandler||g.getPresentationControlHandler(i),switchingKey:i};var l=o.oCommonUtils.getElementCustomData(a);var u=v+"/"+s.switchingKey;var p=Object.create(null);p.text=l.text;p.count=0;p.state="";p.facetId=g.sectionKey;Z(a,u,p,s).then(ee);s.templateSortOrder=l.TemplateSortOrder;s.getPath=I.bind(null,s.presentationControlHandler);s.selectionVariantFilters=U(s.presentationControlHandler,l);s.numberOfUpdates=0;s.updateStartFunction=e.bind(null,s,"busy");s.updateSuccessFunction=e.bind(null,s,"");s.errorFunction=e.bind(null,s,"error");m[i]=s}if(y.init){y.init(m,$,x)}if(g.manifestSettings.showCounts===undefined){T=y.getDefaultShowCounts()}else{T=g.manifestSettings.showCounts}G(F);var c=d.bindProperty(S);c.attachChange(function(e){var t=e.getSource().getValue();E.forEach(function(e){e(t,F)});F=t;if(y.onSelectedKeyChanged){y.onSelectedKeyChanged(t)}var r=g.isDataToBeShown();var n=y.getRefreshMode(F);if(g.adaptRefreshRequestMode){n=g.adaptRefreshRequestMode(n);if(r&&n>0){X(n)}else{x().presentationControlHandler.setEnabledToolbarButtons()}}g.appStateChange()});h()})})();return{updateCounts:M,refreshOperation:$,onRebindContentControl:A,formatMessageStrip:D,getSelectedKey:j,setSelectedKey:G,getContentForIappState:z,restoreFromIappState:_,getSFBVariantContentStateWrapper:q,getGeneralContentStateWrapper:Q,formatItemTextForMultipleView:W,determineSortOrder:J,setControlVariant:Y,hasEntitySet:R,getPreferredKey:H,refreshSiblingControls:te,resolveParameterizedEntitySet:w,getMode:L,registerKeyChange:re,getKeys:ne,getInitializationPromise:function(){return C}}}return e.extend("sap.suite.ui.generic.template.lib.multipleViews.MultipleViewsHandler",{constructor:function(e,t,r){l(this,g(e,t,r))}})});
//# sourceMappingURL=MultipleViewsHandler.js.map