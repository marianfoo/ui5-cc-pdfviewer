sap.ui.define(["sap/ui/base/Object","sap/suite/ui/generic/template/lib/navigation/routingHelper","sap/suite/ui/generic/template/genericUtilities/testableHelper","sap/suite/ui/generic/template/genericUtilities/FeLogger","sap/base/util/extend","sap/base/util/deepExtend","sap/base/util/isEmptyObject"],function(e,t,n,r,a,i,l){"use strict";var s=new r("lib.StatePreserver").getLogger();function p(e,n){var r=t.getCrossAppNavService();var a=e.componentRegistry[n.oComponent.getId()];var p="";var o=Promise.resolve();var u=null;var c=Promise.resolve();var f=null;var v=null;var g=null;var y,S;var m=Object.create(null);var x={};var b={};function E(){m.permanentEntries=Object.create(null);m.sessionEntries=Object.create(null);m.pageEntries=Object.create(null);m.allEntries=Object.create(null)}E();function d(e){E();for(var t in e){var n=i({},e[t]);m.allEntries[t]=n;var r=n.lifecycle||Object.create(null);if(r.permanent){m.permanentEntries[t]=n}else if(r.session){m.sessionEntries[t]=n}if(r.page||r.pagination){m.pageEntries[t]=n}}return m}function K(e,t){if(t===e){return}var n=t.next.next;t.next.next=e.next;e.next=t.next;t.next=n}function A(e,t,a){if(l(t)){return{appStateKey:""}}var i=JSON.stringify(t);var s=0;var p;for(p=e;p.next&&s<10;s++){if(p.next.serialize===i){K(e,p);return{appStateKey:e.next.appStateKey}}p=p.next}p.next=null;var o=r.createEmptyAppState(n.oComponent.getAppComponent(),!a);var u={next:e.next,serialize:i,appStateKey:o.getKey()};o.setData(t);o.save();e.next=u;return{appStateKey:u.appStateKey}}function P(){var t=A(b,m.sessionEntries,false);var r=Object.create(null);if(t.appStateKey){r.sessionAppStateKey=t.appStateKey}if(!l(m.permanentEntries)){r.permanentEntries=m.permanentEntries}v=A(x,r,true);var i=Promise.resolve();if(g===v.appStateKey){v=null}else if(a.utils.isComponentActive()){i=e.oNavigationControllerProxy.navigateByExchangingQueryParam(n.appStateName,v.appStateKey)}else{p=v.appStateKey;v=null}if(f){f(i.then(e.oBusyHelper.getUnbusy));f=null}}function h(){if(!f||p!==g){return}var e=n.getCurrentState()||Object.create(null);d(e);P()}function O(){var t=a.aKeys;var n="";var r=a.route;for(var i=t.length-1;i>0;i--){var l=e.mRoutingTree[r];var s=i===1?l.entitySet:l.navigationProperty;n="/"+s+(t[i]?"("+t[i]+")":"")+n;r=l.parentRoute}return n}function j(e,t){return o.then(function(){var t=Object.create(null);var r=(!e||O()===e)&&y;if(r){t[n.appStateName]=r}return t})}function C(){if(e.bStateHandlingSuspended){return}if(!f){c=new Promise(function(e){f=e;setTimeout(h,0)})}return c}function N(){p=g;v=null;y=g}function w(e,t,n){if(!t){return}for(var r in t){var a=t[r];if(n||a.lifecycle.page){e[r]=a}}}function H(e,t){d(t);var r=Object.create(null);for(var a in t){r[a]=t[a].data}n.applyState(r,e);if(u){u();u=null}N();P();h()}function F(e,t,n){for(var r=e;r.next;r=r.next){if(r.next.appStateKey===n){K(e,r);return}}var a={next:e.next,serialize:JSON.stringify(t),appStateKey:n};e.next=a}function I(e,t,n,r,a,i){if(g===null){g=e}else if(e!==g){return}if(i){F(b,i,a);w(n,i,true)}w(n,r,true);H(t,n)}function R(t,n,r,a){var i=a||Object.create(null);F(x,i,t);if(!i.permanentEntries){i={permanentEntries:{permanentState:{data:i,lifecycle:{permanent:true}}}}}var l=e.oNavigationControllerProxy.getAppStateFromShell(i.sessionAppStateKey).catch(Function.prototype);l.then(I.bind(null,t,n,r,i.permanentEntries,i.sessionAppStateKey))}function U(t){var r=e.componentRegistry[n.oComponent.getId()];var a=r.utils.getHeaderDataAvailablePromise()||Promise.resolve();return a.then(function(){return e.oApplicationProxy.areTwoKnownPathesIdentical(S,t,r.viewLevel===1)})}function z(e,t){if(e===S){t(true);return}if(!e||!S){t(false);return}U(e).then(t)}function L(t,r){z(t,function(a){if(!n.callAlways&&a){if(g===p){return}if(!g){P();return}}S=t;var i=Object.create(null);w(i,m[a?"allEntries":"pageEntries"],a||r);if(!g){if(a){w(i,m.sessionEntries,true);w(i,m.permanentEntries,true)}H(a,i);return}if(!u){o=new Promise(function(e){u=e})}if(e.bStateHandlingSuspended){g=""}var l=e.oNavigationControllerProxy.getAppStateFromShell(g).catch(Function.prototype);l.then(R.bind(null,g,a,i))})}function T(){for(var e in m.pageEntries){var t=m.pageEntries[e].lifecycle;if(!t.permanent&&!t.session){delete m.allEntries[e];delete m.pageEntries[e]}}}function B(e){g=e[n.appStateName]||"";if(Array.isArray(g)){g=g.sort()[0]||""}if(v){if(v.appStateKey!==g){s.error("StatePreserver: Got AppstateKey "+g+" expected "+v.appStateKey);return false}N();return true}return false}function D(){return{isStateChange:B,leaveApp:T}}return{getUrlParameterInfo:j,stateChanged:C,applyAppState:L,getAsStateChanger:D}}return e.extend("sap.suite.ui.generic.template.lib.StatePreserver",{constructor:function(e,t){a(this,p(e,t))}})});
//# sourceMappingURL=StatePreserver.js.map