sap.ui.define(["sap/ui/base/Object","sap/ui/model/base/ManagedObjectModel","sap/suite/ui/generic/template/genericUtilities/controlHelper","sap/suite/ui/generic/template/genericUtilities/FeLogger","sap/suite/ui/generic/template/genericUtilities/oDataModelHelper","sap/suite/ui/generic/template/lib/CRUDActionHandler","sap/suite/ui/generic/template/lib/StatePreserver","sap/base/util/extend","sap/base/util/isEmptyObject","sap/suite/ui/generic/template/genericUtilities/FeError","sap/base/util/UriParameters","sap/suite/ui/generic/template/lib/CommandComponentUtils"],function(e,t,n,o,r,a,i,s,l,u,c,p){"use strict";var d="lib.ComponentUtils";var f=new o(d).getLogger();var g={isPreliminary:function(){return false}};function m(e,t,n){var o;for(o=n;o.level>t.level;o=e[o.parentRoute]){f.info("Checked test node with route "+o.sRouteName)}return o===t}function v(e,o){var v=o.oTemplateContract.mRoutingTree[o.route];var C;var h;var b;var P;var x=false;var y;var T=false;var A;var R=[];var S=[];var D=new p(o);function F(){return e.getModel("_templPriv")}function I(e){o.oTemplateContract.oNavigationControllerProxy.preloadComponent(e)}function E(){var t=e.getAppComponent();return t.getModel("_templPrivGlobal")}function N(){return v.level}function B(){var t=o.oTemplateContract.oApplicationProxy.getAncestralNode(v,1);if(t){var n={};var r=t.getPath(2,Te());n.bindingContext=e.getModel().createBindingContext(r)||e.getModel().getContext(r);n.entitySet=t.entitySet;n.view=t.componentId&&o.oTemplateContract.componentRegistry[t.componentId].oController.getView();n.componentId=t.componentId;return n}return null}function O(){var e=o.oTemplateContract.oApplicationProxy.getAncestralNode(v,1);if(!e.componentId){I(e.sRouteName)}return e.componentCreated.then(function(e){var t=o.oTemplateContract.componentRegistry[e.getId()];return t.viewRegistered.then(function(){return{getText:t.oControllerUtils.oCommonUtils.getText,getRootExpand:t.oControllerUtils.oComponentUtils.getRootExpand}})})}function M(){return o.preprocessorsData}function U(e){var t=o.oTemplateContract.oNavigationControllerProxy.getCurrentIdentity();var n=t.keys;var r=[];for(var a=0;a<e;a++){r[a]=""}var i=o.oTemplateContract.oApplicationProxy.fillSiblingKeyPromise(t.treeNode,n,r,"Changes");return i.then(function(e){return{keys:r,treeNode:e}})}function w(){var e=M();var t=j().getObject("/templateSpecific/streamEnabledAssociatedEntites");var n=[];if(e&&e.rootContextExpand){n=e.rootContextExpand}n=t&&t.length>0?n.concat(t):n;if(n){var o=n.filter(function(e,t){return n.indexOf(e)===t});return o.join(",")}}function j(){return o.oParameterModel}function H(e,t,n){if(typeof n!=="function"){throw new u(d,"Event handler must be a function")}S.push({template:e,event:t,handler:n})}function V(e,t,n){for(var o=S.length;o--;){if(S[o].handler===n&&S[o].event===t&&S[o].template===e){S.splice(o,1)}}}function L(e,t,n){for(var o=0;o<S.length;o++){if(S[o].event===t&&S[o].template===e){S[o].handler(n)}}}function k(e){return e.getMetadata().getName()}function q(){return o.oApplication.isComponentActive(e)}function $(e){var t=o.oTemplateContract.componentRegistry[e];var n=o.oTemplateContract.mRoutingTree[t.route];var r=n.level<v.level;var a=r?m(o.oTemplateContract.mRoutingTree,n,v):m(o.oTemplateContract.mRoutingTree,v,n);return(n.level-v.level)*a}function G(){return o.oNavigationObserver.getProcessFinished(true)}function K(e,t){var n=G();n.then(function(){if(q()){if(t){ie(true,false)}L(k(o.oController),"PageDataLoaded",{context:e});if(e&&Ie()){var n=e.getObject();if(!n.IsActiveEntity){o.oApplication.getDraftSiblingPromise(e)}}}})}function W(){C.then(function(e){if(e){K(e)}})}function z(){o.oHeaderLoadingObserver.startProcess();if(!y){var e=new Promise(function(e){y=e});o.oApplication.getBusyHelper().setBusy(e,undefined,undefined,true)}}function _(){if(!h){C=new Promise(function(e){h=e})}}if(v.getPath(3)){_()}else{C=Promise.resolve()}function Q(t){f.info("Request header data",t.getSource().getPath(),"Class sap.suite.ui.generic.template.lib.ComponentUtils");T=true;_();if(!e.getComponentContainer().getElementBinding().isSuspended()){z()}}function J(){if(y){y();y=null}o.oHeaderLoadingObserver.stopProcess()}function X(t){var n=t.getSource().getBoundContext();if(n){return n}if(e.getComponentContainer().getElementBinding().isSuspended()){n=null}else{n=g}re();return n}function Y(){x=true;var e=o.oTemplateContract.oNavigationControllerProxy.getActiveComponents();var t=e.find(function(e){return o.oTemplateContract.componentRegistry[e].utils.getDataNotExisting()});var n=o.oTemplateContract.componentRegistry[t];var r=o.oTemplateContract.mRoutingTree[n.route];o.oTemplateContract.oNavigationControllerProxy.navigationContextNotFound(r)}function Z(){return x}function ee(){T=false;if(!P){return}if(P===g){Y();re()}else if(!e.getComponentContainer().getElementBinding().isSuspended()){var t=e.getBindingContext();var n=be(t);var r=n.bIsDraft||o.oApplication.getObjectInEditMode();var a;if(r){o.oApplication.setObjectInEditMode(false);a=n.bIsCreate?4:2}else{a=1}var i=F();var s=e.getModel("ui");i.setProperty("/objectPage/displayMode",a);s.setProperty("/editable",r);s.setProperty("/enabled",true);s.setProperty("/createMode",n.bIsCreate);(o.methods.updateBindingContext||Function.prototype)(t);if(h){h(P)}}else{return}h=null;P=null}function te(e){f.info("Received header data",e.getSource().getPath(),"Class sap.suite.ui.generic.template.lib.ComponentUtils");b();J();if(T){P=X(e)}ee()}function ne(e){b();var t=X(e);if(t&&t.isPreliminary()){return}P=t;ee();o.oHeaderLoadingObserver.stopProcess()}function oe(t){x=false;o.oHeaderLoadingObserver.startProcess();var n=new Promise(function(e){b=e});_();if(o.methods.beforeRebind){o.methods.beforeRebind(n)}P=null;v.bindElement(e.getComponentContainer(),t,false,{dataRequested:Q,dataReceived:te,change:ne});A=t;if(o.methods.afterRebind){o.methods.afterRebind()}}function re(){_();var t=e.getComponentContainer();t.setBindingContext();v.unbindElement(t);A=null;P=null;T=false;J()}function ae(){var e=Te();var t=e.length===R.length;for(var n=0;n<e.length&&t;n++){t=e[n]===R[n]}R=e;return!t}function ie(e,t){o.reuseComponentsReady.then(function(n){for(var o in n){var r=n[o];if(!t||r.isStarted()){r.pathUnchangedCallBack(e)}}})}function se(e,t){var n=Object.create(null);for(var o in e){var r=e[o];n[o]=t(r,o)}return n}function le(){var e=F();for(var t in v.embeddedComponents){var n=!!v.embeddedComponents[t].definition.hiddenByDefault;e.setProperty("/generic/embeddedComponents/"+t+"/hidden",n)}}function ue(t,n){var r=ae();if(r&&!n){le()}if(!t){if(o.routingSpec&&o.routingSpec.noOData){K(null,r)}return}var a=e.getComponentContainer();if(!a){return}var i=e.getModel("ui");var s=!!o.nonDraftCreateContext;if(s){var l=a.getBindingContext();if(l===o.nonDraftCreateContext){return}i.setProperty("/enabled",true);i.setProperty("/editable",true);i.setProperty("/createMode",true);re();if(h){h(o.nonDraftCreateContext);h=null}else{C=Promise.resolve(o.nonDraftCreateContext)}W();if(o.methods.beforeRebind){o.methods.beforeRebind(C)}a.setBindingContext(o.nonDraftCreateContext);Promise.all([o.oViewRenderedPromise,o.viewRegistered]).then(ie.bind(null,true,false));if(o.methods.afterRebind){o.methods.afterRebind()}}else{var u=a.getElementBinding();if(u){if(A===t){if(u.isSuspended()){u.resume();ee()}if(T){z()}o.oApplication.getBusyHelper().getUnbusy().then(ie.bind(null,r,false));if(!n){W()}if(!n&&!Ie()){var c=o.oApplication.getEditFlowOfRoot();if(c==="direct"){i.setProperty("/editable",true)}else{i.setProperty("/editable",false)}}i.setProperty("/enabled",true);return}else if(!n){re()}}i.setProperty("/enabled",false);i.setProperty("/editable",false);i.setProperty("/createMode",false);oe(t);W()}}function ce(t,n){var r={};if(t){r.discardPromise=t}var a=e.getModel();if(a.hasPendingChanges()){var i=o.oController.getView();i.setBindingContext(null);a.resetChanges();i.setBindingContext()}var s=e.getModel("ui");if(n||s.getProperty("/editable")){delete o.nonDraftCreateContext;if(!t){delete o.nonDraftCreateContext;s.setProperty("/editable",false);var l=F();l.setProperty("/objectPage/displayMode",1)}L(k(o.oController),"AfterCancel",r)}}function pe(e,t){return Ie()?null:o.oTemplateContract.oNavigationControllerProxy.navigateForNonDraftCreate(e,t)}function de(e,t){o.oApplication.setObjectInEditMode(t);o.oTemplateContract.oNavigationControllerProxy.adaptUrlAfterNonDraftCreateSaved(e)}function fe(){return A}function ge(t){var n=e.getComponentContainer().getElementBinding();if(n){e.getModel().invalidateEntry(n.getBoundContext());if(n.isSuspended()){re()}else{n.refresh(!t);o.bWithoutAssociationsRefresh=false}}}function me(t){t=t||e.getIsRefreshRequired();if(t||!l(o.mRefreshInfos)||o.bWithoutAssociationsRefresh){(o.methods.refreshBinding||Function.prototype)(t,o.mRefreshInfos,o.bWithoutAssociationsRefresh);e.setIsRefreshRequired(false);o.mRefreshInfos=Object.create(null)}ie(t,true)}function ve(){var t=e.getModel();var n={canonicalRequest:!o.oTemplateContract.bCreateRequestsCanonical,batchGroupId:"facets",updateAggregatedMessages:true};t.read(A,n)}function Ce(t){if(Ie()){var n=e.getComponentContainer();var o=n.getElementBinding();if(o&&!o.isSuspended()){o.suspend();t.catch(function(){o.resume()})}}}function he(){var t=e.getComponentContainer();if(o.nonDraftCreateContext){t.setBindingContext();delete o.nonDraftCreateContext;return}var r=t.getElementBinding();if(r&&!r.isSuspended()){var a=o.oTemplateContract.oValidationMessageBinding.getAllCurrentContexts();var i=o.oController.getView();var s=a.some(function(e){var t=e.getObject();var o=t.controlIds;return o.some(function(e){return n.isElementVisibleOnView(e,i)})});if(s){re()}else{r.suspend()}J()}}function be(t){var n=N();return o.oApplication.registerContext(t,n,e.getEntitySet(),Te())}function Pe(e){if(e.level<2){return[e.entitySet]}var t=o.oTemplateContract.mRoutingTree[e.parentRoute];var n=Pe(t);if(e!==v){n.push(e.navigationProperty?n[t.level-1]+"/"+e.navigationProperty:e.entitySet)}return n}function xe(){return v.level<2?[]:Pe(v)}function ye(e,n,r){var a;for(a=v;a.level>r;){a=o.oTemplateContract.mRoutingTree[a.parentRoute]}var i=new t(e);i.bindProperty("/"+n).attachChange(function(e){var t=e.getSource().getValue();o.oTemplateContract.oNavigationControllerProxy.setTextForTreeNode(a,t)});a.contextTargets=a.contextTargets||[];a.contextTargets.push(e)}function Te(){return o.oApplication.getCurrentKeys(N())}function Ae(t){return o.oApplication.getCommunicationObject(e,t)}function Re(e,t,n,r,a){o.oTemplateContract.oNavigationControllerProxy.navigateToChildInHierarchy(v,e,n,t,r,a)}function Se(e,t,n){o.oTemplateContract.oNavigationControllerProxy.navigateFromNodeAccordingToContext(v,e,t,n)}function De(){return v.headerTitle}function Fe(e){o.oTemplateContract.oNavigationControllerProxy.setTextForTreeNode(v,e)}function Ie(){return v.isDraft}function Ee(){return!(o.routingSpec&&o.routingSpec.noOData)}function Ne(){return!o.oTemplateContract.bCreateRequestsCanonical}function Be(){return C}function Oe(){return o.oTemplateContract.oPaginatorInfo[N()-1]}function Me(t){var n=N();if(t&&!t.suppressButtons&&t.objectPageNavigationContexts.length>0){var a=t.objectPageNavigationContexts[0];var i=r.analyseContext(a);var s=i.entitySet;t.suppressButtons=o.mRefreshInfos[s]||e.getIsRefreshRequired()}o.oTemplateContract.oPaginatorInfo[n]=t}function Ue(e,t){o.reuseComponentsReady.then(function(n){var o=t.getComponentInstance();for(var r in n){if(o===n[r].component){var a=F();a.setProperty("/generic/embeddedComponents/"+r+"/isInVisibleArea",e);return}}})}function we(){return o.oStatePreserverPromise.then(function(e){return e.stateChanged()})}o.oStatePreserverPromise=o.reuseComponentsReady.then(function(t){var n=o.methods.getStatePreserverSettings&&o.methods.getStatePreserverSettings();if(!n){return{getUrlParameterInfo:function(){return Promise.resolve({})},applyAppState:Function.prototype,stateChanged:Function.prototype}}var r="sap-iapp-state"+(v.level===0?"":"-"+v.entitySet);var a=s({appStateName:encodeURI(r),getCurrentState:function(){var e=o.methods.getCurrentState?o.methods.getCurrentState():Object.create(null);var n=function(t,n){if(t.component.stGetCurrentState){var o=t.component.stGetCurrentState();for(var r in o){e["$embeddedComponent$"+n.length+"$"+n+"$"+r]=o[r]}}};se(t,n);return e},applyState:function(e,n){var r=Object.create(null);var a=Object.create(null);for(var i in e){if(i.indexOf("$embeddedComponent$")===0){var s=i.substring(19);var l=s.indexOf("$");var u=Number(s.substring(0,l));var c=s.substring(l+1,l+u+1);var p=a[c];if(!p){p=Object.create(null);a[c]=p}var d=s.substring(l+u+2);p[d]=e[i]}else{r[i]=e[i]}}(o.methods.applyState||Function.prototype)(r,n);var f=function(e,t){if(e.component.stApplyState){e.component.stApplyState(a[t]||Object.create(null),n)}};Promise.all([o.oViewRenderedPromise,C]).then(se.bind(null,t,f))},oComponent:e},n);var l=new i(o.oTemplateContract,a);o.oApplication.registerStateChanger(l.getAsStateChanger());return l});o.oTemplateContract.oStatePreserversAvailablePromise=Promise.all([o.oTemplateContract.oStatePreserversAvailablePromise,o.oStatePreserverPromise]);function je(){var e=o.oTemplateContract.oFlexibleColumnLayoutHandler;return e?e.getFclProxy(v):{handleDataReceived:v.level?null:Function.prototype,isListAndFirstEntryLoadedOnStartup:v.level?null:Function.prototype,isNextObjectLoadedAfterDelete:Function.prototype}}function He(){return v.page.component.settings||{}}function Ve(){var t=e.getAppComponent().getManifestEntry("sap.ui5");var n=t.extends&&t.extends.extensions&&t.extends.extensions["sap.ui.controllerExtensions"];var r=o.methods.oComponentData.templateName+"#"+o.oComponent.getAppComponent().getMetadata().getComponentName()+"::"+o.methods.oComponentData.templateName+"::"+o.oComponent.getEntitySet();n=n&&(n[r]||n[o.methods.oComponentData.templateName]);n=n&&n["sap.ui.generic.app"];var a=n&&Object.keys(n).find(function(t){return n[t]&&n[t].EntitySet===e.getEntitySet()});return a&&n[a]}function Le(){var t=e.getAppComponent().getManifestEntry("sap.ui5");var n=t.extends&&t.extends.extensions&&t.extends.extensions["sap.ui.viewExtensions"];return n&&n[o.methods.oComponentData.templateName]}function ke(e){o.aUnsavedDataCheckFunctions=o.aUnsavedDataCheckFunctions||[];o.aUnsavedDataCheckFunctions.push(e)}function qe(){if(o.methods.adaptToChildContext){var e=F().getProperty("/generic/currentActiveChildContext");o.methods.adaptToChildContext(e)}}var $e;function Ge(){$e=$e||new a(o.oTemplateContract,o.oController,o.oControllerUtils.oCommonUtils);return $e}function Ke(e){if(o.methods.executeAfterInvokeActionFromExtensionAPI){o.methods.executeAfterInvokeActionFromExtensionAPI(e,o.oControllerUtils.oCommonUtils)}}function We(e){if(o.methods.executeBeforeInvokeActionFromExtensionAPI){o.methods.executeBeforeInvokeActionFromExtensionAPI(e,o.oControllerUtils.oCommonUtils)}}function ze(){var e=o.oController.getView();var t=e.getModel();if(t.hasPendingChanges(true)){return true}if(o.aUnsavedDataCheckFunctions){return o.aUnsavedDataCheckFunctions.some(function(e){return e()})}return false}function _e(e){if(o.reactivate&&!e){return}if(!o.oController){return}var t=o.oController.onLeaveAppExtension&&o.oController.onLeaveAppExtension.apply(o.oController,[e]);o.reactivate=o.reuseComponentsReady.then(function(n){var o=Object.create(null);se(n,function(t,n){var r=t.leaveApp(e);if(r&&!e){o[n]=r}});return!e&&function(){if(t){t()}for(var e in o){o[e]()}}})}function Qe(){if(o.oTemplateContract.oFlexibleColumnLayoutHandler){o.oTemplateContract.oFlexibleColumnLayoutHandler.hidePlaceholder(v)}else{o.oTemplateContract.oNavigationHost.hidePlaceholder()}if(v.level===0){var e=o.oTemplateContract.oNavigationControllerProxy.oRouter.getTargets();var t=e.getTarget("root");delete t.placeholder}}function Je(t){var n=o.oTemplateContract.oNavigationControllerProxy.getActiveComponents();var r=n.indexOf(e.getId());for(var a=r;a<n.length;a++){var i=n[a];var s=o.oTemplateContract.componentRegistry[i];if(s.methods.prepareForMessageNavigation){s.methods.prepareForMessageNavigation(t)}}}function Xe(){return o.oViewRenderedPromise}function Ye(){return o.viewRegistered}function Ze(){return v.selectionInfo}function et(){var e=He();var t=c.fromQuery(window.location.search).get("sap-fe-xx-lazyloadingtest")==="true";return t?t:e.renderingBehavior&&e.renderingBehavior.waitForViewportEnter}function tt(){return o.lastFocus}function nt(e,t){var n=e["sap.app"].crossNavigation&&e["sap.app"].crossNavigation.outbounds;return n&&n[t]||Object.create(null)}return{getBusyHelper:function(){return o.oApplication.getBusyHelper()},attach:function(e,t,n){H(k(e),t,n)},detach:function(e,t,n){V(k(e),t,n)},fire:function(e,t,n){L(k(e),t,n)},getPreprocessorsData:M,getRootExpand:w,getParameterModelForTemplating:j,bindComponent:ue,cancelEdit:ce,getNonDraftCreatePromise:pe,adaptUrlAfterNonDraftCreateSaved:de,getBindingPath:fe,refreshBinding:me,refreshBindingUnconditional:ge,suspendBinding:he,messagesRefresh:ve,getTemplatePrivateModel:F,getTemplatePrivateGlobalModel:E,registerContext:be,getViewLevel:N,getMainComponentDetails:B,getMainComponentUtils:O,getBreadCrumbInfo:xe,registerAncestorTitleUpdater:ye,getCurrentKeys:Te,getCommunicationObject:Ae,navigateRoute:Re,navigateAccordingToContext:Se,getTitle:De,setText:Fe,onBeforeDraftTransfer:Ce,isDraftEnabled:Ie,isODataBased:Ee,getNoStateMessagesForTables:Ne,isComponentActive:q,getHierachicalDistance:$,getDataNotExisting:Z,getHeaderDataAvailablePromise:Be,getPaginatorInfo:Oe,setPaginatorInfo:Me,onVisibilityChangeOfReuseComponent:Ue,getNavigationFinishedPromise:G,stateChanged:we,unbind:re,getFclProxy:je,getSettings:He,getControllerExtensions:Ve,getViewExtensions:Le,registerUnsavedDataCheckFunction:ke,layoutChanged:qe,getCRUDActionHandler:Ge,executeAfterInvokeActionFromExtensionAPI:Ke,executeBeforeInvokeActionFromExtensionAPI:We,preloadComponent:I,isComponentDirty:ze,getTargetKeyFromLevel:U,leaveApp:_e,hidePlaceholder:Qe,prepareForMessageNavigation:Je,getViewRenderedPromise:Xe,getViewInitializedPromise:Ye,getSelectionInfo:Ze,isRenderingWaitingForViewportEntered:et,getLastFocus:tt,getOutboundNavigationIntent:nt,getToolbarDataFieldForActionCommandDetails:D.getToolbarDataFieldForActionCommandDetails,getToolbarDataFieldForIBNCommandDetails:D.getToolbarDataFieldForIBNCommandDetails}}return e.extend("sap.suite.ui.generic.template.lib.ComponentUtils",{constructor:function(e,t){s(this,v(e,t))}})});
//# sourceMappingURL=ComponentUtils.js.map