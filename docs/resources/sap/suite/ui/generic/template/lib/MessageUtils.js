sap.ui.define(["sap/ui/base/Event","sap/ui/core/ValueState","sap/m/MessageToast","sap/ui/generic/app/util/MessageUtil","sap/suite/ui/generic/template/genericUtilities/controlHelper","sap/suite/ui/generic/template/genericUtilities/FeLogger","sap/suite/ui/generic/template/lib/TemplateComponent"],function(e,t,a,r,s,o,n){"use strict";var i=new o("lib.MessageUtils").getLogger();var l=sap.ui.getCore().getMessageManager();function c(e,t,a,s,o,n){o=o||{};var l=r.parseErrorResponse(s);var c=l.messageText;var g;var E=false;var T=false;var p=t&&t.getOwnerComponent();var u=o.resourceBundle||p.getModel("i18n").getResourceBundle();var _=o.navigationController||a.oNavigationController;var v=o.model||p.getModel();i.debug("handleError has been called with operation "+e+" and HTTP response status code "+l.httpStatusCode);var f=n&&n[l.httpStatusCode];if(f){f(l.httpStatusCode)}var R=l.httpStatusCode;switch(R){case 400:switch(e){case r.operations.modifyEntity:break;case r.operations.callAction:c=u.getText("ST_GENERIC_BAD_REQUEST_ACTION");break;case r.operations.deleteEntity:c=u.getText("ST_GENERIC_BAD_REQUEST_DELETE");break;case r.operations.editEntity:c=u.getText("ST_GENERIC_BAD_REQUEST_EDIT");break;case r.operations.saveEntity:case r.operations.activateDraftEntity:if(a&&a.oTemplateCapabilities&&a.oTemplateCapabilities.oMessageButtonHelper&&a.oTemplateCapabilities.oMessageButtonHelper.showMessagePopover){a.oTemplateCapabilities.oMessageButtonHelper.showMessagePopover();T=true}else{i.info("A MessageButtonHelper class instance could not be found as one of the services' template capabilities.")}break;default:c=u.getText("ST_GENERIC_BAD_REQUEST");break}break;case 401:E=true;c=u.getText("ST_GENERIC_ERROR_AUTHENTICATED_FAILED");g=u.getText("ST_GENERIC_ERROR_AUTHENTICATED_FAILED_DESC");break;case 403:switch(e){case r.operations.callAction:c=u.getText("ST_GENERIC_ERROR_NOT_AUTORIZED_ACTION");break;case r.operations.addEntry:c=u.getText("ST_GENERIC_ERROR_NOT_AUTORIZED_CREATE");break;case r.operations.deleteEntity:c=u.getText("ST_GENERIC_ERROR_NOT_AUTORIZED_DELETE");break;case r.operations.editEntity:c=u.getText("ST_GENERIC_ERROR_NOT_AUTORIZED_EDIT");break;default:c=u.getText("ST_GENERIC_ERROR_NOT_AUTORIZED");g=u.getText("ST_GENERIC_ERROR_NOT_AUTORIZED_DESC");E=true;break}break;case 404:switch(e){case r.operations.callAction:c=u.getText("ST_GENERIC_BAD_REQUEST_ACTION");break;default:c=u.getText("ST_GENERIC_BAD_REQUEST");break}break;case 409:case 412:if((e===r.operations.activateDraftEntity||e===r.operations.deleteEntity)&&s.response&&s.response.headers&&s.response.headers["preference-applied"]==="handling=strict"){return}break;case 422:break;case 423:if(e===r.operations.activateDraftEntity||e===r.operations.saveEntity||e===r.operations.deleteEntity){return}break;case 500:case 501:case 502:case 503:case 504:case 505:E=!Object.keys(r.operations).some(function(t){return t===e});switch(e){case r.operations.callAction:c=u.getText("ST_GENERIC_ERROR_SYSTEM_UNAVAILABLE_FOR_ACTION");break;default:c=u.getText("ST_GENERIC_ERROR_SYSTEM_UNAVAILABLE");break}g=u.getText("ST_GENERIC_ERROR_SYSTEM_UNAVAILABLE_DESC");break;case 0:E=false;T=true;break;default:E=true;c=u.getText("ST_GENERIC_ERROR_SYSTEM_UNAVAILABLE");g=u.getText("ST_GENERIC_ERROR_SYSTEM_UNAVAILABLE_DESC");break}if(E){var S;if(p){var I=p.getModel("_templPriv");S=I.getProperty("/generic/viewLevel")}_.navigateToMessagePage({title:u.getText("ST_GENERIC_ERROR_TITLE"),text:c,description:g,icon:"sap-icon://message-error",viewLevel:S})}else{if(!l.containsTransientMessage&&!T){r.addTransientErrorMessage(c,g,v)}}}function g(t,a,r,o,i){var l;if(a instanceof e){var c=a.getParameter("item");l=c.getBindingContext("msg").getObject()}else{l=a}var g=t.oCommonUtils.getPositionableControlId(l.controlIds,true);if(!g){t.oServices.oApplication.registerForMessageNavigation(t,l,r);return}var E=Promise.resolve(false);if(o){var T=s.byId(g);if(s.isTable(T)){var p=l.controlIds.filter(function(e){var t=s.byId(e);return!s.isTable(t)});var u;p.forEach(function(e){var a=s.isElementVisibleOnView(e,null,function(t){var a=s.isView(t)&&t.getVisible()&&t.getController().getOwnerComponent();return a instanceof n&&{component:a,controlId:e}});if(a&&t.oServices.oApplication.isComponentActive(a.component)){var r=a.component.getModel("_templPriv");a.level=r.getProperty("/generic/viewLevel");if(!u||u.level<a.level){u=a}}});if(u){g=u.controlId;r=u.component}else{var _=l.aFullTargets.find(function(e){return e.startsWith(i)&&e.lastIndexOf("/")>i.length});if(_){E=t.oServices.oApplication.navigateToMessageTarget(l,_)}}}}E.then(function(e){if(e){return}var a={targetInfo:l};t.oServices.oApplication.prepareForControlNavigation(r,g).then(s.focusControl.bind(null,g,a))})}function E(e,t){var a=l.getMessageModel().getData();var r=a.some(function(e){return e.persistent});if(!r){t.oApplication.showMessageToast(e)}}function T(e,t){var a=e.some(function(e){var a=t.oCommonUtils.getPositionableControlId(e.controlIds,true);return!a||s.isTable(s.byId(a))});if(a){t.oComponentUtils.prepareForMessageNavigation(e)}}function p(e){var t=e.getTechnicalDetails();return!!t&&t.statusCode==="412"&&!t.headers["preference-applied"]}function u(e){var t=l.getMessageModel().getData();return t.find(function(t){return t.id===e})}function _(e,t){var a=l.getMessageModel().getProperty("/");var r=a.filter(function(a){return a.persistent&&(e||!a.technicalDetails||a.technicalDetails.statusCode!=="404"||a.type!=="Error")&&t(a)});return r}function v(e){var t=_(true,e);if(t.length>0){l.removeMessages(t)}}function f(e){var a=t.None,r=0;for(var s=0;s<e.length;s++){var o=I(e[s]);if(o>r){a=e[s].type;r=o}}return a}function R(e,a){var r,s="";r=f(e);var o="";if(r===t.Error){o=e.length>1?"ST_MESSAGES_DIALOG_TITLE_ERROR_PLURAL":"ST_MESSAGES_DIALOG_TITLE_ERROR"}else if(r===t.Warning){o=e.length>1?"ST_MESSAGES_DIALOG_TITLE_WARNING_PLURAL":"ST_MESSAGES_DIALOG_TITLE_WARNING"}else if(r===t.Information){o="ST_MESSAGES_DIALOG_TITLE_INFORMATION"}else if(r===t.Success){o="ST_MESSAGES_DIALOG_TITLE_SUCCESS_PLURAL"}s=a.getText(o);return{sTitle:s,sSeverity:r}}function S(e,r,s){var o=e.oApplicationProxy.isTransientMessageNoCustomMessage;var n=_(false,o);if(n.length===0){return Promise.resolve()}v(o);var i;if(n.length===1){i=n[0].type;if(i===t.Success||i===t.Information||i===t.None){a.show(n[0].message);return Promise.resolve()}}var l=R(n,e);i=l.sSeverity;return new Promise(function(t){var a,r,o;var c=function(){a.close();o.setProperty("/backButtonVisible",false);o.setProperty("/messages",[]);o.setProperty("/messageToGroupName",Object.create(null));r.navigateBack();o.getProperty("/resolve")()};var g={onMessageDialogClose:function(){c(o)},onActionButtonPressed:function(){o.getProperty("/actionButtonCallback")();c(o)},onBackButtonPress:function(){o.setProperty("/backButtonVisible",false);r.navigateBack()},onMessageSelect:function(){o.setProperty("/backButtonVisible",true)}};var E=function(t,a){a.setProperty("/genericGroupName",e.getText("ST_MESSAGE_GENERAL_TITLE"));a.setProperty("/backButtonVisible",false);a.setProperty("/cancelButtonText",e.getText("CANCEL"));a.setProperty("/closeButtonText",e.getText("ST_GENERIC_DIALOG_CLOSE_BUT"))};e.oApplicationProxy.getDialogFragmentAsync("sap.suite.ui.generic.template.fragments.MessageDialog",g,"settings",E,false,true).then(function(e){a=e;r=a.getContent()[0];var c=a.getModel();var g=c&&c.getMetaModel();var E=false;var T=!!(s&&s.action);var p=Object.create(null);if(g){n.forEach(function(e){var t=e.getTarget();if(!t){return}if(t.lastIndexOf("/")>0){t=t.substring(0,t.lastIndexOf("/"))}var a=t.substring(1,t.indexOf("("));var r=a&&g.getODataEntitySet(a);var s=r&&g.getODataEntityType(r.entityType);var o=s&&s["com.sap.vocabularies.UI.v1.HeaderInfo"];var n=o&&o.Title&&o.Title.Value&&o.Title.Value.Path;var i=c.getProperty(t);var l=i&&i[n];if(l){p[e.getId()]=l;E=true}})}o=a.getModel("settings");o.setProperty("/showActionButton",T);if(T){o.setProperty("/actionButtonText",s.actionLabel);o.setProperty("/actionButtonCallback",s.action)}o.setProperty("/title",l.sTitle);o.setProperty("/messages",n);o.setProperty("/grouping",E);o.setProperty("/state",i);o.setProperty("/resolve",t);o.setProperty("/messageToGroupName",p);a.open()})})}function I(e){var t;switch(e.type){case"Error":t=4;break;case"Warning":t=3;break;case"Information":t=2;break;case"Success":t=1;break;default:t=0}return t}return{operations:r.operations,handleTransientMessages:S,prepareForMessageNavigation:T,handleError:c,navigateFromMessageTitleEvent:g,removeTransientMessages:v,getTransientMessages:_,showSuccessMessageIfRequired:E,parseError:r.parseErrorResponse,isMessageETagMessage:p,getMessageById:u,getSeverityAsNumber:I,getMessageDialogTitleAndSeverity:R}});
//# sourceMappingURL=MessageUtils.js.map