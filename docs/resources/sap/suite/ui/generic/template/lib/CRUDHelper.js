sap.ui.define(["sap/ui/base/Object","sap/ui/model/Context","sap/suite/ui/generic/template/lib/MessageUtils","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/m/MessageBox","sap/suite/ui/generic/template/genericUtilities/CacheHelper","sap/suite/ui/generic/template/genericUtilities/metadataAnalyser"],function(e,t,n,r,a,i,s,o){"use strict";var l=Promise.reject();l.catch(Function.prototype);function f(e,t,n,r,a){var i=n.createEntry(t,{properties:r,context:e,batchGroupId:"Changes",changeSetId:"Changes",canonicalRequest:a});return i}function u(e,t,n,r,a,i,s,o){n=n||"/"+t;var l=a.mustRequireRequestsCanonical();s.oFunctionImportDialogInfo={getTitleText:function(){return o.getText("DIALOG_TITLE_NEW_ACTION_FOR_CREATE")},getActionButtonText:function(){return o.getText("DIALOG_ACTION_BUTTON_NEW_ACTION_FOR_CREATE")}};return e.createNewDraftEntity(t,n,i,l,s).then(function(e){return e.context})}function c(e,t,n){var r=new Promise(function(n,r){e.read(t,{urlParameters:{$expand:"DraftAdministrativeData"},success:function(e){n(e)},error:function(e){r(e)}})});n.setBusy(r,true);return r}function d(e,t,n,i,s,o){var l=new Promise(function(o,l){var f,u,c,d,g=[];if(n&&i&&s){u=n.length;for(f=0;f<u;f++){c=n[f].PropertyPath;d=i[c][0];g.push(new r(c,a.EQ,d))}if(e.getDraftController().getDraftContext().isDraftEnabled(t)){var p=new r({filters:[new r("IsActiveEntity","EQ",false),new r("SiblingEntity/IsActiveEntity","EQ",null)],and:false});g.push(p)}var D=new r(g,true);s.read("/"+t,{urlParameters:{$expand:"DraftAdministrativeData"},filters:[D],success:function(e){var t=v(e,s,i);if(t){o(t)}else{l(e)}},error:function(e){l(e)}})}});o.oBusyHelper.setBusy(l,true);return l}function v(e,t,n){var r,a,i,s;if(e&&e.results){i=e.results.length;if(i==0){s=null}else if(i==1){s=e.results[0]}else if(i>=1){var o=[];var l=[];for(a=0;a<i;a++){r=e.results[a];if(r&&r.IsActiveEntity){l.push(r)}else if(r&&r.IsActiveEntity==false){o.push(r)}}if(l.length==0&&o.length>=2){var f;for(var u=0;u<o.length;u++){f=o[u];if(f.DraftUUID==n.DraftUUID){s=f;break}}if(!s){s=o[0]}}else if(l.length==1&&o.length==1){s=l[0]}else if(l.length==1&&o.length>=2){s=l[0]}}}return s}function g(e){var t=e.oAppComponent;var r=t.getModel();var a=r.getMetaModel();var i=t.getNavigationController();var s=t.getApplicationController();var o=s.getTransactionController().getDraftController().getDraftContext();var l=function(t){e.oApplicationProxy.getResourceBundleForEditPromise().then(function(a){n.handleError(n.operations.modifyEntity,null,null,t,{resourceBundle:a,navigationController:i,model:r});n.handleTransientMessages(e)})};var f=function(t){var n=t.getParameter("context");if(!o.hasDraft(n)){return}if(!a.getODataEntitySet(n.getPath().split("(")[0].substring(1))){return}var r=t.getParameter("path");s.propertyChanged(r,n).catch(l);e.oApplicationProxy.markCurrentDraftAsModified()};r.attachPropertyChange(f)}function p(e,t,n,r,a){var s=e||n;return new Promise(function(e,n){var o=s.getText("DRAFT_LOCK_EXPIRED",[t.LastChangedByUserDescription||t.LastChangedByUser]);var l=s.getText("Edit");var f=s.getText("CANCEL");i.warning(o,{title:s.getText("ST_UNSAVED_CHANGES_TITLE"),actions:[l,f],emphasizedAction:l,onClose:function(t){if(t===l){e()}else if(t===f){if(a){r.navigateUp()}}n()}})})}function D(e,n,r,a,i,o,l,f){if(r===""&&l&&f){return new Promise(function(u,c){var v=s.getInfoForContentIdPromise(n,a,i.oAppComponent.getId());Promise.all([v,d(e,n,l,f,a,i)]).then(function(s){var l=s[1];var f=s[0].contentIdRequestPossible?s[0].parametersForContentIdRequest.sRootExpand:null;var d="/"+a.createKey(n,l);a.createBindingContext(r,null,null,function(n){var n=new t(a,d);if(!l.DraftAdministrativeData||l.DraftAdministrativeData.DraftIsCreatedByMe){u(e.editEntity(n,false,f))}else if(l.DraftAdministrativeData.InProcessByUser){c({lockedByUser:l.DraftAdministrativeData.InProcessByUserDescription||l.DraftAdministrativeData.InProcessByUser})}else{p(i,l.DraftAdministrativeData,o).then(function(){u(e.editEntity(n,false))},function(){c({lockedByUser:l.DraftAdministrativeData.LastChangedByUserDescription||l.DraftAdministrativeData.LastChangedByUser})})}})},function(e){c({draftAdminReadResponse:e})})})}var u=e.getDraftController().getDraftContext();var v=new Promise(function(t,s){a.createBindingContext(r,null,null,function(l){if(u.isDraftEnabled(n)){if(true||!u.hasPreserveChanges(l)){c(a,r,i.oBusyHelper).then(function(n){if(!n.DraftAdministrativeData||n.DraftAdministrativeData.DraftIsCreatedByMe){t(e.editEntity(l,false))}else if(n.DraftAdministrativeData.InProcessByUser){s({lockedByUser:n.DraftAdministrativeData.InProcessByUserDescription||n.DraftAdministrativeData.InProcessByUser})}else{var r=function(){t(e.editEntity(l,false))};var a=function(){s({lockedByUser:n.DraftAdministrativeData.LastChangedByUserDescription||n.DraftAdministrativeData.LastChangedByUser})};var f=p(i,n.DraftAdministrativeData,o);f.then(r,a)}},function(e){s({draftAdminReadResponse:e})});i.oBusyHelper.setBusy(v,true)}}else{t({context:l})}})});return v}function m(e,t,n,r,a,i,s,o,l){var f=e.getDraftController().getDraftContext();var u=new Promise(function(d,v){r.createBindingContext(n,null,null,function(g){if(f.isDraftEnabled(t)){e.editEntity(g,true).then(function(e){g.getModel().invalidateEntry(g);s.setRootPageToDirty();d({context:e.context})},function(t){if(t&&t.response&&t.response.statusCode==="409"){a.removeTransientMessages();c(r,n,a.getBusyHelper()).then(function(t){if(t.DraftAdministrativeData.InProcessByUser){v({lockedByUser:t.DraftAdministrativeData.InProcessByUserDescription||t.DraftAdministrativeData.InProcessByUser})}else{var n=function(){var t=e.editEntity(g,false).then(function(e){g.getModel().invalidateEntry(g);s.setRootPageToDirty();d({context:e.context})});a.getBusyHelper().setBusy(t,true)};var r=Function.prototype;var f=p(undefined,t.DraftAdministrativeData,i,o,l);f.then(n,r)}},function(e){v({draftAdminReadResponse:e})});a.getBusyHelper().setBusy(u,true)}else{v(t)}})}else{return d({context:g})}})});return u}function y(e,t,n,r,a,i){var s=e.hasActiveEntity(r);var o=s&&!a?n.getDraftSiblingPromise(r):Promise.resolve();return o.then(function(e){var o=t(a,s,r);if(!a){var l=function(){return{context:e}};var f=o.then(l);n.cancellationStarted(r,f,i,e)}return o})}function h(e,t,n,r){var a=function(e,n,r){return t.deleteEntity(r)};return y(e,a,n,r,false,"discardAction")}function A(e,t,r){var a=t.getMessageModel();var i=a.bindList("/",null,null,[e]);var s=i.getCurrentContexts().map(function(e){return e.getObject()});if(r){s=s.filter(function(e){return!n.isMessageETagMessage(e)})}return s}function C(e,t,r,a,i,s){if(r.isBusy()){return l}var f=new Promise(function(l,f){var u=e?e:i.getView().getBindingContext();var c=t?t:a.oTemplateCapabilities.oMessageButtonHelper&&a.oTemplateCapabilities.oMessageButtonHelper.getContextFilter(true);var d=sap.ui.getCore().getMessageManager();var v=false;var g=i.getView().getModel();var p=o.isContentIdReferencingAllowed(g)?s.getRootExpand():undefined;var D=function(e){v=true;var t=function(){var t=a.oDraftController.activateDraftEntity(u,true,p);a.oApplication.activationStarted(u,t);t.then(function(e){l(e)},function(t){var r=A(c,d).filter(function(e){return e.type==="Error"});if(r.length){var s=r[0];var o=e.some(function(e){return s===e});if(!o){var l=r.some(function(e){return e.type==="Error"});if(l){a.oApplication.removeTransientMessages()}}}n.handleError(n.operations.activateDraftEntity,i,a,t,null);f()});r.setBusy(t)};var o={messagesForUserDecison:e};if(e.length===0){var g=a.oApplication.getTransientMessages();v=g.some(function(e){return e.type==="Warning"&&e.technicalDetails&&e.technicalDetails.statusCode==="412"&&e.technicalDetails.headers&&e.technicalDetails.headers["preference-applied"]==="handling=strict"});if(!v){return}o.messagesForUserDecison=g;a.oApplication.removeTransientMessages()}var D=s.getCRUDActionHandler();D.handleCRUDScenario(4,t,f,"Activate",o)};a.oApplication.getDraftSiblingPromise(u).then(function(t){if(t){i.getOwnerComponent().getModel().invalidateEntry(t)}var s=A(c,d);var o=a.oDraftController.activateDraftEntity(u,false,p);r.setBusy(o);a.oApplication.activationStarted(u,o);o.then(function(e){d.removeMessages(s);l(e)},function(t){var r=A(c,d);var o=0;if(r.length){var l=r[0];var u=s.some(function(e){return l===e});if(!u){r.some(function(e){if(e.type==="Error"){o=2;return true}if(e.type==="Warning"){o=1}});if(o===2){a.oApplication.removeTransientMessages()}}}if(!e){n.handleError(n.operations.activateDraftEntity,i,a,t,null,{412:D.bind(null,r)});if(!v){f()}else if(o===1){a.oApplication.removeTransientMessages()}}})})});return f}return{createNonDraft:f,create:u,edit:D,directEdit:m,enableAutomaticDraftSaving:g,discardDraft:h,deleteEntity:y,activateDraftEntity:C,fnGetMessagesFromContextFilter:A}});
//# sourceMappingURL=CRUDHelper.js.map