sap.ui.define(["sap/ui/thirdparty/jquery","sap/ui/core/Control","sap/suite/ui/commons/library","sap/ui/core/library","sap/m/library","sap/base/Log","sap/ui/Device","sap/m/MessageToast","sap/ui/core/Icon","./ResizeHistoryItem","./RotateHistoryItem","./CropRectangleHistoryItem","./CropEllipseHistoryItem","./CropCustomShapeHistoryItem","./FilterHistoryItem","./FlipHistoryItem","./FilterUtils","sap/ui/core/util/File","sap/suite/ui/commons/Utils","./ImageEditorRenderer","sap/ui/thirdparty/jqueryui/jquery-ui-draggable","sap/ui/thirdparty/jqueryui/jquery-ui-resizable"],function(jQuery,t,e,i,o,s,r,a,n,h,p,l,g,_,d,u,m,c,C){"use strict";var f=e.ImageEditorMode,y=e.ImageFormat,I=sap.ui.getCore().getLibraryResourceBundle("sap.suite.ui.commons");var w=t.extend("sap.suite.ui.commons.imageeditor.ImageEditor",{metadata:{library:"sap.suite.ui.commons",properties:{src:{type:"any",defaultValue:""},customShapeSrc:{type:"any",defaultValue:""},mode:{type:"sap.suite.ui.commons.ImageEditorMode",defaultValue:f.Default},keepCropAspectRatio:{type:"boolean",defaultValue:true},keepResizeAspectRatio:{type:"boolean",defaultValue:true},scaleCropArea:{type:"boolean",defaultValue:false}},events:{loaded:{},error:{},customShapeLoaded:{},customShapeError:{},sizeChanged:{parameters:{width:{type:"int"},height:{type:"int"},originalWidth:{type:"int"},originalHeight:{type:"int"}}},cropAreaChanged:{parameters:{cropArea:{type:"object"},originalCropArea:{type:"object"}}},zoomChanged:{parameters:{zoom:{type:"int"}}},historyChanged:{history:{type:"sap.suite.ui.commons.imageeditor.HistoryItem[]"},index:{type:"int"}}}}});w.LIMITS=Object.freeze({WIDTH_MIN:1,WIDTH_MAX:8192,HEIGHT_MIN:1,HEIGHT_MAX:8192,MAX_CANVAS_SIZE:67108864,MAX_SAFARI_MOBILE_CANVAS_SIZE:16777216,ROTATION_MIN:-360,ROTATION_MAX:360,SEPIA_MIN:0,SEPIA_MAX:100,GRAYSCALE_MIN:0,GRAYSCALE_MAX:100,SATURATE_MIN:0,SATURATE_MAX:500,INVERT_MIN:0,INVERT_MAX:100,BRIGHTNESS_MIN:0,BRIGHTNESS_MAX:500,CONTRAST_MIN:0,CONTRAST_MAX:500,CROP_AREA_MIN:1});w.ZOOM_MILESTONES=[5,10,25,33,50,67,75,80,90,100,110,125,150,175,200,250,300,400,500];var v=Object.freeze({CROP_AREA_SHORTER_SIDE_OFFSET:.8,DEFAULT_ZOOM_MILESTONE:100});w.prototype.init=function(){this._oCanvas=document.createElement("canvas");this._initCanvas();this._initOrigImg();this._initCustomShapeImg();this._fZoom=v.DEFAULT_ZOOM_MILESTONE;this._oSavedImg=document.createElement("canvas");this._oSavedImg.width=0;this._oSavedImg.height=0};w.prototype._initOrigImg=function(){var t=this;this._oOrigImg=new Image;this._oOrigImg.crossOrigin="Anonymous";this._oOrigImg.onload=function(){t._bImageLoaded=true;t._drawImage(t._oOrigImg);t._storeCurrentImg();t._applyExifOrientation();if(t._isReady()){t._onAfterIsReady()}if(t.getCustomShapeLoaded()&&!r.browser.msie){t._renderCustomShapeMask()}t.fireLoaded()};this._oOrigImg.onerror=function(e){t.fireError()}};w.prototype._initCustomShapeImg=function(){var t=this;this._oCustomShapeImg=new Image;this._oCustomShapeImg.crossOrigin="Anonymous";this._oCustomShapeImg.onload=function(){t._bCustomShapeLoaded=true;t.$().addClass("sapSuiteUiCommonsImageEditorModeCropCustomShapeLoaded");t._renderCustomShapeMask();t.fireCustomShapeLoaded()};this._oCustomShapeImg.onerror=function(){t.fireCustomShapeError()}};w.prototype._getExifOrientation=function(t){var e=new FileReader,i,o,s,r,a,n,h,p,l,g={FIRST_CHECK:65496,SECOND_CHECK:65505,CORRECT_FORMAT_CHECK:1165519206,LITTLE_CHECK:18761,FOURTH_CHECK:65280,EXIF_CHECK:274,ERR_FILE_FORMAT:-2,OFFSET_STEP:2,OFFSET_STEP_MED:4,OFFSET_STEP_BIG:6};return new Promise(function(_){e.onload=function(t){o=t.target.result;s=new DataView(o);r=s.byteLength;i=2;l=0;try{if(s.getUint16(0,false)!=g.FIRST_CHECK){return}while(i<r){a=s.getUint16(i,false);i+=g.OFFSET_STEP;if(a==g.SECOND_CHECK){i+=g.OFFSET_STEP;if(s.getUint32(i,false)!=g.CORRECT_FORMAT_CHECK){return}i+=g.OFFSET_STEP_BIG;n=s.getUint16(i,false)==g.LITTLE_CHECK;i+=s.getUint32(i+g.OFFSET_STEP_MED,n);h=s.getUint16(i,n);i+=g.OFFSET_STEP;for(p=0;p<h;p++){if(s.getUint16(i+p*12,n)==g.EXIF_CHECK){return s.getUint16(i+p*12+8,n)}}}else if((a&g.FOURTH_CHECK)!=FOURTH_CHECK){break}else{i+=s.getUint16(i,false)}}}catch(t){return _(g.ERR_FILE_FORMAT)}};e.readAsArrayBuffer(t.slice(0,64*1024))})};w.prototype._handleExifOrientation=function(t){var e=this;this._getExifOrientation(t).then(function(t){switch(t){case 1:e._iExifRotation=0;break;case 2:e._iExifRotation=0;e._bExifFlip=true;break;case 3:e._iExifRotation=180;break;case 4:e._bExifFlip=true;e._iExifRotation=180;break;case 5:e._bExifFlip=true;e._iExifRotation=90;break;case 6:e._iExifRotation=90;break;case 7:e._bExifFlip=true;e._iExifRotation=-90;break;case 8:e._iExifRotation=-90;break;default:e._iExifRotation=0;break}e._applyExifOrientation()})};w.prototype._applyExifOrientation=function(){if(this.getLoaded()){if(this._iExifRotation){this._setRotation(this._iExifRotation);this._storeCurrentImg()}if(this._bExifFlip){this._flipHorizontal();this._storeCurrentImg()}}};w.prototype._renderCustomShapeMask=function(){var t=document.createElement("canvas"),e=t.getContext("2d"),i,o;this._oCustomShapeImg.width=500;this._oCustomShapeImg.height=this._oCustomShapeImg.naturalHeight*this._oCustomShapeImg.width/this._oCustomShapeImg.naturalWidth;jQuery("body").prepend(this._oCustomShapeImg);i=this._oCustomShapeImg.clientWidth;o=this._oCustomShapeImg.clientHeight;jQuery(this._oCustomShapeImg).remove();if(i>=o){t.width=this._oCanvas.width;t.height=o*(this._oCanvas.width/i)}else{t.height=this._oCanvas.height;t.width=i*(this._oCanvas.height/o)}this._oCustomShapeImg.width=t.width;this._oCustomShapeImg.height=t.height;e.drawImage(this._oCustomShapeImg,0,0,this._oCustomShapeImg.width,this._oCustomShapeImg.height);e.globalCompositeOperation="source-in";e.fillStyle="black";e.fillRect(0,0,t.width,t.height);this._sBlackCustomShapeUrl=t.toDataURL();if(this.$("overlayMaskCustomBlack")[0]){this.$("overlayMaskCustomBlack")[0].setAttributeNS("http://www.w3.org/1999/xlink","href",this._sBlackCustomShapeUrl)}e.fillStyle="white";e.fillRect(0,0,t.width,t.height);this._sWhiteCustomShapeUrl=t.toDataURL();if(this.$("overlayMaskCustomWhite")[0]){this.$("overlayMaskCustomWhite")[0].setAttributeNS("http://www.w3.org/1999/xlink","href",this._sWhiteCustomShapeUrl)}};w.prototype.onAfterRendering=function(){this._$Container=this.$("canvasInnerContainer");this._$Container.prepend(this._oCanvas);this._initContainer();this._initCropArea();if(this._isReady()){this._onAfterIsReady()}};w.prototype.setSrc=function(t){this.setProperty("src",t,true);var e=this,i,o;this._reset();if(typeof t==="string"){i=t;this._oOriginalBlob=this._fetchUrlAsBlob(i).then(function(t){e._handleExifOrientation(t);e._oOriginalBlob=t;e._sOriginalFileType=t.type});if(!i.startsWith("data:image")){this._sOriginalFileName=this._getFileNameFromUrl(i)}}else if(t instanceof Blob){o=window.URL;i=o.createObjectURL(t);o.revokeObjectURL(t);e._handleExifOrientation(t);this._oOriginalBlob=t;this._sOriginalFileType=t.type;if(t instanceof File){this._sOriginalFileName=t.name}}if(i){this._oOrigImg.src=i}else{this.fireLoaded()}return this};w.prototype.setScaleCropArea=function(t){this.setProperty("scaleCropArea",t,true);return this};w.prototype.setCustomShapeSrc=function(t){this.setProperty("customShapeSrc",t,true);var e=this,i,o;e._bCustomShapeLoaded=false;if(typeof t==="string"){if((r.browser.msie||r.browser.firefox)&&t.startsWith("data:image/svg+xml;base64,")){this._handleSvgString(atob(t.slice("data:image/svg+xml;base64,".length)))}else{i=t}}else if(t instanceof Blob){if(t instanceof File&&t.type==="image/svg+xml"){var s=new FileReader;s.onload=function(t){e._handleSvgString(t.target.result)};s.readAsText(t)}else{o=window.URL;i=o.createObjectURL(t);o.revokeObjectURL(t);this._setCustomShapeSrc(i)}}if(i){this._setCustomShapeSrc(i)}else if(!t){this._sBlackCustomShapeUrl="";this._sWhiteCustomShapeUrl="";if(this.$("overlayMaskCustomBlack")[0]){this.$("overlayMaskCustomBlack")[0].setAttributeNS("http://www.w3.org/1999/xlink","href",this._sBlackCustomShapeUrl)}if(this.$("overlayMaskCustomWhite")[0]){this.$("overlayMaskCustomWhite")[0].setAttributeNS("http://www.w3.org/1999/xlink","href",this._sWhiteCustomShapeUrl)}this.$().removeClass("sapSuiteUiCommonsImageEditorModeCropCustomShapeLoaded");this.fireCustomShapeLoaded()}return this};w.prototype._handleSvgString=function(t){var e,i;if(r.browser.msie){throw Error("SVG files cannot be used as shapes for custom crop in Internet Explorer. Please use a different image source or a different browser.")}var o=(new DOMParser).parseFromString(t,"image/svg+xml");if(o.documentElement.width.baseVal.value>0){o.documentElement.width.baseVal.valueAsString=o.documentElement.width.baseVal.value.toString()+"px"}if(o.documentElement.height.baseVal.value>0){o.documentElement.height.baseVal.valueAsString=o.documentElement.height.baseVal.value.toString()+"px"}i=(new XMLSerializer).serializeToString(o);e="data:image/svg+xml;base64,"+btoa(i);this._setCustomShapeSrc(e)};w.prototype._setCustomShapeSrc=function(t){this._oCustomShapeImg.src=t};w.prototype.setKeepCropAspectRatio=function(t){this.setProperty("keepCropAspectRatio",t,true);this._updateResizableCropAspectRatio();return this};w.prototype.setKeepResizeAspectRatio=function(t){this.setProperty("keepResizeAspectRatio",t,true);this._updateResizableResizeAspectRatio();return this};w.prototype.getLoaded=function(){return!!this.getSrc()&&this._bImageLoaded};w.prototype.getCustomShapeLoaded=function(){return!!this.getCustomShapeSrc()&&this._bCustomShapeLoaded};w.prototype.setSize=function(t,e,i){this._throwIfNotLoaded("setSize");var o,s,r;t=this._constraintValue(t,w.LIMITS.WIDTH_MIN,w.LIMITS.WIDTH_MAX);e=this._constraintValue(e,w.LIMITS.HEIGHT_MIN,w.LIMITS.HEIGHT_MAX);r=this._limitCanvasSize(t,e);t=r.width;e=r.height;this._cancelPreview();o=this.getWidth();s=this.getHeight();this._setCanvasSize(t,e);this._addHistory(new h({width:t,height:e,oldWidth:o,oldHeight:s}),i);return this};w.prototype.getWidth=function(){this._throwIfNotLoaded("getWidth");return this._getLastImg().width};w.prototype.getPreviewWidth=function(){this._throwIfNotLoaded("getPreviewWidth");return this._oCanvas.width};w.prototype.setWidth=function(t,e){this._throwIfNotLoaded("setWidth");var i=this.getHeight(),o=this.getWidth(),s=this.getPreviewHeight(),r;t=this._constraintValue(t,w.LIMITS.WIDTH_MIN,w.LIMITS.WIDTH_MAX);if(this.getKeepResizeAspectRatio()){s=Math.round(t*s/this.getPreviewWidth())}r=this._limitCanvasSize(t,s);t=r.width;s=r.height;this._cancelPreview();this._setCanvasSize(t,s);this._addHistory(new h({width:t,height:s,oldWidth:o,oldHeight:i}),e);return this};w.prototype.getHeight=function(){this._throwIfNotLoaded("getHeight");return this._getLastImg().height};w.prototype.getPreviewHeight=function(){this._throwIfNotLoaded("getPreviewHeight");return this._oCanvas.height};w.prototype.setHeight=function(t,e){this._throwIfNotLoaded("setHeight");var i=this.getWidth(),o=this.getHeight(),s=this.getPreviewWidth(),r;t=this._constraintValue(t,w.LIMITS.HEIGHT_MIN,w.LIMITS.HEIGHT_MAX);if(this.getKeepResizeAspectRatio()){s=Math.round(t*s/this.getPreviewHeight())}r=this._limitCanvasSize(s,t);s=r.width;t=r.height;this._cancelPreview();this._setCanvasSize(s,t);this._addHistory(new h({width:s,height:t,oldWidth:i,oldHeight:o}),e);return this};w.prototype.rotate=function(t,e){this._throwIfNotLoaded("rotate");t=this._constraintValue(t,w.LIMITS.ROTATION_MIN,w.LIMITS.ROTATION_MAX);this._cancelPreview();this._setRotation(t);this._addHistory(new p({degrees:t}),e);return this};w.prototype.flipVertical=function(t){this._throwIfNotLoaded("flipVertical");this._cancelPreview();this._flipVertical();this._addHistory(new u({vertical:true,horizontal:false}),t);return this};w.prototype.flipHorizontal=function(t){this._throwIfNotLoaded("flipHorizontal");this._cancelPreview();this._flipHorizontal();this._addHistory(new u({vertical:false,horizontal:true}),t);return this};w.prototype.flip=function(t,e,i){this._throwIfNotLoaded("flip");this._cancelPreview();this._flip(t,e);this._addHistory(new u({vertical:t,horizontal:e}),i);return this};w.prototype.applyVisibleCrop=function(t){this._throwIfNotReady("applyVisibleCrop");switch(this.getMode()){case f.CropRectangle:{this._applyRectangleCrop(t);break}case f.CropEllipse:{this._applyEllipseCrop(t);break}case f.CropCustomShape:{this._throwIfCustomShapeNotLoaded("applyVisibleCrop CropCustomShape");this._applyCustomShapeCrop(t);break}default:{s.warning("No cropping mode is selected, applyVisibleCrop does nothing");break}}};w.prototype.rectangleCrop=function(t,e,i,o,s){this._throwIfNotLoaded("rectangleCrop");var r=this.getWidth(),a=this.getHeight();this._cancelPreview();this._rectangleCrop(t,e,i,o);this._addHistory(new l({x:Math.round(t),y:Math.round(e),width:Math.round(i),height:Math.round(o),oldWidth:r,oldHeight:a}),s);this._limitCurrentCropArea()};w.prototype.ellipseCrop=function(t,e,i,o,s){this._throwIfNotLoaded("ellipseCrop");var r=this.getWidth(),a=this.getHeight();this._cancelPreview();this._ellipseCrop(t,e,i,o);this._addHistory(new g({x:Math.round(t),y:Math.round(e),rx:Math.round(i),ry:Math.round(o),width:Math.round(i*2),height:Math.round(o*2),oldWidth:r,oldHeight:a}),s);this._limitCurrentCropArea()};w.prototype.customShapeCrop=function(t,e,i,o,s){this._throwIfNotLoaded("customShapeCrop");this._throwIfCustomShapeNotLoaded("customShapeCrop");var r=this.getWidth(),a=this.getHeight();this._cancelPreview();this._customShapeCrop(t,e,i,o);this._addHistory(new _({x:Math.round(t),y:Math.round(e),width:Math.round(i),height:Math.round(o),oldWidth:r,oldHeight:a}),s);this._limitCurrentCropArea()};w.prototype.setCropArea=function(t,e,i,o){this._throwIfNotLoaded("setCropArea");var s=this._limitCropArea(t,e,i,o);this._setCropArea(s.x,s.y,s.width,s.height);return this};w.prototype.setCropAreaByRatio=function(t,e){this._throwIfNotLoaded("setCropAreaByRatio");var i=this._oCanvas.width/this._oCanvas.height,o=t/e,s,r,a,n,h;if(typeof t!=="number"||typeof e!=="number"){return this}if(i>=o){r=v.CROP_AREA_SHORTER_SIDE_OFFSET;s=this._oCanvas.height*r*o;s=100*s/this._oCanvas.width;r*=100;a=(100-s)/2;n=(100-r)/2}else{s=v.CROP_AREA_SHORTER_SIDE_OFFSET;r=this._oCanvas.width*s/o;r=100*r/this._oCanvas.height;s*=100;n=(100-r)/2;a=(100-s)/2}h=this._transposePercentToImageCoordsPx(a,n,s,r);this._setCropArea(h.x,h.y,h.width,h.height);return this};w.prototype.setCustomShapeCropAreaRatio=function(){this._throwIfNotLoaded("setCustomShapeCropAreaRatio");this._throwIfCustomShapeNotLoaded("setCustomShapeCropAreaRatio");this.setCropAreaByRatio(this._oCustomShapeImg.width,this._oCustomShapeImg.height);return this};w.prototype.setCropAreaBySize=function(t,e){this._throwIfNotLoaded("setCropAreaBySize");var i=this._limitCropArea(null,null,t,e);this._setCropArea(null,null,i.width,i.height);return this};w.prototype.getCropArea=function(){return this._oCropArea?jQuery.extend({},this._oCropArea):null};w.prototype.zoom=function(t,e){this._setZoom(t,e);return this};w.prototype.zoomIn=function(t){this._zoomIn(t);return this};w.prototype.zoomOut=function(t){this._zoomOut(t);return this};w.prototype.zoomToFit=function(){this._throwIfNotReady("zoomToFit");this._zoomToFit();return this};w.prototype.getZoomLevel=function(){return this._fZoom};w.prototype.sepia=function(t,e){this._throwIfNotLoaded("sepia");this._constraintValue(t,w.LIMITS.SEPIA_MIN,w.LIMITS.SEPIA_MAX);this._cancelPreview();this._addHistory(new d({type:"sepia",value:t,unit:"%"}),e)};w.prototype.grayscale=function(t,e){this._throwIfNotLoaded("grayscale");this._constraintValue(t,w.LIMITS.GRAYSCALE_MIN,w.LIMITS.GRAYSCALE_MAX);this._cancelPreview();this._addHistory(new d({type:"grayscale",value:t,unit:"%"}),e)};w.prototype.saturate=function(t,e){this._throwIfNotLoaded("saturate");this._constraintValue(t,w.LIMITS.SATURATE_MIN,w.LIMITS.SATURATE_MAX);this._cancelPreview();this._addHistory(new d({type:"saturate",value:t,unit:"%"}),e)};w.prototype.invert=function(t,e){this._throwIfNotLoaded("invert");this._constraintValue(t,w.LIMITS.INVERT_MIN,w.LIMITS.INVERT_MAX);this._cancelPreview();this._addHistory(new d({type:"invert",value:t,unit:"%"}),e)};w.prototype.brightness=function(t,e){this._throwIfNotLoaded("brightness");this._constraintValue(t,w.LIMITS.BRIGHTNESS_MIN,w.LIMITS.BRIGHTNESS_MAX);this._cancelPreview();this._addHistory(new d({type:"brightness",value:t,unit:"%"}),e)};w.prototype.contrast=function(t,e){this._throwIfNotLoaded("contrast");this._constraintValue(t,w.LIMITS.CONTRAST_MIN,w.LIMITS.CONTRAST_MAX);this._cancelPreview();this._addHistory(new d({type:"contrast",value:t,unit:"%"}),e)};w.prototype.applyPreview=function(){this._throwIfNotLoaded("applyPreview");this._applyPreview()};w.prototype.cancelPreview=function(){this._throwIfNotLoaded("cancelPreview");this._cancelPreview()};w.prototype.undo=function(){this._throwIfNotLoaded("undo");this._jumpToHistory(this._iHistoryIndex+1)};w.prototype.redo=function(){this._throwIfNotLoaded("redo");this._jumpToHistory(this._iHistoryIndex-1)};w.prototype.jumpToHistory=function(t){this._throwIfNotLoaded("jumpToHistory");this._jumpToHistory(t)};w.prototype.getHistory=function(){return this._aHistory};w.prototype.getHistoryIndex=function(){return this._iHistoryIndex};w.prototype.getImagePngDataURL=function(){this._throwIfNotLoaded("getImagePngDataURL");return this._getFinalisedCanvas().toDataURL("image/png")};w.prototype.getImageJpegDataURL=function(t){this._throwIfNotLoaded("getImageJpegDataURL");return this._getFinalisedCanvas().toDataURL("image/jpeg",t)};w.prototype.getImageDataURL=function(t,e){this._throwIfNotLoaded("getImageDataURL");t=this._convertImageFormatEnumToMime(t)||this._getFileFormat();return this._getFinalisedCanvas().toDataURL(t,e)};w.prototype.getImageAsBlob=function(t,e){this._throwIfNotLoaded("getImageAsBlob");var i=this,o;t=this._convertImageFormatEnumToMime(t)||this._getFileFormat();if(this._aHistory.length===0){o=this._getOriginalBlob()}else{o=new Promise(function(o,s){var r=i._getFinalisedCanvas();if(r.toBlob){r.toBlob(function(t){o(t)},t,e)}else{i._createBlob(r,t,e).then(function(t){o(t)})}})}return o};w.prototype.openSaveDialog=function(t,e,i){this._throwIfNotLoaded("openSaveDialog");var o,s;t=t||this._getFileName();e=this._convertImageFormatEnumToMime(e)||this._getFileFormat();s=e.split("/")[1];if(this._aHistory.length===0){this._getOriginalBlob().then(function(i){c.save(i,t,s,e)})}else{o=this._getFinalisedCanvas();if(o.toBlob){o.toBlob(function(i){c.save(i,t,s,e)},e,i)}else{this._createBlob(o,e,i).then(function(i){c.save(i,t,s,e)})}}};w.prototype.getFileName=function(){return this._getFullFileName()};w.prototype._throwIfNotLoaded=function(t){if(!this.getLoaded()){throw Error("Cannot call "+t+" before image is set and loaded")}};w.prototype._throwIfNotReady=function(t){if(!this._isReady()){throw Error("Cannot call "+t+" before image is set and loaded and control is rendered")}};w.prototype._throwIfCustomShapeNotLoaded=function(t){if(!this.getCustomShapeLoaded()){throw Error("Cannot call "+t+" before custom shape is set and loaded")}};w.prototype._onAfterIsReady=function(){var t=this;this.$().removeClass("sapSuiteUiCommonsImageEditorEmpty");t._refreshContainerSize();this._$Container.css({width:this._oCanvas.width*this._getScale()+"px",height:this._oCanvas.height*this._getScale()+"px"});if(!this.getCropArea()){this.setCropAreaByRatio(this.getWidth(),this.getHeight())}else{this._setCropArea(this._oCropArea.x,this._oCropArea.y,this._oCropArea.width,this._oCropArea.height)}this.getDomRef().onmousewheel=this._onMouseWheel.bind(this);this.getDomRef().onmousedown=this._onMouseDown.bind(this)};w.prototype._isReady=function(){return!!this._$Container&&this.getLoaded()};w.prototype._createBlob=function(t,e,i){var o=this;return new Promise(function(s,r){var a=t.toDataURL(e,i).split(",")[1];setTimeout(function(){s(o._convertDataUriToBlob(a,e))})})};w.prototype._convertDataUriToBlob=function(t,e){var i=atob(t),o=i.length,s=new Uint8Array(o);for(var r=0;r<o;r++){s[r]=i.charCodeAt(r)}return new Blob([s],{type:e})};w.prototype._fetchUrlAsBlob=function(t){var e,i,o,s;if(window.fetch){e=fetch(t).then(function(t){return t.blob()}).then(function(t){return t})}else{if(t.startsWith("data:image")){i=t.split(",");o=i[1];s=i[0].split(";")[0].split(":")[1];e=Promise.resolve(this._convertDataUriToBlob(o,s))}else{e=new Promise(function(e,i){var o=new XMLHttpRequest;o.open("GET",t);o.responseType="blob";o.onreadystatechange=function(){if(this.readyState===XMLHttpRequest.DONE){if(this.status===200){e(o.response)}else{i()}}};o.send()})}}return e};w.prototype._getOriginalBlob=function(){var t;if(this._oOriginalBlob instanceof Promise){t=this._oOriginalBlob}else{t=Promise.resolve(this._oOriginalBlob)}return t};w.prototype._getFileNameFromUrl=function(t){return t.split("#")[0].split("?")[0].split("/").pop()};w.prototype._getFileName=function(){var t=this._sOriginalFileName||"image",e;e=t.lastIndexOf(".");if(e>0){t=t.slice(0,e)}return t};w.prototype._getFullFileName=function(){return this._sOriginalFileName};w.prototype._convertImageFormatEnumToMime=function(t){switch(t){case y.Png:t="image/png";break;case y.Jpeg:t="image/jpeg";break;default:break}return t};w.prototype._getFileFormat=function(){return this._sOriginalFileType};w.prototype._updateTransformation=function(){this._oCanvas.style.transform="scale("+this._getScale()+")"};w.prototype._refreshContainerSize=function(){if(!this._$Container||!this._$Container[0]||!this._isReady()){return}this._$Container.css({width:this._oCanvas.width*this._getScale()+"px",height:this._oCanvas.height*this._getScale()+"px"});this._refreshOverlayMask()};w.prototype._refreshOverlayMask=function(){var t=this.$().find(".sapSuiteUiCommonsImageEditorCropOverlayContainer")[0];if(!t||!this._$Container){return}this._$Container[0].removeChild(t);this._$Container[0].insertBefore(t,this._oCanvas.nextSibling)};w.prototype._refreshCropContainerSize=function(){var t=this.getCropArea(),e,i;if(t){e=this._transposeImageCoordsPxToPercent(t.x,t.y,t.width,t.height);i=this.$().find(".sapSuiteUiCommonsImageEditorCropInnerRectangle");i.css({left:e.x+"%",top:e.y+"%"});i.width(e.width+"%");i.height(e.height+"%")}};w.prototype._refreshCropContainerLook=function(){function t(t){return t/parseFloat(getComputedStyle(document.documentElement).fontSize)}var e=this.$().find(".sapSuiteUiCommonsImageEditorCropInnerRectangle"),i=t(e.width()),o=t(e.height()),s=Math.min(i,o);e.removeClass("sapSuiteUiCommonsImageEditorCropInnerRectangleSmall sapSuiteUiCommonsImageEditorCropInnerRectangleVerySmall sapSuiteUiCommonsImageEditorCropInnerRectangleExtraSmall");if(s<1.25){e.addClass("sapSuiteUiCommonsImageEditorCropInnerRectangleExtraSmall")}else if(s<2){e.addClass("sapSuiteUiCommonsImageEditorCropInnerRectangleVerySmall")}else if(s<3){e.addClass("sapSuiteUiCommonsImageEditorCropInnerRectangleSmall")}};w.prototype._initCanvas=function(){this._oCanvas.id=this.getId()+"-image";this._oCanvas.classList.add("sapSuiteUiCommonsImageEditorCanvas");this._oContext=this._oCanvas.getContext("2d")};w.prototype._initContainer=function(){var t=this,e=this.$().find(".sapSuiteUiCommonsImageEditorTransformHandlers .sapSuiteUiCommonsImageEditorHandlerContainer");this._$Container.resizable({containment:"parent",aspectRatio:this.getKeepResizeAspectRatio(),start:function(e,i){t.$("image").addClass("sapSuiteUiCommonsImageEditorCanvasResize");t.$("image").css("transform","");jQuery(this).css({top:i.position.top+"px",left:i.position.left+"px",width:i.size.width+"px",height:i.size.height+"px"})},stop:function(e,i){var o=i.size.width*t._oCanvas.width/i.originalSize.width,s=i.size.height*t._oCanvas.height/i.originalSize.height,r=t._oCanvas.width,a=t._oCanvas.height;t.$("image").removeClass("sapSuiteUiCommonsImageEditorCanvasResize");t._$Container.css({top:"",left:""});t.setSize(o,s,true);t._refreshContainerSize();t._updateTransformation();t.fireSizeChanged({width:t.getPreviewWidth(),height:t.getPreviewHeight(),originalWidth:r,originalHeight:a})},handles:{nw:e.filter(".ui-resizable-nw"),ne:e.filter(".ui-resizable-ne"),sw:e.filter(".ui-resizable-sw"),se:e.filter(".ui-resizable-se"),n:e.filter(".ui-resizable-n"),s:e.filter(".ui-resizable-s"),w:e.filter(".ui-resizable-w"),e:e.filter(".ui-resizable-e")}});C._setupMobileDraggable(this._$Container)};w.prototype._initCropArea=function(){var t=this,e=this.$().find(".sapSuiteUiCommonsImageEditorCropInnerRectangle"),i=this.$().find(".sapSuiteUiCommonsImageEditorCropInnerRectangle .sapSuiteUiCommonsImageEditorHandlerContainer"),o=this.$().find(".sapSuiteUiCommonsImageEditorDragHandlerContainer")[0];function s(e,i){var o=getComputedStyle(i.helper[0]);t._setOverlayMaskSize(i.position.left,i.position.top,i.size?i.size.width:parseFloat(o.width),i.size?i.size.height:parseFloat(o.height),"px");t._refreshCropContainerLook()}function r(e,i){var o=jQuery(this),s=this.getBoundingClientRect(),r=o.position(),a=t._transposeViewportCoordsToImageCoords(r.left,r.top,s.width,s.height),n=t.getCropArea(),h;h=t._limitCropArea(a.x,a.y,a.width,a.height);t._setCropArea(h.x,h.y,h.width,h.height);h=t.getCropArea();t.fireCropAreaChanged({cropArea:h,originalCropArea:n})}e.resizable({aspectRatio:this.getKeepCropAspectRatio(),containment:"parent",minWidth:w.LIMITS.CROP_AREA_MIN,minHeight:w.LIMITS.CROP_AREA_MIN,resize:s,stop:r,handles:{nw:i.filter(".ui-resizable-nw"),ne:i.filter(".ui-resizable-ne"),sw:i.filter(".ui-resizable-sw"),se:i.filter(".ui-resizable-se"),n:i.filter(".ui-resizable-n"),s:i.filter(".ui-resizable-s"),w:i.filter(".ui-resizable-w"),e:i.filter(".ui-resizable-e")}});o.onmousewheel=this._onMouseWheel.bind(this);e.draggable({containment:"parent",handle:o,drag:s,stop:r});C._setupMobileDraggable(e);e.css("position","absolute")};w.prototype._getLastImg=function(){return this._oSavedImg};w.prototype._storeCurrentImg=function(){this._oSavedImg.width=this._oCanvas.width;this._oSavedImg.height=this._oCanvas.height;this._oSavedImg.getContext("2d").drawImage(this._oCanvas,0,0)};w.prototype._addHistory=function(t,e){if(e){this._oPreview=t}else{this._addNewHistory(t);this._oPreview=null}this._updateFilters()};w.prototype._applyPreview=function(){if(!this._oPreview){return}this._addNewHistory(this._oPreview);this._oPreview=null};w.prototype._addNewHistory=function(t){this._aHistory=this._aHistory.slice(this._iHistoryIndex);this._iHistoryIndex=0;if(this._aHistory.length===0||!this._aHistory[0].compare(t)){this._aHistory.unshift(t);this._storeCurrentImg();this._fireHistoryChanged()}};w.prototype._cancelPreview=function(){if(!this._oPreview){return}this._oPreview=null;this._updateFilters();this._drawImage(this._getLastImg())};w.prototype._jumpToHistory=function(t){var e=this._iHistoryIndex,i,o;this._iHistoryIndex=Math.min(this._aHistory.length,Math.max(0,t));if(e===this._iHistoryIndex){return}if(e<this._iHistoryIndex){this._drawImage(this._oOrigImg);this._storeCurrentImg();this._applyExifOrientation();o=this._aHistory.length-1}else{o=e-1}for(o;o>=this._iHistoryIndex;o--){i=this._aHistory[o];switch(i.getMetadata().getName()){case"sap.suite.ui.commons.imageeditor.RotateHistoryItem":{this._setRotation(i.getDegrees());break}case"sap.suite.ui.commons.imageeditor.ResizeHistoryItem":{this._setCanvasSize(i.getWidth(),i.getHeight());break}case"sap.suite.ui.commons.imageeditor.FlipHistoryItem":{this._flip(i.getVertical(),i.getHorizontal());break}case"sap.suite.ui.commons.imageeditor.FilterHistoryItem":{if(this._needsManualFilter()){this._applyFilterItem(i)}break}case"sap.suite.ui.commons.imageeditor.CropRectangleHistoryItem":{this._rectangleCrop(i.getX(),i.getY(),i.getWidth(),i.getHeight());break}case"sap.suite.ui.commons.imageeditor.CropEllipseHistoryItem":{this._ellipseCrop(i.getX(),i.getY(),i.getRx(),i.getRy());break}case"sap.suite.ui.commons.imageeditor.CropCustomShapeHistoryItem":{this._customShapeCrop(i.getX(),i.getY(),i.getWidth(),i.getHeight());break}default:{break}}this._storeCurrentImg()}this._updateFilters();this._fireHistoryChanged()};w.prototype._fireHistoryChanged=function(){this.fireHistoryChanged({history:this._aHistory.slice(),index:this._iHistoryIndex})};w.prototype._onMouseDown=function(t){if(t.button!==0||t.target!==this.getDomRef()&&t.target!==this._oCanvas){return}var e=this,i=t.clientX,o=t.clientY;t.preventDefault();function s(t){var s=t.clientX,r=t.clientY,a=s-i,n=r-o,h=e.getDomRef();h.scrollLeft-=a;h.scrollTop-=n;i=s;o=r}function r(){document.removeEventListener("mousemove",s);document.removeEventListener("mouseup",r)}document.addEventListener("mousemove",s);document.addEventListener("mouseup",r)};w.prototype._onMouseWheel=function(t){if(!t.ctrlKey){return}t.preventDefault();var e=t.wheelDeltaY>0?this._zoomIn.bind(this):this._zoomOut.bind(this);e({x:(t.clientX-this._$Container[0].getBoundingClientRect().x)/this.getZoomLevel()*100,y:(t.clientY-this._$Container[0].getBoundingClientRect().y)/this.getZoomLevel()*100});this.fireZoomChanged({zoom:this._fZoom})};w.prototype._limitCropArea=function(t,e,i,o,s){var r=this._getMaxCropAreaWidth(s),a=this._getMinCropAreaWidth(s),n=this._getMaxCropAreaHeight(s),h=this._getMinCropAreaHeight(s);t=t&&t<0?0:t;e=e&&e<0?0:e;i=this._constraintValue(i,a,r);o=this._constraintValue(o,h,n);if(t+i>this.getWidth()){t-=t+i-this.getWidth()}if(e+o>this.getHeight()){e-=e+o-this.getHeight()}return{x:t,y:e,width:i,height:o}};w.prototype._limitCurrentCropArea=function(){var t=this.getCropArea();if(t){this.setCropArea(t.x,t.y,t.width,t.height)}};w.prototype._getMaxCropAreaWidth=function(t){var e,i=this.getCropArea();if(t&&this.getKeepCropAspectRatio()&&i&&this.getWidth()/this.getHeight()>i.width/i.height){e=i.width*this._getMaxCropAreaHeight()/i.height}else{e=this.getWidth()}return Math.round(e)};w.prototype._getMinCropAreaWidth=function(t){var e,i=this.getCropArea();if(t&&this.getKeepCropAspectRatio()&&i&&i.width>i.height){i=this.getCropArea();e=i.width*this._getMinCropAreaHeight()/i.height}else{e=w.LIMITS.CROP_AREA_MIN}return Math.round(e)};w.prototype._getMaxCropAreaHeight=function(t){var e,i=this.getCropArea();if(t&&this.getKeepCropAspectRatio()&&i&&this.getWidth()/this.getHeight()<i.width/i.height){i=this.getCropArea();e=i.height*this._getMaxCropAreaWidth()/i.width}else{e=this.getHeight()}return Math.round(e)};w.prototype._getMinCropAreaHeight=function(t){var e,i=this.getCropArea();if(t&&this.getKeepCropAspectRatio()&&i&&i.width<i.height){i=this.getCropArea();e=i.height*this._getMinCropAreaWidth()/i.width}else{e=w.LIMITS.CROP_AREA_MIN}return Math.round(e)};w.prototype._scaleCropArea=function(t,e){var i=this.getCropArea();if(i&&typeof i.x==="number"&&typeof i.width==="number"){i.newWidth=i.width*(t/e);i.newHeight=i.height*(t/e);i.x+=(i.width-i.newWidth)/2;i.y+=(i.height-i.newHeight)/2;i=this._limitCropArea(i.x,i.y,i.newWidth,i.newHeight,true);this._setCropArea(i.x,i.y,i.width,i.height)}};w.prototype._setCropArea=function(t,e,i,o){this._oCropArea={x:t,y:e,width:i,height:o};if(!this._isReady()){return}var s;if(typeof this._oCropArea.x!=="number"){this._oCropArea.x=(this.getWidth()-i)/2;this._oCropArea.y=(this.getHeight()-o)/2}s=this._transposeImageCoordsPxToPercent(this._oCropArea.x,this._oCropArea.y,this._oCropArea.width,this._oCropArea.height);this._refreshCropContainerSize();this._setOverlayMaskSize(s.x,s.y,s.width,s.height,"%");this._refreshOverlayMask();this._refreshCropContainerLook();this._updateCropAreaHandlerColors()};w.prototype._setOverlayMaskSize=function(t,e,i,o,s){var r;r=this.$("overlayMaskRect");r.attr({x:t+s,y:e+s,width:i+s,height:o+s});r=this.$("overlayMaskEllipse");r.attr({cx:t+i/2+s,cy:e+o/2+s,rx:i/2+s,ry:o/2+s});r=this.$("overlayMaskCustomBlack");r.attr({x:t+s,y:e+s,width:i+s,height:o+s});r=this.$("overlayMaskCustomWhite");r.attr({x:t+s,y:e+s,width:i+s,height:o+s})};w.prototype._constraintValue=function(t,e,i){if(isNaN(t)||t<e){t=e}else if(t>i){t=i}return Math.round(t)};w.prototype._setZoom=function(t,e){var i=this._fZoom,o=this.getDomRef(),s,r,a,n,h,p,l,g;this._fZoom=parseFloat(t.toFixed(2));if(this._fZoom<=0){this._fZoom=1}e=e||{};if(o){a=o.clientWidth;n=o.clientHeight;h=o.scrollLeft;p=o.scrollTop}this._updateTransformation();this._refreshContainerSize();if(o){s=o.getBoundingClientRect();r=this._$Container[0].getBoundingClientRect();e.x=e.x||(o.clientWidth/2+s.x-(r.x-(a-o.clientWidth)/2))/i*100;e.y=e.y||(o.clientHeight/2+s.y-(r.y-(n-o.clientHeight)/2))/i*100}if(e.x&&e.y){l=o.scrollLeft+(e.x/100*this.getZoomLevel()-o.scrollLeft)-(e.x/100*i-h);g=o.scrollTop+(e.y/100*this.getZoomLevel()-o.scrollTop)-(e.y/100*i-p)}if(o&&e.x){o.scrollLeft=l}if(o&&e.y){o.scrollTop=g}if(this.getScaleCropArea()){this._scaleCropArea(i,this._fZoom)}this._refreshCropContainerLook()};w.prototype._getScale=function(){return this._fZoom/100};w.prototype._zoomIn=function(t){var e=w.ZOOM_MILESTONES.indexOf(this._fZoom),i=this._fZoom,o;if(e>=0&&e<w.ZOOM_MILESTONES.length-1){i=w.ZOOM_MILESTONES[e+1]}else{for(o=0;o<w.ZOOM_MILESTONES.length;o++){if(w.ZOOM_MILESTONES[o]>i){i=w.ZOOM_MILESTONES[o];break}}}this._setZoom(i,t)};w.prototype._zoomOut=function(t){var e=w.ZOOM_MILESTONES.indexOf(this._fZoom),i=this._fZoom,o;if(e>0){i=w.ZOOM_MILESTONES[e-1]}else{for(o=w.ZOOM_MILESTONES.length-1;o>=0;o--){if(w.ZOOM_MILESTONES[o]<i){i=w.ZOOM_MILESTONES[o];break}}}this._setZoom(i,t)};w.prototype._zoomToFit=function(){this._$Container.css({width:"",height:"",margin:"0px"});this._oCanvas.style.maxWidth="100%";this._oCanvas.style.maxHeight="100%";this._oCanvas.style.transform="";var t=this._oCanvas.getBoundingClientRect().width*100/this._oCanvas.width;this._oCanvas.style.maxWidth="";this._oCanvas.style.maxHeight="";this._$Container.css({margin:"auto"});this.zoom(t)};w.prototype._setCanvasSize=function(t,e){var i=this._getLastImg();this._oCanvas.width=t;this._oCanvas.height=e;this._oContext.drawImage(i,0,0,i.width,i.height,0,0,t,e);this._refreshContainerSize()};w.prototype._setRotation=function(t){var e=this._getLastImg(),i,o,s;i=this._degToRad(t);this._oCanvas.width=Math.abs(e.width*Math.cos(i))+Math.abs(e.height*Math.sin(i));this._oCanvas.height=Math.abs(e.width*Math.sin(i))+Math.abs(e.height*Math.cos(i));o=this._limitCanvasSize(this._oCanvas.width,this._oCanvas.height);s=o.width/this._oCanvas.width;this._oCanvas.width=o.width;this._oCanvas.height=o.height;this._oContext.save();this._oContext.translate(this._oCanvas.width/2,this._oCanvas.height/2);this._oContext.rotate(i);this._oContext.translate(-this._oCanvas.width/2,-this._oCanvas.height/2);this._oContext.drawImage(e,0,0,e.width,e.height,Math.round((this._oCanvas.width-e.width*s)/2),Math.round((this._oCanvas.height-e.height*s)/2),e.width*s,e.height*s);this._oContext.restore();this._refreshContainerSize()};w.prototype._flipVertical=function(){this._flip(true,false)};w.prototype._flipHorizontal=function(){this._flip(false,true)};w.prototype._flip=function(t,e){var i=this._getLastImg(),o=document.createElement("canvas"),s=o.getContext("2d");o.width=i.width;o.height=i.height;s.translate(e?i.width:0,t?i.height:0);s.scale(e?-1:1,t?-1:1);s.drawImage(i,0,0);this._oContext.clearRect(0,0,this._oCanvas.width,this._oCanvas.height);this._oContext.drawImage(o,0,0)};w.prototype._transposeViewportCoordsToImageCoords=function(t,e,i,o){if(!this._isReady()){return{x:0,y:0,width:0,height:0}}var s=this._oCanvas.getBoundingClientRect(),r=this._oCanvas.width/s.width,a=this._oCanvas.height/s.height;return{x:t*r,y:e*a,width:i*r,height:o*a}};w.prototype._transposeImageCoordsToViewportCoords=function(t,e,i,o){if(!this._isReady()){return{x:0,y:0,width:0,height:0}}var s=this._oCanvas.getBoundingClientRect(),r=this._oCanvas.width/s.width,a=this._oCanvas.height/s.height;return{x:t/r,y:e/a,width:i/r,height:o/a}};w.prototype._transposeImageCoordsPxToPercent=function(t,e,i,o){return{x:t*100/this._oCanvas.width,y:e*100/this._oCanvas.height,width:i*100/this._oCanvas.width,height:o*100/this._oCanvas.height}};w.prototype._transposePercentToImageCoordsPx=function(t,e,i,o){return{x:t*this._oCanvas.width/100,y:e*this._oCanvas.height/100,width:i*this._oCanvas.width/100,height:o*this._oCanvas.height/100}};w.prototype._transposeViewPortPxToPercent=function(t,e,i,o){var s=this._$Container[0].getBoundingClientRect();return{x:t*100/s.width,y:e*100/s.height,width:i*100/s.width,height:o*100/s.height}};w.prototype._updateCropAreaHandlerColors=function(){var t;if(!this.$().find(".sapSuiteUiCommonsImageEditorCropInnerRectangle").is(":visible")){return}var e=this;this.$().find(".sapSuiteUiCommonsImageEditorCropInnerRectangle .sapSuiteUiCommonsImageEditorHandlerContainer").each(function(){var i=jQuery(this);if(!i.is(":visible")||i.width()===0||i.height()===0){return}t=e._getContrastColorForElement(this);for(var o=0;o<this.childElementCount;o++){this.children[o].style.background=t}})};w.prototype._getContrastColorForElement=function(t){var e=this._oCanvas.getBoundingClientRect(),i=t.getBoundingClientRect(),o=this._transposeViewportCoordsToImageCoords(i.left-e.left,i.top-e.top,i.width,i.height),s=this._getContrastColorForRectangleArea(o.x,o.y,o.width,o.height);return s};w.prototype._getContrastColorForRectangleArea=function(t,e,i,o){var s=this._getRectangleAreaAvg(t,e,i,o);return s>.5*.5?"white":"black"};w.prototype._getRectangleAreaAvg=function(t,e,i,o){if(i===0||o===0){return 0}var s=this._oContext.getImageData(t,e,Math.ceil(i),Math.ceil(o)).data,r=0,a,n,h,p;for(var l=0;l<s.length;l+=4){a=1-s[l]/255;n=1-s[l+1]/255;h=1-s[l+2]/255;p=s[l+3]/255;r+=(.2126*a*a+.7152*n*n+.0722*h*h)*p}return r/(s.length/4)};w.prototype._updateResizableCropAspectRatio=function(){var t=this.$().find(".sapSuiteUiCommonsImageEditorCropInnerRectangle"),e=this.getKeepCropAspectRatio();this._updateResizableAspectRatio(t,e)};w.prototype._updateResizableResizeAspectRatio=function(){var t=this.getKeepResizeAspectRatio();this._updateResizableAspectRatio(this._$Container,t)};w.prototype._updateResizableAspectRatio=function(t,e){if(t&&t.data("uiResizable")){t.resizable("option","aspectRatio",e).data("uiResizable")._aspectRatio=e}};w.prototype._applyRectangleCrop=function(t){var e=this.$().find(".sapSuiteUiCommonsImageEditorCropInnerRectangle")[0].getBoundingClientRect(),i=this._oCanvas.getBoundingClientRect(),o=this._transposeViewportCoordsToImageCoords(e.left-i.left,e.top-i.top,e.width,e.height);this.rectangleCrop(o.x,o.y,o.width,o.height,t)};w.prototype._rectangleCrop=function(t,e,i,o){var s=document.createElement("canvas");s.width=Math.round(i);s.height=Math.round(o);s.getContext("2d").drawImage(this._oCanvas,t,e,i,o,0,0,i,o);this._drawImage(s);this._refreshCropContainerSize()};w.prototype._applyEllipseCrop=function(t){var e,i,o;e=this.$().find(".sapSuiteUiCommonsImageEditorCropInnerRectangle")[0].getBoundingClientRect();i=this._oCanvas.getBoundingClientRect();o=this._transposeViewportCoordsToImageCoords(e.left-i.left,e.top-i.top,e.width,e.height);this.ellipseCrop(o.width/2+o.x,o.height/2+o.y,o.width/2,o.height/2,t)};w.prototype._ellipseCrop=function(t,e,i,o){var s=document.createElement("canvas"),r=i*2,a=o*2,n=s.getContext("2d");s.width=Math.round(r);s.height=Math.round(a);if(!n.ellipse){n.save();n.translate(i,o);n.scale(i,o);n.arc(0,0,1,0,360);n.restore()}else{n.ellipse(i,o,i,o,0,0,2*Math.PI)}n.fill();n.globalCompositeOperation="source-in";n.drawImage(this._oCanvas,t-i,e-o,r,a,0,0,r,a);this._drawImage(s);this._refreshCropContainerSize()};w.prototype._applyCustomShapeCrop=function(t){var e,i,o;e=this.$().find(".sapSuiteUiCommonsImageEditorCropInnerRectangle")[0].getBoundingClientRect();i=this._oCanvas.getBoundingClientRect();o=this._transposeViewportCoordsToImageCoords(e.left-i.left,e.top-i.top,e.width,e.height);this.customShapeCrop(o.x,o.y,o.width,o.height,t)};w.prototype._customShapeCrop=function(t,e,i,o){var s=document.createElement("canvas"),r=s.getContext("2d");s.width=i;s.height=o;r.drawImage(this._oCustomShapeImg,0,0,i,o);r.globalCompositeOperation="source-in";r.drawImage(this._oCanvas,t,e,i,o,0,0,i,o);r.globalCompositeOperation="source-over";this._drawImage(s);this._refreshCropContainerSize()};w.prototype._getFinalisedCanvas=function(){var t=this.getWidth(),e=this.getHeight(),i,o,s;i=this._getLastImg().getContext("2d").getImageData(0,0,t,e);this._applyFilterHistory(i);o=document.createElement("canvas");s=o.getContext("2d");o.width=t;o.height=e;s.putImageData(i,0,0);return o};w.prototype._applyFilterHistory=function(t){var e;for(var i=this._aHistory.length-1;i>=this._iHistoryIndex;i--){if(this._aHistory[i].isA("sap.suite.ui.commons.imageeditor.FilterHistoryItem")){e=this._aHistory[i];m[e.getType()](t,e.getValue()/100)}}};w.prototype._applyFilterItem=function(t){var e=this._getLastImg(),i=e.getContext("2d"),o=i.getImageData(0,0,e.width,e.height);m[t.getType()](o,t.getValue()/100);this._oContext.putImageData(o,0,0)};w.prototype._updateFilters=function(){var t="",e;function i(t){return t.getType()+"("+t.getValue()+t.getUnit()+") "}if(this._needsManualFilter()){if(this._isReady()){if(this._oPreview&&this._oPreview.isA("sap.suite.ui.commons.imageeditor.FilterHistoryItem")){this._applyFilterItem(this._oPreview)}}}else{for(var o=this._aHistory.length-1;o>=this._iHistoryIndex;o--){e=this._aHistory[o];if(e.isA("sap.suite.ui.commons.imageeditor.FilterHistoryItem")){t+=i(e)}}if(this._oPreview&&this._oPreview.isA("sap.suite.ui.commons.imageeditor.FilterHistoryItem")){t+=i(this._oPreview)}this._oCanvas.style.filter=t.trim()}};w.prototype._needsManualFilter=function(){return r.browser.msie||r.os.name===r.os.OS.IOS};w.prototype._isMobileSafari=function(){return r.os.name===r.os.OS.IOS&&r.browser.name===r.browser.BROWSER.SAFARI};w.prototype._reset=function(){this.$().addClass("sapSuiteUiCommonsImageEditorEmpty");this._aHistory=[];this._iHistoryIndex=0;this._oPreview=null;this._bImageLoaded=false;this._oCropArea=null;this._oCanvas.width=0;this._oCanvas.height=0;this._oOriginalBlob=null;this._sOriginalFileName=null;this._sOriginalFileType=null;this._iExifRotation=null;this._bExifFlip=false;this._updateFilters();this._refreshContainerSize()};w.prototype._drawImage=function(t){var e=this._limitCanvasSize(t.width,t.height);this._oCanvas.width=e.width;this._oCanvas.height=e.height;this._oContext.drawImage(t,0,0,t.width,t.height,0,0,this._oCanvas.width,this._oCanvas.height);this._refreshContainerSize()};w.prototype._limitCanvasSize=function(t,e,i){var o=this._isMobileSafari()?w.LIMITS.MAX_SAFARI_MOBILE_CANVAS_SIZE:w.LIMITS.MAX_CANVAS_SIZE,s=t,r=e,n;if(t*e>o){n=Math.sqrt(o/(t*e));s=Math.floor(t*n);r=Math.floor(r*s/t);if(!i){this.fireSizeChanged({width:s,height:r,originalWidth:t,originalHeight:e});a.show(I.getText("IMGEDITOR_SCALE_WARNING",[s,r,t,e]),{duration:6e3})}}return{width:s,height:r}};w.prototype._degToRad=function(t){return t*Math.PI/180};w.prototype._RadToDeg=function(t){return t*180/Math.PI};w.prototype._getCropAreaDragIcon=function(){if(!this._cropAreaDragIcon){this._cropAreaDragIcon=new n({src:"sap-icon://move",useIconTooltip:false})}return this._cropAreaDragIcon};return w});
//# sourceMappingURL=ImageEditor.js.map