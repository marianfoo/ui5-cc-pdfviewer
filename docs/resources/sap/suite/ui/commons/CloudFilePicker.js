/*!
 * 
		SAP UI development toolkit for HTML5 (SAPUI5)
		(c) Copyright 2009-2015 SAP SE. All rights reserved
	
 */
sap.ui.define(["sap/m/Button","sap/m/Dialog","sap/m/DialogRenderer","sap/m/HBox","sap/m/Table","sap/m/ColumnListItem","sap/m/Column","sap/ui/model/odata/v4/ODataModel","sap/m/Select","sap/m/Label","sap/m/Input","sap/ui/layout/form/SimpleForm","sap/ui/core/IconPool","sap/ui/core/Icon","sap/m/Page","sap/m/Breadcrumbs","sap/m/Link","sap/m/Text","./CloudFileInfo","./library","sap/m/library","sap/ui/core/library","sap/ui/layout/FixFlex","sap/m/OverflowToolbar","sap/m/ToolbarSpacer","sap/m/Title","sap/m/ColumnPopoverSelectListItem","sap/m/ColumnHeaderPopover","sap/ui/core/CustomData","sap/ui/model/Sorter","sap/m/SearchField","sap/m/OverflowToolbarLayoutData","sap/ui/Device","sap/base/Log","sap/ui/model/odata/type/DateTimeOffset","sap/ui/core/Item","sap/ui/core/SortOrder","sap/m/IllustratedMessage","sap/m/IllustratedMessageType","sap/m/IllustratedMessageSize","sap/ui/core/format/FileSizeFormat"],function(e,t,i,n,a,r,s,o,l,d,u,c,h,g,m,p,f,F,C,S,y,I,b,v,w,T,_,x,D,E,B,L,N,P,O,k,M,A,V,R,U){"use strict";var z=y.DialogType;var K=y.ButtonType;var j=I.ValueState;var H=S.FilePickerModes;var $,W,G,q,Y,X,Z,J,Q,ee;var te=sap.ui.getCore().getLibraryResourceBundle("sap.suite.ui.commons");var ie=t.extend("sap.suite.ui.commons.CloudFilePicker",{metadata:{library:"sap.suite.ui.commons",properties:{serviceUrl:{type:"sap.ui.core.URI",group:"Data",defaultValue:""},sharedModel:{type:"object",group:"Misc",defaultValue:null},confirmButtonText:{type:"string",group:"Data",defaultValue:te.getText("CFP_BUTTON_SELECT")},filePickerMode:{type:"sap.suite.ui.commons.FilePickerModes",group:"Data",defaultValue:"All"},title:{type:"string",group:"Data",defaultValue:te.getText("CFP_TITLE")},enableDuplicateCheck:{type:"boolean",group:"Data",defaultValue:false},duplicateMessage:{type:"string",group:"Data"},suggestedFileName:{type:"string",group:"Data"},fileNameMandatory:{type:"boolean",group:"Data",defaultValue:false}},events:{select:{parameters:{replaceExistingFile:"boolean",selectedFileName:"string",selectedFiles:{type:"sap.suite.ui.commons.CloudFileInfo[]"},selectedFolder:{type:"sap.suite.ui.commons.CloudFileInfo"}}},cancel:{}}},constructor:function(){t.prototype.constructor.apply(this,arguments);this.setResizable(true);this.setDraggable(true);this._createDialogContent();this._createButton();if(N.system.phone){this.setStretch(true)}else{this.setStretch(false);this.setContentWidth("780px");this.setContentHeight("48.75rem")}this.setHorizontalScrolling(false);this.setVerticalScrolling(false);this.setTitle(this.getTitle());this.setBusyIndicatorDelay(0);this.setBusy(true)},renderer:i});ie.prototype._createDialogContent=function(){var e=this.getServiceUrl(),t=this.getSharedModel();if(!e&&!t){P.error("Invalid Configuration")}if(!t&&e){t=new o({serviceUrl:e,synchronizationMode:"None",earlyRequests:true})}if(t){t.setSizeLimit(200)}this.setModel(t);var i=this._createCloudDropdownAndFileNameField();G=this._createBreadcrumbLinks();var n=this._createTableContent();var a=new b({fixContent:[i,G],flexContent:n});this.addContent(a)};ie.prototype._createCloudDropdownAndFileNameField=function(){var t=new d({text:te.getText("CFP_LOCATION"),showColon:true,labelFor:this.getId()+"-cloudSpaceSelect"}).addStyleClass(N.system.desktop?"sapUiTinyMarginTop":"");W=new l({id:this.getId()+"-cloudSpaceSelect",forceSelection:false,change:function(e){$.setBusyIndicatorDelay(0);$.setNoDataText(" ");q.setValue(this.getSuggestedFileName());G.destroyLinks();this._initializeVisibleLinks();var t=e.getParameters().selectedItem;this._loadFileShareRootFolder(t.getKey())}.bind(this)}).bindItems({path:"/FileShares",events:{dataReceived:function(t){var i=t.getParameters();if(i.error||!Object.keys(i.data).length&&!t.getSource().getCurrentContexts().length){this.setBusy(false);var n=new A({illustrationType:V.ErrorScreen,illustrationSize:R.Spot,enableVerticalResponsiveness:true,title:te.getText("CFP_NO_FILESHARE_FOUND"),description:te.getText("CFP_NO_FILESHARE_FOUND_RELOAD"),additionalContent:[new e({text:te.getText("CFP_BUTTON_RELOAD"),press:function(){W.getBinding("items").refresh()}})]});$.setNoData(n)}else{if(t.getSource()&&t.getSource().getContexts()&&t.getSource().getContexts().length){var a=t.getSource().getContexts()[0].sPath;var r=a.split(/[']/)[1];W.setSelectedKey(r);setTimeout(function(){this._initializeVisibleLinks()}.bind(this));this._loadFileShareRootFolder(W.getSelectedKey())}}}.bind(this)},template:new k({key:"{FileShare}",text:{parts:["FileShare","FileShareDescription"],formatter:function(e,t){return t?t:e}}})});var i=new c({layout:"ResponsiveGridLayout",singleContainerFullSize:false});i.addContent(t);i.addContent(W);var n=new d({text:te.getText("CFP_FILENAME"),showColon:true,labelFor:this.getId()+"-fileName"}).addStyleClass(N.system.desktop?"sapUiTinyMarginTop":"");q=new u({id:this.getId()+"-fileName",liveChange:function(e){$.removeSelections();var t=X.get(Y[Y.length-1].fileShareItemId);this._setConfirmationButtonEnabled(null,t,true)}.bind(this)});i.addContent(n);i.addContent(q);if(this.getFilePickerMode()===H.FileOnly){q.setVisible(false)}else{q.setValue(this.getSuggestedFileName())}return i};ie.prototype._createBreadcrumbLinks=function(){G=new p(this.getId()+"-breadcrumbs").addStyleClass("sapUiSmallMarginBegin sapUiSmallMarginEnd");X=new Map;this._initializeVisibleLinks();return G};ie.prototype._initializeVisibleLinks=function(){var e=W.getSelectedItem()?W.getSelectedItem().getText():"";var t={fileShareItemId:"Root",title:e};Y=[t];G.setCurrentLocationText(e);X.clear()};ie.prototype._createTableContent=function(){J=new e({text:te.getText("CFP_TITLE_NEWFOLDER"),type:K.Transparent,enabled:false,press:function(){this._createNewFolderInline()}.bind(this)});$=new a({headerToolbar:new v({content:[new T({text:te.getText("CFP_LIST_HEADER")}),new w,new B({layoutData:new L({minWidth:"200px",maxWidth:"300px",shrinkable:true,moveToOverflow:false}),visible:false}),J],design:"Transparent"}),columns:[new s({header:new F({text:te.getText("CFP_NAME")}),customData:[new D({key:"bindingProperty",value:"FileShareItemName"})],width:"auto",importance:"High"}),new s({hAlign:"Left",header:new F({text:te.getText("CFP_TYPE")}),customData:[new D({key:"bindingProperty",value:"FileShareItemContentType"})],width:"17%",importance:"High"}),new s({header:new F({text:te.getText("CFP_OWNER")}),customData:[new D({key:"bindingProperty",value:"CreatedByUser"})],width:"17%",importance:"Low",visible:N.system.phone?false:true}),new s({hAlign:"End",header:new F({text:te.getText("CFP_TITLE_LAST_CHANGED_ON")}),customData:[new D({key:"bindingProperty",value:"LastChangeDateTime"})],width:"17%",importance:"Low",visible:N.system.phone?false:true}),new s({hAlign:"End",header:new F({text:te.getText("CFP_FILESIZE")}),customData:[new D({key:"bindingProperty",value:"FileShareItemContentSize"})],width:"10%",importance:"Low",visible:N.system.phone?false:true})],autoPopinMode:true,sticky:["HeaderToolbar","ColumnHeaders"],headerDesign:"Plain",noDataText:" ",mode:"SingleSelectMaster",itemPress:function(e){$.setBusyIndicatorDelay(0);$.setNoDataText(" ");var t=e.getParameters().listItem;var i=t.getBindingContext();var n=i.getObject("FileShareItemKind")==="folder";if(n){var a=this._createSelectionParameter(t);var r=a.getFileShareItemId();a.path=i.getCanonicalPath();ee=a;X.set(r,a);var s=i.getModel().createBindingContext(a.path);Y.push({fileShareItemId:r,title:t.getCells()[0].getItems()[1].getText()});this._updateBreadcrumbLinks();$.setBindingContext(s)}else{if(Z.getEnabled()){var o=i.getProperty("FileShareItemName");q.setValue(o)}}}.bind(this),items:{path:"_Children",parameters:{$$operationMode:"Server"},sorter:[new E({path:"FileShareItemKind",descending:true}),new E({path:"FileShareItemName",descending:false})],events:{dataReceived:function(){$.setNoData(null);$.setNoDataText(te.getText("CFP_NO_DATA_FILESHARE"));this.setBusy(false)}.bind(this)},template:new r({cells:[new n({items:[new g({src:{parts:["FileShareItemKind","FileShareItemContentType","isDocumentCreationAllowed"],formatter:function(e,t,i){if(e==="folder"){if(i==="No"){return"sap-icon://locked"}else{return"sap-icon://folder-full"}}else{return h.getIconForMimeType(t)}}}}).addStyleClass("sapUiTinyMarginEnd"),new F({text:"{FileShareItemName}"})]}),new F({text:"{FileShareItemHumanContentType}"}),new F({text:"{= ${FileShareItemKind} === 'folder' ? '' : ${CreatedByUser}}"}),new F({text:{parts:["FileShareItemKind","LastChangeDateTime"],formatter:function(e,t){if(e==="folder"){return""}else{var i=new O({style:"short"});return i.formatValue(new Date(t),"string")}}}}),new F({text:{parts:["FileShareItemKind","FileShareItemContentSize"],formatter:function(e,t){if(e!=="folder"){var i=U.getInstance({binaryFilesize:false,maxFractionDigits:1,maxIntegerDigits:3}).format(t.split(",").join(""));return i}else{return""}}}})],type:"{= ${FileShareItemKind} === 'folder' ? 'Navigation' : 'Active'}"})},updateFinished:function(e){if(!$.getBusy()){if(ee&&Object.keys(ee).length!==0){this._setConfirmationButtonEnabled(ee.getProperty("isDocumentCreationAllowed"));this._enableDisableNewFolderBtn()}}}.bind(this)});$.bActiveHeaders=true;$.attachEvent("columnPress",function(e){var t=e.getParameter("column"),i=t.getCustomData()[0].getValue();if(i==="CreatedByUser"||i==="FileShareItemContentSize"){return}var n=[new _({icon:"sap-icon://sort-ascending",action:function(){this._fHandleSorting(t,true)}.bind(this)}),new _({icon:"sap-icon://sort-descending",action:function(){this._fHandleSorting(t,false)}.bind(this)})];var a=new x({items:[n]});a.openBy(t)}.bind(this));var t=new m({showHeader:false,content:[$],enableScrolling:true});return t};ie.prototype._createNewFolderInline=function(){var e=new u({placeholder:"Enter Folder Name",width:"100%",visible:true,value:te.getText("CFP_TITLE_NEWFOLDER")});e.attachBrowserEvent("focusout",function(t){if(this._checkForDuplicateInTable($,t.target.value.toLowerCase())){e.setValueState(j.Error);e.setValueStateText(te.getText("CFP_FOLDER_EXIST"))}else{e.setValueState(j.None);e.setValueStateText("");this._makeNewFolderEntry(t.target.value)}}.bind(this));Q=new r({cells:[new n({items:[e]}),new F({text:"{= ${FileShareItemKind} === 'folder' ? '' : ${FileShareItemContentType}}"}),new F({text:"{= ${FileShareItemKind} === 'folder' ? '' : ${CreatedByUser}}"}),new F({text:{parts:["FileShareItemKind","LastChangeDateTime"],formatter:function(e,t){if(e==="folder"){return""}else{if(t){var i=new O({style:"short"});return i.formatValue(new Date(t),"string")}}}}}),new F({text:"{= ${FileShareItemKind} === 'folder' ? '' : ${FileShareItemContentSize}}"})]});this._setConfirmationButtonEnabled(false);J.setEnabled(false);$.insertItem(Q);setTimeout(function(){e.focus()})};ie.prototype._checkForDuplicateInTable=function(e,t){var i=e.getItems().find(function(e,i){if(i>0&&e.getCells()[0].getItems()[1].getText().toLowerCase()===t){return true}return false});return!!i};ie.prototype._enableDisableNewFolderBtn=function(){if(X.size&&ee.getProperty("isDocumentCreationAllowed")){J.setEnabled(true)}else{J.setEnabled(false)}};ie.prototype._makeNewFolderEntry=function(e){this.setBusy(true);var t=$.getBinding("items"),i,n=new Promise(function(e){i=e});$.removeItem(Q);Q.destroy();var a=t.create({FileShareItemName:e,FileShareItemKind:"folder"},true,false,false);var r=function(e){var n=e.getParameter("context"),s=e.getParameter("success");if(n===a){t.detachCreateCompleted(r,this);i(s)}};t.attachCreateCompleted(r,this);var s=function(){a.created().then(undefined,function(e){P.trace("transient creation context deleted")}).catch(function(e){P.trace("transient creation context deletion error",e)})};n.then(function(e){if(!e){s();t.resetChanges();this.setBusy(false)}else{a.created();$.setSelectedItem($.getItems().length>0?$.getItems()[0]:null);this.setBusy(false)}}.bind(this))};ie.prototype._warningMessageDialog=function(i){var n=new t({type:z.Message,title:te.getText("CFP_TITLE_WARNING"),state:j.Warning,content:new F({text:i}),beginButton:new e({type:K.Emphasized,text:te.getText("CFP_BUTTON_OK"),press:function(){n.close()}})});n.open()};ie.prototype._fHandleSorting=function(e,t){var i=t?M.Ascending:M.Descending;if(i===e.getSortIndicator()){i=M.None}$.getColumns().forEach(function(e){e.setSortIndicator("None")});e.setSortIndicator(i);var n=e.data("bindingProperty");var a=$.getBinding("items");a.sort([new E("FileShareItemKind",true),new E(n,!t)])};ie.prototype._resetAndApplyDefaultSorting=function(){$.getColumns().forEach(function(e){e.setSortIndicator("None")});var e=$.getBinding("items");e.sort([new E("FileShareItemKind",true),new E("FileShareItemName",false)])};ie.prototype._updateBreadcrumbLinks=function(){if(Y&&Y.length>1){var e=Y.slice().reverse();var t=[];e.forEach(function(e,i,n){if(i==0){G.setCurrentLocationText(e.title)}else{var a=new f({text:e.title,press:function(e){if(Q&&$.indexOfItem(Q)>-1){$.removeItem(Q);Q.destroy()}var t=G.indexOfLink(e.getSource());var i=Y.splice(t+1);var n,a;this._updateBreadcrumbLinks();if(Y.length>1){n=X.get(Y[Y.length-1].fileShareItemId);ee=n;for(var r in i){X.delete(i[r].fileShareItemId)}this._setConfirmationButtonEnabled(null,n);a=this.getModel().createBindingContext(n.path);$.setBindingContext(a)}else{n=X.get(Y[Y.length-1].fileShareItemId);ee=n;this._setConfirmationButtonEnabled(null,n);this._loadFileShareRootFolder(W.getSelectedKey())}}.bind(this)});t.push(a)}}.bind(this));t.reverse();if(G.getLinks()){G.removeAllLinks()}for(var i=0;i<t.length;i++){G.addLink(t[i])}}else{G.destroyLinks();this._initializeVisibleLinks();this._enableDisableNewFolderBtn()}this._setConfirmationButtonEnabled(false)};ie.prototype._loadFileShareRootFolder=function(e){X.clear();var t="/FileShares("+"'"+e+"'"+")/_Root";var i=this.getModel().bindContext(t);i.requestObject().then(function(e){var t=this._createSelectionParameter(e,i.getBoundContext(e));this._setConfirmationButtonEnabled(null,t)}.bind(this));var n=this.getModel().createBindingContext(t);$.setBindingContext(n)};ie.prototype._createButton=function(){Z=new e({text:this.getConfirmButtonText(),type:K.Emphasized,enabled:false,press:function(){var e=q.getValue();if(this.getFilePickerMode()===H.FileOnly||e){if(this.getEnableDuplicateCheck()&&this._checkForDuplicate($,e.toLowerCase())){this._showOverwriteMessage(e)}else{this._closeDialog()}}else{this._closeDialog()}}.bind(this)});this.addButton(Z);this.addButton(new e({text:te.getText("CFP_BUTTON_CANCEL"),press:function(){this.fireCancel();this.close();setTimeout(function(){this.destroy()}.bind(this))}.bind(this)}));this._setConfirmationButtonEnabled(false)};ie.prototype._setConfirmationButtonEnabled=function(e,t,i){var n=false;if(q&&q.getValue()){n=q.getValue()!==""}if(this.getFilePickerMode()===H.FileOnly){Z.setEnabled(e)}else if(t&&t.getIsDocumentCreationAllowed()){if(this.getFileNameMandatory()){n||e?Z.setEnabled(true):Z.setEnabled(false)}else{Z.setEnabled(true)}}else if(i){if(this.getFileNameMandatory()){Z.setEnabled(t&&t.getIsDocumentCreationAllowed()?n:false)}}else{Z.setEnabled(e?e:false)}};ie.prototype._checkForDuplicate=function(e,t){var i=e.getItems().find(function(i){if(i.getCells()[0].getItems()[1].getText().toLowerCase()===t){e.setSelectedItem(i);return true}return false});return!!i};ie.prototype._showOverwriteMessage=function(i){var n=this.getDuplicateMessage();if(!n){n=te.getText("CFP_MESSAGE_DUPLICATE",i)}var a=new t({type:z.Message,title:te.getText("CFP_TITLE_WARNING"),state:j.Warning,content:new F({text:n}),beginButton:new e({type:K.Emphasized,text:te.getText("CFP_BUTTON_YES"),press:function(){a.close();this._closeDialog(true)}.bind(this)}),endButton:new e({text:te.getText("CFP_BUTTON_NO"),press:function(){a.close()}})});a.open()};ie.prototype._closeDialog=function(e){var t={};if(Y.length>1){t.selectedFolder=X.get(Y[Y.length-1].fileShareItemId)}else{t.selectedFolder=new C;t.selectedFolder.setFileShareId(W.getSelectedKey())}t.selectedFileName=q.getValue();t.replaceExistingFile=!!e;t.selectedFiles=[];var i=$.getSelectedItem();if(i){t.selectedFiles.push(this._createSelectionParameter(i))}this.fireEvent("select",t);this.close();setTimeout(function(){this.destroy()}.bind(this))};ie.prototype._createSelectionParameter=function(e,t){var i=new C;var n;if(!t){n=e.getBindingContext()}else{n=t}i.setFileShareId(n.getObject("FileShare"));i.setFileShareItemId(n.getObject("FileShareItem"));i.setParentFileShareItemId(n.getObject("ParentFileShareItem"));i.setIsFolder(n.getObject("FileShareItemKind")==="folder");i.setFileShareItemName(n.getObject("FileShareItemName"));i.setCreatedByUser(n.getObject("CreatedByUser"));i.setCreationDateTime(n.getObject("CreationDateTime"));i.setLastChangedByUser(n.getObject("LastChangedByUser"));i.setLastChangeDateTime(n.getObject("LastChangeDateTime"));i.setFileShareItemContent(n.getObject("FileShareItemContent"));i.setFileShareItemContentType(n.getObject("FileShareItemContentType"));i.setFileShareItemContentSize(n.getObject("FileShareItemContentSize"));i.setFileShareItemContentLink(n.getObject("FileShareItemContentLink"));i.setIsDocumentCreationAllowed(n.getObject("isDocumentCreationAllowed"));return i};return ie});
//# sourceMappingURL=CloudFilePicker.js.map