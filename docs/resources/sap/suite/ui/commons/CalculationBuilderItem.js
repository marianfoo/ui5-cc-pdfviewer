sap.ui.define(["sap/ui/thirdparty/jquery","./library","sap/ui/core/Control","sap/m/MessageBox","sap/base/security/encodeXML","./Utils","sap/ui/thirdparty/jqueryui/jquery-ui-core","sap/ui/thirdparty/jqueryui/jquery-ui-widget","sap/ui/thirdparty/jqueryui/jquery-ui-mouse","sap/ui/thirdparty/jqueryui/jquery-ui-draggable"],function(jQuery,t,e,i,r,n){"use strict";var a=t.CalculationBuilderItemType,s=t.CalculationBuilderOperatorType,o=t.CalculationBuilderLogicalOperatorType;var u=sap.ui.getCore().getLibraryResourceBundle("sap.suite.ui.commons");var l=e.extend("sap.suite.ui.commons.CalculationBuilderItem",{constructor:function(t,i){if(typeof t!=="string"&&t!==undefined){i=t}if(i&&i.key){i.key=this._sanitizeKey(i.key)}e.apply(this,arguments)},metadata:{library:"sap/suite/ui/commons",properties:{key:{type:"string",group:"Misc",defaultValue:null}}},renderer:{apiVersion:2,render:function(t,e){e._render(t)}}});l.prototype._innerRender=function(t,e){var i=this._bReadOnly?"sapMBtnDisabled":"",n=this._getLabel(),a={"!=":"NOT_EQUAL","-":"MINUS",",":"COMMA"};var s=function(t){t.openStart("div");t.class("sapCalculationBuilderItemFocusWrapper");t.openEnd();t.openStart("div");t.class("sapCalculationBuilderItemFocus");t.openEnd();t.close("div");t.close("div")};var o=function(t){t.openStart("div");t.class("sapCalculationBuilderItemExpandButtonWrapper");t.attr("title",u.getText("CALCULATION_BUILDER_EXPAND_BUTTON_TITLE"));t.openEnd();t.openStart("div");t.attr("id",this.getId()+"-expandbutton");t.class("sapCalculationBuilderItemExpandButton").class(i);t.attr("tabindex","-1");t.openEnd();if(!this._bReadOnly){t.openStart("div");t.class("sapCalculationBuilderItemExpandButtonFocus");t.openEnd();t.close("div")}l(t,"");t.close("div");t.close("div")}.bind(this);var l=function(t,e){t.openStart("span");t.attr("aria-hidden","true");t.attr("data-sap-ui-icon-content",e);t.class("sapCalculationBuilderEmptyItemIcon").class("sapUiIcon").class("sapUiIconMirrorInRTL").class("sapCalculationBuilderExpressionSAPFont");t.openEnd();t.close("span")};var p=function(t,e){t.attr("aria-label",u.getText(e))};t.openStart("div");t.class("sapCalculationBuilderItemContentWrapper");t.openEnd();t.openStart("div");t.attr("id",this.getId()+"-content");t.class("sapCalculationBuilderItemContent");if(this._bIsNew||this._isEmpty()){t.attr("title",u.getText("CALCULATION_BUILDER_NEW_ITEM_TITLE"))}else if(a[n]){p(t,"CALCULATION_BUILDER_"+a[n]+"_ARIA_LABEL")}t.attr("aria-haspopup","dialog");t.openEnd();s(t);if(this._isEmpty()){l(t,"");t.close("div")}else if(this._bIsNew){l(t,"");t.close("div")}else if(this._isFunction()){var c=this._getFunction();t.openStart("span");t.class("sapCalculationBuilderItemLabel").class("sapCalculationBuilderItemFunctionLabel");t.openEnd();t.unsafeHtml(r(c.title||this.getKey()));t.close("span");t.openStart("span");t.class("sapCalculationBuilderItemLabel").class("sapCalculationBuilderItemFunctionBracket");t.openEnd();t.unsafeHtml("(");t.close("span");t.close("div")}else{t.openStart("span");t.class("sapCalculationBuilderItemLabel");t.openEnd();t.unsafeHtml(r(n));t.close("span");t.close("div")}t.close("div");if(this._isVariable()&&this.isExpandable()){o(t)}if(e){t.flush(e)}};l.prototype._getClass=function(t,e,i){var r="",n=this._isEmpty();r+=this._bIsNew?"sapCalculationBuilderNewItem  sapCalculationBuilderCancelSelectable":"sapCalculationBuilderItem";if(n){r+=" sapCalculationBuilderNewItem "}if(this._isBracket()){r+=" sapCalculationBuilderItemBracket "}else if(this._isOperator()){r+=" sapCalculationBuilderItemOperator sapCalculationBuilderItemOperatorLength-"+this._getLabel().length+" ";if(this._isLogicalOperator()){r+=" sapCalculationBuilderItemLogicalOperator "}}else if(this._isCustomOperator()){r+=" sapCalculationBuilderItemOperator sapCalculationBuilderItemCustomOperator "}else if(this._isFunction()){r+=" sapCalculationBuilderItemFunction "}else if(this._isLiteral()){r+=" sapCalculationBuilderItemLiteral "}else if(this._isVariable()){r+=" sapCalculationBuilderItemVariable ";if(this.isExpandable()){r+=" sapCalculationBuilderItemVariableSeparator "}}else{r+=" sapCalculationBuilderUnknownItem "}if(t){r+=" sapCalculationBuilderItemErrorSyntax "}if(i){return r}var a=r.split(" "),s;for(s=0;s<a.length;s++){e.class(a[s])}};l.prototype._render=function(t){if(!this.getParent()){return}var e=this._hasCorrectParent(),i=this._getItemError(),r=this._getTooltip(),n=r?'"'+r+'"':"",a=this._bIsNew?"button":"",s=e?"-1":"0";t.openStart("div");this._getClass(!!i,t);t.attr("id",this.getId());t.attr("tabindex",s);t.attr("title",n);t.attr("role",a);t.openEnd();this._innerRender(t);t.close("div")};l.prototype.init=function(){this._bIsNew=false};l.prototype.onBeforeRendering=function(){this._oVariable=this.getVariable()};l.prototype.onAfterRendering=function(){this._afterRendering()};l.prototype._afterRendering=function(){var t=this.getParent();if(!t){return}this._setEvents();if(!this._bIsNew&&!this._bReadOnly){this._setupDraggable()}if(this._hasCorrectParent(t)){if(!t._bIsCalculationBuilderRendering){t._setupKeyboard();t.getParent()._enableOrDisableExpandAllButton()}}};l.prototype._setEvents=function(){if(this.isExpandable()){this.$("expandbutton").on("click",this._expandButtonPress.bind(this));this.$("expandbutton").on("mousedown",function(t){t.stopPropagation()})}if(!this._bReadOnly){this.$("content").on("click",this._buttonPress.bind(this))}if(this._isBracket()||this._isFunction()){this._setBracketHover()}};l.prototype._buttonPress=function(t){var e=this.getParent();if(this._hasCorrectParent(e)&&!e._bDragging){if(t.ctrlKey){e._selectItem(this.$())}else if(t.shiftKey){e._selectItemsTo(this.$())}else{e._deselect();e._openDialog({opener:this,currentItem:this})}}};l.prototype._expandButtonPress=function(t){if(!this._bReadOnly){this._openExpandConfirmMessageBox()}};l.prototype.isExpandable=function(){var t=this._oVariable?this._oVariable:this.getVariable();return t&&t.getItems().length>0};l.prototype.getVariable=function(){var t=this.getParent();return this._hasCorrectParent(t)&&t._getVariableByKey(this.getKey())};l.prototype.getType=function(){return this._getType()};l.prototype._setupDraggable=function(){var t=this.getParent(),e=t.$(),i=this.$();i.draggable({revert:"invalid",axis:"x",delay:100,cursor:"move",helper:function(t){var e=i.clone();e.addClass("sapCalculationBuilderDragging");e.css("pointer-events","none");return e},scope:t.getId()+"-scope",start:function(){e.find(".sapCalculationBuilderBracket").removeClass("sapCalculationBuilderBracket");e.find(".sapCalculationBuilderItemContent").css("cursor","move");jQuery(this).addClass("sapCalculationBuilderDragging");t._bDragging=true;if(!jQuery(this).hasClass("ui-selected")){t._deselect()}},stop:function(){jQuery(this).removeClass("sapCalculationBuilderDragging");e.find(".sapCalculationBuilderItemContent").css("cursor","pointer");t._bDragging=false}});n._setupMobileDraggable(i)};l.prototype._setBracketHover=function(){var t=this.$("content"),e=this._isFunction()?s["("]:this.getKey(),i=e===s[")"],r=i?s["("]:s[")"],n;t.mouseenter(function(t){var a,s,o=0,u=this._hasCorrectParent()&&this.getParent().getItems()||[],l=i?u.length:0;for(;i?l>=0:l<u.length;i?l--:l++){a=u[l];if(a===this){s=true}if(s){if(a.getKey()===r||a._isFunction()&&i){o--;if(o===0){n=a;break}}else if(a.getKey()===e||a._isFunction()&&!i){o++}}}if(n){this.$().addClass("sapCalculationBuilderBracket");n.$().addClass("sapCalculationBuilderBracket")}}.bind(this));t.on("mouseleave",function(t){this.$().removeClass("sapCalculationBuilderBracket");if(n){n.$().removeClass("sapCalculationBuilderBracket")}}.bind(this))};l.prototype._expandVariable=function(t){var e=this.getParent(),i,r;if(e){i=e.getItems().indexOf(this);r=e._getVariableByKey(this.getKey());e.insertItem(new l({key:"("}),i++);r.getItems().forEach(function(t){e.insertItem(t._cloneItem(),i++)});e.insertItem(new l({key:")"}),i++);e.removeItem(this);if(t){e._aErrors=e._validateSyntax();e._fireChange()}}};l.prototype._cloneItem=function(){return new l({key:this.getKey()})};l.prototype._openExpandConfirmMessageBox=function(){i.show(u.getText("CALCULATION_BUILDER_EXPAND_MESSAGE_TEXT",this._getLabel()),{icon:i.Icon.WARNING,title:u.getText("CALCULATION_BUILDER_EXPAND_MESSAGE_TITLE"),actions:[i.Action.OK,i.Action.CANCEL],onClose:function(t){var e;if(t===i.Action.OK){this._expandVariable(true)}else{e=this.getParent();if(e){e._setCorrectFocus()}}}.bind(this)})};l.prototype._getItemError=function(){var t=this.getParent(),e;if(this._hasCorrectParent(t)){e=jQuery.grep(t._aErrors,function(t){return t.index===this._iIndex}.bind(this))[0]}return e};l.prototype._getLabel=function(){var t=function(){var t=this._getItem();if(!t){return this.getKey()}if(t.title){return t.title}if(t._getLabel){return t._getLabel()}return t.getText()||t.getKey()}.bind(this);if(!this._sLabel){this._sLabel=t();if(this._isFunction()){this._sLabel+=" ("}}return this._sLabel};l.prototype._sanitizeKey=function(t){if(!t||typeof t!=="string"){return t}t=t.replace(/{/g,"&#125;");t=t.replace(/}/g,"&#123;");return t};l.prototype._reset=function(){this._sType="";this._sLabel="";this._oVariable=""};l.prototype.setKey=function(t,e){this._reset();this.setProperty("key",this._sanitizeKey(t),e);var i=this.getParent();if(i&&i._bRendered){i.getParent()&&i.getParent()._expressionChanged()}return this};l.prototype.getKey=function(){var t=this.getProperty("key");t=t.replace(/&#125;/g,"{");t=t.replace(/&#123;/g,"}");return t};l.prototype._getType=function(){var t=this.getParent();if(!this._sType&&t){this._sType=t._getType(this.getKey())}return this._sType};l.prototype._isEmpty=function(){return!this._bIsNew&&!this.getKey()};l.prototype._isOperator=function(){return this._getType()===a.Operator};l.prototype._isSecondaryOperator=function(){var t=this._getType();if(this._getType()===a.Operator){return["+","-","/","*","(",")",","].indexOf(this.getKey())===-1}return t===a.CustomOperator};l.prototype._isCustomOperator=function(){return this._getType()===a.CustomOperator};l.prototype._isVariable=function(){return this._getType()===a.Variable};l.prototype._isLiteral=function(){return this._getType()===a.Literal};l.prototype._isFunction=function(){var t=this._getType();return t===a.Function||t===a.CustomFunction};l.prototype._getFunction=function(){var t=this._getType();if(t===a.Function||t===a.CustomFunction){var e=this.getParent().getParent();return e._createFunctionObject(e._getFunctionDefinition(this.getKey()))}return null};l.prototype._getItemInstance=function(t,e){if(this._getType()===t){var i=this.getKey(),r=this.getParent()[e]();return jQuery.grep(r,function(t){return t.getKey().toLowerCase()===i.toLowerCase()})[0]}return null};l.prototype._getItem=function(){var t=this._getType();switch(t){case a.Variable:return this._getVariable();case a.CustomFunction:return this._getCustomFunction();case a.CustomOperator:return this._getCustomOperator()}return null};l.prototype._getTooltip=function(){var t=this._getItem();return t&&t.getTooltip_AsString?t.getTooltip_AsString():""};l.prototype._getVariable=function(){return this._getItemInstance(a.Variable,"getVariables")};l.prototype._getCustomFunction=function(){return this._getItemInstance(a.CustomFunction,"getFunctions")};l.prototype._getCustomOperator=function(){return this._getItemInstance(a.CustomOperator,"getOperators")};l.prototype._isBracket=function(){return this._isOperator()&&(this.getKey()==="("||this.getKey()===")")};l.prototype._isAddition=function(){return this._isOperator()&&this.getKey()==="+"};l.prototype._isSubtraction=function(){return this._isOperator()&&this.getKey()==="-"};l.prototype._isDivision=function(){return this._isOperator()&&this.getKey()==="/"};l.prototype._isMultiplication=function(){return this._isOperator()&&this.getKey()==="*"};l.prototype._isComma=function(){return this._isOperator()&&this.getKey()===","};l.prototype._isLogicalOperator=function(){return this._isOperator()&&!!o[this.getKey()]};l.prototype._hasCorrectParent=function(t){t=t||this.getParent();return t instanceof sap.suite.ui.commons.CalculationBuilderExpression};return l});
//# sourceMappingURL=CalculationBuilderItem.js.map