/*!
 * 
		SAP UI development toolkit for HTML5 (SAPUI5)
		(c) Copyright 2009-2015 SAP SE. All rights reserved
	
 */
sap.ui.define(["sap/ui/thirdparty/jquery","sap/ui/base/Object","./Group","./Node","./Line","sap/ui/events/KeyCodes","sap/ui/dom/containsOrEquals","sap/base/Log"],function(jQuery,t,e,o,i,s,n,r){"use strict";var u={LEFT:"left",RIGHT:"right",UP:"up",DOWN:"down"};var a=/^on.*|setFocus|setItems$/;function l(t){var e,o=t.prototype;for(e in o){if(o.hasOwnProperty(e)&&typeof o[e]==="function"&&a.test(e)){o[e]=h(o[e])}}}function h(t){return function(){try{return t.apply(this,arguments)}catch(t){this._handleError(t)}return undefined}}var f=t.extend("sap.suite.ui.commons.networkgraph.KeyboardNavigator",{constructor:function(e){t.apply(this,arguments);this._oGraph=e;this._aItems=[[]];this._iRows=0;this._iColumns=0;this._iPageSize=5;this._oFocus=null;this._oFocusPosition=null;this._oWrapperDom=null}});f.prototype.getFocus=function(){var t=this._oGraph.getFocus();if(this._oFocus!==t){this._oFocus=t?{item:t.item,button:t.button}:null;this._oFocusPosition=null}if(this._oFocus!=null&&this._oFocus.item===null&&this._oFocus.button===null){return null}return this._oFocus?{item:this._oFocus.item,button:this._oFocus.button}:null};f.prototype.getFocusPosition=function(){var t=this.getFocus();if(!this._oFocusPosition){var e,o;this._oFocusPosition={iX:null,iY:null};if(!t){return this._oFocusPosition}for(o=0;o<this._aItems.length;o++){for(e=0;e<this._aItems[o].length;e++){if(this._aItems[o][e]===t.item){this._oFocusPosition={iX:e,iY:o};return this._oFocusPosition}}}}return this._oFocusPosition};f.prototype.setItems=function(t){this._aItems=t;this._iRows=t.length;this._iColumns=0;t.forEach(function(t){if(this._iColumns<t.length){this._iColumns=t.length}},this)};f.prototype.setWrapperDom=function(t){this._oWrapperDom=t};f.prototype.setPageSize=function(t){this._iPageSize=t};f.prototype.onsapend=function(t){this._moveThroughMatrix(t,true,true)};f.prototype.onsaphome=function(t){this._moveThroughMatrix(t,true,false)};f.prototype.onsapendmodifiers=function(t){if(t.ctrlKey){this._moveThroughMatrix(t,false,true)}};f.prototype.onsaphomemodifiers=function(t){if(t.ctrlKey){this._moveThroughMatrix(t,false,false)}};f.prototype.onsappagedown=function(t){this._moveThroughMatrix(t,false,true,this._iPageSize)};f.prototype.onsappageup=function(t){this._moveThroughMatrix(t,false,false,this._iPageSize)};f.prototype.onsappagedownmodifiers=function(t){if(t.altKey){this._moveThroughMatrix(t,true,true,this._iPageSize)}};f.prototype.onsappageupmodifiers=function(t){if(t.altKey){this._moveThroughMatrix(t,true,false,this._iPageSize)}};f.prototype.onsapspace=function(t){this._handleEnter();if(this._oGraph.getFocusDomRef()===document.activeElement){t.stopPropagation();t.preventDefault()}};f.prototype.onsapspacemodifiers=function(t){if(t.ctrlKey&&this._oGraph.getFocusDomRef()===document.activeElement){this._selectElement(true);t.stopPropagation();t.preventDefault()}};f.prototype.onsapenter=function(t){this._handleEnter()};f.prototype.onsaptabnext=function(t){this._handleTab(t,u.RIGHT)};f.prototype.onsaptabprevious=function(t){this._handleTab(t,u.LEFT)};f.prototype.onsapleft=function(t){this._handleArrow(t,u.LEFT)};f.prototype.onsapright=function(t){this._handleArrow(t,u.RIGHT)};f.prototype.onsapup=function(t){this._handleArrow(t,u.UP)};f.prototype.onsapdown=function(t){this._handleArrow(t,u.DOWN)};f.prototype.onkeydown=function(t){var n,r,a=this.getFocus();if(!a){return}n=a.item;r=a.button;if(t.ctrlKey&&t.keyCode===s.A){this._onCtrlA(t)}else if(t.keyCode===s.F2){if(n instanceof o){if(n.hasVisibleActionButtons()){n._detailClick()}}else if(n instanceof i){n.getParent()._tooltip.openDetail({item:n,point:n._getArrowFragmentVector().apex})}else if(n instanceof e){n._openDetail()}t.stopPropagation()}else if(t.keyCode===s.F6){if(n&&r){a.button=null;this._oGraph.setFocus(a)}this._handleArrow(t,t.shiftKey?u.LEFT:u.RIGHT)}else if(t.keyCode===s.F7&&!t.shiftKey){if(n&&r){a.button=null;this._oGraph.setFocus(a)}}else if(t.ctrlKey&&(t.keyCode===s.DIGIT_0||t.keyCode===s.NUMPAD_0)){this._onCtrl0(t)}else if(t.ctrlKey&&(t.keyCode===s.PLUS||t.keyCode===s.NUMPAD_PLUS)){this._onCtrlPlus(t)}else if(t.ctrlKey&&(t.keyCode===s.SLASH||t.keyCode===s.NUMPAD_MINUS)){this._onCtrlMinus(t)}};f.prototype._handleEnter=function(){var t,s,n=this.getFocus();if(!n){return}if(n.button=="menu"){n.item._setMenuButtonFocus(false)}t=n.item;s=n.button;if(t instanceof o){if(s){this._oGraph._isUseNodeHtml()?jQuery(s).trigger("click"):jQuery(s).children().first().trigger("click")}else{t._onClick(false);if(!t.getSelected()){t.$().removeClass(t.HIGHLIGHT_CLASS);t._setStatusColors("")}}}else if(t instanceof i){var r=t._getArrowFragmentVector();t._click({ctrlKey:false,clientX:r.apex.x,clientY:r.apex.y,skipConversion:true})}else if(t instanceof e){if(s===e.BUTTONS.MENU){t._openDetail()}else if(s===e.BUTTONS.COLLAPSE){t._collapse()}else{t._openDetail()}}};f.prototype._handleTab=function(t,e){var o=sap.ui.getCore().getLibraryResourceBundle("sap.suite.ui.commons");this._oWrapperDom.setAttribute("aria-live","assertive");this._oGraph._setAriaLabelForWrapper(o.getText("NETWORK_GRAPH_ACCESSIBILITY_LABEL"));if(this._ignoreEvent(t)){this._oWrapperDom.setAttribute("aria-live","off");this._oWrapperDom.classList.remove("sapSuiteUiCommonsNetworkGraphContentFocusHidden");return}else{this._oWrapperDom.classList.add("sapSuiteUiCommonsNetworkGraphContentFocusHidden")}if(this._handleTabOverNodeWithButtons(t,e)||this._handleTabOverGroupWithButtons(t,e)){t.preventDefault();t.stopPropagation();return}this._moveItemFocus(t,e)};f.prototype._handleTabOverNodeWithButtons=function(t,e){var i=this.getFocus(),s,n,r,a=false,l;if(!i){return false}s=i.item;n=i.button;r=s&&s.getEnabledActionButtons?s.getEnabledActionButtons():[];if(!(s instanceof o)||!s.hasVisibleActionButtons()||r.length===0){return false}if(n){l=0;for(var h=0;h<r.length;h++){if(r[h].isEqualNode(n)){l=h;break}}if(e===u.RIGHT){if(l===r.length-1){return false}else{this._setActionButtonFocus(r[l+1])}a=true}else if(e===u.LEFT){if(l===0){this._moveItemFocus(t,this.getFocusPosition())}else{this._setActionButtonFocus(r[l-1])}a=true}}else if(e===u.RIGHT){this._setActionButtonFocus(r[0]);a=true}return a};f.prototype._handleTabOverGroupWithButtons=function(t,o){var i=this.getFocus(),s,n;if(!i){return false}s=i.item;n=i.button;if(s instanceof e){if(!n){n=e.BUTTONS.MENU}if(n){if(n===e.BUTTONS.MENU){if(o===u.RIGHT){i.button=e.BUTTONS.COLLAPSE;this._oGraph.setFocus(i);return true}else if(o===u.LEFT){return false}}else if(n===e.BUTTONS.COLLAPSE){if(o===u.RIGHT){return false}else if(o===u.LEFT){i.button=e.BUTTONS.MENU;this._oGraph.setFocus(i);return true}}}}return false};f.prototype._setActionButtonFocus=function(t){var e=this.getFocus();if(!e){return}e.button=t;this._oGraph.setFocus(e)};f.prototype._selectElement=function(t){var e=this.getFocus(),s;if(!e){return}s=e.item;if(s instanceof o){s.getParent()._selectNode({element:s,setFocus:false,renderActionButtons:false,preventDeselect:t})}else if(s instanceof i){s.getParent()._selectLine({element:s,setFocus:false,preventDeselect:t})}};f.prototype._moveThroughMatrix=function(t,e,o,i){var s=this.getFocus(),n,r,u,a,l=this.getFocusPosition().iX,h=this.getFocusPosition().iY;if(this._ignoreEvent(t)||!s){return}n=s.item;u=0;i=i||Number.POSITIVE_INFINITY;do{for(var f=(e?l:h)+(o?1:-1);o&&f<(e?this._iColumns:this._iRows)||!o&&f>=0;f+=o?1:-1){r=e&&h>=0&&h<this._iRows||!e&&l>=0&&l<this._iColumns?this._aItems[e?h:f][e?f:l]:null;if(r&&u<i){a=r;u++;if(u>=i){break}}}if(i<Number.POSITIVE_INFINITY&&u<i){if(e){if(o){l=-1;h++}else{l=this._iColumns;h--}}else if(o){l++;h=-1}else{l--;h=this._iRows}}}while(i<Number.POSITIVE_INFINITY&&u<i&&h>=-1&&h<=this._iRows&&l>=-1&&l<=this._iColumns);if(a&&a!==n){s.item=a;s.button=null;this._oGraph.setFocus(s);t.stopPropagation()}};f.prototype._handleArrow=function(t,e){if(this._ignoreEvent(t)||!this.getFocus()){return}this._moveItemFocus(t,e,true)};f.prototype._moveItemFocus=function(t,i,s){var n,r=i===u.LEFT&&t.key==="Tab",a,l,h;if(typeof i==="string"){a=this._findNextPosition(i)}else{a=i}l=this._getItemAtPosition(a);n={item:l,button:null};if(r&&l!==null){if(l instanceof o&&l.hasVisibleActionButtons()){h=l.getEnabledActionButtons();if(h.length>0){n.button=h[h.length-1]}}else if(l instanceof e){n.button=e.BUTTONS.COLLAPSE}}if(l||!s){this._oGraph.setFocus(n)}if(t&&l){t.preventDefault();t.stopPropagation()}};f.prototype._getItemAtPosition=function(t){var e;if(!t||t.iX===null){return null}else{e=this._aItems[t.iY];return e?e[t.iX]:null}};f.prototype._findNextPosition=function(t){var e,o;if(this.getFocusPosition().iX===null){if(t===u.LEFT){e=this._iColumns-1;o=this._iRows-1}else{e=0;o=0}if(this._aItems[o][e]!==null){return{iX:e,iY:o}}}else{e=this.getFocusPosition().iX;o=this.getFocusPosition().iY}do{switch(t){case u.RIGHT:e+=1;if(e>=this._iColumns){o+=1;e=0}break;case u.LEFT:e-=1;if(e<0){o-=1;e=this._iColumns-1}break;case u.UP:o-=1;if(o<0&&e>0){e-=1;o=this._iRows-1}break;case u.DOWN:o+=1;if(o>=this._iRows&&e<this._iColumns-1){e+=1;o=0}break;default:throw new Error("Unexpected direction: "+t)}}while(o>=0&&o<this._iRows&&this._aItems[o][e]===null);if(o<0||o>=this._iRows){return null}else{return{iX:e,iY:o}}};f.prototype._onCtrlA=function(t){if(this._ignoreEvent(t)){return}var o=true;this._forEach(function(t){if(t instanceof e){return false}if(!t.getSelected()){o=false;return true}return false});o=!o;this._forEach(function(t){if(!(t instanceof e)){t.setSelected(o)}});t.preventDefault();t.stopPropagation()};f.prototype._forEach=function(t){var e,o,i,s;for(o=0;o<this._iRows;o++){for(e=0;e<this._iColumns;e++){i=this._aItems[o][e];if(i){s=t.call(this,i,e,o);if(s){return}}}}};f.prototype._onCtrl0=function(t){this._oGraph._zoom({zoomLevel:this._oGraph.ZOOM_100});t.preventDefault();t.stopPropagation()};f.prototype._onCtrlPlus=function(t){this._oGraph._zoom({deltaY:1});t.preventDefault();t.stopPropagation()};f.prototype._onCtrlMinus=function(t){this._oGraph._zoom({deltaY:-1});t.preventDefault();t.stopPropagation()};f.prototype._ignoreEvent=function(t){return!n(this._oWrapperDom,t.target)};f.prototype._handleError=function(t){r.error("An error in KeyboardNavigator: "+t)};l(f);return f});
//# sourceMappingURL=KeyboardNavigator.js.map