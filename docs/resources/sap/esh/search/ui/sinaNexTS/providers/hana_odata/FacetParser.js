/*! 
 * SAPUI5

		(c) Copyright 2009-2021 SAP SE. All rights reserved
	 
 */
(function(){sap.ui.define(["../../sina/SearchQuery","./typeConverter","../../sina/LogicalOperator","../../sina/ComparisonOperator","../../core/Log","../../core/errors","./HierarchyParser"],function(e,r,a,t,o,i,n){function s(e){"@babel/helpers - typeof";return s="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},s(e)}function c(e,r){if(!(e instanceof r)){throw new TypeError("Cannot call a class as a function")}}function u(e,r){for(var a=0;a<r.length;a++){var t=r[a];t.enumerable=t.enumerable||false;t.configurable=true;if("value"in t)t.writable=true;Object.defineProperty(e,t.key,t)}}function l(e,r,a){if(r)u(e.prototype,r);if(a)u(e,a);Object.defineProperty(e,"prototype",{writable:false});return e}
/*!
   * SAPUI5

		(c) Copyright 2009-2021 SAP SE. All rights reserved
	
   */var v=e["SearchQuery"];var p=a["LogicalOperator"];var m=t["ComparisonOperator"];var f=o["Log"];var d=i["FacetsParseError"];var h=i["InternalServerError"];var y=n["HierarchyParser"];function b(e,r,a){if(a){return r?r(e()):e()}try{var t=Promise.resolve(e());return r?t.then(r):t}catch(e){return Promise.reject(e)}}var S=function(){function e(r){c(this,e);this.provider=r;this.sina=r.sina;this.log=new f("hana_odata facet parser")}l(e,[{key:"parse",value:function e(r,a){var t=this;return b(function(){var e=new y;var o=a["@com.sap.vocabularies.Search.v1.Facets"];if(a.error&&!o){return Promise.reject(new h(a.error.message))}if(!o){return Promise.resolve([])}if(a.error){t.log.warn("Server-side Warning: "+a.error.message)}var i=[];for(var n=0;n<o.length;n++){var s=o[n];var c=void 0;if(r.filter.dataSource===r.sina.getAllDataSource()){try{c=t.parseDataSourceFacet(r,s)}catch(e){t.log.warn("Error occurred by parsing dataource item number "+n+": "+e.message);continue}}else{if(r.filter.dataSource.type===r.sina.DataSourceType.Category){continue}if(s["@com.sap.vocabularies.Search.v1.Facet"].Dimensions[0].PropertyType==="GeometryPolygonFacet"){continue}try{var u=t.parseFacetAttribute(r,s);if(u.isHierarchy){c=e.parseHierarchyFacet(r,u,s)}else{c=t.parseChartFacet(r,u,s)}}catch(e){var l="";if(s.Items&&Array.isArray(s.Items)){l=JSON.stringify(s)}t.log.warn("Error occurred by parsing facet "+(s["@com.sap.vocabularies.Common.v1.Label"]||"")+"', facet position: "+n+": "+e.message+"; item data: "+l);continue}}i.push(c)}return Promise.all(i)})}},{key:"parseDataSourceFacet",value:function e(r,a){var t=r;if(r instanceof v){t=this.sina.createDataSourceQuery({dataSource:r.filter.dataSource,filter:r.filter.clone()})}var o=[];for(var i=0;i<a.Items.length;i++){var n=a.Items[i];var s=this.sina.getDataSource(n.scope);if(!s){s=this.sina.createDataSource({type:this.sina.DataSourceType.Category,id:n.ValueLow,label:n.Description})}o.push(this.sina._createDataSourceResultSetItem({dataSource:s,dimensionValueFormatted:s.labelPlural,measureValue:n._Count,measureValueFormatted:n._Count.toString()}))}var c=this.sina._createDataSourceResultSet({title:r.filter.dataSource.label,items:o,query:t});if(r instanceof v){return t._setResultSet(c)}return c}},{key:"createAttributeFilterCondition",value:function e(a,t,o){if(s(o[a])==="object"&&(Object.prototype.hasOwnProperty.call(o[a],"From")||Object.prototype.hasOwnProperty.call(o[a],"From"))){var i=this.sina.createComplexCondition({attributeLabel:t.label,valueLabel:this.formatFacetValue(o[a]),operator:p.And,conditions:[]});var n,c;if(!o[a].From){c=this.sina.createSimpleCondition({attribute:a,operator:m.Le,value:r.odata2Sina(t.type,o[a].To)});i.conditions.push(c)}else if(!o[a].To){n=this.sina.createSimpleCondition({attribute:a,operator:m.Ge,value:r.odata2Sina(t.type,o[a].From)});i.conditions.push(n)}else{n=this.sina.createSimpleCondition({attribute:a,operator:m.Ge,value:r.odata2Sina(t.type,o[a].From)});i.conditions.push(n);c=this.sina.createSimpleCondition({attribute:a,operator:m.Le,value:r.odata2Sina(t.type,o[a].To)});i.conditions.push(c)}return i}var u=r.odata2Sina(t.type,o[a]);var l=o[a+"@com.sap.vocabularies.Common.v1.Text"];if(typeof l==="string"&&l.length>0){if(l.startsWith("sap-icon://")===false){u=l}}return this.sina.createSimpleCondition({attributeLabel:t.label,attribute:a,value:o[a],valueLabel:u})}},{key:"formatFacetValue",value:function e(r){var a="";if(r["@com.sap.vocabularies.Common.v1.Label"]){return r["@com.sap.vocabularies.Common.v1.Label"]}if(s(r)==="object"&&(Object.prototype.hasOwnProperty.call(r,"From")||Object.prototype.hasOwnProperty.call(r,"To"))){r=(r.From||a)+"..."+(r.To||a)}return r}},{key:"parseFacetAttribute",value:function e(r,a){var t=r.filter.dataSource;var o="";if(r.dimension){o=r.dimension}else{if(a["@com.sap.vocabularies.Search.v1.Facet"]&&a["@com.sap.vocabularies.Search.v1.Facet"].Dimensions&&a["@com.sap.vocabularies.Search.v1.Facet"].Dimensions[0]&&a["@com.sap.vocabularies.Search.v1.Facet"].Dimensions[0].PropertyName){o=a["@com.sap.vocabularies.Search.v1.Facet"].Dimensions[0].PropertyName}else{throw new d("parse error facets")}}var i=t.getAttributeMetadata(o);return i}},{key:"parseChartFacet",value:function e(r,a,t){var o,i;var n=r.filter.dataSource;var s=[];var c=r;var u=r.filter.clone();u.setDataSource(n);u.setRootCondition(r.filter.rootCondition.clone());c=this.sina.createChartQuery({filter:u,dimension:a.id});var l=((o=a.usage)===null||o===void 0?void 0:(i=o.AdvancedSearch)===null||i===void 0?void 0:i.iconUrlAttributeName)||a.id+"@com.sap.vocabularies.Common.v1.Text";var p=t.Items.findIndex(function(e){var r;return(r=e[l])===null||r===void 0?void 0:r.startsWith("sap-icon://")})>-1;for(var m=0;m<t.Items.length;m++){var f=t.Items[m];var d=f[a.id+"@com.sap.vocabularies.Common.v1.Text"];var h="";if(p===true){h="sap-icon://none"}var y=this.formatFacetValue(f[a.id]);if(typeof d==="string"&&d.length>0){if(d.startsWith("sap-icon://")){h=d}else{var b,S;y=d;h=f[(b=a.usage)===null||b===void 0?void 0:(S=b.AdvancedSearch)===null||S===void 0?void 0:S.iconUrlAttributeName]||h}}else{var g,C;h=f[(g=a.usage)===null||g===void 0?void 0:(C=g.AdvancedSearch)===null||C===void 0?void 0:C.iconUrlAttributeName]||h}s.push(this.sina._createChartResultSetItem({filterCondition:this.createAttributeFilterCondition(a.id,a,f),dimensionValueFormatted:y,measureValue:f._Count,measureValueFormatted:f._Count,icon:h}))}var F=this.sina._createChartResultSet({title:a.label,items:s,query:c});if(r instanceof v){return c._setResultSet(F)}return F}}]);return e}();var g={__esModule:true};g.FacetParser=S;return g})})();
//# sourceMappingURL=FacetParser.js.map