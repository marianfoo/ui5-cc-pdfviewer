/*! 
 * SAPUI5

		(c) Copyright 2009-2021 SAP SE. All rights reserved
	 
 */
(function(){sap.ui.define(["../AbstractProvider","../../core/core","./conditionSerializer","./dataSourceSerializer","../../core/util","../../core/lang","../../core/ajax","./ajaxTemplates","./labelCalculation","./pivotTableParser","./suggestionParser","./suggestionTermSplitter","./UserEventLogger","./MetadataParser","./ItemParser","./FacetParser","../../sina/AttributeType","../../core/errors"],function(e,t,r,a,s,n,i,o,u,c,l,d,f,h,p,v,g,S){function y(e,t){if(!(e instanceof t)){throw new TypeError("Cannot call a class as a function")}}function b(e,t){for(var r=0;r<t.length;r++){var a=t[r];a.enumerable=a.enumerable||false;a.configurable=true;if("value"in a)a.writable=true;Object.defineProperty(e,a.key,a)}}function m(e,t,r){if(t)b(e.prototype,t);if(r)b(e,r);Object.defineProperty(e,"prototype",{writable:false});return e}function R(e,t){if(typeof t!=="function"&&t!==null){throw new TypeError("Super expression must either be null or a function")}e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:true,configurable:true}});Object.defineProperty(e,"prototype",{writable:false});if(t)P(e,t)}function P(e,t){P=Object.setPrototypeOf||function e(t,r){t.__proto__=r;return t};return P(e,t)}function C(e){var t=q();return function r(){var a=I(e),s;if(t){var n=I(this).constructor;s=Reflect.construct(a,arguments,n)}else{s=a.apply(this,arguments)}return D(this,s)}}function D(e,t){if(t&&(typeof t==="object"||typeof t==="function")){return t}else if(t!==void 0){throw new TypeError("Derived constructors may only return object or undefined")}return O(e)}function O(e){if(e===void 0){throw new ReferenceError("this hasn't been initialised - super() hasn't been called")}return e}function q(){if(typeof Reflect==="undefined"||!Reflect.construct)return false;if(Reflect.construct.sham)return false;if(typeof Proxy==="function")return true;try{Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}));return true}catch(e){return false}}function I(e){I=Object.setPrototypeOf?Object.getPrototypeOf:function e(t){return t.__proto__||Object.getPrototypeOf(t)};return I(e)}function T(e,t,r){if(t in e){Object.defineProperty(e,t,{value:r,enumerable:true,configurable:true,writable:true})}else{e[t]=r}return e}
/*!
   * SAPUI5

		(c) Copyright 2009-2021 SAP SE. All rights reserved
	
   */var j=e["AbstractProvider"];var k=i["Client"];var E=f["UserEventLogger"];var x=h["MetadataParser"];var L=p["ItemParser"];var z=v["FacetParser"];var M=g["AttributeType"];var A=S["ESHNotActiveError"];var _=S["NotImplementedError"];function w(e,t,r){if(r){return t?t(e):e}if(!e||!e.then){e=Promise.resolve(e)}return t?e.then(t):e}function N(e,t,r){if(r){return t?t(e()):e()}try{var a=Promise.resolve(e());return t?a.then(t):a}catch(e){return Promise.reject(e)}}var U=function(e){R(f,e);var i=C(f);function f(){var e;y(this,f);for(var t=arguments.length,r=new Array(t),a=0;a<t;a++){r[a]=arguments[a]}e=i.call.apply(i,[this].concat(r));T(O(e),"id","inav2");return e}m(f,[{key:"initAsync",value:function e(r){var a,s=this;this.urlPrefix="/sap/es/ina";this.getServerInfoUrl=this.urlPrefix+"/GetServerInfo";this.getResponseUrl=this.urlPrefix+"/GetResponse";this.sina=r.sina;var n;if(typeof r.getLanguage==="function"){n={csrf:true,csrfByPassCache:true,getLanguage:r.getLanguage}}else{n={csrf:true,csrfByPassCache:true}}this.ajaxClient=(a=r.ajaxClient)!==null&&a!==void 0?a:new k(n);this.metadataLoadPromises={};this.internalMetadata={};this.labelCalculator=u.createLabelCalculator();this.userEventLogger=new E(this);this.metadataParser=new x(this);this.itemParser=new L(this);this.facetParser=new z(this);this.executeSearchQuery=this.addMetadataLoadDecorator(this.executeSearchQuery);this.executeChartQuery=this.addMetadataLoadDecorator(this.executeChartQuery);this.executeSuggestionQuery=this.addMetadataLoadDecorator(this.executeSuggestionQuery);this.sessionId=t.generateGuid();return this.loadServerInfo().then(function(e){s.serverInfo=e;s.userEventLogger.delayedInit();if(!s.supports("Search")){return Promise.reject(new A("Enterprise Search is not active"))}return s.loadBusinessObjectDataSources()}).then(function(){return{capabilities:s.sina._createCapabilities({fuzzy:s.supports("Search","OptionFuzzy")})}})}},{key:"addMetadataLoadDecorator",value:function e(t){return function(){for(var e=arguments.length,r=new Array(e),a=0;a<e;a++){r[a]=arguments[a]}var s=r[0];var n=s.filter.dataSource;return Promise.resolve().then(function(){return this.loadMetadata(n)}.bind(this)).then(function(){return t.apply(this,r)}.bind(this))}.bind(this)}},{key:"loadMetadata",value:function e(t){if(t.type===this.sina.DataSourceType.Category){return Promise.resolve()}var r=this.metadataLoadPromises[t.id];if(r){return r}o.loadDataSourceMetadataRequest.DataSource.ObjectName=t.id;this.addLanguagePreferences(o.loadDataSourceMetadataRequest);r=this.ajaxClient.postJson(this.getResponseUrl,o.loadDataSourceMetadataRequest).then(function(e){this.metadataParser.parseMetadataRequestMetadata(t,e.data)}.bind(this));this.metadataLoadPromises[t.id]=r;return r}},{key:"supports",value:function e(t,r){for(var a=0;a<this.serverInfo.Services.length;++a){var s=this.serverInfo.Services[a];if(s.Service==t){if(!r){return true}for(var n=0;n<s.Capabilities.length;++n){var i=s.Capabilities[n];if(i.Capability===r){return true}}}}return false}},{key:"loadServerInfo",value:function e(){return this.ajaxClient.getJson(this.getServerInfoUrl).then(function(e){return e.data})}},{key:"loadBusinessObjectDataSources",value:function e(){var t=this;t.addLanguagePreferences(o.loadDataSourcesRequest);if(t.supports("Search","PluralDescriptionForDataSource")){o.loadDataSourcesRequest.Search.NamedValues.push({AttributeName:"DescriptionPlural",Name:"DescriptionPlural"})}return t.ajaxClient.postJson(t.getResponseUrl,o.loadDataSourcesRequest).then(function(e){t._processDataSourcesResponse(e,false)},function(){var e=t.serverInfo.ServerInfo.SystemId+t.serverInfo.ServerInfo.Client+"~ESH_CONNECTOR~";o.fallbackLoadDataSourcesRequest.DataSource.ObjectName=e;return t.ajaxClient.postJson(t.getResponseUrl,o.fallbackLoadDataSourcesRequest).then(function(e){t._processDataSourcesResponse(e,true)})})}},{key:"_processDataSourcesResponse",value:function e(r,a){var s=c.parse(r.data);var n=s.axes[0];for(var i=0;i<n.length;++i){var o=n[i];var u="";var l="";var d="";if(!a){if(t.isObject(o.Description)){u=o.Description.Value}else{u=o.Description}if(t.isObject(o.DescriptionPlural)){l=o.DescriptionPlural.Value}else{l=o.DescriptionPlural}if(t.isObject(o.ObjectName)){d=o.ObjectName.Value}else{d=o.ObjectName}}else{o.$$ResultItemAttributes$$.forEach(function(e){if(e.Name==="DESCRIPTION"){u=e.Value}if(e.Name==="DESCRIPTION_PLURAL"){l=e.Value}if(e.Name==="OBJECT_NAME"){d=e.Value}})}if(!u){u=d}if(!l){l=u}var f=this.sina._createDataSource({id:d,label:u,labelPlural:l,type:this.sina.DataSourceType.BusinessObject});this.labelCalculator.calculateLabel(f)}}},{key:"getInternalMetadataAttributes",value:function e(t){var r=[];var a=this.internalMetadata[t.id];if(!a){return r}for(var s in a.data){r.push(a.data[s])}return r}},{key:"getInternalMetadataAttribute",value:function e(t,r){return this.internalMetadata[t.id].data[r]}},{key:"getInternalMetadataLoadStatus",value:function e(t){var r=this.internalMetadata[t.id];if(!r){return{}}return r.loadStatus}},{key:"fillInternalMetadata",value:function e(t,r,a){var s=this.internalMetadata[t.id];if(!s){s={loadStatus:{},data:{}};this.internalMetadata[t.id]=s}for(var n=0;n<a.length;++n){var i=a[n];var o=s.data[i.Name];if(!o){o={};s.data[i.Name]=o}for(var u in i){o[u]=i[u]}}s.loadStatus[r]=true}},{key:"addTemplateConditions",value:function e(t){t.addCondition({attribute:"$$RenderingTemplatePlatform$$",operator:this.sina.ComparisonOperator.Eq,value:"html"});t.addCondition({attribute:"$$RenderingTemplateTechnology$$",operator:this.sina.ComparisonOperator.Eq,value:"Tempo"});t.addCondition({attribute:"$$RenderingTemplateType$$",operator:this.sina.ComparisonOperator.Eq,value:"ResultItem"});t.addCondition({attribute:"$$RenderingTemplateType$$",operator:this.sina.ComparisonOperator.Eq,value:"ItemDetails"})}},{key:"assembleOrderBy",value:function e(t){var r=[];for(var a=0;a<t.sortOrder.length;++a){var s=t.sortOrder[a];var n=s.order===this.sina.SortOrder.Descending?"DESC":"ASC";r.push({AttributeName:s.id,SortOrder:n})}return r}},{key:"executeSearchQuery",value:function e(t){var s,n;var i=t.filter.rootCondition.clone();this.addTemplateConditions(i);o.searchRequest.Search.Filter=r.serialize(t.filter.dataSource,i);o.searchRequest.DataSource=a.serialize(t.filter.dataSource);o.searchRequest.Search.SearchTerms=t.filter.searchTerm;o.searchRequest.Search.Top=t.top;o.searchRequest.Search.Skip=t.skip;o.searchRequest.Options=this.assembleRequestOptions(t);o.searchRequest.Search.OrderBy=this.assembleOrderBy(t);o.searchRequest.Search.Expand=["Grid","Items","TotalCount"];this.addLanguagePreferences(o.searchRequest);this.addSessionId(o.searchRequest);if(t.calculateFacets){o.searchRequest.Search.Expand.push("ResultsetFacets")}return this.ajaxClient.postJson(this.getResponseUrl,o.searchRequest).then(function(e){n=e;return this.itemParser.parse(t,n.data)}.bind(this)).then(function(e){s=e;return this.facetParser.parse(t,n.data)}.bind(this)).then(function(e){return this.sina._createSearchResultSet({id:n.data.ExecutionID,title:"Search Result List",query:t,items:s.items,totalCount:s.totalCount,facets:e})}.bind(this))}},{key:"executeChartQuery",value:function e(t){var s=t.filter.rootCondition.clone();this.addTemplateConditions(s);o.chartRequest.Search.Filter=r.serialize(t.filter.dataSource,s);o.chartRequest.DataSource=a.serialize(t.filter.dataSource);o.chartRequest.Search.SearchTerms=t.filter.searchTerm;o.chartRequest.Search.Top=1;o.chartRequest.Search.Skip=0;o.chartRequest.Facets.Attributes=[t.dimension];o.chartRequest.Facets.MaxNumberOfReturnValues=t.top;o.chartRequest.Options=this.assembleRequestOptions(t);this.addLanguagePreferences(o.chartRequest);this.addSessionId(o.chartRequest);return this.ajaxClient.postJson(this.getResponseUrl,o.chartRequest).then(function(e){return this.facetParser.parse(t,e.data)}.bind(this)).then(function(e){if(e.length>0){return e[0]}return this.sina._createChartResultSet({title:t.filter.dataSource.getAttributeMetadata(t.dimension).label,items:[],query:t})}.bind(this))}},{key:"executeHierarchyQuery",value:function e(t){throw new _}},{key:"executeSuggestionQuery",value:function e(t){var s=this;return N(function(){var e=t.filter.searchTerm;var n=d.split(s,e);var i=t.filter.rootCondition.clone();if(n.searchTerm){i.addCondition(t.sina.createSimpleCondition({attribute:M.INAV2_SearchTerms,value:n.searchTerm}))}i.addCondition(t.sina.createSimpleCondition({attribute:M.INAV2_SuggestionTerms,value:n.suggestionTerm}));o.suggestionRequest.Suggestions2.Filter=r.serialize(t.filter.dataSource,i);o.suggestionRequest.DataSource=a.serialize(t.filter.dataSource);o.suggestionRequest.Options=s.assembleSuggestionOptions(t);if(o.suggestionRequest.Options.length===0){return w(s.sina._createSuggestionResultSet({title:"Suggestions",query:t,items:[]}))}o.suggestionRequest.Suggestions2.Top=t.top;o.suggestionRequest.Suggestions2.Skip=t.skip;s.addLanguagePreferences(o.suggestionRequest);s.addSessionId(o.suggestionRequest);return w(s.ajaxClient.postJson(s.getResponseUrl,o.suggestionRequest).then(function(e){var r=l.parse(this,t,e.data);d.concatenate(this,n,r);return this.sina._createSuggestionResultSet({title:"Suggestions",query:t,items:r})}.bind(s)))})}},{key:"addSessionId",value:function e(t){if(!this.supports("Search","SessionHandling")){delete t.SessionID;delete t.SessionTimestamp;return}t.SessionID=this.sessionId;t.SessionTimestamp=parseInt(s.generateTimestamp(),10)}},{key:"addLanguagePreferences",value:function e(t){if(!this.supports("Search","LanguagePreferences")){delete t.LanguagePreferences;return}t.LanguagePreferences=n.getLanguagePreferences()}},{key:"assembleSuggestionOptions",value:function e(t){var r={SearchTerm:{Data:"SuggestObjectData",History:"SuggestSearchHistory"},Object:{},DataSource:{Data:"SuggestDataSources"}};if(!this.supports("Suggestions2","ScopeTypes")){delete r.SearchTerm.History;delete r.DataSource.Data}var a=[];var s=t.types;var n=t.calculationModes;for(var i=0;i<s.length;i++){var o=s[i];for(var u=0;u<n.length;u++){var c=n[u];var l=r[o][c];if(!l){continue}a.push(l)}}return a}},{key:"assembleRequestOptions",value:function e(t){var r=["SynchronousRun"];if(this.decideValueHelp(t)){r.push("ValueHelpMode")}return r}},{key:"decideValueHelp",value:function e(t){var r=t.filter.rootCondition.conditions;for(var a=0;a<r.length;a++){if(t.filter._getAttribute(r[a])===t["dimension"]){return true}}return false}},{key:"getConfigurationAsync",value:function e(){var t=this;return N(function(){return t.supports("PersonalizedSearch","SetUserStatus")?w(t.ajaxClient.postJson(t.getResponseUrl,o.getConfigurationRequest).then(function(e){var t={personalizedSearch:false,isPersonalizedSearchEditable:false};t.personalizedSearch=e.data.Data.PersonalizedSearch.SessionUserActive;switch(e.data.Data.PersonalizedSearch.PersonalizationPolicy){case"Opt-In":t.isPersonalizedSearchEditable=true;break;case"Opt-Out":t.isPersonalizedSearchEditable=true;break;case"Enforced":t.isPersonalizedSearchEditable=false;break;case"Disabled":t.isPersonalizedSearchEditable=false;break}return this.sina._createConfiguration(t)}.bind(t))):Promise.resolve(t.sina._createConfiguration({personalizedSearch:false,isPersonalizedSearchEditable:false}))})}},{key:"saveConfigurationAsync",value:function e(t){var r=this;return N(function(){if(!r.supports("PersonalizedSearch","SetUserStatus")){return Promise.resolve()}o.saveConfigurationRequest.SearchConfiguration.Data.PersonalizedSearch.SessionUserActive=t.personalizedSearch;return w(r.ajaxClient.postJson(r.getResponseUrl,o.saveConfigurationRequest))})}},{key:"resetPersonalizedSearchDataAsync",value:function e(){if(!this.supports("PersonalizedSearch","ResetUserData")){return Promise.resolve()}return this.ajaxClient.postJson(this.getResponseUrl,o.resetPersonalizedSearchDataRequest)}},{key:"logUserEvent",value:function e(t){return this.userEventLogger.logUserEvent(t)}},{key:"getDebugInfo",value:function e(){return"Searchsystem: ".concat(this.serverInfo.ServerInfo.SystemId," Client: ").concat(this.serverInfo.ServerInfo.Client," ESH API Provider: ").concat(this.id)}}]);return f}(j);var $={__esModule:true};$.Provider=U;return $})})();
//# sourceMappingURL=Provider.js.map