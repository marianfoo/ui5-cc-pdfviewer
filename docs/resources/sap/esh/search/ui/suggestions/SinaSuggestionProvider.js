/*! 
 * SAPUI5

		(c) Copyright 2009-2021 SAP SE. All rights reserved
	 
 */
(function(){sap.ui.define(["../i18n","./SinaBaseSuggestionProvider","./SinaObjectSuggestionFormatter","./SuggestionType","sap/esh/search/ui/SearchHelper"],function(e,t,r,i,n){function s(e){return e&&e.__esModule&&typeof e.default!=="undefined"?e.default:e}function a(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),r.push.apply(r,i)}return r}function o(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?a(Object(r),!0).forEach(function(t){u(e,t,r[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):a(Object(r)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))})}return e}function u(e,t,r){if(t in e){Object.defineProperty(e,t,{value:r,enumerable:true,configurable:true,writable:true})}else{e[t]=r}return e}function c(e,t){if(!(e instanceof t)){throw new TypeError("Cannot call a class as a function")}}function g(e,t){for(var r=0;r<t.length;r++){var i=t[r];i.enumerable=i.enumerable||false;i.configurable=true;if("value"in i)i.writable=true;Object.defineProperty(e,i.key,i)}}function l(e,t,r){if(t)g(e.prototype,t);if(r)g(e,r);Object.defineProperty(e,"prototype",{writable:false});return e}function f(e,t){if(typeof t!=="function"&&t!==null){throw new TypeError("Super expression must either be null or a function")}e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:true,configurable:true}});Object.defineProperty(e,"prototype",{writable:false});if(t)h(e,t)}function h(e,t){h=Object.setPrototypeOf||function e(t,r){t.__proto__=r;return t};return h(e,t)}function S(e){var t=d();return function r(){var i=b(e),n;if(t){var s=b(this).constructor;n=Reflect.construct(i,arguments,s)}else{n=i.apply(this,arguments)}return p(this,n)}}function p(e,t){if(t&&(typeof t==="object"||typeof t==="function")){return t}else if(t!==void 0){throw new TypeError("Derived constructors may only return object or undefined")}return y(e)}function y(e){if(e===void 0){throw new ReferenceError("this hasn't been initialised - super() hasn't been called")}return e}function d(){if(typeof Reflect==="undefined"||!Reflect.construct)return false;if(Reflect.construct.sham)return false;if(typeof Proxy==="function")return true;try{Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}));return true}catch(e){return false}}function b(e){b=Object.setPrototypeOf?Object.getPrototypeOf:function e(t){return t.__proto__||Object.getPrototypeOf(t)};return b(e)}var m=s(e);var v=s(t);var T=s(r);var O=i["Type"];var D=i["SuggestionType"];function j(e,t,r){if(r){return t?t(e):e}if(!e||!e.then){e=Promise.resolve(e)}return t?e.then(t):e}function k(e,t,r){if(r){return t?t(e()):e()}try{var i=Promise.resolve(e());return t?i.then(t):i}catch(e){return Promise.reject(e)}}var P=function(e){f(r,e);var t=S(r);function r(e){var i;c(this,r);i=t.call(this,e.sinaNext);i.model=e.model;i.suggestionTypes=e.suggestionTypes;i.suggestionHandler=e.suggestionHandler;i.suggestionLimit=sap.ui.Device.system.phone?5:7;i.suggestionStartingCharacters=i.model.config.suggestionStartingCharacters;i.sinaObjectSuggestionFormatter=new T;return i}l(r,[{key:"abortSuggestions",value:function e(){this.suggestionQuery.abort()}},{key:"getSuggestions",value:function e(t){var r=this;return k(function(){r.suggestions=[];r.firstObjectDataSuggestion=true;r.numberSuggestionsByType={};for(var e=0;e<D.types.length;++e){var i=D.types[e];r.numberSuggestionsByType[i]=0}var n=t.searchTerm;if(r.suggestionTypes.length===1&&r.suggestionTypes.indexOf(O.SearchTermData)>=0&&n.length<r.suggestionStartingCharacters){return Promise.resolve(r.suggestions)}if(r.suggestionTypes.length===1&&r.suggestionTypes.indexOf(O.Object)>=0&&n.length<r.suggestionStartingCharacters){return Promise.resolve(r.suggestions)}if(r.suggestionTypes.length===1&&r.suggestionTypes.indexOf(O.DataSource)>=0&&r.model.getDataSource()!==r.model.sinaNext.allDataSource){return Promise.resolve(r.suggestions)}r.createAllAndAppDsSuggestions();if(!r.model.config.searchBusinessObjects){return Promise.resolve(r.suggestions)}if(r.model.getDataSource()===r.model.appDataSource){return Promise.resolve(r.suggestions)}r.prepareSuggestionQuery(t);return j(r.suggestionQuery.getResultSetAsync(),function(e){var t=e.items;r.formatSinaSuggestions(t);return r.suggestions})})}},{key:"createAllAndAppDsSuggestions",value:function e(){if(this.suggestionTypes.indexOf(O.DataSource)<0){return}if(this.model.getDataSource()!==this.model.allDataSource){return}var t=[];t.unshift(this.model.appDataSource);t.unshift(this.model.allDataSource);var r=this.model.getProperty("/uiFilter/searchTerm");var i=r.replace(/\*/g,"");var s=new n.Tester(i);for(var a=0;a<t.length;++a){var o=t[a];if(o.id===this.model.getDataSource().id){continue}var u=s.test(o.label);if(u.bMatch===true){if(this.isSuggestionLimitReached(O.DataSource)){return}var c={sina:this.sinaNext,label:"<i>"+m.getText("searchInPlaceholder",[""])+"</i> "+u.sHighlightedText,dataSource:o,position:D.properties.DataSource.position,type:this.sinaNext.SuggestionType.DataSource,calculationMode:this.sinaNext.SuggestionCalculationMode.Data,uiSuggestionType:O.DataSource};this.addSuggestion(c)}}}},{key:"isSuggestionLimitReached",value:function e(t){var r=this.suggestionHandler.getSuggestionLimit(t);var i=this.numberSuggestionsByType[t];if(i>=r){return true}return false}},{key:"preFormatSuggestions",value:function e(t){for(var r=0;r<t.length;++r){var i=t[r];var n=i;n.uiSuggestionType=this.getSuggestionType(i);n.position=D.properties[n.uiSuggestionType].position;this.assembleKey(n);if(n.childSuggestions){this.preFormatSuggestions(n.childSuggestions)}}}},{key:"assembleKey",value:function e(t){switch(t.uiSuggestionType){case O.DataSource:t.key=O.DataSource+t.dataSource.id;break;case O.SearchTermData:t.key=O.SearchTermData+t.searchTerm;if(t.dataSource){t.key+=t.dataSource.id}break;case O.SearchTermHistory:t.key=O.SearchTermData+t.searchTerm;if(t.dataSource){t.key+=t.dataSource.id}break;case O.Object:{var r=t.object.detailAttributes[0].value;t.key=O.Object+r;break}}}},{key:"formatSinaSuggestions",value:function e(t){this.preFormatSuggestions(t);for(var r=0;r<t.length;++r){var i=t[r];if(this.isSuggestionLimitReached(i.uiSuggestionType)){continue}switch(i.uiSuggestionType){case O.DataSource:if(this.model.getDataSource()!==this.model.allDataSource){continue}this.addSuggestion(i);break;case O.SearchTermData:this.formatSearchTermDataSuggestion(i);break;case O.SearchTermHistory:this.addSuggestion(i);break;case O.Object:case O.Transaction:{var n=o(o({},i),{},{dataSource:i.object.dataSource,object:i.object});this.sinaObjectSuggestionFormatter.format(this,n);break}default:break}}return this.suggestions}},{key:"addSuggestion",value:function e(t){this.suggestions.push(t);this.numberSuggestionsByType[t.uiSuggestionType]+=1}},{key:"formatSearchTermDataSuggestion",value:function e(t){if(this.model.getDataSource()===this.model.allDataSource){if(this.firstObjectDataSuggestion){this.firstObjectDataSuggestion=false;if(t.childSuggestions.length>0){t.label=this.assembleSearchInSuggestionLabel(t);t.grouped=true;this.addSuggestion(t);this.addChildSuggestions(t)}else{this.addSuggestion(t)}}else{this.addSuggestion(t)}}else{this.addSuggestion(t)}}},{key:"addChildSuggestions",value:function e(t){for(var r=0;r<Math.min(2,t.childSuggestions.length);++r){if(this.isSuggestionLimitReached(O.SearchTermData)){return}var i=t.childSuggestions[r];i.label=this.assembleSearchInSuggestionLabel(i);i.grouped=true;this.addSuggestion(i)}}},{key:"assembleSearchInSuggestionLabel",value:function e(t){return m.getText("resultsIn",["<span>"+t.label+"</span>",t.filter.dataSource.labelPlural])}},{key:"getSuggestionType",value:function e(t){switch(t.type){case this.sinaNext.SuggestionType.SearchTerm:if(t.calculationMode===this.sinaNext.SuggestionCalculationMode.History){return O.SearchTermHistory}return O.SearchTermData;case this.sinaNext.SuggestionType.SearchTermAndDataSource:if(t.calculationMode===this.sinaNext.SuggestionCalculationMode.History){return O.SearchTermHistory}return O.SearchTermData;case this.sinaNext.SuggestionType.DataSource:return O.DataSource;case this.sinaNext.SuggestionType.Object:return O.Object}}}]);return r}(v);return P})})();
//# sourceMappingURL=SinaSuggestionProvider.js.map