/*
* ! SAP UI development toolkit for HTML5 (SAPUI5)

(c) Copyright 2009-2017 SAP SE. All rights reserved
*/
sap.ui.define(["sap/ui/thirdparty/jquery","sap/base/util/isEmptyObject","sap/ui/dom/includeStylesheet","sap/ui/core/Control","sap/collaboration/components/utils/LanguageBundle","sap/collaboration/components/controls/FeedEntryEmbeddedRenderer","sap/collaboration/components/controls/PlaceholderUtility","sap/collaboration/components/utils/MediaTypeToSAPIcon","sap/m/Link","sap/ui/model/json/JSONModel","sap/m/VBox","sap/m/Image","sap/ui/core/Icon","sap/m/HBox"],function(jQuery,e,t,n,i,r,s,o,a,l,d,c,p,h){"use strict";var u=n.extend("sap.collaboration.components.controls.FeedEntryEmbedded",{metadata:{interfaces:[],library:"sap.collaboration",properties:{feedEntry:{type:"object",group:"data"},serviceUrl:{type:"string",group:"data"}},events:{atMentionClick:{parameters:{link:{type:"object"}}},expandCollapseClick:{},previewLoad:{}}},renderer:r});u.prototype.init=function(){this.nMaxCollapsedLength=200;this.CONTENT_MAX_HEIGHT=128;this._oLangBundle=new i;this._oTimelineItemContent;t(sap.ui.require.toUrl("sap/collaboration/components/resources/css/EmbeddedControl.css"))};u.prototype.onBeforeRendering=function(){};u.prototype.onAfterRendering=function(){this._$ExpandedTextDiv=this.$("expanded-text");var e=this._$ExpandedTextDiv.html();if(e!=undefined){this._$ExpandedTextDiv.html(this._renderLinks(e))}if(this.oExpandLink&&this.oCollapseLink){this._$FeedEntryDiv=this.$();this._$CollapsedTextDiv=this.$("collapsed-text");var t=this._$CollapsedTextDiv.html();if(t!=undefined){this._$CollapsedTextDiv.html(this._renderLinks(t))}jQuery(this._$ExpandedTextDiv).detach()}if(this._oTimelineItemContent.getItems()[0]&&this._oTimelineItemContent.getItems()[0].getMetadata().getName()==="sap.m.Image"){var n=this._oTimelineItemContent.getItems()[0];n.getDomRef().addEventListener("load",function(){var e=this._oTimelineItemContent.getDomRef().clientWidth;var t=this.CONTENT_MAX_HEIGHT;var i=n.getDomRef().width;var r=n.getDomRef().height;var s=i/r;if(!(r<=t&&i<=e)){if(r>t){i=s*t;r=t}if(i>e){r=e/s;i=e}n.setWidth(i+"px");n.setHeight(r+"px");n.rerender()}this.firePreviewLoad()}.bind(this))}};u.prototype.exit=function(){this._destroyAtMentionLinks();if(this.oExpandLink){this.oExpandLink.destroy()}if(this.oCollapseLink){this.oCollapseLink.destroy()}if(this._oTimelineItemContent){this._oTimelineItemContent.destroy()}};u.prototype.setFeedEntry=function(e){this.setProperty("feedEntry",e);this._sText=e.Text;this._sTextWithPlaceholders=e.TextWithPlaceholders;this._destroyAtMentionLinks();this._mAtMentionsLinks={};var t=s.getAtMentionsValues(this._sText,this._sTextWithPlaceholders);for(var n=0;n<t.length;n++){this._mAtMentionsLinks[t[n].placeholder]=this._createAtMentionLink(t[n],e)}this._oTimelineItemContent=this._createTimelineItemContent();return this};u.prototype.getCollapsedText=function(){this.oExpandLink;this.oCollapseLink;var e=0;var t=0;var n=0;var i="";var r=/@@.\{\d+\}/;var o=this._splitByPlaceholders(this._sTextWithPlaceholders);var a=s.getAtMentionsValues(this._sText,this._sTextWithPlaceholders);do{if(r.test(o[n])){if(a[t].placeholder===o[n]){e+=a[t].value.length;i+=a[t].placeholder;t++}}else{e+=o[n].length;i+=o[n]}n++}while(e<=this.nMaxCollapsedLength);i=i.substring(0,this.nMaxCollapsedLength);var l=i.lastIndexOf(" ");if(l>0){this._sCollapsedTextWithPlaceholders=i.substr(0,l)}else{this._sCollapsedTextWithPlaceholders=i}};u.prototype.createExpandCollapseLink=function(e){var t=new a({id:this.getId()+"-"+e,text:this._oLangBundle.getText(e),press:[function(e){var t=e.getSource().getId();if(t.indexOf("-TE_MORE")>-1){jQuery(this._$CollapsedTextDiv).detach();jQuery(this._$ExpandedTextDiv).prependTo(this._$FeedEntryDiv)}else{jQuery(this._$ExpandedTextDiv).detach();jQuery(this._$CollapsedTextDiv).prependTo(this._$FeedEntryDiv)}this.fireExpandCollapseClick()},this]}).addStyleClass("alignMiddle");return t};u.prototype._shouldTextBeRendered=function(){var t=this.getFeedEntry();if(t.Text==undefined||t.Text==""||t.ConsolidatedCount>1||!e(t.TargetObjectReference)&&(t.TargetObjectReference.Type=="Task"||t.TargetObjectReference.Type=="ForumItem"||t.TargetObjectReference.Type=="Event"||t.TargetObjectReference.FullPath=="ContentItem/BlogEntry"||t.TargetObjectReference.FullPath=="ContentItem/Page"||t.TargetObjectReference.FullPath=="ContentItem/Poll")){return false}else{return true}};u.prototype._shouldContentBeRendered=function(){return this._oTimelineItemContent.getItems().length>0};u.prototype._splitByPlaceholders=function(e){return s.splitByPlaceholders(e)};u.prototype._renderLinks=function(e){var t=/(^|[\s\n]|<br\/?>)((?:https?|ftp):\/\/[\-A-Z0-9+\u0026\u2019@#\/%?=()~_|!:,.;]*[\-A-Z0-9+\u0026@#\/%=~()_|])/gi;return e.replace(t,"$1<a href='$2' target='_blank'>$2</a>")};u.prototype._createAtMentionLink=function(e,t){var n=e.value.slice(1);var i=e.placeholder.replace(/[@a-z{}]/g,"");var r=new l({feedId:t.Id,placeholderIndex:i,placeholderValue:e.value});var s=new a({id:"at_mention_link-"+this.getId()+"-"+i,text:"{/placeholderValue}",press:[function(e){this.fireAtMentionClick({link:e.getSource()})},this]}).addStyleClass("sapCollaborationAtMentionLink");s.setModel(r);return s};u.prototype._destroyAtMentionLinks=function(){if(this._mAtMentionsLinks){for(var e in this._mAtMentionsLinks){if(this._mAtMentionsLinks.hasOwnProperty(e)){this._mAtMentionsLinks[e].destroy()}}this._mAtMentionsLinks=undefined}};u.prototype._createTimelineItemContent=function(){var t=new d(this.getId()+"-content",{}).addStyleClass("sapUiTinyMarginTopBottom");var n=this.getFeedEntry();if(!e(n.TargetObjectReference)&&n.TargetObjectReference.Type!==undefined&&n.TargetObjectReference.Type!=="FeedEntry"||n.ConsolidatedCount>1){t.addItem(this._createFeedEntryContent(n))}return t};u.prototype._createFeedEntryContent=function(e){var t="";var n="";var i="";if(e.ConsolidatedCount>1){t="sap-icon://documents";n=this._oLangBundle.getText("TE_CONSOLIDATED_FEED_TEXT");i=e.WebURL}else{i=e.TargetObjectReference.WebURL;switch(e.TargetObjectReference.Type){case"ContentItem":if(e.TargetObjectReference.ContentType){if(e.TargetObjectReference.ContentType.indexOf("image")>-1){var r=new c(this.getId()+"-preview",{src:this.getServiceUrl()+"/FeedEntries('"+e.Id+"')/PreviewImage/$value",press:[function(e){window.open(i,"_blank")},this]});return r}t=o.getSAPIconForMediaType(e.TargetObjectReference.ContentType);n=s.getContentItemName(e.Action,e.ActionWithPlaceholders)}else{switch(e.TargetObjectReference.FullPath){case"ContentItem/Poll":t="sap-icon://horizontal-bar-chart";break;case"ContentItem/Page":t="sap-icon://e-learning";break;case"ContentItem/BlogEntry":t="sap-icon://request";break;default:t="";break}n=e.TargetObjectReference.Title}break;case"ForumItem":t=this._getForumItemIconSrc(e.TargetObjectReference);n=e.TargetObjectReference.Title;break;case"Task":t="sap-icon://task";n=e.TargetObjectReference.Title;break;case"Event":t="sap-icon://calendar";n=e.TargetObjectReference.Title;break;default:t="sap-icon://action";n=e.TargetObjectReference.Title;break}}var l="2.5em";var u=new p({src:t,size:l}).addStyleClass("sapUiTinyMarginBeginEnd");var m=new a({text:n,target:"_blank",href:i,tooltip:n,wrapping:true,width:"95%"}).addStyleClass("RightToLeftParenthesisStyling");var T=new h({});T.addItem(u);var f=new d({width:"100%"}).addStyleClass("sapUiTinyMarginBeginEnd");f.addItem(m);T.addItem(f);return T};u.prototype._getForumItemIconSrc=function(e){var t=e.FullPath;switch(t){case"ForumItem/Inquiry":case"ForumItem/Question":return"sap-icon://question-mark";case"ForumItem/Idea":return"sap-icon://lightbulb";case"ForumItem/Discussion":return"sap-icon://discussion";default:return""}};return u});
//# sourceMappingURL=FeedEntryEmbedded.js.map