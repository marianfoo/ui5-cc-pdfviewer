/*!
 * SAP UI development toolkit for HTML5 (SAPUI5) (c) Copyright 2009-2014 SAP AG. All rights reserved
 */
sap.ui.define(["sap/base/Log","sap/base/security/encodeURL","sap/ui/base/Object","sap/collaboration/components/utils/OdataUtil","sap/ui/thirdparty/jquery"],function(e,r,t,o,jQuery){"use strict";var s=t.extend("sap.collaboration.components.socialtimeline.datahandlers.JamDataHandler",{constructor:function(r){this._oLogger=e.getLogger("sap.collaboration.components.socialtimeline.datahandlers.JamDataHandler");this._oOdataUtil=new o;this._oCollabModel=r;this._oExternalBObuffer={}},_requestsData:{getGroups:{url:function(e){return"/ExternalObjects('"+r(e)+"')/Groups"},urlParameters:function(){return{}},successLog:function(e,r){return"Groups were successfully retrieved."},errorLog:function(e){this._oLogger.error("Failed to retrieve groups: "+e.response.statusText)}},getExternalObjectByExidAndObjectType:{url:function(e,r,t){return t?t:"/ExternalObjects_FindByExidAndObjectType"},urlParameters:function(e,r){return{Exid:"'"+e.replace(/'/g,"''")+"'",ObjectType:"'"+r.replace(/'/g,"''")+"'",$expand:"FeedEntries/Creator"}},successLog:function(e,r){return"External object found: "+e.results.Name},errorLog:function(e){this._oLogger.error(e.response.statusText)}},getFeedEntries:{url:function(e,t){return t?t:"/ExternalObjects"+"('"+r(e)+"')/FeedEntries"},urlParameters:function(){return{$expand:"Creator/MemberProfile"}},successLog:function(e,r){return"Feed entries were successfully retrieved."},errorLog:function(e){this._oLogger.error("Failed to retrieve feed entries: "+e.response.statusText)}},getSuggestions:{url:function(){return"/Members_Autocomplete"},urlParameters:function(e,r){var t={Query:"'"+e+"'",$top:"4"};if(r){t.GroupId="'"+r+"'"}return t},successLog:function(e,r){return""},errorLog:function(e){this._oLogger.error("")}},getAtMentions:{url:function(e){return"/FeedEntries('"+r(e)+"')/AtMentions"},urlParameters:function(){return{}},successLog:function(e,r){return"@mentions were successfully retrieved."},errorLog:function(e){this._oLogger.error("Failed to retrieve the @mentions: "+e.response.statusText,e.stack)}},getReplies:{url:function(e,t){return t?t:"/FeedEntries('"+r(e)+"')/Replies"},urlParameters:function(){return{$orderby:"CreatedAt desc",$expand:"Creator"}},successLog:function(e,r){return"Replies were successfully retrieved."},errorLog:function(e){if(e.response){this._oLogger.error("Failed to retrieve replies: "+e.response.statusText,e.stack)}}}},_doAllTheThings:function(e,r){var t=this;var o=this._requestsData[e];var s=Array.prototype.slice.apply(arguments);s.shift();s.shift();var n=new jQuery.Deferred;var a=function(e,r){t._oLogger.info(o.successLog.apply(t,[e,r]));n.resolve(e,r)};var i=function(e){o.errorLog.apply(t,[e]);n.reject(e)};var u=o.urlParameters.apply(t,s);if(Object.prototype.toString.apply(r)==="[object Object]"){for(var l in r){u[l]=r[l]}}var c={context:null,urlParameters:u,async:true,filters:[],sorters:[],success:a,error:i};return{request:this._oCollabModel.read(o.url.apply(t,s),c),promise:n.promise()}},getGroups:function(e,r,t){return this._doAllTheThings("getGroups",t,e,r)},getExternalObjectByExidAndObjectType:function(e,r){var t=e.ObjectType+e.Exid;this._oExternalBObuffer[t]=e;return this._doAllTheThings("getExternalObjectByExidAndObjectType",null,e.Exid,e.ObjectType,r)},getFeedEntries:function(e,r){return this._doAllTheThings("getFeedEntries",null,e,r)},getSuggestions:function(e,r){return this._doAllTheThings("getSuggestions",null,e,r)},getAtMentions:function(e){return this._doAllTheThings("getAtMentions",null,e)},getReplies:function(e,r){return this._doAllTheThings("getReplies",null,e,r)},getExternalObject:function(e){var r=this;var t=e.ObjectType+e.Exid;var o=jQuery.Deferred();if(!this._oExternalBObuffer[t]){var s=this.postExternalObject(e);s.promise.done(function(e,s){var n=e.results;r._oExternalBObuffer[t]=n;o.resolve(n)});s.promise.fail(function(e){o.reject(e)})}else{o.resolve(this._oExternalBObuffer[t])}return o.promise()},getFeedEntryFromActivity:function(e){var t=this;var o="/Activities('"+r(e)+"')/FeedEntry";var s=jQuery.Deferred();var n=function(e,r){s.resolve(e,r)};var a=function(e){t._oLogger.error("Failed to get the feed entry: "+e.response.statusText);s.reject(e)};var i={urlParameters:{$expand:"Creator"},async:true,success:n,error:a};this._oCollabModel.read(o,i);return s.promise()},getUserInfoBatch:function(e){var t=this;var o=[];e.forEach(function(e){var s="/Members_Autocomplete?Query='"+r(e)+"'&$expand=MemberProfile";var n="GET";var a=null;var i=null;o.push(t._oCollabModel.createBatchOperation(s,n,a,i))});this._oCollabModel.addBatchReadOperations(o);var s=true;var n=true;var a=jQuery.Deferred();var i=function(e,r){var o=t._oOdataUtil.parseBatchResponse(e.__batchResponses);a.resolve(o,r)};var u=function(e){if(e.response.statusCode===403&&n){t._oCollabModel.refreshSecurityToken(function(){n=false;t._oCollabModel.addBatchReadOperations(o);t._oCollabModel.submitBatch(i,u,s)},function(e){t._oLogger.error("Failed to get member information: "+e.response.statusText);a.reject(e)},true)}else{t._oLogger.error("Failed to get member information: "+e.response.statusText);a.reject(e)}};return{request:this._oCollabModel.submitBatch(i,u,s),promise:a.promise()}},getAtMentionsBatch:function(e){var t=this;var o=10;var s=[];e.forEach(function(e,n){if(n<o){var a="/FeedEntries('"+r(e)+"')/AtMentions";var i="GET";var u=null;var l=null;s.push(t._oCollabModel.createBatchOperation(a,i,u,l))}});this._oCollabModel.addBatchReadOperations(s);var n=true;var a=true;var i=new jQuery.Deferred;var u=function(e,r){var o=t._oOdataUtil.parseBatchResponse(e.__batchResponses);i.resolve(o,r)};var l=function(e){if(e.response.statusCode===403&&a){t._oCollabModel.refreshSecurityToken(function(){a=false;t._oCollabModel.addBatchReadOperations(s);t._oCollabModel.submitBatch(u,l,n)},function(e){t._oLogger.error("Failed to get the feeds @mentions: "+e.response.statusText);i.reject(e)},true)}else{t._oLogger.error("Failed to get the feeds @mentions: "+e.response.statusText);i.reject(e)}};return{request:this._oCollabModel.submitBatch(u,l,n),promise:i}},getSender:function(){var e=this;var r="/Self";var t=jQuery.Deferred();var o=function(r,o){e._oLogger.info("The reply was successfully posted.");t.resolve(r.results)};var s=function(r){e._oLogger.error("Failed to retrieve the sender: "+r.response.statusText,r.stack);t.reject(r)};var n={urlParameters:null,async:true,success:o,error:s};return{request:this._oCollabModel.read(r,n),promise:t.promise()}},getGroupFeedEntries:function(e,t){var o=this;var s="";if(t){s=t}else{s="/Groups('"+r(e)+"')/FeedEntries"}var n=jQuery.Deferred();var a=function(r,t){o._oLogger.info("The feed entries for the group '"+e+"' were retrieved.");n.resolve(r,t)};var i=function(r){o._oLogger.error("Failed to get feed entries for the group '"+e+"'.");n.reject(r)};var u={context:null,urlParameters:{$expand:"Group,Creator,TargetObjectReference"},async:true,success:a,error:i};return{request:this._oCollabModel.read(s,u),promise:n.promise()}},getGroupExternalObjectFeedEntries:function(e,t,o){var s=this;var n="";var a=jQuery.Deferred();if(o){n=o}else{n="/GroupExternalObjects(GroupId='"+r(e)+"',ExternalObjectId='"+r(t)+"')/FeedEntries"}var i=function(r,o){s._oLogger.info("The feed entries for the group object wall was retrieved. Group Id is:'"+e+"', External Object Id is:"+t+".");a.resolve(r,o)};var u=function(r){s._oLogger.error("Failed to get feed entries for the group object wall. Group Id is:'"+e+"', External Object Id is:"+t+".");a.reject(r)};var l={context:null,urlParameters:{$expand:"Group,Creator,TargetObjectReference"},async:true,success:i,error:u};return{request:this._oCollabModel.read(n,l),promise:a.promise()}},addPostToExternalObject:function(e,r){var t=this;var o=this.postFeedEntryToObject(r,e).promise.then(function(e,r){var o=e.results;return t.getFeedEntryFromActivity(o.Id)}).then(function(e,r){var t=e.results;return t}).fail(function(e){return e});return o.promise()},postExternalObject:function(e){var r=this;var t="/ExternalObjects";var o=e;var s=jQuery.Deferred();var n=function(e,t){r._oLogger.info("External object created. "+e.results.Name);s.resolve(e,t)};var a=function(e){r._oLogger.error("Failed to create external object: "+e.response.statusText);s.reject(e)};var i={context:null,urlParameters:null,async:true,success:n,error:a};return{request:this._oCollabModel.create(t,o,i),promise:s.promise()}},postFeedEntryToObject:function(e,r){var t=this;var o="/Activities";var s={};s.__metadata=e.__metadata;var n={Content:r,Object:s,Verb:"comment"};var a=true;var i=jQuery.Deferred();var u=function(e,r){i.resolve(e,r)};var l=function(e){if(e.response.statusCode===403&&a){t._oCollabModel.refreshSecurityToken(function(){a=false;t._oCollabModel.create(o,n,c)},function(e){t._oLogger.error("Failed to get the activity: "+e.response.statusText);i.reject(e)},true)}else{t._oLogger.error("Failed to get the activity: "+e.response.statusText);i.reject(e)}};var c={context:null,urlParameters:null,async:true,success:u,error:l};return{request:this._oCollabModel.create(o,n,c),promise:i.promise()}},postReply:function(e,t){var o=this;var s="/FeedEntries('"+r(e)+"')/Replies";var n={Text:t};var a=true;var i=jQuery.Deferred();var u=function(e,r){o._oLogger.info("The reply was successfully posted.");i.resolve(e)};var l=function(e){if(e.response.statusCode===403&&a){o._oCollabModel.refreshSecurityToken(function(){a=false;o._oCollabModel.create(s,n,c)},function(e){o._oLogger.error("Failed to post reply: "+e.response.statusText,e.stack);i.reject(e)},true)}else{o._oLogger.error("Failed to post reply: "+e.response.statusText,e.stack);i.reject(e)}};var c={context:null,urlParameters:null,async:true,success:u,error:l};return{request:this._oCollabModel.create(s,n,c),promise:i.promise()}},postGroupFeedEntry:function(e,t){var o=this;var s="/Groups('"+r(e)+"')/FeedEntries";var n={Text:t};var a=jQuery.Deferred();var i=function(r,t){o._oLogger.info("Feed entry was successfully posted to Group '"+e+"'.");a.resolve(r,t)};var u=function(r){o._oLogger.error("Failed to post feed entry to group '"+e+"'.");a.reject(r)};var l={context:null,urlParameters:null,async:true,success:i,error:u};return{request:this._oCollabModel.create(s,n,l),promise:a.promise()}},postGroupExternalObjectFeedEntry:function(e,t,o){var s=this;var n="/GroupExternalObjects(GroupId='"+r(e)+"',ExternalObjectId='"+r(t)+"')/FeedEntries";var a={Text:o};var i=jQuery.Deferred();var u=function(r,o){s._oLogger.info("Feed entry was successfully posted to group object wall. Group Id is:'"+e+"', External Object Id is:"+t+".");i.resolve(r,o)};var l=function(r){s._oLogger.error("Failed to post feed entry to group object wall. Group Id is:'"+e+"', External Object Id is:"+t+".");i.reject(r)};var c={context:null,urlParameters:null,async:true,success:u,error:l};return{request:this._oCollabModel.create(n,a,c),promise:i.promise()}},getFeedUpdatesLatestCount:function(e,r){var t=jQuery.Deferred();var o="/ExternalObject_FeedLatestCount";var s={urlParameters:{LatestTopLevelId:"'"+e+"'",Id:"'"+r+"'"},success:function(e,r){t.resolve(e,r)},error:function(e){t.reject(e)}};return t.promise(this._oCollabModel.read(o,s))}});return s});
//# sourceMappingURL=JamDataHandler.js.map