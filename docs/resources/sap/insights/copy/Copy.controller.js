/*!
 * 
		SAP UI development toolkit for HTML5 (SAPUI5)
		(c) Copyright 2009-2015 SAP SE. All rights reserved
	
 */
sap.ui.define(["sap/ui/model/json/JSONModel","sap/ui/model/resource/ResourceModel","../base/Base.controller","../CardHelper","sap/m/MessageToast","sap/base/Log"],function(e,t,r,a,i,o){"use strict";var s=o.getLogger("sap.insights.CardHelper");return r.extend("sap.insights.copy.Copy",{onInit:function(){this._oCopyCardViewModel=new e({oOrgCard:{},oCard:{},aCards:[]});this.getView().setModel(this._oCopyCardViewModel,"copyCardView");var r=sap.ui.getCore().getLibraryResourceBundle("sap.insights");this.getView().setModel(new t({bundle:r}),"i18n");this.i18Bundle=this.getView().getModel("i18n").getResourceBundle();this.smartFormEditable=true},_getCopyCardPage:function(){return this.getView().byId("copyCardPage")},initCopyCard:function(e){var t=e.descriptorContent["sap.app"].id;if(this.oDraftCardParams){this.oDraftCardParams[t]={}}a.getServiceAsync().then(function(e){return e.getUserCards().then(function(e){this._oCopyCardViewModel.setProperty("/aCards",e)}.bind(this))}.bind(this));var r=e;this._oCopyCardViewModel.setProperty("/oOrgCard",r);var i=JSON.parse(JSON.stringify(r));this._oCopyCardViewModel.setProperty("/oCard",i);var o=this._oCopyCardViewModel.createBindingContext("/oCard");this.byId("copyCardPreview").refresh();this.getView().byId("copyCardPage").setBindingContext(o,"copyCardView");this._setSmartFormForCopyCard(e)},handleCopyCardDialogCancel:function(){this.byId("CopyCardsEditTitleField").setValueState("None");this.isCopyCardDialogOpen=false;this._getCopyCardPage().close()},_setSmartFormForCopyCard:function(e){this.byId("copyCardSmartForm").removeAllItems();this._setSmartFormForCardEdit(e)},_handleCardPreviewPress:function(e){if(this._oCopyCardViewModel.getProperty("/oCard").descriptorContent["sap.card"].header.title){var t=this._mergeDraftParamsIncard(this._oCopyCardViewModel.getProperty("/oCard"));this._oCopyCardViewModel.setProperty("/oCard",t);this._oCopyCardViewModel.refresh();this.byId("copyCardPreview").refresh()}},handleCardsInputChange:function(e){var t=e.getSource(),r=t.getValue(),a=t.getId();if(a&&a.includes("CopyCardsEditTitleField")){if(!r){t.setValueState("Error")}else{t.setValueState("None")}this._oCopyCardViewModel.getProperty("/oCard").descriptorContent["sap.card"].header.title=r}else if(a&&a.includes("CopyCardsEditSubTitleField")){this._oCopyCardViewModel.getProperty("/oCard").descriptorContent["sap.card"].header.subTitle=r}},handleCardCopyPress:function(){var e=this.byId("copyCardSmartForm"),t=e&&e.getItems()[0];if(t&&!t.getSmartFields().some(function(e){return e.checkClientError({handleSuccess:true})})){if(this._oCopyCardViewModel.getProperty("/oCard").descriptorContent["sap.card"].header.title){this._getCopyCardPage().setBusy(true);var r=this._oCopyCardViewModel.getProperty("/oOrgCard");var o=r.descriptorContent["sap.app"].id;var d=this._oCopyCardViewModel.getProperty("/oCard");var n=o+"."+Date.now();var C=this._oCopyCardViewModel.getProperty("/aCards")||[];if(C&&C.length){var p=C.reduce(function(e,t){return e.rank>t.rank?e:t});d.descriptorContent["sap.insights"].rank=p.rank+1;d.rank=p.rank+1}this.oDraftCardParams[n]={};d=this._mergeDraftParamsIncard(d);d.descriptorContent["sap.app"].id=n;var h=C.filter(function(e){return e.visibility});d.descriptorContent["sap.insights"].visible=h.length<10?true:false;d.visibility=h.length<10?true:false;d.descriptorContent["sap.insights"].parentAppId=r.descriptorContent["sap.insights"].parentAppId;d.descriptorContent["sap.insights"].isDtCardCopy=false;d.descriptorContent["sap.ui5"].componentName=n;a.getServiceAsync().then(function(e){e.createCard(d.descriptorContent).then(function(){var t=r.descriptorContent["sap.card"].header.title;var a=this.i18Bundle.getText("copyCardSuccessMsg",t);i.show(a);e.getUserCardModel();var o=this.getView().getParent().getPages()[0];this.getView().getParent().to(o)}.bind(this)).catch(function(e){i.show(e.message)}).finally(function(){this._getCopyCardPage().setBusy(false)}.bind(this))}.bind(this))}}else{s.error(this.i18Bundle.getText("cardCopyErrorMsg"))}},onNavBack:function(){this.getView().getParent().back()}})});
//# sourceMappingURL=Copy.controller.js.map