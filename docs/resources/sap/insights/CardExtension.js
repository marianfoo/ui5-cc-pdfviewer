/*!
 * 
		SAP UI development toolkit for HTML5 (SAPUI5)
		(c) Copyright 2009-2015 SAP SE. All rights reserved
	
 * This extension is for OVP Analytical cards delivered in 2208.
 */
sap.ui.define(["sap/ui/integration/Extension","sap/ui/core/format/NumberFormat","sap/fe/navigation/SelectionVariant","sap/base/Log","sap/ui/core/format/DateFormat","sap/ui/core/ValueState","sap/m/ValueColor","sap/ui/integration/util/Utils","sap/m/DynamicDateUtil","sap/ui/core/Core","sap/fe/navigation/NavError","sap/insights/utils/UrlGenerateHelper"],function(e,t,r,a,i,n,o,s,f,l,c,u){"use strict";var g={StateValues:{None:"None",Negative:"Error",Critical:"Warning",Positive:"Success"},ColorValues:{None:"Neutral",Negative:"Error",Critical:"Critical",Positive:"Good"}};var v=a.getLogger("sap.insights.CardExtension");var p=function(e,t){return e&&e.indexOf(t,e.length-t.length)!==-1};var m=function(e,t){var r;if(t){r=t.None;if(e&&e.EnumMember){var a=e.EnumMember;if(p(a,"Negative")){r=t.Negative}else if(p(a,"Critical")){r=t.Critical}else if(p(a,"Positive")){r=t.Positive}}}return r};var d=function(e,t,r,a,i,n,o){var s={};s.EnumMember="None";var f=Number.NEGATIVE_INFINITY;var l=Number.POSITIVE_INFINITY;if(!i&&i!==0&&(r||r===0)){i=r}if(!n&&n!==0&&(a||a===0)){n=a}if(!r&&r!==0){r=f}if(!a&&a!==0){a=l}if(e!==undefined){e=Number(e);if(p(t,"Minimize")||p(t,"Minimizing")){if((n||n===0)&&(a||a===0)){if(e<=parseFloat(n)){s.EnumMember="Positive"}else if(e>parseFloat(a)){s.EnumMember="Negative"}else{s.EnumMember="Critical"}}}else if(p(t,"Maximize")||p(t,"Maximizing")){if((i||i===0)&&(r||r===0)){if(e>=parseFloat(i)){s.EnumMember="Positive"}else if(e<parseFloat(r)){s.EnumMember="Negative"}else{s.EnumMember="Critical"}}}else if(p(t,"Target")){if((n||n===0)&&(a||a===0)&&(i||i===0)&&(r||r===0)){if(e>=parseFloat(i)&&e<=parseFloat(n)){s.EnumMember="Positive"}else if(e<parseFloat(r)||e>parseFloat(a)){s.EnumMember="Negative"}else{s.EnumMember="Critical"}}}}return m(s,o)};var h=function(e,t,r,a){if(!e||!t){return}e=Number(e);if(!a&&e-t>=0){return"Up"}if(!r&&e-t<=0){return"Down"}if(t&&a&&e-t>=a){return"Up"}if(t&&r&&e-t<=r){return"Down"}};var b=function(e,r,a){var i=r||{},n=e;var o=t.getFloatInstance({minFractionDigits:i.NumberOfFractionalDigits,maxFractionDigits:i.NumberOfFractionalDigits,style:"short",showScale:true,shortRefNumber:n});var s=o.format(Number(n)),f=o.getScale()||"";if(!a&&s){var l=s[s.length-1];return l===f?s.slice(0,s.length-1):s}if(a&&i.percentageAvailable){return f+"%"}if(a&&!i.percentageAvailable){return f}return""};var N=function(){var e=this.getCard().getCombinedParameters();return e._headerDataUrl};var S=function(){var e=this.getCard().getCombinedParameters();return e._contentDataUrl};var D=function(e,r,a){var i,n,o;if(isNaN(+e)){return""}if(e==0){o=r}else{o=e}if(a.NumberOfFractionalDigits){n=+a.NumberOfFractionalDigits}if(r){i=r}else if(a.manifestTarget){i=a.manifestTarget}if(!n||n<0){n=0}else if(n>2){n=2}if(i){var s=t.getFloatInstance({minFractionDigits:n,maxFractionDigits:n,style:"short",showScale:true,shortRefNumber:o});return s.format(+i)}};var y=function(e,r,a){var i,n;if(isNaN(+e)){return""}e=+e;if(a.NumberOfFractionalDigits){i=+a.NumberOfFractionalDigits}if(r){n=+r}else if(a.manifestTarget){n=+a.manifestTarget}if(!i||i<0){i=0}else if(i>2){i=2}if(n){var o=(e-n)/n;var s=t.getPercentInstance({style:"short",minFractionDigits:i,maxFractionDigits:i,showScale:true});return s.format(o)}};var O=function(e){var t={};t.EnumMember="None";if(Number(e)===1){t.EnumMember="Negative"}else if(Number(e)===2){t.EnumMember="Critical"}else if(Number(e)===3){t.EnumMember="Positive"}return m(t,g.ColorValues)};var C=function(){var e=arguments[arguments.length-1];var t=1;return d(arguments[0],e.sImprovementDirection,e.bIsDeviationLowBinding?arguments[t++]:e.deviationLow,e.bIsDeviationHighBinding?arguments[t++]:e.deviationHigh,e.bIsToleranceLowBinding?arguments[t++]:e.toleranceLow,e.bIsToleranceHighBinding?arguments[t++]:e.toleranceHigh,e.oCriticalityConfigValues)};var I=function(){var e=arguments[arguments.length-1];var t=1;return h(arguments[0],e.bIsRefValBinding?arguments[t++]:e.referenceValue,e.bIsDownDiffBinding?arguments[t++]:e.downDifference,e.bIsUpDiffBinding?arguments[t++]:e.upDifference)};var P=function(e){var t;var r=arguments[arguments.length-1],a=r&&r.propertyType;switch(a){case"yearmonth":var i=parseInt(e.substr(0,4),10),n=e.substr(4),o=parseInt(n,10)-1;t=new Date(Date.UTC(i,o));break;case"yearquarter":var i=parseInt(e.substr(0,4),10),s=e.substr(4),f=parseInt(s,10)*3-2,o=f-1;t=new Date(Date.UTC(i,o));break;case"yearweek":var i=parseInt(e.substr(0,4),10),l=e.substr(4),c=1+(parseInt(l,10)-1)*7;t=new Date(Date.UTC(i,0,c));break;default:break}return t};var w=function(e,t){if(e){var r=s.parseJsonDateTime(e);return i.getInstance(t).format(new Date(r),t.bUTC)}};var E=function(e,r,a,i){var n;if(e){e.maxFractionDigits=e.numberOfFractionalDigits||0;e.minFractionDigits=e.numberOfFractionalDigits||0;e.style=e.style||"short";e.showScale=e.showScale||true;e.shortRefNumber=e.scaleFactor;n=t.getFloatInstance(e)}var o=[];if(!isNaN(parseFloat(a))&&n){o.push(n.format(a))}else{o.push(a)}if(!isNaN(parseFloat(i))&&n){o.push(n.format(i))}else{o.push(i)}var s="";if(r&&r.length){r.forEach(function(e){if(typeof e==="number"){s=s+o[e]}else{s=s+e}})}return s};var F=function(e,t){if(t==="state"){switch(String(e)){case"1":case"Error":return n.Error;case"2":case"Warning":return n.Warning;case"3":case"Success":return n.Success;case"4":case"Information":return n.Information;default:return n.None}}if(t==="color"){switch(String(e)){case"1":case"Error":return o.Error;case"2":case"Critical":return o.Critical;case"3":case"Good":return o.Good;case"4":case"Neutral":return o.Neutral;default:return o.None}}};var V=function(e,t){var r=this.getCard().getModel().getProperty("/content/d/results")||this.getCard().getModel().getProperty("/d/results")||[];return Math[t].apply(Math,r.map(function(t){return t[e]}))};var M=function(e,t,r){var a=1;var i=2;var n=4;for(var o in e){if(e.hasOwnProperty(o)){var s=e[o];if(s instanceof Date){s=s.toJSON()}else if(Array.isArray(s)||s&&typeof s==="object"){s=JSON.stringify(s)}else if(typeof s==="number"||typeof s==="boolean"){s=s.toString()}if(s===""){if(r&a){v.info("Semantic attribute "+o+" is an empty string and due to the chosen Suppression Behiavour is being ignored.");continue}}if(s===null){if(r&i){throw new v.error("NavigationHandler.INVALID_INPUT")}else{v.warning("Semantic attribute "+o+" is null and ignored for mix in to selection variant");continue}}if(s===undefined){if(r&n){throw new v.error("NavigationHandler.INVALID_INPUT")}else{v.warning("Semantic attribute "+o+" is undefined and ignored for mix in to selection variant");continue}}if(typeof s==="string"||s instanceof String){t.addSelectOption(o,"I","EQ",s)}else{throw new v.error("NavigationHandler.INVALID_INPUT")}}}return t};var T=function(e,t,a){var i=new r(t);var n=new r;if(i.getFilterContextUrl()){n.setFilterContextUrl(i.getFilterContextUrl())}if(i.getParameterContextUrl()){n.setParameterContextUrl(i.getParameterContextUrl())}if(Array.isArray(e)){e.forEach(function(e){M(e,n,a)})}else{M(e,n,a)}var o=i.getParameterNames();var s;for(s=0;s<o.length;s++){if(!n.getSelectOption(o[s])){n.addSelectOption(o[s],"I","EQ",i.getParameter(o[s]))}}var f=i.getSelectOptionsPropertyNames();for(s=0;s<f.length;s++){var l=i.getSelectOption(f[s]);if(!n.getSelectOption(f[s])){for(var c=0;c<l.length;c++){n.addSelectOption(f[s],l[c].Sign,l[c].Option,l[c].Low,l[c].High)}}}return n};function U(e){if(e){if(e.hasOwnProperty("SelectionVariantID")){delete e.SelectionVariantID}else if(e.hasOwnProperty("PresentationVariantID")){delete e.PresentationVariantID}delete e.Text;delete e.ODataFilterExpression;delete e.Version;delete e.FilterContextUrl;delete e.ParameterContextUrl;return e}return e}var x=function(e){try{if(JSON.parse(e)){return true}}catch(e){return false}};var A=function(e){var t=e&&e.length===1,r=e&&e[0];return t&&r["Option"]==="EQ"&&!r["High"]&&r["Low"]&&r["Sign"]==="I"};function H(e,t){var r=this.getCard().getManifestEntry("sap.card"),a=r&&r.configuration.parameters,i=new sap.fe.navigation.SelectionVariant,n=a._relevantODataFilters.value||[];e=e&&JSON.parse(e);var o=e&&e.sensitiveProps,s=r&&r.header.actions[0].parameters.ibnParams,f=r&&r.content.actions[0].parameters.ibnParams;n.forEach(function(e){var t=x(a[e].value);if(t&&!(o&&o[e])){var r=JSON.parse(a[e].value);var n=r.SelectOptions.Ranges;if(n&&n.length){var l=A(n);if(s[e]&&f[e]){if(l){s[e]=n[0].Low;f[e]=n[0].Low}else if(!l){delete f[e];delete s[e];i.massAddSelectOption(e,n)}}else{i.massAddSelectOption(e,n)}}}});if(t){var l=Object.keys(t)||[];for(var c=0;c<l.length;c++){if(o&&o[l[c]]||l[c]==="__metadata"){delete t[l[c]]}}var u=T(t,i&&i.toJSONObject());u=U(u.toJSONObject());e.selectionVariant=u}if(e&&e.sensitiveProps){delete e.sensitiveProps}return JSON.stringify(e)}var L=function(e){var t=i.getDateInstance({pattern:"''yyyy-MM-dd'T'HH:mm:ss.SSS'Z'''",calendarType:"Gregorian"});if(e){var r=t.format(e,true);return String(r).replace(/'/g,"")}};var J=function(e){var t=i.getDateInstance({pattern:"''yyyy-MM-dd'T'HH:mm:ss.SSS''",calendarType:"Gregorian"});var r=e instanceof Date?e:new Date(e);var a=t.format(r);return String(a).replace(/'/g,"")};var _=function(e,t,r){var a=[];if(e.operation==="DATE"&&e.value1){a=f.toDates({values:[e.value1],operator:e.operation})||[]}else{a=f.toDates({values:[],operator:e.operation})||[]}var i=a[0]&&a[0].oDate;var n=a[1]&&a[1].oDate;var o="",s="";if(e["sap:filter-restriction"]==="single-value"){if(e.type==="Edm.DateTime"&&i instanceof Date){o=J(i);if(o){t.massAddSelectOption(r,[{Sign:"I",Option:e.operator,Low:o,High:null}])}}else if(e.type==="Edm.String"){o=L(i);if(o){t.massAddSelectOption(r,[{Sign:"I",Option:e.operator,Low:o,High:null}])}}}else if(e["sap:filter-restriction"]==="interval"){if(e.type==="Edm.DateTime"){if(i instanceof Date){o=J(i)}if(n instanceof Date){s=J(n)}if(o&&s){t.massAddSelectOption(r,[{Sign:"I",Option:e.operator,Low:o,High:s}])}}else if(e.type==="Edm.String"){if(i instanceof Date){o=L(i)}if(n instanceof Date){s=L(n)}if(o&&s){t.massAddSelectOption(r,[{Sign:"I",Option:e.operator,Low:o,High:s}])}}}};function k(e){var t={};var a;if(typeof e==="string"){a=new r(e)}else if(typeof e==="object"){a=e}else{throw new c("NavigationHandler.INVALID_INPUT")}var i=a.getSelectOptionsPropertyNames();for(var n=0;n<i.length;n++){var o=a.getSelectOption(i[n]);if(o.length===1&&o[0].Sign==="I"&&o[0].Option==="EQ"){t[i[n]]=o[0].Low}}var s=a.getParameterNames();for(var n=0;n<s.length;n++){var f=a.getParameter(s[n]);t[s[n]]=f}return t}function j(e,t){var a=this.getCard().getManifestEntry("sap.card"),i=a&&a.configuration.parameters,n=new r,o=i._relevantODataFilters.value||[],s=i._mandatoryODataParameters.value||[],f=e&&JSON.parse(e)||{},l=f.parameters||{},c=l.ibnParams||{},u=c.sensitiveProps||{};var g={};s.forEach(function(e){var t=x(i[e].value);if(t&&!u[e]){var r=JSON.parse(i[e].value);if(r&&r.operation){_(r,n,e)}}});o.forEach(function(e){var t=x(i[e].value);if(t&&!u[e]){var r=JSON.parse(i[e].value);if(r&&r.operation){_(r,n,e)}else{var a=r.SelectOptions.Ranges||r.SelectOptions&&r.SelectOptions[0]&&r.SelectOptions[0].Ranges;if(a&&a.length){var o=A(a);if(o){c[e]=a[0].Low}else{if(c[e]&&!o){delete c[e]}n.massAddSelectOption(e,a)}}}}});var v=t||{};var p=Object.keys(v)||[];for(var m=0;m<p.length;m++){if(u&&u[p[m]]||p[m]==="__metadata"){delete v[p[m]]}}var d=T(v,n&&n.toJSONObject());var h=k(d);d=U(d.toJSONObject());if(c.presentationVariant){g["presentationVariant"]=c.presentationVariant}if(d.Parameters.length||d.SelectOptions.length){g["selectionVariant"]=d}if(!l.ibnParams){l.ibnParams={}}if(g["selectionVariant"]||g["presentationVariant"]){l.ibnParams["sap-xapp-state-data"]=JSON.stringify(g)}if(c&&c.sensitiveProps){delete c.sensitiveProps}for(var b in h){l.ibnParams[b]=h[b]}delete c.selectionVariant;delete c.presentationVariant;return f.parameters}function B(){var e={descriptorContent:{}};e.descriptorContent=this.getCard().getManifestEntry("/");var t=R(e,"header");return t}function G(){var e={descriptorContent:{}};e.descriptorContent=this.getCard().getManifestEntry("/");var t=e.descriptorContent["sap.card"]["configuration"]["csrfTokens"]["token1"].data.request.url;var r=R(e,"content");if(e.descriptorContent["sap.card"]["data"]["request"]&&e.descriptorContent["sap.card"]["data"]["request"]["batch"]){return r}return t+"/"+r}function R(e,t){var r=u.processPrivateParams(e,null,true);if(t==="header"&&r.header){return r.header}else if(t==="content"&&r.content){return r.content}}return e.extend("sap.insights.CardExtension",{init:function(){e.prototype.init.apply(this,arguments);this.setFormatters({kpiformatter:b,formatHeaderUrl:N.bind(this),formatContentUrl:S.bind(this),returnPercentageChange:y,targetValueFormatter:D,kpiValueCriticality:O,formatValueColor:C,formatTrendIcon:I,formatDateValue:P,addPropertyValueToAppState:H.bind(this),getNavigationContext:j.bind(this),formatDate:w,formatNumber:E,formatCriticality:F,getMinMax:V.bind(this),formatHeaderDataUrlForSemanticDate:B.bind(this),formatContentDataUrlForSemanticDate:G.bind(this)})},loadDependencies:function(){var e=this.getCard(),t=e.getManifestEntry("/sap.card/type");if(t!=="Analytical"){return Promise.resolve()}return l.loadLibrary("sap.viz",{async:true}).then(function(){return new Promise(function(e){sap.ui.require(["sap/insights/OVPChartFormatter"],function(t){t.registerCustomFormatters();e()})})})}})});
//# sourceMappingURL=CardExtension.js.map