/*!
 * 
		SAP UI development toolkit for HTML5 (SAPUI5)
		(c) Copyright 2009-2015 SAP SE. All rights reserved
	
 */
sap.ui.define(["sap/ui/model/resource/ResourceModel","../CardHelper","sap/m/MessageBox","sap/m/MessageToast","../base/Base.controller","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/base/util/UriParameters","sap/m/FormattedText","sap/m/Link"],function(e,t,i,r,s,n,a,o,d,l){var c=500;return s.extend("sap.insights.selection.Selection",{onInit:function(){var t=sap.ui.getCore().getLibraryResourceBundle("sap.insights");this.getView().setModel(new e({bundle:t}),"i18n");this.i18Bundle=this.getView().getModel("i18n").getResourceBundle();this.oNavCon=this.getView().byId("selectionNavCon");this.oNavCon.setBusy(true);this.initUserCards()},showSelectionDialog:function(e){this.orgCard=e;this.getView().getModel("view").setProperty("/selectionDialogOpen",true);this._getSelectionDialog().open()},_getSelectionDialog:function(){return this.getView().byId("insightsSelectionDialog")},_getSelectionFragment:function(){return this.getView().byId("flexContainerCardsContent")},_getCardListPage:function(){return this.getView().byId("insightCardPage")},_getPreviewPage:function(){return this.getView().byId("previewPage")},closeDialog:function(){t.getServiceAsync("UIService").then(function(e){this.oNavCon.to(this._getCardListPage());this.getView().getModel("view").setProperty("/selectionDialogOpen",false);this._getSelectionDialog().close();e.showCardPreview(this.orgCard,true)}.bind(this))},handleCardListItemPress:function(e,t){var i=this.getView().getModel("view");if(e){this.currentCardPreviewPath=e.getSource().getBindingContextPath()}else if(t){this.currentCardPreviewPath=t.getBindingContextPath()}var r=i.getProperty(this.currentCardPreviewPath).descriptorContent["sap.card"].header.title;i.setProperty("/selectedCardTitle",r);var s=this.getView().byId("previewPage");this.oNavCon.to(s);var n=i.createBindingContext(this.currentCardPreviewPath);this.byId("previewCard").setBindingContext(n,"view");this.byId("insightsPreviewOverflowLayer").setBindingContext(n,"view");var a=this.byId("smartForm");a.removeAllItems();this._setSmartFormForCardEdit(i.getProperty(this.currentCardPreviewPath));this.oCardHelperServiceInstance.getParentAppDetails(i.getProperty(this.currentCardPreviewPath)).then(function(e){i.setProperty("/parentAppTitle",e.title);i.setProperty("/parentAppUrl",e.semanticURL);i.setProperty("/parentAppsectionVisible",this.getIsNavigationEnabled(e))}.bind(this))},setCopyVisible:function(e){var t=this.getView().getModel("view");t.setProperty("/showCopyButton",false);if(e){var i=e["sap.app"].dataSources;var r=i.filterService;var s=r&&r.uri;var n=r&&r.settings;if(s&&n&&n.odataVersion==="2.0"){t.setProperty("/showCopyButton",true)}}},handleCardVisibilityToggle:function(e){this._getSelectionFragment().setBusy(true);var t=e.getSource();var i=t.getBindingContext("view").getPath();var s=this.getView().getModel("view").getProperty(i);var n=t.getSelected();s.visibility=n;s.descriptorContent["sap.insights"].visible=n;this.setSelectedCards();this.oCardHelperServiceInstance.updateCard(s.descriptorContent).then(function(){this._getSelectionFragment().setBusy(false)}.bind(this)).catch(function(e){s.visibility=!n;s.descriptorContent["sap.insights"].visible=!n;this.getView().getModel("view").refresh();this._getSelectionFragment().setBusy(false);r.show(e.message)}.bind(this))},setSelectedCards:function(){var e=this.byId("insightsCardsListTable");if(e){this.getView().getModel("view").setProperty("/visibleCardCount",this.getSelectedCards().length)}},onEditInsightCardsDrop:function(e){var t=e.getParameter("draggedControl"),i=t.getParent().indexOfItem(t),r=e.getParameter("droppedControl"),s=t.getParent().indexOfItem(r);if(i!==s){var n=this._setCardsRanking(i,s);try{this._getSelectionFragment().setBusy(true);this.oCardHelperServiceInstance.setCardsRanking(n).then(function(e){var t=this.getView().getModel("view");t.setProperty("/cards",e);t.setProperty("/cardCount",e.length);this._createOdataModelsforDialog(e);this.setDTCards()}.bind(this)).finally(function(){this._getSelectionFragment().setBusy(false)}.bind(this))}catch(e){this._getSelectionFragment().setBusy(false)}}},handleCardDeleteConfirm:function(){i.show(this.i18Bundle.getText("deleteCardMsg"),{icon:i.Icon.WARNING,title:this.i18Bundle.getText("delete"),actions:[i.Action.DELETE,i.Action.CANCEL],emphasizedAction:i.Action.DELETE,onClose:function(e){if(e===i.Action.DELETE){this.handleCardDelete(this.currentCardPreviewPath)}}.bind(this)})},handleCardDelete:function(e){var t=this.getView().getModel("view");this._getPreviewPage().setBusy(true);var i=t.getProperty(e);var s=i.descriptorContent["sap.app"].id;var n=i.descriptorContent["sap.card"].header.title;this.oCardHelperServiceInstance.deleteCard(s).then(function(){this._getPreviewPage().setBusy(false);r.show(this.i18Bundle.getText("deleteCardSuccess",n));var e=t.getProperty("/cards").filter(function(e){return e.descriptorContent["sap.app"].id!==s});var i=e.filter(function(e){return e.visibility});t.setProperty("/cards",e);t.setProperty("/cardCount",e.length);t.setProperty("/visibleCardCount",i.length);this.setDTCards();this.oNavCon.back();this.setSelectedCards()}.bind(this)).catch(function(e){this._getPreviewPage().setBusy(false);r.show(e.message)}.bind(this))},getSelectedCards:function(){var e=this.getView().getModel("view").getProperty("/cards");e=e.filter(function(e){return e.visibility});return e},initUserCards:function(){return t.getServiceAsync().then(function(e){this.oCardHelperServiceInstance=e;return this.oCardHelperServiceInstance.getUserCardModel().then(function(e){this.getView().setModel(e,"view");var t=this.getView().getModel("view").getProperty("/cards");var i=0;t.forEach(function(e){if(e.visibility){if(++i>10){e.visibility=false}}if(e.rank===0){e.rank=500}});var r=this.getView().getModel("view");r.setProperty("/selectionDialogOpen",false);r.setProperty("/cards",t);this.oSmartFormMap={};this._createOdataModelsforDialog(t);this.setDTCards();var s=this.isDeleteAllCardsEnabled();r.setProperty("/deleteAllEnabled",s);this.oNavCon.setBusy(false);return Promise.resolve()}.bind(this))}.bind(this))},_setCardsRanking:function(e,t){var i=this.byId("insightsCardsListTable").getItems().map(function(e){return e.getBindingContext("view").getObject()}),r=[];var s=function(e){var t=i[e].rank;if(t!==c){r.push({id:i[e+1].descriptorContent["sap.app"].id,rank:t+1})}else{r.push({id:i[e+1].descriptorContent["sap.app"].id,rank:null});if(e){s(e-1)}else{r.push({id:i[e].descriptorContent["sap.app"].id,rank:null})}}};var n=function(){r.forEach(function(e,t){if(t===0){if(!e.rank){r[t].rank=1}}else{e.rank=r[t-1].rank+1}})};var a=i[t].rank;if(a!==c){if(e<t){r.push({id:i[e].descriptorContent["sap.app"].id,rank:a+1})}else{r.push({id:i[e].descriptorContent["sap.app"].id,rank:a})}}else{if(t===0){r.push({id:i[e].descriptorContent["sap.app"].id,rank:1})}else{var o=i.splice(e,1);i.splice(t,0,o[0]);s(t-1);r.reverse();n();r.reverse()}}return{Ranking:r}},onNavBack:function(){this.oNavCon.back()},navigateToCopyCard:function(){var e=this.getView().byId("insightsCopyCardView");var t=this.getView().getModel("view").getProperty(this.currentCardPreviewPath);this.oNavCon.to(e);e.getController().initCopyCard(t)},onCardSearch:function(e){var t=e.getSource().getValue();var i=new n("descriptorContent/sap.card/header/title",a.Contains,t);var r=[];r.push(i);var s=this.byId("insightsCardsListTable");var o=s.getBinding("items");o.filter(r,"Application")},refreshCardList:function(){var e=this.isDeleteAllCardsEnabled(),t;if(e){t=this.i18Bundle.getText("deleteAllCardsMsg")}else{var r=this.getView().getModel("view").getProperty("/DTCards");var s="<p>"+this.i18Bundle.getText("refreshAllCards")+"</p>";s+="<ul>";r.forEach(function(e){s+='<li class="sapUiTinyMarginBottom">'+e.descriptorContent["sap.card"].header.title+"</li>"});s+="</ul>";t=new d({htmlText:s})}i.show(t,{icon:i.Icon.WARNING,title:this.i18Bundle.getText("refresh"),actions:[i.Action.OK,i.Action.CANCEL],emphasizedAction:i.Action.OK,onClose:function(t){if(t===i.Action.OK){this.oNavCon.setBusy(true);this.oCardHelperServiceInstance._refreshUserCards(e).then(function(){this.initUserCards()}.bind(this))}}.bind(this)})},isDeleteAllCardsEnabled:function(){var e=o.fromQuery(window.location.search).get("delete-all-cards")||"";return e.toUpperCase()==="TRUE"?true:false},navigateToParentApp:function(){var e=this.getView().getModel("view");var t=e.getProperty("/parentAppUrl");sap.ushell.Container.getServiceAsync("CrossApplicationNavigation").then(function(e){e.toExternal({target:{shellHash:t}});this.oNavCon.back()}.bind(this))},navigateToCardPreview:function(e){var t=this.getView().getModel("view");var i=t.getProperty("/cards");var r=i.findIndex(function(t){return t.descriptorContent["sap.app"].id===e});if(r!==-1){var s=this.getView().byId("insightsCardsListTable").getItems();this.handleCardListItemPress(null,s[r])}},getIsNavigationEnabled:function(e){return sap.ushell.Container.getServiceAsync("CrossApplicationNavigation").then(function(t){return t.isNavigationSupported([{target:{semanticObject:e.semanticObject,action:e.action}}])}).then(function(e){return e[0].supported||false})},setDTCards:function(){var e=this.getView().getModel("view");var t=e.getProperty("/cards");var i=t.filter(function(e){return e.descriptorContent["sap.insights"].isDtCardCopy});e.setProperty("/DTCards",i)}})});
//# sourceMappingURL=Selection.controller.js.map