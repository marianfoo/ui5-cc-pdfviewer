/*!
 * 
		SAP UI development toolkit for HTML5 (SAPUI5)
		(c) Copyright 2009-2015 SAP SE. All rights reserved
	
 */
sap.ui.define(["sap/ui/core/mvc/Controller","sap/ui/model/json/JSONModel","sap/ui/model/resource/ResourceModel","sap/m/MessageToast","../CardHelper"],function(e,t,i,r,s){return e.extend("sap.insights.preview.Preview",{onInit:function(){this.getView().setModel(new t({descriptor:{}}),"cardPreviewModel");this.I18_BUNDLE=sap.ui.getCore().getLibraryResourceBundle("sap.insights");this.getView().setModel(new i({bundle:this.I18_BUNDLE}),"i18n")},save:function(){var e=this.getView().getModel("cardPreviewModel").getProperty("/descriptor");if(e["sap.card"].header.title){e["sap.insights"].visible=true;this._getPreviewDialog().setBusy(true);s.getServiceAsync().then(function(t){t.createCard(e).then(function(e){r.show("Card created Successfully.");this._getPreviewDialog().setBusy(false);this._getPreviewDialog().close()}.bind(this)).catch(function(e){r.show(e.message);this._getPreviewDialog().setBusy(false)}.bind(this))}.bind(this))}},cancel:function(){this._getPreviewDialog().close()},handleTitleChange:function(e){var t=e.getSource();var i=t.getValue();var r=this.getView().byId("insightsCard");if(i){t.setValueState("None");t.setValueStateText("");r.getCardHeader().setTitle(i)}else{t.setValueState("Error");t.setValueStateText(this.I18_BUNDLE.getText("INT_Preview_Title_ValueStateText"))}},handleSubTitleChange:function(e){var t=e.getSource();var i=t.getValue();var r=this.getView().byId("insightsCard");r.getCardHeader().setSubtitle(i)},handleVisibilityChange:function(e){var t=this.getView().getModel("cardPreviewModel");var i=e.getParameter("state");var r=t.getProperty("/descriptor");r["sap.insights"].visible=i;t.setProperty("/descriptor",r)},showCardSelectionDialog:function(){this._getPreviewDialog().close();var e=this.getView().getModel("cardPreviewModel");var t=e.getProperty("/descriptor");s.getServiceAsync("UIService").then(function(e){e._showCardSelectionDialog(t)})},_getPreviewDialog:function(){return this.getView().byId("previewDialog")},_onCardManifestApplied:function(e){var t=e.getSource();t.attachEvent("_error",this._onCardLoadFailure.bind(this,t));t.attachEvent("stateChanged",this._onCardStateChanged.bind(this,t))},_onCardLoadFailure:function(e,t){if(t&&t.getParameters()){if(t.getParameters().message&&(t.getParameters().message.includes("Internal Server Error")||t.getParameters().message.includes("Data service unavailable. timeout"))){this.bCardError=true}}},_onCardStateChanged:function(e){var t=this.getView().getModel("cardPreviewModel");if(e.isReady()&&!this.bCardError){t.setProperty("/bAddButton",true)}else{t.setProperty("/bAddButton",false)}},showPreview:function(e,t){var i=this.getView().getModel("cardPreviewModel");return s.getServiceAsync().then(function(r){return r.getUserCards().then(function(r){var s=r.filter(function(e){return e.visibility});if(s.length>9){e["sap.insights"].visible=false}i.setProperty("/descriptor",e);if(!t){i.setProperty("/bAddButton",false)}this.bCardError=false;this._getPreviewDialog().open();return Promise.resolve()}.bind(this))}.bind(this))}})});
//# sourceMappingURL=Preview.controller.js.map