// Copyright (c) 2009-2022 SAP SE, All Rights Reserved
sap.ui.define(["sap/base/Log","sap/m/Bar","sap/m/Button","sap/m/ButtonRenderer","sap/m/Dialog","sap/m/DisplayListItem","sap/m/library","sap/m/List","sap/m/Text","sap/m/ObjectIdentifier","sap/ui/core/IconPool","sap/ui/Device","sap/ui/layout/VerticalLayout","sap/ui/model/json/JSONModel","sap/ui/thirdparty/jquery","sap/ushell/Config","sap/ushell/EventHub","sap/ushell/library","sap/ushell/resources","sap/ushell/ui/launchpad/AccessibilityCustomData","sap/ushell/ui/launchpad/ActionItem","sap/ushell/ui/utils"],function(e,t,o,n,r,i,s,a,l,u,d,g,p,h,jQuery,c,y,f,v,m,B,P){"use strict";var M=s.ButtonType;var C=B.extend("sap.ushell.ui.footerbar.UserPreferencesButton",{metadata:{library:"sap.ushell"},renderer:"sap.m.ButtonRenderer"});C.prototype.init=function(){if(B.prototype.init){B.prototype.init.apply(this,arguments)}this.setIcon("sap-icon://person-placeholder");this.translationBundle=v.i18n;this.setText(this.translationBundle.getText("userSettings"));this.setTooltip(this.translationBundle.getText("settings_tooltip"));this.attachPress(this.showUserPreferencesDialog);this.oModel=c.createModel("/core/userPreferences",h);this.setModel(this.oModel)};C.prototype.createDialog=function(){var e=this;this.saveButton=this._createSaveButton();this.cancelButton=this._createCancelButton();this.oDialog=new r({id:"userPreferencesDialog",title:"{/dialogTitle}",contentWidth:"29.6rem",content:null,contentHeight:"17rem",buttons:[this.saveButton,this.cancelButton],afterClose:function(){this._destroyDialog();this.oUser.resetChangedProperties()}.bind(e),stretch:g.system.phone}).addStyleClass("sapUshellUserPreferencesDialog").addStyleClass("sapContrastPlus");this._addDialogBackButton();this.oDialog.setModel(this.getModel());this.oDialog.addCustomData(new m({key:"aria-label",value:e.translationBundle.getText("Settings_Dialog_Main_label"),writeToDom:true}));this.oDialog.addContent(this._getOriginalDialogContent())};C.prototype._getOriginalDialogContent=function(){if(!this.oInitialContent){var e,t;e=this._getUserDetailsControl();t=this._getEntryListControl();this.oInitialContent=new p("userPreferencesLayout",{content:[e,t],width:"100%"})}return this.oInitialContent};C.prototype._getEntryListControl=function(){var e=this._getUserPrefEntriesTemplate(),t=this.getModel()&&this.getModel().getProperty("/enableHelp"),o=this,n,r=this.oUser.getFullName(),i,s=new a("userPrefEnteryList",{items:{path:"/entries",template:e}});s.addCustomData(new m({key:"aria-label",value:o.translationBundle.getText("Settings_EntryList_label")+r,writeToDom:true}));i=s.onAfterRendering;s.onAfterRendering=function(){var e=this.getItems(),r;i.apply(this,arguments);for(n=0;n<e.length;n++){r=e[n].getBindingContext().getPath();if(!o.getModel().getProperty(r+"/valueResult")){o._setEntryValueResult(r)}if(t){o._addXRayHelpId(r,e[n])}}};return s};C.prototype._addXRayHelpId=function(e,t){var o=this.getModel().getProperty(e+"/entryHelpID");if(o){t.addStyleClass("help-id-"+o)}};C.prototype._setEntryValueResult=function(e){var t=this,o=this.getModel().getProperty(e+"/editable"),n=this.getModel().getProperty(e+"/valueArgument");if(typeof n==="function"){this.getModel().setProperty(e+"/valueResult",this.translationBundle.getText("genericLoading"));this.getModel().setProperty(e+"/editable",false);var r=n();r.done(function(n){t.getModel().setProperty(e+"/editable",o);t.getModel().setProperty(e+"/visible",typeof n==="object"?!!n.value:true);t.getModel().setProperty(e+"/valueResult",typeof n==="object"?n.displayText:n)});r.fail(function(){t.getModel().setProperty(e+"/valueResult",t.translationBundle.getText("loadingErrorMessage"))})}else if(n){this.getModel().setProperty(e+"/valueResult",n);this.getModel().setProperty(e+"/editable",o)}else{this.getModel().setProperty(e+"/valueResult",this.translationBundle.getText("loadingErrorMessage"))}};C.prototype._emitEntryOpened=function(e){var t=y.last("UserSettingsOpened")||{},o=e.split("/").pop();t[o]=true;y.emit("UserSettingsOpened",t)};C.prototype._getUserPrefEntriesTemplate=function(){var e=this,t,o=function(t){var o={};o=jQuery.extend(true,{},{},t);sap.ui.require(["sap/m/FlexBox","sap/m/FlexAlignItems","sap/m/FlexJustifyContent","sap/m/BusyIndicator"],function(t,n,r,i){var s=true,a,u,d=o.getSource().getLabel(),g=o.getSource().getBindingContext().getPath();e.getModel().setProperty("/activeEntryPath",g);e._setDetailedEntryModeMode(true,g,d,g);e.oDialog.removeAllContent();u=e.getModel().getProperty(g+"/contentResult");if(u){a=sap.ui.getCore().byId(u);e.oDialog.addContent(a);e._emitEntryOpened(g)}else{var p=null,h,c=true,y=false,f=e.getModel().getProperty(g+"/contentFunc");if(typeof f==="function"){e._emitEntryOpened(g);h=f();h.done(function(t){c=false;if(y===true){e.oDialog.removeAllContent();p.destroy()}if(t instanceof sap.ui.core.Control){e.getModel().setProperty(g+"/contentResult",t.getId());e.oDialog.addContent(t)}else{s=false}});h.fail(function(){c=false;if(y===true){e.oDialog.removeAllContent();p.destroy()}s=false});h.always(function(){if(s===false){var o=new t("userPrefErrorFlexBox",{height:"5rem",alignItems:n.Center,justifyContent:r.Center,items:[new l("userPrefErrorText",{text:e.translationBundle.getText("loadingErrorMessage")})]});e.getModel().setProperty(g+"/contentResult",o.getId());e.oDialog.addContent(o)}});if(c===true){p=new i("userPrefLoadingBusyIndicator",{size:"2rem"});e.oDialog.addContent(p);y=true}}}})};t=new i({label:"{title}",value:"{valueResult}",tooltip:{path:"valueResult",formatter:function(e){return typeof e==="string"?e:""}},type:{path:"editable",formatter:function(e){return e===true?"Navigation":"Inactive"}},visible:{path:"visible",formatter:function(e){return e!==undefined?e:true}},press:o,customData:new m({key:"aria-label",value:{parts:[{path:"title"},{path:"valueResult"}],formatter:function(e,t){t=t||"";return e+" "+t}},writeToDom:true})});return t};C.prototype._getUserDetailsControl=function(){return new u({title:this.oUser.getFullName(),text:this.oUser.getEmail()}).addStyleClass("sapUshellUserPrefUserIdentifier")};C.prototype._createCancelButton=function(){var e=this;return new o({id:"cancelButton",text:{parts:["/entries"],formatter:function(t){if(!t){return""}var o=t.some(function(e){return e.editable});return o>0?e.translationBundle.getText("cancelBtn"):e.translationBundle.getText("close")}},press:e._dialogCancelButtonHandler.bind(e),visible:true})};C.prototype._createSaveButton=function(){var e=this;return new o({id:"saveButton",text:this.translationBundle.getText("saveBtn"),type:M.Emphasized,press:e._dialogSaveButtonHandler.bind(e),visible:{parts:["/entries"],formatter:function(e){if(!e){return false}return e.some(function(e){return e.editable})}}})};C.prototype._setDetailedEntryModeMode=function(e,t,o,n){this.getModel().setProperty("/isDetailedEntryMode",!!e);this.getModel().setProperty("/dialogTitle",o)};C.prototype.showUserPreferencesDialog=function(){this.oUser=sap.ushell.Container.getUser();this.createDialog();this.oDialog.open()};C.prototype._dialogBackButtonHandler=function(){var e=this;e.getModel().setProperty("/isDetailedEntryMode",false);e.getModel().setProperty("/dialogTitle",e.translationBundle.getText("userSettings"));e.oDialog.removeAllContent();e.oDialog.addContent(e._getOriginalDialogContent());e._setEntryValueResult(e.getModel().getProperty("/activeEntryPath"));e.getModel().setProperty("/activeEntryPath",null)};C.prototype._destroyDialog=function(){this.oHeadBar.destroy();this.oInitialContent.destroy();this.oInitialContent=null;this._modelCleanUpToInitial();this._entriesCleanUp();this.oDialog.destroy();this.saveButton.destroy();this.cancelButton.destroy()};C.prototype._entriesCleanUp=function(){var e,t=this.getModel().getProperty("/entries"),o,n;for(e=0;e<t.length;e++){o=t[e].contentResult;delete t[e].contentResult;if(o){n=sap.ui.getCore().byId(o);n.destroy();n=null}t[e].valueResult=null}this.getModel().setProperty("/entries",t)};C.prototype._modelCleanUpToInitial=function(){this.getModel().setProperty("/isDetailedEntryMode",false);this.getModel().setProperty("/dialogTitle",this.translationBundle.getText("userSettings"))};C.prototype._dialogSaveButtonHandler=function(){var t=this,o,n=this.getModel().getProperty("/entries"),r=P.saveUserPreferenceEntries(n);o=this.getModel().getProperty("/isDetailedEntryMode");if(o){this.getModel().setProperty("/activeEntryPath",null)}r.done(function(){t._showSaveMessageToast()});r.fail(function(o){var n,r="";if(o.length===1){n=t.translationBundle.getText("savingEntryError")+" "}else{n=t.translationBundle.getText("savingEntriesError")+"\n"}o.forEach(function(e){n+=e.entry+"\n";r+="Entry: "+e.entry+" - Error message: "+e.message+"\n"});sap.ushell.Container.getServiceAsync("Message").then(function(e){e.error(n,t.translationBundle.getText("Error"))});e.error("Failed to save the following entries",r,"sap.ushell.ui.footerbar.UserPreferencesButton")});this.oDialog.close();this._destroyDialog()};C.prototype._dialogCancelButtonHandler=function(){var e,t=this.getModel().getProperty("/entries");for(e=0;e<t.length;e++){if(t[e]&&t[e].onCancel){t[e].onCancel()}}this.oDialog.close();this._destroyDialog()};C.prototype._addDialogBackButton=function(){var e=this,n=new o("userPrefBackBtn",{visible:"{/isDetailedEntryMode}",icon:d.getIconURI("nav-back"),press:e._dialogBackButtonHandler.bind(e),tooltip:this.translationBundle.getText("feedbackGoBackBtn_tooltip")}),r=new l("userPrefTitle",{text:"{/dialogTitle}"});this.oHeadBar=new t({contentLeft:[n],contentMiddle:[r]});this.oDialog.setCustomHeader(this.oHeadBar)};C.prototype._showSaveMessageToast=function(){var e=this;sap.ui.require(["sap/m/MessageToast"],function(t){var o=e.translationBundle.getText("savedChanges");t.show(o,{duration:3e3,width:"15em",my:"center bottom",at:"center bottom",of:window,offset:"0 -50",collision:"fit fit"})})};return C});
//# sourceMappingURL=UserPreferencesButton.js.map