// Copyright (c) 2009-2022 SAP SE, All Rights Reserved
sap.ui.define(["sap/ushell/library","sap/base/util/deepClone","sap/ui/core/XMLComposite","sap/ui/model/json/JSONModel","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/ui/core/Fragment","sap/ui/Device","sap/m/Token","sap/ushell/resources","sap/ushell/Config"],function(e,t,o,n,i,s,a,r,l,d,u){"use strict";var p=e.ContentNodeType;var g=o.extend("sap.ushell.ui.ContentNodeSelector",{metadata:{library:"sap.ushell",associations:{labelId:{type:"sap.ui.core.Control",multiple:false}},events:{selectionChanged:{},valueHelpEndButtonPressed:{}}}});g.prototype.init=function(){this._oModel=new n({items:[],suggestions:[],isSpaces:u.last("/core/spaces/enabled")});this._oDeviceModel=new n(r);this.setModel(this._oModel,"_internal");this.setModel(this._oDeviceModel,"_device");this.setModel(d.getTranslationModel(),"_i18n");var e=this.getAggregation("_content");e.addValidator(this._validateItem.bind(this));this.setBusyIndicatorDelay(0);this._loadContentNodes().then(this._overwriteLabel.bind(this))};g.prototype._overwriteLabel=function(){var e=this.getLabelId();var t=sap.ui.getCore().byId(e);if(t&&typeof t.setText==="function"){if(this._oModel.getProperty("/isSpaces")){t.setText(d.i18n.getText("contentNodeSelectorHomepagePages"))}else{t.setText(d.i18n.getText("contentNodeSelectorHomepageGroups"))}}if(t&&typeof t.setRequired==="function"&&t.isPropertyInitial("required")){t.setRequired(true)}if(t&&typeof t.setLabelFor==="function"){t.setLabelFor(this)}};g.prototype.exit=function(){this._oModel.destroy();this._oDeviceModel.destroy()};g.prototype.getSelectedContentNodes=function(){var e=this.getAggregation("_content");var o=e.getTokens();return o.map(function(e){var o=e.getBindingContext("_internal").getObject();var n=t(o);delete n.selected;delete n.spaceTitles;return n})};g.prototype._getMyHomeEnablement=function(){return new Promise(function(e,t){var o=u.last("/core/spaces/myHome/enabled");var n=sap.ushell.Container.getUser().getShowMyHome();e(o&&n)})};g.prototype._filterPersonalizableContentNodes=function(e){if(!Array.isArray(e)){return[]}return e.reduce(function(e,t){if(this._bShowOnlyMyHome&&t.id!==this._sMyHomeSpaceId&&t.id!==this._sMyHomePageId){return e}t.children=this._filterPersonalizableContentNodes(t.children);if(t.type===p.HomepageGroup||t.type===p.Space||t.type===p.Page&&t.isContainer){e.push(t)}return e}.bind(this),[])};g.prototype._loadContentNodes=function(){this.setBusy(true);return Promise.all([sap.ushell.Container.getServiceAsync("Bookmark"),this._getMyHomeEnablement()]).then(function(e){var o=e[0];var n=e[1];var i=u.last("/core/shell/enablePersonalization");this._bShowOnlyMyHome=!i&&n;this._sMyHomeSpaceId=u.last("/core/spaces/myHome/myHomeSpaceId");this._sMyHomePageId=u.last("/core/spaces/myHome/myHomePageId");return o.getContentNodes().then(function(e){e=t(e);e=this._filterPersonalizableContentNodes(e);g._normalizeContentNodes(e);this._oModel.setProperty("/items",e);var o=g._getSuggestions(e);for(var n=0;n<o.length;n++){o[n].selected=false}this._oModel.setProperty("/suggestions",o);this.setBusy(false)}.bind(this))}.bind(this))};g.prototype._showValueHelp=function(e){var t=e.getSource();var o=t.getValue();if(!this._oValueHelpDialog){a.load({id:this.getId()+"-ValueHelpDialog",name:"sap.ushell.ui.ContentNodeSelectorValueHelp",controller:this}).then(function(e){this.addDependent(e);this._oValueHelpDialog=e;this._openValueHelpDialog(o)}.bind(this))}else{this._openValueHelpDialog(o)}};g.prototype._openValueHelpDialog=function(e){var t=a.byId(this.getId()+"-ValueHelpDialog","ContentNodesTree");t.expandToLevel(1);this._oValueHelpDialog.open();var o=a.byId(this.getId()+"-ValueHelpDialog","ContentNodesSearch");o.setValue(e);this._onValueHelpSearch()};g.prototype._onValueHelpSearch=function(){var e=a.byId(this.getId()+"-ValueHelpDialog","ContentNodesSearch");var t=e.getValue();var o=a.byId(this.getId()+"-ValueHelpDialog","ContentNodesTree");var n=o.getBinding("items");n.filter(new i({path:"label",operator:s.Contains,value1:t}))};g.prototype._onValueHelpBeginButtonPressed=function(){var e=a.byId(this.getId()+"-ValueHelpDialog","ContentNodesTree");var t=e.getSelectedContextPaths();var o=this.getAggregation("_content");o.destroyTokens();var n;var i;for(var s=0;s<t.length;s++){i=t[s];var r=this.getModel("_internal");var l=o.getAggregation("tokens").map(function(e){return e.getProperty("key")}).indexOf(r.getProperty(i).id);if(l<0){n=this._createToken(i);o.addValidateToken({token:n})}}o.setValue("");this._oValueHelpDialog.close()};g.prototype._onValueHelpEndButtonPressed=function(){this.fireValueHelpEndButtonPressed();this._oValueHelpDialog.close()};g.prototype._onTokenUpdate=function(e){var t=e.getParameter("addedTokens");var o=e.getParameter("removedTokens");this._setTokensSelected(t,true);this._setTokensSelected(o,false);setTimeout(this.fireSelectionChanged.bind(this),0)};g.prototype._setTokensSelected=function(e,t){var o;for(var n=0;n<e.length;n++){o=e[n].getBindingContext("_internal");o.getModel().setProperty(o.getPath("selected"),t)}};g.prototype._validateItem=function(e){if(e.suggestedToken){return e.suggestedToken}var t=e.suggestionObject;if(!t){return null}var o=t.getBindingContext("_internal");return this._createToken(o.getPath())};g.prototype._createToken=function(e){var t=new l({key:"{_internal>id}",text:"{_internal>label}"});t.bindObject({path:e,model:"_internal"});return t};g._getSuggestions=function(e){var t=[];g._getChildren(e,t);return t};g._getChildren=function(e,t){var o;for(var n=0;n<e.length;n++){o=e[n];if(o.isContainer&&t.indexOf(o)===-1){t.push(o)}if(o.children){g._getChildren(o.children,t)}}};g._normalizeContentNodes=function(e){var t={};g._visitPages(e,function(e,o){o.spaceTitles=o.spaceTitles||[];if(t[o.id]){t[o.id].spaceTitles.push(e.label);return t[o.id]}o.spaceTitles.push(e.label);t[o.id]=o;return o})};g._visitPages=function(e,t){var o,n;if(e===undefined||e===null){return}for(var i=0;i<e.length;i++){o=e[i];if(o.type!==p.Space){return}else if(o.children){for(var s=0;s<o.children.length;s++){n=o.children[s];o.children[s]=t(o,n)}}}};g.prototype.clearSelection=function(){var e=this.getAggregation("_content");var t=e.getTokens();t.forEach(function(e){var t=e.getBindingContext("_internal");this._oModel.setProperty(t.getPath("selected"),false)}.bind(this));e.destroyTokens()};g.prototype.setValueState=function(e){var t=this.getAggregation("_content");t.setValueState(e)};g.prototype.setValueStateText=function(e){var t=this.getAggregation("_content");t.setValueStateText(e)};return g});
//# sourceMappingURL=ContentNodeSelector.js.map