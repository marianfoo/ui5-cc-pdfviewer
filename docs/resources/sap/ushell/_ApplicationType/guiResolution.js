// Copyright (c) 2009-2022 SAP SE, All Rights Reserved
sap.ui.define(["sap/ui/thirdparty/URI","sap/ushell/_ApplicationType/utils","sap/ushell/_ApplicationType/systemAlias","sap/ushell/services/_ClientSideTargetResolution/Utils","sap/ushell/services/_ClientSideTargetResolution/ParameterMapping","sap/ui/thirdparty/jquery","sap/base/Log"],function(e,t,s,a,r,jQuery,n){"use strict";function i(e,t){t.forEach(function(t){delete e[t]})}function u(e,t){return t&&t.signature&&t.signature&&t.signature.parameters&&t.signature.parameters[e]&&t.signature.parameters[e].required===true}function o(e,t){var s=u("DYNP_OKCODE",t)||u("DYNP_NO1ST",t);var a=[];if(s){return[]}var r=p(e);function n(e){return e.toUpperCase()}var i=Object.keys(r).map(n).sort();function o(e,t){if(e.length!==t.length){return false}return e.every(function(s,a){return e[a]===t[a]})}if(o(["DYNP_NO1ST","DYNP_OKCODE"],i)||o(["DYNP_OKCODE"],i)||o(["DYNP_NO1ST"],i)){a=Object.keys(r)}return a}function p(e){var t=a.filterObject(e,l);return t}function l(e,t){var s;if(arguments.length===1){s=e.split(/[=](.+)?/);if(s.length>1){return l.apply(null,s)}}return!(e.indexOf("sap-")===0||e.indexOf("saml")===0||e.charAt(0)==="~")}function c(e,s,a){var r=e.inbound,n=r&&r.resolutionResult,i;if(!(!r||!n||!n["sap.gui"]||!(n.applicationType==="TR"))){i=v(e,s,a)}else if(!(!r||!n||!(n.applicationType==="TR")||!(n.url.indexOf("/~canvas;")>=0)||!(n.url.indexOf("app/transaction/APB_LPD_CALL_")===-1))){i=S(e,s,a)}else if(!(!r||!n||!(n.applicationType==="TR")||!(n.url.indexOf("/~canvas;")>=0)||!(n.url.indexOf("app/transaction/APB_LPD_CALL_")>=0))){i=P(e,s,a)}else if(!(!r||!n||!(n.applicationType==="TR")||!(n.url.indexOf("/its/webgui")>=0)||!(n.url.indexOf("APB_LPD_CALL_")===-1))){i=g(e,s,a)}else if(!(!r||!n||!(n.applicationType==="TR")||!(n.url.indexOf("/its/webgui")>=0)||!(n.url.indexOf("APB_LPD_CALL_")!==-1))){i=y(e,s,a)}if(i){return i.then(function(e){if(e.url){e.url=t.appendParametersToUrl("sap-iframe-hint=GUI",e.url)}return e})}throw new Error("Cannot generate TR resolution result")}function f(t,a,r,n){var i,u;t=encodeURIComponent(t);i="/gui/sap/its/webgui?%7etransaction="+t+"&%7enosplash=1";u=new e(i);return s.spliceSapSystemIntoURI(u,s.LOCAL_SYSTEM_ALIAS,a,r,"NATIVEWEBGUI",s.SYSTEM_ALIAS_SEMANTICS.apply,n)}function m(e,s,a,r){var n,i="P_OBJECT"+r,u=132;var o=t.getURLParsing().privparamsToString(s,"%25","%21");if(!o){return e}var p="";d("P_OBJECT",e,a,r,function(e){var t=e.replace(i,"");p=decodeURIComponent(t);if(p.length>0){p=p+"%25"}return i});o=p+o;var l={pObjX:"",pObject:""};o.match(new RegExp(".{1,"+u+"}","g")).map(function(e){return encodeURIComponent(e)}).forEach(function(e,t){var s="P_OBJECT";var n="pObject";if(t>0){s="P_OBJ"+t;n="pObjX"}var i=l[n].length===0?"":a;l[n]=l[n]+i+s+r+e});n=[l.pObjX,l.pObject].filter(function(e){return e.length>0}).join(a);var c=d("P_OBJECT",e,a,r,function(e){return n});if(c.found){return c.query}return e+(e.length===0?"":a)+n}function d(e,t,s,a,r){var n=false,i=e+a;var u=t.split(s).map(function(e){if(e.indexOf(i)!==0){return e}n=true;return r(e)}).filter(function(e){return typeof e!=="undefined"}).join(s);return{found:n,query:u}}function y(a,r,n){var i=a.inbound,u=i&&i.resolutionResult,o={};var p=new e(r);var l=jQuery.extend(true,{},a.mappedIntentParamsPlusSimpleDefaults);var c=l["sap-system"]&&l["sap-system"][0];var f=l["sap-system-src"]&&l["sap-system-src"][0];o["sap-system"]=c;delete l["sap-system"];if(typeof f==="string"){o["sap-system-src"]=f;delete l["sap-system-src"]}return new Promise(function(e,a){s.spliceSapSystemIntoURI(p,u.systemAlias,c,f,"NATIVEWEBGUI",u.systemAliasSemantics||s.SYSTEM_ALIAS_SEMANTICS.applied,n).fail(a).done(function(s){var a=s.search();var r=a.split("&").map(function(e){var t;if(e.indexOf("?%7etransaction")===0||e.indexOf("%7etransaction")===0){t=m(e,l,"%3b","%3d");return t}return e}).join("&");s.search(r);["additionalInformation","applicationDependencies"].forEach(function(e){if(i.resolutionResult.hasOwnProperty(e)){o[e]=i.resolutionResult[e]}});o.url=s.toString();o.text=i.title;o.applicationType="TR";t.setSystemAlias(o,i.resolutionResult);e(o)})})}function v(e,s,a){var n=e.inbound,i=n&&n.resolutionResult,u=e.mappedIntentParamsPlusSimpleDefaults||{};var o=i.systemAlias;if(u["sap-system"]){o=u["sap-system"][0]}var p;if(u["sap-system-src"]){p=u["sap-system-src"][0]}return new Promise(function(s,i){f(n.resolutionResult["sap.gui"].transaction,o,p,a).done(function(a){r.mapParameterNamesAndRemoveObjects(e);var i=h(e.inbound,e.mappedIntentParamsPlusSimpleDefaults,a);if(i&&e.inbound&&e.inbound.resolutionResult&&e.inbound.resolutionResult["sap.platform.runtime"]){i["sap.platform.runtime"]=e.inbound.resolutionResult["sap.platform.runtime"]}i["sap-system"]=o;t.setSystemAlias(i,n.resolutionResult);s(i)}).fail(i)})}function P(a,r,n){var i=a.inbound,u=i&&i.resolutionResult;var o={};var p=new e(r);var l=jQuery.extend(true,{},a.mappedIntentParamsPlusSimpleDefaults);var c=l["sap-system"]&&l["sap-system"][0];var f=l["sap-system-src"]&&l["sap-system-src"][0];o["sap-system"]=c;delete l["sap-system"];if(typeof f==="string"){o["sap-system-src"]=f;delete l["sap-system-src"]}return new Promise(function(e,a){s.spliceSapSystemIntoURI(p,u.systemAlias,c,f,"WEBGUI",u.systemAliasSemantics||s.SYSTEM_ALIAS_SEMANTICS.applied,n).fail(a).done(function(s){var a=s.search();a=m(a,l,"&","=");s.search(a);["additionalInformation","applicationDependencies"].forEach(function(e){if(i.resolutionResult.hasOwnProperty(e)){o[e]=i.resolutionResult[e]}});o.url=s.toString();o.text=i.title;o.applicationType="NWBC";t.setSystemAlias(o,i.resolutionResult);e(o)})})}function S(a,r,n){var u=a.inbound,p=u&&u.resolutionResult;var l={};var c=new e(r);var f=jQuery.extend(true,{},a.mappedIntentParamsPlusSimpleDefaults);var m=f["sap-system"]&&f["sap-system"][0];var d=f["sap-system-src"]&&f["sap-system-src"][0];l["sap-system"]=m;delete f["sap-system"];if(typeof d==="string"){l["sap-system-src"]=d;delete f["sap-system-src"]}var y=o(f,u||{});i(f,y);return new Promise(function(e,a){s.spliceSapSystemIntoURI(c,p.systemAlias,m,d,"WEBGUI",l.systemAliasSemantics||s.SYSTEM_ALIAS_SEMANTICS.applied,n).fail(a).done(function(s){var a=t.getURLParsing().paramsToString(f);var r=s.search();if(a){r=r+(r.indexOf("?")<0?"?":"&")+a}s.search(r);["additionalInformation","applicationDependencies"].forEach(function(e){if(u.resolutionResult.hasOwnProperty(e)){l[e]=u.resolutionResult[e]}});l.url=s.toString();l.text=u.title;l.applicationType="NWBC";t.setSystemAlias(l,u.resolutionResult);e(l)})})}function g(t,a,r){var n=t.inbound,i=n&&n.resolutionResult,u={"sap-wd-run-sc":true,"sap-wd-auto-detect":true,"sap-ep-version":true,"sap-system":true,"sap-system-src":true};var o=new e(a);var p=jQuery.extend(true,{},t.mappedIntentParamsPlusSimpleDefaults);var l=p["sap-system"]&&p["sap-system"][0];var c=p["sap-system-src"]&&p["sap-system-src"][0];Object.keys(p).forEach(function(e){if(u[e.toLowerCase()]){delete p[e]}});return new Promise(function(e,a){s.spliceSapSystemIntoURI(o,i.systemAlias,l,c,"NATIVEWEBGUI",i.systemAliasSemantics||s.SYSTEM_ALIAS_SEMANTICS.applied,r).fail(a).done(function(s){var a=h(t.inbound,t.mappedIntentParamsPlusSimpleDefaults,s);e(a)})})}function h(e,s,a){var r={"sap-wd-run-sc":true,"sap-wd-auto-detect":true,"sap-ep-version":true,"sap-system":true};var u={};var p=jQuery.extend(true,{},s);var c=p["sap-system"]&&p["sap-system"][0];var f=p["sap-system-src"]&&p["sap-system-src"][0];u["sap-system"]=c;if(typeof f==="string"){u["sap-system-src"]=f}Object.keys(p).forEach(function(e){if(r[e.toLowerCase()]){delete p[e]}});var m=o(p,e||{});i(p,m);var d=R(p);i(p,Object.keys(d));var y=a.search();var v=y.split("&").map(function(e){var t;if(!l(e)){if(e.indexOf("=")>=0){t=e.split("=");if(!d.hasOwnProperty(t[0])){d[t[0]]=t[1]}}else{n.error("Found no '=' separator of Webgui non-business parameter. Parameter will be skipped.","'"+e+"'","sap.ushell.services.ClientSideTargetResolution")}return undefined}var s;if(e.indexOf("?%7etransaction")===0||e.indexOf("%7etransaction")===0){s=O(e,p,"%3b","%3d");return s}return e}).filter(function(e){return typeof e!=="undefined"}).join("&");var P=t.getURLParsing().paramsToString(d);v=[v,P.replace("~","%7e")].join("&");a.search(v);["additionalInformation","applicationDependencies","sap.platform.runtime"].forEach(function(t){if(e.resolutionResult.hasOwnProperty(t)){u[t]=e.resolutionResult[t]}});u.url=a.toString();u.text=e.title;u.applicationType="TR";t.setSystemAlias(u,e.resolutionResult);return u}function R(e){var t;t=a.filterObject(e,function(e,t){return!l(e,t)});return t}function b(e){var t="^(.+?)(%20|(%20)(.+))?$",s=new RegExp(t,"i"),a,r={hasParameters:null,transactionParamName:"",transactionCode:"",parameters:[]};var n=e.split("=");if(n.length>2){return{error:"Found more than one assignment ('=') in the transaction query parameter",details:"Only one '=' sign is expected in "+e}}if(n.length<2||typeof n[1]==="undefined"||n[1].length===0){return{error:"The transaction query parameter must specify at least the transaction name",details:"Got "+e+" instead."}}r.transactionParamName=n[0];a=n[1];var i=a.match(s);if(!i){return{error:"Cannot parse ~transaction query parameter value.",details:a+" should match /"+t+"/"}}r.transactionCode=i[1];if(i[2]&&i[2]!=="%20"){var u=i[4]||"";u.split("%3b").forEach(function(e){var t=e.split("%3d"),s=t[0];if(s&&typeof s==="string"&&s.length>0){r.parameters.push({name:s,value:t[1]})}})}r.hasParameters=false;if(r.parameters.length>0){r.hasParameters=true;r.transactionCode=r.transactionCode.replace(/^[*]/,"")}return r}function O(e,s){var a=b(e);if(a.error){n.error(a.error,a.details,"sap.ushell.services.ClientSideTargetResolution");return e}var r=a.parameters.map(function(e){return e.name.toUpperCase()+"%3d"+e.value});var i,u=true;if(s.hasOwnProperty("DYNP_SKIP_SEL_SCREEN")){i=s["DYNP_SKIP_SEL_SCREEN"];delete s["DYNP_SKIP_SEL_SCREEN"];if(i[0]===""||i[0]===" "||i[0]==="0"||i[0]===0||i[0]&&i[0].toLowerCase()==="false"){u=false}}var o={};Object.keys(s).forEach(function(e){o[e.toUpperCase()]=s[e]});var p=t.getURLParsing().privparamsToString(o,"%3b","%3d");if(p){r.push(p)}var l=r.length>0;return a.transactionParamName+"="+(l&&u?"*":"")+a.transactionCode+(l?"%20":"")+r.join("%3b")}function I(e,s,a){return new Promise(function(n,i){var u;if(e.params["sap-system-src"]){u=e.params["sap-system-src"][0]}var o=e.params["sap-system"]?e.params["sap-system"][0]:undefined;var p=e.params["sap-ui2-tcode"]?e.params["sap-ui2-tcode"][0]:undefined;f(p,o,u,a).done(function(e){delete s.intentParamsPlusAllDefaults["sap-ui2-tcode"];r.mapParameterNamesAndRemoveObjects(s);var a=h(s.inbound,s.mappedIntentParamsPlusSimpleDefaults,e);if(a&&s.inbound&&s.inbound.resolutionResult&&s.inbound.resolutionResult["sap.platform.runtime"]){a["sap.platform.runtime"]=s.inbound.resolutionResult["sap.platform.runtime"]}a["sap-system"]=o;a.text=p;a.url=t.appendParametersToUrl("sap-iframe-hint=GUI",a.url);n(a)}).fail(function(e){i(e)})})}return{generateTRResolutionResult:c,resolveEasyAccessMenuIntentWebgui:I,injectEffectiveParametersIntoWebguiQueryParam:O,injectEffectiveParametersIntoWebguiPobjectParam:m,amendGuiParam:d,parseWebguiTransactionQueryParam:b,getWebguiNonBusinessParameters:R,getWebguiBusinessParameters:p,isWebguiBusinessParameter:l,buildNativeWebGuiURI:f,constructFullWebguiResolutionResult:v}},false);
//# sourceMappingURL=guiResolution.js.map