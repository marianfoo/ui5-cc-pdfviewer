// Copyright (c) 2009-2022 SAP SE, All Rights Reserved
sap.ui.define(["sap/ushell/utils","sap/ushell/utils/UrlParsing","sap/ushell/ui/launchpad/Tile","sap/ushell/EventHub","sap/base/Log","sap/base/util/extend"],function(e,t,a,i,s,n){"use strict";var o=function(){};o.prototype={_maxLoggedMessages:50,_maxMessageByteSize:2048,_maxQueueByteSize:30720,_isActive:false,_observedLaunchpadActions:["createGroupAt","deleteGroup","resetGroup","changeGroupTitle","moveGroup","addTile","deleteTile","movetile","externalSearch","addBookmarkTile"],_observedGeneralActions:["openApp"],_observedEventHubEvents:["showCatalog"],_aDoableObjects:[],messageType:{ACTION:0,ERROR:1},_tileOntapOrigFunc:undefined,activate:function(){if(this._isActive){return}this._isActive=true;var e=sap.ui.getCore().getEventBus(),t=this;this._observedLaunchpadActions.forEach(function(a,i,s){e.subscribe("launchpad",a,t._handleAction,t)});e.subscribe("sap.ushell","appOpened",t._handleAction,t);this._observedGeneralActions.forEach(function(a,i,s){e.subscribe(a,t._handleAction,t)});this._observedEventHubEvents.forEach(function(e,a,s){t._aDoableObjects.push(i.on(e).do(t._handleActionEventHub.bind(t)))});s.addLogListener(this);t._tileOntapOrigFunc=a.prototype.ontap;sap.ushell.ui.launchpad.Tile.prototype.ontap=t._tileOnTapDecorator(t._tileOntapOrigFunc)},deactivate:function(){if(!this._isActive){return}this._isActive=false;var e=sap.ui.getCore().getEventBus(),t=this;this._observedLaunchpadActions.forEach(function(a,i,s){e.unsubscribe("launchpad",a,t._handleAction,t)});e.unsubscribe("sap.ushell","appOpened",t._handleAction,t);this._observedGeneralActions.forEach(function(a,i,s){e.unsubscribe(a,t._handleAction,t)});this._aDoableObjects.forEach(function(e){e.off()});s.removeLogListener(this);sap.ushell.ui.launchpad.Tile.prototype.ontap=this._tileOntapOrigFunc},addMessage:function(e,t,a){if(this._isActive){this._addMessageInternal(e,t,a)}},getLog:function(){return this._getLoggingQueueFromStorage()},getMessageInfo:function(){var t={userDetails:this._getUserDetails(),shellState:this._getShellState(),navigationData:this._getLastNavActionFromStorage(),userLog:this.getLog(),formFactor:e.getFormFactor()};return t},getMessageInfoAsString:function(e){return JSON.stringify(this.getMessageInfo(e))},onLogEntry:function(e){if(e.level<=2){var t=e.message;if(typeof e.details!=="undefined"&&e.details!==""){t=t+", "+e.details}this.addMessage(this.messageType.ERROR,t)}},onAttachToLog:function(){},onDetachFromLog:function(){},_tileOnTapDecorator:function(e){var a=this,i,s,n,o,r,u;return function(){var l=this.getMetadata().getName();if(l==="sap.ushell.ui.launchpad.PlusTile"){a.addMessage(a.messageType.ACTION,"Open Catalog for empty group "+this.getGroupId())}else if(l==="sap.ushell.ui.launchpad.Tile"){i=hasher.getHash();if(i){var g=t.parseShellHash(i);i="#"+t.constructShellHash({target:{semanticObject:g.semanticObject,action:g.action}})}s=a._getLastNavActionFromStorage();s.time=new Date;s.navigationHash=i;s.tileDebugInfo=this.getDebugInfo();n=sap.ui.getCore().byId(this.getId());o=n.getModel();r=this.getBindingContext();u=r.getPath();s.tileTitle=r.getModel().getProperty(u).title;a._putInSessionStorage("sap.ushell.UserActivityLog.lastNavigationActionData",JSON.stringify(s));a.addMessage(a.messageType.ACTION,"Click on Tile: "+o.getData().title+" Tile debugInfo: "+this.getDebugInfo())}e.apply(this,arguments)}},_addMessageInternal:function(e,t,a){var i=this._getLoggingQueueFromStorage(),s={type:null},o;for(o in this.messageType){if(e===this.messageType[o]){s.type=o;break}}if(s.type===null){return}n(s,{messageID:a,messageText:t,time:new Date,toString:function(){var e=[this.type,this.time];if(typeof this.messageID!=="undefined"){e.push(this.messageID)}e.push(this.messageText);return e.join(" :: ")}});i.push(s);if(i.length>this._maxLoggedMessages){i.shift()}this._putInSessionStorage("sap.ushell.UserActivityLog.loggingQueue",JSON.stringify(i))},_handleActionEventHub:function(e){this._handleAction("",e.sId,e.oData)},_handleAction:function(e,t,a){var i;switch(t){case"deleteTile":i="Delete Tile "+(a.tileId||"");break;case"moveTile":i="Move Tile "+(a.sTileId||"")+" to Group "+(a.toGroupId||"");break;case"createGroupAt":i="Create Group";break;case"changeGroupTitle":i="Change Group Title of "+(a.groupId||"")+" to "+(a.newTitle||"");break;case"deleteGroup":i="Delete Group "+(a.groupId||"");break;case"addTile":var s=a.catalogTileContext.oModel.oData,n=a.catalogTileContext.sPath,o=this._findInModel(n,s),r=o.id,u=a.groupContext.getObject(),l=u.groupId;i="Add Tile "+(r||"")+" to Group "+(l||"");break;case"moveGroup":i="Move Group from index "+(a.fromIndex||"")+" to index "+(a.toIndex||"");break;case"appOpened":i="Open application "+a.action;var g=this._getLastNavActionFromStorage();g.applicationInformation={};["applicationType","ui5ComponentName","url","additionalInformation","text"].forEach(function(e){g.applicationInformation[e]=a[e]});if(!this._hashSegmentsEqual(g.navigationHash,a.sShellHash)){g.tileDebugInfo=""}g.navigationHash=a.sShellHash;this._putInSessionStorage("sap.ushell.UserActivityLog.lastNavigationActionData",JSON.stringify(g));break;case"addBookmarkTile":i="Add Bookmark "+(a.title||"")+" "+(a.subtitle||"")+" for URL: "+(a.url||"");break;case"showCatalog":i="Show Catalog";break;default:break}this.addMessage(this.messageType.ACTION,i)},_findInModel:function(e,t){var a,i=t,s,n;try{a=e.split("/");for(s=0;s<a.length;s=s+1){if(n!==a[s]){continue}i=i[n]}}catch(e){return undefined}return i},_getUserDetails:function(){var e=sap.ushell.Container.getUser();return{fullName:e.getFullName()||"",userId:e.getId()||"",eMail:e.getEmail()||"",Language:e.getLanguage()||""}},_getShellState:function(){var e=sap.ui.getCore().byId("viewPortContainer"),t,a="";if(e!==undefined){t=e.getModel();a=t.getProperty("/currentState/stateName")}return a},_getLoggingQueueFromStorage:function(){var e=this._getFromSessionStorage("sap.ushell.UserActivityLog.loggingQueue");var t=[];if(e){try{t=JSON.parse(e)}catch(e){}}return t},_getLastNavActionFromStorage:function(){var e=this._getFromSessionStorage("sap.ushell.UserActivityLog.lastNavigationActionData");return e?JSON.parse(e):{}},_hashSegmentsEqual:function(e,t){if(!e||!t){return false}return this._getHashSegment(e)===this._getHashSegment(t)},_getHashSegment:function(e){var t=e.indexOf("~"),a;if(t>-1){return e.substring(0,t)}a=e.indexOf("?");if(a>-1){return e.substring(0,a)}return e},_getFromSessionStorage:function(e){var t=null;try{t=sessionStorage.getItem(e)}catch(e){}return t},_putInSessionStorage:function(e,t){try{sessionStorage.setItem(e,t)}catch(e){}}};var r=new o;return r},false);
//# sourceMappingURL=UserActivityLog.js.map