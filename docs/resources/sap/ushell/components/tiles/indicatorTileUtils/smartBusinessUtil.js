// Copyright (c) 2009-2022 SAP SE, All Rights Reserved
sap.ui.define(["sap/ui/model/FilterOperator","sap/ui/model/analytics/odata4analytics","sap/ui/core/format/NumberFormat","sap/ui/model/odata/ODataModel","sap/base/Log","sap/ui/thirdparty/jquery","sap/base/util/UriParameters","sap/ushell/utils/UrlParsing"],function(e,t,i,r,a,jQuery,n,s){"use strict";var l=t.ParameterizationRequest;var o=t.QueryResultRequest;var u=t.Model.ReferenceByModel;var c=t.Model;sap=sap||{};sap.ushell=sap.ushell||{};sap.ushell.components=sap.ushell.components||{};sap.ushell.components.tiles.indicatorTileUtils=sap.ushell.components.tiles.indicatorTileUtils||{};sap.ushell.components.tiles.indicatorTileUtils.util=sap.ushell.components.tiles.indicatorTileUtils.util||{};sap.ushell.components.tiles.indicatorTileUtils.util=function(t,s){var f={},g={ANN:"years",WEE:"weeks",DAY:"days",HUR:"hours",MIN:"minutes"},T={},h={};return{getScheduledJob:function(e){return T[e]},setScheduledJob:function(e,t){T[e]=t},isCallInProgress:function(e){return h[e]},setUnsetCallInProgress:function(e,t){h[e]=t},getTimeUnitMap:function(){return g},getHanaUser:function(){return authObject.userName},addSystemToServiceUrl:function(e,t){a.info("Hana Adapter --\x3e Add System to Service Url");if(sap.ushell&&sap.ushell.Container){if(t){sap.ushell.Container.getServiceAsync("URLParsing").then(function(i){sap.ui.model.odata.ODataUtils.setOrigin(e,{alias:t})})}else{sap.ushell.Container.getServiceAsync("URLParsing").then(function(t){sap.ui.model.odata.ODataUtils.setOrigin(e)})}}return e},getODataModelByServiceUri:function(e){e=this.addSystemToServiceUrl(e);if(!f[e]){var t=new r(e,{loadMetadataAsync:true,json:true});f[e]=t}return f[e]},getEdmType:function(e,t){var i=null;if(e instanceof r){i=e}else{i=this.getODataModelByServiceUri(e)}if(i&&i.getServiceMetadata()){var a=i.getServiceMetadata();var n=a.dataServices.schema[0].entityType;if(n){for(var s=0;s<n.length;s++){var l=n[s];var o=l.property;for(var u=0;u<o.length;u++){var c=o[u];if(c.name==t){return c.type}}}}}return null},getMillisecond:function(e,t){var i;switch(t){case"seconds":i=e*1e3;break;case"minutes":i=e*60*1e3;break;case"hours":i=e*60*60*1e3;break;case"days":i=e*24*60*60*1e3;break;case"weeks":i=e*7*24*60*60*1e3;break;case"months":i=e*4*7*24*60*60*1e3;break;case"years":i=e*12*4*7*24*60*60*1e3;break}return i},getUTCDate:function(){var e=new Date;return e},isCacheValid:function(e,t,i,r,a){var n=sap.ushell.components.tiles.indicatorTileUtils.cache.getKpivalueById(e);if(!n){return false}else if(!(i&&Number(i))){return true}var s=this.getMillisecond(i,g[r]),l;if(jQuery.type(n.CachedTime)=="date"){l=n.CachedTime&&n.CachedTime.getTime()}else{l=n.CachedTime&&parseInt(n.CachedTime.substr(6),10)}var o=this.getUTCDate();return l>=t&&s>=o-l&&!a},getMantissaLength:function(e){var t=e.toString();var i=0;if(e<0){i=1}if(t.indexOf(".")===-1){return e<0?t.length-1:t.length}return t.substring(i,t.indexOf(".")).length},getLocaleFormattedValue:function(e,t,r,a,n){sap.ui.require("sap.ui.core.format.NumberFormat");a=a||false;n=n||null;if(a){return i.getCurrencyInstance({style:"short",showMeasure:false}).format(e,n)}var s=2;var l={style:"short"};var o;if(!(r==-1||r==null)){l.shortDecimals=Number(r);l.minFractionDigits=Number(r);l.maxFractionDigits=Number(r)}var u=i.getInstance(l);if(t==-2){if(e>9999){o="????"}else if(e>-.001&&e<0||e<.001&&e>0){o="0"}else{if(e.toString().indexOf(".")!=-1){o=Number(e).toFixed(4-e.toString().indexOf("."))}else{o=Number(e)}o=u.format(o)}}else if(r==-1||r==null){var c=this.getMantissaLength(e);if(!(c%3)){s=1}if(c%3===1){s=3}if(c%3===2){s=2}if(Math.abs(e)%Math.pow(10,c-1)==0){s=0}else if(Math.abs(e)%Math.pow(10,c-1)<6*Math.pow(10,c-4)){s=0}u=i.getInstance({style:"short",shortDecimals:s});o=u.format(e)}else{o=u.format(e)}return o},getPlatform:function(e){return(new n(window.location.href).get("sb_metadata")||e||"HANA").toUpperCase()},getTileTitleSubtitle:function(e){var t={};if(e.bag&&e.bag.getBagIds()&&e.bag.getBagIds().length){t.title=e.bag.getBag("sb_tileProperties").getText("title")||e.bag.getBag("sb_tileProperties").getProperty("title")||e.preview.getTitle();t.subTitle=e.bag.getBag("sb_tileProperties").getText("description")||e.bag.getBag("sb_tileProperties").getProperty("description")||e.preview.getDescription()}else{t.title=e.preview.getTitle();t.subTitle=e.preview.getDescription()}return t},scheduleFetchDataJob:function(e){var t;if(this.getView().getViewName().indexOf("DualTile")!==-1){t=this.oKpiTileView.oConfig}else{t=this.oConfig}var i=t.TILE_PROPERTIES.id+"data";var r=sap.ushell.components.tiles.indicatorTileUtils.util.getScheduledJob(i);if(r){clearTimeout(r);r=undefined}var a=sap.ushell.components.tiles.indicatorTileUtils.util.getTimeUnitMap(),n=sap.ushell.components.tiles.indicatorTileUtils.util.getCachingTime(t),s=sap.ushell.components.tiles.indicatorTileUtils.util.getCachingTimeUnit(t),l=sap.ushell.components.tiles.indicatorTileUtils.util.getMillisecond(n,a[s]),o;if(jQuery.type(this.cacheTime)=="date"){o=this.cacheTime}else{o=new Date(parseInt(this.cacheTime.substr(6),10))}var u=l-(sap.ushell.components.tiles.indicatorTileUtils.util.getUTCDate()-o);if(u<=0){u=0}else if(u>2147483646){u=2147483646}if(!e){u=3e5}if(this.getView().getViewName().indexOf("DualTile")!==-1){r=setTimeout(this.refreshPress.bind(this),u)}else{r=setTimeout(this.refreshHandler.bind(this,false,true),u);sap.ushell.components.tiles.indicatorTileUtils.util.setScheduledJob(i,r)}this.updateDatajobScheduled=true},scheduleTimeStampJob:function(){var e=this.oConfig.TILE_PROPERTIES.id+"time",t=sap.ushell.components.tiles.indicatorTileUtils.util.getScheduledJob(e),i;if(t){clearTimeout(t);t=undefined}if(jQuery.type(this.cacheTime)=="date"){i=this.cacheTime}else{i=new Date(parseInt(this.cacheTime.substr(6),10),13)}var r=sap.ushell.components.tiles.indicatorTileUtils.util.getTimeDifference(sap.ushell.components.tiles.indicatorTileUtils.util.getUTCDate()-i);t=setTimeout(this.setTimeStamp.bind(this,this.cacheTime),r.timer);sap.ushell.components.tiles.indicatorTileUtils.util.setScheduledJob(e,t);this.updateTimeStampjobScheduled=true},getBoolValue:function(e){var t=false;if(typeof e==="boolean"&&e){t=true}return t},getSeconds:function(e){return e/1e3},getMinutes:function(e){return this.getSeconds(e)/60},getHours:function(e){return this.getMinutes(e)/60},getDays:function(e){return this.getHours(e)/24},getWeeks:function(e){return this.getDays(e)/7},getMonths:function(e){return this.getWeeks(e)/4},getYears:function(e){return this.getMonths(e)/12},getTimeDifference:function(e){var t={};if(e){var i=this.getMinutes(e);var r=this.getHours(e);var a=this.getDays(e);if(i<5){t.time=0;t.unit="minutes";t.timer=Math.round(this.getMillisecond(5-i,"minutes"))}else if(i>=5&&i<60){if(i<10){t.time=5}else{t.time=i-i%10}t.unit="minutes";t.timer=Math.round(this.getMillisecond(10-i%10,"minutes"))}else if(r>=1&&r<24){t.unit="hours";t.time=r-r%1;t.timer=Math.round(this.getMillisecond(1-r%1,"hours"))}else if(a>=1&&a<2){t.unit="days";t.time=a-a%1;t.timer=Math.round(this.getMillisecond(1-a%1,"days"))}else{t.unit="days";t.time=a-a%1;t.timer=this.getMillisecond(2,"days")}}else{t.timer=6e3;t.unit="days";t.timer=2e3}return t},getCachingTime:function(e){return e.CACHINGTIME&&Number(e.CACHINGTIME)||e.TILE_PROPERTIES.cachingTime&&Number(e.TILE_PROPERTIES.cachingTime)},getCachingTimeUnit:function(e){return e.CACHINGUNIT||e.TILE_PROPERTIES.cachingTimeUnit},getFrontendCacheQuery:function(e,t,i,r){var n;try{var s=r.url.addSystemToServiceUrl("/sap/opu/odata/SSB/SMART_BUSINESS_RUNTIME_SRV");s=sap.ushell.components.tiles.indicatorTileUtils.util.cacheBustingMechanism(s);n=this.getODataModelByServiceUri(s);s="/CacheParameters(P_CacheType=1)/Results";return{oModel:n,uri:s}}catch(e){a.error("FrontEnd cache Metadata failed");return null}},isDualTile:function(e){var t=e&&e.TILE_PROPERTIES&&e.TILE_PROPERTIES.tileType;if(t.indexOf("DT-")==-1){return false}return true},writeFrontendCacheByChipAndUserId:function(e,t,i,r,n){var s=function(e){a.info("cache write successFully");n(e)};var l=function(){a.error("cache update failed");n(null)};try{var o=e.url.addSystemToServiceUrl("/sap/opu/odata/SSB/SMART_BUSINESS_RUNTIME_SRV/");o=sap.ushell.components.tiles.indicatorTileUtils.util.cacheBustingMechanism(o);var u=this.getODataModelByServiceUri(o);var c="/CacheData";u.create(c,i,{async:true,success:s,error:l})}catch(e){a.error(e)}},getKpiChipsOnPage:function(e,t){var i=[];sap.ushell.Container.getServiceAsync("LaunchPage").then(function(r){r.getGroups().done(function(r){if(r&&r instanceof Array&&r.length){a.info("Group Chip fetch")}t(e,i)})})},getFrontendCache:function(e,t){var i=this;var r=sap.ushell.components.tiles.indicatorTileUtils.cache.getFrontEndCacheDeferredObject(t.url.getApplicationSystem());var n;if(r){n=r}else{n=jQuery.Deferred()}var s=e&&e.TILE_PROPERTIES&&e.TILE_PROPERTIES.id;var l=sap.ushell.components.tiles.indicatorTileUtils.cache.getKpivalueById(s);if(l){r.resolve(true)}else if(r){return r.promise()}else{sap.ushell.components.tiles.indicatorTileUtils.cache.setFrontEndCacheDefferedObject(t.url.getApplicationSystem(),n);r=n;this.getKpiChipsOnPage(s,function(e,n){if(n){var s=i.getFrontendCacheQuery(n,sap.ushell.Container.getUser().getId(),n,t);if(s){var l=s.oModel;var o=s.uri;var u=false;l.read(o,null,null,true,function(t){if(t&&t.results&&t.results instanceof Array&&t.results.length){jQuery.each(t.results,function(e,t){sap.ushell.components.tiles.indicatorTileUtils.cache.setKpivalueById(t.ChipId,t)})}if(sap.ushell.components.tiles.indicatorTileUtils.cache.getKpivalueById(e)){u=true}r.resolve(u)},function(e){if(e&&e.response){a.error(e.message+" : "+e.request.requestUri)}r.reject()})}else{r.reject()}}else{r.resolve(false)}})}return r.promise()},getModelerRuntimeServiceModel:function(){var e="/sap/hba/r/sb/core/odata/runtime/SMART_BUSINESS.xsodata";e=sap.ushell.components.tiles.indicatorTileUtils.util.cacheBustingMechanism(e);return this.getODataModelByServiceUri(e)},getSapFontErrorCode:function(){return String.fromCharCode(57521)},getSapFontBusyCode:function(){return String.fromCharCode(57842)},prepareFilterStructure:function(e,t){var i=[];if(t){e=e.concat(t)}for(var r=0;r<e.length;r++){var a={};a.comparator=e[r].OPERATOR;a.filterPropertyName=e[r].NAME;if(e[r].ID){a.id=e[r].ID}a.type=e[r].TYPE;a.value=e[r].VALUE_1;a.valueTo=e[r].VALUE_2;i.push(a)}return i},getODataModelByServiceUriFromChipAPI:function(e,t){e=t.url.addSystemToServiceUrl(e);if(!f[e]){var i=new r(e,true);f[e]=i}return f[e]},cacheBustingMechanism:function(e){if(window["sap-ushell-config"].cacheBusting.cacheBusterToken){var t=window["sap-ushell-config"].cacheBusting&&window["sap-ushell-config"].cacheBusting.cacheBusterToken;e=e+"?_="+t}return e},getRunTimeUri:function(e){var t="/sap/hba/r/sb/core/odata/runtime/SMART_BUSINESS.xsodata";var i="/sap/opu/odata/SSB/SMART_BUSINESS_RUNTIME_SRV";if(e.toUpperCase()=="HANA"){if(window["sap-ushell-config"].cacheBusting){t=sap.ushell.components.tiles.indicatorTileUtils.util.cacheBustingMechanism(t)}return t}if(window["sap-ushell-config"].cacheBusting){i=sap.ushell.components.tiles.indicatorTileUtils.util.cacheBustingMechanism(i)}return i},getFilterFromRunTimeService:function(e,t,i,r){var a=e.TILE_PROPERTIES.sb_metadata;var n=this.getODataModelByServiceUriFromChipAPI(this.getRunTimeUri(a),t);var s="ID eq '#EVALUATIONID'".replace("#EVALUATIONID",e.EVALUATION.ID);var l=n.read("/EVALUATION_FILTERS",null,{$filter:s},true,function(e){var t=[];if(e.results.length){t=e.results}i.call(this,t)},r);return l},_getOData4AnalyticsObject:function(e){var t=null;if(e instanceof r){t=e}else if(typeof e==="string"){t=this.getODataModelByServiceUri(e)}else{throw new Error("Invalid Input to Create ODataModel Object : "+e)}var i=new c(u(t));return i},findTextPropertyForDimension:function(e,t,i){try{var r=this._getOData4AnalyticsObject(e);var n=r.findQueryResultByName(t);var s=n.findDimensionByName(i);if(s.getTextProperty()){return s.getTextProperty().name}return i}catch(e){a.error("Error Fetching Text Property for "+i+" : "+e.toString())}},getEvalValueMeasureName:function(e,t,i){var r=e.EVALUATION_VALUES;for(var a=0;a<r.length;a++){if(r[a].TYPE==t){if(i==="FIXED"){return r[a].FIXED}return r[a].COLUMN_NAME}}},getSemanticColorName:function(e){var t="";if(e=="Error"){t="sb.error"}if(e=="Neutral"){t="sb.neutral"}if(e=="Critical"){t="sb.critical"}if(e=="Good"){t="sb.good"}return t},setTooltipInTile:function(e,t,i){var r="";var a=sap.ushell.components.tiles.utils.getResourceBundleModel().getResourceBundle();if(t=="NT"||t=="DT"){if(i.status){r+=a.getText("sb.status")+": "+a.getText(i.status)+"\n"}if(i.actual){r+=a.getText("sb.actual")+": "+i.actual+"\n"}if(i.target){r+=a.getText("sb.target")+": "+i.target+"\n"}if(i.cH){r+=a.getText("sb.ch")+": "+i.cH+"\n"}if(i.wH){r+=a.getText("sb.wh")+": "+i.wH+"\n"}if(i.wL){r+=a.getText("sb.wl")+": "+i.wL+"\n"}if(i.cL){r+=a.getText("sb.cl")+": "+i.cL+"\n"}}if(t=="CONT"||t=="COMP"){if(i.measure&&t=="CONT"){if(i&&i.contributionTile.contributionTile&&i.contributionTile.contributionTile[1]==="asc"){r+=a.getText("sb.bottomn")+": "+i.contributionTile[0]+"\n"}else if(i&&i.contributionTile.contributionTile&&i.contributionTile.contributionTile.length){r+=a.getText("sb.topn")+": "+i.contributionTile[0]+"\n"}}if(i.m1&&(i.v1==undefined||i.v1==null?false:i.v1.toString())&&i.c1){r+=i.m1+": "+i.v1+" "+a.getText(i.c1)+"\n"}if(i.m2&&(i.v2==undefined||i.v2==null?false:i.v2.toString())&&i.c2){r+=i.m2+": "+i.v2+" "+a.getText(i.c2)+"\n"}if(i.m3&&(i.v3==undefined||i.v3==null?false:i.v3.toString())&&i.c3){r+=i.m3+": "+i.v3+" "+a.getText(i.c3)+"\n"}}if(e&&e.setTooltip){e.setTooltip(r)}},_getFormattedTileProperties:function(e){e=e||{};var t=["sb_metadata","sb_navigation","sb_catalog"];var i=false;for(var r=0;!i&&r<t.length;r++){i=i||new n(window.location.href).get(t[r])||e[t[r]]}e.sb_metadata=(new n(window.location.href).get("sb_metadata")||e.sb_metadata||"HANA").toLowerCase();e.sb_navigation=(new n(window.location.href).get("sb_navigation")||e.sb_navigation||"abap").toLowerCase();e.sb_catalog=(new n(window.location.href).get("sb_catalog")||e.sb_catalog||"HANA").toLowerCase();e.isPlatformInfoPresent=i;return e},getEvaluationDetailsFromRunTimeService:function(e,t,i,r){var a=this.getODataModelByServiceUri(this.getRunTimeUri(t));var n="ID eq '#EVALUATIONID'".replace("#EVALUATIONID",i);a.read(e,null,{$filter:n},true,function(e){var t=[];if(e.results.length){t=e.results}r.call(this,t)})},getParsedChip:function(e,t,i){try{var r={};var a=JSON.parse(e);var n=JSON.parse(a.TILE_PROPERTIES).evaluationId||"";if(a.TILE_PROPERTIES){var s=JSON.parse(a.TILE_PROPERTIES);if(s&&(s.instanceId||s.catalogId)){return false}}var l=this;if(a.blankTile){r.BLANKTILE=a.blankTile}if(a.cachingTime){r.CACHINGTIME=a.cachingTime}if(a.cachingTimeUnit){r.CACHINGUNIT=a.cachingTimeUnit}if(a.TAGS){r.TAGS=JSON.parse(a.TAGS)}if(a.ADDITIONAL_FILTERS){r.ADDITIONAL_FILTERS=JSON.parse(a.ADDITIONAL_FILTERS)}if(a.ADDITIONAL_APP_PARAMETERS){r.ADDITIONAL_APP_PARAMETERS=JSON.parse(a.ADDITIONAL_APP_PARAMETERS)}r.TILE_PROPERTIES=this._getFormattedTileProperties(JSON.parse(a.TILE_PROPERTIES));var o=r.TILE_PROPERTIES.sb_metadata;if(a.EVALUATION_FILTERS){r.EVALUATION_FILTERS=JSON.parse(a.EVALUATION_FILTERS);if(a.EVALUATION_VALUES){r.EVALUATION_VALUES=JSON.parse(a.EVALUATION_VALUES);if(a.EVALUATION){r.EVALUATION=JSON.parse(a.EVALUATION);if(i){i(r)}else{return r}}else if(!t){l.getEvaluationDetailsFromRunTimeService("/EVALUATIONS",o,n,function(e){r.EVALUATION=e;if(i){i(r)}else{return r}})}else if(i){i(r)}else{return r}}else if(!t){l.getEvaluationDetailsFromRunTimeService("/EVALUATION_VALUES",o,n,function(e){r.EVALUATION_VALUES=e;if(a.EVALUATION){r.EVALUATION=JSON.parse(a.EVALUATION);if(i){i(r)}else{return r}}else{l.getEvaluationDetailsFromRunTimeService("/EVALUATIONS",o,n,function(e){r.EVALUATION=e;if(i){i(r)}else{return r}})}})}else if(i){i(r)}else{return r}}else if(t){if(i){i(r)}else{return r}}else{l.getEvaluationDetailsFromRunTimeService("/EVALUATION_FILTERS",o,n,function(e){r.EVALUATION_FILTERS=e;if(a.EVALUATION_VALUES){r.EVALUATION_VALUES=JSON.parse(a.EVALUATION_VALUES);if(a.EVALUATION){r.EVALUATION=JSON.parse(a.EVALUATION);if(i){i(r)}else{return r}}else{l.getEvaluationDetailsFromRunTimeService("/EVALUATIONS",o,n,function(e){r.EVALUATION=e;if(i){i(r)}else{return r}})}}else{l.getEvaluationDetailsFromRunTimeService("/EVALUATION_VALUES",o,n,function(e){r.EVALUATION_VALUES=e;if(a.EVALUATION){r.EVALUATION=JSON.parse(a.EVALUATION);if(i){i(r)}else{return r}}else{l.getEvaluationDetailsFromRunTimeService("/EVALUATIONS",o,n,function(e){r.EVALUATION=e;if(i){i(r)}else{return r}})}})}})}}catch(e){return false}},getNavigationTarget:function(e,t){var i=sap.ushell&&sap.ushell.Container&&sap.ushell.Container.getServiceAsync;var r=i&&i("CrossApplicationNavigation");r.then(function(i){var r;var a={};a.evaluationId=e.EVALUATION.ID;a.chipId=e.TILE_PROPERTIES.id;if(t){a["sap-system"]=t}a.tileType=e.TILE_PROPERTIES.tileType;if(e.TILE_PROPERTIES.dimension){a.dimension=e.TILE_PROPERTIES.dimension}if(e.TILE_PROPERTIES.storyId){a.storyId=e.TILE_PROPERTIES.storyId}if(e.TILE_PROPERTIES.apfConfId){a["sap-apf-configuration-id"]=e.TILE_PROPERTIES.apfConfId}if(e.TILE_PROPERTIES.isPlatformInfoPresent){a.sb_metadata=e.TILE_PROPERTIES.sb_metadata;a.sb_navigation=e.TILE_PROPERTIES.sb_navigation;a.sb_catalog=e.TILE_PROPERTIES.sb_catalog}if(e.ADDITIONAL_APP_PARAMETERS){for(r in e.ADDITIONAL_APP_PARAMETERS){if(e.ADDITIONAL_APP_PARAMETERS.hasOwnProperty(r)){if(e.ADDITIONAL_APP_PARAMETERS[r].constructor==Array){var n=e.ADDITIONAL_APP_PARAMETERS[r];for(var s=0;s<n.length;s++){a[r]=n[s]}}else{a[r]=e.ADDITIONAL_APP_PARAMETERS[r]}}}}var l=i&&i.hrefForExternal({target:{semanticObject:e.TILE_PROPERTIES.semanticObject,action:e.TILE_PROPERTIES.semanticAction},params:a})||"";if(e.ADDITIONAL_FILTERS){var o=e.ADDITIONAL_FILTERS;var u="&";for(var c=0;c<o.length;c++){if(o[c].OPERATOR==="EQ"){u=u+"/"+o[c].NAME+"="+o[c].VALUE_1}}l+=u}return l})},getChipTitle:function(e){var t="";if(e){var i=e.EVALUATION||{};t=i.INDICATOR_TITLE||""}return t},getstringifyTileConfig:function(e){var t={};t.EVALUATION=JSON.stringify(e.EVALUATION);t.EVALUATION_FILTERS=JSON.stringify(e.EVALUATION_FILTERS);t.EVALUATION_VALUES=JSON.stringify(e.EVALUATION_VALUES);t.TILE_PROPERTIES=JSON.stringify(e.TILE_PROPERTIES);return JSON.stringify(t)},getChipSubTitle:function(e){var t="";if(e){var i=e.EVALUATION||{};t=i.TITLE||""}return t},getAllMeasures:function(e,t){var i=[];try{var r=this._getOData4AnalyticsObject(e);var n=r.findQueryResultByName(t);i=n.getAllMeasureNames()}catch(e){a.error("Error Fetching All Measures : "+e.toString())}return i},getFormattingMetadata:function(e,t,i){var a={};a._hasCurrency=false;a._hasSapText=false;var n=null;if(e instanceof r){n=u(e)}else{var s=this.getODataModelByServiceUri(e);n=u(s)}var l=new c(n);var o=l.findQueryResultByName(t);var f=o.getAllMeasures();if(f[i]){var g=f[i]._oTextProperty&&f[i]._oTextProperty.name?f[i]._oTextProperty.name:"";if(g!=""){a._hasSapText=true;a._sapTextColumn=g}else if(f[i].hasOwnProperty("_oUnitProperty")){var T=f[i]._oUnitProperty.extensions;for(var h=0;h<f[i]._oUnitProperty.extensions.length;h++){if(T[h].name==="semantics"&&T[h].value==="currency-code"){a._hasCurrency=true;a._currencyColumn=f[i]._oUnitProperty.name}}}}return a},getAllDimensions:function(e,t){function i(e,t){var i=0,r=0;var a=[];while(i<e.length&&r<t.length){if(e[i]<t[r]){i++}else if(e[i]>t[r]){r++}else{a.push(e[i]);i++;r++}}return a}var r=[];var n=[];try{var s=this._getOData4AnalyticsObject(e);var l=s.findQueryResultByName(t);var o=l.getEntityType();n=o.getFilterablePropertyNames();r=l.getAllDimensionNames();if(n&&n.length){r=i(n.sort(),r.sort())}}catch(e){a.error("Error Fetching All Dimesions : "+e.toString())}return r},prepareQueryServiceUri:function(t,i,n,s,f,g,T){function h(e){return e.replace(/'/g,"''")}var d=null;var m=function(){};var p=function(){};try{var v=null;if(t instanceof r){v=u(t)}else{var E=this.getODataModelByServiceUri(t);v=u(E)}var A=new c(v);var I=A.findQueryResultByName(i);var S=new o(I);if(n){S.setMeasures(n.split(","));S.includeMeasureRawFormattedValueUnit(null,true,true,true)}if(s){if(typeof s==="string"){d=s;d=d.split(",")}for(var O=0;O<d.length;O++){S.addToAggregationLevel([d[O]]);var y=I.getAllDimensions();if(y[d[O]].getTextProperty()!=null){S.includeDimensionKeyTextAttributes([d[O]],true,true,null)}}}if(f&&f.length){var N=[];var P=[];var U;for(O=0,U=f.length;O<U;O++){var R=f[O];if(R.type==="PA"){P.push(R)}else if(R.type==="FI"){N.push(R)}}m=function(e){var t=e.toJSON();var i=t.charAt(t.length-1).toUpperCase();if(i.charCodeAt(0)>=65&&i.charCodeAt(0)<=90){t=t.slice(0,-1)}return t};p=function(e){if(e){try{if(e==+e){e=window.parseInt(e)}var t=new Date(e);var i=t.getTime();if(isNaN(i)){return e}return m(t)}catch(e){}}return e};if(N.length){var L=S.getFilterExpression();for(O=0,U=N.length;O<U;O++){R=N[O];if(this.getEdmType(t,R.filterPropertyName)=="Edm.DateTime"){R.value=p(R.value);R.valueTo=p(R.valueTo)}if(R.comparator==e.BT){L.addCondition(R.filterPropertyName,R.comparator,h(R.value),R.valueTo)}else{var _=R.value.split(",");for(var b=0,D=_.length;b<D;b++){L.addCondition(R.filterPropertyName,R.comparator,h(_[b].replace(/\^\|/g,",")),null)}}}}if(P.length){if(I.getParameterization()){var C=new l(I.getParameterization());var M=I.getParameterization();var V,w,B,F,x;for(var H=0,j=P.length;H<j;H++){V=P[H];w=M.findParameterByName(V.filterPropertyName);if(w.isIntervalBoundary()===true&&w.isLowerIntervalBoundary()===true){x=w.getPeerIntervalBoundaryParameter();for(O=0,U=P.length;O<U;O++){if(P[O].filterPropertyName===x.getName()){F=h(P[O].value);break}}B=h(V.value);if(F){C.setParameterValue(V.filterPropertyName,B,F)}}else if(w.isIntervalBoundary()===true&&w.isLowerIntervalBoundary()===false){a.info("Future development")}else{C.setParameterValue(V.filterPropertyName,h(V.value))}}S.setParameterizationRequest(C)}}}var J=S.getURIToQueryResultEntries();if(g&&g.length){J=J+"&$orderby=";for(H=0,j=g.length;H<j;H++){var k=g[H].sortOrder||"asc";if(k){J+=g[H].element+" "+k+","}}J=J.slice(0,J.length-1)}if(T){J=J+"&$top="+T}var Q=I.getAllMeasures();var G=[];for(O=0;O<n.split(",").length;O++){G.push(Q[n.split(",")[O]].getUnitProperty())}return{uri:J,model:A.getODataModel(),unit:G}}catch(e){a.error("Error Preparing Query Service Uri using OData4Analytics Library : "+e.toString());if(arguments.length){a.error("Arguments Passed to this function");a.error(arguments[0]+","+arguments[1]+","+arguments[2]+","+arguments[3])}else{a.error("NO Arguments passed to this function")}return null}},getAllEntitySet:function(e){var t=[];try{var i=this._getOData4AnalyticsObject(e);t=i.getAllQueryResultNames()}catch(e){a.error("Error fetching Enity Set : "+e.toString())}return t},getAllMeasuresWithLabelText:function(e,i){var r=[];try{var n=this._getOData4AnalyticsObject(e);var s=n.findQueryResultByName(i);var l=s.getAllMeasureNames();for(var o=0;o<l.length;o++){var u=l[o];t.oMeasure=s.findMeasureByName(u);r.push({key:u,value:oMeasure.getLabelText()})}}catch(e){a.error("Error Fetching All Measures : "+e.toString())}return r},getAllDimensionsWithLabelText:function(e,t){var i=[];try{var r=this._getOData4AnalyticsObject(e);var n=r.findQueryResultByName(t);var s=n.getAllDimensionNames();for(var l=0;l<s.length;l++){var o=s[l];var u=n.findDimensionByName(o);var c=null;if(u.getTextProperty()!=null){c=u.getTextProperty().name}i.push({key:o,value:u.getLabelText(),textProperty:c})}}catch(e){a.error("Error Fetching All Dimesions : "+e.toString())}return i},getAllInputParams:function(e,t){var i=[];try{var r=this._getOData4AnalyticsObject(e);var n=r.findQueryResultByName(t);if(n.getParameterization()){var s=n.getParameterization();i=s.getAllParameterNames()}}catch(e){a.error("Error Fetching Input Params : "+e.toString())}return i},getAllInputParamsWithFlag:function(e,t){var i=[];try{var r=this._getOData4AnalyticsObject(e);var n=r.findQueryResultByName(t);if(n.getParameterization()){var s=n.getParameterization();var l=s.getAllParameterNames();for(var o=0;o<l.length;o++){var u=l[o];var c=s.findParameterByName(u);i.push({name:u,optional:c.isOptional()})}}}catch(e){a.error("Error Fetching Input Params : "+e.toString())}return i},formatOdataObjectToString:function(e){if(e&&e.constructor==Object){if(e.__edmType=="Edm.Time"){var t=e.ms;var i=Math.floor(t/1e3%60);var r=Math.floor(t/6e4%60);var a=Math.floor(t/36e5%24);return a+"H"+r+"M"+i+"S"}}return e},generateCombinations:function(e){function t(e,t){while(t.length<e){t="0"+t}return t}var i=Math.pow(2,e.length);var r=[];var a=0;while(i>1){var n=(i-1).toString(2);n=t(e.length,n);r[a]=[];for(var s=0;s<n.length;s++){if(Number(n[s])){r[a].push(e[s])}}i--;a++}return r},logError:function(e,t){if(e=="no data"&&t){var i=sap.ushell.components.tiles.utils.getResourceBundleModel().getResourceBundle();t.setFailedText(i.getText("sb.noData"))}a.error(e.toString())},numberOfLeadingZeros:function(e){e=String(e);var t=0;var i=e.indexOf(".");if(i==-1){return 0}if(Number(e.split(".")[0])!=0){return 0}var r=i+1;while(e[r++]=="0"){++t}return t},formatValue:function(e,t,i){i=i||3;var r={3:"K",6:"M",9:"B",12:"T",0:""};r["-3"]="m";r["-6"]="u";r["-9"]="n";r["-12"]="t";r["-2"]="%";var a,n,s;a=Number(e).toPrecision(i);var l=this.numberOfLeadingZeros(a);if(l>0&&t<0){n=a*Math.pow(10,l+i);s=-(l+i)}else{n=Number(a.split("e")[0]);s=Number(a.split("e")[1])||0}if(!e&&e!=0){return{value:"",unitPrefix:""}}if(t>=0){if(s%3!=0){if(s%3==2){if(s+1==t){s=s+1;n=n/10}else{s=s-2;n=n*100}}else if(s+2==t){s=s+2;n=n/100}else{s--;n=n*10}}else if(s==15){n=n*1e3;s=12}}else if(t=="-2"){var o=this.formatValue(e*100,0)}else if(s>=0&&e<10&&t=="-3"){n=e*Math.pow(10,3);s=-3}else if(s>=0){return this.formatValue(e,0)}else{s=Math.abs(s);t=Math.abs(t);if(t>s){n=n/Math.pow(10,s%3);s=s-s%3}else{var u=s-t;n=n/Math.pow(10,u);s=s-u}s=0-s}n+="";if(t=="-2"){var c=o.unitPrefix==""?Number(o.value+"").toFixed(4-(o.value+"").indexOf(".")):Number(o.value+"").toFixed(3-(o.value+"").indexOf("."));return{value:Number(c),unitPrefix:o.unitPrefix+r[-2]}}n=Number(n).toFixed(4-n.indexOf("."));return{value:Number(n),unitPrefix:r[s]}},isSmartbusinessChipAndCachable:function(e){var t=this.getParsedChip(e&&e.getConfigurationParameter("tileConfiguration"));return t&&t.TILE_PROPERTIES&&t.TILE_PROPERTIES.tileType&&this.getCachingTime(t)},getHanaClient:function(){var e;var t=function(t,i,r){e=t.sessionClient;sap.ushell.components.tiles.indicatorTileUtils.cache.setCacheHanaClient(e);sap.ushell.components.tiles.indicatorTileUtils.util.HANA_CLIENT_DEFERRED.resolve(e)};var i=function(e,t,i){a.error(e.responseText);a.error("session client call failed");sap.ushell.components.tiles.indicatorTileUtils.cache.setCacheHanaClient(null);sap.ushell.components.tiles.indicatorTileUtils.util.HANA_CLIENT_DEFERRED.reject()};var r=sap.ushell.components.tiles.indicatorTileUtils.util.HANA_CLIENT_DEFERRED||jQuery.Deferred();var n=sap.ushell.components.tiles.indicatorTileUtils.cache.getCacheHanaClient();if(n!=undefined){e=n;sap.ushell.components.tiles.indicatorTileUtils.util.HANA_CLIENT_DEFERRED.resolve(e)}else if(sap.ushell.components.tiles.indicatorTileUtils.util.HANA_CLIENT_DEFERRED){return sap.ushell.components.tiles.indicatorTileUtils.util.HANA_CLIENT_DEFERRED.promise()}else{sap.ushell.components.tiles.indicatorTileUtils.util.HANA_CLIENT_DEFERRED=r;jQuery.ajax({type:"GET",async:false,dataType:"json",url:"/sap/hba/r/sb/core/logic/GetSessionClient.xsjs",success:t,error:i})}return sap.ushell.components.tiles.indicatorTileUtils.util.HANA_CLIENT_DEFERRED.promise()},abortPendingODataCalls:function(e){try{if(e){e.abort()}}catch(e){this.logError(e)}}}}(window,jQuery);sap.ushell.components.tiles.indicatorTileUtils.cache=function(){var e={};var t={};var i="HANA_CLIENT";return{getCacheHanaClient:function(){return e[i]},setCacheHanaClient:function(t){e[i]=t},getEvaluationByChipId:function(t){if(e[t]){return e[t]}return null},getEvaluationById:function(e){return this.getEvaluationByChipId(e)},setEvaluationById:function(t,i){e[t]=i},getFrontEndCacheDeferredObject:function(t){if(e[t]){return e[t]}return null},setFrontEndCacheDefferedObject:function(t,i){e[t]=i},getKpivalueById:function(e){if(t[e]){return t[e]}return null},setKpivalueById:function(e,i){t[e]=i}}}();return{}},true);
//# sourceMappingURL=smartBusinessUtil.js.map