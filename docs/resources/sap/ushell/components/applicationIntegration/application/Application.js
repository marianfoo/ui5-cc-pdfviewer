// Copyright (c) 2009-2022 SAP SE, All Rights Reserved
sap.ui.define(["sap/ushell/components/container/ApplicationContainer","sap/ushell/components/applicationIntegration/application/PostMessageAPI","sap/ushell/utils","sap/ui/thirdparty/jquery","sap/ui/thirdparty/URI","sap/ushell/UI5ComponentType","sap/base/Log","sap/base/util/ObjectPath"],function(e,t,r,jQuery,i,n,a,s){"use strict";var o,p,l=e.getMetadata().getJSONKeys();function u(){var i=this;this.handleMessageEvent=function(t,n,s){var o=n.data;if(typeof o==="string"){try{o=JSON.parse(n.data)}catch(e){a.debug("Message received from origin '"+n.origin+"' cannot be parsed: "+e,o,"sap.ushell.components.container.ApplicationContainer");return}}if(o.action==="pro54_setGlobalDirty"&&localStorage.getItem(t.globalDirtyStorageKey)===sap.ushell.Container.DirtyState.PENDING){if(!e.prototype._isTrustedPostMessageSource(t,n)){a.warning("Received message from untrusted origin: "+n.origin,o,"sap.ushell.components.container.ApplicationContainer");return}a.debug("getGlobalDirty() pro54_setGlobalDirty SetItem key:"+t.globalDirtyStorageKey+" value: "+o.parameters.globalDirty,null,"sap.ushell.components.container.ApplicationContainer");r.localStorageSetItem(t.globalDirtyStorageKey,o.parameters.globalDirty,true)}else{i.handleServiceMessageEvent(t,n,o,s)}};this.handleServiceMessageEvent=function(i,n,o,p){var l=s.get("sap-ushell-config.services.PostMessage.config")||s.create("sap-ushell-config.services.PostMessage.config"),u=o&&o.service,c,g,f,d,v=false,h=t.getAPIs(),y;a.debug("Received post message request from origin '"+n.origin+"': "+JSON.stringify(o),null,"sap.ushell.components.container.ApplicationContainer");if(o.type!=="request"||!u){return}for(var m in h){if(h.hasOwnProperty(m)){if(u.indexOf(m)!==-1){g=h[m];f=m;v=true;break}}}if(v===false){if(p.bPluginsStatusChecked===false||p.bKeepMessagesForPlugins===true){p.bApiRegistered=false}else{S("error",{code:-1,message:"Unknown service name: '"+o.service+"'"})}return}y=u.indexOf("user.postapi.")===0;c=u.split(".")[3];if(l&&l.enabled===false){a.warning("Received message for "+c+", but this "+"feature is disabled. It can be enabled via launchpad configuration "+"property 'services.PostMessage.config.enabled: true'",undefined,"sap.ushell.components.container.ApplicationContainer");return}if(!e.prototype._isTrustedPostMessageSource(i,n)){a.warning("Received message from untrusted origin '"+n.origin+"': "+JSON.stringify(n.data),null,"sap.ushell.components.container.ApplicationContainer");return}function b(e,t){var r;if(t===true){r={oMessage:n,oMessageData:o}}else{r={matchesLocalSid:I,getLocalSystemInSidForma:R,storeSapSystemData:C,executeSetBackNavigationService:A,sendResponseMessage:S,oMessage:n,oMessageData:o,oContainer:i}}try{e(r).done(function(e){S("success",{result:e})}).fail(function(e){S("error",{message:e})})}catch(e){S("error",{message:e.message})}}function S(e,t){var r=JSON.stringify({type:"response",service:o.service,request_id:o.request_id,status:e,body:t});a.debug("Sending post message response to origin ' "+n.origin+"': "+r,null,"sap.ushell.components.container.ApplicationContainer");if(typeof n.source!=="object"||n.source===null){a.debug("Cannot send response message to origin ' "+n.origin,"`source` member of request message is not an object","sap.ushell.components.container.ApplicationContainer");return}n.source.postMessage(r,n.origin)}function A(t,r){var n=new jQuery.Deferred,a;if(r.body&&r.body.callbackMessage&&r.body.callbackMessage.service){a=e.prototype._backButtonPressedCallback.bind(null,t.source,r.body.callbackMessage.service,t.origin)}n.resolve(i.getShellUIService().setBackNavigation(a));return n.promise()}function C(e,t){var i,n,s,o=[e.id];if(arguments.length>1){o.unshift(t)}try{s=JSON.stringify(e)}catch(e){a.error("Cannot stringify and store expanded system data: "+e)}if(s){n=r.getLocalStorage();i=r.generateLocalStorageKey("sap-system-data",o);n.setItem(i,s)}}function R(){var e=sap.ushell.Container.getLogonSystem();var t=e.getName();var r=e.getClient();return"sid("+t+"."+r+")"}function I(e){return R().toLowerCase()===e.toLowerCase()}d=g.oServiceCalls[o.service.replace(f+".","")];if(d&&d.executeServiceCallFn){b(d.executeServiceCallFn,y)}else{S("error",{code:-1,message:"Unknown service name: '"+o.service+"'"})}};this.init=function(e){p=e};this.restoreArray=function(e){var t=[],r=0;while(e[r]){t.push(e[r]);r++}return t};this._createWaitForRendererCreatedPromise=function(){var e,t;t=sap.ushell.Container.getRenderer();if(t){a.debug("Shell controller._createWaitForRendererCreatedPromise: shell renderer already created, return empty array.");return[]}e=new Promise(function(e,r){var i;i=function(){a.info("Shell controller: resolving component waitFor promise after shell renderer created event fired.");e();sap.ushell.Container.detachRendererCreatedEvent(i)};t=sap.ushell.Container.getRenderer();if(t){a.debug("Shell controller: resolving component waitFor promise immediately (shell renderer already created");e()}else{sap.ushell.Container.attachRendererCreatedEvent(i)}});return[e]};this.createComponent=function(e,t){var r=this,i=new jQuery.Deferred;sap.ushell.Container.getServiceAsync("Ui5ComponentLoader").then(function(a){a.createComponent(e,t,r._createWaitForRendererCreatedPromise(),n.Application).then(i.resolve,i.reject)});return i.promise()};this.stripURL=function(e){var t=e.indexOf("?"),r=e.indexOf("#"),i;if(t>=0){i=e.substr(0,t)}else if(r>=0){i=e.substr(0,r)}else{i=e}return i};this.createApplicationContainer=function(t,r){var i={};this._cleanTargetResolution(r,i);o=new e("application"+t,r);this._restoreTargetResolution(r,i);if(r.appCapabilities){o.setProperty("frameworkId",r.appCapabilities.appFrameworkId,true)}o.setHandleMessageEvent(this.handleMessageEvent);p.setAppCapabilities(o,r);return o};this.active=function(e){if(e){if(e.active){e.active()}}};this.restore=function(e){var t;if(e.container&&e.container._getIFrame&&e.container._getIFrame()!=undefined){this.postMessageToIframeApp(e.container,"sap.ushell.appRuntime","keepAliveAppShow",{},false)}if(e.app){sap.ui.getCore().getEventBus().publish("sap.ushell","appKeepAliveActivate",e.appTarget);if(e.app.getUrl){t=e.app.getUrl();o=p.get(this.stripURL(t));if(o){p.restoreApp(o.sApplication)}}if(e.app.isKeepAliveSupported&&e.app.isKeepAliveSupported()===true){e.app.activate()}else{if(e.app.restore){e.app.restore()}if(e.app.getRouter&&e.app.getRouter()&&e.app.getRouter().initialize){if(e.enableRouterRetrigger===false){e.app.getRouter().initialize()}else{e.app.getRouter().initialize(true)}}if(e.app.setInitialConfiguration){e.app.setInitialConfiguration()}}o=e.app}};this.store=function(e){var t;if(e.container&&e.container._getIFrame&&e.container._getIFrame()!=undefined){this.postMessageToIframeApp(e.container,"sap.ushell.appRuntime","keepAliveAppHide",{},false)}if(e.app){sap.ui.getCore().getEventBus().publish("sap.ushell","appKeepAliveDeactivate",e.appTarget);if(e.app.getUrl){t=e.app.getUrl();o=p.get(this.stripURL(t));if(o){p.storeApp(o.sApplication)}}if(e.app.isKeepAliveSupported&&e.app.isKeepAliveSupported()===true){e.app.deactivate()}else{if(e.app.suspend){e.app.suspend()}if(e.app.getRouter&&e.app.getRouter()){e.app.getRouter().stop()}}}};this.destroy=function(e){var t,r,i=false;if(e){if(e.getUrl){t=e.getUrl();r=p.get(this.stripURL(t));if(p.isStatefulContainerSupported(r)){i=true;p.destroyApp(r.sApplication)}}if(e.destroy&&i===false){try{e.destroy()}catch(t){a.error("exception when trying to close sapui5 application with id '"+(e.sId||"<unknown>")+"'. This error must be fixed in order for FLP to operate properly.\n",t.stack,"sap.ushell.components.applicationIntegration.application.Application::destroy")}}}};this.setActiveAppContainer=function(e){o=e};this.getActiveAppContainer=function(){return o}}u.prototype._cleanTargetResolution=function(e,t){var r;if(e){for(r in e){if(l[r]===undefined){t[r]=e[r];delete e[r]}}}};u.prototype._restoreTargetResolution=function(e,t){var r;if(e){for(r in t){e[r]=t[r]}}};u.prototype.getResponseHandler=function(e,r){return t.getResponseHandler(e,r)};u.prototype.isActiveOnly=function(e,r){return t.isActiveOnly(e,r)};u.prototype.isAppTypeSupported=function(e,r,i){var n=t._getPostMesageInterface(r,i);return this.isAppTypeSupportedByPolicy(e,n)};u.prototype.isAppTypeSupportedByPolicy=function(e,t){if(e&&e.getAdditionalInformation&&e.getAdditionalInformation().startsWith("SAPUI5.Component=")){return false}var r=t;if(!r||!r.distributionType){return false}if(r.distributionType.indexOf("all")>=0){return true}if(r.distributionType.indexOf("URL")>=0){return false}if(e.getApplicationType&&r.distributionType.indexOf(e.getApplicationType())>=0){return true}return false};u.prototype.postMessageToIframeApp=function(e,t,r,i,n){var a=t+"."+r,s=this.createPostMessageRequest(a,i);return this.postMessageToIframe(s,e,n)};u.prototype.createPostMessageRequest=function(e,t){var r=Date.now().toString();return{type:"request",request_id:r,service:e,body:t}};u.prototype.postMessageToIframe=function(e,t,r){var n=e.request_id,s=t._getIFrame();return new Promise(function(o,p){function l(t){var r;try{if(typeof t.data==="string"&&t.data.indexOf("{")===0){try{r=JSON.parse(t.data)}catch(e){r={}}}else{return}if(!r.request_id||n!==r.request_id){return}if(r.status==="success"){o(r)}else{p(r)}window.removeEventListener("message",l)}catch(r){o();a.warning("Obtained bad response from framework in response to message "+e.request_id);a.debug("Underlying framework returned invalid response data: '"+t.data+"'")}}var u=JSON.stringify(e);a.debug("Sending postMessage "+u+" to application container '"+t.getId()+"'");var c,g;if(!s){o()}else if(r){window.addEventListener("message",l,false);c=new i(t._getIFrameUrl(s));g=c.protocol()+"://"+c.host();s.contentWindow.postMessage(u,g)}else{c=new i(t._getIFrameUrl(s));g=c.protocol()+"://"+c.host();s.contentWindow.postMessage(u,g);o()}})};u.prototype.registerShellCommunicationHandler=function(e){t.registerShellCommunicationHandler(e)};u.prototype._getPostMesageInterface=function(e,r){return t._getPostMesageInterface(e,r)};return new u},true);
//# sourceMappingURL=Application.js.map