// Copyright (c) 2009-2022 SAP SE, All Rights Reserved
sap.ui.define(["sap/ui/core/mvc/Controller","sap/ui/Device","sap/ui/model/json/JSONModel","sap/ushell/resources","sap/base/util/deepExtend","sap/ui/core/Fragment","sap/ushell/library","sap/m/library","sap/base/Log","sap/base/util/ObjectPath","sap/base/util/uid"],function(e,t,i,o,r,a,n,s,d,l,g){"use strict";var p=s.FrameType;var c=n.AppBoxPreviewSize;var u={applicationWidgets:{id:"applicationWidgets",title:o.i18n.getText("ContentFinder.Categories.Applications.Title"),widgets:[{id:"widgets-tiles",title:o.i18n.getText("ContentFinder.Widgets.Tiles.Title"),description:o.i18n.getText("ContentFinder.Widgets.Tiles.Description"),icon:"sap-icon://header"},{id:"widgets-cards",title:o.i18n.getText("ContentFinder.Widgets.Cards.Title"),description:o.i18n.getText("ContentFinder.Widgets.Cards.Description"),icon:"sap-icon://card"}]}};var h={title:o.i18n.getText("ContentFinder.Categories.AllWidgets.Title"),categories:Object.values(u)};var C={currentPageIndex:0,currentBreakpoint:null,currentCategory:h,selectedWidget:"",restrictedMode:false,selectedAppCount:0,navigation:[{id:"allWidgets",title:o.i18n.getText("ContentFinder.Categories.AllWidgets.Title")},{id:"applicationWidgets",title:o.i18n.getText("ContentFinder.Categories.Applications.Title")}]};return e.extend("sap.ushell.components.workPageBuilder.controller.ContentFinderDialog",{init:function(){this.oModel=new i;this.oModel.setData(r({},C))},selectWidgetType:function(e){var t=e.getSource().getBindingContext().getProperty("id");if(this._isMyHomeWidget(t)){this.addWidget();return}this.navigate(1,t)},_onCatalogLoaded:function(e){var t=this.oWorkPageDataProvider.oWorkPageBuilderView.getModel();var i=this._getPreselectedWidgets();var o=this._prepareAppSearchModel(t.getProperty("/data/Catalog"),i);t.setProperty("/data/AppSearchData/tiles",o.Tiles);t.setProperty("/data/AppSearchData/cards",o.Cards);t.setProperty("/data/AppSearchData/appBoxCount",e==="widgets-tiles"?o.Tiles.length:o.Cards.length)},_getPreselectedWidgets:function(){var e=[];var t=this.oModel.getProperty("/restrictedMode");if(t){try{var i=this.oWorkPageDataProvider.oCell.getBindingContext().getPath();e=this.oWorkPageDataProvider.oWorkPageBuilderView.getModel().getProperty(i).Widgets}catch(e){d.error("Error looking up the preselected widgets",null,"sap.ushell.components.workPageBuilder.controller.ContentFinderDialog")}}return e},_prepareAppSearchModel:function(e,t){var i={};var o=e.filter(function(e){return["sap.ushell.StaticAppLauncher","sap.ushell.DynamicAppLauncher"].indexOf(e.Type)>-1});i.Tiles=o.map(function(e,i){if(!e.Descriptor){d.error("No Descriptor available. Cannot load this tile!",null,"sap.ushell.components.workPageBuilder.controller.ContentFinderDialog");return}var r=t.some(function(t){return t.Visualization.Id===e.Id});var a=e.Descriptor["sap.ui"];var n=e.Descriptor["sap.app"];var s=e.Descriptor["sap.fiori"];var g=e.Descriptor["sap.flp"];var u="";if(s){u=s.registrationIds[0]}else if(n&&n.hasOwnProperty("id")){u=n.id}return{id:e.Id,appId:u,icon:l.get("icons.icon",a)||"",info:n&&n.info||"",launchUrl:g&&g.target||"",previewSize:c.Small,posinset:i+1,setsize:o.length,subtitle:n&&n.subTitle||"",title:n&&n.title||"",type:e.Type,frameType:p.OneByOne,catalogData:e,selected:r,disabled:r}});var r=e.filter(function(e){return e.Type==="sap.card"});i.Cards=r.map(function(e,t){if(!e.Descriptor){d.error("No Descriptor available. Cannot load this card!",null,"sap.ushell.components.workPageBuilder.controller.ContentFinderDialog");return}var i=e.Descriptor["sap.app"];var o=e.Descriptor["sap.ui"];var a=i&&i.id||"";return{id:e.Id,appId:a,icon:l.get("icons.icon",o)||"",info:i&&i.info||"",previewSize:c.Large,posinset:t+1,setsize:r.length,subtitle:i&&i.subTitle||"",title:i&&i.title||"",type:e.Type,manifest:e.Descriptor,catalogData:e}});return i},_prepareContentFinderModel:function(e){var t=o.i18nModel.getResourceBundle();return{type:e,CurrentSelectedTreeNode:e==="tiles"?"All Tiles":"All Cards",selectedAppCount:0,showSelectedPressed:false,selectAllBtnPressed:false,tilePreviewShown:false,cardPreviewShown:false,hasSelectables:e==="tiles",appBoxCount:0,tiles:[],cards:[],tree:[{title:e==="tiles"?t.getText("ContentFinder.CategoryTree.Row.AllTiles"):t.getText("ContentFinder.CategoryTree.Row.AllCards")}]}},navigate:function(e,t){switch(e){case 0:this._navigateToCategoryPage();break;case 1:this._navigateToWidgetSelectionPage(t);break;default:d.error("Invalid page index provided for navigation",null,"sap.ushell.components.workPageBuilder.controller.ContentFinderDialog")}},_navigateToCategoryPage:function(){this.oModel.setProperty("/selectedWidget","");this.oModel.setProperty("/selectedAppCount",0);this._oNavContainer.to(this._oCategorySelectionPage)},_navigateToWidgetSelectionPage:function(e){var t;if(e==="widgets-tiles"){t=["sap.ushell.StaticAppLauncher","sap.ushell.DynamicAppLauncher"]}else if(e==="widgets-cards"){t=["sap.card"]}else{d.error("_navigateToWidgetSelectionPage: Invalid Widget type provided: "+e,null,"sap.ushell.components.workPageBuilder.controller.ContentFinderDialog");return}this.oContentFinderData=this._prepareContentFinderModel(e==="widgets-tiles"?"tiles":"cards");this.oModel.setProperty("/selectedWidget",e);var i=this.oWorkPageDataProvider.oWorkPageBuilderView.getModel();i.setProperty("/data/AppSearchData",this.oContentFinderData);i.attachEventOnce("propertyChange",this._onCatalogLoaded.bind(this,e));this.oWorkPageDataProvider.oWorkPageBuilderView.getController().getOwnerComponent().fireEvent("loadCatalog",t);try{var o=this._oWidgetSelectionPage.getContent()[0].getComponentInstance();if(o){o.getRootControl().getController().resetFilters()}}catch(e){}this._oNavContainer.to(this._oWidgetSelectionPage,{type:e})},afterNavigate:function(){var e=this._oNavContainer.indexOfPage(this._oNavContainer.getCurrentPage());this.oModel.setProperty("/currentPageIndex",e)},connect:function(e,i,r,a){var n=a.iCurrentPageIndex!==0?!!a.bRestrictedMode:false;this.oModel.setProperty("/restrictedMode",n);this._sFragmentId=e;this._oDialog=i;this._oDynamicSideContent=this._getDynamicSideContent();this._oNavContainer=this._getNavContainer();this._oCategorySelectionPage=this._oNavContainer.getPage(this._getScopedId("sapCepContentFinderCategoryPage"));this._oWidgetSelectionPage=this._oNavContainer.getPage(this._getScopedId("sapCepContentFinderWidgetPage"));this._oDialog.setModel(this.oModel);this._oDialog.setModel(o.i18nModel,"i18n");this._oDialog.addStyleClass(t.support.touch?"sapUiSizeCozy":"sapUiSizeCompact");this.oWorkPageDataProvider=r;this._setInitialPage(a.iCurrentPageIndex,a.sWidgetType)},addWidget:function(){var e=this.oModel.getProperty("/selectedWidget");var t=this.oModel.getProperty("/selectedAppCount");if(!this._isMyHomeWidget(e)&&t>0){var i=this.oModel.getProperty("/restrictedMode");var o=this.oWorkPageDataProvider.oWorkPageBuilderView.getModel();var r=this.oContentFinderAppSearchView.getModel().getProperty("/data/AppSearchData/tiles");var a=r.filter(function(e){return e.selected&&!e.disabled});a.forEach(function(e){var t=this.oWorkPageDataProvider.sVizRootPath+"/"+e.catalogData.Id;if(!o.getProperty(t)){o.setProperty(t,e.catalogData)}}.bind(this));var n=a.map(function(e){return{Id:g(),Descriptor:{},Visualization:{Id:e.catalogData.Id}}});if(i){this._setCellData(n)}else{this._setColumnData(n)}}this.close()},addCardSelected:function(e){var t=e.getParameters().getSource().getBindingContext().getObject().catalogData;var i=this.oWorkPageDataProvider.oWorkPageBuilderView.getModel();var o=this.oWorkPageDataProvider.sVizRootPath+"/"+t.Id;if(!i.getProperty(o)){i.setProperty(o,t)}var r=[{Id:g(),Descriptor:{},Visualization:{Id:t.Id}}];this._setColumnData(r);this.close()},_setColumnData:function(e){var t=this.oWorkPageDataProvider.oColumn;if(!t){return}var i=this.oWorkPageDataProvider.oWorkPageBuilderView.getModel();var o=t.getBindingContext().getPath();var r=i.getProperty(o);if(!r.Cells){r.Cells=[]}r.Cells.push({Id:g(),Widgets:e});i.setProperty(o,r);if(this.oWorkPageDataProvider.fnOnWidgetAdded){this.oWorkPageDataProvider.fnOnWidgetAdded()}},_setCellData:function(e){var t=this.oWorkPageDataProvider.oCell;if(!t){return}var i=this.oWorkPageDataProvider.oWorkPageBuilderView.getModel();var o=t.getBindingContext().getPath();var r=Object.assign({},i.getProperty(o));r.Widgets=r.Widgets.concat(e);i.setProperty(o,r);if(this.oWorkPageDataProvider.fnOnWidgetAdded){this.oWorkPageDataProvider.fnOnWidgetAdded()}},close:function(){this._oDialog.close()},afterClose:function(){this.oModel.setData(r({},C))},_setInitialPage:function(e,t){var i=[0,1].indexOf(e)>-1?e:0;if(i===1&&t!=="widgets-tiles"&&t!=="widgets-cards"){d.error("Initial page is WidgetSelectionPage but no widget type was provided. Navigating to Widget Gallery instead.",null,"sap.ushell.components.workPageBuilder.controller.ContentFinderDialog");i=0}this.navigate(i,t);this.oModel.setProperty("/currentPageIndex",i)},handleToggle:function(){if(this.oModel.getProperty("/currentPageIndex")===0){this._oDynamicSideContent.toggle()}else if(this.oModel.getProperty("/currentPageIndex")===1){this.oContentFinderAppBoxDynamicSideControl.toggle()}},_getNavContainer:function(){return sap.ui.getCore().byId(this._getScopedId("sapCepContentFinderNavContainer"))},_getDynamicSideContent:function(){return sap.ui.getCore().byId(this._getScopedId("sapCepContentFinderDynamicSideContent"))},_getAddButton:function(){return sap.ui.getCore().byId(this._getScopedId("sapCepContentFinderAddButton"))},_getScopedId:function(e){return a.createId(this._sFragmentId,e)},_isMyHomeWidget:function(e){if(!u.myHomeWidgets){return false}return u.myHomeWidgets.widgets.some(function(t){return t.id===e})},onAppBoxContainerCreated:function(e){var t=e.getSource().getComponentInstance();var i=this.oWorkPageDataProvider.oWorkPageBuilderView.getModel();this.oContentFinderAppSearchView=e.getSource().getComponentInstance().getRootControl();this.oContentFinderAppBoxDynamicSideControl=sap.ui.getCore().byId(this.oContentFinderAppSearchView.getId()+"--ContentFinderAppSearchDynamicSideContent");if(this.oContentFinderData){this.oContentFinderAppSearchView.setModel(i);this.oContentFinderAppSearchView.bindObject({path:"/data/AppSearchData"})}t.attachEvent("cardSelected",this.addCardSelected.bind(this))},titleFormatter:function(e,t){if(e===0){return o.i18n.getText("ContentFinder.Dialog.Title")}if(t==="widgets-tiles"){return o.i18n.getText("ContentFinder.Dialog.AddTiles.TitleLabel")}return o.i18n.getText("ContentFinder.Dialog.AddCards.TitleLabel")}})});
//# sourceMappingURL=ContentFinderDialog.controller.js.map