//Copyright (c) 2009-2022 SAP SE, All Rights Reserved
sap.ui.define(["sap/base/Log","sap/ui/core/mvc/Controller","sap/ushell/components/workPageRuntime/services/WorkPage","sap/ui/model/json/JSONModel","sap/base/util/deepExtend","sap/ushell/EventHub","sap/ushell/components/pages/controller/PagesAndSpaceId","sap/ushell/resources","sap/ushell/Config"],function(e,t,i,o,a,n,s,d,r){"use strict";return t.extend("sap.ushell.components.workPageRuntime.controller.WorkPageRuntime",{onInit:function(){var e=sap.ushell.Container.getRenderer();var t=new URLSearchParams(window.location.search);this.oWorkPageService=new i;this.oOriginalModel=new o;this.oEditModel=new o({editMode:false,loaded:false});this.oWorkPageNavContainer=this.byId("workpageNavContainer");this.oEmptyPage=this.byId("emptyPage");this.oEditModel.setSizeLimit(Infinity);this.getView().setModel(this.oEditModel);return this._getPageId().then(function(i){this._sPageId=i;this._sSiteId=t.get("siteId")||r.last("/core/site/siteId");return this._loadWorkPageAndVisualizations(this._sSiteId,this._sPageId).then(this._handleEditModeButton.bind(this)).then(this._navigate.bind(this)).finally(function(){n.emit("CenterViewPointContentRendered");if(!this.getOwnerComponent().getNavigationDisabled()){this.oContainerRouter=e.getRouter();this.oContainerRouter.getRoute("home").attachMatched(this.onRouteMatched.bind(this,false));this.oContainerRouter.getRoute("openFLPPage").attachMatched(this.onRouteMatched.bind(this,false));this.oContainerRouter.getRoute("openWorkPage").attachMatched(this.onRouteMatched.bind(this,false))}n.on("WorkPageHasChanges").do(this._onWorkPageChanged.bind(this))}.bind(this))}.bind(this)).catch(this._handleErrors.bind(this))},_handleEditModeButton:function(){var e=this.oOriginalModel.getProperty("/editable");var t=sap.ushell.Container.getUser().isAdminUser();if(e&&t){return this._createEditModeButton(this._createEditButtonControlProperties())}this._hideEditModeButton();return Promise.resolve()},_onWorkPageChanged:function(e){this.oEditModel.setProperty("/workPageHasChanges",!!e);sap.ushell.Container.setDirtyFlag(!!e)},_navigate:function(){this.oWorkPageNavContainer.to(this.byId("workPage"))},_createEditButtonControlProperties:function(){var t=d.i18n.getText("WorkpageRuntime.EditMode.Activate");e.debug("cep/editMode: create Edit Button","Workpage runtime");return{id:"EditModeBtn",text:t,icon:"sap-icon://edit",press:[this.pressEditModeButton,this]}},_createEditModeButton:function(e){var t={controlType:"sap.ushell.ui.launchpad.ActionItem",oControlProperties:e,bIsVisible:true,aStates:["home"]};this._showEditModeButton();return sap.ushell.Container.getRenderer("fiori2").addUserAction(t).then(function(e){if(r.last("/core/extension/enableHelp")){e.addStyleClass("help-id-EditModeBtn")}})},_setEditButtonText:function(e){if(e){var t=sap.ui.getCore().byId("EditModeBtn");if(t){var i=d.i18n.getText(e);t.setText(i);t.setTooltip(i)}}},pressEditModeButton:function(){if(this.oEditModel.getProperty("/editMode")){if(this.oEditModel.getProperty("/workPageHasChanges")){this._saveChanges()}else{this._toggleEditMode(false)}}else{this._toggleEditMode(true)}},_toggleEditMode:function(t){n.emit("enableMenuBarNavigation",!t);e.debug("cep/editMode: toggle edit mode"," Work Page runtime");this.oEditModel.setProperty("/editMode",t);this._setEditButtonText(t?"PageRuntime.EditMode.Exit":"WorkpageRuntime.EditMode.Activate");n.emit("WorkPageHasChanges",false)},_cancelChanges:function(){this._toggleEditMode(false);this._setModels()},_saveChanges:function(){var e=this.getView();e.setBusy(true);this._updateWorkPage().then(function(e){sap.ui.require(["sap/m/MessageToast"],function(e){e.show(d.i18n.getText("savedChanges"),{duration:4e3})});this._toggleEditMode(false);this._setModels()}.bind(this)).catch(function(e){var t=e.responseText||e;sap.ui.require(["sap/m/MessageBox"],function(i){i.error(t,{title:e.statusText})})}).finally(function(){e.setBusy(false)})},_closeEditMode:function(e){(e.getParameter("saveChanges")?this._saveChanges:this._cancelChanges).bind(this)()},onWorkPageBuilderCreated:function(e){var t=e.getParameter("component");t.attachEvent("loadCatalog",this._loadCatalog.bind(this));t.attachEvent("closeEditMode",this._closeEditMode.bind(this))},_loadWorkPageAndVisualizations:function(e,t){return this.oWorkPageService.loadWorkPageAndVisualizations(e,t).then(this._setModels.bind(this))},_loadWorkPage:function(t,i){e.debug("cep/editMode: load Work Page: "+i,"Work Page runtime");return this.oWorkPageService.loadWorkPage(t,i).then(function(){var e=this.oWorkPageService.getAllVizIds(this.oWorkPageService.getModel().getData());this.oWorkPageService.loadVisualizations(t,e).then(this._setModels.bind(this))}.bind(this))},_loadCatalog:function(e){return this.oWorkPageService.loadCatalog("",e.getParameters()).then(function(){this.oEditModel.setProperty("/data/Catalog",this.oWorkPageService.getModel().getProperty("/data/Catalog"));this.oEditModel.firePropertyChange({type:"Catalog"})}.bind(this))},_updateWorkPage:function(){var e=a({Id:this._sPageId},this.oEditModel.getProperty("/data/WorkPage"));return this.oWorkPageService.updateWorkPage(this._sPageId,e)},_setModels:function(){var e=this.oWorkPageService.getModel().getData();this.oOriginalModel.setData(a({},e));if(this.oEditModel.getProperty("/editMode")===true){this._toggleEditMode(false)}this.oEditModel.setData(a({editMode:false,loaded:true,workPageHasChanges:false},e));this.getView().setModel(this.oEditModel)},_hideEditModeButton:function(){var t=sap.ui.getCore().byId("EditModeBtn");e.debug("cep/editMode: hide Edit Mode button","Work Page runtime");if(t){t.setVisible(false)}},_showEditModeButton:function(){var t=sap.ui.getCore().byId("EditModeBtn");e.debug("cep/editMode: show Edit Mode button","Work Page runtime");if(t){t.setVisible(true)}},_handleErrors:function(t){this._hideEditModeButton();e.error("An error occurred while loading the page",t);e.debug("cep/editMode: on Route matched: Handle errors","Work Page runtime");this.oWorkPageNavContainer.to(this.byId("errorPage"))},onRouteMatched:function(){e.debug("cep/editMode: on Route matched","Work Page runtime");return this._getPageId().then(function(e){this._sPageId=e;return this._loadWorkPageAndVisualizations(this._sSiteId,this._sPageId).then(this._navigate.bind(this))}.bind(this)).then(this._handleEditModeButton.bind(this)).catch(this._handleErrors.bind(this))},_getPageId:function(){if(r.last("/core/workPages/myHome/pageId")){return Promise.resolve(r.last("/core/workPages/myHome/pageId"))}return s._getPageAndSpaceId().then(function(e){return e.pageId})},hideRuntime:function(){e.debug("cep/editMode: navigate to empty page","Page runtime");this._hideEditModeButton();this.oWorkPageNavContainer.to(this.oEmptyPage)}})});
//# sourceMappingURL=WorkPageRuntime.controller.js.map