// Copyright (c) 2009-2022 SAP SE, All Rights Reserved
sap.ui.define(["sap/ushell/utils/HttpClient","sap/ushell/utils/RestrictedJSONModel","sap/ushell/components/workPageRuntime/services/NavigationResolver","sap/base/util/ObjectPath","sap/ushell/Config","sap/base/Log"],function(e,t,r,a,o,i){"use strict";var s=function(){this.httpClient=new e;this._oNavigationResolver=new r;this._oCdmServicePromise=sap.ushell.Container.getServiceAsync("CommonDataModel");this._oCSTRServicePromise=sap.ushell.Container.getServiceAsync("ClientSideTargetResolution");this._sBaseUrl=o.last("/core/workPages/contentApiUrl");this._oWorkPagesModel=new t({editable:false,data:{WorkPage:null,Visualizations:null,Catalog:[]}})};s.prototype.getModel=function(){return this._oWorkPagesModel};s.prototype._validateData=function(e){i.debug("cep/editMode: load Page: validate","Work Page service");if(e.errors&&e.errors.length>0){return Promise.reject(e.errors.map(function(e){return e.message}).join(",\n"))}if(!a.get("data.WorkPage",e)){i.debug("cep/editMode: load Page: validate: reject: data is empty","Work Page service");return Promise.reject("Work Page data is empty")}return Promise.resolve(e)};s.prototype.loadWorkPageAndVisualizations=function(e,t){var r="{"+"WorkPage("+'SiteId:"'+e+'",'+'WorkPageId:"'+t+'"'+") {"+"Id,"+"Contents,"+"Editable,"+"UsedVisualizations{"+"nodes{"+"Id,"+"Type,"+"Descriptor,"+"DescriptorResources{"+"BaseUrl,"+"DescriptorPath"+"}"+"}"+"}"+"}"+"}";return this._doRequest(r).then(this._validateData).then(function(e){var t=a.get("data.WorkPage.Contents",e);var r=a.get("data.WorkPage.UsedVisualizations.nodes",e)||[];var o=a.get("data.WorkPage.Editable",e)===true;return this._transformVizData(r).then(function(e){var r=e.reduce(function(e,t){e[t.Id]=t;return e},{});this._oWorkPagesModel._setProperty("/data/WorkPage",t);this._oWorkPagesModel._setProperty("/data/Visualizations",r);this._oWorkPagesModel._setProperty("/editable",o)}.bind(this))}.bind(this))};s.prototype._resolveAndReplaceIBNTargets=function(e){var t,r,o,i;var s=e.reduce(function(e,s){t=a.get(["Descriptor","sap.flp","target","type"],s);if(t==="IBN"){i=this._replaceTarget(s);r=a.get(["Descriptor","sap.flp","target","inboundId"],s);o=a.get(["Descriptor","sap.flp","target","parameters"],s);if(r){e.push(i(r,o))}}else{e.push(Promise.resolve(s))}return e}.bind(this),[]);return Promise.all(s)};s.prototype._replaceTarget=function(e){return function(t,r){return this._oNavigationResolver.resolveByInbound(t,r).then(function(t){a.set(["Descriptor","sap.flp","target"],{type:"URL",url:t.url},e);return e})}.bind(this)};s.prototype.loadWorkPage=function(e,t){var r="{"+"WorkPage("+'SiteId:"'+e+'",'+'WorkPageId:"'+t+'"'+") {"+"Id,"+"Contents,"+"Editable"+"}"+"}";return this._doRequest(r).then(this._validateData).then(function(e){var t=a.get("data.WorkPage.Contents",e);var r=a.get("data.WorkPage.Editable",e)===true;this._oWorkPagesModel._setProperty("/data/WorkPage",t);this._oWorkPagesModel._setProperty("/editable",r)}.bind(this))};s.prototype.updateWorkPage=function(e,t){function r(e){for(var t in e){if(e[t]!==null&&typeof e[t]==="object"){if(e.DescriptorSchemaVersion){return e.DescriptorSchemaVersion}return r(e[t])}}return""}var o=r(t);function i(e,t){if(e&&e.DescriptorSchemaId){delete e.DescriptorSchemaId}for(var r in e){if(e[r]!==null&&typeof e[r]==="object"){i(e[r],!isNaN(r))}}if(e&&t){e.Descriptor=e.Descriptor||{};e.DescriptorSchemaVersion=e.DescriptorSchemaVersion||o}}function s(e){if(e.Rows){e.Rows.forEach(function(e){if(e.Columns){e.Columns.forEach(function(e){if(!e.Cells){e.Cells=[]}})}})}}i(t,true);s(t);var n="mutation updateWorkPage($WorkPageId: String!, $Contents: JSON) {"+"updateWorkPage(WorkPageId: $WorkPageId, Contents: $Contents ) {"+"Id,"+"Contents,"+"Editable,"+"UsedVisualizations{"+"nodes{"+"Id,"+"Type,"+"Descriptor,"+"DescriptorResources{"+"BaseUrl,"+"DescriptorPath"+"}"+"}"+"}"+"}"+"}";var u={query:n,variables:{WorkPageId:e,Contents:t}};var p=this.httpClient.post(this._sBaseUrl,{data:u,headers:{"Content-Type":"application/json",Accept:"application/json","Accept-Language":sap.ui.getCore().getConfiguration().getLanguageTag()}}).then(function(e){if(e.status!==200){return Promise.reject({statusText:"HTTP request failed with status: "+e.status,responseText:e.statusText})}var t={};try{t=JSON.parse(e.responseText||"{}")}catch(t){return Promise.reject({statusText:undefined,responseText:e.responseText})}var r;var a;if(t.errors){try{var o=t.errors[0].split("[");r=o[0];var i=JSON.parse("["+o[1]);a=JSON.stringify(i,null,"  ")}catch(e){r=null;a=t.errors}return Promise.reject({statusText:r,responseText:a})}return t}).then(function(e){var t=a.get("data.updateWorkPage.Contents",e);var r=a.get("data.updateWorkPage.UsedVisualizations.nodes",e)||[];var o=a.get("data.updateWorkPage.Editable",e)===true;return this._transformVizData(r).then(function(e){var r=e.reduce(function(e,t){e[t.Id]=t;return e},{});this._oWorkPagesModel._setProperty("/data/Visualizations",r);this._oWorkPagesModel._setProperty("/data/WorkPage",t);this._oWorkPagesModel._setProperty("/editable",o)}.bind(this))}.bind(this));return p};s.prototype.loadVisualizations=function(e,t){var r=t.map(function(e){return'"'+e+'"'}).join(",");var o="{"+"Visualizations("+'SiteId:"'+e+'",'+"QueryInput:{filter:{Id:{in:["+r+"]}}}"+") {"+"nodes {"+"Id,"+"Type,"+"Descriptor,"+"DescriptorResources{"+"BaseUrl,"+"DescriptorPath"+"}"+"}"+"}"+"}";return this._doRequest(o).then(function(e){var t=a.get("data.Visualizations.nodes",e)||[];return this._transformVizData(t).then(function(e){var t=e.reduce(function(e,t){e[t.Id]=t;return e},{});this._oWorkPagesModel._setProperty("/data/Visualizations",t)}.bind(this))}.bind(this))};s.prototype.loadCatalog=function(e,t){var r=t.map(function(e){return'"'+e+'"'}).join(",");var o="{"+"Visualizations("+'SiteId:"'+e+'",'+"QueryInput:{filter:{Type:{in:["+r+"]}}}"+") {"+"nodes{"+"Id,"+"Type,"+"Descriptor,"+"DescriptorResources{"+"BaseUrl,"+"DescriptorPath"+"}"+"}"+"}"+"}";return this._doRequest(o).then(function(e){var t=a.get("data.Visualizations.nodes",e)||[];return this._transformVizData(t).then(function(e){this._oWorkPagesModel._setProperty("/data/Catalog",e)}.bind(this))}.bind(this))};s.prototype.getAllVizIds=function(e){var t=a.get("data.Rows",e),r=[],o=0,i,s,n,u,p,l,c;if(!t||t.length===0){return[]}for(;o<t.length;o++){u=t[o].Columns;if(!u||u.length===0){continue}for(i=0;i<u.length;i++){p=u[i].Cells;if(!p||p.length===0){continue}for(s=0;s<p.length;s++){l=p[s].Widgets;if(!l||l.length===0){continue}for(n=0;n<l.length;n++){c=a.get("Visualization.Id",l[n]);if(!c){continue}r.push(c)}}}}return r};s.prototype._doRequest=function(e){return this.httpClient.get(this._sBaseUrl+"?query="+e,{headers:{"Content-Type":"application/json",Accept:"application/json","Accept-Language":sap.ui.getCore().getConfiguration().getLanguageTag()}}).then(function(e){if(e.status!==200){return Promise.reject("HTTP request failed with status: "+e.status+" - "+e.statusText)}return JSON.parse(e.responseText||"{}")})};s.prototype._addSiteDataToVisualizations=function(e){return this._oCdmServicePromise.then(function(t){var r,o,i;return Promise.all([t.getApplications(),t.getVizTypes()]).then(function(t){var s=t[0];var n=t[1];return e.map(function(e){i=n[e.Type];r=a.get(["Descriptor","sap.flp","target","appId"],e);o=s[r];if(o){a.set("BusinessApp",o,e)}if(i){a.set("VizType",i,e)}return e})})})};s.prototype._replaceIndicatorDatasource=function(e){return Promise.all([this._oCSTRServicePromise,this._oCdmServicePromise]).then(function(t){var r=t[0];var o=t[1];return o.getApplications().then(function(t){return Promise.all(e.map(function(e){var o=a.get(["Descriptor","sap.flp","target","appId"],e);var s=t[o];var n=a.get(["Descriptor","sap.flp","indicatorDataSource"],e);var u;if(s){u=a.get(["sap.app","contentProviderId"],s);if(u&&n&&n.path){return r.getSystemContext(u).then(function(t){if(t){var r=n.dataSource;var o=a.get(["Descriptor","sap.app","dataSources",r],e);var i;if(o){i=t.getFullyQualifiedXhrUrl(o.uri);a.set(["Descriptor","sap.app","dataSources",r,"uri"],i,e)}else{i=t.getFullyQualifiedXhrUrl(n.path);a.set(["Descriptor","sap.flp","indicatorDataSource","path"],i,e)}}return e}).catch(function(t){i.error(t);return e})}}return Promise.resolve(e)}))})})};s.prototype._transformVizData=function(e){return this._addSiteDataToVisualizations(e).then(this._replaceIndicatorDatasource.bind(this))};return s},true);
//# sourceMappingURL=WorkPage.js.map