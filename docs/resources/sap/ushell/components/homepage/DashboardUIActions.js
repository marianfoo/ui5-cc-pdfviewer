// Copyright (c) 2009-2022 SAP SE, All Rights Reserved
sap.ui.define(["sap/ui/base/Object","sap/ushell/Layout","sap/ui/Device","sap/ui/thirdparty/jquery","sap/base/Log"],function(e,t,i,jQuery,o){"use strict";var n=e.extend("sap.ushell.components.homepage.DashboardUIActions",{metadata:{publicMethods:["initializeUIActions"]},constructor:function(){this.aTabBarItemsLocation=[];if(sap.ushell.components.homepage.getDashboardUIActions&&sap.ushell.components.homepage.getDashboardUIActions()){return sap.ushell.components.homepage.getDashboardUIActions()}sap.ushell.components.homepage.getDashboardUIActions=function(e){return function(){return e}}(this.getInterface());this.oTileUIActions=undefined;this.oLinkUIActions=undefined;this.oGroupUIActions=undefined;this.oController=undefined;this.UIActionsInitialized=false;sap.ui.getCore().getEventBus().subscribe("launchpad","actionModeActive",this._enableGroupUIActions,this);sap.ui.getCore().getEventBus().subscribe("launchpad","actionModeInactive",this._disableGroupUIActions,this)},destroy:function(){sap.ui.getCore().getEventBus().unsubscribe("launchpad","actionModeActive",this._enableGroupUIActions,this);sap.ui.getCore().getEventBus().unsubscribe("launchpad","actionModeInactive",this._disableGroupUIActions,this);sap.ushell.components.homepage.getDashboardUIActions=undefined;this.oGroupUIActions=null;this.oTileUIActions=null;this.oLinkUIActions=null},initializeUIActions:function(e){this.oController=e;if(e.getView().getModel().getProperty("/homePageGroupDisplay")==="tabs"){this._fillTabBarItemsArray()}var t=jQuery("#sapUshellDashboardPage").width();var i=e.getView().sDashboardGroupsWrapperId,o,n=sap.ui.getCore().getConfiguration().getRTL(),s={containerSelector:"#dashboardGroups",wrapperSelector:i?"#"+i:undefined,rootSelector:"#shell"},a=jQuery.extend(true,{},s,{switchModeDelay:1e3,isTouch:e.getView().isTouch,isCombi:e.getView().isCombi,debug:false}),l={draggableSelector:".sapUshellLinkTile",placeHolderClass:"sapUshellLinkTile-placeholder",cloneClass:"sapUshellLinkTile-clone",endCallback:this._handleLinkDrop.bind(this),dragCallback:this._handleStartDragTile.bind(this),onBeforeCreateClone:this._onBeforeCreateLinkClone.bind(this),dragAndScrollCallback:this._handleTileDragMove.bind(this),endDragAndScrollCallback:this._handleTileDragAndScrollContinuation.bind(this),moveTolerance:e.getView().isTouch||e.getView().isCombi?10:3,isLayoutEngine:true,disabledDraggableSelector:"sapUshellLockedTile",onDragStartUIHandler:this._markDisableGroups.bind(this),onDragEndUIHandler:this._endUIHandler.bind(this),offsetLeft:n?t:-t,defaultMouseMoveHandler:function(){}},r={draggableSelector:".sapUshellTile",draggableSelectorExclude:".sapUshellPlusTile",placeHolderClass:"sapUshellTile-placeholder",cloneClass:"sapUshellTile-clone",deltaTop:-44,scrollContainerSelector:undefined,endCallback:this._handleTileDrop.bind(this),dragCallback:this._handleStartDragTile.bind(this),dragAndScrollCallback:this._handleTileDragMove.bind(this),endDragAndScrollCallback:this._handleTileDragAndScrollContinuation.bind(this),moveTolerance:e.getView().isTouch||e.getView().isCombi?10:3,isLayoutEngine:true,disabledDraggableSelector:"sapUshellLockedTile",onDragStartUIHandler:this._markDisableGroups.bind(this),onDragEndUIHandler:this._endUIHandler.bind(this),offsetLeft:n?t:-t,defaultMouseMoveHandler:function(){}},h={draggableSelector:".sapUshellDashboardGroupsContainerItem:not(.sapUshellDisableDragAndDrop)",draggableSelectorBlocker:".sapUshellTilesContainer-sortable, .sapUshellTileContainerBeforeContent, .sapUshellTileContainerAfterContent",draggableSelectorExclude:".sapUshellHeaderActionButton",placeHolderClass:"sapUshellDashboardGroupsContainerItem-placeholder",cloneClass:"sapUshellDashboardGroupsContainerItem-clone",startCallback:this._handleGroupsUIStart.bind(this),endCallback:this._handleGroupDrop.bind(this),dragCallback:this._handleGroupStartDrag.bind(this),moveTolerance:e.getView().isTouch||e.getView().isCombi?10:.1,isLayoutEngine:false,isVerticalDragOnly:true,draggableElement:".sapUshellTileContainerHeader"};if(e.getView().oDashboardGroupsBox.getGroups().length){if(e.getView().getModel().getProperty("/personalization")){sap.ui.require(["sap/ushell/UIActions"],function(t){sap.ushell.Container.getServiceAsync("LaunchPage").then(function(i){this._disableTileUIActions();this._disableGroupUIActions();this._disableLinkUIActions();this.oTileUIActions=new t(jQuery.extend(true,{},a,r)).enable();this.oGroupUIActions=new t(jQuery.extend(true,{},a,h));if(i.isLinkPersonalizationSupported()){this.oLinkUIActions=new t(jQuery.extend(true,{},a,l)).enable()}o=e.getView().getModel().getProperty("/tileActionModeActive");if(o){this.oGroupUIActions.enable()}}.bind(this))}.bind(this))}}},_enableGroupUIActions:function(){if(this.oGroupUIActions){this.oGroupUIActions.enable()}},disableAllDashboardUiAction:function(){this._disableTileUIActions();this._disableLinkUIActions();this._disableGroupUIActions()},_disableTileUIActions:function(){if(this.oTileUIActions){this.oTileUIActions.disable()}},_disableLinkUIActions:function(){if(this.oLinkUIActions){this.oLinkUIActions.disable()}},_disableGroupUIActions:function(){if(this.oGroupUIActions){this.oGroupUIActions.disable()}},_handleTileDragMove:function(e){if(!e.isScrolling){t.getLayoutEngine().moveDraggable(e.moveX,e.moveY,this.aTabBarItemsLocation)}},_handleTileDragAndScrollContinuation:function(e){var i=jQuery("#anchorNavigationBar").offset(),o=i?i.top:0;if(e<o){t.getLayoutEngine()._cancelLongDropTimmer()}return t.getLayoutEngine()._isTabBarCollision(e)},_fillTabBarItemsArray:function(){var e=jQuery(".sapUshellAnchorItem"),t=e.length,i,o=10,n=0,s,a=[],l,r,h,d;for(i=0;i<t;i++){l=e[i];r=l.getBoundingClientRect();a[i]=r.width}for(i=0;i<t;i++){h=a[i];if(h===0){continue}d=Math.round(h/o);for(s=n;s<n+d;s++){this.aTabBarItemsLocation[s]=i}n=s}},_preventTextSelection:function(){if(window.getSelection){var e=window.getSelection();try{e.removeAllRanges()}catch(e){}}},_handleStartDragTile:function(e,i){this._preventTextSelection();t.getLayoutEngine().layoutStartCallback(i);t.initDragMode();jQuery(i).find("a").removeAttr("href");this.oController._handleDrag.call(this.oController,e,i);sap.ui.getCore().getEventBus().publish("launchpad","sortableStart")},_onBeforeCreateLinkClone:function(e,i){t.getLayoutEngine().saveLinkBoundingRects(i)},_handleLinkDrop:function(e,o,n){var s=jQuery.Deferred(),a;if(t.isTabBarActive()){t.tabBarTileDropped()}if(n&&n.clone){jQuery(n.clone).css({opacity:0})}if(i.desktop){jQuery("body").removeClass("sapUshellDisableUserSelect")}if(t.getLayoutEngine().isLinkIntersected()||t.getLayoutEngine().isOriginalAreaChanged()){a=this.oController._handleDrop.call(this.oController,e,o)}if(a){a.then(function(){jQuery("#dashboardGroups .sapUshellHidePlusTile").removeClass("sapUshellHidePlusTile");setTimeout(function(){s.resolve()},0)})}else{setTimeout(function(){s.resolve()},0)}return s.promise()},_handleTileDrop:function(e,i,o){if(t.getLayoutEngine().isOriginalAreaChanged()){return this._handleTileToLinkDrop(e,i,o)}return this._handleTileToTileDrop(e,i,o)},_handleTileToLinkDrop:function(e,t,i){return this._handleLinkDrop(e,t,i)},_handleTileToTileDrop:function(e,o,n){var s;var a;var l;var r=function(e,o){t.endDragMode();jQuery("#dashboardGroups .sapUshellHidePlusTile").removeClass("sapUshellHidePlusTile");this.oController._handleDrop(this.oController,e,o);if(i.desktop){jQuery("body").removeClass("sapUshellDisableUserSelect")}};a=jQuery(".sapUshellTabBarHoverOn");a.removeClass("sapUshellTabBarHoverOn");l=jQuery(".sapUshellTileDragOpacity");l.removeClass("sapUshellTileDragOpacity");if(t.isTabBarActive()){t.tabBarTileDropped()}var h;if(t.isTabBarActive()&&t.isOnTabBarElement()){if(n&&n.clone){h=jQuery.Deferred();s=jQuery(n.clone);s.css("display","none");setTimeout(function(){h.resolve();r.call(this,e,o)}.bind(this),0);return h.promise()}r.apply(this,arguments)}if(n&&n.clone){h=jQuery.Deferred();s=jQuery(n.clone);setTimeout(function(){h.resolve();r.call(this,e,o)}.bind(this),0);return h.promise()}setTimeout(function(){r.call(this,e,o)}.bind(this),0)},_getTileTopOffset:function(e,t,i){var o=0,n=o+i;n+=e.closest(".sapUshellDashboardGroupsContainerItem").position().top;n+=t.top;return n},_markDisableGroups:function(){if(this.oController.getView().getModel()){this.oController.getView().getModel().setProperty("/isInDrag",true)}},_endUIHandler:function(){t.endDragMode();if(this.oController.getView().getModel()){this.oController.getView().getModel().setProperty("/isInDrag",false)}},_handleGroupStartDrag:function(e,t){this.oTileUIActions.disable();if(this.oLinkUIActions){this.oLinkUIActions.disable()}var n=jQuery(".sapUshellDashboardGroupsContainerItem-clone"),s=n.find(".sapUshellContainerTitle"),a=s.height(),l=s.width(),r,h,d,c,p=sap.ui.getCore().getConfiguration().getRTL();if(!i.system.phone){n.find(".sapUshellTileContainerEditMode").offset({top:this.oGroupUIActions.getMove().y-a,left:p?jQuery("#sapUshellDashboardPage").width()+this.oGroupUIActions.getMove().x+l:this.oGroupUIActions.getMove().x-l/2});jQuery(".sapUshellTileContainerBeforeContent").addClass("sapUshellTileContainerHidden")}else{jQuery(".sapUshellTilesContainer-sortable").addClass("sapUshellTileContainerRemoveContent");jQuery(".sapUshellLineModeContainer").addClass("sapUshellTileContainerRemoveContent");jQuery(".sapUshellTileContainerBeforeContent").addClass("sapUshellTileContainerRemoveContent");jQuery(".sapUshellContainerHeaderActions").addClass("sapUshellTileContainerHidden")}jQuery(".sapUshellTileContainerAfterContent").addClass("sapUshellTileContainerRemoveContent");jQuery(t).find(".sapUshellContainerHeaderActions").addClass("sapUshellTileContainerHidden");this.oController.getView().getModel().setProperty("/isInDrag",true);jQuery(t).attr("startPos",jQuery(t).index());o.info("startPos - "+jQuery(t).index());setTimeout(function(){sap.ui.getCore().getEventBus().publish("launchpad","sortableStart")},0);r=jQuery("#dashboardGroups").offset().top;h=jQuery(".sapUshellDashboardGroupsContainerItem-placeholder").offset().top;d=jQuery(".sapUshellDashboardGroupsContainerItem-clone").offset().top;c=h-r-d;jQuery(".sapUshellDashboardView section").css({scrollTop:c})},_handleGroupsUIStart:function(e,t){jQuery(t).find(".sapUshellTileContainerContent").css("outline-color","transparent")},_handleGroupDrop:function(e,t){var i=sap.ui.getCore().getEventBus(),o=jQuery(t),n=jQuery(o.children()[0]).attr("id"),s=sap.ui.getCore().byId(n),a=sap.ui.getCore().byId("dashboardGroups"),l={group:s,groupChanged:false,focus:false},r=o.index();o.startPos=window.parseInt(o.attr("startPos"),10);a.removeAggregation("groups",s,true);a.insertAggregation("groups",s,r,true);this._handleGroupMoved(e,{item:o});o.removeAttr("startPos");sap.ui.getCore().getEventBus().publish("launchpad","sortableStop");setTimeout(function(){jQuery(".sapUshellContainerHeaderActions").removeClass("sapUshellTileContainerHidden");jQuery(".sapUshellTileContainerBeforeContent").removeClass("sapUshellTileContainerHidden");jQuery(".sapUshellTileContainerBeforeContent").removeClass("sapUshellTileContainerRemoveContent");jQuery(".sapUshellTileContainerAfterContent").removeClass("sapUshellTileContainerRemoveContent");jQuery(".sapUshellTilesContainer-sortable").removeClass("sapUshellTileContainerRemoveContent");jQuery(".sapUshellLineModeContainer").removeClass("sapUshellTileContainerRemoveContent")},0);window.setTimeout(jQuery.proxy(i.publish,i,"launchpad","scrollToGroup",l),1);this.oTileUIActions.enable();if(this.oLinkUIActions){this.oLinkUIActions.enable()}},_handleGroupMoved:function(e,t){var i=t.item.startPos,o=t.item.index(),n=this.oController.getView().getModel();if(o!==-1){this.oController._publishAsync("launchpad","moveGroup",{fromIndex:i,toIndex:o});setTimeout(function(){n.setProperty("/isInDrag",false)},100)}},_setController:function(e){this.oController=e}});return n});
//# sourceMappingURL=DashboardUIActions.js.map