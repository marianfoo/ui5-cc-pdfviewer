// Copyright (c) 2009-2022 SAP SE, All Rights Reserved
sap.ui.define(["sap/ui/thirdparty/jquery","sap/ui/base/Object","sap/ui/Device","sap/ui/model/Filter","sap/ushell/ui/launchpad/TileState","sap/ushell/components/_HomepageManager/PagingManager","sap/ushell/components/_HomepageManager/DashboardLoadingManager","sap/ushell/EventHub","sap/ushell/Config","sap/ushell/utils","sap/ushell/resources","sap/ushell/components/DestroyHelper","sap/ushell/components/GroupsHelper","sap/ushell/components/MessagingHelper","sap/m/GenericTile","sap/m/SelectDialog","sap/m/StandardListItem","sap/ushell/components/_HomepageManager/PersistentPageOperationAdapter","sap/ushell/components/_HomepageManager/TransientPageOperationAdapter","sap/ui/model/FilterOperator","sap/m/library","sap/ui/model/Context","sap/m/MessageToast","sap/base/Log","sap/ui/performance/Measurement"],function(jQuery,e,t,i,o,r,s,n,a,l,u,d,p,h,g,c,f,b,M,v,m,P,T,G,_){"use strict";var y=m.GenericTileScope;var I={PERSONALIZATION:"FLP: Personalization",RENAME_GROUP:"FLP: Rename Group",MOVE_GROUP:"FLP: Move Group",DELETE_GROUP:"FLP: Delete Group",RESET_GROUP:"FLP: Reset Group",DELETE_TILE:"FLP: Delete Tile",ADD_TILE:"FLP: Add Tile",MOVE_TILE:"FLP: Move Tile"};var k=[];var w;var L=e.extend("sap.ushell.components.HomepageManager",{metadata:{publicMethods:["getModel","getDashboardView","loadPersonalizedGroups","resetGroupsOnFailure","addGroupToModel","addTileToGroup","deleteTilesFromGroup"]},analyticsConstants:I,constructor:function(e,t){if(w){if(!w.view){w.setDashboardView(t.view)}return w}this.oServiceLoadingPromise=sap.ushell.Container.getServiceAsync("LaunchPage").then(function(e){this.oPageBuilderService=e;this.oPageBuilderService.registerTileActionsProvider(this._addFLPActionsToTile.bind(this));this.oPageOperationAdapter=b.getInstance(e);this.bLinkPersonalizationSupported=this.oPageOperationAdapter.isLinkPersonalizationSupported()}.bind(this));sap.ui.getCore().attachThemeChanged(l.handleTilesVisibility);w=this;this.oModel=t.model;this.oRouter=t.router;this.oDashboardView=t.view;this.oSortableDeferred=new jQuery.Deferred;this.oSortableDeferred.resolve();this.registerEvents();this.tileViewUpdateQueue=[];this.tileViewUpdateTimeoutID=0;this.tileUuid=null;this.bIsGroupsModelLoading=false;this.bIsGroupsRequestPending=false;this.segmentsStore=[];this.bIsFirstSegment=true;this.bIsFirstSegmentViewLoaded=false;this.aGroupsFrame=null;this.iMinNumOfTilesForBlindLoading=this.oModel.getProperty("/optimizeTileLoadingThreshold")||100;this.bIsScrollModeAccordingKPI=false;this.oGroupNotLockedFilter=new i("isGroupLocked",v.EQ,false);this.oDashboardLoadingManager=new s("loadingManager",{oDashboardManager:this});if(this.oRouter){var o=this.oRouter.getTarget("home");o.attachDisplay(function(e){this.oDashboardView=e.getParameter("view")}.bind(this))}var r=a.last("/core/home/enableTransientMode");k.push(a.on("/core/home/enableTransientMode").do(function(e){if(r===e){return}r=e;this._changeMode(e)}.bind(this)));this.oModel.bindProperty("/tileActionModeActive").attachChange(this._changeLinksScope.bind(this));this._aRequestQueue=[];this._bRequestRunning=false;return undefined},_addRequest:function(e){this._aRequestQueue.push(e);if(!this._bRequestRunning){this._bRequestRunning=true;this._aRequestQueue.shift()()}},_checkRequestQueue:function(){if(this._aRequestQueue.length===0){this._bRequestRunning=false}else{this._aRequestQueue.shift()()}},_requestFailed:function(){this._aRequestQueue=[];this._bRequestRunning=false},isBlindLoading:function(){var e=a.last("/core/home/homePageGroupDisplay");if((e===undefined||e==="scroll")&&this.bIsScrollModeAccordingKPI){G.info("isBlindLoading reason IsScrollModeAccordingKPI and IsScrollMode: true");return true}if(this.oModel.getProperty("/tileActionModeActive")){G.info("isBlindLoading reason TileActionModeActive : true");return true}return false},createMoveActionDialog:function(e){var t=new c(e,{title:u.i18n.getText("moveTileDialog_title"),rememberSelections:false,contentWidth:"400px",contentHeight:"auto",confirm:function(t){var i=t.getParameter("selectedContexts");this.publishMoveActionEvents(i,e)}.bind(this),cancel:function(){var e=jQuery('.sapUshellTile[tabindex="0"]')[0];if(e){e.focus()}},items:{path:"/groups",template:new f({title:"{title}"})}});return t},publishMoveActionEvents:function(e,i){var o=sap.ui.getCore().getEventBus();if(e.length){var r=this.tileType==="link"?"links":"tiles",s=e[0].getObject().groupId,n={sTileId:this.tileUuid,sToItems:r,sFromItems:r,sTileType:r,toGroupId:e[0].getObject().groupId,toIndex:e[0].getObject()[this.tileType==="link"?"links":"tiles"].length,source:i};if(t.system.desktop){sap.ui.require(["sap/ushell/components/ComponentKeysHandler"],function(e){e.getInstance().then(function(e){n.callBack=e.callbackSetFocus.bind(e);o.publish("launchpad","scrollToGroup",{groupId:s});o.publish("launchpad","movetile",n)})})}else{o.publish("launchpad","scrollToGroup",{groupId:s});o.publish("launchpad","movetile",n)}}},_changeLinksScope:function(e){var t=this;if(this.bLinkPersonalizationSupported){var i=e.getSource().getValue();this.oModel.getProperty("/groups").forEach(function(e,o){if(!e.isGroupLocked){t._changeGroupLinksScope(e,i?"Actions":"Display")}})}},_changeGroupLinksScope:function(e,t){var i=this;e.links.forEach(function(e,o){i._changeLinkScope(e.content[0],t)})},_changeLinkScope:function(e,t){var i;if(e.getScope){i=e}else if(e.getContent){i=e.getContent()[0]}if(this.bLinkPersonalizationSupported&&i&&i.setScope){i.setScope(t)}},registerEvents:function(){var e=sap.ui.getCore().getEventBus();e.subscribe("launchpad","addBookmarkTile",this._createBookmark,this);e.subscribe("launchpad","tabSelected",this.getSegmentTabContentViews,this);e.subscribe("sap.ushell.services.Bookmark","bookmarkTileAdded",this._addBookmarkToModel,this);e.subscribe("sap.ushell.services.Bookmark","catalogTileAdded",this._refreshGroupInModel,this);e.subscribe("sap.ushell.services.Bookmark","bookmarkTileDeleted",this.loadPersonalizedGroups,this);e.subscribe("launchpad","loadDashboardGroups",this.loadPersonalizedGroups,this);e.subscribe("launchpad","createGroupAt",this._createGroupAt,this);e.subscribe("launchpad","deleteGroup",this._deleteGroup,this);e.subscribe("launchpad","resetGroup",this._resetGroup,this);e.subscribe("launchpad","changeGroupTitle",this._changeGroupTitle,this);e.subscribe("launchpad","moveGroup",this._moveGroup,this);e.subscribe("launchpad","deleteTile",this._deleteTile,this);e.subscribe("launchpad","movetile",this._moveTile,this);e.subscribe("launchpad","sortableStart",this._sortableStart,this);e.subscribe("launchpad","sortableStop",this._sortableStop,this);e.subscribe("launchpad","dashboardModelContentLoaded",this._modelLoaded,this);e.subscribe("launchpad","convertTile",this._convertTile,this)},_changeMode:function(e){var t=this.getModel().getProperty("/groups");if(e){this.oPageOperationAdapter=M.getInstance();var i=this.oPageOperationAdapter.transformGroupModel(t);this.getModel().setProperty("/groups",i)}else{this.oPageOperationAdapter=b.getInstance();d.destroyFLPAggregationModels(t);this.getModel().setProperty("/groups",[]);this.loadPersonalizedGroups()}},_addFLPActionsToTile:function(e){var t=[];if(a.last("/core/shell/enablePersonalization")){var i=this.bLinkPersonalizationSupported&&this.oPageOperationAdapter.isLinkPersonalizationSupported(e);t.push(this._getMoveTileAction(e));if(i){t.push(this._getConvertTileAction(e))}}return t},getPersonalizableGroups:function(){var e=this.getModel().getProperty("/groups");return e.filter(function(e){return!e.isGroupLocked})},_getConvertTileAction:function(e){var i=sap.ui.getCore().getEventBus();var o=this.oPageOperationAdapter.getTileType(e);var r=o==="tile"?"ConvertToLink":"ConvertToTile";return{id:r,text:u.i18n.getText(r),press:function(e){var o={tile:e};if(t.system.desktop){sap.ui.require(["sap/ushell/components/ComponentKeysHandler"],function(e){e.getInstance().then(function(e){o.callBack=e.callbackSetFocus.bind(e);i.publish("launchpad","convertTile",o)})})}else{i.publish("launchpad","convertTile",o)}}}},_getMoveTileAction:function(e){var t="moveTile_action";return{id:t,text:u.i18n.getText(t),press:function(t){this.tileType=this.oPageOperationAdapter.getTileType(e);var o=this.tileType==="tile";this.tileUuid=this.getModelTileById(this.oPageOperationAdapter.getTileId(e),o?"tiles":"links").uuid;var r=t.getParent().getProperty("groupId");var s=new i("groupId",v.NE,r);var n=function(e){var t=e.getParameter("value");var o=new i("title",v.Contains,t);var r=e.getSource().getBinding("items");r.filter([o,this.oGroupNotLockedFilter,s])}.bind(this);var a=o?this.moveTileDialog:this.moveLinkDialog;if(!a){a=this.createMoveActionDialog("move"+this.tileType+"Dialog");a.setModel(this.oModel);if(o){this.moveTileDialog=a}else{this.moveLinkDialog=a}}else{a.detachSearch(a._searchHandler)}a.getBinding("items").filter([this.oGroupNotLockedFilter,s]);a.attachSearch(n);a._searchHandler=n;a.open()}.bind(this)}},_handleTileAppearanceAnimation:function(e){if(!e){return}var t=["webkit",""];function i(i,o){for(var r=0;r<t.length;r++){o=o.toLowerCase();e.attachBrowserEvent(t[r]+o,function(t){if(t.originalEvent&&t.originalEvent.animationName==="sapUshellTileEntranceAnimation"){e.removeStyleClass("sapUshellTileEntrance")}},false)}}i(e,"AnimationEnd");e.addStyleClass("sapUshellTileEntrance")},destroy:function(){var t=sap.ui.getCore().getEventBus();t.unsubscribe("launchpad","addBookmarkTile",this._createBookmark,this);t.unsubscribe("launchpad","loadDashboardGroups",this.loadPersonalizedGroups,this);t.unsubscribe("launchpad","createGroupAt",this._createGroupAt,this);t.unsubscribe("launchpad","deleteGroup",this._deleteGroup,this);t.unsubscribe("launchpad","resetGroup",this._resetGroup,this);t.unsubscribe("launchpad","changeGroupTitle",this._changeGroupTitle,this);t.unsubscribe("launchpad","moveGroup",this._moveGroup,this);t.unsubscribe("launchpad","deleteTile",this._deleteTile,this);t.unsubscribe("launchpad","movetile",this._moveTile,this);t.unsubscribe("launchpad","sortableStart",this._sortableStart,this);t.unsubscribe("launchpad","sortableStop",this._sortableStop,this);t.unsubscribe("launchpad","dashboardModelContentLoaded",this._modelLoaded,this);sap.ui.getCore().detachThemeChanged(l.handleTilesVisibility);k.forEach(function(e){e.off()});b.destroy();M.destroy();w=undefined;e.prototype.destroy.apply(this,arguments)},_sortableStart:function(){this.oSortableDeferred=new jQuery.Deferred},_createBookmark:function(e,t,i){var o=i.group?i.group.object:"";delete i.group;function r(){sap.ushell.Container.getServiceAsync("Bookmark").then(function(e){e.addBookmark(i,o).always(this._checkRequestQueue.bind(this)).done(function(){h.showLocalizedMessage("tile_created_msg")}).fail(function(e){G.error("Failed to add bookmark",e,"sap.ushell.ui.footerbar.AddBookmarkButton");h.showLocalizedError("fail_to_add_tile_msg")})}.bind(this))}this._addRequest(r.bind(this))},_addBookmarkToModel:function(e,t,i){var o=i.tile,r,s=i.group,n,a,u,d,p;if(!i||!o){this.bIsGroupsModelDirty=true;if(!this.bGroupsModelLoadingInProcess){this._handleBookmarkModelUpdate()}return}if(!s){r=this.getModel().getProperty("/groups");for(p=0;p<r.length;p++){if(r[p].isDefaultGroup===true){s=r[p].object;break}}}a=this._getIndexOfGroupByObject(s);u=this.oModel.getProperty("/groups/"+a);n=this.oPageOperationAdapter.getPreparedTileModel(o,u.isGroupLocked);this.getTileView(n);u.tiles.push(n);u.visibilityModes=l.calcVisibilityModes(u,true);d=u.tiles.length;this._updateModelWithTileView(a,d);this.oModel.setProperty("/groups/"+a,u)},_refreshGroupInModel:function(e,t,i){var o=this;this.oPageOperationAdapter.refreshGroup(i).then(function(e){if(!e){return}var t=o._getIndexOfGroupByObject(e.object);e.visibilityModes=l.calcVisibilityModes(e.object,true);o.oModel.setProperty("/groups/"+t,e);if(e.tiles){e.tiles.forEach(function(e){o.getTileView(e)})}})},_sortableStop:function(){this.oSortableDeferred.resolve()},_handleAfterSortable:function(e){return function(){var t=Array.prototype.slice.call(arguments);this.oSortableDeferred.done(function(){e.apply(null,t)})}.bind(this)},_createGroupAt:function(e,t,i){var o=parseInt(i.location,10),r=this.oModel.getProperty("/groups"),s=this.oPageOperationAdapter.getPreparedGroupModel(null,false,o===r.length,i),n=this.oModel,a;s.index=o;r.splice(o,0,s);for(a=0;a<r.length-1;a++){r[a].isLastGroup=false}for(a=o+1;a<r.length;a++){r[a].index++}n.setProperty("/groups",r)},_getIndexOfGroupByObject:function(e){var t=this.oModel.getProperty("/groups");return this.oPageOperationAdapter.getIndexOfGroup(t,e)},getTileActions:function(e){return this.oPageOperationAdapter.getTileActions(e)},addTileToGroup:function(e,t){var i=e+"/tiles",o=this.oModel.getProperty(e),r=this.oModel.getProperty(i).length;var s=this.oModel.getProperty(e+"/isGroupLocked"),n=this.oModel.getProperty("/personalization");o.tiles[r]=this.oPageOperationAdapter.getPreparedTileModel(t,s);this.getTileView(o.tiles[r]);o.visibilityModes=l.calcVisibilityModes(o,n);this._updateModelWithTileView(o.index,r);this.oModel.setProperty(e,o)},addTilesToGroupByCatalogTileId:function(e,t){var i=e.getBindingContext();for(var o=0;o<t.length;o++){this.addTileToGroupByCatalogTileId(i.sPath,t[o])}},addTileToGroupByCatalogTileId:function(e,t){var i,o,r;if(!a.last("/core/home/enableTransientMode")){return}r=this.oPageOperationAdapter.getTileModelByCatalogTileId(t);if(!r){return}this.oDashboardLoadingManager.setTileResolved(r);i=this.oModel.getProperty(e+"/tiles").length;o=this.oModel.getProperty(e);o.tiles[i]=r;this.oModel.setProperty(e,o)},_getPathOfTile:function(e){var t=this.oModel.getProperty("/groups"),i,o,r,s,n;for(var a=0;a<t.length;++a){i=t[a];o=i.tiles;r=i.links;for(s=0;s<o.length;++s){if(o[s].uuid===e){return"/groups/"+a+"/tiles/"+s}}for(n=0;n<r.length;++n){if(r[n].uuid===e){return"/groups/"+a+"/links/"+n}}}return null},_moveInArray:function(e,t,i){if(i>=e.length){var o=i-e.length;while(o--+1){e.push(undefined)}}e.splice(i,0,e.splice(t,1)[0])},_updateGroupIndices:function(e){var t;for(t=0;t<e.length;t++){e[t].index=t}},_deleteGroup:function(e,t,i){var o=this,r=this.oModel,s=i.groupId,n=r.getProperty("/groups"),a=p.getIndexOfGroup(n,s),l=n.length-1===a,u=null,g,c;g=l?a-1:a;d.destroyFLPAggregationModel(r.getProperty("/groups/"+a));u=n.splice(a,1)[0];if(l){r.setProperty("/groups/"+g+"/isLastGroup",l)}r.setProperty("/groups",n);this._updateGroupIndices(n);if(g>=0){c=sap.ui.getCore().getEventBus();window.setTimeout(jQuery.proxy(c.publish,c,"launchpad","scrollToGroup",{groupId:r.getProperty("/groups")[g].groupId}),200)}function f(){o.oPageOperationAdapter.deleteGroup(u).then(function(){h.showLocalizedMessage("group_deleted_msg",[u.title]);o._checkRequestQueue()},function(){o._resetGroupsOnFailure("fail_to_delete_group_msg")})}this._addRequest(f)},_resetGroup:function(e,t,i){var o=this,r=i.groupId,s=this.oModel,a=s.getProperty("/groups"),u=p.getIndexOfGroup(a,r),d=o.oModel.getProperty("/groups/indexOfDefaultGroup")===u,g=s.getProperty("/groups/"+u),c,f;s.setProperty("/groups/"+u+"/sortable",false);function b(){o.oPageOperationAdapter.resetGroup(g,d).then(function(e){o._handleAfterSortable(function(e,t,i){var r=o.oModel.getProperty("/groups"),s=p.getIndexOfGroup(r,e);o._loadGroup(s,i||t);h.showLocalizedMessage("group_reset_msg",[t.title]);o.oModel.setProperty("/groups/"+s+"/sortable",true);c=sap.ui.getCore().byId("dashboardGroups").getGroupControlByGroupId(e);f=c.getBindingContext().getObject().links;if(f&&f.length&&!c.getIsGroupLocked()){o._changeGroupLinksScope(c.getBindingContext().getObject(),o.oModel.getProperty("/tileActionModeActive")?y.Actions:y.Display)}if(c){c.rerender();n.emit("updateGroups",Date.now());l.handleTilesVisibility()}})(r,g,e);o._checkRequestQueue()},function(){o._resetGroupsOnFailure("fail_to_reset_group_msg")})}this._addRequest(b)},_moveGroup:function(e,t,i){if(isNaN(i.fromIndex)){return}var o=i.fromIndex,r=i.toIndex,s=this.oModel,n=s.getProperty("/groups"),a=s.getProperty("/tileActionModeActive"),l,u,d=this,h,g;if(!a){o=this._adjustFromGroupIndex(o,n)}l=n[o];u=l.groupId;if(!a){r=this._adjustToGroupIndex(r,n,u)}g=n[r];this._moveInArray(n,o,r);this._updateGroupIndices(n);for(h=0;h<n.length-1;h++){n[h].isLastGroup=false}n[n.length-1].isLastGroup=true;s.setProperty("/groups",n);function c(){n=s.getProperty("/groups");var e=s.getProperty(p.getModelPathOfGroup(n,u));if(!e.object){return}d.oPageOperationAdapter.getOriginalGroupIndex(g,n).then(function(t){var i={iFromIndex:o,iToIndex:r};return d.oPageOperationAdapter.moveGroup(e,t,i)}).then(d._checkRequestQueue.bind(d),function(){d._resetGroupsOnFailure("fail_to_move_group_msg")})}this._addRequest(c)},_adjustToGroupIndex:function(e,t,i){var o=0,r=false,s=0;for(s=0;s<t.length&&o<e;s++){if(t[s].isGroupVisible){if(t[s].groupId===i){r=true}else{o++}}}if(r){return s-1}return s},_adjustFromGroupIndex:function(e,t){var i=0,o;for(o=0;o<t.length;o++){if(t[o].isGroupVisible){i++}if(i===e+1){return o}}return e},_changeGroupTitle:function(e,t,i){var o=this,r=i.newTitle,s=this.oModel.getProperty("/groups"),n=i.groupId,a=p.getIndexOfGroup(s,n),l=o.oModel.getProperty("/groups/indexOfDefaultGroup")===a,u=this.oModel.getProperty("/groups/"+a),d=u.title;this.oModel.setProperty("/groups/"+a+"/title",r);function h(){var e;if(u.isLastGroup){e=o.oPageOperationAdapter.addGroupAt(u,undefined,l)}else{var t=o.oModel.getProperty("/groups")[a+1];e=o.oPageOperationAdapter.getOriginalGroupIndex(t,s).then(function(e){return o.oPageOperationAdapter.addGroupAt(u,e,l)})}e.then(function(e){o._handleAfterSortable(function(e,t){var i=o.oModel.getProperty("/groups");var r=p.getIndexOfGroup(i,e);var s=i[r];Object.keys(t).forEach(function(e){if(e==="tiles"||e==="links"){return}s[e]=t[e]});o.oModel.refresh();o._checkRequestQueue()})(n,e)},function(){o._resetGroupsOnFailure("fail_to_create_group_msg")})}function g(){this.oPageOperationAdapter.renameGroup(u,r,d).then(function(){o._checkRequestQueue()},function(){o._resetGroupsOnFailure("fail_to_rename_group_msg")})}if(!u.object){this._checkRequestQueue();this._addRequest(h.bind(this))}else{this._addRequest(g.bind(this))}},addGroupToModel:function(e){var t=this.oPageOperationAdapter.getPreparedGroupModel(e,false,true,{isRendered:true}),i=this.oModel.getProperty("/groups"),o=i.length,r;if(o>0){i[o-1].isLastGroup=false}t.index=o;i.push(t);this.oModel.setProperty("/groups/",i);r=new P(this.oModel,"/groups/"+o);return r},_deleteTile:function(e,i,o){var r=o.tileId,s=this.oModel.getProperty("/groups"),n=o.items||"tiles",a,u,p,h;function g(e,t){this.oPageOperationAdapter.removeTile(e,t).then(this._checkRequestQueue.bind(this),this._resetGroupsOnFailure.bind(this,"fail_to_remove_tile_msg"))}function c(e,t,i){var o=sap.ui.getCore().byId("dashboardGroups"),r=o.getGroupControlByGroupId(t.groupId),s;if(i==="tiles"){if(e+1===t[i].length){s=r.oPlusTile}}else{var n=r.getLinks();if(e+1===n.length){if(n.length===1){s=r.oPlusTile}else{s=n[e-1]}}else{s=n[e+1]}}if(s){sap.ui.require(["sap/ushell/components/ComponentKeysHandler"],function(e){e.getInstance().then(function(e){e.moveScrollDashboard(s.$())})})}}for(p=0;p<s.length;++p){a=s[p];for(h=0;h<a[n].length;++h){u=a[n][h];if(u.uuid===r){if(t.system.desktop){c(h,a,n)}d.destroyTileModel(this.oModel.getProperty("/groups/"+p+"/"+n+"/"+h));var f=a[n].splice(h,1)[0],b=this.oModel.getProperty("/personalization");a.visibilityModes=l.calcVisibilityModes(a,b);this.oModel.setProperty("/groups/"+p,a);this._addRequest(g.bind(this,a,f));l.handleTilesVisibility();return}}}},deleteTilesFromGroup:function(e,t){var i=this.oModel.getProperty("/groups"),o=p.getIndexOfGroup(i,e),r=this.oModel.getProperty("/groups/"+o),s=[];["tiles","links"].forEach(function(e){s=r[e].filter(function(e){if(t.indexOf(e.uuid)<0){return true}return false});r[e]=s});r.visibilityModes=l.calcVisibilityModes(r,true);this.oModel.setProperty("/groups/"+o,r)},_getGroupIndex:function(e){var t=this.oModel.getProperty("/groups"),i=this._getNewGroupInfo(t,e);if(i){return i.newGroupIndex}return undefined},_convertTile:function(e,t,i){var o=i.tile?i.tile:i,r=i.srcGroupId?this._getGroupIndex(i.srcGroupId):undefined,s=i.srcGroupId?this.oModel.getProperty("/groups/"+r):o.getParent().getBindingContext().getObject(),a=o.getBindingContext().sPath.split("/"),d=o.getBindingContext().getObject(),p=a[a.length-2],h=d.uuid,g=parseInt(a[a.length-1],10),c=i.toIndex!==undefined?i.toIndex:undefined,f=this.oModel.getProperty("/tileActionModeActive"),b=i.toGroupId?this._getGroupIndex(i.toGroupId):s.index,M=i.toGroupId?this.oModel.getProperty("/groups/"+b):s,v=this;var m=this._getIndexForConvert(p,g,c,s,M),P={tileIndex:g,groupIndex:r,group:s};function G(){d.tileIsBeingMoved=true;var e=this.oPageOperationAdapter.moveTile(d,m,s,M,p==="links"?"tile":"link");e.then(function(e){v._handleAfterSortable(function(e,t){var o=v._getPathOfTile(e);var r=t.content;if(o){if(p==="tiles"){v._attachLinkPressHandlers(r);v._changeLinkScope(r,f?"Actions":"Display")}if(s===M){T.show(u.i18n.getText("PageRuntime.Message.VisualizationConverted"))}else{T.show(u.i18n.getText("PageRuntime.Message.VisualizationMovedAndConverted"))}var a={tileIndex:c,groupIndex:b,group:M};var h={tile:d,view:r,type:p,tileObj:t.object};d.tileIsBeingMoved=true;v.replaceTileViewAfterConvert(P,a,h);n.emit("updateGroups",Date.now());l.handleTilesVisibility();if(i.callBack){i.callBack(r)}}})(h,e);v._checkRequestQueue()},function(){v._handleAfterSortable(v._resetGroupsOnFailure.bind(v))("fail_to_move_tile_msg")})}this._addRequest(G.bind(this))},replaceTileViewAfterConvert:function(e,t,i){var o=i.tile,r=o.content;o.tileIsBeingMoved=false;o.content=[i.view];o.object=i.tileObj;o.originalTileId=this.oPageOperationAdapter.getTileId(i.tileObj);e.group[i.type].splice(e.tileIndex,1);if(t.tileIndex!==undefined){t.group[i.type==="tiles"?"links":"tiles"].splice(t.tileIndex,0,o)}else{t.group[i.type==="tiles"?"links":"tiles"].push(o)}this.oModel.setProperty("/groups/"+t.groupIndex,t.group);this.oModel.setProperty("/groups/"+e.groupIndex,e.group);if(i.type==="links"){this._handleTileAppearanceAnimation(o.content[0].getParent())}else{this._handleTileAppearanceAnimation(o.content[0])}if(r&&r[0]){r[0].destroy()}},_getIndexForConvert:function(e,t,i,o,r){var s;if(e==="tiles"){if(i!==undefined){s=r[e].length+i}else{s=r[e].length+r.links.length}if(o.groupId===r.groupId){s--}}else{s=i||o.tiles.length;t+=o.tiles.length}return{tileIndex:t,newTileIndex:s}},_getIndexForMove:function(e,t,i,o,r){var s;if(e==="tiles"){s=i!==undefined?i:o[e].length}else{if(i!==undefined){s=o.tiles.length+i}else{s=o.tiles.length+o.links.length}t+=r.tiles.length}return{tileIndex:t,newTileIndex:s}},_getTileInfo:function(e,t,i){var o,r,s,n;for(o=0;o<e.length;++o){s=e[o];for(r=0;r<s[i].length;++r){n=s[i][r];if(n.uuid===t){return{oTile:n,tileIndex:r,oGroup:s,groupIndex:o}}}}return},_getNewGroupInfo:function(e,t){var i;for(var o=0;o<e.length;++o){i=e[o];if(i.groupId===t){return{oNewGroup:i,newGroupIndex:o}}}return},_moveTile:function(e,t,i){var o=i.toIndex,r=i.toGroupId,s=i.sTileId,a=i.source,d=i.sTileType==="tiles"||i.sTileType==="tile"?"tile":"link",p=i.sToItems,h=i.sFromItems,g=this.oModel.getProperty("/tileActionModeActive"),c=this.oModel.getProperty("/groups"),f,b,M,v,m,P={},G=this;v=this._getTileInfo(c,s,h);m=this._getNewGroupInfo(c,r);var _=v.tileIndex===m.oNewGroup.tiles.length-1&&o>=m.oNewGroup.tiles.length;if((v.tileIndex===o||_)&&v.oGroup.groupId===m.oNewGroup.groupId){return}if(v.oGroup.groupId===m.oNewGroup.groupId&&(a==="movetileDialog"||o===null||a==="movelinkDialog")){if(i.callBack&&v.oTile&&v.oTile.content&&v.oTile.content.length){i.callBack(v.oTile.content[0])}return}if(d==="link"){v.oTile.content[0].addStyleClass("sapUshellZeroOpacity")}if(d==="tile"&&p==="tiles"){if(o&&o>m.oNewGroup[p].length){o=m.oNewGroup[p].length}}if(v.oGroup.groupId===r&&p===h){if(o===null||o===undefined){v.oGroup[p].splice(v.tileIndex,1);o=v.oGroup[p].length;v.oGroup[p].push(v.oTile)}else{o=this._adjustTileIndex(o,v.oTile,v.oGroup,p);this._moveInArray(v.oGroup[p],v.tileIndex,o)}this.oModel.setProperty("/groups/"+v.groupIndex+"/"+p,v.oGroup[p])}else{M=this.oModel.getProperty("/personalization");v.oGroup[h].splice(v.tileIndex,1);v.oGroup.visibilityModes=l.calcVisibilityModes(v.oGroup,M);this.oModel.setProperty("/groups/"+v.groupIndex+"/"+h,v.oGroup[h]);if(o===null||o===undefined){o=m.oNewGroup[p].length;m.oNewGroup[p].push(v.oTile)}else{o=this._adjustTileIndex(o,v.oTile,m.oNewGroup,p);m.oNewGroup[p].splice(o,0,v.oTile)}m.oNewGroup.visibilityModes=l.calcVisibilityModes(m.oNewGroup,M);this.oModel.setProperty("/groups/"+m.newGroupIndex+"/"+p,m.oNewGroup[p])}n.emit("updateGroups",Date.now());l.handleTilesVisibility();function y(){f=this.oModel.getProperty("/groups/"+v.groupIndex);b=this.oModel.getProperty("/groups/"+m.newGroupIndex);P=this._getIndexForMove(h,v.tileIndex,o,m.oNewGroup,f);v.oTile.tileIsBeingMoved=true;this.oPageOperationAdapter.moveTile(v.oTile,P,f,b,d).then(function(e){var t=G._getPathOfTile(s);if(t){G.oModel.setProperty(t+"/object",e.object);G.oModel.setProperty(t+"/originalTileId",e.originalTileId);var o=G.oModel.getProperty(t+"/content");var r=e.content;if(p==="links"){G._changeLinkScope(r,g?"Actions":"Display");G._attachLinkPressHandlers(r);G._handleTileAppearanceAnimation(r);v.oTile.content=[r];G.oModel.setProperty(t,jQuery.extend({},v.oTile));G.oModel.setProperty("/groups/"+m.newGroupIndex+"/"+p,G.oModel.getProperty("/groups/"+m.newGroupIndex+"/"+p))}else{G.oModel.setProperty(t+"/content",[r])}if(o&&o[0]){var n=r.onAfterRendering;r.onAfterRendering=function(){n.apply(this);o[0].destroy();r.onAfterRendering=n}}G.oModel.setProperty(t+"/tileIsBeingMoved",false);if(i.callBack){i.callBack(r)}T.show(u.i18n.getText("PageRuntime.Message.VisualizationMoved"))}G._checkRequestQueue()},function(){G._resetGroupsOnFailure("fail_to_move_tile_msg")})}this._addRequest(y.bind(this))},_adjustTileIndex:function(e,t,i,o){var r=0,s=false,n=0;for(n=0;n<i[o].length&&r<e;n++){if(i[o][n].isTileIntentSupported){if(i[o][n]===t){s=true}else{r++}}}if(s){return n-1}return n},getModel:function(){return this.oModel},getDashboardView:function(){return this.oDashboardView},setDashboardView:function(e){this.oDashboardView=e;return this},setTileVisible:function(e,t){this.oPageOperationAdapter.setTileVisible(e.object,t)},refreshTile:function(e){this.oPageOperationAdapter.refreshTile(e.object)},updateSettings:function(e){this.oModel=e.model||this.oModel;this.oConfig=e.config||this.oConfig;this.oRouter=e.router||this.oRouter;this.oDashboardView=e.view||this.oDashboardView},_resetGroupsOnFailure:function(e,t){this._requestFailed();h.showLocalizedError(e,t);this.bStartLoadRemainSegment=false;this.loadPersonalizedGroups();this.oModel.updateBindings(true)},resetGroupsOnFailure:function(){this._resetGroupsOnFailure.apply(this,arguments)},_bindSegment:function(e,t){var i,o,r,s;for(i=0;i<t.length;i++){r=t[i];s=r.index;o=e[s];if(o){o.isRendered=true;o.tiles=o.tiles.concat(r.tiles);o.links=o.links.concat(r.links)}}return e},createGroupsModelFrame:function(e,t){var i,o=[],r,s;s=function(e){var t=jQuery.extend({},e);t.tiles=[];t.pendingLinks=[];t.links=[];return t};for(i=0;i<e.length;i++){r=e[i];o[i]=s(r);o[i].isRendered=false;o[i].visibilityModes=l.calcVisibilityModes(r,t)}return o},_splitGroups:function(e,t){var i,o=[],r=0,s=this.oModel.getProperty("/homePageGroupDisplay")==="tabs",n=this.oModel.getProperty("/personalization"),a=0,l;var u=500;for(i=0;i<e.length;i++){l=e[i];o.push(l);if(!this.segmentsStore.length){r+=this.PagingManager.getGroupHeight(l,t===i,n)}else{a+=l.tiles.length+l.links.length}if(s&&!this.segmentsStore.length&&r>0){o.loadTilesView=true;this.segmentsStore.push(o);o=[];r=0}if(r>=1||a>=u){this.segmentsStore.push(o);o=[];r=0;a=0}}if(o.length){this.segmentsStore.push(o)}},_processSegment:function(e){var t=this.segmentsStore.shift();if(!t){return e}if(this.isBlindLoading()===false){if(this.oModel.getProperty("/homePageGroupDisplay")!=="tabs"||t.loadTilesView){this.getSegmentContentViews(t)}}e=this._bindSegment(e,t);return e},getSegmentContentViews:function(e){var t,i,o,r;for(t=0;t<e.length;t++){o=e[t];for(i=0;i<o.tiles.length;i++){r=o.tiles[i];if(r.isTileIntentSupported){this.getTileView(r)}}for(i=0;i<o.links.length;i++){r=o.links[i];if(r.isTileIntentSupported){this.getTileView(r,o.index)}}}this.bIsFirstSegmentViewLoaded=true},getSegmentTabContentViews:function(e,t,i){var o,r,s=i.iSelectedGroup,n;n=this.oModel.getProperty("/groups/"+s);for(o=0;o<n.tiles.length;o++){r=n.tiles[o];if(r.isTileIntentSupported){this.getTileView(r)}}for(o=0;o<n.links.length;o++){r=n.links[o];if(r.isTileIntentSupported){this.getTileView(r,s)}}},_handleBookmarkModelUpdate:function(){this.bIsGroupsModelDirty=false;this.bGroupsModelLoadingInProcess=true;this.loadPersonalizedGroups()},_modelLoaded:function(){this.bGroupsModelLoadingInProcess=false;if(this.bIsGroupsModelDirty){this._handleBookmarkModelUpdate()}},handleFirstSegmentLoaded:function(){var e=this.oModel.getProperty("/groups");if(this.aGroupsFrame){Array.prototype.push.apply(e,this.aGroupsFrame);this.aGroupsFrame=null}this._initializeAnchorNavigationBar();if(!this.bStartLoadRemainSegment){this._processRemainingSegments()}},_initializeAnchorNavigationBar:function(){var e,t=w.getDashboardView();e=t.getAnchorItemTemplate();this.oDashboardView.oAnchorNavigationBar.bindAggregation("groups",{path:"/groups",template:e})},_processRemainingSegments:function(){var e;if(this.segmentsStore.length>0){window.setTimeout(function(){e=this._processSegment(this.oModel.getProperty("/groups"));this.oModel.setProperty("/groups",e);this.bIsFirstSegment=false;this._processRemainingSegments()}.bind(this),0)}else{this.bIsGroupsModelLoading=false;this._updateModelWithTileView(0,0);l.handleTilesVisibility();sap.ui.getCore().getEventBus().publish("launchpad","dashboardModelContentLoaded");n.emit("updateGroups",Date.now())}},tabsModeVisibilityChanged:function(){if(this.bIsFirstSegmentViewLoaded===false&&this.oModel.getProperty("/homePageGroupDisplay")==="tabs"){this.oDashboardLoadingManager.manageTilesView();this.bIsFirstSegmentViewLoaded=true;n.emit("firstSegmentCompleteLoaded",true)}},_setGroupModel:function(e){if(this.bIsGroupsModelLoading){G.info("Skip set the group model, because the group model is still loading");return}var t=0,i,o=0,s=0,a=0,u,p,h=null,g,c,f=[];this.bIsGroupsModelLoading=true;try{o=this.oModel.getProperty("/groups").length}catch(e){}for(t=e.length;t<o;++t){d.destroyFLPAggregationModel(this.oModel.getProperty("/groups/"+t))}if(!this.PagingManager){var b=jQuery("#dashboardGroups").width();if(!b){b=window.innerWidth}var M=jQuery("#sapUshellDashboardPage-cont").height();if(M<100){M=window.innerHeight}this.PagingManager=new r("dashboardPaging",{supportedElements:{tile:{className:"sapUshellTile"},link:{className:"sapUshellLinkTile"}},containerHeight:M,containerWidth:b})}e.forEach(function(e){if(e.isGroupVisible){s+=e.tiles.length}});this.bIsScrollModeAccordingKPI=s>this.iMinNumOfTilesForBlindLoading;this.aGroupsFrame=this.createGroupsModelFrame(e,this.oModel.getProperty("/personalization"));for(t=0;t<this.aGroupsFrame.length;t++){if(this.aGroupsFrame[t].isGroupVisible&&this.aGroupsFrame[t].visibilityModes[0]){if(h===null){h=t;this.aGroupsFrame[t].isGroupSelected=true;this.oModel.setProperty("/iSelectedGroup",t)}a++;if(a>1){this.aGroupsFrame[h].showGroupHeader=false;break}}}this._splitGroups(e,h);p=this.segmentsStore[0]?this.segmentsStore[0].length:0;u=this.aGroupsFrame.splice(0,p);_.start("FLP:DashboardManager._processSegment","_processSegment","FLP");f=this._processSegment(u);e.every(function(e,t){if(e.isDefaultGroup){i=t;return false}return true});f.indexOfDefaultGroup=i;if(this.oModel.getProperty("/homePageGroupDisplay")==="tabs"){g=this.getDashboardView();if(g){c=g.oDashboardGroupsBox;var v=c.getBinding("groups");if(v){v.filter([g.oFilterSelectedGroup])}}}_.end("FLP:DashboardManager._processSegment");this.oModel.setProperty("/groups",f);this.aGroupModel=f;if(this.oDashboardView){n.once("firstSegmentCompleteLoaded").do(function(){l.setPerformanceMark("FLP-TTI-Homepage",{bUseUniqueMark:true})}).do(this.handleFirstSegmentLoaded.bind(this))}else{setTimeout(function(){Array.prototype.push.apply(this.aGroupModel,this.aGroupsFrame);this.aGroupsFrame=null;this.bStartLoadRemainSegment=true;this._processRemainingSegments()}.bind(this),0)}if(this.bIsFirstSegmentViewLoaded){n.emit("firstSegmentCompleteLoaded",true)}_.end("FLP:DashboardManager.loadGroupsFromArray")},getPreparedGroupModel:function(){return this.aGroupModel},_loadGroup:function(e,t){var i=this,o="/groups/"+e,r=i.oModel.getProperty(o),s=r.isLastGroup,n=r.groupId;d.destroyFLPAggregationModel(r);if(n){t.groupId=n}t.isLastGroup=s;t.index=e;t.isRendered=true;this.oModel.setProperty(o,t)},_hasPendingLinks:function(e){for(var t=0;t<e.length;t++){if(e[t].content[0]===undefined){return true}}return false},_addModelToTileViewUpdateQueue:function(e,t){this.tileViewUpdateQueue.push({uuid:e,view:t})},_updateModelWithTileView:function(e,t){var i=this;if(this.tileViewUpdateTimeoutID){clearTimeout(this.tileViewUpdateTimeoutID)}this.tileViewUpdateTimeoutID=window.setTimeout(function(){i.tileViewUpdateTimeoutID=undefined;i.oSortableDeferred.done(function(){i._updateModelWithTilesViews(e,t)})},50)},_updateGroupModelWithTilesViews:function(e,t,i,o){var r,s,n,a,l=t||0;for(var u=l;u<e.length;u=u+1){r=e[u];for(var d=0;d<this.tileViewUpdateQueue.length;d++){s=this.tileViewUpdateQueue[d];if(r.uuid===s.uuid){i.push(d);if(s.view){if(o){r.content=[s.view]}else{r.content[0].destroy();r.content=[s.view]}this.oDashboardLoadingManager.setTileResolved(r);n=this.oPageOperationAdapter.getTileSize(r.object);a=n!==null&&n==="1x2"||false;if(r.long!==a){r.long=a}}else{r.content[0].setState("Failed")}break}}}},_updateModelWithTilesViews:function(e,t){var i=this.oModel.getProperty("/groups"),o=e||0,r=[];if(!i||this.tileViewUpdateQueue.length===0){return}for(var s=o;s<i.length;s=s+1){this._updateGroupModelWithTilesViews(i[s].tiles,t,r);if(i[s].links){this._updateGroupModelWithTilesViews(i[s].links,t,r,true);if(i[s].pendingLinks.length>0){if(!i[s].links){i[s].links=[]}i[s].links=i[s].links.concat(i[s].pendingLinks);i[s].pendingLinks=[]}}}var n=[],a;for(a=0;a<this.tileViewUpdateQueue.length;a++){if(r.indexOf(a)===-1){n.push(this.tileViewUpdateQueue[a])}}this.tileViewUpdateQueue=n;this.oModel.setProperty("/groups",i)},getModelTileById:function(e,t){var i=this.oModel.getProperty("/groups"),o,r=false;i.every(function(i){i[t].every(function(t){if(t.uuid===e||t.originalTileId===e){o=t;r=true}return!r});return!r});return o},_attachLinkPressHandlers:function(e){var t=sap.ui.getCore().getEventBus(),i=e.attachPress?e:e.getContent()[0];i.attachPress(function(i){var o=e.getBindingContext().getObject().tileIsBeingMoved;if(!o&&this.getScope&&this.getScope()==="Actions"){switch(i.getParameters().action){case"Press":var r=e.getState?e.getState():"";if(r!=="Failed"){sap.ushell.components.homepage.ActionMode._openActionsMenu(i)}break;case"Remove":var s=e.getBindingContext().getObject().uuid;t.publish("launchpad","deleteTile",{tileId:s,items:"links"});break;default:break}}else{t.publish("launchpad","dashboardTileLinkClick")}})},handleDisplayModeChange:function(e){this.oModel.setProperty("/homePageGroupDisplay",e);switch(e){case"scroll":this._handleDisplayModeChangeToScroll();break;case"tabs":this._handleDisplayModeChangeToTabs();break}},_handleDisplayModeChangeToTabs:function(){var e=this.oModel.getProperty("/iSelectedGroup"),t=this.oModel.getProperty("/groups");this.oDashboardLoadingManager.manageTilesView();if(t.length>0){for(var i=0;i<t.length;i++){this.oModel.setProperty("/groups/"+i+"/isGroupSelected",false)}this.oModel.setProperty("/groups/"+e+"/isGroupSelected",true)}},_handleDisplayModeChangeToScroll:function(){if(this.isBlindLoading()){return}var e=this.oModel.getProperty("/groups"),t,i,o,r=[],s,n;for(s=0;s<e.length;s++){t=e[s];i=t.tiles||[];for(n=0;n<i.length;n++){o=i[n];if(o.content.length===0){this.getTileView(o,s)}}r=t.links||[];for(n=0;n<r.length;n++){this.getTileView(r[n],s)}}this.oModel.refresh(false);var a=this.oModel.getProperty("/iSelectedGroup");if(a){setTimeout(function(){sap.ui.getCore().getEventBus().publish("launchpad","scrollToGroup",{groupId:e[a].groupId})},100)}},getTileViewsFromArray:function(e){var t=this;if(e.length===0){return}e.forEach(function(e){t.getTileView(e.oTile,e.iGroup)});this.oModel.refresh(false);if(this.bIsFirstSegmentViewLoaded===false){this.bIsFirstSegmentViewLoaded=true;n.emit("firstSegmentCompleteLoaded",true)}},getTileView:function(e,t){var i=this.oPageOperationAdapter.getTileType(e.object);if(this.oDashboardLoadingManager.isTileViewRequestIssued(e)){return}this.oDashboardLoadingManager.setTileInProgress(e);this.oPageOperationAdapter.setTileVisible(e.object,false);if(i==="card"){this._loadCardData(e)}else{this._loadTileData(e,t,i)}},_loadCardData:function(e){var t=sap.ui.getCore().byId(e.controlId);if(t&&t.setManifest&&this.isBlindLoading()){t.setManifest(e.manifest)}e.content=[e.manifest];this.oDashboardLoadingManager.setTileResolved(e)},getCurrentHiddenGroupIds:function(e){return this.oPageOperationAdapter.getCurrentHiddenGroupIds(e)},_loadTileData:function(e,t,i){var r=this,s=this.oPageOperationAdapter.getTileView(e),n,a,l,u=this._addModelToTileViewUpdateQueue,d,p=false,h=e.uuid,c=false;if(s.state()==="resolved"){c=true}s.done(function(i){if(i.oController&&i.oController.navigationTargetUrl&&!e.isCustomTile){e.target=i.oController.navigationTargetUrl}d=i;if(d.getComponentInstance){_.average("FLP:getComponentInstance","get info for navMode","FLP1");var o=d.getComponentInstance().getComponentData();if(o&&o.properties){e.navigationMode=o.properties.navigationMode}_.end("FLP:getComponentInstance")}r.oDashboardLoadingManager.setTileResolved(e);n=i.getMode?i.getMode():"ContentMode";if(r.bLinkPersonalizationSupported&&n==="LineMode"){r._attachLinkPressHandlers(d);if(t>=0){a=r.oModel.getProperty("/groups");if(a[t]){e.content=[d];l=r.oModel.getProperty("/groups/"+t+"/links");r.oModel.setProperty("/groups/"+t+"/links",[]);r.oModel.setProperty("/groups/"+t+"/links",l)}}}else if(r.isBlindLoading()){if(e.content&&e.content.length>0){e.content[0].destroy()}e.content=[d];if(t>=0&&!c){r.oModel.refresh(false)}}if(r.isBlindLoading()){var s=r.oPageOperationAdapter.getTileSize(e.object);var g=s==="1x2";if(e.long!==g){e.long=g}}else if(n==="LineMode"){e.content=[d];if(p){l=r.oModel.getProperty("/groups/"+t+"/links");r.oModel.setProperty("/groups/"+t+"/links",[]);r.oModel.setProperty("/groups/"+t+"/links",l)}}else if(e.content.length===0){e.content=[d]}else{u.apply(r,[h,d]);r._updateModelWithTileView(0,0)}});s.fail(function(){if(r.oPageOperationAdapter.getTileType(e.object)==="link"&&r.bLinkPersonalizationSupported){d=r.oPageOperationAdapter.getFailedLinkView(e);r._attachLinkPressHandlers(d)}else{d=new o({state:"Failed"})}e.content=[d]});if(!d){if(r.oPageOperationAdapter.getTileType(e.object)==="link"){p=true;d=new g({mode:"LineMode"})}else{d=new o}e.content=[d]}},loadPersonalizedGroups:function(){var e=this;var t=new jQuery.Deferred;if(this.bIsGroupsRequestPending){G.info("loadPersonalizedGroups was skipped because there is already a pending request.");t.reject();return t.promise()}this.bIsGroupsRequestPending=true;this.oServiceLoadingPromise.then(function(){return e.oPageOperationAdapter.getPage()}).then(function(i){e._setGroupModel(i);e.bIsGroupsRequestPending=false;t.resolve()}).catch(function(){h.showLocalizedError("fail_to_load_groups_msg");e.bIsGroupsRequestPending=false});_.start("FLP:DashboardManager.loadPersonalizedGroups","loadPersonalizedGroups","FLP");return t.promise()}});L.prototype.getInstance=function(){return w};return L});
//# sourceMappingURL=HomepageManager.js.map