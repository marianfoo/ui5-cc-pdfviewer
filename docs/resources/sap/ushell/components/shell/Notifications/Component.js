// Copyright (c) 2009-2022 SAP SE, All Rights Reserved
sap.ui.define(["sap/base/Log","sap/ui/Device","sap/m/library","sap/m/Popover","sap/ui/core/IconPool","sap/ui/core/InvisibleText","sap/ui/core/UIComponent","sap/ushell/EventHub","sap/ushell/library","sap/ushell/resources","sap/ushell/utils","sap/ushell/ui/shell/ShellHeadItem"],function(i,t,e,o,n,s,a,r,l,c,h,u){"use strict";var f=e.PlacementType;var d=l.FloatingNumberType;function p(){return sap.ui.getCore().byId("NotificationsCountButton")}return a.extend("sap.ushell.components.shell.Notifications.Component",{metadata:{version:"1.108.12",library:"sap.ushell.components.shell.Notifications",dependencies:{libs:["sap.m"]}},createContent:function(){this._aTimeouts=[];this.oRenderer=sap.ushell.Container.getRenderer("fiori2");this.oShellModel=this.oRenderer.shellCtrl.getModel();sap.ushell.Container.getServiceAsync("Notifications").then(function(i){this.oNotificationsService=i;if(this.oNotificationsService.isEnabled()===true){sap.ui.getCore().getEventBus().subscribe("sap.ushell.services.Notifications","onNewNotifications",this._handleAlerts,this);this.oShellModel.setProperty("/enableNotifications",true);this.oNotificationsService.init();if(this.oRenderer.getShellConfig().enableNotificationsUI===true){this.oShellModel.setProperty("/enableNotificationsUI",true);this.oNotificationsService.registerDependencyNotificationsUpdateCallback(this._updateCount.bind(this),true)}this._createNotificationButton(this.oShellModel);this.oRenderer.oShellModel.addHeaderEndItem(["NotificationsCountButton"],false,["home","app","minimal"],true);r.on("showNotifications").do(this._toggleNotifications.bind(this))}}.bind(this))},_createNotificationButton:function(i){var e="NotificationsCountButton";var o=new u({id:e,tooltip:c.i18n.getText("notificationsBtn_title"),icon:n.getIconURI("bell"),text:c.i18n.getText("notificationsBtn_title"),ariaLabel:c.i18n.getText("notificationsBtn_title"),ariaHaspopup:"dialog",enabled:true,selected:false,visible:"{/enableNotifications}",floatingNumber:"{/notificationsCount}",floatingNumberMaxValue:t.system.phone?99:999,floatingNumberType:d.Notifications,press:function(){r.emit("showNotifications",Date.now())}});o.setModel(i);o.setModel(c.i18nModel,"i18n")},_handleAlerts:function(i,t,e){(e||[]).forEach(this.handleNotification.bind(this))},handleNotification:function(i){var t=this.oRenderer.addRightFloatingContainerItem({press:function(){if(this.oPopover){this.oPopover.close()}if(window.hasher.getHash()!==i.NavigationTargetObject+"-"+i.NavigationTargetAction){h.toExternalWithParameters(i.NavigationTargetObject,i.NavigationTargetAction,i.NavigationTargetParams)}this.oNotificationsService.markRead(i.Id)}.bind(this),close:function(){this.oRenderer.removeRightFloatingContainerItem(t.getId(),true)}.bind(this),datetime:c.i18n.getText("notification_arrival_time_now"),title:i.SensitiveText?i.SensitiveText:i.Text,description:i.SubTitle,unread:i.IsRead,priority:"High",hideShowMoreButton:true},true,true);this.oRenderer.showRightFloatingContainer(true);var e=setTimeout(function(){this.oRenderer.removeRightFloatingContainerItem(t.getId(),true)}.bind(this),5200);this._aTimeouts.push(e)},_updateCount:function(){this.oNotificationsService.getUnseenNotificationsCount().done(function(i){this.oShellModel.setProperty("/notificationsCount",parseInt(i,10))}.bind(this)).fail(function(t){i.error("Notifications - call to notificationsService.getCount failed: ",t)})},_getPopover:function(){if(!this._oNotificationsPopoverPromise){this._oNotificationsPopoverPromise=new Promise(function(i,t){sap.ui.require(["sap/ui/core/mvc/XMLView"],function(e){e.create({id:"notificationsView",viewName:"sap.ushell.components.shell.Notifications.Notifications",viewData:{notificationsService:this.oNotificationsService}}).then(function(t){var e=t.byId("notificationIconTabBar");e.enhanceAccessibilityState=function(i,t){if(i.isA("sap.m.IconTabHeader")){t.role="";t.label=c.i18n.getText("Notifications.Popover.IconTabBar.Header.AriaLabel")}return t};var n=new o("shellNotificationsPopover",{showHeader:false,placement:f.Bottom,showArrow:true,content:t,beforeClose:function(i){i.getSource().getContent()[0].invalidate();this._resetCount()}.bind(this)});n._oAriaLabelledByText=new s(n.getId()+"-labelledBy",{text:c.i18n.getText("NotificationToggleButton.NoNewNotifications")}).toStatic();n.addDependent(n._oAriaLabelledByText);n.addAriaLabelledBy(n._oAriaLabelledByText);n.addStyleClass("sapUshellNotificationsPopup");n.addStyleClass("sapContrastPlus");i(n)}.bind(this)).catch(t)}.bind(this))}.bind(this))}return this._oNotificationsPopoverPromise},_toggleNotifications:function(i){this._getPopover().then(function(t){var e=p();if(!e.$().width()){e=sap.ui.getCore().byId("endItemsOverflowBtn")}if(t.isOpen()){t.close()}else if(i!==false){this._resetCount();t.openBy(e)}}.bind(this))},_resetCount:function(){this.oShellModel.setProperty("/notificationsCount",0);this.oNotificationsService.notificationsSeen()},exit:function(){sap.ui.getCore().getEventBus().unsubscribe("sap.ushell.services.Notifications","onNewNotifications",this._handleAlerts,this);if(this.oNotificationsService&&this.oNotificationsService.isEnabled()===true){this.oNotificationsService.destroy()}this.oNotificationsService=null;var i=p();if(i){this.oRenderer.hideHeaderEndItem(i,false);i.destroy()}this.oRenderer=null;var t=sap.ui.getCore().byId("notificationsView");if(t){t.destroy();t=null}this._aTimeouts.forEach(window.clearTimeout)}})});
//# sourceMappingURL=Component.js.map