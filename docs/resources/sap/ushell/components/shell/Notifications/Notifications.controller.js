// Copyright (c) 2009-2022 SAP SE, All Rights Reserved
sap.ui.define(["sap/ui/Device","sap/ushell/utils","sap/ushell/resources","sap/m/Text","sap/m/VBox","sap/m/CustomListItem","sap/ui/thirdparty/jquery","sap/ui/events/KeyCodes","sap/base/Log","sap/ui/model/json/JSONModel","sap/m/MessageToast","sap/m/library","sap/ui/core/library","sap/ui/core/mvc/Controller"],function(t,e,i,o,n,s,jQuery,r,a,c,f,d,g,l){"use strict";var h=g.Priority;var u=d.ListType;var I=d.FlexAlignItems;function N(t){sap.ushell.Container.getServiceAsync("Message").then(function(e){e.error(t)})}l.extend("sap.ushell.components.shell.Notifications.Notifications",{oPagingConfiguration:{MAX_NOTIFICATION_ITEMS_DESKTOP:400,MAX_NOTIFICATION_ITEMS_MOBILE:100,MIN_NOTIFICATION_ITEMS_PER_BUFFER:15,NOTIFICATION_ITEM_HEIGHT:t.system.phone||t.system.tablet?130:100,TAB_BAR_HEIGHT:100},onInit:function(){var e={};if(t.system.desktop){this.iMaxNotificationItemsForDevice=this.oPagingConfiguration.MAX_NOTIFICATION_ITEMS_DESKTOP}else{this.iMaxNotificationItemsForDevice=this.oPagingConfiguration.MAX_NOTIFICATION_ITEMS_MOBILE}this.oNotificationsService=this.getView().getViewData().notificationsService;this.oSortingType=this.oNotificationsService.getOperationEnum();e[this.oSortingType.NOTIFICATIONS_BY_DATE_DESCENDING]=this.getInitialSortingModelStructure();e[this.oSortingType.NOTIFICATIONS_BY_DATE_ASCENDING]=this.getInitialSortingModelStructure();e[this.oSortingType.NOTIFICATIONS_BY_PRIORITY_DESCENDING]=this.getInitialSortingModelStructure();e[this.oSortingType.NOTIFICATIONS_BY_TYPE_DESCENDING]={};this.sCurrentSorting=this.oSortingType.NOTIFICATIONS_BY_DATE_DESCENDING;this.oPreviousTabKey="sapUshellNotificationIconTabByDate";this.sCurrentExpandedType=undefined;var o=new c(e);o.setSizeLimit(1500);this.getView().setModel(o);this.getView().setModel(i.i18nModel,"i18n");this.getNextBuffer();this._oTopNotificationData=undefined},onAfterRendering:function(){this.removeTabIndexFromList(this.sCurrentSorting);var t=this.getView().byId("notificationIconTabBar--header");if(t){t.getDomRef().classList.remove("sapContrastPlus")}if(this.sCurrentSorting!==this.oSortingType.NOTIFICATIONS_BY_TYPE_DESCENDING){if(this._oTopNotificationData){this.scrollToItem(this._oTopNotificationData)}}this.getView().$("-sapUshellNotificationIconTabByDate-text").attr("aria-label",i.i18n.getText("Notifications.ByDateDescending.AriaLabel"));this.getView().$("-sapUshellNotificationIconTabByType-text").attr("aria-label",i.i18n.getText("Notifications.ByType.AriaLabel"));this.getView().$("-sapUshellNotificationIconTabByPrio-text").attr("aria-label",i.i18n.getText("Notifications.ByPriority.AriaLabel"))},shouldFetchMoreNotifications:function(){var t=this.getView().getModel().getProperty("/"+this.sCurrentSorting+"/hasMoreItemsInBackend"),e=this.getView().getModel().getProperty("/"+this.sCurrentSorting+"/listMaxReached");return t&&!e},getNextBuffer:function(){var t=this.sCurrentSorting,e=this.getItemsFromModel(t),i,o,n;if(!this.shouldFetchMoreNotifications()){return}n=this.getNumberOfItemsToFetchOnScroll(t);if(n===0){this.getView().getModel().setProperty("/"+t+"/hasMoreItems",false);return}if(e!==undefined){i=e.length}if(i===0){this.addBusyIndicatorToTabFilter(t)}this.getView().getModel().setProperty("/"+t+"/inUpdate",true);o=this.oNotificationsService.getNotificationsBufferBySortingType(t,i,n);o.done(function(e){var i=this.oNotificationsService._getNotificationSettingsAvalability();if(i.state()==="pending"){this.oNotificationsService._userSettingInitialization()}this.addBufferToModel(t,e)}.bind(this));o.fail(function(){if(i===0){this.removeBusyIndicatorToTabFilter(t);this.handleError()}}.bind(this))},getNextBufferForType:function(){var t=this.sCurrentExpandedType,e=this.oSortingType.NOTIFICATIONS_BY_TYPE_DESCENDING,i=this.getGroupFromModel(t),o=i?i.aNotifications:undefined,n=0,s,r=i?i.hasMoreItems:true;if(!r){return}if(o!==undefined){n=o.length}this.getView().getModel().setProperty("/"+e+"/inUpdate",true);s=this.oNotificationsService.getNotificationsBufferInGroup(t,n,this.iMaxNotificationItemsForDevice);s.done(function(e){this.addTypeBufferToModel(t,e,false)}.bind(this));s.fail(function(){this.getNextBufferFailHandler(e)}.bind(this))},addBufferToModel:function(t,e){var i=this.getItemsFromModel(t),o=i.length,n,s=e.length>=this.getNumberOfItemsToFetchOnScroll(t);this._oTopNotificationData=undefined;if(!e){this.getView().getModel().setProperty("/"+t+"/hasMoreItemsInBackend",false);return}this.getView().getModel().setProperty("/"+t+"/hasMoreItemsInBackend",s);n=i.concat(e);this.getView().getModel().setProperty("/"+t+"/aNotifications",n);this.getView().getModel().setProperty("/"+t+"/inUpdate",false);if(n.length>=this.iMaxNotificationItemsForDevice){this.handleMaxReached(t)}if(o===0){this.removeBusyIndicatorToTabFilter(t)}},addTypeBufferToModel:function(t,e,i){var o=this.getGroupFromModel(t),n=this.getGroupIndexFromModel(t),s=this.getView().getModel().getProperty("/"+this.oSortingType.NOTIFICATIONS_BY_TYPE_DESCENDING),r;if(!e){return}if(e.length<this.getBasicBufferSize()){o.hasMoreItems=false}if(!o.aNotifications||i){o.aNotifications=[]}r=o.aNotifications.concat(e);s[n].aNotifications=r;s[n].Busy=false;this.getView().getModel().setProperty("/"+this.oSortingType.NOTIFICATIONS_BY_TYPE_DESCENDING,s);this.getView().getModel().setProperty("/"+this.oSortingType.NOTIFICATIONS_BY_TYPE_DESCENDING+"/inUpdate",false)},keydownHandler:function(t){var e,i,o;if(t.keyCode===r.DELETE){e=jQuery(document.activeElement);if(e.hasClass("sapUshellNotificationsListItem")){i=e.next();o=e.find(".sapMNLB-CloseButton")[0];sap.ui.getCore().byId(o.id).firePress();if(i){i.focus()}}}},notificationsUpdateCallback:function(t){var e=this,i=this.sCurrentSorting,o,n,s;if(i===this.oSortingType.NOTIFICATIONS_BY_TYPE_DESCENDING){this.notificationsUpdateCallbackForType();t.resolve();return}o=this.getItemsFromModel(i);if(o!==undefined){n=o.length}this.cleanModel();s=this.getNumberOfItemsToFetchOnUpdate(n);this.oNotificationsService.getNotificationsBufferBySortingType(i,0,s).done(function(o){if(!o){return}t.resolve();e.replaceItemsInModel(i,o,s)}).fail(function(t){a.error("Notifications control - call to notificationsService.getNotificationsBufferBySortingType failed: ",t,"sap.ushell.components.shell.Notifications.Notifications")})},isMoreCircleExist:function(t){var e=this.getNotificationList(t),i=e.getItems().length,o=e.getItems()[i-1];return!!i&&o.getMetadata().getName()==="sap.m.CustomListItem"},handleMaxReached:function(t){var e=this.getNotificationList(t),i=Math.floor(this.oNotificationsService.getNotificationsCount()),o=i-this.iMaxNotificationItemsForDevice,n=this.isMoreCircleExist(t);this.getView().getModel().setProperty("/"+this.sCurrentSorting+"/moreNotificationCount",o);this.getView().getModel().setProperty("/"+this.sCurrentSorting+"/listMaxReached",o>=0);if(o>0&&!n){e.addItem(this.getMoreCircle(this.sCurrentSorting))}else if(o<=0&&n){e.removeItem(this.oMoreListItem)}},reAddFailedGroup:function(t){var e=this.getView().getModel(),i=e.getProperty("/notificationsByTypeDescending");i.splice(t.removedGroupIndex,0,t.oGroup);e.setProperty("/notificationsByTypeDescending",i)},removeGroupFromModel:function(t){var e=this.getView().getModel(),i=e.getProperty("/notificationsByTypeDescending"),o={oGroup:t,removedGroupIndex:undefined};i.some(function(n,s){if(n.Id===t.Id){o.removedGroupIndex=s;i.splice(s,1);e.setProperty("/notificationsByTypeDescending",i);return true}return false});this.sCurrentExpandedType=undefined;return o},updateGroupHeaders:function(){var t=this.oNotificationsService.getNotificationsGroupHeaders(),e=this,i=e.getView().getModel().getProperty("/"+e.oSortingType.NOTIFICATIONS_BY_TYPE_DESCENDING);t.fail(function(t){a.error("Notifications control - call to notificationsService.updateGroupHeaders failed: ",t,"sap.ushell.components.shell.Notifications.Notifications")});t.done(function(t){var o=JSON.parse(t),n=o.value;n.forEach(function(t){var e=false;i.forEach(function(o,n){if(o.Id===t.Id){i[n].GroupHeaderText=t.GroupHeaderText;i[n].CreatedAt=t.CreatedAt;e=true}});if(!e){i.unshift(t)}});e.getView().getModel().setProperty("/"+e.oSortingType.NOTIFICATIONS_BY_TYPE_DESCENDING,i)})},updateNotificationsByDate:function(){var t=this.getNumberOfItemsToFetchOnScroll(this.sCurrentSorting);var e=this.getView().getModel().getProperty("/"+this.sCurrentSorting);this.oNotificationsService.getNotificationsBufferBySortingType(this.sCurrentSorting,0,t).done(function(t){t.forEach(function(t){for(var i=0;i<e.length;i++){if(e[i].Id===t.Id){e.unshift(t);break}}});this.getView().getModel().setProperty("/"+this.sCurrentSorting,e);this.removeBusyIndicatorToTabFilter(this.oSortingType.NOTIFICATIONS_BY_DATE_DESCENDING)}.bind(this)).fail(function(t){a.error("Notifications control - call to notificationsService.getNotificationsBufferBySortingType failed: ",t,"sap.ushell.components.shell.Notifications.Notifications");this.removeBusyIndicatorToTabFilter(this.oSortingType.NOTIFICATIONS_BY_DATE_DESCENDING)}.bind(this))},reloadGroupHeaders:function(){var t=this.oNotificationsService.getNotificationsGroupHeaders(),e=this;t.fail(function(t){a.error("Notifications control - call to notificationsService.getNotificationsGroupHeaders failed: ",t,"sap.ushell.components.shell.Notifications.Notifications");e.removeBusyIndicatorToTabFilter(e.oSortingType.NOTIFICATIONS_BY_TYPE_DESCENDING)});t.done(function(t){var i=JSON.parse(t),o=i.value,n=[];o.forEach(function(t){if(t.IsGroupHeader){t.Collapsed=true;n.push(t)}});e.getView().getModel().setProperty("/"+e.oSortingType.NOTIFICATIONS_BY_TYPE_DESCENDING,n);e.removeBusyIndicatorToTabFilter(e.oSortingType.NOTIFICATIONS_BY_TYPE_DESCENDING)})},markRead:function(t){var e=this.oNotificationsService.markRead(t),o=this;e.fail(function(){N(i.i18n.getText("notificationsFailedMarkRead"));o.setMarkReadOnModel(t,false)});this.setMarkReadOnModel(t,true)},onExit:function(){},onBeforeRendering:function(){if(!this._bDependencyCallbackRegistered){this._bDependencyCallbackRegistered=true;this.oNotificationsService.registerDependencyNotificationsUpdateCallback(this.notificationsUpdateCallback.bind(this),false)}},executeAction:function(t,e){return this.oNotificationsService.executeAction(t,e)},executeBulkAction:function(t,e,o,n){var s=o,r=this.oNotificationsService.executeBulkAction(o.Id,t),a,c=e,d=this.getView().getModel().getProperty(n+"/NotificationTypeDesc"),g=this;if(d===""){d=this.getView().getModel().getProperty(n+"/NotificationTypeKey")}r.fail(function(t){this.getView().getModel().setProperty(n+"/Busy",false);if(t&&t.succededNotifications&&t.succededNotifications.length){t.succededNotifications.forEach(function(t){this.removeNotificationFromModel(t)}.bind(this));g.cleanModel()}if(t.succededNotifications.length===1){a=i.i18n.getText("notificationsPartialSuccessExecuteBulkAction",[c,t.succededNotifications.length,t.failedNotifications.length+t.succededNotifications.length,d,t.failedNotifications.length]);f.show(a,{duration:4e3})}else if(t.succededNotifications.length>1){a=i.i18n.getText("notificationsSingleSuccessExecuteBulkAction",[c,t.succededNotifications.length,t.failedNotifications.length+t.succededNotifications.length,d,t.failedNotifications.length]);f.show(a,{duration:4e3})}else{a=i.i18n.getText("notificationsFailedExecuteBulkAction");N(a)}}.bind(this));r.done(function(){a=i.i18n.getText("notificationsSuccessExecuteBulkAction",[c,d]);f.show(a,{duration:4e3});this.removeGroupFromModel(s);this.cleanModel()}.bind(this))},dismissNotification:function(t){var e=this,o=this.removeNotificationFromModel(t),n=this.oNotificationsService.dismissNotification(t);this.cleanModel();n.fail(function(){N(i.i18n.getText("notificationsFailedDismiss"));e.addNotificationToModel(o.obj,o.index)})},dismissBulkNotifications:function(t){var e=this.removeGroupFromModel(t),o=this.oNotificationsService.dismissBulkNotifications(t.Id);this.cleanModel();o.fail(function(){N(i.i18n.getText("notificationsFailedExecuteBulkAction"));this.reAddFailedGroup(e)}.bind(this))},onListItemPress:function(t,i,o,n){var s=sap.ui.getCore().byId("viewPortContainer");if(s){s.switchState("Center")}e.toExternalWithParameters(i,o,n);this.markRead(t)},scrollToItem:function(t){var e=this._getJqNotificationObjects(),i=e[0],o=e[1],n=e[2],s=e[3],r,a,c,f,d;if(i.length>0&&o.length>0&&n.length>0&&s.length>0){r=s.outerHeight(true)-window.parseInt(s.css("margin-top").replace("px",""));a=this.getIndexInModelByItemId(t.topItemId);a=a||0;c=a*r+window.parseInt(s.css("margin-top").replace("px",""));f=window.parseInt(o.css("padding-top").replace("px",""))+window.parseInt(n.css("padding-top").replace("px",""));d=i.offset().top;i.scrollTop(c+f+d-t.offSetTop)}this._oTopNotificationData=undefined},_getJqNotificationObjects:function(){var t=jQuery("#notificationIconTabBar-containerContent"),e=t.children(),i=e.children(),o=t.find("li").eq(0);return[t,e,i,o]},getTopOffSet:function(){var t=0,e=this._getJqNotificationObjects()[0];if(e.children().length>0&&e.children().children().length>0){t+=e.children().outerHeight()-e.children().height();t+=e.children().children().outerHeight()-e.children().children().height()}return t},getTopItemOnTheScreen:function(){var t=this._getJqNotificationObjects()[0],e=0,i,o=0,n=this;e=this.getTopOffSet();t.find("li").each(function(){o=jQuery(this).offset().top;if(o>=e){i=n.getItemNotificationId(this);return false}});return{topItemId:i,offSetTop:o}},handleError:function(){N(i.i18n.getText("errorOccurredMsg"))},addBusyIndicatorToTabFilter:function(t){var e=this.getNotificationList(t);e.setBusy(true);e.setShowNoData(false)},removeBusyIndicatorToTabFilter:function(t){var e=this.getNotificationList(t);e.setBusy(false);e.setShowNoData(true)},addNotificationToModel:function(t,e){var i=this.getView().getModel(),o=i.getProperty("/"+this.sCurrentSorting+"/aNotifications");o.splice(e,0,t);i.setProperty("/"+this.sCurrentSorting+"/aNotifications",o)},removeNotificationFromModel:function(t){var e=this.getView().getModel(),i,o,n,s={};if(this.sCurrentSorting===this.oSortingType.NOTIFICATIONS_BY_DATE_DESCENDING||this.sCurrentSorting===this.oSortingType.NOTIFICATIONS_BY_DATE_ASCENDING||this.sCurrentSorting===this.oSortingType.NOTIFICATIONS_BY_PRIORITY_DESCENDING){n="/"+this.sCurrentSorting+"/aNotifications";o=e.getProperty(n);o.some(function(e,i,o){if(e.Id&&e.Id===t){s.obj=o.splice(i,1)[0];s.index=i;return true}return false});e.setProperty(n,o);return s}i=e.getProperty("/notificationsByTypeDescending");for(var r=0;r<i.length;r++){o=i[r].aNotifications;if(o){if(o.length===1&&o[0].Id===t){i.splice(r,1)}else{o.some(function(e,i,o){if(e.Id&&e.Id===t){s.obj=o.splice(i,1)[0];s.index=i;return true}return false});i[r].aNotifications=o}}}this.updateGroupHeaders();e.setProperty("/notificationsByTypeDescending",i);return s},getIndexInModelByItemId:function(t){var e,i;if(this.notificationsByTypeDescending===this.oSortingType.NOTIFICATIONS_BY_TYPE_DESCENDING){e=this.getView().getModel().getProperty("/"+this.sCurrentExpandedType+"/aNotifications")}else{e=this.getView().getModel().getProperty("/"+this.sCurrentSorting+"/aNotifications")}if(e===undefined||e.length===0){return 0}for(i=0;i<e.length;i++){if(e[i].Id===t){return i}}},cleanModel:function(){var t=this,e=this.getView().getModel().getProperty("/");Object.keys(e).forEach(function(i){if(i!==t.sCurrentSorting&&i!==t.oSortingType.NOTIFICATIONS_BY_TYPE_DESCENDING){e[i]=t.getInitialSortingModelStructure()}});this.getView().getModel().setProperty("/",e)},replaceItemsInModel:function(t,e,i){var o=this.getItemsFromModel(t),n=o.length,s=e.length>=i;if(n){this._oTopNotificationData=this.getTopItemOnTheScreen()}this.getView().getModel().setProperty("/"+t+"/hasMoreItemsInBackend",s);this.getView().getModel().setProperty("/"+t+"/aNotifications",e);this.getView().getModel().setProperty("/"+t+"/inUpdate",false);this.handleMaxReached(t)},setMarkReadOnModel:function(t,e){var i=this.getView().getModel(),o="/"+this.sCurrentSorting,n,s,r,a;s=i.getProperty(o);if(this.sCurrentSorting==="notificationsByTypeDescending"){for(a=0;a<s.length;a++){if(s[a].Id===this.sCurrentExpandedType){o=o+"/"+a;r=true;break}}if(!r){return}}o=o+"/aNotifications";n=i.getProperty(o);n.some(function(i){if(i.Id===t){i.IsRead=e;return true}return false});i.setProperty(o,n)},onTabSelected:function(t){var e=t.getParameter("key");if(e==="sapUshellNotificationIconTabByDate"){this.sCurrentSorting=this.oSortingType.NOTIFICATIONS_BY_DATE_DESCENDING;this.updateNotificationsByDate()}else if(e==="sapUshellNotificationIconTabByType"&&this.oPreviousTabKey!=="sapUshellNotificationIconTabByType"){this.sCurrentSorting=this.oSortingType.NOTIFICATIONS_BY_TYPE_DESCENDING;this.addBusyIndicatorToTabFilter(this.oSortingType.NOTIFICATIONS_BY_TYPE_DESCENDING);this.reloadGroupHeaders();this.getView().byId("notificationIconTabBar").addStyleClass("sapUshellNotificationIconTabByTypeWithBusyIndicator")}else{this.sCurrentSorting=this.oSortingType.NOTIFICATIONS_BY_PRIORITY_DESCENDING;if(this.getItemsFromModel(this.oSortingType.NOTIFICATIONS_BY_PRIORITY_DESCENDING).length===0){this.getNextBuffer(this.oSortingType.NOTIFICATIONS_BY_PRIORITY_DESCENDING)}}this.oPreviousTabKey=e},_changeDateListBinding:function(t,e){var o=new Promise(function(t,e){sap.ui.require(["sap/ui/core/Fragment"],function(i){i.load({name:"sap.ushell.components.shell.Notifications.NotificationsListItem",type:"XML",controller:this}).then(t).catch(e)}.bind(this),e)}.bind(this));if(t===this.oSortingType.NOTIFICATIONS_BY_DATE_DESCENDING){e.$("text").attr("aria-label",i.i18n.getText("Notifications.ByDateDescending.AriaLabel"));o.then(function(t){this.getView().byId("sapUshellNotificationsListDate").bindItems("/notificationsByDateDescending/aNotifications",t)}.bind(this))}else{e.$("text").attr("aria-label",i.i18n.getText("Notifications.ByDateAscending.AriaLabel"));o.then(function(t){this.getView().byId("sapUshellNotificationsListDate").bindItems("/notificationsByDateAscending/aNotifications",t)}.bind(this))}},onNotificationItemPress:function(t){var e=t.getSource().getBindingContextPath(),i=this.getView().getModel().getProperty(e),o=i.NavigationTargetObject,n=i.NavigationTargetAction,s=i.NavigationTargetParams,r=i.Id;this.onListItemPress(r,o,n,s)},onNotificationItemClose:function(t){this._retainFocus();var e=t.getSource().getBindingContextPath(),i=this.getView().getModel().getProperty(e),o=i.Id;this.dismissNotification(o)},onNotificationItemButtonPress:function(t){this._retainFocus();var e=t.getSource().getBindingContext().getPath(),o=this.getView().getModel(),n=o.getProperty(e),s=e.split("/"),r=this.sCurrentSorting===this.oSortingType.NOTIFICATIONS_BY_TYPE_DESCENDING,a=r?"/"+s[1]+"/"+s[2]+"/"+s[3]+"/"+s[4]:"/"+s[1]+"/"+s[2]+"/"+s[3],c=o.getProperty(a),f=c.Id;o.setProperty(a+"/Busy",true);this.executeAction(f,n.ActionId).done(function(t){if(t&&t.isSucessfull){sap.ui.require(["sap/m/MessageToast"],function(e){if(t.message&&t.message.length){e.show(t.message,{duration:4e3})}else{var o=n.ActionText;e.show(i.i18n.getText("ActionAppliedToNotification",o),{duration:4e3})}});if(t.DeleteOnReturn!==false){this.removeNotificationFromModel(f);this.oNotificationsService._addDismissNotifications(f);this.cleanModel()}}else if(t){N(t.message)}else{N(i.i18n.getText("notificationsFailedExecuteAction"))}o.setProperty(a+"/Busy",false)}.bind(this)).fail(function(){o.setProperty(a+"/Busy",false);N(i.i18n.getText("notificationsFailedExecuteAction"))})},onNotificationGroupItemClose:function(t){var e=t.getSource().getBindingContext().getPath(),i=e.split("/"),o="/"+i[1]+"/"+i[2],n=this.getView().getModel().getProperty(o);this.dismissBulkNotifications(n)},onNotificationGroupItemCollapse:function(t){var e=t.getSource(),i=e.getBindingContext().getPath();if(!e.getCollapsed()){this.getView().getModel().setProperty(i+"/Busy",true);this.expandedGroupIndex=i.substring(i.lastIndexOf("/")+1);this.onExpandGroup(e)}},onNotificationGroupItemButtonPress:function(t){var e=this.getView().getModel(),i=t.getSource().getBindingContext().getPath(),o=e.getProperty(i),n=i.split("/"),s="/"+n[1]+"/"+n[2],r=e.getProperty(s);this._retainFocus();e.setProperty(s+"/Busy",true);this.executeBulkAction(o.ActionId,t.getSource().getProperty("text"),r,s)},onListUpdateStarted:function(t){if(t.getParameter("reason")==="Growing"){if(!this.getView().getModel().getProperty("/"+this.sCurrentSorting+"/inUpdate")){this.getNextBuffer()}}},getNumberOfItemsInScreen:function(){var t,e=this.getWindowSize();t=(e-this.oPagingConfiguration.TAB_BAR_HEIGHT)/this.oPagingConfiguration.NOTIFICATION_ITEM_HEIGHT;return Math.ceil(t)},getBasicBufferSize:function(){return Math.max(this.getNumberOfItemsInScreen()*3,this.oPagingConfiguration.MIN_NOTIFICATION_ITEMS_PER_BUFFER)},getWindowSize:function(){return jQuery(window).height()},getNumberOfItemsToFetchOnScroll:function(t){var e=this.getItemsFromModel(t).length,i=this.getBasicBufferSize();if(e>=this.iMaxNotificationItemsForDevice){return 0}if(e+i>this.iMaxNotificationItemsForDevice){return this.iMaxNotificationItemsForDevice-e}return i},getNumberOfItemsToFetchOnUpdate:function(t){var e=this.getBasicBufferSize(),i=Math.ceil(t/e),o;o=i>0?i*e:e;return o>this.iMaxNotificationItemsForDevice?this.iMaxNotificationItemsForDevice:o},getItemsFromModel:function(t){if(t===undefined){t=this.sCurrentSorting}return this.getView().getModel().getProperty("/"+t+"/aNotifications")},getItemsOfTypeFromModel:function(t){var e=this.getGroupFromModel(t);if(e){return e.aNotifications?e.aNotifications:[]}return[]},getGroupFromModel:function(t){var e=this.getView().getModel().getProperty("/"+this.oSortingType.NOTIFICATIONS_BY_TYPE_DESCENDING);return e.find(function(e){return e.Id===t})},getGroupIndexFromModel:function(t){var e=this.getView().getModel().getProperty("/"+this.oSortingType.NOTIFICATIONS_BY_TYPE_DESCENDING),i;e.forEach(function(e,o){if(e.Id===t){i=o;return true}});return i},getItemNotificationId:function(t){var e,i;e=sap.ui.getCore().byId(t.getAttribute("Id")).getBindingContext().sPath;i=this.getView().getModel().getProperty(e+"/Id");return i},getInitialSortingModelStructure:function(){return{hasMoreItemsInBackend:true,listMaxReached:false,aNotifications:[],inUpdate:false,moreNotificationCount:""}},onExpandGroup:function(t){var e=this.getView().byId("sapUshellNotificationsListType").getItems(),i=t.getId(),o=this.getView().getModel().getProperty(t.getBindingContextPath()),n=this;n.sCurrentExpandedType=o.Id;n.getView().getModel().setProperty(t.getBindingContextPath()+"/aNotifications",[]);n.getView().getModel().setProperty(t.getBindingContextPath()+"/hasMoreItems",true);e.forEach(function(t,e){if(t.getId()===i){n.getNextBufferForType()}else if(t.getId()!==i&&!t.getCollapsed()){t.setCollapsed(true);n.getView().getModel().setProperty(t.getBindingContextPath()+"/hasMoreItems",true)}})},notificationsUpdateCallbackForType:function(){var t=this.sCurrentExpandedType,e=this.oSortingType.NOTIFICATIONS_BY_TYPE_DESCENDING,i=this.getGroupFromModel(t),o=i?i.aNotifications:undefined,n=0,s;if(o!==undefined){n=o.length}this.getView().getModel().setProperty("/"+e+"/inUpdate",true);this.updateGroupHeaders();if(t){s=this.oNotificationsService.getNotificationsBufferInGroup(t,0,this.getNumberOfItemsToFetchOnUpdate(n));s.done(function(e){this.addTypeBufferToModel(t,e,true)}.bind(this));s.fail(function(t){this.getNextBufferFailHandler(t)}.bind(this))}},getNotificationList:function(t){var e;if(t===this.oSortingType.NOTIFICATIONS_BY_DATE_DESCENDING||t===this.oSortingType.NOTIFICATIONS_BY_DATE_ASCENDING){e=this.getView().byId("sapUshellNotificationsListDate")}else if(t===this.oSortingType.NOTIFICATIONS_BY_PRIORITY_DESCENDING){e=this.getView().byId("sapUshellNotificationsListPriority")}else{e=this.getView().byId("sapUshellNotificationsListType")}return e},removeTabIndexFromList:function(t){var e=this.getNotificationList(t);var i=e.$().children().get(1);if(i){i.removeAttribute("tabindex")}},getMoreCircle:function(t){var e=new o({text:i.i18n.getText("moreNotifications")}),r=new o({text:""}).addStyleClass("sapUshellNotificationsMoreCircleCount"),a=new n({items:[r,e],alignItems:I.Center}).addStyleClass("sapUshellNotificationsMoreCircle"),c=new o({text:i.i18n.getText("moreNotificationsAvailable_message"),textAlign:"Center"}).addStyleClass("sapUshellNotificationsMoreHelpingText"),f=new o({text:i.i18n.getText("processNotifications_message"),textAlign:"Center"}).addStyleClass("sapUshellNotificationsMoreHelpingText"),d=new n({items:[a,c,f]}).addStyleClass("sapUshellNotificationsMoreVBox"),g=new s({type:u.Inactive,content:d}).addStyleClass("sapUshellNotificationsMoreListItem");r.setModel(this.getView().getModel());r.bindText("/"+t+"/moreNotificationCount");this.oMoreListItem=g;return g},_retainFocus:function(){var t=this.getView().byId("notificationIconTabBar"),e=t.getSelectedKey(),i=t.getItems(),o=0;i.forEach(function(t,i){if(t.getKey()===e){o=i}});i[o].focus()},priorityFormatter:function(t){if(t){t=t.charAt(0)+t.substr(1).toLowerCase();return h[t]}}})});
//# sourceMappingURL=Notifications.controller.js.map