// Copyright (c) 2009-2022 SAP SE, All Rights Reserved
sap.ui.define(["sap/ui/core/mvc/Controller","sap/ui/performance/Measurement","sap/base/util/UriParameters","sap/base/util/ObjectPath","sap/base/Log","sap/ui/core/Locale","sap/ui/core/LocaleData","sap/ui/model/json/JSONModel","sap/ui/core/message/Message","sap/ui/core/MessageType"],function(e,t,a,r,i,n,s,o,g,u){"use strict";return e.extend("sap.ushell.components.shell.Settings.userLanguageRegion.LanguageRegionSelector",{onInit:function(){this.oUserInfoServicePromise=sap.ushell.Container.getServiceAsync("UserInfo");return this.oUserInfoServicePromise.then(function(e){this.oUser=sap.ushell.Container.getUser();var t=sap.ui.getCore().getConfiguration().getFormatSettings().getFormatLocale();var a=s.getInstance(t);var r,i,n,g;var u=sap.ushell.Container.getRenderer("fiori2").getShellConfig().enableSetLanguage||false;var l=this.oUser.isLanguagePersonalized();var m=e.getUserSettingListEditSupported();var c=[];if(m){var L=sap.ui.getCore().getConfiguration().getFormatSettings();r=L.getLegacyDateFormat();n=L.getLegacyTimeFormat();g=this._getLegacyNumberFormat(L);c.push(this._loadUserSettingList())}else{r=a.getDatePattern("medium");i=a.getTimePattern("medium");n=i.indexOf("H")===-1?"12h":"24h"}var d=new o({languageList:null,DateFormatList:null,TimeFormatList:null,NumberFormatList:null,TimeZoneList:null,selectedLanguage:this.oUser.getLanguage(),selectedLanguageText:this.oUser.getLanguageText(),selectedDatePattern:r,selectedTimeFormat:n,selectedNumberFormat:g,selectedTimeZone:this.oUser.getTimeZone(),isSettingsLoaded:true,isLanguagePersonalized:l,isEnableSetLanguage:u,isEnableUserProfileSetting:m,isTimeZoneIanaAvailable:true});d.setSizeLimit(1e3);var f=sap.ushell.Container.getUser().getTimeZoneIana();if(f===undefined||f!==""&&typeof f==="string"){d.setProperty("/isTimeZoneIanaAvailable",false)}if(u){c.push(this._loadLanguagesList())}if(c.length>0){this.getView().setBusy(true);return Promise.all(c).then(function(e){var t=m?e[0]:null;var a=null;if(u){a=e.length===1?e[0]:e[1]}if(a&&a.length>1){d.setProperty("/languageList",a);var r=a.some(function(e){return e.key==="default"});if(!l&&r){d.setProperty("/selectedLanguage","default")}}if(t&&t.TIME_FORMAT&&t.TIME_FORMAT.length>0){d.setProperty("/TimeFormatList",t.TIME_FORMAT)}if(t&&t.DATE_FORMAT&&t.DATE_FORMAT.length>0){d.setProperty("/DateFormatList",t.DATE_FORMAT)}if(t&&t.TIME_ZONE&&t.TIME_ZONE.length>0){d.setProperty("/TimeZoneList",t.TIME_ZONE)}if(t&&t.NUMBER_FORMAT&&t.NUMBER_FORMAT.length>0){d.setProperty("/NumberFormatList",t.NUMBER_FORMAT)}this.oView.setModel(d);this.getView().setBusy(false)}.bind(this))}this.oView.setModel(d)}.bind(this))},_loadLanguagesList:function(){t.start("FLP:LanguageRegionSelector._getLanguagesList","_getLanguagesList","FLP");return this.oUserInfoServicePromise.then(function(e){return new Promise(function(a){t.start("FLP:LanguageRegionSelector._getLanguagesList","_getLanguagesList","FLP");e.getLanguageList().done(function(e){t.end("FLP:LanguageRegionSelector._getLanguagesList");a(e)}).fail(function(e){t.end("FLP:LanguageRegionSelector._getLanguagesList");i.error("Failed to load language list.",e,"sap.ushell.components.ushell.settings.userLanguageRegion.LanguageRegionSelector.controller");a(null)})})})},_loadUserSettingList:function(){t.start("FLP:LanguageRegionSelector._loadUserSettingList","_loadUserSettingList","FLP");return this.oUserInfoServicePromise.then(function(e){return new Promise(function(a){t.start("FLP:LanguageRegionSelector._loadUserSettingList","_loadUserSettingList","FLP");e.getUserSettingList().then(function(e){t.end("FLP:LanguageRegionSelector._loadUserSettingList");a(e)})})})},onCancel:function(){var e=this.getView().getModel(),t=e.getData(),a=t.languageList,r=t.isEnableSetLanguage;if(r&&a){var i=this.oUser.getLanguage();var n=t.isLanguagePersonalized?i:"default";e.setProperty("/selectedLanguage",n);this._updateTextFields(i)}if(t.isEnableUserProfileSetting){this._restoreUserSettingPreferenceValues()}},onSave:function(){var e=this.oUser,t=this.getView().getModel().getData(),r=t.selectedLanguage,n=e.getLanguage(),s=r!==(t.isLanguagePersonalized?n:"default"),o=t.isEnableUserProfileSetting,l=t.isEnableSetLanguage&&t.languageList&&s;if(l||o){return this.oUserInfoServicePromise.then(function(s){return new Promise(function(m,c){if(l){e.setLanguage(r)}if(o){var L=sap.ui.getCore().getConfiguration().getFormatSettings();if(L.getLegacyDateFormat()!==t.selectedDatePattern){e.setChangedProperties({propertyName:"dateFormat",name:"DATE_FORMAT"},L.getLegacyDateFormat(),t.selectedDatePattern)}if(L.getLegacyTimeFormat()!==t.selectedTimeFormat){e.setChangedProperties({propertyName:"timeFormat",name:"TIME_FORMAT"},L.getLegacyTimeFormat(),t.selectedTimeFormat)}if(this._getLegacyNumberFormat(L)!==t.selectedNumberFormat){e.setChangedProperties({propertyName:"numberFormat",name:"NUMBER_FORMAT"},this._getLegacyNumberFormat(L),t.selectedNumberFormat)}if(this.oUser.getTimeZone()!==t.selectedTimeZone){e.setChangedProperties({propertyName:"timeZone",name:"TIME_ZONE"},this.oUser.getTimeZone(),t.selectedTimeZone)}}s.updateUserPreferences(e).done(function(){var t={refresh:true};if(l){e.resetChangedProperty("language");var i=a.fromQuery(window.location.search).get("sap-language");if(i&&r!=="default"){t.urlParams=[{"sap-language":r}]}this._removeLanguageFromUserContextCookie()}m(t)}.bind(this)).fail(function(a,r){if(l){e.setLanguage(n);e.resetChangedProperty("language");this._updateTextFields(n)}if(t.isEnableUserProfileSetting){this._restoreUserSettingPreferenceValues()}i.error("Failed to save Language and Region Settings",a,"sap.ushell.components.ushell.settings.userLanguageRegion.LanguageRegionSelector.controller");c(new g({type:u.Error,description:a,message:r.message.value,date:r.innererror.timestamp,httpStatus:r.httpStatus}))}.bind(this))}.bind(this))}.bind(this))}return Promise.resolve()},_restoreUserSettingPreferenceValues:function(){var e=this.getView().getModel();var t=sap.ui.getCore().getConfiguration().getFormatSettings();e.setProperty("/selectedDatePattern",t.getLegacyDateFormat());e.setProperty("/selectedTimeFormat",t.getLegacyTimeFormat());e.setProperty("/selectedNumberFormat",this._getLegacyNumberFormat(t));e.setProperty("/selectedTimeZone",this.oUser.getTimeZone())},_removeLanguageFromUserContextCookie:function(){var e=document.cookie.split(";").find(function(e){return e.indexOf("sap-usercontext")!==-1});if(!e){return}var t=e.replace("sap-usercontext=","").split("&");t=t.filter(function(e){return e.indexOf("sap-language")===-1});document.cookie="sap-usercontext="+t.join("&")+";path=/"},_handleSelectChange:function(e){var t=e.getParameters().selectedItem.getKey();this._updateTextFields(t)},_updateTextFields:function(e){var t;if(e===this.oUser.getLanguage()){t=sap.ui.getCore().getConfiguration().getFormatSettings().getFormatLocale()}else{t=new n(e)}var a=this.getView().getModel(),r=s.getInstance(t),i=r.getDatePattern("medium"),o=r.getTimePattern("medium"),g=o.indexOf("H")===-1?"12h":"24h";if(!a.getData().isEnableUserProfileSetting){a.setProperty("/selectedDatePattern",i);a.setProperty("/selectedTimeFormat",g)}},_getLegacyNumberFormat:function(e){var t=e.getLegacyNumberFormat();if(t){return t.trim()}}})});
//# sourceMappingURL=LanguageRegionSelector.controller.js.map