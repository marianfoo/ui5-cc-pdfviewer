// Copyright (c) 2009-2022 SAP SE, All Rights Reserved
sap.ui.define(["sap/base/Log","sap/ui/core/mvc/Controller","sap/ushell/EventHub","sap/ushell/Config","sap/ui/core/Component","sap/ui/thirdparty/jquery","sap/ui/model/json/JSONModel","sap/ui/core/theming/Parameters","sap/ui/Device","sap/ushell/resources","sap/ui/core/message/Message","sap/ui/core/MessageType","sap/ushell/User","sap/ushell/services/DarkModeSupport"],function(e,t,r,o,s,jQuery,n,i,a,l,h,c,d){"use strict";function p(t){switch(t){case"sap_fiori_3":case"sap_fiori_3_dark":return"SAP Quartz";case"sap_horizon":case"sap_horizon_dark":return"SAP Horizon";case"sap_fiori_3_hcb":case"sap_fiori_3_hcw":return l.i18n.getText("AppearanceHighContrastTheme","SAP Quartz");case"sap_horizon_hcb":case"sap_horizon_hcw":return l.i18n.getText("AppearanceHighContrastTheme","SAP Horizon");default:e.error("Can not find common name for the theme",t);return t||""}}var u={base:"sapUshellBaseIconStyle",sap_bluecrystal:"sapUshellBlueCrystalIconStyle",sap_belize_hcb:"sapUshellHCBIconStyle sapUshellHCBIconStyleOnHCB",sap_belize_hcw:"sapUshellHCWIconStyle sapUshellHCWIconStyleOnHCW",sap_belize:"sapUshellBelizeIconStyle",sap_belize_plus:"sapUshellPlusIconStyle",sap_fiori_3_hcb:"sapUshellQuartzHCBIconStyle sapUshellHCBIconStyleOnHCB",sap_fiori_3_hcw:"sapUshellQuartzHCWIconStyle sapUshellHCWIconStyleOnHCW",sap_fiori_3:"sapUshellQuartzLightIconStyle",sap_fiori_3_dark:"sapUshellQuartzDarkIconStyle",sap_horizon_hcb:"sapUshellHorizonHCBIconStyle sapUshellHCBIconStyleOnHCB",sap_horizon_hcw:"sapUshellHorizonHCWIconStyle sapUshellHCWIconStyleOnHCW",sap_horizon:"sapUshellHorizonLightIconStyle",sap_horizon_dark:"sapUshellHorizonDarkIconStyle"};return t.extend("sap.ushell.components.shell.Settings.appearance.Appearance",{TILE_SIZE:{Small:0,Responsive:1,getName:function(e){return Object.keys(this)[e]}},onInit:function(){var e=this.getView();this.oUser=sap.ushell.Container.getUser();this.aThemeListFromServer=e.getViewData().themeList||[];this.oPersonalizers={};var t=l.getTranslationModel();e.setModel(t,"i18n");e.setModel(this.getConfigurationModel(),"config");sap.ui.getCore().attachThemeChanged(this._handleThemeApplied,this);return this.getDarkModeModel(this.aThemeListFromServer).then(function(t){this._oDarkModeModel=t;e.setModel(this._oDarkModeModel,"darkMode");var r=this.oUser.getTheme();e.setModel(new n({options:this._getThemeListData(this.aThemeListFromServer,r),ariaTexts:{headerLabel:l.i18n.getText("Appearance")}}))}.bind(this))},onExit:function(){sap.ui.getCore().detachThemeChanged(this._handleThemeApplied,this)},_getSelectedTheme:function(){var e=this.getView().byId("themeList").getSelectedItem(),t=e?e.getBindingContext():null,r=t?t.getProperty("id"):this.oUser.getTheme();return r},_getThemeListData:function(e,t){if(this.oUser.isSetThemePermitted()===false){var r=t;for(var o=0;o<e.length;o++){if(e[o].id===t){r=e[o].name||t;break}}return[{id:t,name:r}]}var s=this.getView().getModel("darkMode").getData(),n=this._isDarkModeActive();return e.reduce(function(e,r){var o={id:r.id,name:r.name||r.id||"",isVisible:true,isSelected:r.id===t,isSapTheme:!!u[r.id]};if(n&&s.supportedThemes[r.id]){var i=s.supportedThemes[r.id];if(i.complementaryTheme===t||r.id===t){o.isVisible=r.id===t}else{o.isVisible=i.mode===sap.ushell.services.DarkModeSupport.Mode.LIGHT}o.combineName=i.combineName}e.push(o);return e},[]).sort(function(e,t){var r=e.name.localeCompare(t.name);if(r===0){r=e.id.localeCompare(t.id)}return r})},getConfigurationModel:function(){return new n({themeConfigurable:o.last("/core/shell/model/setTheme"),sizeBehaviorConfigurable:o.last("/core/home/sizeBehaviorConfigurable"),tileSize:this.TILE_SIZE[o.last("/core/home/sizeBehavior")],contentDensityConfigurable:o.last("/core/shell/model/contentDensity")&&!a.system.phone,isCozyContentMode:document.body.classList.contains("sapUiSizeCozy"),sapUiContentIconColor:i.get("sapUiContentIconColor"),textAlign:a.system.phone?"Left":"Right"})},getDarkModeModel:function(e){var t=new n({});var r={enabled:false,detectionSupported:false,detectionEnabled:false,supportedThemes:{}};var s;if(o.last("/core/darkMode/enabled")){s=sap.ushell.Container.getServiceAsync("DarkModeSupport").then(function(s){r.enabled=true;r.detectionSupported=s.canAutomaticallyToggleDarkMode();r.detectionEnabled=r.detectionSupported&&this.oUser.getDetectDarkMode();r.supportedThemes=this._getSupportedDarkModeThemes(e,o.last("/core/darkMode/supportedThemes")||[]);t.setData(r);return t}.bind(this))}else{t.setData(r);s=Promise.resolve(t)}return s},_getSupportedDarkModeThemes:function(e,t){var r=e.reduce(function(e,t){e[t.id]=t.name;return e},{});return t.reduce(function(e,t){var o=t.light,s=t.dark,n=r[o],i=r[s];if(n&&i&&!e[o]&&!e[s]){var a=p(o);e[o]={mode:sap.ushell.services.DarkModeSupport.Mode.LIGHT,complementaryTheme:s,combineName:a};e[s]={mode:sap.ushell.services.DarkModeSupport.Mode.DARK,complementaryTheme:o,combineName:a}}return e},{})},onAfterRendering:function(){var e=this._isDarkModeActive(),t=this.getView().getModel("config").getProperty("/themeConfigurable");var r=this.getView().byId("themeList"),o=r.getItems(),s,n;r.toggleStyleClass("sapUshellThemeListDisabled",!t);o.forEach(function(t,r){n=t.getCustomData()[0].getValue();s=t.getContent()[0].getItems()[0].getItems()[0];if(u[n]){s.addStyleClass(u[n])}s.toggleStyleClass("sapUshellDarkMode",e)})},_handleThemeApplied:function(){var e=this.getView().getModel("config");if(e){e.setProperty("/sapUiContentIconColor",i.get("sapUiContentIconColor"));var t=this.oUser.getTheme();var r=this._getThemeListData(this.aThemeListFromServer,t);this.getView().getModel().setProperty("/options",r)}},onCancel:function(){var e=this.getView().getModel("config");if(e.getProperty("/themeConfigurable")){var t=this.oUser.getTheme(),r=this.getView().getModel().getProperty("/options");r.forEach(function(e){e.isSelected=t===e.id});this.getView().getModel().setProperty("/options",r)}if(e.getProperty("/contentDensityConfigurable")){e.setProperty("/isCozyContentMode",this.oUser.getContentDensity()==="cozy")}if(e.getProperty("/sizeBehaviorConfigurable")){e.setProperty("/tileSize",this.TILE_SIZE[o.last("/core/home/sizeBehavior")])}if(this._oDarkModeModel&&this._oDarkModeModel.getProperty("/enabled")){this._oDarkModeModel.setProperty("/detectionEnabled",this.oUser.getDetectDarkMode());this.oUser.resetChangedProperty("detectDarkMode")}},onSave:function(){var e=this.getView().getModel("config"),t=[];if(e.getProperty("/themeConfigurable")){t.push(this.onSaveThemes().then(function(){r.emit("themeChanged",Date.now())}))}if(e.getProperty("/contentDensityConfigurable")){t.push(this.onSaveContentDensity())}if(e.getProperty("/sizeBehaviorConfigurable")){t.push(this.onSaveTileSize())}if(this._oDarkModeModel&&this._oDarkModeModel.getProperty("/enabled")){t.push(this.onSaveDarkModeEnabled())}if(this._updateUserPreferencesPromise){this._updateUserPreferencesPromise.sendRequest()}return Promise.all(t).then(function(e){var t=[];e.forEach(function(e){if(e&&e instanceof sap.ui.core.message.Message){t.push(e)}});return t.length>0?Promise.reject(t):Promise.resolve()})},onSaveThemes:function(){var t=this.getView().getModel("config"),r=this._getSelectedTheme(),o=this.oUser,s=o.getTheme(d.prototype.constants.themeFormat.ORIGINAL_THEME);if(r&&r!==s&&t.getProperty("/themeConfigurable")){o.setTheme(r);return this._updateUserPreferences(o).then(function(){o.resetChangedProperty("theme");return this._applyDarkMode()}.bind(this)).catch(function(t,r){o.setTheme(s);o.resetChangedProperty("theme");e.error("Can not save selected theme",t);return new h({type:c.Error,description:t,message:r.message.value,date:r.innererror.timestamp,httpStatus:r.httpStatus})})}return Promise.resolve()},onSaveContentDensity:function(){var t=this.getView().getModel("config"),o=this.oUser,s=t.getProperty("/isCozyContentMode")?"cozy":"compact",n=o.getContentDensity();if(s!==n&&t.getProperty("/contentDensityConfigurable")){o.setContentDensity(s);return this._updateUserPreferences(this.oUser).then(function(){o.resetChangedProperty("contentDensity");sap.ui.getCore().getEventBus().publish("launchpad","toggleContentDensity",{contentDensity:s});r.emit("toggleContentDensity",{contentDensity:s});return new Promise(function(e){r.once("toggleContentDensity").do(function(){e()})})}).catch(function(t,r){o.setContentDensity(n);o.resetChangedProperty("contentDensity");e.error("Can not save content density configuration",t);return new h({type:c.Error,description:t,message:r.message.value,date:r.innererror.timestamp,httpStatus:r.httpStatus})})}return Promise.resolve()},onSaveTileSize:function(){var t=this.getView().getModel("config"),r=this.TILE_SIZE.getName(t.getProperty("/tileSize")),s=o.last("/core/home/sizeBehavior");if(r&&r!==s&&t.getProperty("/sizeBehaviorConfigurable")){return new Promise(function(t){this.writeToPersonalization("flp.settings.FlpSettings","sizeBehavior",r).done(function(){o.emit("/core/home/sizeBehavior",r);if(r==="Responsive"){jQuery(".sapUshellTile").removeClass("sapUshellSmall")}else{jQuery(".sapUshellTile").addClass("sapUshellSmall")}t()}).fail(function(r,o){e.error("Can not save tile size configuration",r);t(new h({type:c.Error,description:r,message:o.message.value,date:o.innererror.timestamp,httpStatus:o.httpStatus}))})}.bind(this))}return Promise.resolve()},onSaveDarkModeEnabled:function(){var t=this._oDarkModeModel.getProperty("/detectionEnabled");var r=this.oUser.getDetectDarkMode();var o=this.oUser;if(t!==r){o.setDetectDarkMode(t);return Promise.all([sap.ushell.Container.getServiceAsync("DarkModeSupport"),this._updateUserPreferences(this.oUser)]).then(function(e){var r=e[0];o.resetChangedProperty("detectDarkMode");if(t){r.enableDarkModeBasedOnSystem()}else{r.disableDarkModeBasedOnSystem()}}).catch(function(t,s){o.setDetectDarkMode(r);o.resetChangedProperty("detectDarkMode");e.error("Can not save dark mode configuration",t);return new h({type:c.Error,description:t,message:s.message.value,date:s.innererror.timestamp,httpStatus:s.httpStatus})})}return Promise.resolve()},writeToPersonalization:function(t,r,o){return jQuery.when(this.getPersonalizer(t,r).then(function(e){return e.setPersData(o)})).catch(function(t){e.error("Personalization service does not work:");e.error(t.name+": "+t.message)})},getPersonalizer:function(e,t){var r=e+"-"+t;if(this.oPersonalizers[r]){return Promise.resolve(this.oPersonalizers[r])}return sap.ushell.Container.getServiceAsync("Personalization").then(function(o){var n=s.getOwnerComponentFor(this);var i={keyCategory:o.constants.keyCategory.FIXED_KEY,writeFrequency:o.constants.writeFrequency.LOW,clientStorageAllowed:true};if(!this.oPersonalizers[r]){this.oPersonalizers[r]=o.getPersonalizer({container:e,item:t},i,n)}return this.oPersonalizers[r]}.bind(this))},_updateUserPreferences:function(e){if(this._updateUserPreferencesPromise){return this._updateUserPreferencesPromise}var t,r;this._updateUserPreferencesPromise=new Promise(function(e,o){t=e;r=o});this._updateUserPreferencesPromise.sendRequest=function(){sap.ushell.Container.getServiceAsync("UserInfo").then(function(o){o.updateUserPreferences(e).done(t).fail(r).always(function(){this._updateUserPreferencesPromise=null}.bind(this))}.bind(this))}.bind(this);return this._updateUserPreferencesPromise},_applyDarkMode:function(){var e=this._oDarkModeModel;var t;if(e.getProperty("/enabled")&&e.getProperty("/detectionSupported")&&e.getProperty("/detectionEnabled")){t=sap.ushell.Container.getServiceAsync("DarkModeSupport").then(function(e){e._toggleDarkModeBasedOnSystemColorScheme()})}else{t=Promise.resolve()}return t},_isDarkModeActive:function(){var e=this._oDarkModeModel.getProperty("/");return e.enabled&&e.detectionSupported&&e.detectionEnabled},changeSystemModeDetection:function(e){var t=this._getSelectedTheme();this.getView().getModel().setProperty("/options",this._getThemeListData(this.aThemeListFromServer,t));this.getView().invalidate()}})});
//# sourceMappingURL=Appearance.controller.js.map