// Copyright (c) 2009-2022 SAP SE, All Rights Reserved
sap.ui.define(["sap/ushell/adapters/cdm/v3/_LaunchPage/readHome","sap/ushell/adapters/cdm/v3/_LaunchPage/readVisualizations","sap/ushell/adapters/cdm/v3/_LaunchPage/readUtils","sap/m/GenericTile","sap/ui/core/ComponentContainer","sap/ushell/adapters/cdm/_LaunchPage/uri.transform","sap/ushell/Config","sap/ushell/EventHub","sap/ushell/navigationMode","sap/ushell/resources","sap/ushell/utils","sap/ushell/adapters/cdm/v3/utilsCdm","sap/base/util/Version","sap/ui/thirdparty/jquery","sap/base/util/isPlainObject","sap/base/util/isEmptyObject","sap/base/util/ObjectPath","sap/base/util/deepExtend","sap/base/util/deepClone","sap/base/Log","sap/ushell/UI5ComponentType"],function(e,t,i,r,o,n,s,a,l,u,p,d,c,jQuery,f,g,h,m,v,T,y){"use strict";var R=T.getLogger("sap/ushell/adapters/cdm/LaunchPageAdapter");var _=T.Level;var C="sap.ushell.components.tiles.cdm.applauncher";var b="sap.ushell.components.tiles.cdm.applauncherdynamic";function I(e,t,i){this.oAdapterConfiguration=i;this._mResolvedTiles={};this._mCatalogTilePromises={};this._mFailedResolvedCatalogTiles={};this._mFailedResolvedTiles={};this._mContentProviders={};this.TileType={Tile:"tile",Link:"link",Card:"card"}}I.prototype.getGroups=function(){var e=new jQuery.Deferred;this._ensureLoaded().done(function(t){p.setPerformanceMark("FLP - homepage groups processed");e.resolve(t)}).fail(function(){e.resolve([])});return e.promise()};I.prototype._ensureLoaded=function(){var t=this,i;if(this._ensureLoadedDeferred){return this._ensureLoadedDeferred.promise()}i=new jQuery.Deferred;this._ensureLoadedDeferred=i;this._getSiteData().done(function(i){if(!t.isSiteSupported(i)){throw new Error("Invalid CDM site version: Check the configuration of the launchpage adapter and the version of the FLP site")}var r=[];var o=e.getGroupsArrayFromSite(i);o=t._addDefaultGroup(o,i);o.forEach(function(e){r=t._ensureGroupItemsResolved(e,i).concat(r)});t._allPromisesDone(r).done(function(){t._ensureLoadedDeferred.resolve(o);delete t._ensureLoadedDeferred;t._logTileResolutionFailures(t._mFailedResolvedTiles)})}).fail(function(e){R.error("Delivering hompage groups failed - "+e);t._ensureLoadedDeferred.resolve([]);delete t._ensureLoadedDeferred});return i.promise()};I.prototype._ensureGroupItemsResolved=function(e,t){var i=[],r,o;if(e.payload&&e.payload.tiles){r=this._ensureGroupTilesResolved(e.payload.tiles,t);Array.prototype.push.apply(i,r)}if(e.payload&&e.payload.links){o=this._ensureGroupLinksResolved(e.payload.links,t);Array.prototype.push.apply(i,o)}return i};I.prototype._ensureGroupTilesResolved=function(e,t){return(e||[]).map(function(e,i){return this._resolveGroupTile(e,t).then(function(e){e.isLink=false;return e})},this)};I.prototype._ensureGroupLinksResolved=function(e,t){return(e||[]).map(function(e){return this._resolveGroupTile(e,t).then(function(e){e.isLink=true;return e})},this)};I.prototype._resolveGroupTile=function(e,t){var i=this._mResolvedTiles;var r=this._mFailedResolvedTiles;var o;function n(t){i[e.id]=t;if(r[e.id]){delete r[e.id]}return t}function s(e){var t=e.target;return t&&t.semanticObject==="Shell"&&t.action==="launchURL"}if(i[e.id]){return(new jQuery.Deferred).resolve(i[e.id]).promise()}if(e.target&&e.target.url){o=jQuery.when(this._getTileForUrl(e))}else if(e.isBookmark&&e.vizType===undefined){o=this._resolveTileByIntent(e,t)}else if(s(e)){o=this._resolveTileByIntent(e,t)}else{o=this._resolveTileByVizId(e,t)}var a=new jQuery.Deferred;o.done(function(e){a.resolve(n(e))}).fail(function(t){r[e.id]=t;a.reject(t)});return a.promise()};I.prototype._resolveTileByVizId=function(r,o){var n,a,u,c,g,h,T,y,R,C,b,I,D;function S(e,t){return(new jQuery.Deferred).reject({logLevel:e,message:t}).promise()}var L=new jQuery.Deferred;if(!f(o)){return S(_.ERROR,"Cannot resolve tile: oSite must be an object")}if(!f(r)){return S(_.ERROR,"Cannot resolve tile: oTile must be an object")}a=r.vizId;n=v(t.get(o,a||"")||{});c=r.vizType||t.getTypeId(n);u=t.getType(o,c);if(!u){return S(_.ERROR,"Cannot resolve tile '"+r.id+"': no visualization type found for vizTypeId '"+c+"'")}g=t.getAppId(n);if(g){h=t.getAppDescriptor(o,g);if(!h){return S(_.INFO,"Tile '"+r.id+"' filtered from result: no app descriptor found for appId '"+g+"' (dangling app reference)")}T=e.getInbound(h,t.getTarget(n).inboundId);if(!T){return S(_.ERROR,"Cannot resolve tile '"+r.id+"': app '"+g+"' has no navigation inbound")}y=d.mapOne(T.key,T.inbound,h,n,u,o);var P=y.resolutionResult.applicationType,G=y.resolutionResult.additionalInformation,F=s.last("/core/navigation/enableInPlaceForClassicUIs"),w=F?F[P]:false;R=l.computeNavigationModeForHomepageTiles(P,G,w);I=t.getOutbound(n,T.inbound);b=this._toHashFromOutbound(I)}else{n.vizConfig=m({},n.vizConfig,r.vizConfig);y=d.mapOne(undefined,undefined,undefined,n,u,o);if(t.startsExternalUrl(n)){D=p.getMember(n.vizConfig,"sap|flp.target.url")}}C=y.tileResolutionResult;C.navigationMode=R;C.isLink=false;if(!this._isFormFactorSupported(C)){return S(_.INFO,"Tile '"+r.id+"' filtered from result: form factor not supported")}if(D||b){L.resolve({tileResolutionResult:C,tileIntent:D||b})}else{if(!this._oUrlParsingPromise){this._oUrlParsingPromise=sap.ushell.Container.getServiceAsync("URLParsing")}this._oUrlParsingPromise.then(function(e){if(r.target){var t=v(r.target);b=d.toHashFromTarget(i.harmonizeTarget(t),e)}L.resolve({tileResolutionResult:C,tileIntent:b})})}return L.promise()};I.prototype._isFormFactorSupported=function(t){var i=p.getFormFactor();return e.supportsFormFactor(t,i)};I.prototype._getFirstInbound=function(e){var t=Object.keys(e["sap.app"].crossNavigation.inbounds).shift(),i=e["sap.app"].crossNavigation.inbounds[t];return{key:t,inbound:i}};I.prototype._resolveTileByIntent=function(e){var t=this._prepareTileHash(e);return this._getTileFromHash(t)};I.prototype._allPromisesDone=function(e){var t=new jQuery.Deferred,i;if(e.length===0){t.resolve([])}else{var r=e.map(function(e){i=new jQuery.Deferred;e.always(i.resolve.bind(i));return i.promise()});jQuery.when.apply(this,r).done(function(){var e=Array.prototype.slice.call(arguments);t.resolve(e)})}return t.promise()};I.prototype._logTileResolutionFailures=function(e){var t={};if(!e){return}Object.keys(_).filter(function(e){var t=_[e];return t>=_.FATAL&&t<=_.ALL}).forEach(function(e){t[_[e]]=""});Object.keys(e).forEach(function(i){var r=e[i];if(r.logLevel){t[r.logLevel]=t[r.logLevel].concat(r.message).concat("\n")}});if(t[_.FATAL]){R.fatal(t[_.FATAL])}if(t[_.ERROR]){R.error(t[_.ERROR])}if(t[_.WARNING]){R.warning(t[_.WARNING])}if(t[_.INFO]){R.info(t[_.INFO])}if(t[_.DEBUG]){R.debug(t[_.DEBUG])}if(t[_.TRACE]){R.trace(t[_.TRACE])}};I.prototype._isValidTitle=function(e){return typeof e==="string"&&e};I.prototype._isGroupPreset=function(t){return e.isGroupPreset(t)};I.prototype._isGroupLocked=function(t){return e.isGroupLocked(t)};I.prototype.getGroupTitle=function(t){return e.getGroupTitle(t)};I.prototype.getGroupId=function(t){return e.getGroupId(t)};I.prototype.isGroupVisible=function(t){return e.isGroupVisible(t)};I.prototype.getTileTitle=function(t){return e.getTileTitle(this._mResolvedTiles,t)};I.prototype.getTileContentProviderId=function(t){return e.getContentProviderId(t)};I.prototype.getTileSubtitle=function(t){return e.getTileSubtitle(this._mResolvedTiles,t)};I.prototype.getTileIcon=function(t){return e.getTileIcon(this._mResolvedTiles,t)};I.prototype.getTileInfo=function(t){return e.getTileInfo(this._mResolvedTiles,t)};I.prototype.getTileIndicatorDataSource=function(e){var t=this._mResolvedTiles[e.id],i={},r;if(e.indicatorDataSource){i.indicatorDataSource=m({},e.indicatorDataSource);if(e.dataSource){i.dataSource=m({},e.dataSource)}return i}if(!t){return i}r=t.tileResolutionResult;if(r.indicatorDataSource){i.indicatorDataSource=m({},r.indicatorDataSource);if(r.indicatorDataSource.hasOwnProperty("dataSource")){var o=r.indicatorDataSource.dataSource,s=r.dataSources;if(s&&s.hasOwnProperty(o)){i.dataSource=m({},s[o])}else{T.warning("datasource referenced but not found for tile: "+t.tileIntent)}}if(p.getMember(r,"runtimeInformation.componentProperties.url")){var a=p.getMember(i,"indicatorDataSource.path");var l=p.getMember(i,"dataSource.uri");var u=p.getMember(r,"runtimeInformation.componentProperties.url");var d=n(a,l,u,this.getWindowLocationHref());if(!d.error){if(a){i.indicatorDataSource.path=d.uri}if(l){i.dataSource.uri=d.uriParent}}}}return i};I.prototype.getWindowLocationHref=function(){return window.location.href};I.prototype.isGroupRemovable=function(e){return!this._isGroupPreset(e)};I.prototype.isGroupLocked=function(e){return this._isGroupLocked(e)};I.prototype.getGroupTiles=function(t){return e.getGroupTiles(t).concat(e.getGroupLinks(t))};I.prototype.getTileType=function(t){if(e.isLink(this._mResolvedTiles,t)){return this.TileType.Link}if(e.isCard(this._mResolvedTiles,t)){return this.TileType.Card}return this.TileType.Tile};I.prototype.getTileId=function(t){return e.getTileId(t)};I.prototype.getTileSize=function(t){return e.getTileSize(this._mResolvedTiles,t)||"1x1"};I.prototype.getTileTarget=function(t){var i=e.getTileId(t),r=this._mResolvedTiles[i];if(t.target&&t.target.url){return t.target.url}if(r){return r.tileIntent}T.warning("Could not find a target for Tile with id '"+i+"'","sap.ushell.adapters.cdm.LaunchPageAdapter");return""};I.prototype.isTileIntentSupported=function(e){return this._mFailedResolvedTiles[e.id]===undefined};I.prototype.setTileVisible=function(e,t){var i=this._mResolvedTiles[e.id];if(i){if(i.tileComponent){this._notifyTileAboutVisibility(i.tileComponent,t,i.visibility)}i.visibility=t}};I.prototype.getCardManifest=function(e){var t,i=this._mResolvedTiles[e.id];t=i.tileResolutionResult;return t.tileComponentLoadInfo};I.prototype._getTileUiComponentContainer=function(e,t,i){var n=this,s,l,p,d,c,f,g=new jQuery.Deferred;sap.ushell.Container.getServiceAsync("Ui5ComponentLoader").then(function(r){l=r;var o=this._createTileComponentData(e,i,t);return o}.bind(this)).then(function(t){return this._enhanceTileComponentData(e,t)}.bind(this)).then(function(h){s=t.tileResolutionResult;if(t.isLink){p=s.navigationMode;g.resolve(n._createLinkInstance(e,i,p,r,u));return}var m=this._createTileComponentProperties(h,s.tileComponentLoadInfo);if(!m.name){return Promise.reject("Cannot find name of tile component for tile with id: '"+e.id+"'")}if(m.manifest){h.properties=h.properties||{};h.properties.manifest=m.manifest}f=this._isCustomTileComponent(m.name);var v=function(t){var r;d=t.componentHandle.getInstance();c=new o({component:d,height:"100%"});if(!i){r=n._mResolvedTiles[e.id];r.tileComponent=d;if(typeof r.visibility==="boolean"){n._notifyTileAboutVisibility(d,r.visibility)}}return c};var T=function(){return l.createComponent({loadCoreExt:f,loadDefaultDependencies:false,componentData:h,url:m.url,applicationConfiguration:{},reservedParameters:{},applicationDependencies:m,ui5ComponentName:m.name},{},[],y.Visualization).then(v)};if(f){a.once("CoreResourcesComplementLoaded").do(function(){T().then(function(e){g.resolve(e)}).fail(function(e){g.reject(e)})})}else{T().then(function(e){g.resolve(e)}).fail(function(e){g.reject(e)})}}.bind(this)).catch(function(e){g.reject(e)});return g.promise()};I.prototype._createTileComponentProperties=function(e,t){var i={};if(!t||g(t)){if(e.properties.indicatorDataSource&&e.properties.indicatorDataSource.path){i.name=b}else{i.name=C}}else{i=t.componentProperties||{};i.name=t.componentName}return i};I.prototype.getTileView=function(e){var t=this;return new jQuery.Deferred(function(i){return t._getTileView(e,false).then(function(e){i.resolve(e)},function(t){var r="Tile with ID '"+e.id+"' could not be initialized"+(t?":\n"+t:".");T.error(r,null,e.tileType);i.reject(r)})}).promise()};I.prototype._getTileView=function(e){var t,i,r=new jQuery.Deferred;if(typeof e!=="object"||!e.id){i="Invalid input parameter passed to _getTileView: "+e;T.error(i);return r.reject(i).promise()}t=this._mResolvedTiles[e.id];if(!t){i="No resolved tile found for tile ID: "+e.id;T.error(i);return r.reject(i).promise()}return this._getTileUiComponentContainer(e,t,false)};I.prototype._createTileComponentData=function(e,t,i){var r=t?this.getCatalogTileTitle(e):this.getTileTitle(e),o=t?this.getCatalogTilePreviewSubtitle(e):this.getTileSubtitle(e),n=t?this.getCatalogTilePreviewIcon(e):this.getTileIcon(e),s=t?this.getCatalogTilePreviewInfo(e):this.getTileInfo(e),a=t?this.getCatalogTileTargetURL(e):this.getTileTarget(e),l=this.getTileIndicatorDataSource(e),u=e.numberUnit||i.tileResolutionResult&&i.tileResolutionResult.numberUnit,p={properties:{},startupParameters:{}};if(i.tileResolutionResult&&i.tileResolutionResult.isCustomTile===true&&i.tileResolutionResult.startupParameters){p.startupParameters=i.tileResolutionResult.startupParameters}if(r){p.properties.title=r}if(s){p.properties.info=s}if(o){p.properties.subtitle=o}if(n){p.properties.icon=n}if(a){p.properties.targetURL=a}if(u){p.properties.numberUnit=u}if(l.indicatorDataSource){p.properties.indicatorDataSource=l.indicatorDataSource;if(l.dataSource){p.properties.dataSource=l.dataSource}}if(i.tileResolutionResult){p.properties.navigationMode=i.tileResolutionResult.navigationMode;p.properties.contentProviderId=i.tileResolutionResult.contentProviderId||""}return p};I.prototype._enhanceTileComponentData=function(e,t){var i=Promise.resolve();var r=this.getTileContentProviderId(e);if(r){i=sap.ushell.Container.getServiceAsync("ClientSideTargetResolution").then(function(e){return e.getSystemContext(r)}).then(function(e){t.properties.indicatorDataSource.path=e.getFullyQualifiedXhrUrl(t.properties.indicatorDataSource.path)}).catch(function(){T.error("System Context not available")})}return i.then(function(){return t})};I.prototype._isGroupTile=function(t){return e.isGroupTile(t)};I.prototype._isCatalogTile=function(e){return!!(e&&e.isCatalogTile)};I.prototype._isFailedGroupTile=function(t){return!!(t&&this._mFailedResolvedTiles&&this._mFailedResolvedTiles[e.getTileId(t)])};I.prototype.getCatalogTileId=function(e){if(this._isGroupTile(e)){if(this._isFailedGroupTile(e)){return undefined}if(e.isBookmark&&h.get("target.url",e)){return e.target.url}return e.vizId||e.target&&e.target.url}if(this._isCatalogTile(e)){return e.id}return undefined};I.prototype.getCatalogTilePreviewTitle=function(e){if(this._isGroupTile(e)){return this.getTileTitle(e)}return e.tileResolutionResult&&e.tileResolutionResult.title||""};I.prototype.getCatalogTileTargetURL=function(e){if(!e){throw new Error("The given tile is falsy")}if(this._isCatalogTile(e)){if(e.tileResolutionResult&&e.tileResolutionResult.isCustomTile){if(!e.tileResolutionResult.targetOutbound){return""}return this._toHashFromOutbound(e.tileResolutionResult.targetOutbound)}return e.tileIntent||""}return this.getTileTarget(e)};I.prototype.isGroupFeatured=function(e){return!!e.isFeatured};I.prototype._getMember=function(e,t){return p.getMember(e,t)};I.prototype.getCdmVersionsSupported=function(){return{min:c("3.0.0"),max:c("3.1.0")}};I.prototype.isSiteSupported=function(e){if(!e._version||c(e._version).compareTo(this.getCdmVersionsSupported().min)<0||c(e._version).compareTo(this.getCdmVersionsSupported().max)>0){T.fatal("Invalid CDM site version: Only version 3.0.0 is supported");return false}return true};I.prototype._isCustomTileComponent=function(e){return!(e===C||e===b)};return I},false);
//# sourceMappingURL=AdapterBase.js.map