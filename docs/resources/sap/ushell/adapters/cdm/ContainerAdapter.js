// Copyright (c) 2009-2022 SAP SE, All Rights Reserved
sap.ui.define(["sap/ushell/utils","sap/ushell/User","sap/ushell/System","sap/ui/thirdparty/URI","sap/base/Log","sap/base/util/ObjectPath","sap/ui/thirdparty/jquery"],function(e,t,r,i,o,s,jQuery){"use strict";var n=o.getLogger("sap/ushell/adapters/cdm/ContainerAdapter",o.Level.INFO);var a=function(a,u,l){var f="/sap/public/bc/icf/logoff",c=y(l.config,f),d=s.get("systemProperties.logoutMethod",l.config)||"GET",m=s.get("systemProperties.csrfTokenUrl",l.config),p=P(l.config),g=v(a,l.config),h=R(l.config);function y(e,t){if(e.systemProperties&&e.systemProperties.logoutUrl){return e.systemProperties.logoutUrl}return t}function P(e){var r,i=e.userProfile;if(i){r=b(i.defaults,e.userProfilePersonalization,i.metadata)}return new t(r||T())}function v(e,t){var i=t.systemProperties,o=e.getAlias(),s=e.getPlatform(),n=e.getBaseUrl(),a,u,l,f,c,d,m;if(i){o=i.alias||o;s=i.platform||s;a=i.SID;u=i.client;l=i.productName;f=i.productVersion;c=i.systemName;d=i.systemRole;m=i.tenantRole}return new r({alias:o,platform:s,baseUrl:n,system:a,client:u,productName:l,productVersion:f,systemName:c,systemRole:d,tenantRole:m})}function b(e,t,r){var i=jQuery.extend(T(),e,t);i.bootTheme=i.bootTheme||{theme:i.theme,root:""};delete i.theme;if(r){if(r.editablePropterties){i.setThemePermitted=r.editablePropterties.indexOf("theme")>-1;i.setAccessibilityPermitted=r.editablePropterties.indexOf("accessibility")>-1;i.setContentDensityPermitted=r.editablePropterties.indexOf("contentDensity")>-1}if(r.ranges){i.ranges=r.ranges}}return i}function T(){return{setThemePermitted:false,setAccessibilityPermitted:false,setContentDensityPermitted:false}}function R(e){var t=e&&e.systemProperties&&e.systemProperties.sessionKeepAlive;if(!t){return null}if(!t.url){n.error("Mandatory parameter 'url' missing in 'sessionKeepAlive' configuration.");return null}if(t.method!=="HEAD"&&t.method!=="GET"){t.method="HEAD"}return t}this._getLogoutUrl=function(){return c};this._setDocumentLocation=function(e){document.location=e};this._setWindowLocation=function(e){window.location.href=e};this.getSystem=function(){return g};this.getUser=function(){return p};this.load=function(){return jQuery.when()};this.getCurrentUrl=function(){return window.location.href};this.logout=function(t){var r;if(!t){throw new Error("Not implemented")}if(e.hasNativeLogoutCapability()){r=new i(this._getLogoutUrl()).absoluteTo(this.getCurrentUrl()).search("").toString();e.getPrivateEpcm().doLogOff(r)}else{return this.logoutRedirect()}return jQuery.when()};this.logoutRedirect=function(){var e=g.adjustUrl(this._getLogoutUrl()),t=new jQuery.Deferred,r=this;if(d==="POST"){o.info("performing logout from system via POST",undefined,"sap.ushell.adapters.cdm.ContainerAdapter::logoutRedirect");jQuery.ajax({type:"HEAD",url:m,headers:{"X-CSRF-Token":"Fetch"},success:function(i,s,n){jQuery.ajax({type:"POST",url:e,headers:{"X-CSRF-Token":n.getResponseHeader("X-CSRF-Token")},success:function(e){r._setWindowLocation(e);t.resolve()},error:function(){o.error("Logging out via POST failed",undefined,"sap.ushell.adapters.cdm.ContainerAdapter::logoutRedirect");t.resolve()}})},error:function(){o.error("fetching X-CSRF-Token for logout via POST failed for system: "+g.getAlias(),undefined,"sap.ushell.adapters.cdm.ContainerAdapter::logoutRedirect");t.resolve()}})}else{o.info("performing logout from system via GET (redirect)",undefined,"sap.ushell.adapters.cdm.ContainerAdapter::logoutRedirect");this._setDocumentLocation(e);t.resolve()}return t.promise()};this.sessionKeepAlive=function(){if(!h){return}var e=new XMLHttpRequest;e.open(h.method,h.url,true);e.onreadystatechange=function(){if(this.readyState===4){n.debug("Server session was extended")}};e.send()};this._getSessionKeepAliveConfig=function(){return h}};return a},false);
//# sourceMappingURL=ContainerAdapter.js.map