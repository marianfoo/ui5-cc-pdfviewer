// Copyright (c) 2009-2022 SAP SE, All Rights Reserved
sap.ui.define(["sap/base/Log","sap/base/util/deepExtend","sap/ui/performance/trace/FESR","sap/ushell/performance/ShellAnalytics"],function(e,t,r,n){"use strict";var a={HOME_INITIAL:"FLP@LOAD",HOME_LOADING:"FLP@DURING_LOAD",FINDER_INITIAL:"FLP@LOAD_FINDER",APP_INITIAL:"FLP@DEEP_LINK",NAVIGATION:"NAVIGATION",CUSTOM_HOME_INITIAL:"FLPCUSTOMHOME"};var i={APP_START:1,STEP_IN_APP:2,UNKNOWN:3};var s={_fnOriginalOnBeforeCreated:null,_lastTrackedRecord:null,init:function(){if(r.getActive()){n.enable();this._fnOriginalOnBeforeCreated=r.onBeforeCreated;r.onBeforeCreated=this._onBeforeCreatedHandler.bind(this)}},reset:function(){r.onBeforeCreated=this._fnOriginalOnBeforeCreated;n.disable();this._setLastTrackedRecord(null)},_getPerformanceEntries:function(e){return performance.getEntriesByName(e)},_getLastTrackedApplicationId:function(){var e=n.getCurrentApplication();if(e){return e.id}return null},_getLastTrackedRecord:function(){return this._lastTrackedRecord},_setLastTrackedRecord:function(e){this._lastTrackedRecord=e},_onBeforeCreatedHandler:function(t,r){var n=this._detectScenario(t,r),a=this._getLastTrackedApplicationId();if(a){t.appNameShort=a}if(!n.scenario){e.debug("[fesrEnhFlp] unknown scenario, step name: "+t.stepName);return t}var i=this._enhanceRecord(n.scenario,t,n.relatedEvent);e.debug("[fesrEnhFlp] pass step name: "+i.stepName);e.debug("[fesrEnhFlp] pass short application name: "+i.appNameShort);e.debug("[fesrEnhFlp] pass long application name: "+i.appNameLong);if(/tile.*press/.test(i.stepName)){e.debug("[fesrEnhFlp] did not overwrite press step name")}if(/__cdm/.test(i.stepName)){e.debug("[fesrEnhFlp] did not overwrite press step name(cdm)")}return i},_detectScenario:function(e,t){function r(e,t){var r={scenario:e};if(t){r.relatedEvent=t}return r}if(e.stepName==="undetermined_startup"){var i=n.getLastClosedRecord();this._setLastTrackedRecord(i);if(!!i&&i.isHomeApp){return r(a.CUSTOM_HOME_INITIAL)}switch(e.appNameLong){case"sap.ushell.components.homepage":return r(a.HOME_INITIAL);case"sap.ushell.components.pages":return r(a.HOME_INITIAL);case"sap.ushell.components.appfinder":return r(a.FINDER_INITIAL);default:return r(a.APP_INITIAL,i)}}var s=this._getLastTrackedRecord(),c=n.getNextNavigationRecords(s),o,p;if(c.length===1){p=c[0];if(p&&s&&!p.isEqual(s)||!s&&p){this._setLastTrackedRecord(p);o=p.step===a.HOME_LOADING?a.HOME_LOADING:a.NAVIGATION;return r(o,p)}}else if(c.length>1){c.pop();p=c[0];this._setLastTrackedRecord(p);o=p.step===a.HOME_LOADING?a.HOME_LOADING:a.NAVIGATION;return r(o,p)}return r(null)},_enhanceRecord:function(t,r,n){switch(t){case a.HOME_INITIAL:return this._enhanceInitialStart(r,t,"FLP-TTI-Homepage");case a.CUSTOM_HOME_INITIAL:return this._enhanceInitialStart(r,t,"FLP-TTI-Homepage-Custom");case a.FINDER_INITIAL:return this._enhanceInitialStart(r,t,"FLP-TTI-AppFinder");case a.APP_INITIAL:return this._enhanceInitialAppStart(r,t,n||{});case a.NAVIGATION:case a.HOME_LOADING:return this._enhanceNavigationRecord(r,t,n||{});default:break}e.warning("[fesrEnhFlp] Unknown scenario at the end of execution, unnecessary code executed",null,"sap.ushell.performance.FesrEnhancer");return r},_enhanceInitialStart:function(r,n,s){var c,o=t({},r);if(n===a.CUSTOM_HOME_INITIAL){o.stepName=n+"@"+r.appNameShort}else{o.stepName=n}o.interactionType=i.APP_START;if(s){c=this._getPerformanceEntries(s)[0];if(c){o.timeToInteractive=c.startTime;return o}e.warning("[fesrEnhFlp] Scenario '"+n+"' detected but expected performance mark '"+s+"' does not exist",null,"sap.ushell.performance.FesrEnhancer")}return o},_enhanceNavigationRecord:function(e,r,n){var a=t({},e);if(r!=="FLP@DURING_LOAD"){a.stepName=n.step||e.stepName}a.appNameShort=n.targetApplication||"";if(n.applicationType==="UI5"){a.interactionType=i.APP_START}if(/^FLP_BACK/.test(a.stepName)){var s=this._getPerformanceEntries("FLP-TTI-Homepage")[0];if(s){if(s.startTime>n.getTimeStart()){a.timeToInteractive=s.startTime-n.getTimeStart()}}}return a},_enhanceInitialAppStart:function(e,r,n){var a=t({},e);a.stepName=r;a.appNameShort=e.appNameShort;if(n.applicationType==="UI5"){a.interactionType=i.APP_START}else{a.interactionType=i.STEP_IN_APP}return a}};return s},true);
//# sourceMappingURL=FesrEnhancer.js.map