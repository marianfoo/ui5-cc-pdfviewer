// Copyright (c) 2009-2022 SAP SE, All Rights Reserved
sap.ui.define(["sap/ushell/appRuntime/ui5/AppRuntimePostMessageAPI","sap/ushell/appRuntime/ui5/AppRuntimeService","sap/base/util/UriParameters","sap/ui/thirdparty/URI","sap/ui/thirdparty/jquery","sap/ui/Device","sap/ui/core/BusyIndicator","sap/ushell/appRuntime/ui5/performance/FesrEnhancer","sap/ushell/EventHub","sap/base/Log","sap/ui/thirdparty/hasher","sap/ushell/resources"],function(e,t,s,i,jQuery,r,a,n,u,o,p,l){"use strict";function d(){var d=this,c,f,h=true,g={},v,C={},y={},m={},b={},S,I,w,A,R;this.init=function(i,r,a,o,f,g){c=i;v=r;I=a;if(o!==undefined){h=o}this.addAppInfoToCache(f,g);e.registerCommHandlers({"sap.ushell.services.appLifeCycle":{oServiceCalls:{create:{executeServiceCallFn:function(e){n.startInteraction();t.sendMessageToOuterShell("sap.ushell.appRuntime.iframeIsBusy",{bValue:true});var i=JSON.parse(e.oMessage.data),r=s.fromURL(i.body.sUrl).get("sap-ui-app-id");p.disableCFLPUpdate=true;p.replaceHash(i.body.sHash);p.disableCFLPUpdate=false;d.create(r,i.body.sUrl);return(new jQuery.Deferred).resolve().promise()}},destroy:{executeServiceCallFn:function(e){var t=JSON.parse(e.oMessage.data);d.destroy(t.body.sCacheId);return(new jQuery.Deferred).resolve().promise()}},store:{executeServiceCallFn:function(e){var t=JSON.parse(e.oMessage.data);d.store(t.body.sCacheId);return(new jQuery.Deferred).resolve().promise()}},restore:{executeServiceCallFn:function(e){var t=JSON.parse(e.oMessage.data);p.disableCFLPUpdate=true;p.replaceHash(t.body.sHash);p.disableCFLPUpdate=false;d.restore(t.body.sCacheId);return(new jQuery.Deferred).resolve().promise()}}}}});u.on("disableKeepAliveRestoreRouterRetrigger").do(function(e){if(e.componentId&&y[e.componentId]){y[e.componentId]=e.disable}});t.sendMessageToOuterShell("sap.ushell.services.appLifeCycle.setup",{isStateful:true,isKeepAlive:true,isIframeValid:true,isIframeBusy:true});if(!l.browserI18n){l.browserI18n=l.getTranslationModel(window.navigator.language).getResourceBundle()}A=l.browserI18n.getText("dataLossExternalMessage");window.addEventListener("onbeforeunload",function(){if(sap.ushell&&sap.ushell.Container&&sap.ushell.Container.getDirtyFlag()){return A}return undefined})};this.create=function(e,s){if(r.browser.chrome){a.show(0)}if(w){w._resetBackNavigationCallback()}sap.ui.getCore().getEventBus().publish("launchpad","appOpening",{});var n=new Promise(function(t){d.getAppInfo(e,s).then(function(e){t(e)})}).then(function(r){d.getURLParameters(new i(s).query(true)).then(function(s){v(e,s,r).then(function(e){I(e);t.sendMessageToOuterShell("sap.ushell.appRuntime.iframeIsBusy",{bValue:false});sap.ui.getCore().getEventBus().publish("sap.ushell","appOpened",{})})})});return n};this.destroy=function(e){function t(e){var t=e.sId||"<unkown>";try{e.destroy()}catch(e){o.error("exception when trying to close sapui5 application with id '"+t+"' when running inside the appruntim iframe '"+document.URL+"'. This error must be fixed in order for the iframe to operate properly.\n",e.stack,"sap.ushell.appRuntime.ui5.services.AppLifeCycleAgent::destroy")}}if(e&&C[e]){if(C[e]===S){S=undefined}delete y[C[e].sId];t(C[e]);delete C[e]}else if(S){delete y[S.sId];t(S);S=undefined}sap.ushell.Container.cleanDirtyStateProviderArray();if(w){w._resetBackNavigationCallback()}n.setAppShortId();sap.ui.getCore().getEventBus().publish("sap.ushell","appClosed",{})};this.store=function(e){var t=S,s;C[e]=t;if(w){b[e]=w._getBackNavigationCallback()}s=t.getComponentInstance();t.setVisible(false);if(sap.ushell.Container){m[e]=sap.ushell.Container.getAsyncDirtyStateProviders();sap.ushell.Container.cleanDirtyStateProviderArray()}if(s){if(s.isKeepAliveSupported&&s.isKeepAliveSupported()===true){s.deactivate()}else{if(s.suspend){s.suspend()}if(s.getRouter&&s.getRouter()){s.getRouter().stop()}}}sap.ui.getCore().getEventBus().publish("sap.ushell","appClosed",{})};this.restore=function(e){var t=C[e],s=t.getComponentInstance(),i=y[t.sId];sap.ui.getCore().getEventBus().publish("launchpad","appOpening",{});t.setVisible(true);if(m[e]&&sap.ushell.Container){sap.ushell.Container.setAsyncDirtyStateProviders(m[e])}if(w){w.setBackNavigation(b[e])}if(s){if(s.isKeepAliveSupported&&s.isKeepAliveSupported()===true){s.activate()}else{if(s.restore){s.restore()}if(s.getRouter&&s.getRouter()&&s.getRouter().initialize){if(i===false){s.getRouter().initialize()}else{s.getRouter().initialize(true)}}}S=t}sap.ui.getCore().getEventBus().publish("sap.ushell","appOpened",{})};this.getURLParameters=function(e){return new Promise(function(s,r){if(e.hasOwnProperty("sap-intent-param")){var a=e["sap-intent-param"];t.sendMessageToOuterShell("sap.ushell.services.CrossApplicationNavigation.getAppStateData",{sAppStateKey:a}).then(function(t){delete e["sap-intent-param"];var r=jQuery.extend({},e,new i("?"+t).query(true),true);s(r)},function(t){s(e)})}else{s(e)}})};this.getAppInfo=function(e,t){return new Promise(function(s){function i(){f.getAppInfo(e,t).then(function(t){d.addAppInfoToCache(e,t);s(t)})}if(h===true&&g[e]){s(JSON.parse(JSON.stringify(g[e])))}else if(f){i()}else{sap.ui.require([c.replace(/\./g,"/")],function(e){f=e;i()})}})};this.addAppInfoToCache=function(e,t){if(e&&t&&h===true&&g[e]===undefined){g[e]=JSON.parse(JSON.stringify(t))}};this.setComponent=function(e){S=e;if(S){y[S.sId]=true}};this.setShellUIService=function(e){w=e};this.setShellNavigationService=function(e){R=e};this.checkDataLossAndContinue=function(){if(sap.ushell&&sap.ushell.Container&&sap.ushell.Container.getDirtyFlag(R.getNavigationContext())){if(window.confirm(A)){sap.ushell.Container.setDirtyFlag(false);return true}else{return false}}return true}}return new d},true);
//# sourceMappingURL=AppLifeCycleAgent.js.map