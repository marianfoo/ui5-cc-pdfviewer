// Copyright (c) 2009-2022 SAP SE, All Rights Reserved
sap.ui.define(["sap/ushell/utils/UrlParsing","sap/ushell/utils","sap/ushell/System","sap/ushell/Ui5ServiceFactory","sap/ushell/Ui5NativeServiceFactory","sap/ui/base/EventProvider","sap/ui/core/service/ServiceFactoryRegistry","sap/ui/core/Control","sap/ui/performance/Measurement","sap/ui/thirdparty/URI","sap/ui/util/Mobile","sap/base/util/uid","sap/base/assert","sap/base/Log","sap/ui/thirdparty/jquery","sap/ushell/EventHub","sap/ushell/User"],function(e,t,r,n,i,o,a,s,u,l,c,f,d,g,jQuery,h,p){"use strict";var v="sap.ushell.services.Container",m="sap.ushell.Container.dirtyState.",y={},S,w,C,D=[];function P(){close()}function b(){document.location="about:blank"}function E(e){if(w&&w[e]){return w[e]}return"sap.ushell.adapters."+e}function L(e){return S.services&&S.services[e]||{}}function A(e,t,r,n,i){var o=L(e).adapter||{},a;function s(e){var n=sap.ui.requireSync(e);return new n(t,r,{config:o.config||{}})}function u(e){return new Promise(function(n,i){sap.ui.require([e],function(e){var i=new e(t,r,{config:o.config||{}});n(i)},i)})}if(i===true){a=o.module;if(a===undefined){return n?Promise.resolve():undefined}}else{a=o.module||E(t.getPlatform())+"."+e+"Adapter"}var l=a.replace(/\./g,"/");if(n){return u(l)}return s(l)}function I(n){var i=new o,a=false,c=[],p={},w="sap.ushell.Container."+n.getSystem().getPlatform()+".remoteSystem.",C={},E,I,R=t.getLocalStorage(),F=new t.Map,U=new t.Map,N="sap.ushell.Container."+n.getSystem().getPlatform()+".sessionTermination",M=this;this.cancelLogon=function(){if(this.oFrameLogonManager){this.oFrameLogonManager.cancelLogon()}};this.createRenderer=function(e,r){if(typeof e==="boolean"){r=e;e=undefined}var n={async:!!r};var o;var a;u.start("FLP:Container.InitLoading","Initial Loading","FLP");t.setPerformanceMark("FLP - renderer created");e=e||S.defaultRenderer;if(!e){throw new Error("Missing renderer name")}a=S.renderers&&S.renderers[e]||{};o=a.module||(e.indexOf(".")<0?"sap.ushell.renderers."+e+".Renderer":e);if(a.componentData&&a.componentData.config){n.config=a.componentData.config}function l(t){var r=sap.ui.requireSync(t);var o=new r({componentData:n});var a;var u=sap.ui.require("sap/ui/core/UIComponent");if(o instanceof u){a=new sap.ui.core.ComponentContainer({component:o,height:"100%",width:"100%"})}else{a=o}if(!(a instanceof s)){throw new Error("Unsupported renderer type for name "+e)}f(a);p[e]=o;i.fireEvent("rendererCreated",{renderer:o});return a}function c(t){return new Promise(function(r,o){sap.ui.require([t,"sap/ui/core/ComponentContainer","sap/ui/core/UIComponent","sap/ui/core/routing/Router"],function(t,a,u){var l=new t({componentData:n});if(l instanceof u){var c=new a({component:l,height:"100%",width:"100%",async:true});f(c);p[e]=l;l.rootControlLoaded().then(function(){i.fireEvent("rendererCreated",{renderer:l});r(c)})}else if(l instanceof s){f(l);p[e]=l;i.fireEvent("rendererCreated",{renderer:l});r(l)}else{o(new Error("Unsupported renderer type!"))}})})}function f(e){e.placeAt=function(e,t){var r=e,n="canvas",i=document.body;if(e===i.id){r=document.createElement("div");r.setAttribute("id",n);r.classList.add("sapUShellFullHeight");switch(t){case"first":if(i.firstChild){i.insertBefore(r,i.firstChild);break}case"only":i.innerHTML="";default:i.appendChild(r)}e=n;t=""}s.prototype.placeAt.call(this,e,t)}}var d=o.replace(/\./g,"/");if(r){return c(d)}g.error("sap.ushell.Container.createRenderer() should always be called with bAsync:true.");return l(d)};this.getRenderer=function(e){var t,r;e=e||S.defaultRenderer;if(e){t=p[e]}else{r=Object.keys(p);if(r.length===1){t=p[r[0]]}else{g.warning("getRenderer() - cannot determine renderer, because no default renderer is configured and multiple instances exist.",null,v)}}if(t&&t.isA("sap.ui.core.ComponentContainer")){return t.getComponentInstance()}return t};this.DirtyState={CLEAN:"CLEAN",DIRTY:"DIRTY",MAYBE_DIRTY:"MAYBE_DIRTY",PENDING:"PENDING",INITIAL:"INITIAL"};this.getGlobalDirty=function(){var e,r=new jQuery.Deferred,n=f(),i,o=0,a=this.DirtyState.CLEAN;function s(){if(o===0||a===M.DirtyState.DIRTY){r.resolve(a);g.debug("getGlobalDirty() Resolving: "+a,null,"sap.ushell.Container")}}function u(e){if(e.key.indexOf(m)===0&&e.newValue!==M.DirtyState.INITIAL&&e.newValue!==M.DirtyState.PENDING){g.debug("getGlobalDirty() Receiving event key: "+e.key+" value: "+e.newValue,null,"sap.ushell.Container");if(e.newValue===M.DirtyState.DIRTY||e.newValue===M.DirtyState.MAYBE_DIRTY){a=e.newValue}o-=1;s()}}try{R.setItem(n,"CHECK");R.removeItem(n)}catch(e){g.warning("Error calling localStorage.setItem(): "+e,null,"sap.ushell.Container");return r.resolve(this.DirtyState.MAYBE_DIRTY).promise()}if(E){throw new Error("getGlobalDirty already called!")}E=r;window.addEventListener("storage",u);r.always(function(){window.removeEventListener("storage",u);E=undefined});for(e=R.length-1;e>=0;e-=1){i=R.key(e);if(i.indexOf(m)===0){if(R.getItem(i)==="PENDING"){R.removeItem(i);g.debug("getGlobalDirty() Cleanup of unresolved 'PENDINGS':"+i,null,"sap.ushell.Container")}else{o+=1;t.localStorageSetItem(i,this.DirtyState.PENDING,true);g.debug("getGlobalDirty() Requesting status for: "+i,null,"sap.ushell.Container")}}}s();setTimeout(function(){if(r.state()!=="resolved"){r.resolve("MAYBE_DIRTY");g.debug("getGlobalDirty() Timeout reached, - resolved 'MAYBE_DIRTY'",null,"sap.ushell.Container")}},o*2e3);return r.promise()};this.getLogonSystem=function(){return n.getSystem()};this.getUser=function(){return n.getUser()};this.getDirtyFlag=function(){var e=a;var t=this._oShellNavigationService.getNavigationContext();for(var r=0;r<c.length;r++){e=e||c[r](t)}return e};this.fnAsyncDirtyStateProvider=null;this.getDirtyFlagsAsync=function(){if(!this.fnAsyncDirtyStateProvider){return Promise.resolve(this.getDirtyFlag())}var e=this._oShellNavigationService.getNavigationContext();return this.fnAsyncDirtyStateProvider(e).then(function(e){return e||this.getDirtyFlag()}.bind(this))};this.isAsyncDirtyStateProviderSet=function(){return typeof this.fnAsyncDirtyStateProvider==="function"};this.setAsyncDirtyStateProvider=function(e){this.fnAsyncDirtyStateProvider=e};this.setDirtyFlag=function(e){a=e};this.sessionKeepAlive=function(){if(n.sessionKeepAlive){n.sessionKeepAlive()}};this.extendSession=function(){h.emit("nwbcUserIsActive",Date.now())};this.registerDirtyStateProvider=function(e){if(typeof e!=="function"){throw new Error("fnDirty must be a function")}c.push(e)};this.deregisterDirtyStateProvider=function(e){if(typeof e!=="function"){throw new Error("fnDirty must be a function")}var t=-1;for(var r=c.length-1;r>=0;r--){if(c[r]===e){t=r;break}}if(t===-1){return}c.splice(t,1)};this.getService=function(e,t,r){return M._getService.apply(M,arguments)};this.getServiceAsync=function(e,t){return M._getService(e,t,true)};this._getService=function(e,t,r){var i={},o,a,s,u,l,c;function f(r){var n=new jQuery.Deferred;if(!r){throw new Error("Missing system")}n.resolve(A(e,r,t));sap.ushell.Container.addRemoteSystem(r);return n.promise()}if(!e){throw new Error("Missing service name")}if(e.indexOf(".")>=0){throw new Error("Unsupported service name")}l=L(e);o=l.module||"sap.ushell.services."+e;a=o+"/"+(t||"");c={config:l.config||{}};function d(e,r){i.createAdapter=f;return new e(r,i,t,c)}function h(r,o){var s;if(F.containsKey(a)){s=F.get(a)}else if(r.hasNoAdapter){s=new r(i,t,c)}else{u=A(e,n.getSystem(),t,o,r.useConfiguredAdapterOnly);if(o){return u.then(function(e){var t=d(r,e);F.put(a,t);return t})}s=d(r,u)}F.put(a,s);return o?Promise.resolve(s):s}if(!F.containsKey(a)){if(r){if(!U.containsKey(a)){var p=new Promise(function(e,t){sap.ui.require([o.replace(/[.]/g,"/")],function(t){e(h(t,true))},t)});U.put(a,p);return p}return U.get(a)}g.error("Deprecated API call of 'sap.ushell.Container.getService'. Please use 'getServiceAsync' instead",null,"sap.ushell.services.Container");s=sap.ui.requireSync(o.replace(/[.]/g,"/"));return h(s)}if(r){return Promise.resolve(F.get(a))}return F.get(a)};function T(){var e,t,n,i;for(n=R.length-1;n>=0;n-=1){i=R.key(n);if(i.indexOf(w)===0){try{e=i.substring(w.length);t=JSON.parse(R.getItem(i));C[e]=new r(t)}catch(e){R.removeItem(i)}}}return C}function _(){if(typeof OData==="undefined"){return}function e(e,t,r){g.warning(e,null,"sap.ushell.Container");if(r){setTimeout(r.bind(null,e),5e3)}return{abort:function(){return}}}OData.read=function(t,r,n){return e("OData.read('"+(t&&t.Uri?t.requestUri:t)+"') disabled during logout processing",r,n)};OData.request=function(t,r,n){return e("OData.request('"+(t?t.requestUri:"")+"') disabled during logout processing",r,n)}}this.addRemoteSystem=function(e){var r=e.getAlias(),n=C[r];if(this._isLocalSystem(e)){return}if(n){if(n.toString()===e.toString()){return}g.warning("Replacing "+n+" by "+e,null,"sap.ushell.Container")}else{g.debug("Added "+e,null,"sap.ushell.Container")}C[r]=e;t.localStorageSetItem(w+r,e)};this._isLocalSystem=function(e){var r=e.getAlias();if(r&&r.toUpperCase()==="LOCAL"){return true}var n=new l(t.getLocationHref()),i=this.getLogonSystem().getClient()||"";if(e.getBaseUrl()===n.origin()&&e.getClient()===i){return true}return false};this.addRemoteSystemForServiceUrl=function(e){var t,n={baseUrl:";o="};if(!e||e.charAt(0)!=="/"||e.indexOf("//")===0){return}t=/^[^?]*;o=([^/;?]*)/.exec(e);if(t&&t.length>=2){n.alias=t[1]}e=e.replace(/;[^/?]*/g,"");if(/^\/sap\/(bi|hana|hba)\//.test(e)){n.platform="hana";n.alias=n.alias||"hana"}else if(/^\/sap\/opu\//.test(e)){n.platform="abap"}if(n.alias&&n.platform){this.addRemoteSystem(new r(n))}};this.attachLogoutEvent=function(e,t){var r=false;if(t===true){d(typeof e==="function","Container.attachLogoutEvent: fnFunction must be a function");for(var n=0;n<D.length;n++){if(D[n]===e){r=true;break}}if(!r){D.push(e)}}else{i.attachEvent("Logout",e)}};this.detachLogoutEvent=function(e){i.detachEvent("Logout",e);for(var t=0;t<D.length;t++){if(D[t]===e){D.splice(t,1);break}}};this.attachRendererCreatedEvent=function(e){i.attachEvent("rendererCreated",e)};this.detachRendererCreatedEvent=function(e){i.detachEvent("rendererCreated",e)};this.defaultLogout=function(){var e=new jQuery.Deferred;function r(){n.logout(true).always(function(){R.removeItem(N);e.resolve()})}function o(){var e=new jQuery.Deferred,t=e.promise(),n=[];if(D.length>0){for(var o=0;o<D.length;o++){n.push(D[o]())}Promise.all(n).then(e.resolve);setTimeout(e.resolve,4e3)}else{e.resolve()}t.done(function(){if(i.fireEvent("Logout",true)){r()}else{setTimeout(r,1e3)}})}function a(){var e,r=[];if(I){window.removeEventListener("storage",I)}t.localStorageSetItem(N,"pending");M._suppressOData();e=M._getRemoteSystems();Object.keys(e).forEach(function(t){try{r.push(A("Container",e[t]).logout(false))}catch(e){g.warning("Could not create adapter for "+t,e.toString(),"sap.ushell.Container")}R.removeItem(w+t)});jQuery.when.apply(jQuery,r).done(o)}if(typeof n.addFurtherRemoteSystems==="function"){n.addFurtherRemoteSystems().always(a)}else{a()}return e.promise()};this.logout=this.defaultLogout;this.registerLogout=function(e){this.logout=e};this.setLogonFrameProvider=function(e){if(this.oFrameLogonManager){this.oFrameLogonManager.logonFrameProvider=e}};this.setXhrLogonTimeout=function(e,t){if(this.oFrameLogonManager){this.oFrameLogonManager.setTimeout(e,t)}};this.getFLPConfig=function(){var e=new Promise(function(e,t){var r={URL:this.getFLPUrl()};if(y.CDMPromise){y.CDMPromise.then(function(t){t.getSiteWithoutPersonalization().then(function(t){r.scopeId=t.site.identification.id;e(r)})})}else{e(r)}}.bind(this));return e};this.getFLPUrl=function(r){var n=t.getLocationHref(),i=n.indexOf(e.getShellHash(n));if(i===-1||r===true){return n}return n.substr(0,i-1)};this.getFLPUrlAsync=function(e){return(new jQuery.Deferred).resolve(M.getFLPUrl(e)).promise()};this.inAppRuntime=function(){return false};this.runningInIframe=this.inAppRuntime;this._getAdapter=function(){return n};this.getFLPPlatform=function(e){if(e===true){return S.flpPlatform}return Promise.resolve(S.flpPlatform)};this._closeWindow=P;this._redirectWindow=b;this._getRemoteSystems=T;this._suppressOData=_;sap.ui.getCore().getEventBus().subscribe("sap.ushell.Container","addRemoteSystemForServiceUrl",function(e,t,r){M.addRemoteSystemForServiceUrl(r)});if(typeof n.logoutRedirect==="function"){I=function(e){function r(){M._closeWindow();M._redirectWindow()}if(sap.ushell.Container!==M){return}if(e.key.indexOf(w)===0&&e.newValue&&e.newValue!==R.getItem(e.key)){t.localStorageSetItem(e.key,e.newValue)}if(e.key===N){if(e.newValue==="pending"){M._suppressOData();if(i.fireEvent("Logout",true)){r()}else{setTimeout(r,1e3)}}}};window.addEventListener("storage",I)}this._getFunctionsForUnitTest=function(){return{createAdapter:A}}}function R(e,t){e.forEach(function(e){var r=n.createServiceFactory(e,t);a.register("sap.ushell.ui5service."+e,r)})}function F(e){e.forEach(function(e){var t=i.createServiceFactory(e);a.register("sap.ushell.ui5service."+e,t)})}sap.ushell=sap.ushell||{};sap.ushell.bootstrap=function(e,n){var i,o=new jQuery.Deferred;c.init();if(sap.ushell.Container!==undefined){i=new Error("Unified shell container is already initialized - cannot initialize twice.\nStacktrace of first initialization:"+C);g.error(i,i.stack,v);throw i}C=(new Error).stack;S=jQuery.extend({},true,window["sap-ushell-config"]||{});w=n;if(typeof window["sap.ushell.bootstrap.callback"]==="function"){setTimeout(window["sap.ushell.bootstrap.callback"])}R(["Personalization","URLParsing","CrossApplicationNavigation"],true);R(["Configuration"],false);F(["CardNavigation","CardUserRecents","CardUserFrequents"]);var a=new r({alias:"",platform:S.platform||e});A("Container",a,null,true).then(function(e){e.load().then(function(){function t(){var e,t;var r=window["sap-ushell-config"];if(!r||!r.services){return false}e=r.services.PluginManager;t=e&&e.config;return t&&t.loadPluginsFromSite}sap.ushell.Container=new I(e);var i=[sap.ushell.Container.getServiceAsync("PluginManager")];if(t()){y.CDMPromise=sap.ushell.Container.getServiceAsync("CommonDataModel");i.push(y.CDMPromise)}Promise.all(i).then(function(e){r(e)}).then(n);var a=[];if(S.preloadServices!==undefined&&Array.isArray(S.preloadServices)){S.preloadServices.forEach(function(e){a.push(sap.ushell.Container.getServiceAsync(e))});g.error("Ushell Config's preloadServices should not be used!")}var s=sap.ushell.Container.getServiceAsync("ShellNavigation").then(function(e){sap.ushell.Container._oShellNavigationService=e});a.push(s);Promise.all(a).then(function(){o.resolve()})});function r(e){var t=e[0];var r=e[1];var n=r?r.getPlugins():jQuery.when({});n.then(function(e){var r=jQuery.extend(true,{},S.bootstrapPlugins,e);t.registerPlugins(r);try{t.loadPlugins("EarlyLoading").catch(function(){g.error("Error loading S/4's my home plugin")})}catch(e){g.error("Error loading S/4's my home plugin")}})}function n(){i();sap.ui.require(["sap/ushell/Config"],function(e){a(e)})}function i(){if(t.hasFLPReady2NotificationCapability()){sap.ui.require(["sap/ushell/NWBCInterface"],function(e){t.getPrivateEpcm().doEventFlpReady2(e)})}else if(t.hasFLPReadyNotificationCapability()){t.getPrivateEpcm().doEventFlpReady()}}function a(e){if(e.last("/core/darkMode/enabled")){sap.ushell.Container.getServiceAsync("DarkModeSupport").then(function(e){if(e&&e.setup){e.setup()}})}}});return o.promise()}});
//# sourceMappingURL=Container.js.map