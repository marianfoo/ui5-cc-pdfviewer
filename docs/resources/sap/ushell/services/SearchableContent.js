// Copyright (c) 2009-2022 SAP SE, All Rights Reserved
sap.ui.define(["sap/ushell/Config","sap/ushell/adapters/cdm/v3/_LaunchPage/readApplications","sap/ushell/adapters/cdm/v3/_LaunchPage/readPages","sap/ushell/adapters/cdm/v3/_LaunchPage/readUtils","sap/base/util/values","sap/ui/thirdparty/jquery","sap/ushell/library","sap/ushell/adapters/cdm/v3/_LaunchPage/readVisualizations","sap/base/Log"],function(t,e,i,a,n,jQuery,r,o,s){"use strict";var l=r.DisplayFormat;var u=function(){};u.COMPONENT_NAME="sap/ushell/services/SearchableContent";u.prototype.getApps=function(){if(t.last("/core/spaces/enabled")){return this._getPagesAppData().then(this._filterGetApps)}return this._getLaunchPageAppData().then(this._filterGetApps)};u.prototype._filterGetApps=function(t){t.forEach(function(t){var e=t.visualizations;var i=[];t.visualizations=[];e.forEach(function(e){var a=JSON.stringify({title:e.title,subtitle:e.subtitle,icon:e.icon,vizTypeId:e.vizTypeId});if(i.indexOf(a)===-1){t.visualizations.push(e);i.push(a)}})});return t.filter(function(t){return t.visualizations.length>0})};u.prototype._getLaunchPageAppData=function(){return sap.ushell.Container.getServiceAsync("LaunchPage").then(function(t){this._oLaunchPageService=t;return this._collectLaunchPageTiles()}.bind(this)).then(function(t){return Promise.all(t.map(function(t){var e={tileId:null,tile:t};var i;try{e.tileId=this._oLaunchPageService.getCatalogTileId(t)||this._oLaunchPageService.getTileId(t);i=this._oLaunchPageService.getCatalogTilePreviewTitle(t)}catch(t){s.error("Could not get search data from tile "+e.tileId,t)}if(!i){return new Promise(function(e,i){this._oLaunchPageService.getCatalogTileViewControl(t).done(e).fail(i)}.bind(this)).then(function(t){e.view=t;return e}).catch(function(t){s.error("Could not get search data from tile "+e.tileId,t);return e})}return Promise.resolve(e)}.bind(this)))}.bind(this)).then(function(t){var e={};var i=t.map(function(t){try{return this._buildVizDataFromLaunchPageTile(t.tile)}catch(e){s.error("Could not get search data from tile "+t.tileId,e);return null}}.bind(this)).filter(function(t){return t});t.forEach(function(t){var e=t.view;if(e){if(!e.destroy){s.error("The tile with id '"+t.tileId+"' does not implement mandatory function destroy")}else{e.destroy()}}});i.forEach(function(t){var i=t.targetURL;if(i){if(e[i]){e[i].visualizations.push(t)}else{e[i]=this._buildAppDataFromViz(t)}}}.bind(this));return n(e)}.bind(this))};u.prototype._collectLaunchPageTiles=function(){return new Promise(function(t,e){this._oLaunchPageService.getCatalogs().then(function(e){var i=[];e.forEach(function(t){i.push(this._oLaunchPageService.getCatalogTiles(t))}.bind(this));var a=this._oLaunchPageService.getGroups().then(function(t){var e=[];t.forEach(function(t){Array.prototype.push.apply(e,this._oLaunchPageService.getGroupTiles(t)||[])}.bind(this));return e}.bind(this));i.push(a);return jQuery.when.apply(jQuery,i).then(function(){var e=[];var i=Array.prototype.slice.call(arguments);i.forEach(function(t){Array.prototype.push.apply(e,t)});t(e)})}.bind(this))}.bind(this))};u.prototype._getPagesAppData=function(){var t,e;return sap.ushell.Container.getServiceAsync("CommonDataModel").then(function(t){return Promise.all([t.getAllPages({personalizedPages:true}),t.getApplications(),t.getVisualizations(),t.getVizTypes(),sap.ushell.Container.getServiceAsync("URLParsing"),sap.ushell.Container.getServiceAsync("ClientSideTargetResolution")])}).then(function(i){var a=i[0];var n=i[1];var r=i[2];var o=i[3];var s=i[4];var l=i[5];e={applications:n,visualizations:r,vizTypes:o};t={};this._applyCdmVisualizations(e,t,s);this._applyCdmPages(e,a,t,s);return this._filterAppDataByIntent(t,s,l)}.bind(this)).then(function(){this._applyCdmApplications(e,t);return n(t)}.bind(this))};u.prototype._filterAppDataByIntent=function(t,e,i){var a=Object.keys(t).filter(e.isIntentUrl.bind(e));if(a.length===0){return Promise.resolve()}return new Promise(function(e,n){i.isIntentSupported(a).then(function(e){Object.keys(e).forEach(function(i){if(!e[i].supported&&t[i]){delete t[i]}})}).always(e)})};u.prototype._applyCdmApplications=function(t,i){Object.keys(i).forEach(function(a){try{var n=i[a].visualizations;var r=n.find(function(t){return t.target.appId&&t.target.inboundId});if(r){var o=t.applications[r.target.appId];var l=e.getInbound(o,r.target.inboundId);i[a]=this._buildAppDataFromAppAndInbound(o,l);i[a].visualizations=n;i[a].target=n[0].target}else{i[a]=this._buildAppDataFromViz(n[0]);i[a].visualizations=n;i[a].target=n[0].target}}catch(t){s.error("Could not get search data from application "+a,t)}}.bind(this))};u.prototype._applyCdmVisualizations=function(t,e,i){Object.keys(t.visualizations).forEach(function(n){try{var r={vizId:n,displayFormatHint:l.Standard};var o=a.getVizData(t,r,i);var u=o.targetURL;this._changeVizType(o);o.preview=true;if(u){if(e[u]){e[u].visualizations.push(o)}else{e[u]={visualizations:[o]}}}}catch(t){s.error("Could not get search data from visualization "+n,t)}}.bind(this))};u.prototype._applyCdmPages=function(t,e,n,r){e.forEach(function(e){var o=i.getVisualizationReferences(e);o.forEach(function(e){try{if(e.displayFormatHint&&e.displayFormatHint!==l.Standard){e=Object.assign({},e);e.displayFormatHint=l.Standard}var i=a.getVizData(t,e,r);var o=i.targetURL;this._changeVizType(i);i.preview=true;if(o){if(n[o]){n[o].visualizations.push(i)}else{n[o]={visualizations:[i]}}}}catch(t){s.error("Could not get search data from vizReference "+e.id,t)}}.bind(this))}.bind(this))};u.prototype._changeVizType=function(t){if(t._instantiationData.platform==="CDM"&&!o.isStandardVizType(t.vizType)){t.vizType="sap.ushell.StaticAppLauncher";t._instantiationData.vizType={"sap.ui5":{componentName:"sap.ushell.components.tiles.cdm.applauncher"}}}};u.prototype._buildAppDataFromAppAndInbound=function(t,i){return{id:e.getId(t),title:i.title||e.getTitle(t),subtitle:i.subTitle||e.getSubTitle(t),icon:i.icon||e.getIcon(t),info:i.info||e.getInfo(t),keywords:i.keywords||e.getKeywords(t),visualizations:[]}};u.prototype._buildAppDataFromViz=function(t){return{id:t.vizId,title:t.title,subtitle:t.subtitle,icon:t.icon,info:t.info,keywords:t.keywords,target:t.target,visualizations:[t]}};u.prototype._buildVizDataFromLaunchPageTile=function(t){var e;if(this._oLaunchPageService.getCatalogTileTargetURL(t)&&this._oLaunchPageService.isTileIntentSupported(t)){e={id:this._oLaunchPageService.getTileId(t)||this._oLaunchPageService.getCatalogTileId(t),vizId:this._oLaunchPageService.getCatalogTileId(t)||this._oLaunchPageService.getTileId(t)||"",vizTypeId:"",title:this._oLaunchPageService.getCatalogTilePreviewTitle(t)||this._oLaunchPageService.getCatalogTileTitle(t)||this._oLaunchPageService.getTileTitle(t)||"",subtitle:this._oLaunchPageService.getCatalogTilePreviewSubtitle(t)||"",icon:this._oLaunchPageService.getCatalogTilePreviewIcon(t)||"sap-icon://business-objects-experience",info:this._oLaunchPageService.getCatalogTilePreviewInfo(t)||"",keywords:this._oLaunchPageService.getCatalogTileKeywords(t)||[],target:{type:"URL",url:this._oLaunchPageService.getCatalogTileTargetURL(t)},targetURL:this._oLaunchPageService.getCatalogTileTargetURL(t)};if(t.getChip){e._instantiationData={platform:"LAUNCHPAGE",launchPageTile:t}}else{e._instantiationData={platform:"CDM",vizType:{"sap.ui5":{componentName:"sap.ushell.components.tiles.cdm.applauncher"}}}}}return e};u.hasNoAdapter=true;return u},true);
//# sourceMappingURL=SearchableContent.js.map