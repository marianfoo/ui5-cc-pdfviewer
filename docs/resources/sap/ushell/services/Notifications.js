// Copyright (c) 2009-2022 SAP SE, All Rights Reserved
sap.ui.define(["sap/ui/thirdparty/datajs","sap/ui/core/ws/SapPcpWebSocket","sap/ui/thirdparty/jquery","sap/base/Log","sap/ui/model/json/JSONModel","sap/ushell/utils"],function(e,t,jQuery,i,s,n){"use strict";var o="/sap/bc/apc/iwngw/notification_push_apc";var r=60;function a(a,c,u){var f=new s,d=new Date,l=u&&u.config,g={getNotifications:{},getNotificationsByType:{},getNotificationsInGroup:{},getBadgeNumber:{},resetBadgeNumber:{},getNotificationTypesSettings:{},getNotificationsGroupHeaders:{},getMobileSupportSettings:{},getEmailSupportSettings:{},getWebSocketValidity:{},getNotificationCount:{}},p,h,N,v,_=[],S=[],T=[],C=false,I=[],m=false,b=false,y=true,D,E,A=5e3,P=6e3,O=false,B={NOTIFICATIONS:0,NOTIFICATIONS_BY_TYPE:1,GET_BADGE_NUMBER:2,RESET_BADGE_NUMBER:3,GET_SETTINGS:4,GET_MOBILE_SUPPORT_SETTINGS:5,NOTIFICATIONS_GROUP_HEADERS:6,NOTIFICATIONS_IN_GROUP:7,GET_NOTIFICATIONS_COUNT:8,VALIDATE_WEBSOCKET_CHANNEL:9,GET_EMAIL_SUPPORT_SETTINGS:10,NOTIFICATIONS_BY_DATE_DESCENDING:"notificationsByDateDescending",NOTIFICATIONS_BY_DATE_ASCENDING:"notificationsByDateAscending",NOTIFICATIONS_BY_PRIORITY_DESCENDING:"notificationsByPriorityDescending",NOTIFICATIONS_BY_TYPE_DESCENDING:"notificationsByTypeDescending"},R={PACKAGED_APP:0,FIORI_CLIENT:1,WEB_SOCKET:2,POLLING:3},k,U=false,F=true,G=false,q=new jQuery.Deferred,w=new jQuery.Deferred,L,M,H=q.promise(),j=false,W={},X=10,x=false,$=false,z=[];this.isEnabled=function(){if(!l.enabled||!l.serviceUrl){y=false;if(l.enabled&&!l.serviceUrl){i.warning("No serviceUrl was found in the service configuration")}}else{y=true}return y};this.init=function(){if(!m&&this.isEnabled()){sap.ui.getCore().getEventBus().subscribe("launchpad","sessionTimeout",this.destroy,this);this.lastNotificationDate=new Date;this._setWorkingMode();m=true;this.bUpdateDependencyInitiatorExists=false;this._userSettingInitialization()}sap.ui.getCore().getEventBus().subscribe("launchpad","setConnectionToServer",this._onSetConnectionToServer,this)};this._onSetConnectionToServer=function(e,t,i){if(i.active){this._resumeConnection()}else{this._closeConnection()}};this.getUnseenNotificationsCount=function(){var e=new jQuery.Deferred;e.resolve(f.getProperty("/UnseenCount"));return e.promise()};this.getNotificationsCount=function(){return f.getProperty("/NotificationsCount")?f.getProperty("/NotificationsCount"):"0"};this.getNotificationsByTypeWithGroupHeaders=function(){var t={"Accept-Language":sap.ui.getCore().getConfiguration().getLanguageTag()},s,n=new jQuery.Deferred,o=this._getRequestURI(B.NOTIFICATIONS_BY_TYPE);s={requestUri:o};if(!this._getHeaderXcsrfToken()){t["X-CSRF-Token"]="fetch"}s.headers=t;e.request(s,function(e){n.resolve(e)},function(e){if(e.response&&e.response.statusCode===200&&e.response.body){n.resolve(e.response.body)}else{n.reject(e);i.error("Notification service - oData executeAction failed: ",e,"sap.ushell.services.Notifications")}});return n.promise()};this.getNotificationsGroupHeaders=function(){var t={"Accept-Language":sap.ui.getCore().getConfiguration().getLanguageTag()},s,n=new jQuery.Deferred,o=this._getRequestURI(B.NOTIFICATIONS_GROUP_HEADERS);s={requestUri:o};if(!this._getHeaderXcsrfToken()){t["X-CSRF-Token"]="fetch"}s.headers=t;e.request(s,function(e){n.resolve(e)},function(e){if(e.response&&e.response.statusCode===200&&e.response.body){n.resolve(e.response.body)}else{n.reject();i.error("Notification service - oData executeAction failed: ",e,"sap.ushell.services.Notifications")}});return n.promise()};this.getNotificationsBufferInGroup=function(t,s,n){var o=this,r={"Accept-Language":sap.ui.getCore().getConfiguration().getLanguageTag()},a,c=new jQuery.Deferred,u={group:t,skip:s,top:n},f,d,l=this._getRequestURI(B.NOTIFICATIONS_IN_GROUP,u);if(j===true){f=W[B.NOTIFICATIONS_IN_GROUP].slice(s,s+n);d=JSON.stringify({"@odata.context":"$metadata#Notifications",value:f});setTimeout(function(){c.resolve(d)},1e3)}else{a={requestUri:l};if(!this._getHeaderXcsrfToken()){r["X-CSRF-Token"]="fetch"}a.headers=r;e.request(a,function(e){o._updateCSRF(e.response);c.resolve(e.value)},function(e){if(e.response&&e.response.statusCode===200&&e.response.body){o._updateCSRF(e.response);c.resolve(JSON.parse(e.response.body).value)}else{c.reject();i.error("Notification service - oData executeAction failed: ",e,"sap.ushell.services.Notifications")}})}return c.promise()};this.getNotificationsBufferBySortingType=function(t,s,n){var o=this,r={"Accept-Language":sap.ui.getCore().getConfiguration().getLanguageTag()},a,c=new jQuery.Deferred,u={skip:s,top:n},f,d,l=this._getRequestURI(t,u);if(j===true){f=W[t].slice(s,s+n);d=JSON.stringify({"@odata.context":"$metadata#Notifications",value:f});setTimeout(function(){c.resolve(d)},1e3)}else{a={requestUri:l};if(!this._getHeaderXcsrfToken()){r["X-CSRF-Token"]="fetch"}a.headers=r;e.request(a,function(e){o._updateCSRF(e.response);c.resolve(e.value)},function(e){if(e.response&&e.response.statusCode===200&&e.response.body){o._updateCSRF(e.response);c.resolve(JSON.parse(e.response.body).value)}else{c.reject();i.error("Notification service - oData executeAction failed: ",e,"sap.ushell.services.Notifications")}})}return c.promise()};this.getNotifications=function(){var e,t=new jQuery.Deferred;if(k===R.FIORI_CLIENT||k===R.PACKAGED_APP){e=this._readNotificationsData(false);e.done(function(){t.resolve(f.getProperty("/Notifications"))}).fail(function(){t.reject()})}else{t.resolve(f.getProperty("/Notifications"))}return t.promise()};this.executeBulkAction=function(e,t){var i=new jQuery.Deferred,s=[],n=[],o={succededNotifications:s,failedNotifications:n},r=this;r.sendBulkAction(e,t).done(function(e){e.forEach(function(e,t){var i=e.NotificationId,o=e.Success;if(o){s.push(i)}else{n.push(i)}});if(n.length){i.reject(o)}else{i.resolve(o)}}).fail(function(){i.reject(o)});return i.promise()};this.dismissBulkNotifications=function(e){var t=new jQuery.Deferred,i=this;i.sendBulkDismiss(e).done(function(){t.resolve()}).fail(function(){t.reject()});return t.promise()};this.executeAction=function(t,s){var n=this,o=l.serviceUrl+"/ExecuteAction",r={NotificationId:t,ActionId:s},a={requestUri:o,method:"POST",data:r,headers:{"X-Requested-With":"XMLHttpRequest","Content-Type":"application/json",DataServiceVersion:E,"X-CSRF-Token":D}},c=new jQuery.Deferred;e.request(a,function(e){var t,i={isSucessfull:true,message:""};if(e&&e.response&&e.response.statusCode===200&&e.response.body){t=JSON.parse(e.response.body);i.isSucessfull=t.Success;i.message=t.MessageText}c.resolve(i)},function(e){var o,r={isSucessfull:false,message:""};if(e.response&&e.response.statusCode===200&&e.response.body){o=JSON.parse(e.response.body);r.isSucessfull=o.Success;r.message=o.MessageText;c.resolve(r)}else if(n._csrfTokenInvalid(e)&&x===false){n._invalidCsrfTokenRecovery(c,n.executeAction,[t,s])}else{c.reject(e);i.error("Notification service - oData executeAction failed: ",e,"sap.ushell.services.Notifications")}});return c.promise()};this.sendBulkAction=function(t,s){var n=this,o=l.serviceUrl+"/BulkActionByHeader",r={ParentId:t,ActionId:s},a={requestUri:o,method:"POST",data:r,headers:{"X-Requested-With":"XMLHttpRequest","Content-Type":"application/json",DataServiceVersion:E,"X-CSRF-Token":D}},c=new jQuery.Deferred;e.request(a,function(e){var t,i;if(e&&e.response&&e.response.statusCode===200&&e.response.body){t=JSON.parse(e.response.body);i=t.value}c.resolve(i)},function(e){var o,r;if(e.response&&e.response.statusCode===200&&e.response.body){o=JSON.parse(e.response.body);r=o.value;c.resolve(r)}else if(n._csrfTokenInvalid(e)&&x===false){n._invalidCsrfTokenRecovery(c,n.sendBulkAction,[t,s])}else{c.reject();i.error("Notification service - oData executeBulkAction failed: ",e.message,"sap.ushell.services.Notifications")}});return c.promise()};this.sendBulkDismiss=function(t){var s=this,n=l.serviceUrl+"/DismissAll",o={ParentId:t},r={requestUri:n,method:"POST",data:o,headers:{"X-Requested-With":"XMLHttpRequest","Content-Type":"application/json",DataServiceVersion:E,"X-CSRF-Token":D}},a=new jQuery.Deferred;e.request(r,function(){a.resolve()},function(e){if(e.response&&e.response.statusCode===200){a.resolve()}else if(s._csrfTokenInvalid(e)&&x===false){s._invalidCsrfTokenRecovery(a,s.sendBulkDismiss,[t])}else{a.reject();var n=e?e.message:"";i.error("Notification service - oData executeBulkAction failed: ",n,"sap.ushell.services.Notifications")}});return a.promise()};this.markRead=function(t){var s=this,n=l.serviceUrl+"/MarkRead",o={NotificationId:t},r={requestUri:n,method:"POST",data:o,headers:{"X-Requested-With":"XMLHttpRequest","Content-Type":"application/json",DataServiceVersion:E,"X-CSRF-Token":D}},a=new jQuery.Deferred;e.request(r,function(){a.resolve()},function(e){if(s._csrfTokenInvalid(e)&&x===false){s._invalidCsrfTokenRecovery(a,s.markRead,[t])}else{i.error("Notification service - oData reset badge number failed: ",e,"sap.ushell.services.Notifications");a.reject(e)}});return a.promise()};this.dismissNotification=function(t){var s=l.serviceUrl+"/Dismiss",n=this,o={NotificationId:t},r={requestUri:s,method:"POST",data:o,headers:{"X-Requested-With":"XMLHttpRequest","Content-Type":"application/json",DataServiceVersion:E,"X-CSRF-Token":D}},a=new jQuery.Deferred;e.request(r,function(){n._addDismissNotifications(t);a.resolve()},function(e){if(n._csrfTokenInvalid(e)&&x===false){n._invalidCsrfTokenRecovery(a,n.dismissNotification,[t])}else{a.reject(e);i.error("Notification service - oData dismiss notification failed: ",e,"sap.ushell.services.Notifications")}});return a.promise()};this.registerNotificationsUpdateCallback=function(e){_.push(e)};this.registerDependencyNotificationsUpdateCallback=function(e,t){if(t===false){this.bUpdateDependencyInitiatorExists=true}S.push({callback:e,dependent:t})};this.registerNotificationCountUpdateCallback=function(e){T.push(e)};this.notificationsSeen=function(){this._setNotificationsAsSeen()};this.isFirstDataLoaded=function(){return U};this.readSettings=function(){var e;e=this._readSettingsFromServer();return e};this.saveSettingsEntry=function(e){var t=this._writeSettingsEntryToServer(e);return t};this.getUserSettingsFlags=function(){var e=new jQuery.Deferred;if(G===true){e.resolve({highPriorityBannerEnabled:F})}else{H.done(function(){e.resolve({highPriorityBannerEnabled:F})})}return e.promise()};this.setUserSettingsFlags=function(e){F=e.highPriorityBannerEnabled;this._writeUserSettingsFlagsToPersonalization(e)};this._getNotificationSettingsMobileSupport=function(){return L};this._getDismissNotifications=function(){return z};this.filterDismisssedItems=function(e,t){return e.filter(function(e){return!t.some(function(t){return t===e.originalItemId})})};this._addDismissNotifications=function(e){if(z.indexOf(e)===-1){z.push(e)}};this._initializeDismissNotifications=function(){z=[]};this._getNotificationSettingsEmailSupport=function(){return M};this.destroy=function(){b=true;if(h){clearTimeout(h)}else if(N){clearTimeout(N)}else if(v){clearTimeout(v)}if(k===R.WEB_SOCKET&&p){p.close()}sap.ui.getCore().getEventBus().unsubscribe("launchpad","sessionTimeout",this.destroy,this);sap.ui.getCore().getEventBus().unsubscribe("launchpad","setConnectionToServer",this._onSetConnectionToServer,this)};this._readUnseenNotificationsCount=function(t){var s=this,n=new jQuery.Deferred,o=this._getRequestURI(B.GET_BADGE_NUMBER),r={requestUri:o,headers:{"Accept-Language":sap.ui.getCore().getConfiguration().getLanguageTag()}};e.read(r,function(e,t){f.setProperty("/UnseenCount",t.data.GetBadgeNumber.Number);s._setNativeIconBadge(t.data.GetBadgeNumber.Number);n.resolve(t.data.GetBadgeNumber.Number)},function(e){if(e.response&&e.response.statusCode===200&&e.response.body){var t=JSON.parse(e.response.body);f.setProperty("/UnseenCount",t.value);s._setNativeIconBadge(t.value);n.resolve(t.value)}else{i.error("Notification service - oData read unseen notifications count failed: ",e.message,"sap.ushell.services.Notifications");n.reject(e)}});return n.promise()};this.readNotificationsCount=function(){var t=new jQuery.Deferred,s=this._getRequestURI(B.GET_NOTIFICATIONS_COUNT),n={requestUri:s,headers:{"Accept-Language":sap.ui.getCore().getConfiguration().getLanguageTag()}};e.read(n,function(e,i){t.resolve(i.data)},function(e){if(e.response&&e.response.statusCode===200&&e.response.body){var s=JSON.parse(e.response.body);t.resolve(s.value)}else{i.error("Notification service - oData read notifications count failed: ",e.message,"sap.ushell.services.Notifications");t.reject(e)}});return t.promise()};this._getNotificationSettingsAvalability=function(){return w.promise()};this._setNotificationsAsSeen=function(){var t=this,s=new jQuery.Deferred,n=this._getRequestURI(B.RESET_BADGE_NUMBER),o={requestUri:n,method:"POST",headers:{"X-Requested-With":"XMLHttpRequest","Content-Type":"application/json",DataServiceVersion:E,"X-CSRF-Token":D}};if(this._isFioriClientMode()===true||this._isPackagedMode()===true){this._setNativeIconBadge(0)}e.request(o,function(){s.resolve()},function(e){if(t._csrfTokenInvalid(e)&&x===false){t._invalidCsrfTokenRecovery(s,t._setNotificationsAsSeen)}else{i.error("Notification service - oData reset badge number failed: ",e,"sap.ushell.services.Notifications");s.reject(e)}});return s.promise()};this._readNotificationsData=function(e){var t=this,i,s,n,o=new jQuery.Deferred,r=[];i=this._readUnseenNotificationsCount(e);r.push(i);n=this.readNotificationsCount();n.done(function(e){f.setProperty("/NotificationsCount",e)});s=this.getNotificationsBufferBySortingType(B.NOTIFICATIONS_BY_DATE_DESCENDING,0,X);r.push(s);jQuery.when.apply(jQuery,r).then(function(){r[0].done(function(){if(e===true){t._updateNotificationsCountConsumers()}});r[1].done(function(i){f.setProperty("/Notifications",i);t._notificationAlert(i);if(e===true){t._updateNotificationsConsumers();t._updateDependentNotificationsConsumers()}o.resolve()})});return o.promise()};this._getHeaderXcsrfToken=function(){return D};this._getDataServiceVersion=function(){return E};this._getRequestURI=function(e,t){var i,s=encodeURI(this._getConsumedIntents(e));switch(e){case B.NOTIFICATIONS:if(g.getNotifications.basic===undefined){g.getNotifications.basic=l.serviceUrl+"/Notifications?$expand=Actions,NavigationTargetParams&$filter=IsGroupHeader%20eq%20false"}if(this._isIntentBasedConsumption()){if(g.getNotifications.byIntents===undefined){g.getNotifications.byIntents=g.getNotifications.basic.concat("&intents%20eq%20"+s)}return g.getNotifications.byIntents}return g.getNotifications.basic;case B.NOTIFICATIONS_BY_TYPE:if(g.getNotificationsByType.basic===undefined){g.getNotificationsByType.basic=l.serviceUrl+"/Notifications?$expand=Actions,NavigationTargetParams"}if(this._isIntentBasedConsumption()){if(g.getNotificationsByType.byIntents===undefined){g.getNotificationsByType.byIntents=g.getNotificationsByType.basic.concat("&$filter=intents%20eq%20"+s)}return g.getNotificationsByType.byIntents}return g.getNotificationsByType.basic;case B.NOTIFICATIONS_GROUP_HEADERS:if(g.getNotificationsGroupHeaders.basic===undefined){g.getNotificationsGroupHeaders.basic=l.serviceUrl+"/Notifications?$expand=Actions,NavigationTargetParams&$filter=IsGroupHeader%20eq%20true"}if(this._isIntentBasedConsumption()){if(g.getNotificationsGroupHeaders.byIntents===undefined){g.getNotificationsGroupHeaders.byIntents=g.getNotificationsGroupHeaders.basic.concat("&intents%20eq%20"+s)}return g.getNotificationsGroupHeaders.byIntents}return g.getNotificationsGroupHeaders.basic;case B.NOTIFICATIONS_IN_GROUP:i=l.serviceUrl+"/Notifications?$expand=Actions,NavigationTargetParams&$orderby=CreatedAt desc&$filter=IsGroupHeader eq false and ParentId eq "+t.group+"&$skip="+t.skip+"&$top="+t.top;if(this._isIntentBasedConsumption()===true){i=i.concat("&intents%20eq%20"+s)}break;case B.GET_BADGE_NUMBER:if(g.getBadgeNumber.basic===undefined){g.getBadgeNumber.basic=l.serviceUrl+"/GetBadgeNumber()"}if(this._isIntentBasedConsumption()){if(g.getBadgeNumber.byIntents===undefined){g.getBadgeNumber.byIntents=l.serviceUrl+"/GetBadgeCountByIntent("+s+")"}return g.getBadgeNumber.byIntents}return g.getBadgeNumber.basic;case B.GET_NOTIFICATIONS_COUNT:if(g.getNotificationCount.basic===undefined){g.getNotificationCount.basic=l.serviceUrl+"/Notifications/$count"}return g.getNotificationCount.basic;case B.RESET_BADGE_NUMBER:if(g.resetBadgeNumber.basic===undefined){g.resetBadgeNumber.basic=l.serviceUrl+"/ResetBadgeNumber"}return g.resetBadgeNumber.basic;case B.GET_SETTINGS:if(g.getNotificationTypesSettings.basic===undefined){g.getNotificationTypesSettings.basic=l.serviceUrl+"/NotificationTypePersonalizationSet"}return g.getNotificationTypesSettings.basic;case B.GET_MOBILE_SUPPORT_SETTINGS:if(g.getMobileSupportSettings.basic===undefined){g.getMobileSupportSettings.basic=l.serviceUrl+"/Channels(ChannelId='SAP_SMP')"}return g.getMobileSupportSettings.basic;case B.GET_EMAIL_SUPPORT_SETTINGS:if(g.getEmailSupportSettings.basic===undefined){g.getEmailSupportSettings.basic=l.serviceUrl+"/Channels(ChannelId='SAP_EMAIL')"}return g.getEmailSupportSettings.basic;case B.VALIDATE_WEBSOCKET_CHANNEL:if(g.getWebSocketValidity.basic===undefined){g.getWebSocketValidity.basic=l.serviceUrl+"/Channels('SAP_WEBSOCKET')"}return g.getWebSocketValidity.basic;case B.NOTIFICATIONS_BY_DATE_DESCENDING:i=l.serviceUrl+"/Notifications?$expand=Actions,NavigationTargetParams&$orderby=CreatedAt%20desc&$filter=IsGroupHeader%20eq%20false&$skip="+t.skip+"&$top="+t.top;if(this._isIntentBasedConsumption()===true){i=i.concat("&intents%20eq%20"+s)}break;case B.NOTIFICATIONS_BY_DATE_ASCENDING:i=l.serviceUrl+"/Notifications?$expand=Actions,NavigationTargetParams&$orderby=CreatedAt%20asc&$filter=IsGroupHeader%20eq%20false&$skip="+t.skip+"&$top="+t.top;if(this._isIntentBasedConsumption()===true){i=i.concat("&intents%20eq%20"+s)}break;case B.NOTIFICATIONS_BY_PRIORITY_DESCENDING:i=l.serviceUrl+"/Notifications?$expand=Actions,NavigationTargetParams&$orderby=Priority%20desc&$filter=IsGroupHeader%20eq%20false&$skip="+t.skip+"&$top="+t.top;if(this._isIntentBasedConsumption()===true){i=i.concat("&intents%20eq%20"+s)}break;default:i=""}return i};this._readSettingsFromServer=function(){var t=this._getRequestURI(B.GET_SETTINGS),s={requestUri:t,headers:{"Accept-Language":sap.ui.getCore().getConfiguration().getLanguageTag()}},n=new jQuery.Deferred;e.request(s,function(e){n.resolve(e.results)},function(e){if(e.response&&e.response.statusCode===200&&e.response.body){n.resolve(e.response.body)}else{n.reject(e);i.error("Notification service - oData get settings failed: ",e,"sap.ushell.services.Notifications")}});return n.promise()};this._readMobileSettingsFromServer=function(){return this._readChannelSettingsFromServer(B.GET_MOBILE_SUPPORT_SETTINGS)};this._readEmailSettingsFromServer=function(){return this._readChannelSettingsFromServer(B.GET_EMAIL_SUPPORT_SETTINGS)};this._readChannelSettingsFromServer=function(t){var s=this._getRequestURI(t),n={requestUri:s,headers:{"Accept-Language":sap.ui.getCore().getConfiguration().getLanguageTag()}},o=new jQuery.Deferred,r,a;e.request(n,function(e){if(typeof e.results==="string"){r=JSON.parse(e.results);r.successStatus=true;a=JSON.stringify(r);o.resolve(a)}else{e.results.successStatus=true;o.resolve(e.results)}},function(e){if(e.response&&e.response.statusCode===200&&e.response.body){r=JSON.parse(e.response.body);r.successStatus=true;a=JSON.stringify(r);o.resolve(a)}else{o.resolve(JSON.stringify({successStatus:false}));i.error("Notification service - oData get settings failed: ",e,"sap.ushell.services.Notifications")}});return o.promise()};this._checkWebSocketActivity=function(){var t=this._getRequestURI(B.VALIDATE_WEBSOCKET_CHANNEL),s={requestUri:t,headers:{"Accept-Language":sap.ui.getCore().getConfiguration().getLanguageTag()}},n=new jQuery.Deferred,o;e.request(s,function(e){if(typeof e.results==="string"){o=JSON.parse(e.results);n.resolve(o.IsActive)}else{n.resolve(false)}},function(e){if(e.response&&e.response.statusCode===200&&e.response.body){o=JSON.parse(e.response.body);n.resolve(o.IsActive)}else{n.resolve(false);i.error("Notification service - oData get settings failed: ",e,"sap.ushell.services.Notifications")}});return n.promise()};this._writeSettingsEntryToServer=function(t){var s=this,n,o=this._getRequestURI(B.GET_SETTINGS)+"(NotificationTypeId="+t.NotificationTypeId+")",r={requestUri:o,method:"PUT",headers:{"X-Requested-With":"XMLHttpRequest","Content-Type":"application/json",DataServiceVersion:E,"X-CSRF-Token":D}};r.data=JSON.parse(JSON.stringify(t));r.data["@odata.context"]="$metadata#NotificationTypePersonalizationSet/$entity";n=new jQuery.Deferred;e.request(r,function(e){n.resolve(e)},function(e){if(e.response&&e.response.statusCode===200&&e.response.body){n.resolve(e.response.body)}else if(s._csrfTokenInvalid(e)&&x===false){s._invalidCsrfTokenRecovery(n,s._writeSettingsEntryToServer,[t])}else{n.reject(e);i.error("Notification service - oData set settings entry failed: ",e,"sap.ushell.services.Notifications")}});return n.promise()};this._updateNotificationsConsumers=function(){_.forEach(function(e){e()})};this._updateDependentNotificationsConsumers=function(){var e=this,t=new jQuery.Deferred;S.forEach(function(i){if(e.bUpdateDependencyInitiatorExists===false){i.callback()}else if(i.dependent===true){i.callback(t.promise())}else{i.callback(t)}})};this._updateNotificationsCountConsumers=function(){T.forEach(function(e){e()})};this._updateAllConsumers=function(){this._updateNotificationsConsumers();this._updateNotificationsCountConsumers();this._updateDependentNotificationsConsumers()};this._getModel=function(){return f};this._getMode=function(){return k};this._setWorkingMode=function(){var e;if(l.intentBasedConsumption===true){I=this._getIntentsFromConfiguration(l.consumedIntents);if(I.length>0){C=true}}if(this._isPackagedMode()){k=R.PACKAGED_APP;e=this._getIntentsFromConfiguration(window.fiori_client_appConfig.applications);if(e.length>0){I=e}if(I.length>0){C=true}this._registerForPush();this._readNotificationsData(true);this._setNativeIconBadgeWithDelay();return}this._performFirstRead()};this._performFirstRead=function(){var e=this,t,s=this._readNotificationsData(true);s.done(function(){t=e._getFioriClientRemainingDelay();if(t<=0){e._fioriClientStep()}else{h=setTimeout(function(){e._fioriClientStep()},t)}U=true}).fail(function(e){i.error("Notifications oData read failed. Error: "+e);return})};this._fioriClientStep=function(){var e=this,t;if(this._isFioriClientMode()){k=R.FIORI_CLIENT;this._addPushNotificationHandler();t=this.getUnseenNotificationsCount();t.done(function(t){e._setNativeIconBadge(t,function(){})}).fail(function(){})}else{this._webSocketStep()}};this._webSocketStep=function(){k=R.WEB_SOCKET;this._establishWebSocketConnection()};this._webSocketRecoveryStep=function(){if(O===false){O=true;N=setTimeout(function(){this._webSocketStep()}.bind(this),A)}else{this._activatePollingAfterInterval()}};this._activatePollingAfterInterval=function(){var e=l.pollingIntervalInSeconds||r;clearTimeout(v);v=setTimeout(this._activatePolling.bind(this),n.sanitizeTimeoutDelay(e*1e3))};this._activatePolling=function(){var e=l.pollingIntervalInSeconds||r;k=R.POLLING;this._readNotificationsData(true);clearTimeout(v);v=setTimeout(this._activatePolling.bind(this,e,false),n.sanitizeTimeoutDelay(e*1e3))};this._formatAsDate=function(e){return new Date(e)};this._notificationAlert=function(e){if(F===false){return}var t,i=[],s=0;for(t in e){if(this.lastNotificationDate&&this._formatAsDate(e[t].CreatedAt)>this.lastNotificationDate){if(e[t].Priority==="HIGH"){i.push(e[t])}}if(s<this._formatAsDate(e[t].CreatedAt)){s=this._formatAsDate(e[t].CreatedAt)}}if(this.lastNotificationDate&&i&&i.length>0){sap.ui.getCore().getEventBus().publish("sap.ushell.services.Notifications","onNewNotifications",i)}this.lastNotificationDate=s};this._getFioriClientRemainingDelay=function(){return P-(new Date-d)};this._establishWebSocketConnection=function(){var e=this,s=false,n;try{p=this._getWebSocketObjectObject(l.webSocketUrl||o,[t.SUPPORTED_PROTOCOLS.v10]);p.attachMessage(this,function(t){n=t.getParameter("pcpFields");if(n&&n.Command&&n.Command==="Notification"){e._readNotificationsData(true)}});p.attachOpen(this,function(){e._checkWebSocketActivity().done(function(t){if(!t){s=true;p.close();e._activatePollingAfterInterval()}});i.info("Notifications UShell service WebSocket: webSocket connection opened")});p.attachClose(this,function(t){i.warning("Notifications UShell service WebSocket: attachClose called with code: "+t.mParameters.code+" and reason: "+t.mParameters.reason);if(!b&&!s){e._webSocketRecoveryStep()}});p.attachError(this,function(){i.warning("Notifications UShell service WebSocket: attachError called!")})}catch(e){i.error("Exception occurred while creating new sap.ui.core.ws.SapPcpWebSocket. Message: "+e.message)}};this._isFioriClientMode=function(){return!(sap.FioriClient===undefined)};this._isPackagedMode=function(){return window.fiori_client_appConfig&&window.fiori_client_appConfig.prepackaged===true};this._setNativeIconBadge=function(e){if(sap.Push!==undefined&&sap.Push.setBadgeNumber!==undefined){sap.Push.setBadgeNumber(e,function(){})}};this._setNativeIconBadgeWithDelay=function(){var e=this,t;setTimeout(function(){t=e.getUnseenNotificationsCount();t.done(function(t){e._setNativeIconBadge(t)}).fail(function(){})},4e3)};this._getIntentsFromConfiguration=function(e){var t=[],i,s;if(e&&e.length>0){for(s=0;s<e.length;s++){i=e[s].intent;t.push(i)}}return t};this._handlePushedNotification=function(e){var t,i,s,o,r=[],a;if(e!==undefined){if(e.additionalData===undefined||e.additionalData.foreground===true){this._readNotificationsData(true)}else{if(e.additionalData&&e.additionalData.NavigationTargetObject){i=e.additionalData.NavigationTargetObject}else{i=e.NavigationTargetObject}if(e.additionalData&&e.additionalData.NavigationTargetAction){s=e.additionalData.NavigationTargetAction}else{s=e.NavigationTargetAction}if(e.additionalData&&e.additionalData.NavigationTargetParam){o=e.additionalData.NavigationTargetParam}else{o=e.NavigationTargetParam}if(o){if(typeof o==="string"||o instanceof String){r[0]=o}else if(Array.isArray(o)===true){r=o}}t=e.NotificationId;if(typeof hasher!=="undefined"&&hasher.getHash()===i+"-"+s){a=sap.ui.getCore().byId("viewPortContainer");if(a){a.switchState("Center")}}n.toExternalWithParameters(i,s,r);this.markRead(t);this._readNotificationsData(true)}}};this._registerForPush=function(){sap.Push.initPush(this._handlePushedNotification.bind(this))};this._addPushNotificationHandler=function(){document.addEventListener("deviceready",this._registerForPush.bind(this),false)};this._isIntentBasedConsumption=function(){return C};this._getConsumedIntents=function(e){var t="",i;if(!this._isIntentBasedConsumption()){return t}if(I.length>0){if(e!==B.GET_BADGE_NUMBER){t="&"}for(i=0;i<I.length;i++){if(e===B.GET_BADGE_NUMBER){if(i===0){t=I[i]}else{t=t+","+I[i]}}else{t=t+"NavigationIntent%20eq%20%27"+I[i]+"%27"}}}return t};this._revalidateCsrfToken=function(){var e;D=undefined;$=false;e=this.getNotificationsBufferBySortingType(B.NOTIFICATIONS_BY_DATE_DESCENDING,0,1);return e.promise()};this._csrfTokenInvalid=function(e){var t=e.response;var i=t&&t.statusCode===403;var s=t?t.headers["x-csrf-token"]:"";var n=s.toLowerCase()==="required";return i&&n};this._invalidCsrfTokenRecovery=function(e,t,s){var n=this,o=this._revalidateCsrfToken(),r;x=true;o.done(function(){r=t.apply(n,s);r.done(function(t){x=false;e.resolve(t)});r.fail(function(t){x=false;if(t.response&&t.response.statusCode===200&&t.response.body){e.resolve(t.response.body)}else{e.reject(t)}})});o.fail(function(t){x=false;e.reject(t);i.error("Notification service - oData markRead failed: ",t.message,"sap.ushell.services.Notifications")})};this._notificationsAscendingSortBy=function(e,t){e.sort(function(e,i){var s=e[t],n=i[t];if(s===n){s=e.id;n=i.id}return n>s?-1:1});return e};this._getWebSocketObjectObject=function(e,i){return new t(e,i)};this.getOperationEnum=function(){return B};this._readUserSettingsFlagsFromPersonalization=function(){this._getUserSettingsPersonalizer().then(function(e){e.getPersData().done(function(e){if(e===undefined){this._writeUserSettingsFlagsToPersonalization({highPriorityBannerEnabled:F})}else{F=e.highPriorityBannerEnabled}G=true;q.resolve()}.bind(this)).fail(function(){i.error("Reading User Settings flags from Personalization service failed")})}.bind(this)).catch(function(e){i.error("Personalization service does not work:");i.error(e.name+": "+e.message);i.error("Reading User Settings flags from Personalization service failed")})};this._writeUserSettingsFlagsToPersonalization=function(e){var t=new jQuery.Deferred;this._getUserSettingsPersonalizer().then(function(i){i.setPersData(e).done(t.resolve).fail(t.reject)}).catch(function(e){i.error("Personalization service does not work:");i.error(e.name+": "+e.message);t.reject(e)});return t.promise()};this._getUserSettingsPersonalizer=function(){if(!this.oUserSettingsPersonalizerPromise){this.oUserSettingsPersonalizerPromise=sap.ushell.Container.getServiceAsync("Personalization").then(function(e){var t={keyCategory:e.constants.keyCategory.FIXED_KEY,writeFrequency:e.constants.writeFrequency.LOW,clientStorageAllowed:true};var i={container:"sap.ushell.services.Notifications",item:"userSettingsData"};return e.getPersonalizer(i,t)})}return this.oUserSettingsPersonalizerPromise};this._updateCSRF=function(e){if($===true||e.headers===undefined){return}if(!this._getHeaderXcsrfToken()){D=e.headers["x-csrf-token"]||e.headers["X-CSRF-Token"]||e.headers["X-Csrf-Token"]}if(!this._getDataServiceVersion()){E=e.headers.DataServiceVersion||e.headers["odata-version"]}$=true};this._userSettingInitialization=function(){var e,t,i,s={settingsAvailable:false,mobileAvailable:false,emailAvailable:false},n,o,r,a;this._readUserSettingsFlagsFromPersonalization();e=this._readSettingsFromServer();t=this._readMobileSettingsFromServer();i=this._readEmailSettingsFromServer();n=[e,t,i];e.done(function(){s.settingsAvailable=true});t.done(function(e){o=JSON.parse(e);r=o.successStatus;if(r){L=e?o.IsActive:false;s.mobileAvailable=L}else{L=false;s.mobileAvailable=false}});i.done(function(e){o=JSON.parse(e);a=o.successStatus;if(a){M=e?o.IsActive:false;s.emailAvailable=M}else{M=false;s.emailAvailable=false}});jQuery.when.apply(jQuery,n).then(function(){w.resolve(s)})};this._closeConnection=function(){if(!b){if(k===R.WEB_SOCKET&&p){p.close();b=true}if(k===R.POLLING&&v){clearTimeout(v);b=true}}};this._resumeConnection=function(){if(b){b=false;this._webSocketStep()}}}a.hasNoAdapter=true;return a},true);
//# sourceMappingURL=Notifications.js.map