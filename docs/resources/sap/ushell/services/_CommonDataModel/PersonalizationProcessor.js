// Copyright (c) 2009-2022 SAP SE, All Rights Reserved
sap.ui.define(["sap/ui/thirdparty/jquery","sap/base/util/isEmptyObject","sap/base/Log","sap/base/util/ObjectPath","sap/base/util/deepClone"],function(jQuery,e,r,i,o){"use strict";function t(){}t.prototype._getItemIndex=function(e,r){var i;for(i=0;i<e.length;i++){if(e[i].id===r){break}}i=i>=e.length?-1:i;return i};t.prototype._applyRenameGroup=function(e,r,i){var o,t=false;if(!r){return false}if(e&&i&&i.groups&&i.groups[e]){o=i.groups[e];if(o.identification&&o.identification.title){i.groups[e].identification.title=r;t=true}}return t};t.prototype._applyGroupVisibility=function(e,r,i){var o=false;if(r===undefined){return false}if(e&&i&&i.groups&&i.groups[e]){i.groups[e].identification.isVisible=r;o=true}return o};t.prototype.mixinPersonalization=function(r,i){var o=new jQuery.Deferred,t=this;if(!i||e(i)){return o.resolve(r).promise()}if(i.groups){Object.keys(i.groups).forEach(function(e){var o=i.groups[e];if(r.groups[e]){if(o.identification){if(o.identification.title){t._applyRenameGroup(e,o.identification.title,r)}if(o.identification.hasOwnProperty("isVisible")&&o.identification.isVisible===false){t._applyGroupVisibility(e,false,r)}}}})}this._applyAddGroups(r,i);if(i.removedGroups&&Array.isArray(i.removedGroups)){i.removedGroups.forEach(function(e){t._applyRemoveGroup(r,e)})}this._applyMoveGroup(r,i);this._applyItemChanges(r,i);this._applyTileSettings(r,i);return o.resolve(r).promise()};t.prototype._applyAddGroups=function(e,r){var i=[];e.site=e.site||{};e.site.payload=e.site.payload||{};e.site.payload.groupsOrder=e.site.payload.groupsOrder||[];e.groups=e.groups||{};if(Array.isArray(r.groupOrder)){e.site.payload.groupsOrder.forEach(function(e){if(r.groupOrder.indexOf(e)===-1){if(r.removedGroups&&r.removedGroups.indexOf(e)===-1||!r.removedGroups){i.push(e)}}})}if(Array.isArray(r.groupOrder)&&r.addedGroups&&Object.keys(r.addedGroups).length>0){Object.keys(r.addedGroups).forEach(function(i){e.groups[i]=o(r.addedGroups[i],20);e.groups[i].payload.isPreset=false});e.site.payload.groupsOrder=r.groupOrder}i.forEach(function(r){e.site.payload.groupsOrder.push(r)})};t.prototype._checkRenameGroup=function(e,r,i,o){if(e&&r&&i){if(i[e]){if(r[e].identification.title!==i[e].identification.title){o=o||{};o.groups=o.groups||{};o.groups[e]=o.groups[e]||{};o.groups[e].identification=o.groups[e].identification||{};o.groups[e].identification.title=r[e].identification.title}}}return o};t.prototype._applyTileSettings=function(e,r){var i,o;if(!r.modifiedTiles){return}i=Object.keys(e.groups).map(function(e){return this[e]},e.groups);o=Object.keys(r.modifiedTiles).map(function(e){return this[e]},r.modifiedTiles);i.some(function(e){["tiles","links"].forEach(function(r){if(e.payload[r]){e.payload[r].some(function(e){var r;o.some(function(i,o){if(i.id===e.id){if(i.title!==undefined){e.title=i.title}if(i.subTitle!==undefined){e.subTitle=i.subTitle}if(i.info!==undefined){e.info=i.info}if(i.displayFormatHint!==undefined){e.displayFormatHint=i.displayFormatHint}r=o;return true}return false});if(r!==undefined){o.splice(r,1)}return o.length===0})}});return o.length===0})};t.prototype._checkGroupVisibility=function(e,r,i,o){if(e&&r&&i){if(i[e]){if(r[e].identification.isVisible!==i[e].identification.isVisible&&typeof r[e].identification.isVisible==="boolean"){o=o||{};o.groups=o.groups||{};o.groups[e]=o.groups[e]||{};o.groups[e].identification=o.groups[e].identification||{};o.groups[e].identification.isVisible=r[e].identification.isVisible}}}return o};t.prototype._addGroupToPersonalizationDelta=function(e,r,i){var o=false,t,a;if(e&&e.site&&e.site.payload&&e.site.payload.groupsOrder&&e.groups&&i&&e.groups[i]&&r){t=e.site.payload.groupsOrder;a=e.groups[i];r.addedGroups=r.addedGroups||{};r.addedGroups[i]={};r.addedGroups[i].identification=jQuery.extend({},a.identification);r.addedGroups[i].payload=jQuery.extend({},a.payload);r.addedGroups[i].payload.tiles=[];r.addedGroups[i].payload.links=[];r.groupOrder=t;o=true}return o};t.prototype.extractPersonalization=function(r,i){var o=new jQuery.Deferred,t,a={},s,p,n=this;if(r&&r.groups&&i&&i.groups){t=r.groups;s=i.groups;p=this._getExtractHelperObject(i,r,a);Object.keys(s).forEach(function(e){n._checkRemoveGroup(r,a,e);n._extractFromOriginalSiteOneGroup(i,p,e,"tiles");n._extractFromOriginalSiteOneGroup(i,p,e,"links")});Object.keys(t).forEach(function(e){if(s[e]){n._checkRenameGroup(e,t,s,a);n._checkGroupVisibility(e,t,s,a)}else{n._addGroupToPersonalizationDelta(r,a,e)}n._extractFromPersonalizedSiteOneGroup(r,p,e,"tiles");n._extractFromPersonalizedSiteOneGroup(r,p,e,"links")});this._checkMoveGroup(r,i,a);this._cleanupRemovedGroups(i,a);if(p.oPersonalizationDelta.movedTiles&&e(p.oPersonalizationDelta.movedTiles)){delete p.oPersonalizationDelta.movedTiles}if(p.oPersonalizationDelta.movedLinks&&e(p.oPersonalizationDelta.movedLinks)){delete p.oPersonalizationDelta.movedLinks}}if(i._version){a._version=i._version}return o.resolve(a).promise()};t.prototype._checkRemoveGroup=function(e,r,i){var o=false;if(e&&e.groups&&r&&i){if(!e.groups[i]){r.removedGroups=r.removedGroups||[];r.groupOrder=r.groupOrder||[];if(r.removedGroups.indexOf(i)===-1){r.removedGroups.push(i)}if(e.site&&e.site.payload&&e.site.payload.groupsOrder&&Array.isArray(e.site.payload.groupsOrder)){r.groupOrder=e.site.payload.groupsOrder.slice(0)}}o=true}return o};t.prototype._applyRemoveGroup=function(e,r){var i,o,t;if(e&&e.groups&&e.site&&e.site.payload&&e.site.payload.groupsOrder&&r){i=e.groups;o=e.site.payload.groupsOrder;t=o.indexOf(r);if(!(t===-1)){o.splice(t,1);delete i[r];return true}}return false};t.prototype._checkMoveGroup=function(e,r,i){var o,t,a=false,s=false;if(e.site&&e.site.payload&&Array.isArray(e.site.payload.groupsOrder)&&r.site&&r.site.payload&&Array.isArray(r.site.payload.groupsOrder)){o=e.site.payload.groupsOrder;t=r.site.payload.groupsOrder;if(o.length===t.length){a=function(){var e=false,r;for(r=0;r<t.length;r++){if(t[r]!==o[r]){e=true;break}}return e}();if(a){i.groupOrder=o;s=true}}}return s};t.prototype._applyMoveGroup=function(e,r){var i=false;if(Array.isArray(r.groupOrder)){e.site=e.site||{};e.site.payload=e.site.payload||{};if(!Array.isArray(e.site.payload.groupsOrder)){e.site.payload.groupsOrder=[]}if(e.site.payload.groupsOrder.length===r.groupOrder.length){e.site.payload.groupsOrder=r.groupOrder;i=true}}return i};t.prototype._getHashedItemsFromSite=function(e){var r=null;if(e&&e.groups){if(Object.keys(e.groups).length>0){r={};Object.keys(e.groups).forEach(function(i){var o=e.groups[i],t;r[i]={};if(o.payload){["tiles","links"].forEach(function(e){r[i][e]={};if(Array.isArray(o.payload[e])){t=o.payload[e];t.forEach(function(o,t){var a;if(o&&o.id){a=o.id;r[i][e][a]={iIndex:t,sItemId:o}}})}})}})}}return r};t.prototype._getExtractHelperObject=function(e,r,i){var o=null;o={};o.oHashedItemsOriginal=this._getHashedItemsFromSite(e)||{};o.oHashedItemsPersonalized=this._getHashedItemsFromSite(r);o.oPersonalizationDelta=i;return o};t.prototype._extractFromOriginalSiteOneGroup=function(e,r,i,o){var t=false,a,s,p,n="movedTiles";o=o||"tiles";if(o!=="tiles"){n="movedLinks"}p=function(e,r){s[e]=s[e]?s[e]:{};s[e].fromGroup=r;s[e].toGroup=null};if(r&&r.oHashedItemsPersonalized&&r.oPersonalizationDelta&&e&&e.groups&&e.groups[i]&&e.groups[i].payload&&Array.isArray(e.groups[i].payload[o])){a=e.groups[i].payload[o];r.oPersonalizationDelta[n]=r.oPersonalizationDelta[n]?r.oPersonalizationDelta[n]:{};s=r.oPersonalizationDelta[n];if(r.oHashedItemsPersonalized[i]){a.forEach(function(e){if(!r.oHashedItemsPersonalized[i][o][e.id]){p(e.id,i)}});t=true}else{a.forEach(function(e){p(e.id,i)});t=true}}return t};t.prototype._extractPersonalizationDeltaForTile=function(r,o,t,a){var s=i.get(["oHashedItemsOriginal",t,a,r.id,"sItemId"],o);if(!s){return false}var p={};if(r.title!==s.title){p.title=r.title}if(r.subTitle!==s.subTitle){p.subTitle=r.subTitle}if(r.info!==s.info){p.info=r.info}if(r.displayFormatHint!==s.displayFormatHint&&!(r.displayFormatHint==="default"&&!s.displayFormatHint)){p.displayFormatHint=r.displayFormatHint}if(e(p)){return false}if(!o.oPersonalizationDelta.modifiedTiles){o.oPersonalizationDelta.modifiedTiles={}}var n=o.oPersonalizationDelta.modifiedTiles;p.id=r.id;n[r.id]=p;return true};t.prototype._extractFromPersonalizedSiteOneGroup=function(e,i,o,t){var a=false,s,p,n=false,l,u=this,d="movedTiles";t=t||"tiles";if(t!=="tiles"&&t!=="links"){return a}if(t!=="tiles"){d="movedLinks"}if(i&&i.oPersonalizationDelta&&e&&e.groups&&e.groups[o]&&e.groups[o].payload&&Array.isArray(e.groups[o].payload[t])){l=e.groups[o].payload[t];i.oPersonalizationDelta[d]=i.oPersonalizationDelta[d]?i.oPersonalizationDelta[d]:{};s=i.oPersonalizationDelta[d];p=[];l.forEach(function(e,a){if(!e){return}p.push(e.id);if(i.oHashedItemsOriginal[o]&&i.oHashedItemsOriginal[o][t][e.id]){if(s[e.id]){r.error("Extract personalization failed","The Tile ID "+e.id+" is not unique in the site","PersonalizationProcessor");delete s[e.id]}if(i.oHashedItemsOriginal[o][t][e.id].iIndex!==a){n=true}u._extractPersonalizationDeltaForTile(e,i,o,t)}else{n=true;if(s[e.id]){if(s[e.id].fromGroup&&s[e.id].fromGroup!==o){if(!s[e.id].toGroup){s[e.id].toGroup=o;u._extractPersonalizationDeltaForTile(e,i,s[e.id].fromGroup,t)}}}else{s[e.id]={};s[e.id].fromGroup=null;s[e.id].toGroup=o;s[e.id].item=e}}});if(n){i.oPersonalizationDelta.groups=i.oPersonalizationDelta.groups||{};i.oPersonalizationDelta.groups[o]=i.oPersonalizationDelta.groups[o]||{};i.oPersonalizationDelta.groups[o].payload=i.oPersonalizationDelta.groups[o].payload||{};if(t==="tiles"){i.oPersonalizationDelta.groups[o].payload.tileOrder=p}else{i.oPersonalizationDelta.groups[o].payload.linkOrder=p}}a=true}return a};t.prototype._cleanupRemovedGroups=function(e,r){var i,o;if(r.removedGroups&&r&&Array.isArray(r.removedGroups)&&r.removedGroups.length>0){r.removedGroups.forEach(function(t){if(e&&e.groups&&e.groups[t]&&e.groups[t].payload){[{sType:"tiles",sPersonalizationDeltaType:"movedTiles"},{sType:"links",sPersonalizationDeltaType:"movedLinks"}].forEach(function(a){if(Array.isArray(e.groups[t].payload[a.sType])){i=e.groups[t].payload[a.sType];i.forEach(function(e){if(r[a.sPersonalizationDeltaType]){o=r[a.sPersonalizationDeltaType][e.id];if(o&&o.fromGroup&&o.fromGroup===t&&!o.toGroup){delete r[a.sPersonalizationDeltaType][e.id]}}})}})}})}};t.prototype._setItemOrderOnSiteCollection=function(e,r){var i=true,o=e.length,t,a={},s,p,n,l;if(!Array.isArray(e)||!Array.isArray(e)||e.length!==r.length){return false}t=e.splice(0,e.length);for(s=0;s<r.length;s++){n=r[s];p=t.shift();if(p&&n===p.id){e.push(p)}else if(a[n]){e.push(a[n]);delete a[n];if(p){a[p.id]=p}}else if(p){a[p.id]=p;l=false;while(t.length>0){p=t.shift();if(n===p.id){e.push(p);l=true;break}else{a[p.id]=p}}if(!l){i=false}}}if(e.length!==o){i=false}return i};t.prototype._setItemOrderOnSiteGroupForItemType=function(e,r,i){var o=true,t,a;if(i==="tiles"||i==="links"){a=i==="tiles"?"tileOrder":"linkOrder"}else{return false}if(r.payload&&Array.isArray(r.payload[a])&&r.payload[a].length>0){if(e.payload&&Array.isArray(e.payload[i])&&e.payload[i].length>0){t=this._setItemOrderOnSiteCollection(e.payload[i],r.payload[a]);if(!t){o=false}}else{o=false}}return o};t.prototype._setItemOrderOnSite=function(e,r){var i=true,o,t=this;if(e.groups&&r.groups){Object.keys(r.groups).forEach(function(a){if(r.groups[a]&&e.groups[a]){o=t._setItemOrderOnSiteGroupForItemType(e.groups[a],r.groups[a],"tiles");if(!o){i=false}o=t._setItemOrderOnSiteGroupForItemType(e.groups[a],r.groups[a],"links");if(!o){i=false}}})}return i};t.prototype._applyMoveItemsWithoutOrder=function(r,i,o){var t=true,a,s,p="tileOrder",n,l,u,d=[],f=this;function y(e,t){var a=true;if(r.groups[t]&&r.groups[t].payload&&i.groups&&i.groups[t]&&i.groups[t].payload&&Array.isArray(i.groups[t].payload[p])&&i.groups[t].payload[p].length>0){if(!Array.isArray(r.groups[t].payload[o])){r.groups[t].payload[o]=[]}r.groups[t].payload[o].push(e)}else{a=false}return a}if(o==="tiles"||o==="links"){s=o==="tiles"?"movedTiles":"movedLinks";p=o==="tiles"?"tileOrder":"linkOrder"}else{return false}if(!r||!r.groups||!r.site||!r.site.payload||!Array.isArray(r.site.payload.groupsOrder)||!i){return false}if(i[s]){Object.keys(i[s]).forEach(function(p){n=i[s][p];if(n.fromGroup){if(n.toGroup){if(n.fromGroup!==n.toGroup){if(r.groups[n.fromGroup]&&r.groups[n.fromGroup].payload&&Array.isArray(r.groups[n.fromGroup].payload[o])){d=r.groups[n.fromGroup].payload[o];l=f._getItemIndex(d,p);if(l>=0){u=d.splice(l,1);a=y(u[0],n.toGroup);if(!a){t=false}}else{t=false}}else{t=false}}else{t=false}}else if(r.groups[n.fromGroup]&&r.groups[n.fromGroup].payload&&Array.isArray(r.groups[n.fromGroup].payload[o])){d=r.groups[n.fromGroup].payload[o];l=f._getItemIndex(d,p);if(l>=0){d.splice(l,1)}else{t=false}}else{t=false}}else if(n.toGroup){if(n.item&&!e(n.item)){a=y(n.item,n.toGroup);if(!a){t=false}}else{t=false}}else{t=false}})}return t};t.prototype._applyItemChanges=function(e,r){var i=true,o;o=this._applyMoveItemsWithoutOrder(e,r,"tiles");if(!o){i=false}o=this._applyMoveItemsWithoutOrder(e,r,"links");if(!o){i=false}if(r.groups){o=this._setItemOrderOnSite(e,r);if(!o){i=false}}return i};return t});
//# sourceMappingURL=PersonalizationProcessor.js.map