// Copyright (c) 2009-2022 SAP SE, All Rights Reserved
sap.ui.define(["sap/ushell/services/_PluginManager/Extensions","sap/base/Log","sap/ui/thirdparty/jquery","sap/base/util/UriParameters","sap/ushell/utils","sap/ushell/components/applicationIntegration/application/PostMessageAPIInterface","sap/ushell/UI5ComponentType"],function(e,n,jQuery,i,t,o,r){"use strict";var a="sap.ushell.services.PluginManager";var s="sap-ushell-plugin-type";var l="RendererExtensions";var u="sap.ushell.components.shell.defaults";var g=[l,"EarlyLoading","UserDefaults","UserImage","ContentProvider","AppWarmup"];function f(f,c,p){var d=this;this._oPluginCollection={};this._oCategoryLoadingProgress={};this._mInitializedComponentPromise={};this._sPluginAgentsNames="";this._oConfig=p&&p.config||{};if(this._oConfig.isBlueBox===undefined){this._oConfig.isBlueBox=false}g.forEach(function(e){d._oPluginCollection[e]={};d._oCategoryLoadingProgress[e]=new jQuery.Deferred});this._handlePluginCreation=function(e,i,o,r){var s=this,l=s._oPluginCollection[e][i];t.setPerformanceMark("FLP -- PluginManager.loadPlugin["+e+"]["+i+"]");try{if(l.hasOwnProperty("component")){if(s._mInitializedComponentPromise.hasOwnProperty(l.component)){s._mInitializedComponentPromise[l.component].then(function(){s._instantiateComponent(l,o,r)},function(){s._instantiateComponent(l,o,r)})}else{s._mInitializedComponentPromise[l.component]=s._instantiateComponent(l,o,r)}}else{n.error("Invalid plugin configuration. The plugin "+i+" must contain a <component> key",a)}}catch(e){n.error("Error while loading bootstrap plugin: "+l.component||"",a);if(o){o.reject(e)}}};this._getFileNameForXhrAuth=function(){return"Component-preload.js"};this._handleXhrAuthentication=function(e,i){var t;if(e&&["true",true,"X"].indexOf(e["sap-ushell-xhr-authentication"])>-1){if(!i){n.error(["Illegal state: configuration parameter 'sap-ushell-xhr-authentication-timeout' set, but no component URL specified.","XHR authentication request will not be sent. Please check the target mapping definitions for plug-ins","and the application index."].join(" "),undefined,a);return jQuery.when()}if(e.hasOwnProperty("sap-ushell-xhr-authentication-timeout")){t=parseInt(e["sap-ushell-xhr-authentication-timeout"],10);if(isNaN(t)){n.error(["Invalid value for configuration parameter 'sap-ushell-xhr-authentication-timeout' for plug-in component with URL '",i,"': '",e["sap-ushell-xhr-authentication-timeout"],"' is not a number. Timeout will be ignored."].join(""),undefined,a)}else{sap.ushell.Container.setXhrLogonTimeout(i,t)}}return jQuery.ajax(i+"/"+this._getFileNameForXhrAuth(),{dataType:"text"})}return jQuery.when()};this._instantiateComponent=function(i,t,o){var s=new jQuery.Deferred,l=JSON.parse(JSON.stringify(i)),u={ui5ComponentName:l.component,url:l.url,getExtensions:e.bind(null,i.component)};function g(e){return function(i){e=e||"Cannot create UI5 plugin component: (componentId/appdescrId :"+u.ui5ComponentName+")\n"+i+" properties "+JSON.stringify(u)+"\n This indicates a plugin misconfiguration, see e.g. Note 2316443.";i=i||"";n.error(e,i.stack,a);if(t){t.reject.apply(this,arguments)}s.reject.apply(this,arguments)}}l.name=l.component;delete l.component;u.applicationDependencies=l;if(l.config){u.applicationConfiguration=l.config;delete l.config}u.loadDefaultDependencies=false;if(o!==undefined){u.oPostMessageInterface=o}sap.ushell.Container.getServiceAsync("Ui5ComponentLoader").then(function(e){this._handleXhrAuthentication(u.applicationConfiguration,l.url).done(function(){e.createComponent(u,{},[],r.Plugin).done(function(e){if(t){t.resolve(e)}s.resolve.apply(this,arguments)}).fail(g())}).fail(g("XHR logon for FLP plugin failed"))}.bind(this)).catch(g());return s.promise()};this.getSupportedPluginCategories=function(){return JSON.parse(JSON.stringify(g))};this.getRegisteredPlugins=function(){return JSON.parse(JSON.stringify(this._oPluginCollection))};this.registerPlugins=function(e){var t=this,o,r,u,f=[],c,p;if(!e){return}if(this._oConfig.isBlueBox===true){c=new i(window.location.href).get("sap-plugins");if(c&&c.length>0){c=","+c+","}else{c=undefined}}Object.keys(e).sort().forEach(function(i){o=e[i]||{};r=o.config||{};u=r[s]||"";if(o.enabled===false){return}if(!t._isFormFactorSupported(o)){n.info("Plugin '"+i+"' filtered from result: form factor not supported");return}if(t._oConfig.isBlueBox===true){if(o.config&&o.config["sap-plugin-agent"]===true){p=o.config["sap-plugin-agent-id"]||i;if(c){if(c.indexOf(","+p+",")<0){return}}else{return}}}if(o.enabled===undefined){o.enabled=true}if(o.hasOwnProperty("module")){var d=(o.module||"").replace(/\./g,"/");n.error("Plugin "+i+" cannot get registered, because the module mechanism for plugins is not valid anymore. Plugins need to be defined as SAPUI5 components.",a);try{sap.ui.requireSync(d)}catch(e){n.error("Plugin module "+d+" is not found.")}return}if(r&&r.hasOwnProperty(s)){if(g&&Array.prototype.indexOf.call(g,u)!==-1){if(f.indexOf(u)===-1){f.push(u)}t._oPluginCollection[u][i]=JSON.parse(JSON.stringify(o))}else{n.warning("Plugin "+i+" will not be inserted into the plugin collection of the PluginManager, because of unsupported category "+u,a)}}else{t._oPluginCollection[l][i]=JSON.parse(JSON.stringify(o));if(f.indexOf(l)===-1){f.push(l)}}});try{if(t._oConfig.isBlueBox!==true){t._buildNamesOfPluginsWithAgents()}}catch(e){n.error("failed to build plugin agents names list",e.message||e.toString(),"sap.ushell.services.PluginManager")}f.forEach(function(e){if(t._oCategoryLoadingProgress.hasOwnProperty(e)&&t._oCategoryLoadingProgress[e].state()==="resolved"){t.loadPlugins(e)}})};this._isFormFactorSupported=function(e){var n=e.deviceTypes,i=t.getFormFactor();if(n&&n[i]===false){return false}return true};this.getPluginLoadingPromise=function(e){if(this._oCategoryLoadingProgress.hasOwnProperty(e)){return this._oCategoryLoadingProgress[e].promise()}};this.loadPlugins=function(e){var r=this,s,f,c,p;t.setPerformanceMark("FLP -- PluginManager.startLoadPlugins["+e+"]");if(e===l){p=o.getInterface()}if(g&&Array.prototype.indexOf.call(g,e)!==-1){if(r._oCategoryLoadingProgress[e].pluginLoadingTriggered===undefined){r._oCategoryLoadingProgress[e].pluginLoadingTriggered=true}if(Object.keys(r._oPluginCollection[e]).length>0){s=[];c=Object.keys(r._oPluginCollection[e]);if(new i(window.location.href).get("sap-ushell-xx-pluginmode")==="discard"&&(e==="RendererExtensions"||e==="AppWarmup")){c=c.filter(function(n){return r._oPluginCollection[e][n].component===u})}c.forEach(function(n){var i=r._oPluginCollection[e][n];if(!i.loaded){i.loaded=true;f=new jQuery.Deferred;s.push(f.promise());r._handlePluginCreation(e,n,f,p)}});if(s.length>0){jQuery.when.apply(undefined,s).done(function(){t.setPerformanceMark("FLP -- PluginManager.endLoadPlugins["+e+"]");r._oCategoryLoadingProgress[e].resolve()}).fail(r._oCategoryLoadingProgress[e].reject.bind())}}else{r._oCategoryLoadingProgress[e].resolve()}}else{n.error("Plugins with category "+e+" cannot be loaded by the PluginManager",a);r._oCategoryLoadingProgress[e].reject("Plugins with category "+e+" cannot be loaded by the PluginManager")}return r._oCategoryLoadingProgress[e].promise()};this._buildNamesOfPluginsWithAgents=function(){var e=this,n="",i;Object.keys(e._oPluginCollection).forEach(function(t){Object.keys(e._oPluginCollection[t]).forEach(function(o){i=e._oPluginCollection[t][o];if(i&&i.enabled&&i.enabled===true){if(i.config&&i.config["sap-plugin-agent"]===true){n+=(i.config["sap-plugin-agent-id"]||o)+","}}})});if(n.endsWith(",")){n=n.slice(0,-1)}this._sPluginAgentsNames=n};this._getNamesOfPluginsWithAgents=function(){return this._sPluginAgentsNames}}f.hasNoAdapter=true;return f},true);
//# sourceMappingURL=PluginManager.js.map