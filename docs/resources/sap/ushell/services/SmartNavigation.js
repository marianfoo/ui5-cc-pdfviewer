// Copyright (c) 2009-2022 SAP SE, All Rights Reserved
sap.ui.define(["sap/ui/thirdparty/jquery","sap/ushell/utils","sap/ushell/services/AppConfiguration","sap/base/Log","sap/ushell/utils/UrlParsing"],function(jQuery,e,t,n,r){"use strict";function i(e,t,n){this._oServiceConfig=n;this._oCrossAppNavigationServicePromise=sap.ushell.Container.getServiceAsync("CrossApplicationNavigation");this._oPersonalizationServicePromise=sap.ushell.Container.getServiceAsync("Personalization");this._oHashCodeCache={"":0}}i.STATISTIC_COLLECTION_WINDOW_DAYS=90;i.PERS_CONTAINER_KEY_PREFIX="ushell.smartnav.";i.ONE_DAY_IN_MILLISECOND=24*60*60*1e3;i.prototype.getLinks=function(e){var r=new jQuery.Deferred;this._oCrossAppNavigationServicePromise.then(function(i){var a=i.getLinks(e);if(!this._isTrackingEnabled(this._oServiceConfig)){a.done(r.resolve).fail(r.reject);return}var o=t.getCurrentApplication();var s=o.sShellHash;var c=o.componentHandle;if(o.componentHandle){c=o.componentHandle.getInstance()}if(!s){n.warning("Call to SmartNavigation#getLinks() simply delegated to CrossApplicationNavigation#getLinks()"+" because AppConfiguration#getCurrentApplication()#sShellHash evaluates to undefined.");a.done(r.resolve).fail(r.reject);return}var l=this._getNavigationOccurrences(s,c);jQuery.when(a,l).done(function(e,t){if(t.length===0){r.resolve(e);return}var n=this._prepareLinksForSorting(e,t);e=n.sort(function(e,t){return t.clickCount-e.clickCount});r.resolve(e)}.bind(this)).fail(r.reject)}.bind(this)).catch(r.reject);return r.promise()};i.prototype.toExternal=function(e){var r=arguments;this._oCrossAppNavigationServicePromise.then(function(i){if(!this._isTrackingEnabled(this._oServiceConfig)){i.toExternal.apply(i,r);return}var a=t.getCurrentApplication();var o=a.sShellHash;var s=a.componentHandle;if(a.componentHandle){s=a.componentHandle.getInstance()}if(!o){n.warning("Current shell hash could not be identified. Navigation will not be tracked.",null,"sap.ushell.services.SmartNavigation");i.toExternal.apply(i,r);return}var c=this._getHashFromOArgs(e.target);if(!c){n.warning("Destination hash does not conform with the ushell guidelines. Navigation will not be tracked.",null,"sap.ushell.services.SmartNavigation");i.toExternal.apply(i,r);return}this._recordNavigationOccurrences(o,c,s).then(function(){i.toExternal.apply(i,r)})}.bind(this))};i.prototype.hrefForExternal=function(){n.error("Deprecated API call of 'sap.ushell.services.SmartNavigation.hrefForExternal'. Please use 'hrefForExternalAsync' instead.",null,"sap.ushell.services.SmartNavigation");var e=sap.ushell.Container.getService("CrossApplicationNavigation");return e.hrefForExternal.apply(e,arguments)};i.prototype.hrefForExternalAsync=function(){var e=arguments;return this._oCrossAppNavigationServicePromise.then(function(t){return t.hrefForExternalAsync.apply(t,e)})};i.prototype.getPrimaryIntent=function(){var e=new jQuery.Deferred;var t=arguments;this._oCrossAppNavigationServicePromise.then(function(n){n.getPrimaryIntent.apply(n,t).done(e.resolve).fail(e.reject)}).catch(e.reject);return e.promise()};i.prototype.trackNavigation=function(e){if(!this._isTrackingEnabled(this._oServiceConfig)){n.debug("Call to SmartNavigation#trackNavigation() ignored because Service is not enabled via Configuration",null,"sap.ushell.services.SmartNavigation");return jQuery.when(null)}var r=e.target;var i=t.getCurrentApplication();var a=i.sShellHash;var o;if(!a){n.warning("Call to SmartNavigation#trackNavigation() simply ignored"+" because AppConfiguration#getCurrentApplication()#sShellHash evaluates to undefined.");return jQuery.when(null)}o=this._getHashFromOArgs(r);if(!o){n.warning("Navigation not tracked - no valid destination provided",null,"sap.ushell.services.SmartNavigation");return jQuery.when(null)}n.debug("Navigation to "+o+" was tracked out of "+a,null,"sap.ushell.services.SmartNavigation");return this._recordNavigationOccurrences(a,o,i.componentHandle.getInstance())};i.prototype._isTrackingEnabled=function(t){return e.isDefined(t)&&e.isDefined(t.config)&&e.isDefined(t.config.isTrackingEnabled)?t.config.isTrackingEnabled:false};i.prototype._getHashCode=function(e){var t=e+"";if(this._oHashCodeCache[t]){return this._oHashCodeCache[t]}var n=0;var r=t.length;while(r--){n=(n<<5)-n+(t.charCodeAt(r)|0);n|=0}this._oHashCodeCache[t]=n;return n};i.prototype._getBaseHashPart=function(e){var t=r.parseShellHash(e);if(t&&t.semanticObject&&t.action){return t.semanticObject+"-"+t.action}throw"Invalid intent `"+e+"`"};i.prototype._getHashFromOArgs=function(e){if(!e){return null}if(e.shellHash&&r.parseShellHash(e.shellHash)){return this._getBaseHashPart(e.shellHash)}if(e.semanticObject&&e.action){return e.semanticObject+"-"+e.action}return null};i.prototype._getPersContainerKey=function(e){return i.PERS_CONTAINER_KEY_PREFIX+this._getHashCode(e)};i.prototype._getNavigationOccurrences=function(e,t){var n=new jQuery.Deferred;var r=this._getPersContainerKey(e);this._oPersonalizationServicePromise.then(function(e){var i=e.getContainer(r,{keyCategory:e.constants.keyCategory.FIXED_KEY,writeFrequency:e.constants.writeFrequency.HIGH,clientStorageAllowed:true},t);i.done(function(e){var t=e.getItemKeys();var r=t.map(function(t){var n=e.getItemValue(t);var r=Object.keys(n.actions);return r.map(function(e){var r=n.actions[e];var i=r.dailyFrequency.reduce(function(e,t){return e+t},0);return{intent:t+"-"+e,clickCount:i}})});var i=r.reduce(function(e,t){Array.prototype.push.apply(e,t);return e},[]);n.resolve(i)})}).catch(n.reject);return n.promise()};i.prototype._prepareLinksForSorting=function(e,t){var n={};t.forEach(function(e){n[e.intent]=e});e.forEach(function(e){var t=this._getBaseHashPart(e.intent);var r=n[t];e.clickCount=r?r.clickCount:0}.bind(this));return e};i.prototype._recordNavigationOccurrences=function(e,t,n){var i=r.parseShellHash(t);var a=this._getPersContainerKey(e);var o=i.semanticObject;var s=new jQuery.Deferred;this._oPersonalizationServicePromise.then(function(e){var t=e.getContainer(a,{keyCategory:e.constants.keyCategory.FIXED_KEY,writeFrequency:e.constants.writeFrequency.HIGH,clientStorageAllowed:true},n);t.done(function(e){var t=e.getItemValue(o);var n=i.action;if(!t){t={actions:{},latestVisit:Date.now(),dailyFrequency:[0]}}var r=t.actions[n];if(!r){r={latestVisit:Date.now(),dailyFrequency:[0]};t.actions[n]=r}this._updateHistoryEntryWithCurrentUsage(t);this._updateHistoryEntryWithCurrentUsage(r);e.setItemValue(o,t);e.save().done(s.resolve).fail(s.reject)}.bind(this)).fail(s.reject)}.bind(this)).catch(s.reject);return s.promise()};i.prototype._updateHistoryEntryWithCurrentUsage=function(e){var t=Date.now();var n=t-e.latestVisit;var r=Math.floor(n/i.ONE_DAY_IN_MILLISECOND);while(r--){e.dailyFrequency.unshift(0);if(e.dailyFrequency.length>i.STATISTIC_COLLECTION_WINDOW_DAYS){e.dailyFrequency.pop()}}++e.dailyFrequency[0];e.latestVisit=t;return e};i.hasNoAdapter=true;return i});
//# sourceMappingURL=SmartNavigation.js.map