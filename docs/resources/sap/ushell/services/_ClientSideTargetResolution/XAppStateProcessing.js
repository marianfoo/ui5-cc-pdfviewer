// Copyright (c) 2009-2022 SAP SE, All Rights Reserved
sap.ui.define(["sap/ushell/utils","sap/ushell/services/_ClientSideTargetResolution/Utils","sap/ushell/navigationMode","sap/ushell/services/AppConfiguration","sap/ushell/Config","sap/ui/thirdparty/jquery","sap/base/util/ObjectPath","sap/base/util/isEmptyObject","sap/base/util/isPlainObject","sap/ui/generic/app/navigation/service/SelectionVariant","sap/base/Log"],function(e,t,a,n,r,jQuery,i,s,o,u,l){"use strict";function p(e,a){var n=new jQuery.Deferred,r,i=e.resolutionResult,s=e.inbound&&(e.inbound.signature||{}),o=c(i)||s.additionalParameters==="ignored"||b(e);if(!o){m(n,e);return n.promise()}var u=e.intentParamsPlusAllDefaults["sap-xapp-state"]&&e.intentParamsPlusAllDefaults["sap-xapp-state"][0];if(u){v(a,u).then(h).then(function(o){if(c(i)){var u=t.constructParameterDominatorMap(s.parameters);Object.keys(i.oNewAppStateMembers).forEach(function(e){var t=u[e].dominatedBy;if(g(o,t)){delete i.oNewAppStateMembers[e]}})}var l=s.additionalParameters==="ignored";if(!c(i)&&!b(e)&&!l){m(n,e);return}r=a.createEmptyAppState(undefined,true);if(r){r.setData(o);f(r,e,n)}},function(){delete i.oNewAppStateMembers;m(n,e);return});return n.promise()}if(c(i)){var l=a.createEmptyAppState(undefined,true);f(l,e,n);return n.promise()}m(n,e);return n.promise()}function f(e,t,a){var n=e.getData()||{},r,i={},s=t.inbound.signature,o=t.resolutionResult;if(n.selectionVariant){r=new u(JSON.stringify(n.selectionVariant))}else{r=new u}if(c(o)){Object.keys(o.oNewAppStateMembers).forEach(function(e){r.massAddSelectOption(e,o.oNewAppStateMembers[e].Ranges)})}var l=s.additionalParameters==="ignored";r=P(r,i,s.parameters,l);if(r.getParameterNames().length!==0||r.getSelectOptionsPropertyNames().length!==0||i.deleted){n.selectionVariant=r.toJSONObject()}if(!i.changed&&!i.deleted&&!c(o)){m(a,t);return}e.setData(n);e.save().done(function(){t.intentParamsPlusAllDefaults["sap-xapp-state"]=[e.getKey()];t.mappedIntentParamsPlusSimpleDefaults["sap-xapp-state"]=[e.getKey()];m(a,t)})}function m(t,s){var o;A(s);O(s);o=a.compute(i.get("inbound.resolutionResult.applicationType",s),(s.intentParamsPlusAllDefaults["sap-ushell-next-navmode"]||[])[0],(s.intentParamsPlusAllDefaults["sap-ushell-navmode"]||[])[0],(n.getCurrentApplication()||{}).applicationType,r.last("/core/navigation/enableInPlaceForClassicUIs"));e.shallowMergeObject(s.resolutionResult,o);delete s.resolutionResult.oNewAppStateMembers;t.resolve(s)}function c(e){return e.oNewAppStateMembers&&!s(e.oNewAppStateMembers)}function d(e,t){return Array.isArray(e)&&e.some(function(e){return t.indexOf(e)!==-1})}function g(e,t){if(e&&e.selectionVariant){var a=new u(JSON.stringify(e.selectionVariant)),n=a.getSelectOptionsPropertyNames()||[],r=a.getParameterNames()||[];if(d(n,t)||d(r,t)){return true}}return false}function P(e,t,a,n){var r=new u,i=e.getParameterNames()||[],s=e.getSelectOptionsPropertyNames()||[],o,p;i.forEach(function(i){o=e.getParameter(i);if(n&&!a[i]){t.deleted=true;return}if(a[i]&&a[i].renameTo){if(r.getParameter(a[i].renameTo)===undefined&&r.getSelectOption(a[i].renameTo)===undefined){r.addParameter(a[i].renameTo,o);t.changed=true}else{l.error("renaming of appstate creates duplicates "+i+"->"+a[i].renameTo)}}else if(r.getParameter(i)===undefined&&r.getSelectOption(i)===undefined){r.addParameter(i,o)}});s.forEach(function(i){p=e.getSelectOption(i);if(n&&!a[i]){t.deleted=true;return}if(a[i]&&a[i].renameTo){if(r.getSelectOption(a[i].renameTo)===undefined&&r.getParameter(a[i].renameTo)===undefined){r.massAddSelectOption(a[i].renameTo,p);t.changed=true}else{l.error("renaming of appstate creates duplicates "+i+"->"+a[i].renameTo)}}else if(r.getSelectOption(i)===undefined&&r.getParameter(i)===undefined){r.massAddSelectOption(i,p)}});i.forEach(function(t){e.removeParameter(t)});s.forEach(function(t){e.removeSelectOption(t)});r.getParameterNames().forEach(function(t){e.addParameter(t,r.getParameter(t))});r.getSelectOptionsPropertyNames().forEach(function(t){e.massAddSelectOption(t,r.getSelectOption(t))});return e}function S(e){if(e===undefined||o(e)){return false}return true}function b(e){return e.inbound&&e.inbound.signature&&e.inbound.signature.parameters&&Object.keys(e.inbound.signature.parameters).some(function(t){return!!e.inbound.signature.parameters[t].renameTo})}function A(e){e.defaultedParamNames=e.defaultedParamNames.filter(function(t){if(e.intentParamsPlusAllDefaults[t]&&!Array.isArray(e.intentParamsPlusAllDefaults[t])){if(!(e.resolutionResult.oNewAppStateMembers&&e.resolutionResult.oNewAppStateMembers[t])){return false}}return true})}function O(e){var t=i.get("inbound.signature.parameters",e)||{},a={};e.defaultedParamNames.forEach(function(e){var n=t[e]&&t[e].renameTo||e;if(a[n]){l.error("renaming of defaultedParamNames creates duplicates"+e+"->"+n)}else{a[n]=true}});e.mappedDefaultedParamNames=Object.keys(a).sort()}function h(e){if(S(e)){return Promise.reject()}return Promise.resolve(e)}function v(e,t){return new Promise(function(a,n){e.getAppState(t).done(function(e){a(e.getData())}).fail(function(e){n(e)})})}return{mixAppStateIntoResolutionResultAndRename:p,_hasRenameTo:b}});
//# sourceMappingURL=XAppStateProcessing.js.map