// Copyright (c) 2009-2022 SAP SE, All Rights Reserved
sap.ui.define(["sap/ui/thirdparty/jquery","sap/ushell/Config","sap/ushell/library","sap/base/util/deepClone","sap/base/util/deepExtend","sap/base/Log"],function(jQuery,e,r,o,t,n){"use strict";var i="X-SAP-UI2-HANA:hana?remoteId=HANA_CATALOG";var a=r.ContentNodeType;function s(){this._oLaunchPageServicePromise=sap.ushell.Container.getServiceAsync("LaunchPage");if(e.last("/core/spaces/enabled")){this._oPagesServicePromise=sap.ushell.Container.getServiceAsync("Pages")}this._addBookmarkToContentNodes=function(e,r,o,t){var n=r.map(function(r){if(r&&r.hasOwnProperty("type")&&r.isContainer){switch(r.type){case a.Page:return this.addBookmarkToPage(e,r.id,t);case a.HomepageGroup:return new Promise(function(e,o){this._oLaunchPageServicePromise.then(function(t){t.getGroupById(r.id).done(e).fail(o)})}.bind(this)).then(function(r){return this.addBookmarkToHomepageGroup(e,r,o,t)}.bind(this));default:return Promise.reject("Bookmark Service: The API needs to be called with a valid content node type. '"+r.type+"' is not supported.")}}return Promise.reject("Bookmark Service: Not a valid content node.")}.bind(this));return Promise.all(n)};this.addBookmark=function(r,o,t){var n=new jQuery.Deferred;var i=e.last("/core/shell/enablePersonalization");var a=e.last("/core/spaces/enabled");var s=e.last("/core/spaces/myHome/enabled");if(!i&&(!a||!s)){return n.resolve().promise()}if(typeof o==="undefined"&&a){sap.ushell.Container.getServiceAsync("Menu").then(function(e){return e.getDefaultSpace()}).then(function(e){var r=e&&e.children&&e.children[0];return r}).then(function(e){this._addBookmarkToContentNodes(r,[e],false,t).then(n.resolve).catch(n.reject)}.bind(this));return n.promise()}if((typeof o==="undefined"||!o.hasOwnProperty("type"))&&!Array.isArray(o)){this.addBookmarkToHomepageGroup(r,o,false,t).then(n.resolve).catch(n.reject);return n.promise()}var u=[].concat(o);this._addBookmarkToContentNodes(r,u,false,t).then(n.resolve).catch(n.reject);return n.promise()};this.addCustomBookmark=function(e,r,n,i){var a=o(r);var s=t(a,{vizType:e,vizConfig:{"sap.flp":{chipConfig:a.chipConfig},"sap.platform.runtime":{includeManifest:!a.loadManifest}}});delete s.chipConfig;delete s.loadManifest;var u=[].concat(n);return this._addBookmarkToContentNodes(s,u,true,i)};this.addBookmarkToHomepageGroup=function(r,o,t,n){if(e.last("/core/spaces/enabled")){var i="Bookmark Service: The API is not available in spaces mode.";return Promise.reject(i)}return new Promise(function(e,i){this._oLaunchPageServicePromise.then(function(a){var s;if(t){s=a.addCustomBookmark(r,o,n)}else{s=a.addBookmark(r,o,n)}s.done(function(r){var t={tile:r,group:o};sap.ui.getCore().getEventBus().publish("sap.ushell.services.Bookmark","bookmarkTileAdded",t);e()}).fail(i)})}.bind(this))};this.addBookmarkToPage=function(r,o,t){if(!e.last("/core/spaces/enabled")){return Promise.reject("Bookmark Service: 'addBookmarkToPage' is not valid in launchpad homepage mode, use 'addBookmark' instead.")}var n=e.last("/core/shell/enablePersonalization");var i=e.last("/core/spaces/myHome/enabled");var a=e.last("/core/spaces/myHome/myHomePageId");if(!n&&(!i||i&&o!==a)){return Promise.reject("Bookmark Service: Add bookmark is not allowed as the personalization functionality is not enabled.")}if(r&&(typeof r.title!=="string"||typeof r.url!=="string")){return Promise.reject("Bookmark Service - Invalid bookmark data.")}return this._oPagesServicePromise.then(function(e){return e.addBookmarkToPage(o,r,undefined,t)})};this.addBookmarkByGroupId=function(r,o,t){var n=new jQuery.Deferred;if(e.last("/core/spaces/enabled")){var i="Bookmark Service: The API 'addBookmarkByGroupId' is not supported in launchpad spaces mode.";return n.reject(i).promise()}this._oLaunchPageServicePromise.then(function(e){e.getGroups().done(function(e){e=jQuery.grep(e,function(e){return e.id===o});var i=null;if(e.length>0){i=e[0]}this.addBookmark(r,i,t).done(n.resolve).fail(n.reject)}.bind(this)).fail(n.reject)}.bind(this)).catch(n.reject);return n.promise()};this.getShellGroupIDs=function(r){var o=new jQuery.Deferred;if(e.last("/core/spaces/enabled")){var t="Bookmark Service: The API 'getShellGroupIDs' is not supported in launchpad spaces mode.";return o.reject(t).promise()}this._oLaunchPageServicePromise.then(function(e){e.getGroupsForBookmarks(r).done(function(r){r=r.map(function(r){return{id:e.getGroupId(r.object),title:r.title}});o.resolve(r)}).fail(o.reject)});return o.promise()};this._doAddCatalogTileToGroup=function(e,r,o,t){this._oLaunchPageServicePromise.then(function(i){if(t){i.getGroups().fail(e.reject).done(function(a){var s=a.some(function(n){if(i.getGroupId(n)===t){this._addToGroup(o,e,r,n);return true}}.bind(this));if(!s){var u="Group '"+t+"' is unknown";n.error(u,null,"sap.ushell.services.Bookmark");e.reject(u)}}.bind(this))}else{i.getDefaultGroup().fail(e.reject).done(function(t){this._addToGroup(o,e,r,t)}.bind(this))}}.bind(this));return e.promise()};this._isSameCatalogTile=function(e,r,o){var t=o.getCatalogTileId(r);if(t===undefined){return false}return t.indexOf(e)===0};this._addToGroup=function(e,r,o,t){return this._oLaunchPageServicePromise.then(function(i){i.getCatalogTiles(e).fail(r.reject).done(function(a){var s=i.getGroupId(t);var u=a.some(function(e){if(this._isSameCatalogTile(o,e,i)){i.addTile(e,t).fail(r.reject).done(function(){r.resolve();sap.ui.getCore().getEventBus().publish("sap.ushell.services.Bookmark","catalogTileAdded",s)});return true}}.bind(this));if(!u){var c="No tile '"+o+"' in catalog '"+i.getCatalogId(e)+"'";n.error(c,null,"sap.ushell.services.Bookmark");r.reject(c)}}.bind(this))}.bind(this))};this.addCatalogTileToGroup=function(r,o,t){var a=new jQuery.Deferred;var s;if(e.last("/core/spaces/enabled")){s="Bookmark Service: The API 'addCatalogTileToGroup' is not supported in launchpad spaces mode.";return a.reject(s).promise()}this._oLaunchPageServicePromise.then(function(e){var u=t?this._isMatchingRemoteCatalog:this._isLegacyHANACatalog;t=t||{id:i};e.onCatalogTileAdded(r);e.getCatalogs().fail(a.reject).done(function(i){var c;i.forEach(function(r){if(u(r,t,e)){if(!c){c=r}else{n.warning("More than one matching catalog: "+JSON.stringify(t),null,"sap.ushell.services.Bookmark")}}});if(c){this._doAddCatalogTileToGroup(a,r,c,o)}else{s="No matching catalog found: "+JSON.stringify(t);n.error(s,null,"sap.ushell.services.Bookmark");a.reject(s)}}.bind(this))}.bind(this));return a.promise()};this._isMatchingRemoteCatalog=function(e,r,o){var t=o.getCatalogData(e);return t.remoteId===r.remoteId&&t.baseUrl.replace(/\/$/,"")===r.baseUrl.replace(/\/$/,"")};this._isLegacyHANACatalog=function(e,r,o){return o.getCatalogId(e)===i};this.countBookmarks=function(r,o){var t=new jQuery.Deferred;if(e.last("/core/spaces/enabled")){this._oPagesServicePromise.then(function(e){return e.countBookmarks({url:r,contentProviderId:o})}).then(t.resolve,t.reject)}else{this._oLaunchPageServicePromise.then(function(e){e.countBookmarks(r,o).done(t.resolve).fail(t.reject)})}return t.promise()};this.countCustomBookmarks=function(r){if(!r||!r.url||!r.vizType){return Promise.reject("countCustomBookmarks: Some required parameters are missing.")}if(e.last("/core/spaces/enabled")){return this._oPagesServicePromise.then(function(e){return e.countBookmarks(r)})}return this._oLaunchPageServicePromise.then(function(e){return e.countCustomBookmarks(r)})};this.deleteBookmarks=function(r,o){var t=new jQuery.Deferred;if(e.last("/core/spaces/enabled")){this._oPagesServicePromise.then(function(e){return e.deleteBookmarks({url:r,contentProviderId:o})}).then(t.resolve,t.reject)}else{this._oLaunchPageServicePromise.then(function(e){e.deleteBookmarks(r,o).done(function(e){sap.ui.getCore().getEventBus().publish("sap.ushell.services.Bookmark","bookmarkTileDeleted",r);t.resolve(e)}).fail(t.reject)})}return t.promise()};this.deleteCustomBookmarks=function(r){if(!r||!r.url||!r.vizType){return Promise.reject("deleteCustomBookmarks: Some required parameters are missing.")}if(e.last("/core/spaces/enabled")){return this._oPagesServicePromise.then(function(e){return e.deleteBookmarks(r)})}return this._oLaunchPageServicePromise.then(function(e){return e.deleteCustomBookmarks(r)}).then(function(){sap.ui.getCore().getEventBus().publish("sap.ushell.services.Bookmark","bookmarkTileDeleted",r.url)})};this.updateBookmarks=function(r,o,t){var n=new jQuery.Deferred;if(e.last("/core/spaces/enabled")){this._oPagesServicePromise.then(function(e){return e.updateBookmarks({url:r,contentProviderId:t},o)}).then(n.resolve,n.reject)}else{this._oLaunchPageServicePromise.then(function(e){e.updateBookmarks(r,o,t).done(n.resolve).fail(n.reject)})}return n.promise()};this.updateCustomBookmarks=function(r,o){if(!r||!r.url||!r.vizType){return Promise.reject("deleteCustomBookmarks: Some required parameters are missing.")}var n=t({},o,{vizConfig:{"sap.flp":{chipConfig:o.chipConfig},"sap.platform.runtime":{includeManifest:!o.loadManifest}}});delete n.chipConfig;delete n.loadManifest;if(e.last("/core/spaces/enabled")){return this._oPagesServicePromise.then(function(e){return e.updateBookmarks(r,n)})}return this._oLaunchPageServicePromise.then(function(e){return e.updateCustomBookmarks(r,n)})};this.getContentNodes=function(){if(e.last("/core/spaces/enabled")){return sap.ushell.Container.getServiceAsync("Menu").then(function(e){return e.getContentNodes()})}return new Promise(function(e,r){this._oLaunchPageServicePromise.then(function(o){o.getGroupsForBookmarks().done(function(r){var t=r.map(function(e){return{id:o.getGroupId(e.object),label:e.title,type:a.HomepageGroup,isContainer:true}});e(t)}).fail(r)})}.bind(this))}}s.hasNoAdapter=true;return s},true);
//# sourceMappingURL=Bookmark.js.map