/* Tiny mentions plugin
 *
 * Copyright 2010-2019 Tiny Technologies LLC. All rights reserved.
 *
 * Version: 2.1.0-88
 */

!function(b){"use strict";var n=function(t){return parseInt(t,10)},r=function(t,e,n){return{major:t,minor:e,patch:n}},o=function(t){var e=/([0-9]+)\.([0-9]+)\.([0-9]+)(?:(\-.+)?)/.exec(t);return e?r(n(e[1]),n(e[2]),n(e[3])):r(0,0,0)},i=function(t,e){var n=t-e;return 0===n?0:0<n?1:-1},w=function(t,e){return!!t&&-1===function(t,e){var n=i(t.major,e.major);if(0!==n)return n;var r=i(t.minor,e.minor);if(0!==r)return r;var o=i(t.patch,e.patch);return 0!==o?o:0}(o([(n=t).majorVersion,n.minorVersion].join(".").split(".").slice(0,3).join(".")),o(e));var n},t=function(r,o){return function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];var n=r.console;n&&o in n&&n[o].apply(n,arguments)}},y={log:t(b.window,"log"),error:t(b.window,"error"),warn:t(b.window,"warm")},x=function(t,e){return t.dom.is(e,O(t))},O=function(t){return t.settings.mentions_selector||".mention"},u=function(t){b.console.error(t)},T=function(t){return t&&"string"==typeof t.id&&"string"==typeof t.name},A=function(t){T(t)||u("mentions_fetch didn't produce a valid list of users.")},C=function(t,e){var n=x(t,e);return n||u("mentions_complete needs to produce a element that matches selector: "+O(t)),n},E=function(t){var e=function(){},r=function(t,e){return"function"==typeof t?t:e},n=function(t,e){var o,n=r(t,e);return function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];var r={};t=t.map(function(t){var n;return"function"==typeof t&&(n=t,t=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];r===o&&n.apply(null,t)}),t}),r=o={},n.apply(null,t)}},o=n(t.mentions_menu_hover,e),i=n(t.mentions_fetch,function(t,e){e([])}),u=r(t.mentions_menu_complete,function(t,e){var n=t.dom.create("span",{class:"mention"});return n.appendChild(t.dom.doc.createTextNode("@"+e.name)),n}),c=r(t.mentions_menu_cancel,e);return{hover:o,fetch:i,complete:u,select:n(t.mentions_select,e),cancel:c}},P=function(i){i.on("SetContent",function(){var t,e;e=!0,(t=i).$(O(t),e).prop("contentEditable",!1)}),i.on("PreProcess",function(t){var e,n,r,o;e=i,n=t.node,r=t.source_view,(o=e.$(O(e),n)).removeAttr("contenteditable"),r||o.removeAttr("data-mce-mentions-id")}),i.on("ResolveName",function(t){x(i,t.target)&&(t.name="mention")})},p=function(e,n){var r,t;return(t=function(){var t=arguments;clearTimeout(r),r=setTimeout(function(){e.apply(this,t)},n)}).stop=function(){clearTimeout(r)},t},s=Math.round,c=function(t,e,n){var r,o,i,u,c,l;r=e.x,o=e.y,i=t.w,u=t.h,c=e.w,l=e.h;var a=(n||"").split("");return"b"===a[0]&&(o+=l),"r"===a[1]&&(r+=c),"c"===a[0]&&(o+=s(l/2)),"c"===a[1]&&(r+=s(c/2)),"b"===a[3]&&(o-=u),"r"===a[4]&&(r-=i),"c"===a[3]&&(o-=s(u/2)),"c"===a[4]&&(r-=s(i/2)),g(r,o,i,u)},g=function(t,e,n,r){return{x:t,y:e,w:n,h:r}},l=tinymce.DOM,h=function(t,e,n){var r=l.getViewPort();r.w-=30,r.h-=30;var o=function(t,e,n,r){var o,i;for(i=0;i<r.length;i++)if((o=c(t,e,r[i])).x>=n.x&&o.x+o.w<=n.w+n.x&&o.y>=n.y&&o.y+o.h<=n.h+n.y)return r[i];return null}(t,e,r,n);return t=c(t,e,o||n[0]||"bl-tl")},N=function(t,e,n,r){var o,i,u,c=(u=n,S(i=t,i.dom.getRect(u)));o=l.getRect(e),o=h(o,c,r),l.setStyles(e,{position:"absolute",left:o.x,top:o.y})},S=function(t,e){var n;return t.inline||(n=l.getPos(t.getContentAreaContainer()),e.x+=n.x,e.y+=n.y),e},j=function(i,t,e,n){var u,c,l=-1,a=tinymce.DOM,s=function(t,e){var n,r,o,i,u,c;r=f(((o=(o=t.rng).cloneRange()).setStart(o.startContainer,o.startOffset+1),o)),n=h(a.getRect(e.getEl()),(u=0,c=2,g((i=r).x-u,i.y-c,i.w+2*u,i.h+2*c)),["bl-tl","tl-bl","tl-br","bl-tr"]),e.moveTo(n.x,n.y)},f=function(t){var e;e=t.getClientRects()[0];var n=i.inline?a.getViewPort():{x:0,y:0};return S(i,{x:e.left+n.x,y:e.top+n.y,w:e.width,h:e.height})},m=function(){c&&(a.remove(c),c=null)},d=function(){m(),u&&(u.remove(),u=null)},r=function(){m(),u&&u.hide()},o=function(o){n(o.settings.data,function(t){var e,n,r;o.getEl().parentNode&&0!==u.items().length&&u.visible()&&(a.setStyles(t,{position:"absolute",left:-65535,top:-65535}),a.add(b.document.body,t),e=t,n=o.getEl(),r=h(a.getRect(e),a.getRect(n),["tr-tl","tl-tr","bl-br","br-bl"]),a.setStyles(e,{left:r.x,top:r.y}),m(),c=t)})},v=function(n){m(),u.items().each(function(t,e){t===n&&l!==e&&(n.hover(),o(n),l=e)})},y=function(){var t;r(),(t=u.items()[l])&&e(t.settings.data)};return{isVisible:function(){return u&&u.visible()},selectNext:function(){v(u.items()[l+1])},selectPrev:function(){v(u.items()[l-1])},showAt:function(o){t(function(t){var e,n,r;0!==t.length?(u=(u||(u=tinymce.ui.Factory.create("menu",{onhide:function(){m()},classes:"contextmenu"}).renderTo(),i.on("remove",d),u)).show(),(e=u).getEl().style.width="",e.getEl("body").style.width="",u.items().remove(),u.add((n=t,r=o.text,tinymce.util.Tools.map(n,function(t){return{text:t.fullName,data:t,match:r,onclick:function(){v(this),y()},onmouseenter:function(){v(this)}}}))),u.renderNew(),u.initLayoutRect(),s(o,u),l=-1,v(u.items()[0])):u&&u.hide()})},hide:r,complete:y}},a=/[\u00a0 \t\r\n]/,k=function(t){var e,n=(e=t).collapsed&&3===e.startContainer.nodeType?e.startContainer:null;if(null===n)return null;var r=t.startOffset,o=function(t,e){var n;for(n=e-1;0<=n;n--){if(a.test(t.charAt(n)))return null;if("@"===t.charAt(n))break}return-1===n||e-n<2?null:t.substring(n+1,e)}(n.data,r);if(null===o)return null;var i=t.cloneRange();return i.setStart(n,r-o.length-1),i.setEnd(n,r),{text:o,rng:i}},R=function(){return(R=Object.assign||function(t){for(var e,n=1,r=arguments.length;n<r;n++)for(var o in e=arguments[n])Object.prototype.hasOwnProperty.call(e,o)&&(t[o]=e[o]);return t}).apply(this,arguments)};var e,f,m,d,v,V=function(){},_=function(t){return function(){return t}},K=_(!1),D=_(!0),L=function(){return M},M=(e=function(t){return t.isNone()},d={fold:function(t,e){return t()},is:K,isSome:K,isNone:D,getOr:m=function(t){return t},getOrThunk:f=function(t){return t()},getOrDie:function(t){throw new Error(t||"error: getOrDie called on none.")},getOrNull:_(null),getOrUndefined:_(void 0),or:m,orThunk:f,map:L,each:V,bind:L,exists:K,forall:D,filter:L,equals:e,equals_:e,toArray:function(){return[]},toString:_("none()")},Object.freeze&&Object.freeze(d),d),q=function(n){var t=_(n),e=function(){return o},r=function(t){return t(n)},o={fold:function(t,e){return e(n)},is:function(t){return n===t},isSome:D,isNone:K,getOr:t,getOrThunk:t,getOrDie:t,getOrNull:t,getOrUndefined:t,or:e,orThunk:e,map:function(t){return q(t(n))},each:function(t){t(n)},bind:r,exists:r,forall:r,filter:function(t){return t(n)?o:M},toArray:function(){return[n]},toString:function(){return"some("+n+")"},equals:function(t){return t.is(n)},equals_:function(t,e){return t.fold(K,function(t){return e(n,t)})}};return o},U={some:q,none:L,from:function(t){return null==t?M:q(t)}},$=(v="function",function(t){return function(t){if(null===t)return"null";var e=typeof t;return"object"===e&&(Array.prototype.isPrototypeOf(t)||t.constructor&&"Array"===t.constructor.name)?"array":"object"===e&&(String.prototype.isPrototypeOf(t)||t.constructor&&"String"===t.constructor.name)?"string":e}(t)===v}),H=Array.prototype.slice,I=function(t,e){for(var n=t.length,r=new Array(n),o=0;o<n;o++){var i=t[o];r[o]=e(i,o)}return r},z=($(Array.from)&&Array.from,function(t){var e=t,n=function(){return e};return{get:n,set:function(t){e=t},clone:function(){return z(n())}}}),B=Object.hasOwnProperty,F=function(t,e){return B.call(t,e)},W=tinymce.util.Delay,G=tinymce.util.Tools,J=function(s){var e,n,r,f=E(s.settings),m={},d="data-mce-mentions-id",o=null,i=(e=z(U.none()),{clear:function(){e.set(U.none())},set:function(t){e.set(U.some(t))},isSet:function(){return e.get().isSome()},on:function(t){e.get().each(t)}}),u=function(){null!==o&&null!==o.parentNode&&(o.removeEventListener("mouseover",a),o.removeEventListener("mouseout",v),o.parentNode.removeChild(o)),o=null},c=function(){u()},l=function(t){W.clearTimeout(n),W.clearTimeout(r),n=W.setEditorTimeout(s,function(){return e=t,void f.select(e,function(t){u(),(o=t).addEventListener("mouseover",a),o.addEventListener("mouseout",v),o.style.position="absolute",o.style.left="-10000px",o.style.top="-10000px",b.document.body.appendChild(o),N(s,o,e,["bl-tl","tl-bl","tl-br","bl-tr"])});var e},0)},a=function(){W.clearTimeout(r)},v=function(){W.clearTimeout(r),W.clearTimeout(n),r=W.setEditorTimeout(s,c,300)},y=function(){return i.isSet()||x(s,s.selection.getNode())&&!1===s.selection.isCollapsed()},t=function(t){var e=s.dom.$(t.target).closest(O(s));0<e.length&&(i.set(!0),l(e[0]))},p=function(t){0<s.dom.$(t.target).closest(O(s)).length&&(i.clear(),y()||c())},g=function(t){x(s,t.element)&&!1===s.selection.isCollapsed()?l(t.element):y()||v()},h=function(t,e){void 0===e&&(e=[]);var n=I(t,function(e){return{value:e.id,text:e.name,meta:{user:e,tooltipWorker:function(t){f.hover(e,t)}}}});if(w(tinymce,"5.0.14"))return n;var r=I(e,function(t){return{value:void 0===t.value?"":t.value,text:t.text,meta:R(R({},t.meta),{reload:!0})}});return function(){for(var t=0,e=0,n=arguments.length;e<n;e++)t+=arguments[e].length;var r=Array(t),o=0;for(e=0;e<n;e++)for(var i=arguments[e],u=0,c=i.length;u<c;u++,o++)r[o]=i[u];return r}(n,0<r.length?[{type:"separator"}]:[],r)};return s.ui.registry.addAutocompleter("mentions",{ch:"@",minChars:1,maxResults:10,onAction:function(t,e,n,r){if((l=r,a="reload",F(l,a)?U.from(l[a]):U.none()).is(!0)){r.reload;var o=function(t,e){var n={};for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&e.indexOf(r)<0&&(n[r]=t[r]);if(null!=t&&"function"==typeof Object.getOwnPropertySymbols){var o=0;for(r=Object.getOwnPropertySymbols(t);o<r.length;o++)e.indexOf(r[o])<0&&Object.prototype.propertyIsEnumerable.call(t,r[o])&&(n[r[o]]=t[r[o]])}return n}(r,["reload"]);t.reload(o)}else i=r.user,u=e,c=f.complete(s,i),C(s,c)&&(c.contentEditable="false",c.setAttribute(d,i.id),m[i.id]=i,s.selection.setRng(u),s.insertContent(c.outerHTML)),t.hide();var i,u,c,l,a},fetch:function(i,u,c){return new tinymce.util.Promise(function(n){var t,r,e,o;t=i,r=u,e=c,o=function(t,e){n(h(t,e))},f.fetch({term:t,meta:e},function(t,e){G.each(t,A);var n=t.slice(0,r);o(G.grep(n,T),e)})})},columns:1}),P(s),s.on("mouseover",t),s.on("mouseout",p),s.on("nodechange",g),s.on("remove",u),{getUsers:function(){var e=[],n=G.map(s.dom.select("["+d+"]"),function(t){return t.getAttribute(d)});return G.each(m,function(t){-1!==G.inArray(n,t.id)&&e.push(t)}),e}}},Q=function(t){return w(tinymce,"4.3.13")?(y.error("The mentions plugin requires at least 4.3.13 version of TinyMCE."),function(){}):w(tinymce,"5.0.0")?(o=E((r=t).settings),i={},u="data-mce-mentions-id",c=function(){return k(r.selection.getRng())},l=function(){n&&(n.parentNode.removeChild(n),n=null)},a=j(r,function(n){var t=c();if(t){var e={term:t.text};o.fetch(e,function(t){tinymce.util.Tools.each(t,A);var e=t.slice(0,10);n(tinymce.util.Tools.grep(e,T))})}},function(t){var e,n;e=o.complete(r,t),C(r,e)&&(n=k(r.selection.getRng()),e.contentEditable=!1,e.setAttribute("data-mce-mentions-id",t.id),i[t.id]=t,r.selection.setRng(n.rng),r.insertContent(e.outerHTML))},o.hover),s=function(){a.isVisible()&&o.cancel(),a.hide()},e=function(){if(!r.removed){var t,e=c();(t=e)&&1<=t.text.length?a.showAt(e):s()}},f=function(t,e){t.preventDefault(),e()},m=function(t){if(a.isVisible()&&!tinymce.util.VK.modifierPressed(t))switch(t.keyCode){case 27:f(t,s);break;case tinymce.util.VK.UP:f(t,a.selectPrev);break;case tinymce.util.VK.DOWN:f(t,a.selectNext);break;case tinymce.util.VK.ENTER:case tinymce.util.VK.TAB:f(t,a.complete)}else s()},d=function(t){t.keyCode===tinymce.util.VK.BACKSPACE&&e(),t.keyCode!==tinymce.util.VK.LEFT&&t.keyCode!==tinymce.util.VK.RIGHT||s()},v=function(t){var e=t.element;x(r,e)&&!1===r.selection.isCollapsed()?o.select(e,function(t){l(),n=t,b.document.body.appendChild(t),N(r,t,e,["bl-tl","tl-bl","tl-br","bl-tr"])}):l()},P(r),r.on("keypress",p(e,100)),r.on("keydown",m),r.on("keyup",d),r.on("nodechange",v),r.on("remove",l),{getUsers:function(){var e=[],n=tinymce.util.Tools.map(r.dom.select("["+u+"]"),function(t){return t.getAttribute(u)});return tinymce.util.Tools.each(i,function(t){-1!==tinymce.util.Tools.inArray(n,t.id)&&e.push(t)}),e}}):J(t);var r,n,o,i,u,c,l,a,s,e,f,m,d,v};tinymce.PluginManager.add("mentions",Q)}(window);