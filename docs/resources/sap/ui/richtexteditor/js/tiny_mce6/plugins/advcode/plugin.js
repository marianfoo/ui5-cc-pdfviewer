/*!
 * Tiny Advanced Code Editor plugin
 *
 * Copyright (c) 2022 Ephox Corporation DBA Tiny Technologies, Inc.
 * Licensed under the Tiny commercial license. See https://www.tiny.cloud/legal/
 *
 * Version: 3.1.0-57
 */

!function(){"use strict";const e=e=>parseInt(e,10),t=(e,t)=>{const o=e-t;return 0===o?0:o>0?1:-1},o=(e,t,o)=>({major:e,minor:t,patch:o}),r=t=>{const r=/([0-9]+)\.([0-9]+)\.([0-9]+)(?:(\-.+)?)/.exec(t);return r?o(e(r[1]),e(r[2]),e(r[3])):o(0,0,0)},n=e=>t=>t.options.get(e),s=n("codemirror_script"),i=n("codemirror_css"),c=n("codemirror_linewrapping"),d=n("codemirror_linenumbers"),a=n("codemirror_foldgutter"),l=n("codemirror_gutter"),u=n("codemirror_theme"),m=e=>"rtl"===e.getBody().dir?"rtl":"ltr",g=n("advcode_headless"),h=n("advcode_inline"),p=(e,t)=>({customEditorScriptUrl:t+"/customeditor.min.js",codeMirrorScriptUrl:s(e),codeMirrorCssUrl:i(e),lineWrapping:c(e),lineNumbers:d(e),foldGutter:a(e),theme:u(e),direction:m(e),gutter:l(e),editorId:e.id}),v=e=>t=>typeof t===e,f=e=>"string"===(e=>{const t=typeof e;return null===e?"null":"object"===t&&Array.isArray(e)?"array":"object"===t&&(o=r=e,(n=String).prototype.isPrototypeOf(o)||(null===(s=r.constructor)||void 0===s?void 0:s.name)===n.name)?"string":t;var o,r,n,s})(e),y=v("boolean"),b=e=>!(e=>null==e)(e),C=v("function"),w=v("number"),_=()=>{},T=()=>!1;class S{constructor(e,t){this.tag=e,this.value=t}static some(e){return new S(!0,e)}static none(){return S.singletonNone}fold(e,t){return this.tag?t(this.value):e()}isSome(){return this.tag}isNone(){return!this.tag}map(e){return this.tag?S.some(e(this.value)):S.none()}bind(e){return this.tag?e(this.value):S.none()}exists(e){return this.tag&&e(this.value)}forall(e){return!this.tag||e(this.value)}filter(e){return!this.tag||e(this.value)?this:S.none()}getOr(e){return this.tag?this.value:e}or(e){return this.tag?this:e}getOrThunk(e){return this.tag?this.value:e()}orThunk(e){return this.tag?this:e()}getOrDie(e){if(this.tag)return this.value;throw new Error(null!=e?e:"Called getOrDie on None")}static from(e){return b(e)?S.some(e):S.none()}getOrNull(){return this.tag?this.value:null}getOrUndefined(){return this.value}each(e){this.tag&&e(this.value)}toArray(){return this.tag?[this.value]:[]}toString(){return this.tag?`some(${this.value})`:"none()"}}S.singletonNone=new S(!1);const E=Object.hasOwnProperty,N=(e,t)=>E.call(e,t);"undefined"!=typeof window?window:Function("return this;")();const k=e=>t=>(e=>e.dom.nodeType)(t)===e,A=k(1),M=k(9),x=k(11),O=e=>{if(null==e)throw new Error("Node cannot be null or undefined");return{dom:e}},L=(e,t)=>{const o=(t||document).createElement("div");if(o.innerHTML=e,!o.hasChildNodes()||o.childNodes.length>1){const t="HTML does not have a single root node";throw console.error(t,e),new Error(t)}return O(o.childNodes[0])},I=(e,t)=>{const o=(t||document).createElement(e);return O(o)},V=O,P=e=>M(e)?e:V(e.dom.ownerDocument),j=(e,t)=>{e.dom.appendChild(t.dom)},B=C(Element.prototype.attachShadow)&&C(Node.prototype.getRootNode)?e=>V(e.dom.getRootNode()):P,R=()=>D(V(document)),D=e=>{const t=e.dom.body;if(null==t)throw new Error("Body is not available yet");return V(t)},U=(e,t,o)=>{let r=e.dom;const n=C(o)?o:T;for(;r.parentNode;){r=r.parentNode;const e=V(r);if(t(e))return S.some(e);if(n(e))break}return S.none()},G=e=>{const t=e.dom;null!==t.parentNode&&t.parentNode.removeChild(t)},H="\x3c!--mce_cursor--\x3e",W=(e,t)=>{const o=e.dom,r=e.selection,n=r.getBookmark(),s=(e=>N(e,"name"))(n)?o.select(n.name)[n.index]:o.select(`#${n.id}_start`)[0],i=S.from(s).map((t=>{const o=V(e.getBody());return((e,t)=>{const r=L(H),n=V(e),s=((e,t,o)=>((e,t,o,r,n)=>r(o)?S.some(o):C(n)&&n(o)?S.none():t(o,r,n))(0,U,e,t,o))(n,(e=>((e,t)=>{const o=e.dom;return!(!o||!o.hasAttribute)&&o.hasAttribute("data-mce-bogus")})(e)),(e=>{return t=o,e.dom===t.dom;var t})).getOr(n);return((e,t)=>{const o=(e=>S.from(e.dom.parentNode).map(V))(e);o.each((o=>{o.dom.insertBefore(t.dom,e.dom)}))})(s,r),r})(t)})),c=t();return i.each(G),r.moveToBookmark(n),c},q=e=>{const t=(e=>{const t=e.split(/\r?\n/);return((e,t)=>{for(let o=0;o<e.length;o++){const r=t(e[o],o);if(r.isSome())return r}return S.none()})(t,((e,o)=>{const r=e.indexOf(H);return(n=-1!==r,s=r,n?S.some(s):S.none()).map((r=>e===H?0===o?{line:o,ch:0}:{line:o-1,ch:t[o-1].length}:{line:o,ch:r}));var n,s})).getOr({line:0,ch:0})})(W(e,(()=>e.getContent({source_view:!0}))));return{content:e.getContent({source_view:!0}),cursor:t}},z=(e,t)=>{e.focus(),e.undoManager.transact((()=>{e.setContent(t)})),e.selection.setCursorLocation(),e.nodeChanged()},F=e=>{return(t=tinymce,"get",N(t,"get")?S.from(t.get):S.none()).bind((t=>S.from(t.call(tinymce,e))));var t},K=(e,t)=>((e,t,o)=>{const r=((e,t)=>{const o=((e,t)=>{const o=e.dom.getAttribute("class");return null===o?void 0:o})(e);return void 0===o||""===o?[]:o.split(" ")})(e);return((e,t,o)=>{((e,t,o)=>{if(!(f(o)||y(o)||w(o)))throw console.error("Invalid call to Attribute.set. Key ",t,":: Value ",o,":: Element ",e),new Error("Attribute value was not simple");e.setAttribute(t,o+"")})(e.dom,t,o)})(e,t,r.concat([o]).join(" ")),!0})(e,"class",t),$=(e,t)=>{(e=>void 0!==e.dom.classList)(e)?e.dom.classList.add(t):K(e,t)},J=(e,t,o,r="")=>{const n=(e=>{const t=F(e).map((e=>{const t=B(V(e.getElement()));return(e=>x(e)&&b(e.dom.host))(o=t)?o:V(P(o).dom.body);var o})).getOrThunk(R);if(A(t))return{element:t,destroy:_};{const e=I("div");return j(t,e),{element:e,destroy:()=>G(e)}}})(o.editorId),s=((e,t)=>{const o=(o,r)=>(r&&!r()||setTimeout((()=>{o.state.completionActive||o.showHint({completeSingle:!1,container:t})}),100),e.Pass);return{completeAfter:o,completeIfAfterLt:t=>o(t,(()=>{const o=t.getCursor();return"<"===t.getRange(e.Pos(o.line,o.ch-1),o)})),completeIfInTag:t=>o(t,(()=>{const o=t.getTokenAt(t.getCursor());return!!("string"!==o.type||/['"]/.test(o.string.charAt(o.string.length-1))&&1!==o.string.length)&&e.innerMode(t.getMode(),o.state).state.tagName}))}})(e,n.element.dom),i={lineWrapping:o.lineWrapping,lineNumbers:o.lineNumbers,foldGutter:o.foldGutter,theme:o.theme,direction:o.direction,matchTags:{bothTags:!0},keyMap:"sublime",gutters:o.gutter?["CodeMirror-linenumbers","CodeMirror-foldgutter"]:[],extraKeys:{"Alt-F":"findPersistent","Ctrl-J":"toMatchingTag","Ctrl-B":"selectNextOccurrence","'<'":s.completeAfter,"'/'":s.completeIfAfterLt,"' '":s.completeIfInTag,"'='":s.completeIfInTag,"Ctrl-Q":e=>{e.foldCode(e.getCursor())}},mode:"text/html",value:r},c=e(t,i),d=e=>{27!==e.keyCode&&e.stopPropagation()};t.addEventListener("keyup",d),t.addEventListener("keydown",d),t.addEventListener("keypress",d),setTimeout((()=>{c.focus(),o.cursor&&c.doc.setCursor(o.cursor)}),0),setTimeout((()=>c.refresh()),200);const a={getValue:()=>c.doc.getValue(),setValue:e=>c.doc.setValue(e),destroy:()=>{t.removeEventListener("keyup",d),t.removeEventListener("keydown",d),t.removeEventListener("keypress",d),n.destroy()}};return a},Q={},X=(e,t)=>{if(Q[t])return Promise.resolve();{const n=F(t),s=n.bind((e=>{var t;return S.from(null===(t=e.ui)||void 0===t?void 0:t.styleSheetLoader)})).getOr(tinymce.DOM.styleSheetLoader);return n.each((o=>{o.on("remove",(()=>{s.unload(e),delete Q[t]}))})),Q[t]=!0,o=e,(null!=(r=s)?r:tinymce.DOM.styleSheetLoader).load(o)}var o,r},Y=e=>({name:"codeview",type:"customeditor",tag:"div",scriptId:"tinymce.plugins.advcode.customeditor",scriptUrl:e.customEditorScriptUrl,settings:e}),Z=(e,t)=>{e.addCommand("mceCodeEditor",(()=>{h(e)&&!e.inline?"code"===e.mode.get()?e.mode.set("design"):e.mode.set("code"):(()=>{const o=p(e,t);((e,t)=>{const o=q(e),r={...t,cursor:o.cursor},n={title:"Source Code",size:"large",body:{type:"panel",items:[Y(r)]},buttons:[{type:"cancel",name:"cancel",text:"Cancel"},{type:"submit",name:"save",text:"Save",primary:!0}],initialData:{codeview:o.content},onSubmit:t=>{z(e,t.getData().codeview),t.close()}};e.windowManager.open(n)})(e,o)})()}))},ee=(e,t,o,r,n)=>{const s=q(o),i={...n,cursor:s.cursor},c=I("div");var d;d=c,((e,t)=>{for(let t=0,o=e.length;t<o;t++)$(d,e[t])})([0===t?"tox-inline-headless-codemirror":"tox-inline-codemirror","mce-codemirror"]),j(V(e),c);const{getValue:a,destroy:l}=r(c.dom,i,s.content);var u,m;1===t&&(u=V(c.dom),m=".CodeMirror",((e,t)=>{const o=void 0===t?document:t.dom;return 1!==(r=o).nodeType&&9!==r.nodeType&&11!==r.nodeType||0===r.childElementCount?S.none():S.from(o.querySelector(e)).map(V);var r})(m,u)).each((e=>$(e,"tox-view__pane_panel")));const g=()=>z(o,a());return 0===t&&o.on("BeforeGetContent",g),{syncWithEditor:g,destroy:()=>{0===t&&(o.off("BeforeGetContent",g),g()),G(c),l()}}},te=(e,t,o)=>{const r=(()=>{const e=(e=>{const t=(e=>{let t=e;return{get:()=>t,set:e=>{t=e}}})(S.none()),o=()=>t.get().each(e);return{clear:()=>{o(),t.set(S.none())},isSet:()=>t.get().isSome(),get:()=>t.get(),set:e=>{o(),t.set(S.some(e))}}})(_);return{...e,on:t=>e.get().each(t)}})(),n=()=>{r.get().each((({destroy:e})=>{e()})),r.clear()};e.ui.registry.addView("code",{buttons:1===o?[{type:"button",text:"Cancel",onAction:()=>{r.get().each((()=>{n(),e.mode.set("design")}))}},{type:"button",text:"Save code",buttonType:"primary",onAction:()=>{r.get().each((({syncWithEditor:t})=>{t(),n(),e.mode.set("design")}))}}]:[],onShow:n=>{const c=n.getContainer(),d=p(e,t);e.setProgressState(!0),((e,t,o)=>{return Promise.all([X(t,o),("tinymce.plugins.advcode.CodeMirror",r=e,tinymce.Resource.load("tinymce.plugins.advcode.CodeMirror",r))]).then((([e,t])=>(e,o,r)=>J(t(),e,o,r)));var r})(s(e),i(e),e.id).then((t=>{e.setProgressState(!1),r.set(ee(c,o,e,t,d))}))},onHide:n})};tinymce.PluginManager.requireLangPack("advcode","ar,bg_BG,ca,cs,da,de,el,es,eu,fa,fi,fr_FR,he_IL,hi,hr,hu_HU,id,it,ja,kk,ko_KR,ms,nb_NO,nl,pl,pt_BR,pt_PT,ro,ru,sk,sl_SI,sv_SE,th_TH,tr,uk,vi,zh_CN,zh_TW"),tinymce.PluginManager.add("advcode",((e,o)=>{((e,o)=>!!e&&-1===((e,o)=>{const r=t(e.major,o.major);if(0!==r)return r;const n=t(e.minor,o.minor);if(0!==n)return n;const s=t(e.patch,o.patch);return 0!==s?s:0})((e=>r((e=>[e.majorVersion,e.minorVersion].join(".").split(".").slice(0,3).join("."))(e)))(e),r(o)))(tinymce,"6.3.0")?console.error("The advcode plugin requires at least version 6.3.0 of TinyMCE."):((e,t)=>{((e,t)=>{const o=e.options.register;o("codemirror_script",{processor:"string",default:t+"/codemirror.min.js"}),o("codemirror_css",{processor:"string",default:t+"/codemirror.min.css"}),o("codemirror_linewrapping",{processor:"boolean",default:!0}),o("codemirror_linenumbers",{processor:"boolean",default:!0}),o("codemirror_foldgutter",{processor:"boolean",default:!0}),o("codemirror_gutter",{processor:"boolean",default:!0}),o("codemirror_theme",{processor:"string",default:"default"}),o("advcode_headless",{processor:"boolean",default:!1}),o("advcode_inline",{processor:"boolean",default:!1})})(e,t),Z(e,t),(e=>{const t="sourcecode",o=()=>e.execCommand("mceCodeEditor");e.ui.registry.addButton("code",{icon:t,tooltip:"Source code",onAction:o}),e.ui.registry.addMenuItem("code",{icon:t,text:"Source code",onAction:o})})(e),((e,t)=>{te(e,t,g(e)?0:1)})(e,t),(e=>{e.mode.register("code",{activate:()=>{"code"!==e.queryCommandValue("ToggleView")&&e.execCommand("ToggleView",!1,"code")},deactivate:()=>{"code"===e.queryCommandValue("ToggleView")&&e.execCommand("ToggleView",!1,"code")},editorReadOnly:!1})})(e)})(e,o)}))}();