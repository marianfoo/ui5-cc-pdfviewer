/*!
 * OpenUI5
 * (c) Copyright 2009-2023 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/base/util/each","sap/base/util/isPlainObject","sap/base/util/ObjectPath","sap/base/Log","sap/ui/core/util/reflection/JsControlTreeModifier","sap/ui/core/Core","sap/ui/fl/changeHandler/condenser/Classification","sap/ui/fl/apply/_internal/changes/Utils","sap/ui/fl/write/_internal/condenser/classifications/LastOneWins","sap/ui/fl/write/_internal/condenser/classifications/Reverse","sap/ui/fl/write/_internal/condenser/classifications/Update","sap/ui/fl/write/_internal/condenser/UIReconstruction","sap/ui/fl/write/_internal/condenser/Utils","sap/ui/fl/Change","sap/ui/fl/Utils","sap/ui/performance/Measurement","sap/base/util/restricted/_isEqual"],function(e,n,t,r,a,i,o,s,f,c,u,d,l,p,g,h,C){"use strict";var v={};var E="unclassified";var S={lastOneWins:f,reverse:c,update:u};var y=["affectedControl","sourceContainer","targetContainer","updateControl"];function I(e,n){var t=e[o.Move];return n.classification===o.Create&&t&&t[t.length-1].targetContainer===n.targetContainer}function _(e,n){return n.classification===o.Move&&e[o.Destroy]}function m(e,n){return n.classification===o.Create&&e[o.Destroy]}function O(e,n,t,r){if(!_(e,t)&&!m(e,t)){var a=t.classification;if(!e[a]){t.change=r;r.condenserState="select";e[a]=[t]}else{r.condenserState="delete"}e[a][0].updateChange=r}if(I(e,t)||m(e,t)){if(e[o.Move]){e[o.Move].forEach(function(e){e.change.condenserState="delete"});delete e[o.Move]}if(e[o.Destroy]){e[o.Destroy].forEach(function(e){e.change.condenserState="delete"});delete e[o.Destroy]}}return d.addChange(n,t)}function N(e,n,t){if(!e[n.classification]){e[n.classification]={}}var r=e[n.classification];S[n.classification].addToChangesMap(r,n,t);return Promise.resolve()}function T(e,n,t,r,a){if(!e[r.type]){e[r.type]={}}var i=e[r.type];if(r.type===l.NOT_INDEX_RELEVANT){return N(i,r,a)}t.push(a);return O(i,n,r,a)}function b(e,n,t){if(!e[n]){e[n]=[]}e[n].push(t);t.condenserState="select"}function A(e,n){var t=a.getControlIdBySelector(n.getSelector(),e);var r=i.byId(t);if(r){var o={modifier:a,appComponent:e,view:g.getViewForControl(r)};var f=s.getControlIfTemplateAffected(n,r,o);return Promise.resolve(s.getChangeHandler(n,f,o)).then(function(e){if(e&&typeof e.getCondenserInfo==="function"){return e.getCondenserInfo(n,o)}return undefined}).then(function(e){if(e&&f.bTemplateAffected){M(e,n)}return e}).catch(function(){return undefined})}return Promise.resolve()}function M(e,n){var t=n.getOriginalSelector();var r=n.getSelector();y.forEach(function(n){if(e[n]&&e[n]===r){e[n]=t}})}function x(e,n,t,r){var i=n!==undefined?n.affectedControl:a.getControlIdBySelector(t.getSelector(),r);if(!e[i]){e[i]={}}if(n&&n.updateControl){var o=n.updateControl;e[i]=Object.assign(e[i],e[o]);delete e[o]}return e[i]}function D(e,n,t,r,a){return a.reduce(function(a,i){return a.then(R.bind(this,e,n,t,r,i))}.bind(this),Promise.resolve())}function R(e,n,t,r,a){return A(e,a).then(function(i){P(i,e);var o=x(n,i,a,e);if(i!==undefined){w(i);return T(o,t,r,i,a).then(function(){if(i.update){U(o,i,a)}})}b(o,E,a);n[E]=true;return undefined})}function w(e){if(S[e.classification]){e.type=l.NOT_INDEX_RELEVANT}else{e.type=l.INDEX_RELEVANT}}function P(e,n){y.forEach(function(t){if(e&&e[t]){e[t]=a.getControlIdBySelector(e[t],n)}})}function U(e,n,r){var a=t.get([l.NOT_INDEX_RELEVANT,o.Update,n.uniqueKey],e);if(a){a.change.condenserState="delete";if(r.condenserState==="delete"){return}n.update(r,a.updateContent);if(r.getState()===p.states.PERSISTED){r.condenserState="update"}}}function L(t,r){e(t,function(e,a){if(S[e]&&S[e].getChangesFromMap){S[e].getChangesFromMap(t,e).forEach(function(e){r.push(e)})}else if(n(a)){return L(a,r)}else if(Array.isArray(a)){a.forEach(function(e){if(e instanceof p){r.push(e)}else{r.push(e.change)}})}});return r}function V(e){return L(e,[])}function X(t,r){e(t,function(e,t){if(n(t)){X(t,r)}else if(Array.isArray(t)){t.forEach(function(e){if(!(e instanceof p)){r.push(e)}})}});return r}function j(e,n){n.sort(function(n,t){return e.indexOf(n)-e.indexOf(t)})}function B(e,n){n.sort(function(n,t){return e.indexOf(n.change)-e.indexOf(t.change)})}function F(e,n){var t=e.map(function(e){return e.getId()});n.forEach(function(n){if(t.indexOf(n.getId())===-1){e.push(n)}})}function W(e,n){e.forEach(function(e){var t=e.updateChange;if(t&&!C(t.getContent(),e.change.getContent())&&t.getState()!==p.states.NEW){var r=e.change;if(t.getId()!==r.getId()){var a=r.getContent();t.setContent(a);r.condenserState="delete";n=n.map(function(e){if(e.getId()===r.getId()){return t}return e})}else{t.setState(p.states.DIRTY)}t.condenserState="update"}});return n}v.condense=function(e,n){h.start("Condenser_overall","Condenser overall - CondenserClass",["sap.ui.fl","Condenser"]);var t={};var a={};var i=[];var o=[];var s=[];n.slice(0).reverse().forEach(function(e){if(e instanceof p&&e.isSuccessfullyApplied()){s.push(e)}else{o.push(e)}});h.start("Condenser_defineMaps","defining of maps - CondenserClass",["sap.ui.fl","Condenser"]);return D(e,t,a,i,s).then(function(){h.end("Condenser_defineMaps");var e=t[E];if(!e){d.compareAndUpdate(t,a)}var s=V(t);if(e){i.forEach(function(e){e.condenserState="select"});F(s,i)}s=s.concat(o);j(n,s);if(!e){h.start("Condenser_handleIndexRelatedChanges","handle index related changes - CondenserClass",["sap.ui.fl","Condenser"]);var f=true;var c=X(t,[]);B(n,c);var u;try{h.start("Condenser_sort","sort index related changes - CondenserClass",["sap.ui.fl","Condenser"]);u=d.sortIndexRelatedChanges(a,c)}catch(e){r.error("Error during Condensing: "+e.message,"No Condensing performed for index-relevant changes.");f=false}h.end("Condenser_sort");if(f){s=W(c,s);j(n,s);u.forEach(function(e){d.swapChanges(e,s)})}else{i.forEach(function(e){e.condenserState="select"});F(s,i);j(n,s)}h.end("Condenser_handleIndexRelatedChanges")}h.end("Condenser_overall");return s})};return v});
//# sourceMappingURL=Condenser.js.map