/*
 * ! SAPUI5

(c) Copyright 2009-2020 SAP SE. All rights reserved
 */
sap.ui.define(["sap/ui/thirdparty/jquery","sap/ui/base/ManagedObject","sap/m/MessageBox","sap/ui/comp/smartform/SmartForm","sap/ui/comp/smartform/Group","sap/ui/comp/smartform/GroupElement","sap/ui/comp/smartfield/SmartField","sap/ui/comp/smartfield/SmartLabel","sap/m/Dialog","sap/ui/generic/app/util/ModelUtil","sap/m/VBox","sap/m/Text","sap/base/strings/formatMessage","sap/base/Log"],function(jQuery,e,t,r,a,o,n,i,s,l,p,u,c,m){"use strict";var f=e.extend("sap.ui.generic.app.util.ActionUtil",{metadata:{properties:{controller:{type:"object",group:"Misc",defaultValue:null},applicationController:{type:"object",group:"Misc",defaultValue:null},contexts:{type:"object",group:"Misc",defaultValue:null},successCallback:{type:"function",group:"Misc",defaultValue:null},operationGrouping:{type:"string",group:"Misc",defaultValue:null}}}});f.prototype._getObjectsDifference=function(e,t){var r=[];var a=Object.keys(e);for(var o=0;o<a.length;o++){if(e[a[o]]!==t[a[o]]){r.push(a[o])}}return r};f.prototype.call=function(e,r,a,o,n,i){var s=this;return new Promise(function(l,p){var u;s._oActionPromiseCallback={resolve:l,reject:p};s._sFunctionImportPath=e;var m=s.getController();if(!m||!m.getView()){p("No View Controller provided")}s._oMetaModel=m.getView().getModel().getMetaModel();var f=e.split("/")[1];s._oFunctionImport=s._oMetaModel.getODataFunctionImport(f);s._sFunctionImportLabel=r||f;s._oSkipProperties=o||{};var d=function(){var e=s.getContexts();u=s._prepareParameters(e,a,i);u=u||[{}];u.expand=i?i.expand:undefined;var t=s.getApplicationController().getTransactionController().getDefaultValues(e,u.map(function(e){return e.parameterData}),undefined,f);if(t instanceof Promise){var r=function(e){for(var t=0;t<u.length;t++){u[t].propertiesOverridenByDefault=s._getObjectsDifference(u[t].parameterData,e[t]);u[t].parameterData=e[t]}s._initiateCall(u,a,n)};t.then(r,r)}else{s._initiateCall(u,a,n)}};if(!s._oFunctionImport){p("Unknown Function Import "+f)}if(s._isActionCritical()){var g="ACTION_CONFIRM|"+f;var v;var h=m.getOwnerComponent().getAppComponent&&m.getOwnerComponent().getAppComponent().getModel("i18n")&&m.getOwnerComponent().getAppComponent().getModel("i18n").getResourceBundle();if(h&&h.hasText(g)){v=h.getText(g)}else{v=sap.ui.getCore().getLibraryResourceBundle("sap.ui.generic.app").getText("ACTION_CONFIRM");v=c(v,s._sFunctionImportLabel)}t.confirm(v,{title:s._sFunctionImportLabel,onClose:function(e){if(e==="OK"){d()}else if(e==="CANCEL"){s._oActionPromiseCallback.reject()}},sClass:s._getCompactModeStyleClass()})}else{d()}})};f.prototype._getCompactModeStyleClass=function(){if(this.getController().getView().$().closest(".sapUiSizeCompact").length){return"sapUiSizeCompact"}return""};f.prototype._isActionCritical=function(){var e=this._oFunctionImport["com.sap.vocabularies.Common.v1.IsActionCritical"];if(!e){return false}if(e.Bool===undefined){return true}return this._toBoolean(e.Bool)};f.prototype._toBoolean=function(e){if(typeof e==="string"){var t=e.toLowerCase();return!(t=="false"||t==""||t==" ")}return!!e};f.prototype._prepareParameters=function(e,t,r){if(!Array.isArray(e)&&!e.length){return undefined}var a=[];e.forEach(function(e){var o=null;var n=e.getObject();if(e&&e.getPath()){var i=l.getEntitySetFromContext(e);var s=e.getModel().getMetaModel().getODataEntitySet(i,false);o=e.getModel().getMetaModel().getODataEntityType(s.entityType,false)}var p=this._getPropertyKeys(o);var u;var c={parameterData:{},additionalParameters:[],isDraftEnabled:t};if(this._oFunctionImport.parameter){for(var f=0;f<this._oFunctionImport.parameter.length;f++){var d=this._oFunctionImport.parameter[f];this._addParameterLabel(d,o);var g=d.name;var v=!!p[g];u=undefined;if(g==="ResultIsActiveEntity"){if(d.nullable!=="false"){continue}u=false}if(n&&n.hasOwnProperty(g)){u=n[g]}else if(v&&n&&this._oFunctionImport["sap:action-for"]){m.error("Key parameter of action not found in current context: "+g);throw new Error("Key parameter of action not found in current context: "+g)}c.parameterData[g]=r&&r[g]||u;var h=!!this._oSkipProperties[g];if(!h&&(!v||!this._oFunctionImport["sap:action-for"])&&d.mode.toUpperCase()=="IN"){c.additionalParameters.push(d)}}a.push(c)}else{a.push(c)}}.bind(this));return a};f.prototype._getPropertyKeys=function(e){var t={};if(e&&e.key&&e.key.propertyRef){for(var r=0;r<e.key.propertyRef.length;r++){var a=e.key.propertyRef[r].name;t[a]=true}}return t};f.prototype._setAdditionalParameters=function(e,t,r,a,o){e.forEach(function(e){if(t===e.name){if(e.hasOwnProperty("com.sap.vocabularies.UI.v1.Hidden")||o&&o.includes(t)){a.oModel.setProperty(t,r[t],a)}else{a.oModel.setProperty(t,undefined,a)}}})};f.prototype._initiateCall=function(e,r,a){var o=e[0];var i=a?"strict":"lenient";var l={Prefer:"handling="+i};if(o!=undefined&&o.additionalParameters&&o.additionalParameters.length==0){this._call(o.parameterData,o.isDraftEnabled,l)}else if(o!=undefined&&o.additionalParameters&&o.additionalParameters.length>0){var m=this;var f={urlParameters:{},headers:l,expand:e.expand};var d=this.getContexts();var g=this.getApplicationController()._getChangeSetFunc(d,this.getOperationGrouping());var v=d.map(function(e,t){f.changeSetId=g(t);return this.getApplicationController().getNewActionContext(this._sFunctionImportPath,e,f)}.bind(this));var h=v.map(function(e){return e.context});Promise.all(h).then(function(r){var i=r[0];var l=o.additionalParameters.map(function(e){return e.name});r.forEach(function(t,a){var o=e[a].parameterData;for(var n in o){if(r.length>1&&l.indexOf(n)>-1){m._setAdditionalParameters(e[a].additionalParameters,n,o,t,e[a].propertiesOverridenByDefault)}else{t.oModel.setProperty(n,o[n],t)}}});if(a){var f=m._buildParametersForm(o,i);var g=false;var h=new s({title:m._sFunctionImportLabel,content:[f.form],beginButton:new sap.m.Button({text:m._sFunctionImportLabel,type:"Emphasized",press:function(e){if(f.hasNoClientErrors()){if(f.getEmptyMandatoryFields().length==0){h.close();g=m._triggerActionPromise(v,d,o,r,a)}else{var n=new p;var i=sap.ui.getCore().getLibraryResourceBundle("sap.ui.generic.app").getText("ACTION_MISSING_MANDATORY");for(var s=0;s<f.getEmptyMandatoryFields().length;s++){var l=c(i,f.getEmptyMandatoryFields()[s].getTextLabel());n.addItem(new u({text:l}))}t.error(n,{sClass:m._getCompactModeStyleClass()})}}}}),endButton:new sap.m.Button({text:sap.ui.getCore().getLibraryResourceBundle("sap.ui.generic.app").getText("ACTION_CANCEL"),press:function(){v[0].abort();h.close();m._oActionPromiseCallback.reject();g=true}}),afterClose:function(e){h.destroy();if(!g){m._oActionPromiseCallback.reject()}}}).addStyleClass("sapUiNoContentPadding");h.addStyleClass(m._getCompactModeStyleClass());h.setModel(i.oModel);if(this.getController().getView().getModel("@i18n")){h.setModel(this.getController().getView().getModel("@i18n"),"@i18n")}var y=h.getAggregation("content")[0].mAggregations["content"];var C=y.getFormContainers()[0].getFormElements();var b=true;for(var _=0;_<C.length;_++){var P=C[_].getFields()[0];if(P instanceof n&&P.getVisible()===true){b=false;break}}if(C.length===0||b){m._triggerActionPromise(v,d,o,r,a);h.destroy()}else{h.open()}}else{m._triggerActionPromise(v,d,o,r)}}.bind(this))}else{this._call(null,o!=undefined?o.isDraftEnabled:r,l)}};f.prototype._triggerActionPromise=function(e,t,r,a,o){var n=this;var i={};n._oActionPromiseCallback.resolve({executionPromise:n.getApplicationController()._newPromiseAll(e.map(function(e){return e.result})).then(function(e){n._bExecutedSuccessfully=n.getApplicationController()._checkAtLeastOneSuccess(t,e);if(o){e.forEach(function(e){e.userEnteredAdditionalParams=i})}if(n._bExecutedSuccessfully){return e}else{return Promise.reject(e)}},function(e){n._bExecutedSuccessfully=false;e.forEach(function(e){e.userEnteredAdditionalParams=i});throw e})});var s=a[0].getObject();r.additionalParameters.forEach(function(e){var t=s[e.name];if(e.type=="Edm.Boolean"&&t==undefined){s[e.name]=false;t=false}i[e.name]=t;a.forEach(function(r){r.oModel.setProperty(e.name,t,r)})});var l=n._sFunctionImportPath.split("/")[1];t.forEach(function(e,t){n.getApplicationController().submitActionContext(e,a[t],l)});if(o){return true}};f.prototype._call=function(e,t,r){var a=this.getContexts();var o={urlParameters:e,operationGrouping:this.getOperationGrouping(),triggerChanges:t,headers:r};var n=this.getController();var i=this.getApplicationController()||n.getApplicationController();var s=this;s._oActionPromiseCallback.resolve({executionPromise:i.invokeActions(this._sFunctionImportPath,a,o).then(function(e){s._bExecutedSuccessfully=true;return e},function(e){s._bExecutedSuccessfully=false;throw e})})};f.prototype._getActionParameterData=function(e){var t=[];var r=e.getObject("/");var a={};for(var o=0;o<this._oFunctionImport.parameter.length;o++){var n=this._oFunctionImport.parameter[o];var i=n.name;if(r.hasOwnProperty(i)){var s=r[i];if(s===undefined){if(!this._toBoolean(n.nullable)){if(n.type==="Edm.Boolean"){a[i]=false}else{t.push(n)}}}else{a[i]=s}}else{throw new Error("Unknown parameter: "+i)}}return{preparedParameterData:a,missingMandatoryParameters:t}};f.prototype._buildParametersForm=function(e,t){var s=new r({editable:true});s.setBindingContext(t);var l;var p=[];var u;var c;var m=new a;for(var f=0;f<e.additionalParameters.length;f++){var d=e.additionalParameters[f];if(d["com.sap.vocabularies.UI.v1.Hidden"]&&!d["com.sap.vocabularies.UI.v1.Hidden"].Path&&!(d["com.sap.vocabularies.UI.v1.Hidden"].Bool==="false")){continue}c=d["com.sap.vocabularies.Common.v1.ValueListWithFixedValues"]?"fixed-values":undefined;if(c==undefined){c=d["sap:value-list"]=="fixed-values"?"fixed-values":undefined}l=new n("ActionUtil-"+this._sFunctionImportPath.replace("/","-")+"-"+d.name,{value:"{"+d.name+"}",textLabel:this._getParameterName(d),width:"100%"});l.data("configdata",{configdata:{isInnerControl:false,path:d.name,entitySetObject:{},annotations:{valuelist:d["com.sap.vocabularies.Common.v1.ValueList"],valuelistType:c},modelObject:t.oModel,entityType:d.type,property:{property:d,typePath:d.name}}});if(d.nullable=="false"){l.setMandatory(true)}p.push(l);u=new i;u.setLabelFor(l);var g=new o;g.addElement(l);m.addGroupElement(g)}s.addGroup(m);var v=function(){var e=true;for(var t=0;t<p.length;t++){if(p[t].getValueState()!="None"){e=false;break}}return e};var h=function(){var e=jQuery.grep(p,function(e){return e.getMandatory()==true&&e.getValue()==""&&e.getDataType()!="Edm.Boolean"});return e};return{form:s,hasNoClientErrors:v,getEmptyMandatoryFields:h}};f.prototype._getParameterName=function(e){return e["com.sap.vocabularies.Common.v1.Label"]?e["com.sap.vocabularies.Common.v1.Label"].String:e.name};f.prototype._addParameterLabel=function(e,t){if(t&&e&&!e["com.sap.vocabularies.Common.v1.Label"]){var r=this._oMetaModel.getODataProperty(t,e.name,false);if(r&&r["com.sap.vocabularies.Common.v1.Label"]){e["com.sap.vocabularies.Common.v1.Label"]=r["com.sap.vocabularies.Common.v1.Label"]}}};f.prototype.getFunctionImportLabel=function(){return this._sFunctionImportLabel};f.prototype.getExecutedSuccessfully=function(){return this._bExecutedSuccessfully};return f});
//# sourceMappingURL=ActionUtil.js.map