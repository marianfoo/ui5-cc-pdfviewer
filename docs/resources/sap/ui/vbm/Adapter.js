/*
 * ! SAP UI development toolkit for HTML5 (SAPUI5) (c) Copyright 2009-2012 SAP AG. All rights reserved
 */
sap.ui.define(["sap/ui/core/Element","jquery.sap.global","sap/base/Log","./library"],function(t,jQuery,e,i){"use strict";var a="sap.ui.vbm.Adapter";var n=t.extend("sap.ui.vbm.Adapter",{metadata:{library:"sap.ui.vbm",associations:{map:{type:"sap.ui.vbm.GeoMap"}},events:{submit:{parameters:{data:{type:"string"}}}}}});n.prototype.init=function(){this._eventHandlers=[];this._actions=[];this._mapConfiguration={};this._clusterVOs=new Map;this._dataTypes={};this._data={};this._idKeyMap={};this._propsAnomalies=new Map;this._propsAnomalies.set("pos","position");this._propsAnomalies.set("posarray","position");this._propsAnomalies.set("dragdata","dragData");this._routeProperties=["color","colorBorder","directionIndicator","dotcolor","dotwidth","dragdata","end","hotDeltaColor","labelBgColor","labelPos","labelText","lineDash","linewidth","posarray","selectColor","start","tooltip"];this._areaProperties=["key","color","colorBorder","posarray","selectColor","dragdata","VB:s","VB:c","hotScale","hotDeltaColor","borderDash","selectColor","fxdir","fxsize","entity","labelBgColor","labelBorderColor","labelPos","labelText","labelArrow","label","labelAlignment","tooltip"];this._spotProperties=["alignment","contentOffset","dragdata","fxdir","fxsize","hotDeltaColor","icon","image","labelBgColor","labelPos","labelText","pos","selectColor","tooltip","semanticType"]};n.prototype.exit=function(){this._actions.forEach(function(t){t.detach()});this._detachHandlers()};n.prototype.setMap=function(t){var e=this._map()||null;var i=sap.ui.getCore().byId(t instanceof sap.ui.vbm.GeoMap?t.getId():t);if(e!=i&&e!=null){this._detachHandlers();this.init()}this.setAssociation("map",t,true);if(i!=null){var a=new sap.ui.model.json.JSONModel;a.setSizeLimit(1e5);i.setModel(a)}};n.prototype._map=function(){return sap.ui.getCore().byId(this.getMap())};n.prototype._attachHandler=function(t,e,i){if(t in this.mEventRegistry&&this.mEventRegistry[t].length>0){return this}else{if(!i._eventHandlers.some(function(t){return t===e})){i._eventHandlers.push(e)}this.attachEvent(t,e,i);return this}};n.prototype._detachHandlers=function(){var t=this;var e=function(e){if(this.hasListeners(e)){var i=this.mEventRegistry[e];for(var a=0,n=i.length;a<n;a++){var r=t._eventHandlers.indexOf(i[a].fFunction);if(r!==-1){this.detachEvent(e,i[a].fFunction,i[a].oListener)}}}};var i=this._map();if(i!=null){var a=i.mEventRegistry;for(var n in a){if(a.hasOwnProperty(n)){e.call(i,n)}}var r=function(t){var i=t.mEventRegistry;for(var a in i){if(i.hasOwnProperty(a)){e.call(t,a)}}};i.getVos().forEach(r)}return this};n.prototype.load=function(t){var i=null;if(typeof t==="string"){try{i=JSON.parse(t)}catch(t){e.debug("attempt to load invalid JSON string","",a);return this}}else if(typeof t==="object"){i=t}if(!i){e.debug("nothing to load","",a);return this}if(!i.SAPVB){e.debug("invalid object supplied for load","",a);return this}if(i.SAPVB.Config){this._processConfiguration(i.SAPVB.Config)}if(i.SAPVB.Resources){this._processResources(i.SAPVB.Resources)}if(i.SAPVB.DataTypes){this._processDataTypes(i.SAPVB.DataTypes)}if(i.SAPVB.Clustering){this._processClusters(i.SAPVB.Clustering)}return(i.SAPVB.MapProviders?this._processMapProviders(i.SAPVB.MapProviders):Promise.resolve()).then(function(){if(i.SAPVB.MapLayerStacks){this._processMapLayerStacks(i.SAPVB.MapLayerStacks)}if(i.SAPVB.Scenes){this._processScenes(i.SAPVB.Scenes)}if(i.SAPVB.Data){this._processData(i.SAPVB.Data)}if(i.SAPVB.Actions){this._processActions(i.SAPVB.Actions)}if(i.SAPVB.Automation&&i.SAPVB.Automation.Call){this._processAutomation(i.SAPVB.Automation,i.SAPVB.Menus)}if(i.SAPVB.Windows){this._processDetailWindows(i)}}.bind(this))};n.prototype._processConfiguration=function(t){return this};n.prototype._processResources=function(t){if(t.Set){var e=this._map();e.destroyResources();[].concat(t.Set.Resource).forEach(function(t){e.addResource(new sap.ui.vbm.Resource({name:t.name,value:t.value}))},this)}return this};n.prototype._processDataTypes=function(t){if(t.Set){if(t.Set.name&&t.Set.type&&t.Set.type==="N"){[].concat(t.Set.N).foreach(function(t){this._dataTypes.forEach(function(e){if(e.name==t.name){e=t}})})}else{this._dataTypes=[].concat(t.Set.N)}}return this};n.prototype._processData=function(t){var e=function(t,e){var i=sap.ui.vbm.findInArray(this._dataTypes,function(t){return t.name==e});if(i==null||!i.A){return undefined}else{var a=sap.ui.vbm.findInArray(i.A,function(e){return e.alias==t});if(a!=null){return a.name}else{return undefined}}};var i=function(t){if(t.name&&t.E){this._data[t.name]=[].concat(t.E).map(function(i){var a={};for(var n in i){if(n!=="xmlns:VB"&&n!=="n.name"&&i.hasOwnProperty(n)){if(n==="VB:c"){a["changeable"]=i[n]}else if(n==="VB:s"){a["select"]=i[n]}else{var r=e.call(this,n,t.name);if(r!=null&&r!==""){a[r]=i[n]}else{a[n]=i[n]}}}}return a},this)}};var a=function(t){var i={};for(var a in t){if(a!=="xmlns:VB"&&a!=="n.name"&&t.hasOwnProperty(a)){if(a==="VB:c"){i["changeable"]=t[a]}else if(a==="VB:s"){i["select"]=t[a]}else{var n=e.call(this,a,t["n.name"]);if(n!=null&&n!==""){i[n]=t[a]}else{i[a]=t[a]}}}}if(!this._data[t["n.name"]]){this._data[t["n.name"]]=[]}if(this._data[t["n.name"]].some(function(e){return e.Key==t.K})){var r=sap.ui.vbm.findIndexInArray(this._data[t["n.name"]],function(e){return e.Key===t.K});if(r!==-1){this._data[t["n.name"]][r]=i}}else{this._data[t["n.name"]].push(i)}};if(t.Remove){[].concat(t.Remove).filter(function(t){return t.N&&t.N.E}).forEach(function(t){[].concat(t.N.E).forEach(function(e){var i=sap.ui.vbm.findIndexInArray(this._data[t.name],function(t){return t.Key===e.K});if(i!==-1){this._data[t.name].splice(i,1)}},this)},this)}if(t.Set&&typeof t.Set==="object"&&!jQuery.isEmptyObject(t.Set)){if(!Array.isArray(t.Set)&&!t.Set.name&&!t.Set.type){this._data={};if(t.Set.N!==null){[].concat(t.Set.N).forEach(i,this)}}else{[].concat(t.Set).filter(function(t){return t.name&&t.type}).map(function(t){return[].concat(t.N)}).reduce(function(t,e){return t.concat(e)}).map(function(t){var e=t.hasOwnProperty("E")&&t.E?[].concat(t.E):[];return e.map(function(e){e["n.name"]=t.name;return e})}).reduce(function(t,e){return t.concat(e)}).forEach(a,this)}}this._map().getModel().setData(this._data,false);return this};n.prototype._processMapProviders=function(t){if(t.Set&&t.Set.MapProvider){var i=[].concat(t.Set.MapProvider).map(function(t){return{name:t.name,tileX:t.tileX,tileY:t.tileY,minLOD:t.minLOD,maxLOD:t.maxLOD,copyright:t.copyright,MapBase:t.MapBase,copyrightImage:t.copyrightImage,copyrightLink:t.copyrightLink,description:t.description,projection:t.projection,resolution:t.resolution,retries:t.retries,type:t.type,Header:t.Header?[].concat(t.Header).map(function(t){return{name:t.name,value:t.value}}):t.Header,Source:t.Source?[].concat(t.Source).map(function(t){return{id:t.id,url:t.url}}):t.Source}});var n=function(t){return t&&t.url&&t.url.indexOf("google")!==-1};var r=i.map(function(t){return[].concat(t.Source)}).reduce(function(t,e){return t.concat(e)}).filter(n);if(r.length>0){var s=[];var o=r.reduce(function(t,e){var i=e.url.split("key=")[1];t[i]=t[i]||[];if(sap.ui.vbm.findIndexInArray(s,function(t){return t===i})===-1){s.push(i)}t[i].push(e);return t},{});var c=function(t){return new Promise(function(e,i){var a=new XMLHttpRequest;a.open("POST","https://www.googleapis.com/tile/v1/createSession?key="+t,true);a.setRequestHeader("Content-Type","application/json");a.onreadystatechange=function(){if(a.readyState==4){if(a.status==200){e(JSON.parse(a.responseText))}else{i(new Error(a.statusText))}}};var n={mapType:"terrain",language:"en-NZ",region:"nz",layerTypes:["layerRoadmap"],overlay:false,scale:"scaleFactor1x"};a.send(JSON.stringify(n))}).then(function(e){if(e&&e.session){o[t].forEach(function(t){t.url=t.url+"&session="+e.session})}},function(t){e.debug(t,"",a)})};return Promise.all(s.map(c)).then(function(){this._mapConfiguration.MapProvider=i;this._updateMapconfiguration()}.bind(this))}else{this._mapConfiguration.MapProvider=i;this._updateMapconfiguration();return Promise.resolve()}}return this};n.prototype._processMapLayerStacks=function(t){if(t.Set&&t.Set.MapLayerStack){this._mapConfiguration.MapLayerStacks=[];[].concat(t.Set.MapLayerStack).forEach(function(t){var e={name:t.name},i="true";if(t.MapLayer){e.MapLayer=[];[].concat(t.MapLayer).forEach(function(t){var a={name:t.name,refMapProvider:t.refMapProvider,opacity:t.opacity,colBkgnd:t.colBkgnd,singleBMP:t.singleBMP||"false"};i=a.singleBMP!=="true"?"false":i;e.MapLayer.push(a)});e.singleBMP=t.singleBMP||i}this._mapConfiguration.MapLayerStacks.push(e)},this);this._updateMapconfiguration()}return this};n.prototype._updateMapconfiguration=function(){if(this._mapConfiguration.MapProvider&&this._mapConfiguration.MapLayerStacks){this._map().setMapConfiguration(this._mapConfiguration)}return this};n.prototype._ui5Id=function(t){return this._map().getId()+"-"+t};n.prototype._processScenes=function(t){if(t.Set&&t.Set.SceneGeo){var i=this._map();if(t.Set.SceneGeo.initialStartPosition){i.setCenterPosition(t.Set.SceneGeo.initialStartPosition)}if(t.Set.SceneGeo.initialZoom){i.setZoomlevel(Math.floor(t.Set.SceneGeo.initialZoom))}if(t.Set.SceneGeo.refMapLayerStack){i.setRefMapLayerStack(t.Set.SceneGeo.refMapLayerStack)}var n=t.Set.SceneGeo.VO;i.destroyVos();if(!n){return this}n.forEach(function(t){if(this._clusterVOs.has(t.id)){return}var n,r,s=[],o={};function c(e,i){for(var a in t){var n=a.indexOf(".bind");var r=n!==-1?a.substring(0,n):a;if(e.indexOf(r)!==-1){r=i.get(r)||r;var c=t[a];if(n!==-1){c=t[a].substring(t[a].indexOf(".")+1);s.push(c)}o[r]=n!==-1?"{"+c+"}":c}}}function u(){if(t.DragSource&&r.getMetadata().hasAggregation("dragSource")){[].concat(t.DragSource.DragItem).forEach(function(t){r.addDragSource(new sap.ui.vbm.DragSource({type:t.type}))})}if(t.DropTarget&&r.getMetadata().hasAggregation("dropTarget")){[].concat(t.DropTarget.DropItem).forEach(function(t){r.addDropTarget(new sap.ui.vbm.DropTarget({type:t.type}))})}}switch(t.type){case"{00100000-2012-0004-B001-64592B8DB964}":c(this._spotProperties,this._propsAnomalies);n=new sap.ui.vbm.Spot(o);r=new sap.ui.vbm.Spots(this._ui5Id(t.id));u();break;case"{00100000-2012-0004-B001-C46BD7336A1A}":c(this._routeProperties,this._propsAnomalies);n=new sap.ui.vbm.Route(o);r=new sap.ui.vbm.Routes(this._ui5Id(t.id));u();break;case"{00100000-2012-0004-B001-F311DE491C77}":c(this._areaProperties,this._propsAnomalies);n=new sap.ui.vbm.Area(o);r=new sap.ui.vbm.Areas(this._ui5Id(t.id));u();break;case"{00100000-2014-0004-BDA8-87B904609063}":case"{00100000-2014-0004-B001-9F1B43BE944A}":case"{00100000-2013-0004-B001-7EB3CCC039C4}":case"{00100000-2013-0004-B001-686F01B57873}":case"{00100000-2012-0004-B001-BFED458C3076}":case"{00100000-2012-0004-B001-383477EA1DEB}":case"{388951f5-a66b-4423-a5ad-e0ee13c2246f}":default:e.debug("unsupported VO type",t.type,a);return}var f=sap.ui.vbm.findIndexInArray(this._dataTypes,function(e){return e.name===t.datasource});if(f!==-1){var p=this._dataTypes[f];n.bindProperty("key",{path:p.key});s.push(p.key);var h=[];p.A.forEach(function(t){if(s.indexOf(t.name)===-1){h.push(t.name);var e=new sap.ui.core.CustomData({key:t.name,value:"{"+t.name+"}"});n.addCustomData(e)}});if(h.length){r.setCustomProperties(h)}r.bindAggregation("items",{path:"/"+t.datasource+"",template:n})}else{r.addItem(n)}i.addVo(r)}.bind(this))}else if(t.Merge&&t.Merge.SceneGeo&&t.Merge.SceneGeo.refMapLayerStack){this._map().setRefMapLayerStack(t.Merge.SceneGeo.refMapLayerStack)}return this};function r(t,e){Object.assign(this,t);this._adapter=e;if(!this.refVO){this.refVO="General"}}r.prototype.attach=function(){var t=false;this._listener=this._adapter;this._handler=this._adapter._handler;if(this.refVO==="Map"||this.refVO==="General"){this._target=this._adapter._map()}else{var i=this._adapter._ui5Id(this.refVO);this._target=sap.ui.vbm.findInArray(this._adapter._map().getVos(),function(t){return t.getId()===i});if(!this._target){this._target=this._adapter._clusterVOs.get(this.refVO);t=!!this._target}}if(!this._target){e.warning("unable to attach action",this.id,a);return false}switch(this.refEvent){case"Click":this._event="click";if(t){this._listener=this;this._handler=function(t){this._adapter._handler(t,this)}}break;case"ContextMenu":this._event="contextMenu";if(t){this._listener=this;this._handler=function(t){this._adapter._handler(t,this)}}break;case"DoubleClick":this._event="click";this._handler=this._adapter._clickHandler;if(t){this._listener=this;this._handler=function(t){this._adapter._clickHandler(t,this)}}break;case"Drop":this._event="drop";break;case"CreateComplete":this._event="createComplete";break;case"Select":this._event="select";break;case"KeyPress":if(this._target!==this._adapter._map()){return false}this._event="keyDown";this._target.setKeyEventDelay(250);this._target.setAllowKeyEventRepeat(false);this._handler=this._adapter._getKeyboardHandler(this.name);break;default:if(this.refEvent&&this.name){e.info("No UI5 event found to attach action to. Falling through to default vbi event handling.",this.name,a);this._event=this.name}else{e.error("Action invalid. No refEvent or name supplied.",this,a);return false}}this._target.attachEvent(this._event,this._handler,this._listener);this._target.invalidate();return true};r.prototype.detach=function(){if(this._target&&this._event&&this._handler&&this._listener){this._target.detachEvent(this._event,this._handler,this._listener);this._target.invalidate();this._target=this._event=this._handler=this._listener=undefined}};n.prototype._removeAction=function(t){var e=this._actions[t];e.detach();this._actions.splice(t,1);if(e.refEvent==="DoubleClick"){var i=sap.ui.vbm.findInArray(this._actions,function(t){return t.refVO===e.refVO&&t.refEvent==="Click"});if(i){i.attach()}}};n.prototype._addAction=function(t){var i=new r(t,this);if(t.refEvent==="Click"){if(this._actions.some(function(e){return e.refVO===t.refVO&&e.refEvent==="DoubleClick"},this)){this._actions.push(i);return}}else if(t.refEvent==="DoubleClick"){var n=sap.ui.vbm.findInArray(this._actions,function(e){return e.refVO===t.refVO&&e.refEvent==="Click"},this);if(n){n.detach()}}if(i.attach()){this._actions.push(i)}else{e.info("unable to attach action",t.id,a)}};n.prototype._processActions=function(t){var i,n;if(t.Remove){if(t.Remove.Action){i=[].concat(t.Remove.Action)}else{i=[].concat(t.Remove)}i.forEach(function(t){n=sap.ui.vbm.findIndexInArray(this._actions,function(e){return e.id===t.id});if(n!==-1){this._removeAction(n)}else{e.info("remove of nonexistent action",t.id,a)}},this)}if(t.Set){if(t.Set.Action){i=[].concat(t.Set.Action)}else{i=[].concat(t.Set)}i.forEach(function(t){n=sap.ui.vbm.findIndexInArray(this._actions,function(e){return e.id===t.id});if(n!==-1){this._removeAction(n)}this._addAction(t)},this)}return this};n.prototype._getKeyboardHandler=function(t){return function(e){var i=e.mParameters;if(i.key=="Shift"||i.code==16||i.key=="Control"||i.code==17||i.key=="Alt"||i.code==18||i.key=="Meta"||i.code==91){return}var a={version:"2.0","xmlns:VB":"VB",Action:{name:t,Params:{Param:[{name:"code","#":i.code},{name:"shift","#":i.shift},{name:"ctrl","#":i.ctrl},{name:"alt","#":i.alt},{name:"meta","#":i.meta}]}}};this.fireSubmit({data:JSON.stringify(a)})}};n.prototype.idKeyMapGenerator=function(){this._map().getVos().map(function(t){return t.getItems()}).reduce(function(t,e){return t.concat(e)}).forEach(function(t){this._idKeyMap[t.getUniqueId()]=t.getKey()},this);return this};n.prototype._processAutomation=function(t,e){var i={};if(t.Call.handler==="CONTEXTMENUHANDLER"){var a=this;var n=this._map();if(t.Call.instance&&t.Call.instance.split(".").length==2){var r=this._map().getVos().map(function(t){return t.getItems()}).reduce(function(t,e){return t.concat(e)}).filter(function(e){return e.getKey()===t.Call.instance.split(".")[1]});if(r.length>0){n=r[0];t.Call.instance=n.getUniqueId();t.Call.object=a._ui5Id(t.Call.object)}}if(e.Set.Menu){[].concat(e.Set.Menu).forEach(function(t){a._attachHandler.call(n,t.action,function(t){var e;if(t.oSource===a._map()){e=t.getParameters();if(e.Action.object.startsWith(this._map().getId())){e.Action.object=e.Action.object.substr(this._map().getId().length+1)}if(e.id&&e.hasOwnProperty("id")){delete e.id}}else{e=t.getParameters().data;if(e.Action.object.startsWith(this._map().getId())){e.Action.object=e.Action.object.substr(this._map().getId().length+1)}e.Action.instance=e.Action.object+"."+t.oSource.getKey()}if(e.Data&&e.Data.Merge&&e.Data.Merge.N){[].concat(e.Data.Merge.N).forEach(function(t){if(t.name&&t.name.startsWith(this._map().getId())){t.name=t.name.substr(this._map().getId().length+1)}},this);var i=e.Data.Merge.N.map(function(t){return t.E}).reduce(function(t,e){return t.concat(e)}).map(function(t){return t.K});if(jQuery.isEmptyObject(this._idKeyMap)){this.idKeyMapGenerator()}if(i.some(function(t){return!this._idKeyMap.hasOwnProperty(t)},this)){this.idKeyMapGenerator()}var n=function(t){t.K=this._idKeyMap[t.K]};[].concat(e.Data.Merge.N).map(function(t){return t.E}).reduce(function(t,e){return t.concat(e)}).forEach(n,this)}this.fireSubmit({data:JSON.stringify(e)})},a)})}}i["Automation"]=t;i["Menus"]=e;var s={};s["SAPVB"]=i;this._map().load(s);return this};n.prototype._processClusters=function(t){this._clusterVOs.clear();if(t.Set){var i=this._map();i.destroyClusters();[].concat(t.Set.Cluster).forEach(function(t){var n=null;switch(t.type){case"distance":n=new sap.ui.vbm.ClusterDistance(t.id);if(t.distance){n.setDistance(parseFloat(t.distance))}break;case"grid":n=new sap.ui.vbm.ClusterGrid(t.id);if(t.limit){n.setLimit(parseInt(t.limit,10))}if(t.limitOnSum){n.setLimitTotal(parseInt(t.limitOnSum,10))}if(t.order){n.setOrderIndex(parseInt(t.order,10))}if(t.areabordersize){n.setCellSpacing(-parseInt(t.areabordersize,10))}if(t.distanceX&&t.distanceY){n.setGridSize(t.distanceX+";"+t.distanceY)}if(t.offsetX&&t.offsetY){n.setOffset(t.offsetX+";"+t.offsetY)}break;case"tree":n=new sap.ui.vbm.ClusterTree(t.id,{});break;default:e.debug("unsupported clustering type",t.type,a);break}if(n){if(t.rule){n.setRule(t.rule)}n.setTextSettings({textcolor:t.textcolor,textfont:t.textfont,textfontsize:t.textfontsize,textoffset:t.textoffset,textoffsetY:t.textoffsetY});n.setVizTemplate(new sap.ui.vbm.Cluster);i.addCluster(n)}this._clusterVOs.set(t.VO,n)},this)}return this};n.prototype._processDetailWindows=function(t){var e=this._map();var i=this;if(!t.SAPVB.Windows.Set&&!t.SAPVB.Windows.Remove){return this}if(t.SAPVB.Windows.Set&&t.SAPVB.Windows.Set.name){var a=function(t,e){return function(i){return i[t]===e}};var n=[].concat(t.SAPVB.Windows.Set).map(function(t){var i=e.getModel().getData();var n=t;for(var r in t.Window){if(t.Window.hasOwnProperty(r)){if(r.endsWith(".bind")){if(r.startsWith("pos")){var s=t.Window[r].split(".");if(s[0]in i){var o=sap.ui.vbm.findIndexInArray(i[s[0]],a("Key",s[1]));if(o!==-1){var c=i[s[0]][o];if(s[2]in c){delete n.Window[r];n.Window[r.split(".")[0]]=c[s[2]]}}}}}}}return n},this);t.SAPVB.Windows.Set=n;if(t.SAPVB.Scenes&&t.SAPVB.Scenes.Set&&t.SAPVB.Scenes.Set.name&&t.SAPVB.Scenes.Set.Scene&&t.SAPVB.Scenes.Set.Scene.VO){var r=[].concat(t.SAPVB.Scenes.Set.Scene.VO).map(function(n){var r=n;var s=function(t,e,i){return function(n){if(n.name&&n.type){var r=n[n.type];if(r.name===n.name){var s=sap.ui.vbm.findInArray([].concat(this._dataTypes),a("name",r.name));var o=sap.ui.vbm.findInArray([].concat(sap.ui.vbm.findInArray([].concat(s.N),a("name",i[2])).A),a("name",i[4])).alias;var c=[].concat(r.E)[i[1]];var u=[].concat(sap.ui.vbm.findInArray([].concat(c.N),a("name",i[2])).E)[i[3]];t[e.split(".")[0]]=u[o];delete t[e]}}}};for(var o in n){if(n.hasOwnProperty(o)){if(o.endsWith(".bind")){var c=n[o].split(".");if(t.SAPVB.Data&&t.SAPVB.Data.Set){[].concat(t.SAPVB.Data.Set).forEach(s(r,o,c),this)}}}}if(t.SAPVB.Actions&&t.SAPVB.Actions.Set){[].concat(t.SAPVB.Actions.Set).filter(function(t){return t.Action.refVO===r.id}).forEach(function(t){i._attachHandler.call(e,t.Action.name,i._handler,i)})}return r},this);t.SAPVB.Scenes.Set.Scene.VO=r}}e.load(t);return this};n.prototype._handler=function(t,e){if(t.oSource instanceof sap.ui.vbm.ClusterBase){var i=t.getParameters().instance.getKey();var a=t.getParameters().event;var n=this._map().mVBIContext.GetMainScene();if(i&&a&&n){var r=n.GetEventVPCoords(a);var s=n.GetPosFromVPPoint([r[0],r[1],0]);var o=this._map().getInfoForCluster(i,sap.ui.vbm.ClusterInfoType.NodeInfo);t.getParameters().data={version:"2.0","xmlns:VB":"VB",id:t.oSource.getId(),Action:{id:e.id,name:e.name,object:e.refVO,instance:i,Params:{Param:[{name:"x","#":r[0].toString()},{name:"y","#":r[1].toString()}]},AddActionProperties:{AddActionProperty:[{name:"pos","#":s[0].toString()+";"+s[1].toString()+";0.0"},{name:"vos","#":o.cnt}]}}};this.fireSubmit({data:JSON.stringify(t.getParameters().data)})}}else{var c=t.getParameters();var u=c.data?c.data:c;if(u.Action&&!u.Action.object){this.fireSubmit({data:JSON.stringify(u)});return}if(u.Action.object.startsWith(this._map().getId())){u.Action.object=u.Action.object.substr(this._map().getId().length+1)}if(u.Action&&u.Action.object){var f="Route",p="Link";var h=[u.Action.object];if(u.Action.object===f){h.push(p);u.Action.object=p}var d=sap.ui.vbm.findInArray(this._actions,function(t){return h.indexOf(t.refVO)!=-1&&u.Action.name.toLowerCase()===t.refEvent.toLowerCase()});if(d){u.Action.id=d.id;u.Action.name=d.name;if(u.Action.instance){u.Action.instance=u.Action.object+"."+c.instance.getKey()}var l=[];if(u.Action.Params){u.Action.Params.Param.forEach(function(t){if(t.name==="strSource"){l.push(t)}});if(l.length){if(jQuery.isEmptyObject(this._idKeyMap)){this.idKeyMapGenerator()}else if(l.some(function(t){return!this._idKeyMap.hasOwnProperty(t["#"].split(".")[1])},this)){this.idKeyMapGenerator()}l.forEach(function(t){var e=t["#"].split(".");t["#"]=e[0]+"."+this._idKeyMap[e[1]]},this)}}if(u.Data&&u.Data.Merge&&u.Data.Merge.N){[].concat(u.Data.Merge.N).forEach(function(t){if(t.name&&t.name.startsWith(this._map().getId())){t.name=t.name.substr(this._map().getId().length+1)}},this);var m=u.Data.Merge.N.map(function(t){return t.E}).reduce(function(t,e){return t.concat(e)}).map(function(t){return t.K});if(jQuery.isEmptyObject(this._idKeyMap)){this.idKeyMapGenerator()}if(m.some(function(t){return!this._idKeyMap.hasOwnProperty(t)},this)){this.idKeyMapGenerator()}var v=function(t){t.K=this._idKeyMap[t.K]};[].concat(u.Data.Merge.N).map(function(t){return t.E}).reduce(function(t,e){return t.concat(e)}).forEach(v,this)}[].concat(d.AddActionProperty||[]).forEach(function(t){var e=u.Action.AddActionProperties.AddActionProperty||[];var i=sap.ui.vbm.findInArray([].concat(e),function(e){return e.name===t.name});if(!i){switch(t.name){case"zoom":e.push({name:t.name,"#":this._map().getZoomlevel()});break;case"centerpoint":e.push({name:t.name,"#":this._map().getCenterPosition()});break;case"pitch":e.push({name:t.name,"#":"0.0"});break;case"yaw":e.push({name:t.name,"#":"0.0"});break;default:break}}},this);this.fireSubmit({data:JSON.stringify(u)})}}}this.timeout=undefined};n.prototype._clickHandler=function(t,e){if(this.timeout){clearTimeout(this.timeout);if(!e){t.getParameters().data.Action.name="doubleclick"}this._handler(t,e)}else{var i=e?sap.ui.vbm.findInArray(this._actions,function(t){return t.refVO===e.refVO&&t.refEvent==="Click"}):undefined;this.oEvent=jQuery.extend(true,{},t);this.timeout=setTimeout(this._handler.bind(this,this.oEvent,i),500)}};return n});
//# sourceMappingURL=Adapter.js.map