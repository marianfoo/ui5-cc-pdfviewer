/*
 * ! SAP UI development toolkit for HTML5 (SAPUI5) (c) Copyright 2009-2012 SAP AG. All rights reserved
 */
sap.ui.define(["./sapvbi","sap/ui/core/Popup"],function(){"use strict";VBI.InputModeDefault=0;VBI.InputModeTrackObject=1;VBI.InputModeTrackMap=2;VBI.InputModeTrackDesign=3;VBI.InputModeRectSelect=4;VBI.InputModeLassoSelect=5;VBI.InputModeRectZoom=6;VBI.SceneManager=function(){var e={};e.vbiclass="SceneManager";e.m_SceneArray=[];e.find=function(n){for(var a=0;a<e.m_SceneArray.length;++a){if(e.m_SceneArray[a].m_ID==n){return e.m_SceneArray[a]}}return null};e.clear=function(){for(var n=0;n<e.m_SceneArray.length;++n){e.m_SceneArray[n].clear()}e.m_SceneArray=[]};e.load=function(n,a){if(n.Set){e.loadScenes(n.Set,false,n,a)}if(n.Merge){e.loadScenes(n.Merge,true,n,a)}};e.loadScenes=function(n,a,t,i){if(jQuery.type(n)=="array"){for(var r=0;r<n.length;++r){e.loadScene(n[r],a,t,i)}}else{e.loadScene(n,a,t,i)}};e.loadScene=function(n,a,t,i){var r;var m=false;if(n.name){r=e.find(n.name);if(r){if(!a){r.clear()}if(n.SceneGeo){m=r.load(n.SceneGeo,i,a)}else if(n.Scene3D){m=r.load(n.Scene3D,i,a)}else{m=r.load(n.Scene,i,a)}if(m){r.ReAwake()}return}}else if(!a){e.clear()}if(n.SceneGeo){e.loadNewScene(n.SceneGeo,"geo",i)}if(n.Scene3D){e.loadNewScene(n.Scene3D,"3d",i)}if(n.Scene){e.loadNewScene(n.Scene,"default",i)}};e.loadNewScene=function(n,a,t){var i=null;if(jQuery.type(n)=="object"){if(a=="geo"){i=new VBI.GeoScene(null,null,null)}else if(a=="3d"){i=new VBI.Scene3D(null)}else{i=new VBI.Scene(null,null,null)}i.load(n,t);e.Add(i)}else if(jQuery.type(n)=="array"){for(var r=0;r<n.length;++r){i=null;if(a=="geo"){i=new VBI.GeoScene(null,null,null)}else if(a=="3d"){i=new VBI.Scene3D(null)}else{i=new VBI.Scene(null,null,null)}i.load(n[r],t);e.Add(i)}}};e.Add=function(n){e.m_SceneArray.push(n)};e.GetScene=function(n){for(var a=0;a<e.m_SceneArray.length;++a){if(e.m_SceneArray[a].m_TargetName==n){return e.m_SceneArray[a]}}return null};e.GetSceneByName=function(n){for(var a=0;a<e.m_SceneArray.length;++a){if(e.m_SceneArray[a].m_ID==n){return e.m_SceneArray[a]}}return null};return e};VBI.Scene=function(e){var n={};n.vbiclass="Scene";n.m_TargetName=e;n.m_EvtCont=new VBI.Events;n.m_ID="";n.m_Ctx=null;n.m_Div=null;n.m_Parent=null;n.m_CaptureVO=null;n.m_DesignVO=null;n.m_VOS=[];n.m_Events=null;n.m_Proj=null;n.m_LastDefinedCenterPos=n.m_LastZoomArea=undefined;n.m_HotItem={m_VO:null,m_Index:null,m_Design:null,m_HitObj:null};n.m_DragInfo=null;n.m_Target=e;n.m_KeysDown=[];n.m_KeysSkipUp=[];n.m_KeysSkipPress=[];n.LoadSingleVO=function(e,a,t,i){if(jQuery.type(e)=="object"){var r=null;if(n.vbiclass=="3DScene"){r=a.Factory3D.CreateInstance(e.type)}else{r=a.Factory.CreateInstance(e.type)}r.m_Scene=n;r.load(e,t);if(i){var m=r.m_ID;for(var o=n.m_VOS.length;o--;){if(n.m_VOS[o].m_ID==m){n.m_VOS[o]=r;return}}}n.m_VOS.push(r)}};n.BaseLoad=function(e,a,t){if(!t){VBI.RegisterKeyboardHook();n.m_Ctx=a;if(e.id){n.m_ID=e.id}}if(e.VO){var i=new VBI.VisualObjects;if(jQuery.type(e.VO)=="array"){for(var r=0;r<e.VO.length;++r){n.LoadSingleVO(e.VO[r],i,a,t)}}else{n.LoadSingleVO(e.VO,i,a,t)}}};n.BaseClear=function(){for(var e=0,a=n.m_VOS.length;e<a;++e){n.m_VOS[e].clear()}n.m_VOS=[];n.m_Ctx=null;n.m_CaptureVO=null;n.m_DesignVO=null;if(n.m_Parent){n.m_Parent.m_refSceneInstance=null}n.m_HotItem=null;if(n.m_Events){n.m_Events.clear();n.m_Events=null}VBI.UnRegisterKeyboardHook()};n.BaseGetVO=function(e){for(var a=0,t=n.m_VOS.length;a<t;++a){if(n.m_VOS[a].m_ID==e){return n.m_VOS[a]}}return null};n.load=function(e,a,t){n.BaseLoad(e,a,t);return false};n.clear=function(){n.BaseClear();n.m_Div=null};n.VerifyHotItem=function(e,a){var t=n.m_HotItem;if(a!=t.m_Index&&e==t.m_VO){var i=e.m_BBRefs[a];if(t.cI==i.cI&&t.nI==i.i){t.m_Index=a}}n.m_LastHotItem=undefined};n.CheckHotItem=function(){if(this.m_LastHotItem){var e=this.m_LastHotItem;var a=e.cI!=undefined?n.m_PreassembledData.clust[e.cI]:n.m_PreassembledData.base[n.m_LastHotItem.m_VO];if(a.m_nRecalcs!=e.recalcs){n.InternalSetHotItem(null,null,true);this.m_LastHotItem=undefined}}};n.SetLastHotItem=function(e){if(e.m_VO&&e.m_VO.m_BBRefs!=undefined){var a=e.m_VO.m_BBRefs[e.m_Index];var t=a.cI!=undefined?n.m_PreassembledData.clust[a.cI]:n.m_PreassembledData.base[e.m_VO.m_nPreDataIndex];n.m_LastHotItem={cI:a.cI,i:a.i,m_VO:e.m_VO.m_nPreDataIndex,recalcs:t.m_nRecalcs}}};n.InvalidateInvisibleHots=function(){if(this.m_LastHotItem!=undefined){var e=this.m_LastHotItem;var a=e.cI!=undefined?n.m_PreassembledData.clust[e.cI]:n.m_PreassembledData.base[n.m_LastHotItem.m_VO];if(a[e.i]!=undefined){a[e.i].h=false;n.InternalSetHotItem(null,null,true)}this.m_LastHotItem=undefined}};n.InternalSetHotItem=function(e,a,t){var i=n.m_HotItem;var r=false;var m=i.m_Index;var o=i.m_VO;if(a){if(i.m_Index!=a.m_Index){i.m_Index=a.m_Index;r=true}if(i.m_Design!=a.m_Design){i.m_Design=a.m_Design;r=true}if(i.m_Entity!=a.m_Entity){i.m_Entity=a.m_Entity;r=true}}else if(i.m_Entity||i.m_Detail){r=true;i.m_Entity=null;i.m_Detail=null}if(i.m_VO!=e){i.m_VO=e;r=true}if(!r){var l;if(a&&(l=i.m_HitObj)){if(!jQuery.sap.equal(l,a,2)){r=true}}else if(a!=null||i.m_HitObj!=null){r=true}}i.m_HitObj=a;if(r){if(o&&!t){o.InternalChangeHotItem(m,false,i)}if(e){e.InternalChangeHotItem(i.m_Index,true,i)}n.RenderAsync(false)}return r};n.InternalRenderVisualObjects=function(e,a){var t=Date.now();var i=n.m_VOS;VBI.Utilities.BackupFont(a);for(var r=0;r<n.m_VOS.length;++r){i[r].Render(e,a)}VBI.Utilities.RestoreFont(a);n.m_nLastRenderingTime=Date.now()-t};n.Render=function(){};n.Awake=function(e){n.InternalRenderVisualObjects(null,n.m_Ctx)};n.NotifyDataChange=function(){for(var e=0;e<n.m_VOS.length;++e){n.m_VOS[e].NotifyDataChange(n.m_Ctx)}n.m_nDataVersion++};n.GetPointArrayFromPosArray=function(e,n){return e};n.GetPosFromPoint=function(e){return e};n.GetPointFromPos=function(e,a,t){return n.GetPointArrayFromPosArray(e,a,t)};n.GetInternalDivClientRect=function(){var e=n.m_Div.getBoundingClientRect();if(this.m_Ctx.moThumbnail&&this.m_Ctx.moThumbnail.nOrgWidth&&this.m_Ctx.moThumbnail.nOrgHeight){return{left:e.left,top:e.top,width:n.m_Ctx.moThumbnail.nOrgWidth,height:n.m_Ctx.moThumbnail.nOrgHeight,right:e.left+n.m_Ctx.moThumbnail.nOrgWidth,bottom:e.top+n.m_Ctx.moThumbnail.nOrgHeight}}return e};n.GetEventVPCoords=function(e){if(!e){return[0,0]}var a=n.GetInternalDivClientRect();if(VBI.m_bIsRtl){return[a.right-e.clientX,e.clientY-a.top]}else{return[e.clientX-a.left,e.clientY-a.top]}};n.GetEventVPCoordsObj=function(e){var a=n.GetEventVPCoords(e);return{x:a[0].toString(),y:a[1].toString()}};n.GetEventVPCoordsObjWithScene=function(e){var a=n.GetEventVPCoords(e);return{x:a[0].toString(),y:a[1].toString(),scene:n.m_ID}};n.GetEventDropObjWithScene=function(e){return{strSource:n.m_DragInfo.strScene+"|"+n.m_DragInfo.strID+"|"+n.m_DragInfo.strInstance,scene:n.m_ID}};n.DispatchEvent=function(e,a){if(VBI.m_bTrace){VBI.Trace("DispatchEvent "+e.type+" as "+a+" mode:"+n.m_nInputMode+(n.m_Gesture?" gesture active":""))}if(n.m_nInputMode==VBI.InputModeTrackMap){return false}var t,i=e.type;if(a){e.m_evName=i=a}e.m_Scene=n;if(e.offsetX==undefined||e.offsetY==undefined){var r;if(e.clientX!==undefined&&e.clientY!==undefined){r=e.target.getBoundingClientRect();e.offsetX=e.clientX-r.left;e.offsetY=e.clientY-r.top}else if(e.changedTouches!==undefined&&e.changedTouches.length>0){r=e.target.getBoundingClientRect();e.clientX=e.changedTouches[0].clientX;e.clientY=e.changedTouches[0].clientY;e.offsetX=e.clientX-r.left;e.offsetY=e.clientY-r.top}}if(e.shiftKey==undefined){e.shiftKey=VBI.m_shiftKey}if(e.ctrlKey==undefined){e.ctrlKey=VBI.m_ctrlKey}if(n.m_DesignVO){if(VBI.m_bTrace){VBI.Trace("DispatchEvent to Design VO")}if((t=n.m_DesignVO["on"+i])&&typeof t=="function"){if(t.call(n.m_DesignVO,e)){return true}}}if(n.m_CaptureVO){if((t=n.m_CaptureVO["on"+i])&&typeof t=="function"){if(t.call(n.m_CaptureVO,e)){return true}}}var m=n.m_Ctx.m_Control;if(i.indexOf("click")!=-1&&m instanceof sap.ui.vbm.GeoMap&&m.getEnableOverlappingTest()){e.hitTests=[];for(var o=0;o<n.m_VOS.length;++o){if((t=n.m_VOS[o]["on"+i])&&typeof t=="function"){t.call(n.m_VOS[o],e)}}if(e.hitTests.length>1){e.hitTests=e.hitTests.filter(function(e){var n=m.getAggregatorContainer(e.m_Vo.m_ID);var a=e.m_Vo.m_ID==="Region"&&m instanceof sap.ui.vbm.AnalyticMap;switch(i){case"sapclick":if(n){return n.isSubscribed("click",e.m_Index)||n.isSelectable()}else if(a){return m.hasListeners("regionClick")||m.isRegionSubscribed("click",e.m_Entity)}break;case"sapsecclick":if(n){return n.isSubscribed("contextMenu",e.m_Index)}else if(a){return m.hasListeners("regionContextMenu")||m.isRegionSubscribed("contextMenu",e.m_Entity)}break}return false});if(e.hitTests.length>1){n.showHitMenu(e,e.hitTests);delete e.hitTests;e.preventDefault();return true}}if(e.hitTests.length>0){e.hitCached=e.hitTests[0];delete e.hitTests;if(e.hitCached.m_Vo){return e.hitCached.m_Vo["on"+i].call(e.hitCached.m_Vo,e)}else{delete e.hitCached}}else{return false}}for(var o=n.m_VOS.length-1;o>=0;--o){if((t=n.m_VOS[o]["on"+i])&&typeof t=="function"){if(t.call(n.m_VOS[o],e)){return true}}}return false};return n};VBI.Scene3D=function(e){var n=new VBI.Scene(e);n.vbiclass="3DScene";n.m_DivCopyright=null;n.m_bMainSceneInitialized=false;n.m_Events=null;n.m_Canvas=[];n.m_nMaxCanvasDimension=VBI.m_bIsMobile?6144:8192;n.clear=function(){n.BaseClear();n.clearCanvases();n.m_TargetName=null;n.m_Proj=null;n.m_DivCopyright=null;n.m_Target=null};n.clearCanvas=function(e){n.m_Canvas[e].m_Scene=null;n.m_Canvas[e]=null};n.clearCanvases=function(){for(var e=0,a=n.m_Canvas.length;e<a;++e){n.clearCanvas(e)}n.m_Canvas=[]};n.Init=function(){};n.InitializeCanvas=function(e){e.m_Scene=n;e.m_nCurrentX=undefined;e.m_nCurrentY=undefined;e.m_bInvalid=false;if(!e.m_bNotInDOM){n.m_Div.appendChild(e)}};n.CreateCanvases=function(){n.m_Canvas.push(VBI.Utilities.Create3DSceneCanvas("layer1",n.m_nWidthCanvas,n.m_nHeightCanvas,2));for(var e=0;e<n.m_Canvas.length;++e){n.InitializeCanvas(n.m_Canvas[e])}};n.Awake=function(e){if(!(n.m_Target=VBI.Utilities.GetDOMElement(e))){n.m_Target=VBI.Utilities.CreateDOMElement(e,"1px","1px")}if(n.m_Div){if(n.m_Div.parentNode==n.m_Target){return}n.m_Target.appendChild(n.m_Div);return}n.m_TargetName=e;n.m_Div=VBI.Utilities.Create3DSceneDiv(e+"-3Dscene");n.m_Target.appendChild(n.m_Div);n.DoAwake(e)};n.DoAwake=function(e){n.CalculateCanvasDimensions();n.CreateCanvases();n.Init();
// // append copyright
// scene.AddCopyright();
var a=n.m_Canvas[0];n.m_Events=new VBI.SceneEvent(this,a)};n.CalculateCanvasDimensions=function(){var e=n.m_Target.offsetWidth;var a=n.m_Div.getBoundingClientRect();var t=a.width?a.width:n.m_Div.clientWidth;var i=a.height?a.height:n.m_Div.clientHeight;if(t==n.m_nDivWidth&&i==n.m_nDivHeight){return}if(VBI.m_bTrace){VBI.Trace("Calculating Canvas Dimensions to "+t+","+i+", Dummy:"+e)}n.m_nDivWidth=t;n.m_nDivHeight=i;n.m_nWidthCanvas=t;n.m_nHeightCanvas=i};n.Render=function(){var e=null;var a=0;for(var t=n.m_VOS.length;t--;){e=n.m_VOS[t];a+=e.Render(n.m_Canvas[0])}};if(e){n.Awake(e)}return n};VBI.GeoScene=function(e,n,a){var t=new VBI.Scene(e);t.vbiclass="GeoScene";t.m_RefMapLayerStack="";t.m_DivCopyright=null;t.m_Canvas=[];t.m_ZoomFactors=[1,1];t.m_StretchFactors=[1,1];t.m_MapManager=n;t.m_MapLayerStack=a;t.m_nMaxCanvasDimension=VBI.m_bIsMobile?6144:8192;t.Click=null;t.m_nOverlayIndex=2;t.m_nLabelIndex=3;t.m_nNonDomIndex=4;t.m_nTapCount=0;t.GetHomeLocation=null;t.m_Touches=[];t.m_currentMouseX=0;t.m_currentMouseY=0;t.m_oldMouseX=0;t.m_oldMouseY=0;t.m_currentMouseDownX=0;t.m_currentTouchCount=0;t.m_currentMouseDownY=0;t.m_midPointX=0;t.m_midPointY=0;t.m_currentTouchDistance=0;t.m_nInputMode=VBI.InputModeDefault;t.m_AnimZoomTimer=null;t.m_startPointLonLat=[0,0];t.m_startLOD=0;t.m_bNavControlVisible=true;t.m_NavControl=null;t.m_RenderRequestID=0;t.m_SuppressedNavigation={zoom:false,move:false};t.m_bScaleVisible=true;t.m_Scale=null;t.m_nInitialTrackingMode=VBI.InputModeDefault;t.m_nCanvasXOversize=2.2;t.m_nCanvasYOversize=2.2;t.m_nCanvasStdXPos=t.m_nCanvasXOversize/4;t.m_nCanvasStdYPos=t.m_nCanvasYOversize/4;t.m_nTicksInALod=VBI.m_bIsMobile?6:12;t.m_nLodFactorZoomIn=Math.pow(2,1/t.m_nTicksInALod);t.m_nLodFactorZoomOut=1/t.m_nLodFactorZoomIn;t.m_nLodFactorZoomInHalf=Math.pow(2,1/(2*t.m_nTicksInALod));t.m_nLodFactorZoomOutHalf=1/t.m_nLodFactorZoomInHalf;t.m_nMaxAnimLodDiff=3;t.m_nZoomMode=1;t.m_nLastRenderingTime=0;t.m_nRenderTimeTarget=250;t.m_nNumOfScalingVOInst=0;t.m_nLastClusteringTime=0;t.m_nDataVersion=0;t.m_bObjCanvasMode=1;t.m_nlstWidth=t.m_nlstHeight=0;t.m_nGetImageDataIncidents=0;t.onTileLoaded=null;t.clear=function(){t.BaseClear();t.m_Touches=[];if(t.m_NavControl){t.m_NavControl.clear();t.m_NavControl=null}if(t.m_Scale){t.m_Scale.clear();t.m_Scale=null}t.clearTimers();t.clearCanvases();t.SetInputMode(VBI.InputModeDefault);t.Remove();t.m_RefMapLayerStack="";t.m_MapManager=null;t.m_MapLayerStack=null;t.m_TargetName=null;t.m_Proj=null;t.m_DivCopyright=null;t.m_Target=null};t.loadSingleRemoveOnScene=function(e,n){if(jQuery.type(e)=="object"){switch(e.type){case"VO":var a=e.id;for(var i=t.m_VOS.length;i--;){if(t.m_VOS[i].m_ID==a){t.m_VOS[i].clear();t.m_VOS.splice(i,1);return}}break;default:break}}};t.loadRemoveOnScene=function(e,n){if(jQuery.type(e)=="array"){for(var a=0;a<e.length;++a){t.loadSingleRemoveOnScene(e[a],n)}}else{t.loadSingleRemoveOnScene(e,n)}};t.load=function(e,n,a){var i=false;if(a&&e.Remove){t.loadRemoveOnScene(e.Remove,n)}t.BaseLoad(e,n,a);if(e.refMapLayerStack){var r=n.m_MapLayerStackManager.GetMapLayerStack(e.refMapLayerStack);if(t.m_RefMapLayerStack!=r){t.m_RefMapLayerStack=r;i=true}}else if(VBI.m_bTrace){VBI.Trace("no map layer specified in geo scene")}if(a){return i}var m=-1e3,o=1e3;var l=-90,s=90;t.m_nMinLodVisualBorder=0;t.m_nMaxLodVisualBorder=99;t.m_nOffsetMinLod=0;t.m_bYBorderExists=false;if(e.VisualFrame){if(e.VisualFrame.minLon!=undefined){m=e.VisualFrame.minLon}else{m=e.VisualFrame.minX!=undefined?e.VisualFrame.minX:m}if(e.VisualFrame.maxLon!=undefined){o=e.VisualFrame.maxLon}else{o=e.VisualFrame.maxX!=undefined?e.VisualFrame.maxX:o}if(e.VisualFrame.minLat!=undefined){l=e.VisualFrame.minLat}else{l=e.VisualFrame.minY!=undefined?e.VisualFrame.minY:l}if(e.VisualFrame.maxLat!=undefined){s=e.VisualFrame.maxLat}else{s=e.VisualFrame.maxY!=undefined?e.VisualFrame.maxY:s}if(e.VisualFrame.minLOD!=undefined){t.m_nMinLodVisualBorder=e.VisualFrame.minLOD}if(e.VisualFrame.maxLOD!=undefined){t.m_nMaxLodVisualBorder=e.VisualFrame.maxLOD}if(e.VisualFrame.maxFraction!=undefined){t.m_fMaxMinLODFraction=e.VisualFrame.maxFraction}if(e.VisualFrame.offsetMinLOD!=undefined){t.m_nOffsetMinLod=e.VisualFrame.offsetMinLOD}}t.m_bXBorderExists=m!=-1e3||o!=1e3;t.m_nBorderMinPoint=VBI.MathLib.DegToRad([m,s]);t.m_nBorderMaxPoint=VBI.MathLib.DegToRad([o,l]);t.m_Proj=t.setProjection();var _=[1,1],v=[1,1];t.m_Proj.LonLatToUCS(t.m_nBorderMinPoint,_);t.m_Proj.LonLatToUCS(t.m_nBorderMaxPoint,v);t.m_nXSizeVisualBorder=Math.max(0,Math.min(1,v[0]-_[0]));t.m_nYSizeVisualBorder=Math.max(0,Math.min(1,v[1]-_[1]));if(e.initialStartPosition){var d=e.initialStartPosition.split(";");t.m_startPointLonLat=VBI.MathLib.DegToRad([parseFloat(d[0]),parseFloat(d[1])])}if(e.initialZoom){t.m_startLOD=parseInt(e.initialZoom,10)}if(e.ariaLabel){t.ariaLabel=e.ariaLabel}var u={zoom:false,move:false,fade:false};if(e.NavigationDisablement){if(e.NavigationDisablement.zoom){t.m_SuppressedNavigation.zoom=VBI.Types.string2bool(e.NavigationDisablement.zoom)}if(e.NavigationDisablement.move){t.m_SuppressedNavigation.move=VBI.Types.string2bool(e.NavigationDisablement.move)}}if(e.navControlVisible){t.m_bNavControlVisible=VBI.Types.string2bool(e.navControlVisible)}u.zoom=t.m_SuppressedNavigation.zoom;u.move=t.m_SuppressedNavigation.move;if(t.m_SuppressedNavigation.zoom&&t.m_SuppressedNavigation.move){t.m_bNavControlVisible=false}else if(t.m_bNavControlVisible){if(e.SuppressedNavControlVisibility){if(!u.zoom&&e.SuppressedNavControlVisibility.zoom){u.zoom=VBI.Types.string2bool(e.SuppressedNavControlVisibility.zoom)}if(!u.move&&e.SuppressedNavControlVisibility.move){u.move=VBI.Types.string2bool(e.SuppressedNavControlVisibility.move)}if(e.SuppressedNavControlVisibility.fade){u.fade=VBI.Types.string2bool(e.SuppressedNavControlVisibility.fade)}}if(u.move&&u.zoom){t.m_bNavControlVisible=false}}if(e.scaleVisible){t.m_bScaleVisible=VBI.Types.string2bool(e.scaleVisible)}if(t.m_Ctx.moThumbnail){t.m_SuppressedNavControlVisibility=u}else if(t.m_bNavControlVisible){t.m_NavControl=new VBI.NavigationControl(u)}if(t.m_bScaleVisible&&!t.m_Ctx.moThumbnail){t.m_Scale=new VBI.Scale(t)}if(e.rectZoom&&VBI.Types.string2bool(e.rectZoom)){t.m_nInitialTrackingMode=VBI.InputModeRectZoom}else if(e.rectSelect&&VBI.Types.string2bool(e.rectSelect)){t.m_nInitialTrackingMode=VBI.InputModeRectSelect}else if(e.lassoSelect&&VBI.Types.string2bool(e.lassoSelect)){t.m_nInitialTrackingMode=VBI.InputModeRectSelect}else{t.m_nInitialTrackingMode=VBI.InputModeDefault}return false};t.SetInputMode=function(e){if(VBI.m_bTrace){VBI.Trace("SetInputMode: "+this.m_nInputMode)}if(this.m_nInputMode==e){return}switch(this.m_nInputMode){case VBI.InputModeTrackMap:t.SetInputModeTrackMap(false);break;default:break}switch(e){case VBI.InputModeTrackMap:t.SetInputModeTrackMap(true);break;default:break}this.m_nInputMode=e};t.SetToolTip=function(e,n,a,i){var r=t.m_Canvas[t.m_nLabelIndex];if(e instanceof sap.ui.core.TooltipBase){if(n==true&&!e._getPopup().isOpen()){var m=a+" "+(i+20);e.setMyPosition(sap.ui.core.Popup.Dock.BeginTop);e.setAtPosition(sap.ui.core.Popup.Dock.BeginTop);e.setOffset(m);e.setCollision("fit fit");e.openPopup(e.getParent());r.title=""}else if(n==false&&e._getPopup().isOpen()){e.closePopup()}}else if(r.title!=e){r.title=e}};t.SetCursor=function(e){var n=t.m_Canvas[t.m_nLabelIndex];if(n.style.cursor!=e){n.style.cursor=e}};t.RenderAsync=function(e){if(e!=false){t.bForceRecluster=true}if(!t.m_RenderRequestID){t.m_RenderRequestID=window.requestAnimationFrame(t.DoRender)}};t.DoRender=function(){t.Render(!t.bForceRecluster)};t.Render=function(e){t.m_RenderRequestID=0;t.bForceRecluster=false;if(t.m_Canvas.length){t.InternalRenderLayer(t.m_Canvas[t.m_nOverlayIndex],false,true,e!=true,t.m_Canvas[0].m_nExactLOD)}};t.GoToInitialStart=function(){if(t.m_nMaxLodVisualBorder<Math.ceil(t.GetMinLOD())){t.m_nMaxLodVisualBorder=Math.ceil(t.GetMinLOD())}if(!t.ZoomToGeoPosition(t.m_startPointLonLat,t.m_startLOD,true,false,true)){var e=VBI.MathLib.RadToDeg(t.m_nBorderMinPoint);var n=VBI.MathLib.RadToDeg(t.m_nBorderMaxPoint);var a=[e[0],n[0]];var i=[e[1],n[1]];t.ZoomToMultiplePositions(a,i,1.1,true)}t.RenderAsync(true)};t.GetDistance=function(e,n){var a=t.GetPosFromVPPoint(e);var i=t.GetPosFromVPPoint(n);return VBI.MathLib.Distance(VBI.MathLib.DegToRad(a),VBI.MathLib.DegToRad(i))};t.GetTargetPointForDistance=function(e,n){var a=VBI.MathLib.DegToRad(t.GetPosFromVPPoint(n));var i=90*Math.PI/180;var r=Math.asin(Math.sin(a[1])*Math.cos(e/VBI.MathLib.earthradius)+Math.cos(a[1])*Math.sin(e/VBI.MathLib.earthradius)*Math.cos(i));var m=a[0]+Math.atan2(Math.sin(i)*Math.sin(e/VBI.MathLib.earthradius)*Math.cos(a[1]),Math.cos(e/VBI.MathLib.earthradius)-Math.sin(a[1])*Math.sin(r));return t.GetPointFromGeo([m,r],false)};t.ZoomToMultiplePositions=function(e,n,a,i){var r=[];var m=[];if(e.length!=n.length){return}var o;for(o=0;o<e.length;o++){var l=parseFloat(e[o]);if(l<0){l+=360}r.push(l);m.push(parseFloat(n[o]))}if(r.length!=m.length||!r.length){return}r.sort(function(e,n){return e-n});m.sort(function(e,n){return e-n});var s=0,_=0,v,d;v=m[0];d=m[m.length-1];var u,c,f,h;c=r[r.length-1];for(o=0;o<r.length;o++){f=r[o];h=f<c?f+360-c:f-c;if(u==undefined||h>u){u=h;s=f<c?f+360:f;_=c}c=f}t.ZoomToArea(s,_,v,d,a?a:1,true,i)};t.ZoomToAreas=function(e,n){var a=Math.log(t.m_nDivWidth/(t.m_MapManager.m_tileWidth*t.m_nXSizeVisualBorder))*Math.LOG2E;var i=VBI.MathLib.GetSurroundingBox(e,0,a,t.CalculateYMinLod,t.m_bObjCanvasMode==1?.5:0);t.ZoomToArea(i[0],i[1],i[2],i[3],n,true);var r=(new Date).getTime();t.m_LastZoomArea=[r,"Areas",e,n];return true};t.ZoomTo=function(e,n){var a=[],i=[];var r=function(e,n,a,t,i){e.forEach(m.bind(this,i,n,a,t))};var m=function(e,n,a,t,i){if(e===i.m_Value){if(n.m_Pos){var r=n.m_Pos.GetValueVector(this.m_Ctx);for(var m=0;m<r.length/3;++m){a.push(r[m*3+0]);t.push(r[m*3+1])}}}};for(var o=0;o<this.m_VOS.length;++o){var l=this.m_VOS[o];var s=l.m_DataSource.GetCurrentNode(this.m_Ctx);if(s&&s.m_dataelements.length){for(var _=0;_<s.m_dataelements.length;++_){l.m_DataSource.Select(_);var v=s.m_dataelements[_].m_dataattributes;e.forEach(r.bind(this,v,l,i,a))}}}if(i.length){t.ZoomToMultiplePositions(i,a,n)}return true};t.ZoomToAll=function(e,n){var a=[],i=[];for(var r=0;r<t.m_VOS.length;++r){var m=t.m_VOS[r];var o=m.m_DataSource?m.m_DataSource.GetCurrentNode(t.m_Ctx):null;if(o&&o.m_dataelements.length){for(var l=0;l<o.m_dataelements.length;++l){m.m_DataSource.Select(l);if(m.m_Pos){var s=m.m_Pos.GetValueVector(t.m_Ctx);for(var _=0;_<s.length/3;++_){i.push(s[_*3+0]);a.push(s[_*3+1])}}else if(m.m_PosM){var s=m.m_PosM.GetValueVector(t.m_Ctx);for(var _=0;_<s.length;++_){for(var v=0;v<s[_].length;++v){for(var d=0;d<s[_][v].length/3;++d){i.push(s[_][v][d*3+0]);a.push(s[_][v][d*3+1])}}}}}}}if(i.length){t.ZoomToMultiplePositions(i,a,e,n)}};t.CalculateYMinLod=function(e,n){if(e==n){return 1e3}var a=[256,256];var i=[256,256];t.m_Proj.LonLatToUCS(VBI.MathLib.DegToRad([0,e]),a);t.m_Proj.LonLatToUCS(VBI.MathLib.DegToRad([0,n]),i);var r=t.m_nDivHeight/Math.abs(i[1]-a[1]);r=Math.log(r)*Math.LOG2E;return r};t.ZoomToArea=function(e,n,a,i,r,m,o){var l=256,s=256;if(t.m_MapManager){l=t.m_MapManager.m_tileWidth;s=t.m_MapManager.m_tileHeight}var _=t.m_nDivHeight?t.m_nDivHeight:s;var v=t.m_nDivWidth?t.m_nDivWidth:l;var d;var u;if(jQuery.type(r)=="array"){if(r.length>=4){var c=r[0]+r[2];var f=r[1]+r[3];if(c<v&&f<_){if(r[0]!=r[2]||r[1]!=r[3]){u=[(r[2]-r[0])/2,(r[3]-r[1])/2]}v-=c;_-=f;d=c<0||f<0}}}else{_*=r;v*=r;d=r>1}if(n<e){n+=360}while(e>180){e-=360}while(n>180){n-=360}var h=[e,a];var C=[n,i];h=VBI.MathLib.DegToRad(h);C=VBI.MathLib.DegToRad(C);var g=[l,s];var M=[l,s];t.m_Proj.LonLatToUCS(h,g);t.m_Proj.LonLatToUCS(C,M);var I=g[0]+M[0]+(M[0]<g[0])*l;var p=g[1]+M[1];var D=[I/l-1,p/s-1];var S=[1,1];t.m_Proj.UCSToLonLat(D,S);var x=14,b=14;if(i!=a){x=_/Math.abs(M[1]-g[1]);x=Math.log(x)*Math.LOG2E}if(n!=e){b=v/Math.abs(M[0]-g[0]+(M[0]<=g[0])*l);b=Math.log(b)*Math.LOG2E}var T=d?Math.max(b,x):Math.min(b,x);if(m){T=Math.floor(T)}t.ZoomToGeoPosition(S,T,false,false,o,u);if(T!=Math.floor(T)){setTimeout(function(){t.AnimateZoomToGeo(S,Math.floor(T),5)},20)}var L=(new Date).getTime();t.m_LastZoomArea=[L,"Area",e,n,a,i,r]};t.getInfoForCluster=function(e,n){var a=JSON.parse(e);var i=t.m_Ctx.m_Clustering;return i.getInfoForCluster(a,n,t)};t.AdaptOtherCanvas=function(e,n,a,i){var r=a?1:0;var m=t.m_Canvas[1-r];if(a<=1&&a>=-2){var o=n-m.m_nCurrentLOD;var l=Math.pow(2,-o);var s=Math.max(1,l);var _=m.getPixelLeft(),v=m.getPixelTop();var d=m.getPixelWidth(),u=m.getPixelHeight();var c=d/t.m_nWidthCanvas;var f=[this.m_MapManager.m_tileWidth*m.m_nCurrentX+(t.m_nDivWidth/2-_)/c,this.m_MapManager.m_tileHeight*m.m_nCurrentY+(t.m_nDivHeight/2-v)/c];var h=[f[0]-l*e[0],f[1]-l*e[1]];if(Math.abs(h[0])<s*t.m_nWidthCanvas&&Math.abs(h[1])<s*t.m_nHeightCanvas){var C=Math.pow(2,i);var g=C*(_-t.m_nDivWidth/2+c*h[0])+t.m_nDivWidth/2;var M=C*(v-t.m_nDivHeight/2+c*h[1])+t.m_nDivHeight/2;this.MoveCanvas(m,g,M,d*C,u*C);return r}}return 0};t.ZoomToGeoPosition=function(e,n,a,i,r,m){if(e.pixelShift!=undefined&&m==undefined){m=e.pixelShift}if(t.m_Canvas[t.m_nNonDomIndex].m_bCanvasValid){t.SwitchTmpCanvasToActive()}var o=0,l=0;var s=t.m_Canvas[0];var _=s.m_nExactLOD;var v=t.m_MapManager.m_tileWidth;var d=t.m_MapManager.m_tileHeight;var u=Math.min(Math.max(n,t.GetMinLOD()),t.GetMaxLOD());n=Math.floor(u);var c=Math.pow(2,u-n);var f=1<<n;if(m!=undefined){o=m[0]/c;l=m[1]/c}var h=[f*v,f*d];t.m_Proj.LonLatToUCS(e,h);var C=[h[0]-t.m_nDivWidth/2+o,h[1]-t.m_nDivHeight/2+l];var g=t.m_Proj.m_nUCSMin*f;var M=t.AdaptOtherCanvas(h,n,n-s.m_nCurrentLOD,u-s.m_nExactLOD);var I=Math.round(C[0]/v-t.m_nCanvasStdXPos-g);var p=Math.round(C[1]/d-t.m_nCanvasStdYPos);var D=-Math.floor(C[0]-(I+g)*v);var S=-Math.floor(C[1]-p*d);var x=Math.round(D+(c-1)*(D-t.m_nDivWidth/2));var b=Math.round(S+(c-1)*(S-t.m_nDivHeight/2));var T=Math.round(t.m_nWidthCanvas*c);var L=Math.round(t.m_nHeightCanvas*c);var V=[f,f];var y=[f,f];t.m_Proj.LonLatToUCS(t.m_nBorderMinPoint,V);t.m_Proj.LonLatToUCS(t.m_nBorderMaxPoint,y);var O=L/t.m_nHeightCanvas;var P=d*(p-V[1])*O-b;var B=d*(p-y[1])*O+t.m_nDivHeight-b;var w;var A=true;if(P<-t.m_nMaxPixelBeyondPoles){b=d*(p-V[1])*O+t.m_nMaxPixelBeyondPoles}else if(B>t.m_nMaxPixelBeyondPoles){b=d*(p-y[1])*O+t.m_nDivHeight-t.m_nMaxPixelBeyondPoles}else{A=false}if(A){if(a){return false}var R=(b+(c-1)*t.m_nDivHeight/2)/c;w=-Math.round(t.m_nCanvasStdYPos+R/d);p+=w;b+=c*w*d}if(t.m_bXBorderExists){var H=v*(I-V[0])*O-x;var G=v*(I-y[0])*O+t.m_nDivWidth-x;var k=true;if(H<-t.m_nMaxPixelBeyondPoles){x=v*(I-V[0])*O+t.m_nMaxPixelBeyondPoles}else if(G>t.m_nMaxPixelBeyondPoles){x=v*(I-y[0])*O+t.m_nDivWidth-t.m_nMaxPixelBeyondPoles}else{k=false}if(k){if(a){return false}var W=(x+(c-1)*t.m_nDivWidth/2)/c;w=-Math.round(t.m_nCanvasStdXPos+W/d);I+=w;x+=c*w*v}}var F=s.m_nCurrentX==I&&s.m_nCurrentY==p&&s.m_nCurrentLOD==n;if(F){t.MoveCanvas(s,x,b,T,L);s.m_nExactLOD=u}else{t.InvalidateCanvas(t.m_Canvas[1]);if(M==0){var Z=s.getContext("2d");Z.clearRect(0,0,s.width,s.height)}var N=t.m_Canvas[M];t.MoveCanvas(N,x,b,T,L);t.m_MapManager.RequestTiles(N,t.m_MapLayerStack,I,p,t.m_nTilesX,t.m_nTilesY,0,0,0,0,n,false);N.m_nExactLOD=u;if(M==1){t.ToggleCanvas(t)}}if(r!=true){t.InternalRenderLayer(t.m_Canvas[t.m_nOverlayIndex],false,!F,!F,u)}t.m_LastDefinedCenterPos=m?undefined:e;t.InternalOnMoveLayer(s,i);if(u!=_){t.InternalOnZoomLayer(t.m_Canvas[t.m_nOverlayIndex],i)}if(t.m_bNavControlVisible&&t.m_NavControl){t.m_NavControl.AdjustScrollPoint(u)}return true};t.RefreshMapLayerStack=function(){var e=t.m_RefMapLayerStack?t.m_RefMapLayerStack.m_Name:t.m_MapLayerStack.m_Name;if(e){t.SetMapLayerStack(e);t.AddCopyright()}};t.SetMapLayerStack=function(e){var n=t.m_Ctx.m_MapLayerStackManager.GetMapLayerStack(e);if(n==null){return}if(t.m_Canvas[t.m_nNonDomIndex].m_bCanvasValid){t.SwitchTmpCanvasToActive()}t.m_MapLayerStack=n;var a=t.m_Canvas[0];t.m_MapManager.RequestTiles(a,t.m_MapLayerStack,a.m_nCurrentX,a.m_nCurrentY,t.m_nTilesX,t.m_nTilesY,0,0,0,0,a.m_nCurrentLOD,false);t.InternalRenderLayer(t.m_Canvas[t.m_nOverlayIndex],false,true,true,a.m_nCurrentLOD)};t.ZoomToZoomlevel=function(e,n,a){var i=t.GetInternalDivClientRect();if(i.width!=t.m_nDivWidth||i.height!=t.m_nDivHeight){t.resizeCanvas(0)}t.ZoomToGeoPosition(e,n,false,a)};t.GetMapLayerStack=function(){return t.m_MapLayerStack};t.GetMinLOD=function(){var e=Math.max(t.m_nDivWidth/(t.m_MapManager.m_tileWidth*t.m_nXSizeVisualBorder),t.m_nDivHeight/(t.m_MapManager.m_tileHeight*t.m_nYSizeVisualBorder));var n=Math.log(e)*Math.LOG2E;var a=t.m_MapLayerStack;var i=Math.max(t.m_nMinLodVisualBorder-t.m_nOffsetMinLod,a?a.GetMinLOD():0);var r=Math.max(n,i);if(t.m_fMaxMinLODFraction!=undefined&&r-Math.floor(r)>t.m_fMaxMinLODFraction){return Math.ceil(r)}return r};t.GetMinLODForWidth=function(e){var n=e/t.m_MapManager.m_tileWidth;var a=Math.log(n)*Math.LOG2E;var i=t.m_MapLayerStack;var r=Math.max(t.m_nMinLodVisualBorder,i?i.GetMinLOD():0)-t.m_nOffsetMinLod;return Math.max(a,r)};t.GetMaxLOD=function(){var e=t.m_MapLayerStack;return Math.min(e?e.GetMaxLOD():20,t.m_nMaxLodVisualBorder)};t.GetCurrentZoomlevel=function(){return t.m_Canvas[0].m_nExactLOD};t.GetCenterPos=function(){if(t.m_LastDefinedCenterPos!=undefined){return t.m_LastDefinedCenterPos}var e=t.getCanvas();var n=[t.m_nDivWidth/2-e.getPixelLeft(),t.m_nDivHeight/2-e.getPixelTop()];return t.GetGeoFromPoint(n)};t.InternalRenderVisualObjects=function(e,n,a){var i=Date.now();var r=t.m_VOS;var m=r.length;var o;t.m_nNumOfScalingVOInst=0;VBI.Utilities.BackupFont(n);var l,s;if(a){if(t.m_nShadowIndex!=undefined){l=t.m_Canvas[t.m_nShadowIndex];s=l.getContext("2d");s.clearRect(0,0,l.width,l.height)}}t.BuildCacheDataObj();for(var _=0;_<m;++_){r[_].Init4Render()}for(var v=0;v<m;++v){var d=r[v];if(d.m_Label&&d.m_Label.length){for(var u=0;u<d.m_Label.length;++u){d.m_Label[u].clear()}}d.m_Label=[];if(a){var c=a.base[v];d.m_nPreDataIndex=v;o=d.Render(e,n,c);for(var f=c.clusterings.length;f--;){o+=d.Render(e,n,a.clust[c.clusterings[f].i],l,s,true)}}else{o=d.Render(e,n)}if(o!=undefined){t.m_nNumOfScalingVOInst+=o}}this.InvalidateInvisibleHots();if(t.m_DesignVO){t.m_DesignVO.Render(e,n)}var h=t.m_Canvas[t.m_nLabelIndex];var C=h.getContext("2d");VBI.Utilities.BackupFont(C);C.clearRect(0,0,h.width,h.height);t.InternalRenderLabels(h,C);VBI.Utilities.RestoreFont(C);VBI.Utilities.RestoreFont(n);t.DestroyCacheDataObj();t.m_nLastRenderingTime=Date.now()-i;if(t.m_Ctx.moThumbnail){t.Copy2Thumbnail()}};t.TriggerReRenderTimer=function(e){window.clearInterval(t.m_ReRenderTimer);t.m_ReRenderTimer=window.setInterval(function(){window.clearInterval(t.m_ReRenderTimer);t.m_ReRenderTimer=null;if(!t.m_bNonIntPosStable){t.m_bNonIntPosStable=Date.now()}t.RenderAsync(true);if(t.m_bLineAnimationRunning){t.TriggerReRenderTimer(15)}},e)};t.AddThumbnailText=function(e,n){var a,t,i,r;var m=e.getContext("2d");switch(n.nFontPos){case 2:case 3:case 4:a=e.width;i="right";break;case 0:case 1:case 5:a=e.width/2;i="center";break;default:a=0;i="left";break}switch(n.nFontPos){case 4:case 5:case 6:t=e.height;r="bottom";break;case 7:case 0:case 3:t=e.height/2;r="middle";break;default:t=0;r="top";break}var o=VBI.Types.string2rgba(n.strCol);m.font=n.strFont;m.fillStyle=m.strokeStyle=VBI.Utilities.RgbToHex(o[0],o[1],o[2]);m.textAlign=i;m.textBaseline=r;m.fillText(n.strText,a,t)};t.GetOverlayPicture=function(e){var n;var a;var i=t.GetStretchFactor4Mode();var r=VBI.Utilities.CreateGeoSceneCanvas("temporarynondomlayer",t.m_nDivWidth,t.m_nDivHeight,0,2);var m=r.getContext("2d");if(e&2){n=t.m_Canvas[0];var o=t.GetCurrentZoomFactors();m.drawImage(n,-n.m_pixelLeft/o[0],-n.m_pixelTop/o[1],t.m_nDivWidth/o[0],t.m_nDivHeight/o[1],0,0,t.m_nDivWidth,t.m_nDivHeight)}n=t.m_Canvas[t.m_nOverlayIndex];m.drawImage(n,-n.m_pixelLeft/i[0],-n.m_pixelTop/i[1],t.m_nDivWidth/i[0],t.m_nDivHeight/i[1],0,0,t.m_nDivWidth,t.m_nDivHeight);if(e&1){n=t.m_Canvas[t.m_nLabelIndex];m.drawImage(n,-n.m_pixelLeft/i[0],-n.m_pixelTop/i[1],t.m_nDivWidth/i[0],t.m_nDivHeight/i[1],0,0,t.m_nDivWidth,t.m_nDivHeight)}try{a=r.toDataURL("png")}catch(e){VBI.Trace(e.message);return""}return a};t.Copy2Thumbnail=function(){var e=t.m_Canvas[t.m_nThumbnailIndex];var n=t.m_Canvas[0];var a=e.getContext("2d");var i=t.GetCurrentZoomFactors();var r=t.GetStretchFactor4Mode();a.clearRect(0,0,e.width,e.height);a.drawImage(n,-n.m_pixelLeft/i[0],-n.m_pixelTop/i[1],t.m_Ctx.moThumbnail.nOrgWidth/i[0],t.m_Ctx.moThumbnail.nOrgHeight/i[1],0,0,e.clientWidth,e.clientHeight);n=t.m_Canvas[t.m_nOverlayIndex];a.drawImage(n,-n.m_pixelLeft/r[0],-n.m_pixelTop/r[1],t.m_Ctx.moThumbnail.nOrgWidth/r[0],t.m_Ctx.moThumbnail.nOrgHeight/r[1],0,0,e.clientWidth,e.clientHeight);var m=t.m_Ctx.moThumbnail;if(m.strFont&&m.nFontPos!=undefined&&m.strText){t.AddThumbnailText(e,m)}};t.CopyCanvasAway=function(e,n){var a=n.getContext("2d");a.clearRect(0,0,n.width,n.height);a.drawImage(e,0,0,e.width,e.height)};t.UpdatePreData4Selected=function(e,n){var a=t.m_Ctx.m_Clustering;if(e!=undefined&&a){a.VerifyCurrentSelection(t.m_VOS,t.m_PreassembledData,t.m_Ctx);a.AddSingle2Selected(e,t.m_VOS,n,t.m_PreassembledData,t.m_Ctx)}};t.UpdatePreData4SelArray=function(e){var n=t.m_Ctx.m_Clustering;if(n){n.VerifyCurrentSelection(t.m_VOS,t.m_PreassembledData,t.m_Ctx);n.AddMultiple2Selected(e,t.m_VOS,t.m_PreassembledData,t.m_Ctx)}};VBI.addSceneLabelFunctions(t);t.InvalidatePreassembledData=function(e,n){var a=t.m_HotItem.m_VO;var i;if(a!=undefined&&a.IsClusterable()){i=a.SwitchHotItemToStandard()}t.m_PreassembledData=undefined;if(t.m_nShadowIndex!=undefined){t.DisableShadowLayer()}return i};t.DisableShadowLayer=function(){var e=t.m_Canvas[t.m_nShadowIndex];var n=e.getContext("2d");n.clearRect(0,0,e.width,e.height);t.clearCanvas(t.m_nShadowIndex);t.m_Canvas.splice(t.m_nShadowIndex,1);t.m_nShadowIndex=undefined};t.SwitchCanvasSize=function(e,n,a){var i=[n,a];var r=i[0]*i[1]/1024;if(t.m_nCanvasMaxPixel<r){var m=Math.sqrt(r/t.m_nCanvasMaxPixel);i[0]=Math.floor(i[0]/m);i[1]=Math.floor(i[1]/m);t.m_bObjCanvasMode=2}else{t.m_bObjCanvasMode=1}e.width=t.m_Canvas[t.m_nLabelIndex].width=i[0];e.height=t.m_Canvas[t.m_nLabelIndex].height=i[1];if(t.m_nShadowIndex){t.m_Canvas[t.m_nShadowIndex].width=i[0];t.m_Canvas[t.m_nShadowIndex].height=i[1]}e.setPixelWidth(e.width);e.setPixelHeight(e.height);return i};t.InternalRenderLayer=function(e,n,a,i,r,m){var o=t.m_Canvas[0];var l;var s=t.m_Ctx.m_Clustering;var _=s!=undefined&&s.m_Clusters.length;if(t.m_PreassembledData!=undefined&&!_){l=t.InvalidatePreassembledData(s,o.m_nCurrentLOD)}if(a==false&&r!=undefined){var v=Math.floor(r);if(r==t.m_nLastRenderLOD){return}if(v==Math.floor(t.m_nLastRenderLOD)&&(r!=v&&r>t.GetMinLOD()+.001)){var d=Math.abs(r-t.m_nLastRenderLOD);if(d<t.m_nLastRenderingTime/t.m_nRenderTimeTarget){return}}}t.m_OverlayImage=null;t.m_nLastRenderLOD=r==undefined?-1:r;var u,c=e.getPixelWidth();var f,h=e.getPixelHeight();if(t.m_bObjCanvasMode){var C=t.SwitchCanvasSize(e,c,h);t.m_StretchFactors=[c/C[0],h/C[1]];t.m_ZoomFactors=[C[0]/t.m_nWidthCanvas,C[1]/t.m_nHeightCanvas];u=c;f=h}else{u=t.m_nWidthCanvas;f=t.m_nHeightCanvas;e.setPixelWidth(u);e.setPixelHeight(f);t.m_ZoomFactors=[1,1];t.m_StretchFactors=[c/t.m_nWidthCanvas,h/t.m_nHeightCanvas]}var g=e.getContext("2d");if(n){g.clearRect(0,0,e.width,e.height);e.setPixelWidth(c);e.setPixelHeight(h);return}var M=false;if(_){this.SetLastHotItem(t.m_HotItem);var I=Date.now();t.m_PreassembledData=s.DoClustering(this,o.m_nCurrentLOD,o.m_nCurrentX,o.m_nCurrentY,t.m_nTilesX,t.m_nTilesY,t.m_VOS,t.m_Ctx,l,a,i,t.m_nDataVersion);this.CheckHotItem();if(t.m_PreassembledData.config.bNeedsShadowLayer&&t.m_nShadowIndex==undefined){t.m_nShadowIndex=t.m_Canvas.length;t.m_Canvas.push(VBI.Utilities.CreateGeoSceneCanvas(t.m_TargetName+"-"+t.m_ID+"-shadow",u,f));t.InitializeCanvas(t.m_Canvas[t.m_nShadowIndex],t.m_Canvas[t.m_nOverlayIndex]);M=true}if(!t.m_PreassembledData.config.bNeedsShadowLayer&&t.m_nShadowIndex!=undefined){t.DisableShadowLayer()}t.m_nLastClusteringTime=Date.now()-I}g.clearRect(0,0,e.width,e.height);t.InternalRenderVisualObjects(e,g,t.m_PreassembledData);if(t.m_bObjCanvasMode!=1){e.setPixelWidth(c);e.setPixelHeight(h)}if(M){t.MoveCanvas2ObjectCanvas(t.m_Canvas[t.m_nShadowIndex])}t.InternalOnRenderLayer(e);if(t.m_Scale){t.m_Scale.Update()}if(t.m_bSwitch2OldCanvasMode&&o.m_nExactLOD==Math.round(o.m_nExactLOD)){t.m_bSwitch2OldCanvasMode=undefined;t.m_bObjCanvasMode=0;VBI.Trace("Switching back to old object canvas rendering style due to performance issues ")}};t.InternalOnMoveLayer=function(e,n){t.m_Ctx.m_Windows.NotifySceneMove(this);var a;if((a=t.m_Ctx.m_Actions)&&n!=true){var i=a.findAction("CenterChanged",t,"Map");if(i){var r=t.m_Canvas[t.m_nOverlayIndex];var m=r.getPixelWidth();var o=r.getPixelHeight();var l=t.GetPosFromPoint([0,0]);var s=t.GetPosFromPoint([m,o]);if(!t.m_Proj.m_bIsIsogonal){var _=t.GetPosFromPoint([m,0]);var v=t.GetPosFromPoint([0,o]);l=[Math.min(l[0],v[0]),Math.min(l[1],_[1])];s=[Math.max(_[0],s[0]),Math.max(v[1],s[1])]}var d=t.GetInternalDivClientRect();var u=-r.getPixelLeft();var c=-r.getPixelTop();var f=t.GetPosFromPoint([u,c]);var h=t.GetPosFromPoint([u+d.width,c+d.height]);var C={level:t.GetCurrentZoomlevel().toString(),min:l[0].toString()+";"+l[1].toString()+";0",max:s[0].toString()+";"+s[1].toString()+";0",vpmin:f[0].toString()+";"+f[1].toString()+";0",vpmax:h[0].toString()+";"+h[1].toString()+";0"};t.m_Ctx.FireAction(i,t,this,null,C)}}this.m_EvtCont.fire("onMove",{canvas:e});t.m_Ctx.onMoveLayer(e)};t.InternalOnZoomLayer=function(e,n){t.m_Ctx.m_Windows.NotifySceneZoom(this);if(n!=true){var a=t.m_Ctx.m_Actions;if(a){var i=a.findAction("ZoomChanged",t,"Map");if(i){var r=t.m_Canvas[t.m_nOverlayIndex];var m=r.getPixelWidth();var o=r.getPixelHeight();var l=t.GetPosFromPoint([0,0]);var s=t.GetPosFromPoint([m,0]);var _=t.GetPosFromPoint([0,o]);var v=t.GetPosFromPoint([m,o]);var d=t.GetInternalDivClientRect();var u=-r.getPixelLeft();var c=-r.getPixelTop();var f=t.GetPosFromPoint([u,c]);var h=t.GetPosFromPoint([u+d.width,c+d.height]);var C={level:t.GetCurrentZoomlevel().toString(),min:Math.min(l[0],_[0]).toString()+";"+Math.min(l[1],s[1]).toString()+";0",max:Math.max(v[0],s[0]).toString()+";"+Math.max(_[1],v[1]).toString()+";0",vpmin:f[0].toString()+";"+f[1].toString()+";0",vpmax:h[0].toString()+";"+h[1].toString()+";0"};if(n!=undefined&&n!=false){C.x=n.x.toString()-d.left;C.y=n.y.toString()-d.top}t.m_Ctx.FireAction(i,t,this,null,C)}}}this.m_EvtCont.fire("onZoom",{canvas:e});t.m_Ctx.onZoomLayer(e)};t.InternalOnRenderLayer=function(e){t.m_Ctx.onRenderLayer(e);if(t.GetHomeLocation){var n=e.getPixelWidth();var a=e.getPixelHeight();var i=[0,0];var r=t.GetHomeLocation();i[0]=r[0];i[1]=r[1];var m=t.GetPointFromGeo(i);e.setPixelWidth(t.m_nWidthCanvas);e.setPixelHeight(t.m_nHeightCanvas);var o=e.getContext("2d");o.clearRect(0,0,e.width,e.height);o.fillStyle="yellow";o.beginPath();o.arc(m[0],m[1],5,0,Math.PI*2,true);o.closePath();o.fill();var l=null;if(t.m_Ctx){l=t.m_Ctx.GetImage("dummy",t.RenderAsync.bind())}if(l){o.drawImage(l,m[0]-l.naturalWidth/2,m[1]-l.naturalHeight)}e.setPixelWidth(n);e.setPixelHeight(a)}};t.MoveObject=function(e,n,a,t,i){e.m_pixelLeft=Math.round(n);e.m_pixelTop=Math.round(a);e.style.left=e.m_pixelLeft.toString()+"px";e.style.top=e.m_pixelTop.toString()+"px";if(t!==undefined){e.m_pixelWidth=Math.round(t);e.style.width=e.m_pixelWidth.toString()+"px"}if(i!==undefined){e.m_pixelHeight=Math.round(i);e.style.height=e.m_pixelHeight.toString()+"px"}};t.InvalidateCanvas=function(e){var n=e.getContext("2d");n.fillStyle="white";n.clearRect(0,0,e.width,e.height);e.m_bInvalid=true};t.MoveCanvas=function(e,n,a,i,r){t.MoveObject(t.m_Canvas[t.m_nOverlayIndex],n,a,i,r);t.MoveObject(t.m_Canvas[t.m_nLabelIndex],n,a,i,r);if(t.m_nShadowIndex!=undefined){t.MoveObject(t.m_Canvas[t.m_nShadowIndex],n,a,i,r)}t.MoveObject(e,n,a,i,r)};t.MoveOnlyThisCanvas=function(e,n,a,i,r){t.MoveObject(e,n,a,i,r)};t.MoveCanvas2ObjectCanvas=function(e){var n=t.m_Canvas[t.m_nOverlayIndex];t.MoveObject(e,n.m_pixelLeft,n.m_pixelTop,n.m_pixelWidth,n.m_pixelHeight)};t.MoveMap=function(e,n){if(VBI.m_bTrace){VBI.Trace("MoveMap"+" DX:"+e+" DY:"+n)}var a=t.m_Canvas[t.m_nNonDomIndex];var i=t.m_Canvas[0];var r=a.m_bCanvasValid?a:i;var m=t.m_MapManager;var o=r.getPixelWidth();var l=r.getPixelHeight();var s=r.getPixelLeft()+e;var _=r.getPixelTop()+n;var v=m.m_tileWidth,d=m.m_tileHeight;var u=o/t.m_nTilesX;var c=l/t.m_nTilesY;var f=l/t.m_nHeightCanvas;var h=1<<i.m_nCurrentLOD;var C=[h,h];var g=[h,h];t.m_Proj.LonLatToUCS(t.m_nBorderMinPoint,C);t.m_Proj.LonLatToUCS(t.m_nBorderMaxPoint,g);if(n>0&&d*f*(r.m_nCurrentY-C[1])-_<-t.m_nMaxPixelBeyondPoles||n<0&&d*f*(r.m_nCurrentY-g[1])+t.m_nDivHeight-_>t.m_nMaxPixelBeyondPoles){if(e==0){return}n=0;_=r.getPixelTop()}if(t.m_bXBorderExists&&(e>0&&v*f*(r.m_nCurrentX-C[0])-s<-t.m_nMaxPixelBeyondPoles||e<0&&v*f*(r.m_nCurrentX-g[0])+t.m_nDivWidth-s>t.m_nMaxPixelBeyondPoles)){if(n==0){return}e=0;s=r.getPixelLeft()}var M=0;var I=0;var p;if(e>0&&(p=s+t.m_nMapMoveXPreLoad)>0){M=Math.ceil(p/u)}else if(e<0&&(p=t.m_nMapMoveXPreLoad+t.m_nDivWidth-(s+o))>0){M=-Math.ceil(p/u)}var D=r.m_nCurrentX-M;if(n>0&&(p=_+t.m_nMapMoveYPreLoad)>0){I=Math.ceil(p/c)}else if(n<0&&(p=t.m_nMapMoveYPreLoad+t.m_nDivHeight-(_+l))>0){I=-Math.ceil(p/c)}var S=r.m_nCurrentY-I;var x=t.m_MapLayerStack;var b=x?x.m_bSingleBMP:false;if(M||I){var T=0,L=0;if(!t.m_Canvas[1].m_bInvalid){t.InvalidateCanvas(t.m_Canvas[1])}t.MoveCanvas(i,i.getPixelLeft()+e,i.getPixelTop()+n);if(a.m_bCanvasValid){if(a.m_nTilesBefSwitch<a.m_nForceSwitchLimit){t.SwitchTmpCanvasToActive()}else{T=a.m_nOffsetX;L=a.m_nOffsetY}}a.m_nTilesBefSwitch=b||Math.abs(M)>=t.m_nTilesX||Math.abs(I)>=t.m_nTilesY?1:(t.m_nTilesX-Math.abs(M))*(t.m_nTilesY-Math.abs(I));a.m_nForceSwitchLimit=Math.ceil(a.m_nTilesBefSwitch/2);a.m_nOffsetX=M+T;a.m_nOffsetY=I+L;t.MoveOnlyThisCanvas(a,s-M*u,_-I*c,o,l);var V=a.getContext("2d");V.clearRect(0,0,i.getPixelWidth(),i.getPixelHeight());if(m.RequestTiles(a,t.m_MapLayerStack,D,S,t.m_nTilesX,t.m_nTilesY,0,0,0,0,i.m_nCurrentLOD,false)){a.m_bCanvasValid=true}else{t.SwitchTmpCanvasToActive()}}else{t.MoveCanvas(i,i.getPixelLeft()+e,i.getPixelTop()+n);t.MoveObject(t.m_Canvas[1],t.m_Canvas[1].getPixelLeft()+e,t.m_Canvas[1].getPixelTop()+n);if(a.m_bCanvasValid){t.MoveOnlyThisCanvas(a,s,_)}}var y=t.m_VOS;var O=false;for(var P=0,B=y.length;P<B;++P){if(y[P].m_Label.length>0&&y[P].CalculateLabelPos){O=true;break}}if(O){var w=t.m_Canvas[t.m_nLabelIndex].getContext("2d");w.clearRect(0,0,t.m_Canvas[t.m_nLabelIndex].width,t.m_Canvas[t.m_nLabelIndex].height);VBI.Utilities.BackupFont(w);t.InternalRenderLabels(t.m_Canvas[t.m_nLabelIndex],w);VBI.Utilities.RestoreFont(w)}t.InternalOnMoveLayer(t.m_Canvas[t.m_nOverlayIndex]);t.m_LastDefinedCenterPos=undefined};t.AdaptZoomFactor=function(e,n,a,i,r){var m={};m.bZoomNotPossible=true;var o=1<<e.m_nCurrentLOD;if(e.m_nCurrentY<0&&i<-e.m_nCurrentY*(e.getPixelHeight()/t.m_nTilesY)){return m}if(e.m_nCurrentY+t.m_nTilesY>o&&i>(o-e.m_nCurrentY)*(e.getPixelHeight()/t.m_nTilesY)){return m}if(n<1){var l=Math.max(t.m_nDivWidth/(e.getPixelWidth()*t.m_nXSizeVisualBorder)*(t.m_nTilesX/o),t.m_nDivHeight/(e.getPixelHeight()*t.m_nYSizeVisualBorder)*(t.m_nTilesY/o));if(n<l){if(l>=1&&n!=0){return m}n=l}}var s=r&&(t.m_nZoomMode||n==t.m_nLodFactorZoomIn||n==t.m_nLodFactorZoomOut);var _=e.m_nExactLOD+Math.log(n)*Math.LOG2E;var v=t.GetMinLOD();if(v!=Math.round(v)&&n!=1&&e.m_nExactLOD<=Math.ceil(v)&&Math.round(r*_)==Math.round(r*v)){s=false}if(s&&Math.round(r*_)!=r*_){_=Math.round(r*_)/r;n=Math.pow(2,_-e.m_nExactLOD)}else if(_<v){_=v;n=Math.pow(2,_-e.m_nExactLOD)}m.factor=n;m.nNewLod=Math.floor(_);m.lodFallsOnInteger=Math.round(_)==_;m.bZoomNotPossible=_>t.GetMaxLOD()||_<v;return m};t.ZoomMap=function(e,n,a,i,r){t.m_bNonIntPosStable=false;if(t.m_Canvas[t.m_nNonDomIndex].m_bCanvasValid){t.SwitchTmpCanvasToActive()}var m=t.m_Canvas[0];var o=t.m_Canvas[1];var l=t.m_MapManager;var s=l.m_tileWidth,_=l.m_tileHeight;var v,d,u=0,c=0;var f=m.getPixelLeft(),h=m.getPixelTop();var C=m.getPixelWidth(),g=m.getPixelHeight();var M=o.getPixelWidth();var I=t.AdaptZoomFactor(m,e,n,a,i);if(I.bZoomNotPossible){return}e=I.factor;var p=I.nNewLod;if(VBI.m_bTrace){VBI.Trace("Zoom by "+e+" to "+n+"/"+a)}var D=Math.round(C*e);var S=Math.round(D*m.height/m.width);var x=Math.round(f-(e-1)*n);var b=Math.round(h-(e-1)*a);if(e<1){var T=1<<m.m_nCurrentLOD;var L=[T,T];var V=[T,T];t.m_Proj.LonLatToUCS(t.m_nBorderMinPoint,L);t.m_Proj.LonLatToUCS(t.m_nBorderMaxPoint,V);var y=S/t.m_nHeightCanvas;var O=(m.m_nCurrentY-L[1])*_*y-b;if(O<-t.m_nMaxPixelBeyondPoles){b=Math.round(_*(m.m_nCurrentY-L[1])*y+t.m_nMaxPixelBeyondPoles);a=(h-b)/(e-1)}else{var P=_*(m.m_nCurrentY-V[1])*y+t.m_nDivHeight-b;if(P>t.m_nMaxPixelBeyondPoles){b=Math.round(_*(m.m_nCurrentY-V[1])*y+t.m_nDivHeight-t.m_nMaxPixelBeyondPoles);a=(h-b)/(e-1)}}if(t.m_bXBorderExists){var B=(m.m_nCurrentX-L[0])*s*y-x;if(B<-t.m_nMaxPixelBeyondPoles){x=Math.round(s*(m.m_nCurrentX-L[0])*y+t.m_nMaxPixelBeyondPoles);n=(f-x)/(e-1)}var w=(m.m_nCurrentX-V[0])*s*y+t.m_nDivWidth-x;if(w>t.m_nMaxPixelBeyondPoles){x=Math.round(s*(m.m_nCurrentX-V[0])*y+t.m_nDivWidth-t.m_nMaxPixelBeyondPoles);n=(f-x)/(e-1)}}}t.MoveCanvas(m,x,b,D,S);var A=D/t.m_nTilesX;var R=S/t.m_nTilesY;var H=false;if(p==m.m_nCurrentLOD){if(!o.m_bInvalid){var G=Math.round(M*e);var k=Math.round(o.getPixelHeight()*e);if(G<=t.m_nMaxCanvasDimension&&k<=t.m_nMaxCanvasDimension){var W=o.getPixelLeft();var F=o.getPixelTop();var Z=Math.round(W-(e-1)*(n+f-W));var N=Math.round(F-(e-1)*(a+h-F));t.MoveObject(o,Z,N,Math.round(M*e),Math.round(o.getPixelHeight()*e))}else{t.InvalidateCanvas(t.m_Canvas[1])}}m.m_nExactLOD=m.m_nCurrentLOD+Math.log(A/s)*Math.LOG2E;if(x>0||b>0||x+D<t.m_nDivWidth||b+S<t.m_nDivHeight){H=true;v=-Math.ceil(x/A);d=-Math.ceil(b/R);u=x+v*A;c=b+d*R;x=m.m_nCurrentX+v;b=m.m_nCurrentY+d;if(VBI.m_bTrace){VBI.Trace("run out viewport newTop="+b+" nTilesY="+d+" nPosY="+c+" yOffset="+a+"\n")}}}else{H=true;var E=Math.pow(2,m.m_nCurrentLOD-p);var Y=g/t.m_nHeightCanvas;var j=n/Y+E*(t.m_nDivWidth/2-f-n);var X=a/Y+E*(t.m_nDivHeight/2-h-a);if(p>m.m_nCurrentLOD){v=Math.round(j/E/s-t.m_nTilesX/2);d=Math.round(X/E/_-t.m_nTilesY/2);u=Math.ceil(x+v*A*E);c=Math.ceil(b+d*R*E)}else{var U=(m.m_nCurrentX%E+E)%E;var z=(m.m_nCurrentY%E+E)%E;v=Math.round((j/s+U)/E-t.m_nTilesX/2);d=Math.round((X/_+z)/E-t.m_nTilesY/2);u=x+A*(v*E-U);c=b+R*(d*E-z)}x=Math.floor(m.m_nCurrentX/E+v);b=Math.floor(m.m_nCurrentY/E+d);D=I.lodFallsOnInteger?s*t.m_nTilesX:Math.ceil(D*E);S=I.lodFallsOnInteger?_*t.m_nTilesY:Math.ceil(S*E)}var q=p+Math.log(D/t.m_nWidthCanvas)*Math.LOG2E;if(H){o.m_nExactLOD=q;t.MoveCanvas(o,u,c,D,S);t.m_MapManager.RequestTiles(t.m_Canvas[1],t.m_MapLayerStack,x,b,t.m_nTilesX,t.m_nTilesY,0,0,0,0,p,true);m.m_Scene.ToggleCanvas(m.m_Scene)}t.InternalRenderLayer(t.m_Canvas[t.m_nOverlayIndex],false,H,H,q);if(t.m_bNavControlVisible&&t.m_NavControl){t.m_NavControl.AdjustScrollPoint(q)}t.InternalOnMoveLayer(m,r);t.InternalOnZoomLayer(t.m_Canvas[t.m_nOverlayIndex],r);t.m_LastDefinedCenterPos=t.m_LastZoomArea=undefined};t.ZoomOtherCanvas=function(e,n,a,i,r){var m=Math.round(e.getPixelLeft()-(a-1)*i);var o=Math.round(e.getPixelTop()-(a-1)*r);var l=Math.round(e.getPixelWidth()*a);var s=Math.round(e.getPixelHeight()*a);t.MoveObject(e,m,o,l,s)};t.AnimationStep=function(){var e=t.m_Canvas[0].m_nExactLOD;var n=t.m_Canvas[0].getBoundingClientRect();if(e!=t.AnimZoomTarget){var a=Math.min((Date.now()-t.AnimZoomTimestamp)/t.AnimZoomDuration,1);var i=Math.min(a*(2-a),1);var r=Math.pow(2,t.AnimZoomOrigin+(t.AnimZoomTarget-t.AnimZoomOrigin)*i)/Math.pow(2,e);t.ZoomMap(r,t.AnimZoomClientX-n.left,t.AnimZoomClientY-n.top,a<1?0:1,true);if(a<1){t.m_AnimZoomRequestID=window.requestAnimationFrame(t.AnimationStep);return}}t.ZoomMap(1,t.AnimZoomClientX-n.left,t.AnimZoomClientY-n.top,1,true);t.InternalOnMoveLayer(t.m_Canvas[t.m_nOverlayIndex],t.AnimZoomClickCoords);t.InternalOnZoomLayer(t.m_Canvas[t.m_nOverlayIndex],t.AnimZoomClickCoords);t.m_AnimZoomRequestID=0;t.AnimZoomClientX=t.AnimZoomClientY=t.AnimZoomClickCoords=undefined;t.AnimZoomTimestamp=t.AnimZoomDuration=t.AnimZoomOrigin=t.AnimZoomTarget=undefined};t.AnimateZoom=function(e,n,a,i,r){var m=r!=undefined&&r.clientX!=undefined?{x:r.clientX,y:r.clientY}:undefined;t.AnimZoomClientX=n;t.AnimZoomClientY=a;t.AnimZoomClickCoords=m;t.AnimZoomOrigin=t.m_Canvas[0].m_nExactLOD;t.AnimZoomTarget=Math.round(t.AnimZoomTarget?t.AnimZoomTarget:t.AnimZoomOrigin)+(e?1:-1);t.AnimZoomTimestamp=Date.now();t.AnimZoomDuration=Math.pow(Math.abs(t.AnimZoomTarget-t.AnimZoomOrigin),.8)*300;if(t.m_AnimZoomRequestID){window.cancelAnimationFrame(t.m_AnimZoomRequestID)}t.m_AnimZoomRequestID=window.requestAnimationFrame(t.AnimationStep)};t.AnimationToGeoStep=function(e,n,a,i,r){if(--t.m_nAnimOpenTicks){t.ZoomToZoomlevel(n,a-(t.m_nAnimOpenTicks-1)*(a-i)/(t.m_nAnimTicks-1),true);var m=Date.now(),o=e;if(t.m_AnimTimestamp){var l=Math.max(0,m-t.m_AnimTimestamp);o=Math.max(10,2*e-l)}t.m_AnimTimestamp=m;t.m_AnimZoomTimer=window.setTimeout(function(){t.AnimationToGeoStep(e,n,a,i,r)},o);return}t.InternalOnZoomLayer(t.m_Canvas[t.m_nOverlayIndex]);if(t.m_AnimZoomTimer){t.m_nAnimOpenTicks=t.m_nAnimationTicks=undefined;window.clearTimeout(t.m_AnimZoomTimer);t.m_AnimZoomTimer=null;t.InternalRenderLayer(t.m_Canvas[t.m_nOverlayIndex],false,false,false,t.m_Canvas[0].m_nExactLOD)}};t.AnimateZoomToGeo=function(e,n,a){var i=t.m_Canvas[0].m_nExactLOD;if(i==n){return}t.m_bNonIntPosStable=false;var r=2*t.m_nTicksInALod;if(t.m_AnimZoomTimer){window.clearTimeout(t.m_AnimZoomTimer)}t.m_nAnimTicks=2+Math.abs(Math.round((i-n)*r));t.m_nAnimOpenTicks=t.m_nAnimTicks;var m=i;var o=n;var l=a*r/t.m_nAnimTicks;t.m_AnimZoomTimer=window.setTimeout(function(){t.AnimationToGeoStep(l,e,o,m,r)},l)};t.PerFormMultiSelect=function(e,n){if(t.m_nInputMode!=VBI.InputModeLassoSelect&&t.m_nInputMode!=VBI.InputModeRectSelect){return}var a,i;if(e.type.indexOf("touch")>=0||e.type.indexOf("pointer")>=0){a=i=false}else{i=e.ctrlKey;a=e.shiftKey}var r=t.m_VOS.length;var m=false;var o=[],l=[];var s,_,v,d,u,c;var f=false;for(var h=0;h<r;++h){l[h]=[];o=[];if(t.m_nInputMode==VBI.InputModeLassoSelect&&!t.m_VOS[h].LassoSelect){continue}if(t.m_nInputMode==VBI.InputModeLassoSelect){f=t.m_VOS[h].LassoSelect(n.m_PosMoves,o,l[h])}else{f=t.m_VOS[h].RectSelect(n.selectionRect,o,l[h])}if(f){c=t.m_VOS[h];if(!(u=c.m_DataSource)){continue}if(!a&&!i&&u){if(v=u.GetCurrentNode(t.m_Ctx)){for(_=0;_<=1;_++){for(s=0;s<v.m_dataelements.length;++s){u.Select(s);if(d=u.GetIndexedElement(t.m_Ctx,s)){if(c.IsSelected(t.m_Ctx)){if(VBI.IndexOf(o,s)==-1){c.Select(d,t.m_Ctx,false);m=true}}else if(VBI.IndexOf(o,s)!=-1){c.Select(d,t.m_Ctx,true);m=true}}}}}}else if(a){for(s=0;s<o.length;s++){u.Select(o[s]);if(d=u.GetIndexedElement(t.m_Ctx,o[s])){if(!c.IsSelected(t.m_Ctx)){c.Select(d,t.m_Ctx,true);m=true}}}}else if(i){var C=[];for(s=0;s<o.length;s++){u.Select(o[s]);var g={};if(c.IsSelected(t.m_Ctx)){g.toSelect=false}else{g.toSelect=true}g.idx=s;C.push(g)}for(_=0;_<=1;_++){for(s=0;s<C.length;s++){u.Select(o[C[s]]);if(d=c.m_DataSource.GetIndexedElement(t.m_Ctx,o[C[s].idx])){if(_==0&&C[s].toSelect){c.Select(d,t.m_Ctx,true);m=true}if(_==1&&!C[s].toSelect){c.Select(d,t.m_Ctx,false);m=true}}}}}}}if(t.m_PreassembledData&&l.length){t.UpdatePreData4SelArray(l)}var M;if(m&&(M=t.m_Ctx.m_Actions)){var I;if(I=M.findAction("Select",t,"General")){t.m_Ctx.FireAction(I,t,"General",null,null)}}};t.endTrackingMode=function(){if(t.m_nInputMode==VBI.InputModeRectSelect||t.m_nInputMode==VBI.InputModeLassoSelect||t.m_nInputMode==VBI.InputModeRectZoom){t.m_DesignVO.ExitMode()}};t.GetViewport=function(){var e=t.GetStretchFactor4Mode();var n=t.GetInternalDivClientRect();var a=n.width/e[0];var i=n.height/e[1];var r=t.m_Canvas[0].getPixelLeft()/e[0];var m=t.m_Canvas[0].getPixelTop()/e[1];return[-r,-m,-r+a,-m+i]};t.IsTransparent=function(e,n){var a=t.m_Canvas[t.m_nOverlayIndex];if(!a){return false}var i=a.getContext("2d");var r=a.getBoundingClientRect();var m=Date.now();var o=i.getImageData(Math.round(e-r.left),Math.round(n-r.top),1,1);if(t.m_bObjCanvasMode&&VBI.m_bIsMyChromeTest&&(a.width!=t.m_nlstWidth||a.height!=t.m_nlstHeight)){var l=Date.now()-m;t.m_nlstWidth=a.width;t.m_nlstHeight=a.height;if(l>40){t.m_nGetImageDataIncidents++;if(t.m_nGetImageDataIncidents>2||l>200){t.m_bSwitch2OldCanvasMode=true}}}var s=o.data[3];return s?false:true};t.GetCurrentZoomFactors=function(){return[t.m_StretchFactors[0]*t.m_ZoomFactors[0],t.m_StretchFactors[1]*t.m_ZoomFactors[1]]};t.GetStretchFactor4Mode=function(){return t.m_StretchFactors};t.GetZoomFactor4Mode=function(){return t.m_ZoomFactors};t.ToggleCanvas=function(e){var n=e.m_Canvas[0];e.m_Canvas[0]=e.m_Canvas[1];e.m_Canvas[1]=n;e.m_Canvas[0].className="vbi-geoscenecanvas vbi-map-inactive";e.m_MapsLayerDiv.insertBefore(e.m_Canvas[1],e.m_Canvas[0]);jQuery.sap.delayedCall(0,this,function(n){if(e.m_Canvas[0]){e.m_Canvas[0].className="vbi-geoscenecanvas vbi-map-active"}})};VBI.addScenePositioningFunctions(t);t.getCanvas=function(){return t.m_Canvas[0]};t.SetEdgeTransition=function(e,n,a,t,i,r,m){e[n+9*t]=1;e[n+9*a]=m;e[n+9*i]=m;e[a+9*n]=m;e[i+9*n]=m;e[n+9*r]=m;e[r+9*n]=m};t.SetCornerTransition=function(e,n,a,t){e[n+9*a]=t;e[a+9*n]=t};t.BuildQuarterTransistionTable=function(){var e=[];var n;for(n=0;n<81;++n){e.push(0)}for(n=0;n<9;++n){e[n]=1;e[9*n]=1}t.SetEdgeTransition(e,3,7,6,8,2,16);t.SetEdgeTransition(e,2,4,1,7,6,8);t.SetEdgeTransition(e,6,4,3,5,1,4);t.SetEdgeTransition(e,1,5,2,8,3,2);t.SetCornerTransition(e,4,8,18);t.SetCornerTransition(e,5,7,24);return e};t.clearTimers=function(){if(t.m_AnimZoomTimer){window.clearTimeout(t.m_AnimZoomTimer);t.m_AnimZoomTimer=null}};t.clearCanvas=function(e){t.m_Canvas[e].m_Scene=null;t.m_Canvas[e]=null};t.clearCanvases=function(){for(var e=0,n=t.m_Canvas.length;e<n;++e){t.clearCanvas(e)}t.m_Canvas=[]};t.Remove=function(){if(t.m_Div){t.SetInputMode(VBI.InputModeDefault);while(t.m_Div.firstChild){t.m_Div.removeChild(t.m_Div.firstChild)}t.m_Div.parentElement.removeChild(t.m_Div);t.m_Div=null;t.clearTimers();t.clearCanvases()}if(t.m_Target){while(t.m_Target.firstChild){t.m_Target.removeChild(t.m_Target.firstChild)}t.m_Target=null}};t.AddCopyright=function(){if(!t.m_MapLayerStack){return}if(!t.m_DivCopyright){var e=VBI.Utilities.CreateGeoSceneDivCSS(t.m_Target.id+"-copyright","vbi-copyright");e.setAttribute("role",sap.ui.core.AccessibleRole.ContentInfo);e.m_VBIType="C";t.m_MapDecoDiv.appendChild(e);t.m_DivCopyright=e}var n=t.m_MapLayerStack.GetCopyright();if(n){t.m_DivCopyright.innerHTML=n}else{t.m_DivCopyright.style.paddingRight=0;t.m_DivCopyright.style.paddingLeft=0}};t.ReAwake=function(){t.m_MapLayerStack=t.m_RefMapLayerStack;t.AddCopyright();t.resizeCanvas(0,true)};t.Awake=function(e,n,a){t.m_Target=VBI.Utilities.GetDOMElement(e);if(!t.m_Target){t.m_Target=VBI.Utilities.CreateDOMElement(e,"1px","1px")}if(t.m_Div){if(!t.m_Div.children||!t.m_Div.children.length){t.m_awakeFrame={pos:t.GetCenterPos(),lod:t.GetCurrentZoomlevel()}}else{if(t.m_Div.parentNode==t.m_Target){return}t.m_Target.appendChild(t.m_Div);if(t.m_bNavControlVisible&&t.m_NavControl){t.m_NavControl.AttachEvents()}return}}t.m_TargetName=e;t.m_MapManager=typeof n!=="undefined"?n:VBI.MapManager;t.m_MapLayerStack=typeof a!=="undefined"?a:t.m_RefMapLayerStack;t.m_Div=VBI.Utilities.CreateGeoSceneDivCSS(e+"-geoscene-viewport","vbi-viewport");t.m_Div.setAttribute("role",sap.ui.core.AccessibleRole.Presentation);t.m_Target.appendChild(t.m_Div);t.m_MoveableLayer=VBI.Utilities.CreateGeoSceneDivCSS(e+"-geoscene-moveable-layer","vbi-moveable-layer");t.m_MoveableLayer.setAttribute("role",sap.ui.core.AccessibleRole.Group);t.m_MoveableLayer.setAttribute("tabindex","0");t.m_Div.appendChild(t.m_MoveableLayer);t.m_MapsLayerDiv=VBI.Utilities.CreateGeoSceneDivCSS(e+"-geoscene-mapslayer","vbi-map-layer");t.m_MapsLayerDiv.setAttribute("role",sap.ui.core.AccessibleRole.Presentation);t.m_MoveableLayer.appendChild(t.m_MapsLayerDiv);
// add a layer div for map deco like scale and copyright
t.m_MapDecoDiv=VBI.Utilities.CreateGeoSceneDivCSS(e+"-geoscene-decolayer","vbi-structure-layer");t.m_MapDecoDiv.setAttribute("role",sap.ui.core.AccessibleRole.Presentation);t.m_Div.appendChild(t.m_MapDecoDiv);t.m_LegendLayerDiv=VBI.Utilities.CreateGeoSceneDivCSS(e+"-geoscene-legendlayer","vbi-structure-layer");t.m_LegendLayerDiv.setAttribute("role",sap.ui.core.AccessibleRole.Group);t.m_LegendLayerDiv.setAttribute("tabindex","0");t.m_Div.appendChild(t.m_LegendLayerDiv);t.m_WindowLayerDiv=VBI.Utilities.CreateGeoSceneDivCSS(e+"-geoscene-winlayer","vbi-structure-layer");t.m_WindowLayerDiv.setAttribute("role",sap.ui.core.AccessibleRole.Presentation);if(VBI.m_bIsPhone){t.m_Div.appendChild(t.m_WindowLayerDiv)}else{t.m_MoveableLayer.appendChild(t.m_WindowLayerDiv)}t.DoAwake(e)};t.setProjection=function(){if(!t.m_RefMapLayerStack||!t.m_RefMapLayerStack.m_MapLayerArray||!t.m_RefMapLayerStack.m_MapLayerArray.length){return new VBI.MercatorProjection}var e=t.m_RefMapLayerStack.m_MapLayerArray;var n=e[0].GetMapProvider().m_nProjection;for(var a=2;a<e.length;++a){if(e[a].GetMapProvider().m_nProjection!=n){if(VBI.m_bTrace){VBI.Trace("projection of layer "+a+" is inconsistent to base layer. Choosing projection of base layer")}}}switch(n){case 1:return new VBI.MercatorProjection;case 2:return new VBI.LinearProjection;case 3:return new VBI.ElliMercatorProjection;default:return new VBI.MercatorProjection}};t.DoAwake=function(e){t.CalculateCanvasDimensions();t.CreateCanvases();
// append copyright
if(!t.m_Ctx.moThumbnail){t.AddCopyright()}var n=t.m_Canvas[t.m_nLabelIndex];if(t.m_Events){t.m_Events.clear()}t.m_Events=new VBI.SceneEvent(this,n.parentElement);if(t.m_bNavControlVisible&&t.m_NavControl){t.m_NavControl.Awake(t,e)}if(t.m_bScaleVisible&&t.m_Scale){t.m_Scale.Awake(t,e)}var a=t.GetMinLOD();if(t.m_startLOD<a){var i=Math.ceil(a);t.m_startLOD=i-a<.6?i:a}if(t.m_bObjCanvasMode&&VBI.m_bIsMyChromeTest&&!t.m_bObjCanvasModeChecked){t.ChromePerformanceCheck(n)}if(t.m_awakeFrame){t.ZoomToGeoPosition(t.m_awakeFrame.pos,t.m_awakeFrame.lod,true,false,true);t.RenderAsync(true);t.m_awakeFrame=null}else{t.GoToInitialStart()}if(t.m_nInitialTrackingMode==VBI.InputModeRectSelect){new t.RectSelection}else if(t.m_nInitialTrackingMode==VBI.InputModeLassoSelect){new t.LassoSelection}else if(t.m_nInitialTrackingMode==VBI.InputModeRectZoom){new t.RectangularZoom}t.m_nInitialTrackingMode=VBI.InputModeDefault};t.ChromePerformanceCheck=function(e){var n=false;var a=[855,672,1512,240,801,901,1222,1392,1023,1024];var i=e.width,r=e.height;var m;var o=e.getContext("2d");e.width=e.height=1024;m=o.getImageData(500,500,1,1);var l,s=Date.now();for(var _=0;_<10;++_){l=Date.now();e.width=e.height=a[_];m=o.getImageData(500,500,1,1);if(Date.now()-l>60){n=true;break}}e.width=i;e.height=r;if(n||Date.now()-s>80){t.m_bObjCanvasMode=0;var v=n?"("+(Date.now()-l)+" ms peak)":"("+(Date.now()-s)/10+" ms average)";VBI.Trace("Setting Object Canvas Mode to Old Style due to Performance issues "+v);if(VBI.m_bTrace){VBI.Trace("Some Pixel was "+m)}}else{VBI.Trace("Chrome Performance Test passed with "+(Date.now()-s)/10+" ms average time.")}t.m_bObjCanvasModeChecked=true};t.CalcCanvasWidth=function(e,n){return Math.floor(e/n+t.m_nCanvasXOversize)*n};t.CalcCanvasHeight=function(e,n){return Math.floor(e/n+t.m_nCanvasYOversize)*n};t.GetInternalDivWidth=function(){if(this.m_Ctx.moThumbnail&&this.m_Ctx.moThumbnail.nOrgWidth){return this.m_Ctx.moThumbnail.nOrgWidth}var e=t.m_Div.parentNode.getBoundingClientRect();return e.width?e.width:t.m_Div.clientWidth};t.GetInternalDivHeight=function(){if(this.m_Ctx.moThumbnail&&this.m_Ctx.moThumbnail.nOrgHeight){return this.m_Ctx.moThumbnail.nOrgHeight}var e=t.m_Div.parentNode.getBoundingClientRect();return e.height?e.height:t.m_Div.clientHeight};t.GetPreviewImage=function(e,n){var a=e;if(a.m_PreviewPosition){t.m_MapManager.GetPreviewImage(a.m_PreviewPosition.longitude,a.m_PreviewPosition.latitude,a.m_PreviewPosition.lod,a,t,n)}else{var i=t.m_Ctx.m_Control.getInitialPosition();var r=t.m_Ctx.m_Control.getInitialZoom();var m=i.split(";");t.m_MapManager.GetPreviewImage(m[0],m[1],r,a,t,n)}};t.CalculateCanvasDimensions=function(){var e=t.m_Target.offsetWidth;var n=t.m_MapManager;var a=t.GetInternalDivWidth();var i=t.GetInternalDivHeight();if(a==t.m_nDivWidth&&i==t.m_nDivHeight){return}t.m_nDivWidth=a;t.m_nDivHeight=i;t.m_nWidthCanvas=t.CalcCanvasWidth(a,n.m_tileWidth);t.m_nHeightCanvas=t.CalcCanvasHeight(i,n.m_tileHeight);t.m_nTilesX=t.m_nWidthCanvas/n.m_tileWidth;t.m_nTilesY=t.m_nHeightCanvas/n.m_tileHeight;n.m_requestTileWidth=n.m_tileWidth;n.m_requestTileHeight=n.m_tileHeight;var r=t.m_MapLayerStack;if(r.m_nMaxSquare&&r.m_MapLayerArray.length){var m=0;for(var o=0;o<r.m_MapLayerArray.length;++o){if(!o||r.m_MapLayerArray[o].m_refMapProvider.m_nResolution<m){m=parseInt(r.m_MapLayerArray[o].m_refMapProvider.m_nResolution,10)}}var l=r.m_nMaxSquare*m;if(t.m_nTilesX*n.m_tileWidth>l||t.m_nTilesY*n.m_tileHeight>l){var s=Math.floor(l/Math.max(t.m_nTilesX,t.m_nTilesY));n.m_requestTileWidth=s;n.m_requestTileHeight=s}}if(VBI.m_bTrace){VBI.Trace("Setting Canvas Size to ("+t.m_nWidthCanvas+","+t.m_nHeightCanvas+") on div with size ("+a+","+i+"). Dummy is "+e)}t.m_nMapMoveXPreLoad=Math.min(120,n.m_tileWidth*(t.m_nTilesX-1)-a);t.m_nMapMoveYPreLoad=Math.min(120,n.m_tileHeight*(t.m_nTilesY-1)-i);t.m_nCanvasStdXPos=(t.m_nWidthCanvas-t.m_nDivWidth)/n.m_tileWidth/2;t.m_nCanvasStdYPos=(t.m_nHeightCanvas-t.m_nDivHeight)/n.m_tileHeight/2;t.m_nMaxPixelBeyondPoles=0};t.SwitchTmpCanvasToActive=function(){var e=t.m_Canvas[0],n=t.m_Canvas[t.m_nNonDomIndex];var a=e.getContext("2d");a.clearRect(0,0,e.getPixelWidth(),e.getPixelHeight());a.drawImage(t.m_Canvas[t.m_nNonDomIndex],0,0);t.MoveCanvas(e,e.getPixelLeft()-n.m_nOffsetX*e.getPixelWidth()/t.m_nTilesX,e.getPixelTop()-n.m_nOffsetY*e.getPixelHeight()/t.m_nTilesY);e.m_nCurrentX=n.m_nCurrentX;e.m_nCurrentY=n.m_nCurrentY;n.m_bCanvasValid=false;n.m_CanvasRedirect=e;n.m_CanvasRedirRequest=n.m_nRequest;n.m_nOffsetX=n.m_nOffsetY=0;n.m_nTilesBefSwitch=undefined;t.InternalRenderLayer(t.m_Canvas[t.m_nOverlayIndex],false,true,true,e.m_nExactLOD)};t.InitializeCanvas=function(e,n){e.m_Scene=t;e.m_nCurrentLOD=2;e.m_nExactLOD=2;e.m_nCurrentX=undefined;e.m_nCurrentY=undefined;e.m_nAppliedRequest=0;e.m_bInvalid=false;if(e.m_bNotInDOM!=2){if(!n){t.m_MapsLayerDiv.appendChild(e)}else{t.m_MapsLayerDiv.insertBefore(e,n)}}};t.AttachCanvasesToDOM=function(){var e=t.m_Div.firstChild,n;while(e){var a=e.m_VBIType;n=e.nextSibling;if(a=="L"||a=="N"||a=="S"||a=="C"){t.m_Div.removeChild(e)}else if(e.m_VBIHidden){e.m_VBIHidden=false;e.style.display=e.m_VBIOrgDiplay}e=n}for(var i=0;i<t.m_Canvas.length;++i){if(t.m_Canvas[i].m_bNotInDOM!=2){t.m_Canvas[i].m_bNotInDOM=!t.m_Canvas[i].m_bNotInDOM}}t.m_bThumbnailedCanvases=false;if(t.m_bNavControlVisible){t.m_NavControl=new VBI.NavigationControl(t.m_SuppressedNavControlVisibility);t.m_NavControl.AttachEvents();t.m_NavControl.Awake(t,t.m_TargetName)}if(t.m_bScaleVisible){t.m_Scale=new VBI.Scale(t);t.m_Scale.Awake(t,t.m_TargetName)}t.AddCopyright()};t.DetachCanvasesFromDOM=function(){for(var e=0;e<t.m_Canvas.length;++e){if(t.m_Canvas[e].m_bNotInDOM!=2){t.m_Canvas[e].m_bNotInDOM=!t.m_Canvas[e].m_bNotInDOM}}var n=t.m_TargetName+"-"+t.m_ID+"-";var a=t.m_Div.firstChild,i;while(a){var r=a.m_VBIType;i=a.nextSibling;if(r=="L"||r=="N"||r=="S"||r=="C"){t.m_Div.removeChild(a)}else{a.m_VBIHidden=true;a.m_VBIOrgDiplay=a.style.display;a.style.display="none"}a=i}var m;if(t.m_nThumbnailIndex){m=t.m_Canvas[t.m_nThumbnailIndex];m.width=t.m_Div.clientWidth;m.setPixelWidth(m.width);m.height=t.m_Div.clientHeight;m.setPixelHeight(m.height)}else{m=VBI.Utilities.CreateGeoSceneCanvas(n+"thumbnail",t.m_Div.clientWidth,t.m_Div.clientHeight,0,false);t.m_ThumbnaiEvents=new VBI.ThumbnailEvent(this,m);t.m_Canvas.push(m);t.m_nThumbnailIndex=t.m_Canvas.length-1}t.m_Div.appendChild(m);t.m_bThumbnailedCanvases=true;if(t.m_NavControl){t.m_SuppressedNavControlVisibility=t.m_NavControl.suppressedVisibility;t.m_NavControl.clear();t.m_NavControl=null}if(t.m_Scale){t.m_Scale.clear();t.m_Scale=null}t.m_DivCopyright=null};t.CreateCanvases=function(){var e=t.m_TargetName+"-"+t.m_ID+"-";var n=false;if(t.m_Ctx.moThumbnail){n=true;if(!t.m_Ctx.moThumbnail.bThumbnailed){t.m_Ctx.DoMinimize(t)}}t.clearCanvases();t.m_Canvas.push(VBI.Utilities.CreateGeoSceneCanvas(e+"layer1",t.m_nWidthCanvas,t.m_nHeightCanvas,-1,n,"vbi-map-active"));t.m_Canvas.push(VBI.Utilities.CreateGeoSceneCanvas(e+"layer2",t.m_nWidthCanvas,t.m_nHeightCanvas,-1,n,"vbi-map-inactive"));t.m_Canvas.push(VBI.Utilities.CreateGeoSceneCanvas(e+"objectlayer",t.m_nWidthCanvas,t.m_nHeightCanvas,-1,n));t.m_Canvas.push(VBI.Utilities.CreateGeoSceneCanvas(e+"labellayer",t.m_nWidthCanvas,t.m_nHeightCanvas,0,n,undefined,t.ariaLabel));t.m_Canvas.push(VBI.Utilities.CreateGeoSceneCanvas(e+"nondomlayer",t.m_nWidthCanvas,t.m_nHeightCanvas,-1,2));if(n){t.m_Canvas.push(VBI.Utilities.CreateGeoSceneCanvas(e+"thumbnail",t.m_Div.clientWidth,t.m_Div.clientHeight,0,false));t.m_nThumbnailIndex=t.m_Canvas.length-1;t.m_ThumbnaiEvents=new VBI.ThumbnailEvent(this,t.m_Canvas[t.m_nThumbnailIndex]);t.m_bThumbnailedCanvases=true}t.m_nShadowIndex=undefined;for(var a=0;a<t.m_Canvas.length;++a){t.InitializeCanvas(t.m_Canvas[a])}t.ToggleCanvas(t);if(t.m_Ctx.moThumbnail){t.DetachCanvasesFromDOM()}if(t.m_nCanvasMaxPixel==undefined){var i=8192;if(VBI.m_bIsMyChromeTest){i=32767}if(VBI.m_bIsIDevice){i=5120}if(VBI.m_bIsAndroid){i=16384}t.m_nCanvasMaxPixel=t.CalculateCanvasMaxPixel(t.m_Canvas[2],i,16384)}};t.CalculateCanvasMaxPixel=function(e,n,a){var i=e.width;var r=e.height;if(n>a-100){return n}var m=e.getContext("2d");if(t.CanvasSizeTest(e,m,Math.floor(n*1.05))){while(a-n>50){var o=Math.floor((n+a)/2);if(t.CanvasSizeTest(e,m,o)){n=o}else{a=o}}}e.width=i;e.height=r;return n};t.CanvasSizeTest=function(e,n,a){e.height=1024;e.width=a;n.fillStyle="#050000";n.fillRect(a-1,1023,1,1);var t=n.getImageData(a-1,1023,1,1).data;return t[0]+256*(t[1]+256*t[2])==5};t.DivIsAlive=function(){var e=t.m_Div.getBoundingClientRect();return e.width!=0||e.height!=0};t.resizeCanvas=function(e,n,a){if(!t.DivIsAlive()){return}if(!t.m_Canvas.length){t.DoAwake();return}if(t.m_Canvas[t.m_nNonDomIndex].m_bCanvasValid){t.SwitchTmpCanvasToActive()}var i=t.m_MapManager;var r=t.m_Canvas[0];var m=t.m_nDivWidth;var o=t.m_nDivHeight;var l=t.GetMinLODForWidth(m);var s=r.getPixelWidth()/t.m_nWidthCanvas;t.m_nLastRenderLOD=-1;t.CalculateCanvasDimensions();if(t.m_Ctx.moThumbnail){if(!t.m_bThumbnailedCanvases){t.DetachCanvasesFromDOM()}else{var _=t.m_Canvas[t.m_nThumbnailIndex];_.width=t.m_Div.clientWidth;_.height=t.m_Div.clientHeight;_.setPixelWidth(t.m_Div.clientWidth);_.setPixelHeight(t.m_Div.clientHeight)}}else if(t.m_bThumbnailedCanvases){t.AttachCanvasesToDOM()}else if(!n&&t.m_nDivWidth==m&&t.m_nDivHeight==o){return}if(VBI.m_bTrace){VBI.Trace("Resizing ("+m+","+o+") to ("+t.m_nDivWidth+","+t.m_nDivHeight+")")}var v=r.m_nCurrentX;var d=r.m_nCurrentY;var u=r.m_nCurrentLOD;var c=r.getPixelLeft()+(t.m_nDivWidth-m)/2;var f=Math.round((-c/i.m_tileWidth-t.m_nCanvasStdXPos)/s);c+=s*f*i.m_tileWidth;var h=r.getPixelTop()+(t.m_nDivHeight-o)/2;var C=Math.round((-h/i.m_tileHeight-t.m_nCanvasStdYPos)/s);h+=s*C*i.m_tileHeight;for(var g=0;g<t.m_Canvas.length;++g){if(g!=t.m_nThumbnailIndex){if(t.m_Canvas[g].width!=t.m_nWidthCanvas){t.m_Canvas[g].width=t.m_nWidthCanvas}if(t.m_Canvas[g].height!=t.m_nHeightCanvas){t.m_Canvas[g].height=t.m_nHeightCanvas}}}t.InvalidateCanvas(t.m_Canvas[1]);t.MoveCanvas(r,c,h,s*t.m_nWidthCanvas,s*t.m_nHeightCanvas);t.m_MapManager.RequestTiles(r,t.m_MapLayerStack,v+f,d+C,t.m_nTilesX,t.m_nTilesY,0,0,0,0,u,true);var M=t.m_LastZoomArea;var I=false;if(M!=undefined){var p=(new Date).getTime();if(p-M[0]<3e3){switch(M[1]){case"Area":t.ZoomToArea(M[2],M[3],M[4],M[5],M[6]);I=true;break;case"Areas":t.ZoomToAreas(M[2],M[3]);I=true;break;default:break}}}if(!I){var D=t.GetMinLOD();if(r.m_nExactLOD<D){t.ZoomMap(Math.pow(2,D-r.m_nExactLOD)*1.000001,t.m_nDivWidth/2-c,t.m_nDivHeight/2-h)}else if(!a&&r.m_nExactLOD!=Math.floor(r.m_nExactLOD)){t.AnimateZoomToGeo(t.GetCenterPos(),Math.floor(r.m_nExactLOD),5)}else{t.InternalRenderLayer(t.m_Canvas[t.m_nOverlayIndex],false,true,true,r.m_nExactLOD);t.InternalOnMoveLayer(t.m_Canvas[t.m_nOverlayIndex])}var S=t.GetMaxLOD();if(r.m_nExactLOD>S){t.ZoomMap(Math.pow(2,S-r.m_nExactLOD),t.m_nDivWidth/2-c,t.m_nDivHeight/2-h)}}if((n||t.GetMinLOD()!=l)&&t.m_NavControl){t.m_NavControl.AdaptMinMaxLOD(t)}if(t.m_bNavControlVisible&&t.m_NavControl){t.m_NavControl.AdjustScrollPoint(t.m_Canvas[0].m_nExactLOD)}t.InternalRenderLayer(t.m_Canvas[t.m_nOverlayIndex],false,false,true,t.m_Canvas[0].m_nExactLOD)};t.showHitMenu=function(e,n){sap.ui.require(["sap/ui/unified/Menu","sap/ui/unified/MenuItem"],function(a,i){var r=t.m_Ctx;if(r.m_strOpenMenu){r.m_Menus.findMenuByID(r.m_strOpenMenu).close();r.m_strOpenMenu=undefined}if(r.m_HitMenu){r.m_HitMenu.close();r.m_HitMenu.destroy()}var m=new a({maxVisibleItems:5});var o=t.GetEventVPCoordsObj(e);var l=sap.ui.getCore().getConfiguration().getLanguageTag();var s=function(e){var n=e.m_Vo;var a=n.getLabelText(r,e);if(!a||a==""){a=n.getTooltip(r,e);if(!a||a==""){a=n.m_DataSource.m_Path+"."+n.m_DataSource.GetCurrentElement(r).GetKeyValue()}}return a};n.sort(function(e,n){if(!e.txt){e.txt=s(e)}if(!n.txt){n.txt=s(n)}return e.txt.localeCompare(n.txt,l)});n.forEach(function(n){m.addItem(new i({text:n.txt,select:function(){e.hitCached=n;n.m_Vo["on"+e.m_evName](e)}}))});r.m_HitMenu=m;m.open(true,0,"begin top","begin top",t.m_Div,parseInt(o.x,10)+5+" "+(parseInt(o.y,10)+5),"fit")})};VBI.addSceneLassoTrackingFunctions(t);VBI.addSceneRectangularTrackingFunctions(t);t.m_TransitionTable=t.BuildQuarterTransistionTable();if(e){t.Awake(e,n,a)}return t}});
//# sourceMappingURL=sapscene.js.map