/*
 * ! SAP UI development toolkit for HTML5 (SAPUI5) (c) Copyright 2009-2012 SAP AG. All rights reserved
 */
sap.ui.define(["./GeoMap","./VoBase","sap/ui/core/theming/Parameters","jquery.sap.global","sap/base/Log","./library","./AnalyticMapRenderer"],function(e,t,i,jQuery,o,r,n){"use strict";var a=e.extend("sap.ui.vbm.AnalyticMap",{metadata:{library:"sap.ui.vbm",properties:{},aggregations:{regions:{type:"sap.ui.vbm.Region",multiple:true,singularName:"region"}},events:{regionClick:{parameters:{code:{type:"string"}}},regionContextMenu:{parameters:{code:{type:"string"}}},regionSelect:{},regionDeselect:{}}},renderer:n});a.DefaultABAPGeoJSONURL="/sap/bc/vbi/geojson/L0.json";a.DefaultGeoJSONURL="media/analyticmap/L0.json";a.DefaultRegionColor=i&&i.get("_sap_ui_vbm_shared_ChoroplethRegionBG")?i.get("_sap_ui_vbm_shared_ChoroplethRegionBG"):"rgb(213,218,221)";a.DefaultRegionColorBorder=i&&i.get("_sap_ui_vbm_shared_ChoroplethRegionBorder")?i.get("_sap_ui_vbm_shared_ChoroplethRegionBorder"):"rgb(255,255,255)";a.DefaultRegionSelectColor="RHLSA(0;1;1;1)";a.DefaultHotDeltaColor="RHLSA(0;1;1;1.0)";a.AltBorderColor=i&&i.get("_sap_ui_vbm_shared_ChartDataPointBorderHoverSelectedColor")?i.get("_sap_ui_vbm_shared_ChartDataPointBorderHoverSelectedColor"):"#676767";var s=i&&i.get("_sap_ui_vbm_shared_ChartDataPointNotSelectedBackgroundOpacity")?i.get("_sap_ui_vbm_shared_ChartDataPointNotSelectedBackgroundOpacity"):"0.6";a.DefaultRegionNonSelectColor="RHLSA(0;1;1;"+s+")";a.prototype.exit=function(){e.prototype.exit.apply(this,arguments);this.detachEvent("submit",a.prototype.onAnalyticsSubmit,this)};a.prototype.onAfterRendering=function(){sap.ui.vbm.VBI.prototype.onAfterRendering.apply(this,arguments)};a.prototype.destroyRegions=function(){this.mbRegionsDirty=true;this.destroyAggregation("regions")};a.prototype.addRegion=function(e){this.mbRegionsDirty=true;this.addAggregation("regions",e)};a.prototype.removeRegion=function(e){this.mbRegionsDirty=true;this.removeAggregation("regions",e)};a.prototype.insertRegion=function(e,t){this.mbRegionsDirty=true;this.insertAggregation("regions",e,t)};a.prototype.removeAllRegions=function(){this.mbRegionsDirty=true;this.removeAllAggregation("regions")};a.prototype.destroyLegend=function(){this.mbLegendDirty=true;this.destroyAggregation("legend")};a.prototype.setLegend=function(e){this.mbLegendDirty=true;this.setAggregation("legend",e)};a.prototype.onAnalyticsSubmit=function(e){var t=JSON.parse(e.mParameters.data);var i,o,r;switch(t.Action.name){case"RGN_CONTEXTMENU":i=t.Action.instance.split(".")[1];r={code:i};if(o=this.findRegionInAggregation(i)){o.fireContextMenu(r)}this.fireRegionContextMenu(r);break;case"RGN_CLICK":i=t.Action.instance.split(".")[1];r={code:i};if(o=this.findRegionInAggregation(i)){o.fireClick(r)}this.fireRegionClick(r);if(t.Data&&t.Data.Merge){this.setSelectionPropFireSelect(t.Data.Merge)}break;default:break}};a.prototype.init=function(){this.mProperties.scaleVisible=false;e.prototype.init.apply(this,arguments);this.mbRegionsDirty=false;this.mbLegendDirty=false;this.mbThemingDirty=true;this.attachEvent("submit",a.prototype.onAnalyticsSubmit,this);this.createRegions()};a.prototype.createRegions=function(){var e=this.mColC=a.DefaultRegionColor;var t=this.mColCB=a.DefaultRegionColorBorder;function i(e,t,i,o,r,n,s){var l={};l.K=e;l.P=[];l.T=n;l.C=o;l.CB=r;l.HDC=a.DefaultHotDeltaColor;l.ACB=l.CB;l.G=s;l.S="false";var g,p,u;for(var h=0,f=t.length;h<f;++h){p=t[h];u=[];for(var c=0,d=p.length;c<d;++c){g="";for(var m=0,C=p[c].length;m<C;++m){if(m){g+=";"}g+=p[c][m]}u.push(g)}l.P.push(u)}return l}var r=null,n=[],s,l="";n[0]=a.GeoJSONURL;var g=window.URI(a.DefaultABAPGeoJSONURL);g.addQuery("sap-language",sap.ui.getCore().getConfiguration().getLanguage());n[1]=g.toString();n[2]=sap.ui.resource("sap.ui.vbm",a.DefaultGeoJSONURL);for(var p=0;p<3;++p){l=n[p];if(!r&&l){s=jQuery.sap.syncGetJSON(l);if(s.statusCode===200&&s.data&&!s.error){r=s.data;break}}}if(!r){o.error("The GeoJSON file is invalid or could not be parsed.\r\nPlease contact your Administrator.",l,"sap.ui.vbm.AnalyticMap");return}var u=[];this.mRegionApplicationTable=u;this.mRegionBox=[];this.mNames=[];this.mRegionProps=[];var h,f,c,d;var m=r.features,C="",y;var R;var v;var b;for(var B=0,L=m.length;B<L;++B){y=[];v=[];b=[];R=[];var A=m[B];if(A.id2==="AQ"){continue}if(!A.id2){A.id2=A.id}if(A.properties&&A.properties.name){C=A.properties.name}else if(A.properties&&A.properties.NAME){C=A.properties.NAME}else{C=""}this.mNames[A.id2]=C;this.mRegionProps[A.id2]=A.properties;var _=A.geometry.coordinates;var S,D,T,N,M;var P,E;switch(A.geometry.type){case"Polygon":c=Number.MAX_VALUE;d=-Number.MAX_VALUE;h=Number.MAX_VALUE;f=-Number.MAX_VALUE;M=_.length;for(P=0;P<M;++P){S=_[P];y=[];for(E=0;E<S.length;++E){N=S[E];if(!P){if((D=N[0])<h){h=D}if(D>f){f=D}if((T=N[1])<c){c=T}if(T>d){d=T}}y.push(N[0],N[1],"0")}b.push(y)}v.push(b);R.push([h,f,c,d]);break;case"MultiPolygon":for(var V=0,I=_.length;V<I;++V){c=Number.MAX_VALUE;d=-Number.MAX_VALUE;h=Number.MAX_VALUE;f=-Number.MAX_VALUE;b=[];M=_[V].length;for(P=0;P<M;++P){S=_[V][P];y=[];for(E=0;E<S.length;++E){N=S[E];if(!P){if((D=N[0])<h){h=D}if(D>f){f=D}if((T=N[1])<c){c=T}if(T>d){d=T}}y.push(N[0],N[1],"0")}b.push(y)}R.push([h,f,c,d]);v.push(b)}break;default:continue}u.push(i(A.id2,v,A.geometry.type,e,t,C,A.id2));this.mRegionBox[A.id2]=window.VBI.MathLib.GetSurroundingBox(R)}};a.prototype.getRegionsTemplateObject=function(){return{id:"Region",type:"{00100000-2012-0004-B001-F311DE491C77}","entity.bind":"Regions.Entity",datasource:"Regions","posarraymulti.bind":"Regions.PosList","color.bind":"Regions.Color",selectColor:a.DefaultRegionSelectColor,nonSelectColor:a.DefaultRegionNonSelectColor,"colorBorder.bind":"Regions.BorderColor","tooltip.bind":"Regions.ToolTip","hotDeltaColor.bind":"Regions.HotDeltaColor","altBorderDeltaColor.bind":"Regions.AltBorderColor","select.bind":"Regions.VB:s","labelText.bind":"Regions.LT","labelPos.bind":"Regions.LP","labelBgColor.bind":"Regions.LBC","labelBorderColor.bind":"Regions.LBBC","labelArrow.bind":"Regions.AR","labelType.bind":"Regions.LabelType"}};a.prototype.getRegionsTypeObject=function(){var e=[{name:"Key",alias:"K",type:"string"},{name:"PosList",alias:"P",type:"vectorarraymulti"},{name:"ToolTip",alias:"T",type:"string"},{name:"Color",alias:"C",type:"color"},{name:"BorderColor",alias:"CB",type:"color"},{name:"HotDeltaColor",alias:"HDC",type:"string"},{name:"AltBorderColor",alias:"ACB",type:"color"},{name:"Entity",alias:"G",type:"string"},{name:"VB:s",alias:"S",type:"boolean"},{name:"LT",alias:"LT",type:"string"},{name:"LP",alias:"LP",type:"string"},{name:"LBC",alias:"LBC",type:"color"},{name:"LBBC",alias:"LBBC",type:"color"},{name:"AR",alias:"AR",type:"boolean"},{name:"LabelType",alias:"LabelType",type:"string"}];return{name:"Regions",minSel:"0",maxSel:"-1",key:"Key",A:e}};a.prototype.getRegionsDataObjects=function(){var e=[];var i=[];var o=[];var r=[];jQuery.extend(true,e,this.mRegionApplicationTable);if(!e.length){return null}var n=this.getRegionMap();for(var s=0,l=e.length,g,p,u;s<l;++s){p=e[s];if(g=n[p.K]){p.HDC="RHLSA(0;1.0;1.0;0.4)";p.ACB=a.AltBorderColor;if(u=g.getColor()){p.C=this.getPlugin()?window.VBI.Utilities.String2VBColor(u):u}if(u=g.getTooltip()){p.T=u}p.LT=g.getLabelText();p.S=g.getSelect();p.LP="0";p.LBC=g.getLabelBgColor();p.LBBC=g.getLabelBorderColor();p.AR=g.getLabelArrow();var h=g.getLabelType();var f=t.prototype.getLabelProps(h);if(f&&p.LT){if(f.LBC){p.LBC=f.LBC}if(f.LBBC){p.LBBC=f.LBBC}if(f.LIC){p.LIC=f.LIC}if(f.LICC){p.LICC=f.LICC}if(f.LICTC){p.LICTC=f.LICTC}}if(!p.LBC){p.LBC="rgba(255,255,255,1.0)"}if(p.LBBC==""){p.LBBC=p.LBC}i.push(p)}else{o.push(p)}}r=o.concat(i);return{name:"Regions",type:"N",E:r}};a.prototype.addRegionsActions=function(e){e.push({id:"AMap1",name:"RGN_CLICK",refScene:"MainScene",refVO:"Region",refEvent:"Click"});e.push({id:"AMap2",name:"RGN_CONTEXTMENU",refScene:"MainScene",refVO:"Region",refEvent:"ContextMenu"});return e};a.prototype.findSelected=function(e,t){var i=this.getRegions();if(!i){return null}var o=[];if(jQuery.type(t)=="object"){if(t.S==(e?"true":"false")){for(var r=0;r<i.length;++r){if(i[r].sId==t.K){o.push(i[r])}}}}else if(jQuery.type(t)=="array"){for(var n=0;n<t.length;++n){if(t[n].S==(e?"true":"false")){for(var a=0;a<i.length;++a){if(i[a].mProperties.code===t[n].K){o.push(i[a])}}}}}return o};a.prototype.setSelectionPropFireSelect=function(t){var i={};i.N=[];var o=t.N;for(var r=0;r<o.length;++r){var n=o[r];var a=n.E;var s,l;var g=false;if(n.name=="Regions"){s=[];l=[];var p=this.getRegionMap();for(var u=0;u<a.length;++u){var h=a[u];var f=h.S=="true"?true:false;var c=p[h.K];if(c){var d=c.getSelect();if(f!=d){c.setProperty("select",f,true);if(f&&this.mEventRegistry["regionSelect"]){s.push(c)}else if(!f&&this.mEventRegistry["regionDeselect"]){l.push(c)}}}else{g=true}}if(l.length){this.fireRegionDeselect({deselected:l})}if(s.length){this.fireRegionSelect({selected:s})}if(g){this.invalidate();this.mbForceDataUpdate=true}}else{i.N.push(n)}}if(i.N.length){e.prototype.setSelectionPropFireSelect.call(this,i)}};a.prototype.getSelectedItems=function(e){var t=[];if(!e){return null}for(var i=0;i<e.length;++i){if(e[i].name==="Regions"){var o=this.findSelected(true,e[i].E);if(o&&o.length){t=t.concat(o)}}else{var r=this.getAggregatorContainer(e[i].name);var n=r.findSelected(true,e[i].E);if(n&&n.length){t=t.concat(n)}}}return t};a.prototype.findRegionInAggregation=function(e){var t=this.getRegions();if(t){for(var i=0,o=t.length;i<o;++i){if(t[i].mProperties.code===e){return t[i]}}}return null};a.prototype.updateVOData=function(t,i,o,r,n){if(this.mbThemingDirty){this.applyTheming(this.mRegionApplicationTable)}t.push(this.getRegionsTemplateObject());r.push(this.getRegionsTypeObject());o.push({name:"Regions",type:"N"});i.push(this.getRegionsDataObjects());e.prototype.updateVOData.apply(this,arguments);this.addRegionsActions(n)};a.prototype.resetDirtyStates=function(){e.prototype.resetDirtyStates.apply(this,arguments);this.mbRegionsDirty=false};a.prototype.minimizeApp=function(t){e.prototype.minimizeApp.apply(this,arguments);var i,o;if(!this.getMapConfiguration()){(i=t)&&(i=i.SAPVB)&&(i=i.Scenes)&&((o=i.Set)||(o=i.Merge))&&(i=o.SceneGeo)&&i.refMapLayerStack&&(i.refMapLayerStack="")}return t};a.prototype.invalidate=function(t){if(t instanceof sap.ui.vbm.Region){this.mbRegionsDirty=true}e.prototype.invalidate.apply(this,arguments)};a.prototype.getRegionMap=function(){var e={};var t=this.getRegions();for(var i=0,o=t?t.length:0,r;i<o;++i){r=t[i];e[r.getCode()]=r}return e};a.prototype.zoomToRegions=function(e,t){if(t==undefined){t=.9999}var i=[];for(var o=0,r=e.length;o<r;++o){var n=this.mRegionBox[e[o]];if(n!=undefined){i.push(n)}}if(!i.length){return}var a=null;if(a=this.mVBIContext.GetMainScene()){a.ZoomToAreas(i,t)}};a.prototype.getRegionsInfo=function(e){var t=[];for(var i=0,o=e.length,r;i<o;++i){r=e[i];t[r]={};t[r].BBox=this.mRegionBox[r];t[r].Midpoint=[(this.mRegionBox[r][0]+this.mRegionBox[r][1])/2,(this.mRegionBox[r][2]+this.mRegionBox[r][3])/2];t[r].Name=this.mNames[r];t[r].Properties=this.mRegionProps[r]}return t};a.prototype.onThemeChanged=function(e){this.mbThemingDirty=true;this.invalidate()};a.prototype.applyTheming=function(e){if(sap.ui.core.theming&&i){var t=a.DefaultRegionColor;if(i.get("_sap_ui_vbm_shared_ChoroplethRegionBG")!=undefined){t=a.DefaultRegionColor=i.get("_sap_ui_vbm_shared_ChoroplethRegionBG")}var o=a.DefaultRegionColorBorder;if(i.get("_sap_ui_vbm_shared_ChoroplethRegionBorder")!=undefined){o=a.DefaultRegionColorBorder=i.get("_sap_ui_vbm_shared_ChoroplethRegionBorder")}if(this.getPlugin()){t=window.VBI.Utilities.String2VBColor(t);o=window.VBI.Utilities.String2VBColor(o)}if(t!=this.mColC||o!=this.mColCB){for(var r=0;r<e.length;++r){if(e[r].C===this.mColC){e[r].C=t}if(e[r].CB===this.mColCB){e[r].CB=o}}this.mColC=t;this.mColCB=o}this.mbThemingDirty=false}};a.prototype.isRegionSubscribed=function(e,t){if(t){var i=this.findRegionInAggregation(t);return i&&i.hasListeners(e)}return false};return a});
//# sourceMappingURL=AnalyticMap.js.map