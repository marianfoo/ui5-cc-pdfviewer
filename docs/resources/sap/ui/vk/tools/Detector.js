/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
 */
sap.ui.define([],function(){"use strict";var e=function(){this._verticesMap=new Map;this._objArr=[];this._collidedUuids=new Set;this._sourceObjects=null;this._targetObjects=[];this._srcBoxHelper=null;this._sourceBox=new THREE.Box3;this._originPos=new THREE.Vector3;this._targetBoxHelper=[];this._targetBoxes=[];this._detectDistance=20;this._direction=new THREE.Vector3;this._isReady=false;this._finalDistance=null;this._finalSnaps=[];this._intersectDistance=Number.NEGATIVE_INFINITY;this._collidedUuid=null;this._isMoved=false;this._detectType={move:this.detectMove.bind(this),scale:this.detectScale.bind(this),rotate:this.detectRotate.bind(this)}};e.prototype.isReady=function(){if(this._isReady&&this._sourceObjects){return true}else{return false}};e.prototype.setMoved=function(e){this._isMoved=e;this._intersectDistance=Number.NEGATIVE_INFINITY};e.prototype.getObjArray=function(){return this._objArr};e.prototype.addObjFromScene=function(e){var t=e._scene.getSceneRef();var i=e._viewStateManager;this._objArr.length=0;this._verticesMap.clear();t.traverse(function(e){if(e.isMesh){if(!this._objArr.find(function(t){return t.uuid===e.uuid})){this._objArr.push(e);var t=this.getVertices(e.geometry);this._verticesMap.set(e.uuid,t)}}}.bind(this));this.setSource(i,e);this._isReady=true};e.prototype.setSource=function(e,t){var i=[];e.enumerateSelection(function(e){i.push(e)});if(i.length>0){var s=i.pop();if(this._isReady){e.setSelectionStates(s,i,false,true)}if(s.children.length===0){this._isGroup=false;this._sourceObjects=s}else{this._isGroup=true;var o=[];s.traverse(function(e){if(e.type==="Mesh"){o.push(e)}});this._sourceObjects=o[0]}this._srcBoxHelper=new THREE.BoxHelper(this._sourceObjects);this._srcBoxHelper.update();this._sourceBox.setFromObject(this._srcBoxHelper);this._sourceSize=this._sourceBox.getSize();this._calculateInitialDetectDistance(t)}else{this._isReady=false;this._sourceObjects=null;this._sourceBox=new THREE.Box3}this.setTarget()};e.prototype._calculateInitialDetectDistance=function(e){if(e){var t=new THREE.Vector3;var i=new THREE.Vector3;var s=e.getRenderer().getSize(new THREE.Vector2);t.set(0/s.x*2-1,-(0/s.y)*2+1,.5);var o=e.getCamera().getCameraRef();t.unproject(o);t.sub(o.position).normalize();var r=-o.position.z/t.z;i.copy(o.position).add(t.multiplyScalar(r));var n=new THREE.Vector3;t.set(s.x/s.x*2-1,-(0/s.y)*2+1,.5);t.unproject(o);t.sub(o.position).normalize();r=-o.position.z/t.z;n.copy(o.position).add(t.multiplyScalar(r));var c=i.distanceTo(n);this._detectDistance=Math.abs(c)*.05}};e.prototype.setTarget=function(){this._intersectDistance=Number.NEGATIVE_INFINITY;this._collidedUuid=null;this._collidedUuids.clear();this._isMoved=false;if(this._sourceObjects){this._sourceObjects.geometry.computeBoundingSphere();this._originPos=new THREE.Vector3;this._targetObjects=this._objArr.filter(function(e){return e.uuid!==this._sourceObjects.uuid}.bind(this));this._targetBoxes.length=0;this._targetBoxHelper.length=0;this._targetObjects.forEach(function(e){var t=new THREE.BoxHelper(e);this._targetBoxHelper.push(t);t.update();var i=new THREE.Box3;i.setFromObject(e);this._targetBoxes.push(i)}.bind(this))}else{this._targetObjects.length=0;this._targetBoxes.length=0;this._targetBoxHelper.length=0}};e.prototype.updateTargetBox=function(){this._targetBoxHelper.forEach(function(e,t){e.update();this._targetBoxes[t].setFromObject(e)}.bind(this))};e.prototype.getVertices=function(e){var t,i,s=[];if(e.isGeometry){s=e.vertices}else if(e.isBufferGeometry){var o=e.attributes.position;if(o!==undefined){var r=new THREE.Vector3;s=[];var n={};var c="";for(t=0,i=o.count;t<i;t++){r.fromBufferAttribute(o,t);c=JSON.stringify(r);if(!n[c]){s.push(r.clone());n[c]=true}}}}return s};e.prototype.findClosestVertex=function(e,t,i){var s=this._verticesMap.get(i.uuid);if(s.length===0){return null}var o,r=null,n=i.worldToLocal(e.clone());for(var c=0,a=s.length;c<a;c++){o=s[c].distanceTo(n);if(o>t){continue}t=o;r=s[c]}if(r===null){return null}return i.localToWorld(r.clone())};e.prototype.findClosestSnap=function(e,t,i){var s=2;var o;while(!o){o=this.findClosestVertex(e,t,i);t*=s}return o};e.prototype.intersectDetect=function(e){var t=new Map;var i=this._sourceBox.clone().expandByScalar(this._detectDistance);e.forEach(function(e){var s=this._targetObjects.findIndex(function(t){return t.uuid===e.object.uuid});if(!this._collidedUuids.has(e.object.uuid)&&s!==-1&&this._targetBoxes&&this._targetBoxes[s].intersectsBox(i)){var o=this.findClosestSnap(this._originPos,this._detectDistance,this._targetObjects[s]);t.set(o,this._targetObjects[s]);if(this._targetBoxes[s].intersectsBox(this._sourceBox)&&this._intersectDistance<this._finalDistance){if(this.detectCollisionGJK(this._sourceObjects,this._targetObjects[s])){this._collidedUuid=e.object.uuid;this._intersectDistance=this._finalDistance}}}}.bind(this));return t};e.prototype.getFinalSnaps=function(e){var t=[];if(e.length>0){var i=this.intersectDetect(e);if(i.size!==0){var s=Array.from(i.keys());var o=s[0];var r=o.distanceTo(this._originPos);for(var n=1;n<s.length;++n){var c=s[n];var a=c.distanceTo(this._originPos);if(a<r){o=c;r=a}}var l=i.get(o);var h=this._originPos.distanceTo(o);var u,_;u=this.findClosestSnap(o,h,this._sourceObjects);var d=u.distanceTo(o);_=this.findClosestSnap(u,d,l);t=[u,_]}}return t};e.prototype.snapMove=function(){var e=this._op;if(this._finalSnaps.length===2&&this._sourceObjects&&Math.abs(this._finalDistance-this._intersectDistance)>.1){if(!this._collidedUuid&&this._finalDistance>=this._intersectDistance){e.gizmo._tool._handler._gesture=false;e.gizmo._moveDelta.add(this._direction.clone().multiplyScalar(.1));e.gizmo._move(e.gizmo._moveDelta)}else{this._intersectDistance=Number.NEGATIVE_INFINITY;this._collidedUuid=null;this._isMoved=false;e.viewport.setShouldRenderFrame()}this.detect()}};e.prototype.snapScale=function(){var e=this._op;if(!e.gizmo._scaleDelta.equals(new THREE.Vector3(1,1,1))&&this._finalSnaps.length===2&&this._sourceObjects&&Math.abs(this._finalDistance-this._intersectDistance)>.1){if(!this._collidedUuid&&this._finalDistance>=this._intersectDistance){e.gizmo._tool._handler._gesture=false;var t=e.gizmo._scaleDelta.toArray();t.forEach(function(t,i){if(t>1){e.gizmo._scaleDelta.setComponent(i,t*1.01)}});e.gizmo._scale(e.gizmo._scaleDelta)}else{this._intersectDistance=Number.NEGATIVE_INFINITY;this._collidedUuid=null;this._isMoved=false;e.viewport.setShouldRenderFrame()}this.detect()}else if(Math.abs(this._finalDistance-this._intersectDistance)<=.1){this._collidedUuids.add(this._collidedUuid)}};e.prototype.snapRotate=function(){var e=this._op;if(this._finalSnaps.length===2&&this._sourceObjects&&Math.abs(this._finalDistance-this._intersectDistance)>.1){if(!this._collidedUuid&&this._finalDistance>=this._intersectDistance){e.gizmo._tool._handler._gesture=false;e.angle2+=.02*(e.angle2-e.angle1)/Math.abs(e.angle2-e.angle1);e.gizmo._setRotationAxisAngle(e.handleIndex,e.angle1,e.angle2)}else{this._intersectDistance=Number.NEGATIVE_INFINITY;this._collidedUuid=null;this._isMoved=false;e.viewport.setShouldRenderFrame()}this.detect()}};e.prototype._calculateDetectDistance=function(){var e=this._sourceSize;var t="";var i=0;if(Math.abs(this._direction.x)===1){t="x"}else if(Math.abs(this._direction.y)===1){t="y"}else if(Math.abs(this._direction.z)===1){t="z"}var s=e[t]/2;if(s){i=this._detectDistance+s}return i};e.prototype.detectMove=function(){this._direction.copy(this._op.gizmo._moveDelta).normalize();var e=this._calculateDetectDistance();var i=new THREE.Raycaster(this._originPos,this._direction,0,e);this._snapAction=t(this.snapMove,1e3/60).bind(this);return i.intersectObjects(this._targetObjects,false)};e.prototype.detectScale=function(){if(this._op.gizmo._scaleDelta.toArray().find(function(e){return e<=1})){this._op.gizmo._tool._handler._gesture=true;this._collidedUuids.forEach(function(e){var t=this._targetObjects.find(function(t){return t.uuid===e});if(t&&!this.detectCollisionGJK(this._sourceObjects,t)){this._collidedUuids.delete(e)}}.bind(this))}this._gizmoPos=new THREE.Vector3;this._op.gizmo._gizmo.getWorldPosition(this._gizmoPos);var e=new THREE.Vector3;this._sourceObjects.getWorldPosition(e);var i=0,s=0;s=this._sourceObjects.geometry.boundingSphere.clone().applyMatrix4(this._sourceObjects.matrixWorld).radius;i=new THREE.Sphere(e,s+this._detectDistance);var o=[];this._targetBoxes.forEach(function(e,t){if(e.intersectsSphere(i)){o.push({object:this._targetObjects[t]})}}.bind(this));this._snapAction=t(this.snapScale,1e3/60).bind(this);return o};e.prototype.detectRotate=function(){this._gizmoPos=new THREE.Vector3;this._op.gizmo._gizmo.getWorldPosition(this._gizmoPos);var e=new THREE.Vector3;var i=new THREE.Vector3;var s=new THREE.Raycaster(this._originPos,this._direction,0,this._detectDistance);this._sourceObjects.getWorldPosition(i);this._radius=this._gizmoPos.distanceTo(i);var o=this._op.handleIndex;this._axis=(new THREE.Vector3).setFromMatrixColumn(this._op.gizmo._matOrigin,o).normalize();this._axis.transformDirection(this._op.gizmo._gizmo.matrixWorld);if(this._radius>.01){e.subVectors(i,this._gizmoPos).normalize();this._detectDistance=this._radius;this._direction.crossVectors(e,this._axis).normalize()}else if(this._finalSnaps.length===2){e.subVectors(this._finalSnaps[0],this._gizmoPos).normalize();this._direction.crossVectors(e,this._axis).normalize()}if(this._op.gizmo._rotationDelta.getComponent(o)>0){this._direction.negate()}var r=new THREE.Plane(this._axis);var n=[],c=[];var a=0,l=0;if(this._radius<.01){l=this._sourceObjects.geometry.boundingSphere.clone().applyMatrix4(this._sourceObjects.matrixWorld).radius;a=new THREE.Sphere(this._gizmoPos,l);this._targetBoxes.forEach(function(e,t){if(e.intersectsSphere(a)&&e.intersectsPlane(r)){n.push({object:this._targetObjects[t]})}}.bind(this))}else{a=new THREE.Sphere(this._gizmoPos,this._radius);this._targetBoxes.forEach(function(e,t){if(e.intersectsSphere(a)&&e.intersectsPlane(r)){c.push(this._targetObjects[t])}}.bind(this));n=s.intersectObjects(c,false)}this._snapAction=t(this.snapRotate,1e3/60).bind(this);return n};e.prototype.detect=function(e){var t=this._op=e||this._op;if(!this.isReady()||!this._verticesMap.has(this._sourceObjects.uuid)){this.addObjFromScene(t.viewport)}else{this._srcBoxHelper.update();this._sourceBox.setFromObject(this._sourceObjects);this._sourceBox.getCenter(this._originPos);this.updateTargetBox();var i=this._detectType[t.detectType]();this._finalSnaps=this.getFinalSnaps(i);if(this._finalSnaps.length===2){var s=new THREE.Vector3;s.subVectors(this._finalSnaps[1],this._finalSnaps[0]);this._finalDistance=s.length();if(this._finalDistance){this._snapAction()}}}};function t(e,t){var i;return function(){var s=this,o=arguments;clearTimeout(i);i=setTimeout(function(){i=null;e.apply(s,o)},t)}}e.prototype.detectCollisionGJK=function(e,t){var i=64;var s=this;function o(e,t){var o=[new THREE.Vector3,new THREE.Vector3,new THREE.Vector3];var r=2;var n=s._direction;o[1]=_(e,t,n);if(o[1].dot(n)<0){return false}n=o[1].clone().negate();o[0]=_(e,t,n);if(o[0].dot(n)<0){return false}var c=o[1].clone().sub(o[0]);var a=o[0].clone().negate();n=c.clone().cross(a).cross(c);var l=function(e,t,i,s,c,a,l){if(i.clone().cross(a).dot(t)>0){o[1]=o[0];o[0]=e.clone();n=i.clone().cross(t).cross(i);r=2}else{o[2]=o[1];o[1]=o[0];o[0]=e.clone();n=a.clone()}};var h=function(e,t,i,s,c,a,h){if(a.clone().cross(s).dot(t)>0){o[0]=e.clone();n=s.clone().cross(t).cross(s);r=2}else{l(e,t,i,s,c,a,h)}};var u=function(e,t,i,s,r,n,c){if(n.clone().cross(s).dot(t)>0){o[0]=o[1];o[1]=o[2].clone();i=s;s=r.clone();n=c.clone();h(e,t,i,s,r,n,c)}else{l(e,t,i,s,r,n,c)}};function _(e,t,i){var s=i.clone().normalize();var o=d(e,s);var r=d(t,s.negate());return o.clone().sub(r)}function d(e,t){var i=s._verticesMap.get(e.uuid);var o=e.localToWorld(i[0].clone());var r=o.dot(t);for(var n=1;n<i.length;++n){var c=e.localToWorld(i[n].clone());var a=c.dot(t);if(a>r){o=c;r=a}}return o}for(var f=0;f<i;++f){var p=_(e,t,n);if(p.dot(n)<0){return false}var g,v,b,m,E;if(r===2){g=p.clone().negate();v=o[0].clone().sub(p);b=o[1].clone().sub(p);E=v.clone().cross(b);var T=v.clone().cross(E);if(T.dot(g)>0){o[1]=o[0];o[0]=p.clone();n=v.clone().cross(g).cross(v);continue}var x=E.clone().cross(b);if(x.dot(g)>0){o[0]=p.clone();n=b.clone().cross(g).cross(b);continue}if(E.dot(g)>0){o[2]=o[1];o[1]=o[0];o[0]=p.clone();n=E.clone()}else{o[2]=o[0];o[0]=p.clone();n=E.clone().negate()}r=3;continue}g=p.clone().negate();v=o[0].clone().sub(p);b=o[1].clone().sub(p);m=o[2].clone().sub(p);E=v.clone().cross(b);var y=b.clone().cross(m);var j=m.clone().cross(v);var D=1;var z=2;var S=4;var R=(E.dot(g)>0?D:0)|(y.dot(g)>0?z:0)|(j.dot(g)>0?S:0);if(R===0){return true}if(R===D){h(p,g,v,b,m,E,y)}else if(R===z){o[0]=o[1];o[1]=o[2].clone();v=b;b=m.clone();E=y.clone();h(p,g,v,b,m,E,y)}else if(R===S){o[1]=o[0];o[0]=o[2].clone();b=v;v=m.clone();E=j.clone();h(p,g,v,b,m,E,y)}else if(R===D||z){u(p,g,v,b,m,E,y)}else if(R===z||S){c=o[0];o[0]=o[1];o[1]=o[2];o[2]=c;c=v;v=b;b=m;m=c;E=y;y=j.clone();u(p,g,v,b,m,E,y)}else if(R===S||D){c=o[1];o[1]=o[0];o[0]=o[2];o[2]=c;c=b;b=v;v=m;m=c;y=E;E=j.clone();u(p,g,v,b,m,E,y)}else{return true}}return true}var r=performance.now();var n=o(e,t);if(n){console.log("Collide (ms): ",performance.now()-r);return true}else{console.log("Not Collide (ms): ",performance.now()-r);return false}};return e});
//# sourceMappingURL=Detector.js.map