/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
 */
sap.ui.define(["./Tool","./RectSelectToolHandler","../SelectionDisplayMode","../Loco"],function(e,t,i,r){"use strict";var a=e.extend("sap.ui.vk.tools.RectSelectTool",{metadata:{library:"sap.ui.vk",properties:{subtractMode:{type:"boolean",defaultValue:false}}},constructor:function(i,r){if(a._instance){return a._instance}e.apply(this,arguments);this._viewport=null;this._handler=new t(this);this._loco=null;a._instance=this}});a.prototype.init=function(){if(e.prototype.init){e.prototype.init.call(this)}this.setFootprint(["sap.ui.vk.dvl.Viewport","sap.ui.vk.threejs.Viewport","sap.ui.vk.svg.Viewport"])};a.prototype.setActive=function(t,i,r){e.prototype.setActive.call(this,t,i,r);if(this._viewport){if(t){if(this._prepare()){this._handler.activate(this._viewport)}}else{this._handler.deactivate()}}return this};a.prototype._prepare=function(){if(this.isViewportType("sap.ui.vk.dvl.Viewport")&&this._viewport._dvl){return true}else if(this.isViewportType("sap.ui.vk.threejs.Viewport")&&this._viewport._scene&&this._viewport._scene.getSceneRef()){return true}else if(this.isViewportType("sap.ui.vk.svg.Viewport")&&this._viewport._scene){return true}else{return false}};a.prototype.queueCommand=function(e){if(this._prepare()){if(this.isViewportType("sap.ui.vk.threejs.Viewport")||this.isViewportType("sap.ui.vk.svg.Viewport")){e()}}return this};function s(e,t,i){var r=e.elements;var a=r[15]===1;var s=2/r[0];var n=2/r[5];var o,p;if(a){o=-r[12]*s;p=-r[13]*n}else{o=r[8]*s;p=r[9]*n}var l=(s+o)*.5;var u=o-l;var c=(n+p)*.5;var v=p-c;var f=THREE.Math.lerp(u,l,Math.min(t.x1,t.x2)/i.width);var h=THREE.Math.lerp(u,l,Math.max(t.x1,t.x2)/i.width);var d=THREE.Math.lerp(c,v,Math.min(t.y1,t.y2)/i.height);var g=THREE.Math.lerp(c,v,Math.max(t.y1,t.y2)/i.height);r[0]=2/(h-f);r[5]=2/(d-g);if(a){r[12]=-(h+f)/(h-f);r[13]=-(d+g)/(d-g)}else{r[8]=(h+f)/(h-f);r[9]=(d+g)/(d-g)}}a.prototype.select=function(e,t,i,r,a,s){if(!this._prepare()){return[]}return this._select(e,t,i,r,this._viewport,a,s)};a.prototype._select=function(e,t,r,a,n,o,p){var l=[];var u=n.getMetadata().getName();if(u==="sap.ui.vk.svg.Viewport"){if(e===r||t===a){return l}l=n._select({x1:e,y1:t,x2:r,y2:a});if(l.length>0){n.fireNodesPicked({picked:l});if(n.getSelectionDisplayMode()===i.Outline){if(this.getSubtractMode()){n._viewStateManager.setOutliningStates([],l)}else{n._viewStateManager.setOutliningStates(l,[])}}else if(this.getSubtractMode()){n._viewStateManager.setSelectionStates([],l)}else{n._viewStateManager.setSelectionStates(l,[])}}return l}if(u==="sap.ui.vk.dvl.Viewport"){l=n.rectSelect(e,t,r,a);if(l.length>0){var c={picked:l};n.fireNodesPicked(c);if(n.getSelectionDisplayMode()===i.Outline){if(this.getSubtractMode()){n._viewStateManager.setOutliningStates([],l)}else{n._viewStateManager.setOutliningStates(l,[])}}else if(this.getSubtractMode()){n._viewStateManager.setSelectionStates([],l)}else{n._viewStateManager.setSelectionStates(l,[])}}return l}if(u!=="sap.ui.vk.threejs.Viewport"){return l}var v=o?o.getSceneRef():undefined;var f=p?p.getCameraRef():undefined;var h=n._getViewStateManagerThreeJS();if(!f||!v||!h||e===r||t===a){return l}var d={x1:e,y1:t,x2:r,y2:a};var g=f.projectionMatrix.clone();s(g,d,n._renderer.getSize(new THREE.Vector2));var S=(new THREE.Matrix4).multiplyMatrices(g,f.matrixWorldInverse);var w=(new THREE.Frustum).setFromProjectionMatrix(S);var y=new THREE.Vector3;function _(e){var t=e.geometry;if(t!==undefined&&w.intersectsObject(e)){var i,r=0;if(t.isGeometry){var a=t.vertices;for(i=0,r=a.length;i<r;i++){y.copy(a[i]).applyMatrix4(e.matrixWorld);if(!w.containsPoint(y)){break}}}else if(t.isBufferGeometry){var s=t.attributes.position;if(s!==undefined){for(i=0,r=s.count;i<r;i++){y.fromBufferAttribute(s,i).applyMatrix4(e.matrixWorld);if(!w.containsPoint(y)){break}}}}return r>0&&i===r}return false}function M(e,t,i){if(!e.visible){return}var r=i||e.userData.skipIt?t:{totalCount:0,passedCount:0};if(r&&e.geometry!==undefined){r.totalCount++;if(_(e)){r.passedCount++}}var a=e.children;for(var s=0,n=a.length;s<n;s++){M(a[s],r,i||e.userData.closed)}if(r!==t&&r.passedCount>0&&r.totalCount===r.passedCount){l.push(e)}}M(v);if(l.length>0){var k={picked:l};n.fireNodesPicked(k);if(n.getSelectionDisplayMode()===i.Outline){if(this.getSubtractMode()){h.setOutliningStates([],l)}else{h.setOutliningStates(l,[])}}else if(this.getSubtractMode()){h.setSelectionStates([],l)}else{h.setSelectionStates(l,[])}}return l};return a});
//# sourceMappingURL=RectSelectTool.js.map