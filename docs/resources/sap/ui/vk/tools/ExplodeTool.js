/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
 */
sap.ui.define(["./Tool","./ExplodeAxis","./ExplodeDirection","./ExplodeItemGroup","./ExplodeType","./ExplodeToolHandler","./ExplodeToolGizmo","../AnimationPlayback","../AnimationTrackType","../AnimationTrackValueType","../OrthographicCamera","sap/ui/base/ManagedObjectObserver","../getResourceBundle","../TransformationMatrix"],function(e,t,i,o,a,r,s,n,p,l,u,d,c,m){"use strict";var h=e.extend("sap.ui.vk.tools.ExplodeTool",{metadata:{library:"sap.ui.vk",properties:{type:{type:"sap.ui.vk.tools.ExplodeType",defaultValue:a.Linear},axis:{type:"sap.ui.vk.tools.ExplodeAxis"},direction:{type:"sap.ui.vk.tools.ExplodeDirection"},magnitude:{type:"float",defaultValue:0},anchor:{type:"float[]",defaultValue:[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]}},aggregations:{items:{type:"sap.ui.vk.tools.ExplodeItemGroup",multiple:true}},associations:{selectedItem:{type:"sap.ui.vk.tools.ExplodeItemGroup",multiple:false}},events:{axisSelected:{parameters:{axis:{type:"sap.ui.vk.tools.ExplodeAxis"},direction:{type:"sap.ui.vk.tools.ExplodeDirection"}}},magnitudeChanging:{parameters:{type:{type:"sap.ui.vk.tools.ExplodeType"},axis:{type:"sap.ui.vk.tools.ExplodeAxis"},direction:{type:"sap.ui.vk.tools.ExplodeDirection"},magnitude:{type:"float"}}},magnitudeChanged:{parameters:{type:{type:"sap.ui.vk.tools.ExplodeType"},axis:{type:"sap.ui.vk.tools.ExplodeAxis"},direction:{type:"sap.ui.vk.tools.ExplodeDirection"},magnitude:{type:"float"}}},itemSequenceChangePressed:{parameters:{item:{type:"sap.ui.vk.tools.ExplodeItemGroup"},moveUp:{type:"boolean"}}},itemPositionAdjusting:{parameters:{item:{type:"sap.ui.vk.tools.ExplodeItemGroup"},magnitudeAdjustmentMultiplier:{type:"float"}}},itemPositionAdjusted:{parameters:{item:{type:"sap.ui.vk.tools.ExplodeItemGroup"},magnitudeAdjustmentMultiplier:{type:"float"}}}}},constructor:function(t,i){e.apply(this,arguments);this._viewport=null;this._handler=new r(this);this._gizmo=null}});h.prototype.init=function(){if(e.prototype.init){e.prototype.init.call(this)}this.setFootprint(["sap.ui.vk.threejs.Viewport"]);this.setAggregation("gizmo",new s);this._groupObserver=new d(this._onGroupChanged.bind(this));this._groupsObserver=new d(this._onGroupsChanged.bind(this));this._groupsObserver.observe(this,{aggregations:["items"]})};h.prototype.destroy=function(){h._cleanAssociatedLoaders();this._groupsObserver.disconnect();this._groupsObserver=null;this._groupObserver.disconnect();this._groupObserver=null};h.prototype.setActive=function(t,i,o){e.prototype.setActive.call(this,t,i,o);if(this._viewport){if(t){this._gizmo=this.getGizmo();this._gizmo.show(this._viewport,this);this._addLocoHandler()}else{this._removeLocoHandler();if(this._gizmo){this._gizmo.hide();this._gizmo=null}}}return this};h.prototype.queueCommand=function(e){if(this._addLocoHandler()){if(this.isViewportType("sap.ui.vk.threejs.Viewport")){e()}}return this};h.prototype.setType=function(e){this.setProperty("type",e,true);if(this._gizmo){this._gizmo._recalculateOffsets()}};h.prototype.setAxis=function(e){this.setProperty("axis",e,true);if(this._gizmo){this._gizmo._updateAxis()}};h.prototype.setDirection=function(e){this.setProperty("direction",e,true);if(this._gizmo){this._gizmo._updateAxis()}};h.prototype.setAnchor=function(e){this.setProperty("anchor",e,true);if(this._gizmo){this._gizmo._updateAxis()}};h.prototype.pickAnchorFromNodesList=function(e){var t=null;var i=-1;var o=new THREE.Vector3;(Array.isArray(e)?e:[e]).forEach(function(e){var a=new THREE.Box3;e._expandBoundingBox(a,false,true,true);var r=a.getSize(new THREE.Vector3).manhattanLength();if(i<r){i=r;t=e;a.getCenter(o)}});if(t!==null){this.setAnchor(t.matrixWorld.clone().setPosition(o).elements)}return t};h.prototype.setMagnitude=function(e){e=Math.max(e,0);this.setProperty("magnitude",e,true);if(this._gizmo){this._gizmo._setMagnitude(e)}};h.prototype.setSelectedItem=function(e){this.setAssociation("selectedItem",e);if(this._gizmo){this._gizmo._handleSelectedItemChanged()}};h.prototype._onGroupsChanged=function(e){this._groupObserver.disconnect();this.getItems().forEach(function(e){this._groupObserver.observe(e,{aggregations:["items"]})}.bind(this));if(this._gizmo){this._gizmo._handleGroupsChanged(e)}};h.prototype._onGroupChanged=function(e){if(this._gizmo){this._gizmo._handleGroupsChanged(e)}};h.prototype.reset=function(){this.getItems().forEach(function(e){e.setMagnitudeAdjustmentMultiplier(0)});this.setMagnitude(0);this.setType(a.Linear);this.setAxis(undefined);this.setDirection(undefined)};h.prototype._activateView=function(e){var t=this._viewport.getScene();var i=t.getViewStateManager();var o=t.getViews()[e];i.activateView(o);var a=this._viewport._viewStateManager.getAnimationPlayer();if(a){setTimeout(function(){a.play()},100)}};h.prototype._createView=function(e,t,i,o,a,r,s){var n=this._viewport.getScene();var p=n.getViewStateManager();var l=n.createView({name:t});var d=[];if(e){var c=e.getNodeInfos();c.forEach(function(e){var t={target:e.target,transform:e.transform?e.transform.slice():null,meshId:e.meshId,materialId:e.materialId,visible:e.visible,opacity:e.opacity};d.push(t)})}else{var m=p.getNodeHierarchy();var h=function(e){if(e.visible){d.push({target:e,visible:e.visible})}m.enumerateChildren(e,h,false,true)};m.enumerateChildren(null,h,false,true)}l.setNodeInfos(d);var g={name:t,nodes:[]};if(e){g.sourceId=e.getViewId();g.exclude="PLAYBACK";var v=this._viewport.getCamera();var f={origin:v.getPosition(),target:v.getTargetDirection(),up:v.getUpDirection(),ortho:v instanceof u};if(f.ortho){f.zoom=v.getZoomFactor()}else{f.fov=v.getFov()/180*Math.PI}g.camera=f;var y=this._viewport._viewStateManager.getAnimationPlayer();if(y){g.time=y.getTime()}}d=[];o.forEach(function(e){var t=e.node;var i=a.get(t);g.nodes.push({sid:n.nodeRefToPersistentId(t),transform:i.localMatrix});d.push({target:t,transform:i.localMatrix})});l.updateNodeInfos(d);var E=n.findViewGroupByView(e);g.groupIds=E?[E.getViewGroupId()]:[r];if(s!==null){g.sequence=s}if(i){i.push(g)}return l};h.prototype.generateRequestData=function(e,t){var i=e?e.viewPrefix:null;var o=[];var r=1;var s=this._viewport.getScene();var u=this._viewport.getCurrentView();var d=new Map;var h=new Map;var g=[];var v=[];var f=[];var y=[];var E=null;var x=[];var _=null;var w=this.getType();if(t){if(Array.isArray(t.views)){var T=t.views.findIndex(function(e){return e.id===u.getViewId()});if(T>=0){E=t.views[T].sequence+1}x=t.views.slice(T+1)}_=t.id}var P=new Map;if(e&&e.animation&&e.animation.enabled){this.getItems().forEach(function(e){e.getItems().forEach(function(e){var t=e.getNodeRef();t.updateMatrixWorld();var i=(new THREE.Vector3).setFromMatrixPosition(t.matrixWorld);h.set(t.uuid,i);var o=new THREE.Matrix4;o.getInverse(t.parent.matrixWorld).multiply(t.matrixWorld);var a=new THREE.Vector3;var r=new THREE.Quaternion;var s=new THREE.Vector3;o.decompose(a,r,s);P.set(t,{localMatrix:m.convertTo4x3(o.elements),position:a,worldPosition:i})})});this._gizmo._nodes.forEach(function(e){var t=e.node;t.matrix.elements[12]=e.local.x;t.matrix.elements[13]=e.local.y;t.matrix.elements[14]=e.local.z;t.position.setFromMatrixPosition(t.matrix);t.updateMatrixWorld(true);d.set(t,[e.local.x,e.local.y,e.local.z]);var i=(new THREE.Vector3).setFromMatrixPosition(t.matrixWorld);var o=new THREE.Matrix4;o.getInverse(t.parent.matrixWorld).multiply(t.matrixWorld);var a=new THREE.Vector3;var r=new THREE.Quaternion;var s=new THREE.Vector3;o.decompose(a,r,s);var n=P.get(t);n.originalPosition=a;n.originalWorldPosition=i})}var I=new Set;var V=this._createView(u,i?i:c().getText("EXPLODETOOL_VIEW"),o,I,P,_,E);var A=o[o.length-1];if(e&&e.animation&&e.animation.enabled){if(!e.animation.separateAnimations){e.animation.separateViews=false}var k=e.animation.sequencePrefix;var O=1;var b=new Map;var z=null;var M=[];var R=[];var L="";this.getItems().forEach(function(t){f.push({name:t.getName()?t.getName():c().getText("EXPLODETOOL_GROUP_NODE",O),contentType:"REFERENCE",transform:[1,0,0,0,1,0,0,0,1,0,0,0]});A=o[o.length-1];if(e.animation.separateAnimations||e.animation.separateViews||O==1){if(M.length>0){v.push({name:L,endTime:r,joints:R,nodes:M});M=[];R=[]}if(e.animation.separateViews){L=c().getText("EXPLODETOOL_SEQUENCE_NAME",[A.name,1])}else{L=c().getText("EXPLODETOOL_SEQUENCE_NAME",[A.name,O])}L=k?c().getText("EXPLODETOOL_PREFIX_n",[k,O]):L;z=s.createSequence(V.getId()+"_seq"+O,{name:L,duration:r});var d=new n({sequence:z});V.addPlayback(d);V.resetPlaybacksStartTimes();if(!A.playbacks){A.playbacks=[]}A.playbacks.push({start:e.animation.separateViews?0:(O-1)*r,sequence:v.length})}var m=s.createTrack(null,{trackValueType:l.Vector3,isAbsoluteValue:false});this._gizmo._nodes.forEach(function(e){if(e.group==t){var i=e.node;var o=s.nodeRefToPersistentId(i);R.push(y.length);y.push({parent:O-1,childSid:o});var n=h.get(i.uuid);if(w===a.Radial||m.getKeysCount()==0){if(w===a.Radial&&m.getKeysCount()>0){m=s.createTrack(null,{trackValueType:l.Vector3,isAbsoluteValue:false})}var u=P.get(i);var d=[u.worldPosition.x-u.originalWorldPosition.x,u.worldPosition.y-u.originalWorldPosition.y,u.worldPosition.z-u.originalWorldPosition.z];m.insertKey(0,[0,0,0]);m.insertKey(r,d);g.push({time:[0,r],vector3:[0,0,0,d[0],d[1],d[2]]})}if(w===a.Radial){M.push({sid:o,rtranslate:{track:g.length-1}})}z.setNodeAnimation(i,p.Translate,m);b.set(i,[n.x,n.y,n.z]);I.add(e)}});if(w===a.Linear){M.push({node:O-1,rtranslate:{track:g.length-1}})}O++;if(e.animation.separateViews&&O<=this.getItems().length){V=this._createView(u,i?c().getText("EXPLODETOOL_PREFIX_n",[i,O]):c().getText("EXPLODETOOL_VIEW_n",O),o,I,P,_,E?++E:E)}}.bind(this));if(M.length>0){v.push({name:L,endTime:r,joints:R,nodes:M})}}else{var C=[];A.nodes=[];this.getItems().forEach(function(e){e.getItems().forEach(function(e){var t=e.getNodeRef();var i=t.matrix.elements;var o=[i[0],i[4],i[8],i[1],i[5],i[9],i[2],i[6],i[10],i[12],i[13],i[14]];C.push({target:t,transform:o});A.nodes.push({sid:s.nodeRefToPersistentId(t),transform:o})})});V.updateNodeInfos(C)}var D=function(){var e={data:{views:o}};x.forEach(function(t){e.data.views.push({id:t.id,sequence:++E})});if(v.length>0){e.data.tree={nodes:f};e.data.animation={sequences:v,tracks:g,joints:y}}return e};return D()};return h});
//# sourceMappingURL=ExplodeTool.js.map