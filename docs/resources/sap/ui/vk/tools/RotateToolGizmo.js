/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
 */
sap.ui.define(["../thirdparty/three","./Gizmo","./RotateToolGizmoRenderer","./RotatableAxis","./CoordinateSystem","./AxisColours","../AnimationTrackType","../AnimationTrackValueType","./GizmoPlacementMode","sap/base/assert","sap/base/Log"],function(e,t,r,i,o,a,n,s,l,u,h){"use strict";var d=t.extend("sap.ui.vk.tools.RotateToolGizmo",{metadata:{library:"sap.ui.vk"}});d.prototype.init=function(){if(t.prototype.init){t.prototype.init.apply(this)}this._createEditingForm(String.fromCharCode(176),84);this._gizmoIndex=-1;this._handleIndex=-1;this._value=new THREE.Vector3;this._rotationDelta=new THREE.Vector3;this._viewport=null;this._tool=null;this._sceneGizmo=new THREE.Scene;this._gizmo=new THREE.Group;this._touchAreas=new THREE.Group;this._sceneGizmo.add(this._gizmo);this._axis=i.All;this._coordinateSystem=o.World;this._nodes=[];this._matViewProj=new THREE.Matrix4;this._gizmoSize=96;function e(e,t,r,i){var o=new THREE.TorusBufferGeometry(r,1/96,4,i);if(e===0){o.rotateY(Math.PI/2)}else if(e===1){o.rotateX(Math.PI/2)}var a=new THREE.Mesh(o,new THREE.MeshBasicMaterial({color:t,transparent:true}));a.matrixAutoUpdate=false;a.userData.color=t;return a}function r(e,t,r){var i=new THREE.TorusBufferGeometry(t,16/96,4,r);if(e===0){i.rotateY(Math.PI/2)}else if(e===1){i.rotateX(Math.PI/2)}return new THREE.Mesh(i,new THREE.MeshBasicMaterial({opacity:.2,transparent:true}))}for(var n=0;n<3;n++){this._gizmo.add(e(n,a[["x","y","z"][n]],1,128));this._touchAreas.add(r(n,1,24))}this._gizmo.add(new THREE.AxesHelper(.75));var s=new THREE.MeshBasicMaterial({color:33023,opacity:.5,transparent:true,side:THREE.DoubleSide});this._arcMesh=new THREE.Mesh(new THREE.Geometry,s);this._arcMesh.visible=false;this._gizmo.add(this._arcMesh);this._axisTitles=this._createAxisTitles();this._sceneGizmo.add(this._axisTitles)};d.prototype.hasDomElement=function(){return true};d.prototype.setAxis=function(e){this._axis=e;var t=[i.All,i.X,i.Y,i.Z];if(this._coordinateSystem!==o.Screen){for(var r=0;r<3;r++){if(e!==i.All&&t[r+1]!==e){this._gizmo.children[r].visible=this._touchAreas.children[r].visible=false}else{this._gizmo.children[r].visible=this._touchAreas.children[r].visible=true}}}};d.prototype.resetValues=function(){this._value.setScalar(0)};d.prototype.setCoordinateSystem=function(e){this._coordinateSystem=e;var t=e===o.Screen;if(t){this._gizmo.children[0].visible=this._gizmo.children[1].visible=false;this._touchAreas.children[0].visible=this._touchAreas.children[1].visible=false;this._gizmo.children[2].visible=this._touchAreas.children[2].visible=true}else{this._gizmo.children[0].visible=this._touchAreas.children[0].visible=this._axis===i.All||this._axis===i.X;this._gizmo.children[1].visible=this._touchAreas.children[1].visible=this._axis===i.All||this._axis===i.Y;this._gizmo.children[2].visible=this._touchAreas.children[2].visible=this._axis===i.All||this._axis===i.Z}this._axisTitles.visible=!t;this._gizmoIndex=this._handleIndex=-1};d.prototype.show=function(e,t){this._viewport=e;this._tool=t;this._nodes.length=0;this._updateSelection(e._viewStateManager);var r=this._getNodesProperties();this._tool.fireEvent("rotating",{x:0,y:0,z:0,nodesProperties:r},true)};d.prototype._prepareForCreatingRotationKey=function(e,t,r){this._nodes.forEach(function(i){var o=i.node;var a=[0,0,0];e.setTime(t,r);var s=e.getAnimatedProperty(o,n.Rotate);if(s.offsetToPrevious){a=s.offsetToPrevious}if(!this._nodeUserDataMap){this._nodeUserDataMap=new Map}var l=this._nodeUserDataMap.get(o);if(!l){l={};this._nodeUserDataMap.set(o,l)}l.eulerInParentCoors=new THREE.Euler(a[0],a[1],a[2]);l.startEulerInParentCoors=new THREE.Euler(a[0],a[1],a[2])}.bind(this));var i=e.getCurrentPlayback();if(i){this._prepareForCreatingKey(i)}};d.prototype.hide=function(){this._cleanTempData();this._viewport=null;this._tool=null;this._gizmoIndex=this._handleIndex=-1;this._updateEditingForm(false)};d.prototype.getGizmoCount=function(){if(this._coordinateSystem===o.Local||this._coordinateSystem===o.Parent){return this._nodes.length}else{return this._nodes.length>0?1:0}};d.prototype.getTouchObject=function(e){if(this._nodes.length===0){return null}this._updateGizmoObjectTransformation(this._touchAreas,e);return this._touchAreas};d.prototype.highlightHandle=function(e,t){for(var r=0;r<3;r++){var i=this._gizmo.children[r];var o=r===e?16776960:i.userData.color;i.material.color.setHex(o);i.material.opacity=e===-1||r===e?1:.35;i.material.visible=t||r===e;var a=this._axisTitles.children[r];a.material.color.setHex(o);a.material.opacity=e===-1||r===e?1:.35;a.material.visible=t||r===e}};d.prototype.selectHandle=function(e,t){this._gizmoIndex=t;this._handleIndex=e;if(this._tool.getAutoResetValues()){this.resetValues()}this._viewport.setShouldRenderFrame()};d.prototype.beginGesture=function(){this._beginValue=this._value.clone();this._rotationDelta.setScalar(0);this._matOrigin=this._gizmo.matrixWorld.clone();this._nodes.forEach(function(e){e.node.parent.updateMatrixWorld(true);e.matOrigin=e.node.matrixWorld.clone();e.matLocalOrigin=e.node.matrix.clone();if(e.node.parent){e.matParentInv=(new THREE.Matrix4).getInverse(e.node.parent.matrixWorld)}else{e.matParentInv=new THREE.Matrix4}e.quaternion=e.node.quaternion.clone()})};d.prototype._printEventInfo=function(e,t,r,i,o){h.debug(e+" is fired:"+" x = "+t+"; y = "+r+"; z = "+i);o.forEach(function(e){h.debug("Node: "+e.node.name);if(e.offsetToRest){h.debug("offsetToRest: [ "+e.offsetToRest[0]+", "+e.offsetToRest[1]+", "+e.offsetToRest[2]+", "+e.offsetToRest[3]+" ] ")}else{h.debug("offsetToRest: null")}if(e.offsetToRestInCoordinates){h.debug("offsetToRestInCoordinates: [ "+e.offsetToRestInCoordinates[0]+", "+e.offsetToRestInCoordinates[1]+", "+e.offsetToRestInCoordinates[2]+" ] ")}else{h.debug("offsetToRestInCoordinates: null")}if(e.offsetToPrevious){h.debug("offsetToPrevious: [ "+e.offsetToPrevious[0]+", "+e.offsetToPrevious[1]+", "+e.offsetToPrevious[2]+" ] ")}else{h.debug("offsetToPrevious: null")}if(e.absolute){h.debug("absolute: [ "+e.absolute[0]+", "+e.absolute[1]+", "+e.absolute[2]+", "+e.absolute[3]+" ] ")}else{h.debug("absolute: null")}if(e.world){h.debug("world: [ "+e.world[0]+", "+e.world[1]+", "+e.world[2]+", "+e.world[3]+" ] ")}else{h.debug("world: null")}if(e.restDifference){h.debug("restDifference: [ "+e.restDifference[0]+", "+e.restDifference[1]+", "+e.restDifference[2]+", "+e.restDifference[3]+" ] ")}else{h.debug("restDifference: null")}if(e.restDifferenceInCoordinates){h.debug("restDifference: [ "+e.restDifferenceInCoordinates[0]+", "+e.restDifferenceInCoordinates[1]+", "+e.restDifferenceInCoordinates[2]+", "+e.restDifferenceInCoordinates[3]+" ] ")}else{h.debug("restDifference: null")}})};d.prototype._getNodesProperties=function(){var e=[];this._nodes.forEach(function(t){var r=t.node;var i={};i.node=r;var o;if(this._nodeUserDataMap){o=this._nodeUserDataMap.get(r)}if(o&&o.eulerInParentCoors){var a=new THREE.Euler(o.eulerInParentCoors.x,o.eulerInParentCoors.y,o.eulerInParentCoors.z);var s=(new THREE.Quaternion).setFromEuler(a);if(this._playback){var l=this._viewport._viewStateManager._getEndPropertyInPreviousPlayback(r,n.Rotate,this._playback);if(l){var u=new THREE.Quaternion(l[0],l[1],l[2],l[3]);s.multiply(u)}}i.offsetToRest=[s.x,s.y,s.z,s.w];i.offsetToPrevious=[o.eulerInParentCoors.x,o.eulerInParentCoors.y,o.eulerInParentCoors.z]}else{i.offsetToRest=null;i.offsetToPrevious=null}var h=this._viewport._viewStateManager.getTransformation(r);i.absolute=[h.quaternion[0],h.quaternion[1],h.quaternion[2],h.quaternion[3]];var d=this._viewport._viewStateManager.getTransformationWorld(r);var f=new THREE.Quaternion(d.quaternion[0],d.quaternion[1],d.quaternion[2],d.quaternion[3]);var _=(new THREE.Euler).setFromQuaternion(f);i.world=[_.x,_.y,_.z];if(o&&o.quatInitialDiffInv){var p=new THREE.Quaternion(h.quaternion[0],h.quaternion[1],h.quaternion[2],h.quaternion[3]);p.multiply(o.quatInitialDiffInv);i.restDifference=[p.x,p.y,p.z,p.w]}else{i.restDifference=null}if(o.euler){i.restDifferenceInCoordinates=[o.euler.x,o.euler.y,o.euler.z]}else{i.restDifferenceInCoordinates=null}i.offsetToRestInCoordinates=null;e.push(i)}.bind(this));return e};d.prototype.endGesture=function(){this._arcMesh.visible=false;var e=this._getNodesProperties();delete this._beginValue;this._nodes.forEach(function(e){var t=e.node;var r;if(this._nodeUserDataMap){r=this._nodeUserDataMap.get(t)}if(r&&r.euler){r.startEuler.x=r.euler.x;r.startEuler.y=r.euler.y;r.startEuler.z=r.euler.z;r.startEulerInParentCoors.x=r.eulerInParentCoors.x;r.startEulerInParentCoors.y=r.eulerInParentCoors.y;r.startEulerInParentCoors.z=r.eulerInParentCoors.z}if(this._coordinateSystem!==o.Custom){delete t.userData.skipUpdateJointNode}this._viewport._viewStateManager._setJointNodeOffsets(t,n.Rotate)}.bind(this));this._tool.fireRotated({x:this._rotationDelta.x,y:this._rotationDelta.y,z:this._rotationDelta.z,nodesProperties:e});this._printEventInfo("Event 'rotated'",this._rotationDelta.x,this._rotationDelta.y,this._rotationDelta.z,e)};var f=function(e,t){if(Math.abs(e-t)<1e-6){return e}if(e>t){while(e>t){t+=2*Math.PI}if(t-e<=Math.PI){return t}else{return t-2*Math.PI}}else{while(e<t){t-=2*Math.PI}if(e-t<=Math.PI){return t}else{return t+2*Math.PI}}};d.prototype.rotateFromRestPosition=function(e,t,r){if(this._coordinateSystem!==o.Parent){return}this.beginGesture();this._nodes.forEach(function(e){var t=e.node;if(!t.userData){t.userData={}}t.userData.skipUpdateJointNode=true});e=THREE.Math.degToRad(e);t=THREE.Math.degToRad(t);r=THREE.Math.degToRad(r);for(var i=0,a=this._nodes.length;i<a;i++){var s=this._nodes[i];if(!s.ignore){var l=s.node;var u;if(this._nodeUserDataMap){u=this._nodeUserDataMap.get(l)}if(u&&u.euler&&u.eulerInParentCoors){this._rotationDelta.set(THREE.Math.radToDeg(e-u.eulerInParentCoors.x),THREE.Math.radToDeg(t-u.eulerInParentCoors.y),THREE.Math.radToDeg(r-u.eulerInParentCoors.z));u.eulerInParentCoors.x=e;u.eulerInParentCoors.y=t;u.eulerInParentCoors.z=r;var h=new THREE.Euler(u.eulerInParentCoors.x,u.eulerInParentCoors.y,u.eulerInParentCoors.z);var d=(new THREE.Quaternion).setFromEuler(h);var f=this._viewport._viewStateManager.getRestTransformationUsingJoint(l);var _=new THREE.Quaternion(f.quaternion[0],f.quaternion[1],f.quaternion[2],f.quaternion[3]);if(this._playback){var p=this._viewport._viewStateManager._getEndPropertyInPreviousPlayback(l,n.Rotate,this._playback);if(p){var E=new THREE.Quaternion(p[0],p[1],p[2],p[3]);d.multiply(E)}}var c=this._getEffectiveParent(l);if(c!==l.parent){this._viewport._viewStateManager._setJointNodeOffsets(l,n.Rotate);l.userData.offsetQuaternion=[d.x,d.y,d.z,d.w];l.userData.skipUpdateJointNode=false;this._viewport._viewStateManager._setJointNodeMatrix();l.userData.skipUpdateJointNode=true}else{l.quaternion.copy(d.multiply(_))}l.updateMatrix();u.euler.x=u.eulerInParentCoors.x-u.startEulerInParentCoors.x+u.startEuler.x;u.euler.y=u.eulerInParentCoors.y-u.startEulerInParentCoors.y+u.startEuler.y;u.euler.z=u.eulerInParentCoors.z-u.startEulerInParentCoors.z+u.startEuler.z}}}this.endGesture()};d.prototype.rotateRestPosition=function(e,t,r){this.beginGesture();this._nodes.forEach(function(e){var t=e.node;if(!t.userData){t.userData={}}t.userData.skipUpdateJointNode=true});e=THREE.Math.degToRad(e);t=THREE.Math.degToRad(t);r=THREE.Math.degToRad(r);for(var i=0,a=this._nodes.length;i<a;i++){var n=this._nodes[i];if(!n.ignore){var s=n.node;var l;if(this._nodeUserDataMap){l=this._nodeUserDataMap.get(s)}if(l&&l.euler&&l.eulerInParentCoors){this._rotationDelta.set(THREE.Math.radToDeg(e-l.euler.x),THREE.Math.radToDeg(t-l.euler.y),THREE.Math.radToDeg(r-l.euler.z));l.euler.x=e;l.euler.y=t;l.euler.z=r;var u=new THREE.Euler(l.euler.x,l.euler.y,l.euler.z);var h=(new THREE.Quaternion).setFromEuler(u);var d=new THREE.Matrix4;var _=new THREE.Matrix4;if(this._coordinateSystem===o.Local){d=s.parent.matrixWorld.clone().multiply(l.matRest);_=l.matRestInv.clone().multiply(n.matParentInv)}else if(this._gizmo&&this._coordinateSystem!==o.Parent){d=this._gizmo.matrixWorld.clone();_=_.getInverse(d)}var p=(new THREE.Matrix4).makeRotationFromQuaternion(h);var E=p;if(this._coordinateSystem!==o.Parent){E=n.matParentInv.clone().multiply(d).multiply(p).multiply(_).multiply(s.parent.matrixWorld)}var c=(new THREE.Matrix4).makeRotationFromQuaternion(l.quatInitialDiff).multiply(E);var m=(new THREE.Euler).setFromRotationMatrix(c);if(Math.abs(m.x)<1e-6){m.x=0}if(Math.abs(m.y)<1e-6){m.y=0}if(Math.abs(m.z)<1e-6){m.z=0}l.eulerInParentCoors.x=f(l.eulerInParentCoors.x,m.x);l.eulerInParentCoors.y=f(l.eulerInParentCoors.y,m.y);l.eulerInParentCoors.z=f(l.eulerInParentCoors.z,m.z);s.matrix=l.matInitialDiff.clone().multiply(E.multiply(l.matRest));s.matrix.decompose(s.position,s.quaternion,s.scale);s.updateMatrix()}}}this.endGesture()};d.prototype._updateEulerForCreatingAnimationKey=function(e){for(var t=0,r=this._nodes.length;t<r;t++){var i=this._nodes[t];if(!i.ignore){var a=i.node;var s;if(this._nodeUserDataMap){s=this._nodeUserDataMap.get(a)}if(s&&s.euler){s.euler.x=s.startEuler.x+e[0];s.euler.y=s.startEuler.y+e[1];s.euler.z=s.startEuler.z+e[2];var l=false;if(Math.abs(s.euler.x)<1e-6&&(Math.abs(s.euler.y)<1e-6||Math.abs(s.euler.z)<1e-6)||Math.abs(s.euler.y)<1e-6&&Math.abs(s.euler.z)<1e-6){l=true}if(l&&this._coordinateSystem===o.Parent){s.eulerInParentCoors.x=s.startEulerInParentCoors.x+e[0];s.eulerInParentCoors.y=s.startEulerInParentCoors.y+e[1];s.eulerInParentCoors.z=s.startEulerInParentCoors.z+e[2];continue}var u=this._viewport._viewStateManager.getRelativeTransformation(a);var h;var d=this._getEffectiveParent(a);if(d!==a.parent&&this._coordinateSystem!==o.Custom){this._viewport._viewStateManager._setJointNodeOffsets(a,n.Rotate);h=new THREE.Quaternion(a.userData.offsetQuaternion[0],a.userData.offsetQuaternion[1],a.userData.offsetQuaternion[2],a.userData.offsetQuaternion[3]);a.userData.skipUpdateJointNode=false;this._viewport._viewStateManager._setJointNodeMatrix();a.userData.skipUpdateJointNode=true}else{h=new THREE.Quaternion(u.quaternion[0],u.quaternion[1],u.quaternion[2],u.quaternion[3])}var _=(new THREE.Matrix4).makeRotationFromQuaternion(h);if(this._playback){var p=this._viewport._viewStateManager._getEndPropertyInPreviousPlayback(a,n.Rotate,this._playback);if(p){var E=new THREE.Quaternion(p[0],p[1],p[2],p[3]);var c=(new THREE.Matrix4).makeRotationFromQuaternion(E);_.multiply((new THREE.Matrix4).getInverse(c))}}var m=(new THREE.Euler).setFromRotationMatrix(_);if(Math.abs(m.x)<1e-5){m.x=0}if(Math.abs(m.y)<1e-5){m.y=0}if(Math.abs(m.z)<1e-5){m.z=0}s.eulerInParentCoors.x=f(s.eulerInParentCoors.x,m.x);s.eulerInParentCoors.y=f(s.eulerInParentCoors.y,m.y);s.eulerInParentCoors.z=f(s.eulerInParentCoors.z,m.z);if(l){continue}var v=new THREE.Matrix4;var g=new THREE.Matrix4;if(this._coordinateSystem===o.Local){v=a.parent.matrixWorld.clone().multiply(s.matRest);g=s.matRestInv.clone().multiply(i.matParentInv)}else if(this._gizmo&&this._coordinateSystem!==o.Parent){v=this._gizmo.matrixWorld.clone();g=g.getInverse(v)}var y=new THREE.Quaternion(u.quaternion[0],u.quaternion[1],u.quaternion[2],u.quaternion[3]);y.multiply(s.quatInitialDiffInv);var x=(new THREE.Matrix4).makeRotationFromQuaternion(y);var T=x;if(this._coordinateSystem!==o.Parent){T=g.clone().multiply(a.parent.matrixWorld).multiply(x).multiply(i.matParentInv).multiply(v)}m=(new THREE.Euler).setFromRotationMatrix(T);if(Math.abs(m.x)<1e-6){m.x=0}if(Math.abs(m.y)<1e-6){m.y=0}if(Math.abs(m.z)<1e-6){m.z=0}s.euler.x=f(s.euler.x,m.x);s.euler.y=f(s.euler.y,m.y);s.euler.z=f(s.euler.z,m.z)}}}};d.prototype._rotate=function(e){this._rotationDelta.set(THREE.Math.radToDeg(e.x),THREE.Math.radToDeg(e.y),THREE.Math.radToDeg(e.z));this._value.addVectors(this._beginValue,this._rotationDelta);this._nodes.forEach(function(e){var t=e.node;if(!t.userData){t.userData={}}t.userData.skipUpdateJointNode=true});var t=new THREE.Quaternion;if(this._coordinateSystem===o.Local){t.setFromEuler(e);this._nodes.forEach(function(e){var r=e.node;r.quaternion.copy(e.quaternion).multiply(t);r.updateMatrix()});e=e.toArray();this._updateEulerForCreatingAnimationKey(e)}else{e=e.toArray();for(var r=0;r<3;r++){var i=e[r];if(i){var a=e[3].charCodeAt(r)-88;if(a>=0&&a<3){var n=(new THREE.Vector3).setFromMatrixColumn(this._matOrigin,a).normalize();var s=(new THREE.Matrix4).makeRotationAxis(n,i);var l=(new THREE.Vector3).setFromMatrixPosition(this._matOrigin);s.setPosition(l.sub(l.clone().applyMatrix4(s)));for(var u=0,h=this._nodes.length;u<h;u++){var d=this._nodes[u];if(!d.ignore){var f=d.node;if(this._coordinateSystem!==o.Parent){f.position.setFromMatrixPosition(d.matOrigin).applyMatrix4(s).applyMatrix4(d.matParentInv)}var _=(new THREE.Vector3).setFromMatrixScale(d.matOrigin);var p=n.clone().transformDirection((new THREE.Matrix4).getInverse(d.matOrigin)).multiply(_).normalize();t.setFromAxisAngle(p,i);f.quaternion.copy(d.quaternion).multiply(t);f.updateMatrix()}}}}}this._updateEulerForCreatingAnimationKey(e)}this._viewport.setShouldRenderFrame()};d.prototype._setRotationAxisAngle=function(e,t,r){var i=(r-t)%(Math.PI*2);var a=new THREE.Euler;a[["x","y","z"][e]]=i;var n=this._getNodesProperties();if(this._tool.fireEvent("rotating",{x:THREE.Math.radToDeg(a.x),y:THREE.Math.radToDeg(a.y),z:THREE.Math.radToDeg(a.z),nodesProperties:n},true)){this._printEventInfo("Event 'rotating'",THREE.Math.radToDeg(a.x),THREE.Math.radToDeg(a.y),THREE.Math.radToDeg(a.z),n);this._rotate(a);var s=[0,0,0];var l=new THREE.Vector3;var u=(e+1)%3,h=(e+2)%3;var d,f=Math.max(Math.ceil(Math.abs(i)*64/Math.PI),1);i*=this._coordinateSystem===o.Local?-1:1;for(d=0;d<=f;d++){var _=t+i*(d/f);l.set(0,0,0).setComponent(u,Math.cos(_)).setComponent(h,Math.sin(_));s.push(l.x,l.y,l.z)}var p=[];for(d=0;d<f;d++){p.push(0,d+1,d+2)}var E=new THREE.BufferGeometry;E.setIndex(p);E.setAttribute("position",new THREE.Float32BufferAttribute(s,3));this._arcMesh.geometry=E;this._arcMesh.visible=true}};d.prototype.rotate=function(e,t,r){this.beginGesture();this._rotate(new THREE.Euler(THREE.Math.degToRad(e||0),THREE.Math.degToRad(t||0),THREE.Math.degToRad(r||0)))};d.prototype._getValueLocaleOptions=function(){return{useGrouping:false,minimumFractionDigits:1,maximumFractionDigits:2}};d.prototype.getValue=function(){return this._gizmoIndex>=0&&this._handleIndex>=0&&this._handleIndex<3?this._value.getComponent(this._handleIndex):0};d.prototype.setValue=function(e){if(this._gizmoIndex>=0&&this._handleIndex>=0&&this._handleIndex<3){var t=new THREE.Euler;t[["x","y","z"][this._handleIndex]]=THREE.Math.degToRad(e-this._value.getComponent(this._handleIndex));this.beginGesture();this._rotate(t);this.endGesture()}};d.prototype.expandBoundingBox=function(e){if(this._viewport){this._expandBoundingBox(e,this._viewport.getCamera().getCameraRef(),true)}};d.prototype._updateSelection=function(e){t.prototype._updateSelection.call(this,e);if(this._tool.getEnableSnapping()){this._tool.getDetector().setSource(e)}};d.prototype.handleSelectionChanged=function(e){if(this._viewport){this._updateSelection(this._viewport._viewStateManager);var t=this._getNodesProperties();this._tool.fireEvent("rotating",{x:0,y:0,z:0,nodesProperties:t},true);this._gizmoIndex=this._handleIndex=-1}};d.prototype._getLevelingQuaternion=function(e,t){e.set(0,0,0,1);switch(this._coordinateSystem){case o.Local:e.setFromRotationMatrix(this._nodes[t].node.parent.matrixWorld);break;case o.Screen:e.copy(this._viewport.getCamera().getCameraRef().quaternion);break;case o.Custom:var r=this._getAnchorPoint();if(r){e.copy(r.quaternion)}break;default:break}};d.prototype._getObjectSize=function(e){var t=new THREE.Box3;if(this._nodes.length===1){this._nodes[0].node._expandBoundingBox(t,true,false)}else if(this._coordinateSystem===o.Local){this._nodes[0].node._expandBoundingBox(t,true,false)}if(t.isEmpty()){return 0}var r=new THREE.Vector3;t.getSize(r);return r.length()};d.prototype._updateGizmoTransformation=function(e,t){var r=this._updateGizmoObjectTransformation(this._gizmo,e);this._updateAxisTitles(this._axisTitles,this._gizmo,t,this._gizmoSize-12,r)};d.prototype._getEditingFormPosition=function(){var e=this._updateGizmoObjectTransformation(this._gizmo,this._gizmoIndex);var t=(new THREE.Vector3).setFromMatrixColumn(this._gizmo.matrixWorld,this._handleIndex).normalize();return t.clone().multiplyScalar((this._gizmoSize-12)*e).add(this._gizmo.position).applyMatrix4(this._matViewProj)};d.prototype.render=function(){u(this._viewport&&this._viewport.getMetadata().getName()==="sap.ui.vk.threejs.Viewport","Can't render gizmo without sap.ui.vk.threejs.Viewport");if(this._nodes.length>0){var e=this._viewport.getRenderer(),t=this._viewport.getCamera().getCameraRef();this._matViewProj.multiplyMatrices(t.projectionMatrix,t.matrixWorldInverse);e.clearDepth();for(var r=0,i=this.getGizmoCount();r<i;r++){this._updateGizmoTransformation(r,t);e.render(this._sceneGizmo,t)}}this._updateEditingForm(this._nodes.length>0&&this._gizmoIndex>=0&&this._handleIndex>=0&&this._handleIndex<3,this._handleIndex)};return d});
//# sourceMappingURL=RotateToolGizmo.js.map