/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
 */
sap.ui.define(["../getResourceBundle","../thirdparty/three","./Gizmo","./AxisColours","../threejs/ThreeUtils","sap/base/assert"],function(t,e,i,o,r,s){"use strict";var n=i.extend("sap.ui.vk.tools.CrossSectionToolGizmo",{metadata:{library:"sap.ui.vk"}});n.prototype.init=function(){if(i.prototype.init){i.prototype.init.apply(this)}this._createEditingForm(t().getText("TOOL_UNITS_MM"),84);this._handleIndex=-1;this._viewport=null;this._tool=null;this._position=new THREE.Vector3(0,0,0);this._plane=new THREE.Plane(new THREE.Vector3(0,0,1),0);this._flip=false;this._matViewProj=new THREE.Matrix4;this._gizmoSize=144;this._firstShowPress=true;this.setAxis(0)};n.prototype.hasDomElement=function(){return true};n.prototype.show=function(t,e){this._viewport=t;this._tool=e;if(this._firstShowPress){var i=t._scene?t._scene._computeBoundingBox(true,true):new THREE.Box3;i.getCenter(this._position);this._firstShowPress=false}this._plane.constant=-this._plane.normal.dot(this._position);t.setClippingPlanes([this._plane])};n.prototype.hide=function(){if(this._viewport){this._viewport.setClippingPlanes([]);this._viewport=null}this._handleIndex=-1;this._tool=null;this._updateEditingForm(false,-1)};n.prototype._getOffset=function(){return this._position.getComponent(this._axis)};n.prototype.getAxis=function(){return this._axis};n.prototype.setAxis=function(t){this._handleIndex=-1;this._axis=t;var e=(new THREE.Vector3).setComponent(t,1);this._plane.normal.set(0,0,0).setComponent(t,this._flip?-1:1);this._plane.constant=-this._plane.normal.dot(this._position);var i=new THREE.BufferGeometry;var r=new Array(15);var s=new THREE.Vector3(e.y,e.z,e.x),n=new THREE.Vector3(e.z,e.x,e.y),a=new THREE.Vector3;a.sub(s).sub(n).multiplyScalar(.5).toArray(r,0);a.toArray(r,12);a.add(s).toArray(r,3);a.add(n).toArray(r,6);a.sub(s).toArray(r,9);i.setAttribute("position",new THREE.Float32BufferAttribute(r,3));this._gizmoPlane=new THREE.Line(i,new THREE.LineBasicMaterial({color:4210752,transparent:true,linewidth:window.devicePixelRatio}));var h=144,p=window.devicePixelRatio*.5,l=32,_=6,u=48;e=this._plane.normal.clone().multiplyScalar(1/h);var m=0;switch(t){case 0:m=o.x;break;case 1:m=o.y;break;case 2:m=o.z;break;default:break}var c=new THREE.CylinderBufferGeometry(p,p,h-l,4);var d=(new THREE.Matrix4).makeBasis(new THREE.Vector3(e.y,e.z,e.x),e,new THREE.Vector3(e.z,e.x,e.y));d.setPosition(e.clone().multiplyScalar((h-l)*.5));c.applyMatrix4(d);this._gizmoArrow=new THREE.Mesh(c,new THREE.MeshBasicMaterial({color:m}));this._gizmoArrow.userData.color=m;var w=new THREE.CylinderBufferGeometry(0,_,l,12,1);d.setPosition(e.clone().multiplyScalar(h-l*.5));w.applyMatrix4(d);var g=new THREE.Mesh(w,new THREE.MeshBasicMaterial({color:m}));g.matrixAutoUpdate=false;this._gizmoArrow.add(g);var x=new THREE.CylinderGeometry(u*.5,u*.5,h,12,1);d.setPosition(e.clone().multiplyScalar(h*.5));x.applyMatrix4(d);this._touchMesh=new THREE.Mesh(x,new THREE.MeshBasicMaterial({visible:false,side:THREE.DoubleSide}));this._gizmoArrow.add(this._touchMesh);if(this._viewport){this._viewport.setShouldRenderFrame()}return this};n.prototype.setFlip=function(t){this._flip=!!t;var e=this._handleIndex;this.setAxis(this._axis);this._handleIndex=e;return this};n.prototype.getTouchObject=function(){return this._touchMesh};var a=new THREE.Vector3;n.prototype._getDelta=function(){var t=this._viewport._scene._computeBoundingBox(true,true);t.getSize(a);return Math.max(a.x,a.y,a.z)};n.prototype._setOffset=function(t){var e=this._viewport._scene._computeBoundingBox(true,true);t=THREE.Math.clamp(t,e.min.getComponent(this._axis),e.max.getComponent(this._axis));this._position.setComponent(this._axis,t);this._plane.constant=-this._plane.normal.dot(this._position);this._viewport.setShouldRenderFrame()};n.prototype.getValue=function(){return this._position.getComponent(this._handleIndex)};n.prototype.setValue=function(t){if(this._handleIndex>=0){this._position.setComponent(this._handleIndex,t);this._plane.constant=t;this._viewport.setShouldRenderFrame()}};n.prototype.highlightArrowHandle=function(t){var e=t?16776960:this._gizmoArrow.userData.color;this._gizmoArrow.material.color.setHex(e);this._gizmoArrow.children[0].material.color.setHex(e)};n.prototype.selectHandle=function(t){this._handleIndex=t;this._viewport.setShouldRenderFrame()};n.prototype._adjustBoundingBox=function(t){t.getSize(a);var e=Math.max(a.x,a.y,a.z)*.2;t.expandByScalar(e)};n.prototype._updateGizmo=function(t){var e=this._axis;var i=THREE.Math.clamp(this._position.getComponent(e),t.min.getComponent(e),t.max.getComponent(e));this._position.setComponent(e,i);this._plane.constant=-this._plane.normal.dot(this._position);this._adjustBoundingBox(t);t.getCenter(this._gizmoPlane.position);this._gizmoPlane.position.setComponent(e,i);t.getSize(this._gizmoPlane.scale);this._gizmoPlane.updateMatrixWorld(true);var o=this._viewport.getCamera().getCameraRef();this._gizmoArrow.position.copy(this._gizmoPlane.position);this._matViewProj.multiplyMatrices(o.projectionMatrix,o.matrixWorldInverse);this._gizmoArrow.scale.setScalar(this._gizmoSize*this._getGizmoScale(this._gizmoArrow.position));this._gizmoArrow.updateMatrixWorld(true)};n.prototype.expandBoundingBox=function(t){if(this._viewport){var e=this._viewport._scene._computeBoundingBox(true,true);this._updateGizmo(e);t.min.min(e.min);t.max.max(e.max);t.expandByPoint(this._plane.normal.clone().multiply(this._gizmoArrow.scale).add(this._gizmoArrow.position))}};n.prototype._getEditingFormPosition=function(){return this._plane.normal.clone().applyMatrix4(this._gizmoArrow.matrixWorld).applyMatrix4(this._matViewProj)};n.prototype.render=function(){s(this._viewport&&this._viewport.getMetadata().getName()==="sap.ui.vk.threejs.Viewport","Can't render gizmo without sap.ui.vk.threejs.Viewport");var t=this._viewport._scene._computeBoundingBox(true,true);this._updateGizmo(t);var e=this._viewport.getRenderer(),i=this._viewport.getCamera().getCameraRef();e.render(this._gizmoPlane,i);e.clearDepth();e.render(this._gizmoArrow,i);this._gizmo=this._gizmoArrow;this._updateEditingForm(this._handleIndex>=0,this._handleIndex)};n.prototype.exit=function(){if(this._gizmoArrow){r.disposeObject(this._gizmoArrow);this._gizmoArrow=null}if(this._gizmoPlane){r.disposeObject(this._gizmoPlane);this._gizmoPlane=null}if(this._touchMesh){r.disposeObject(this._touchMesh);this._touchMesh=null}i.prototype.exit.call(this)};return n});
//# sourceMappingURL=CrossSectionToolGizmo.js.map