/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
 */
sap.ui.define(["sap/ui/core/Core","sap/base/Log","../measurements/Edge","../measurements/Face","../measurements/Vertex","../measurements/MeshAnalyzer","../measurements/MeshAnalyzer2D","../measurements/Settings","./MeasurementToolState","./Gizmo"],function(e,t,r,a,s,i,n,u,o,h){"use strict";var l=h.extend("sap.ui.vk.tools.MeasurementToolGizmo",{metadata:{library:"sap.ui.vk"}});var _=l.getMetadata().getParent().getClass().prototype;l.prototype.hasDomElement=function(){return false};l.prototype.init=function(){if(_.init){_.init.call(this)}this._viewport=null;this._surface=null;this._tool=null;this._vsm=null;this._settings=null;this._state=o.Off;this._hoverPoint=null;this._currentFeature=null;this._currentFeatureIndex=0;this._firstFeature=null;this._secondFeature=null;this._vertexFeatures=[new s];this._edgeFeatures=[new r];this._faceFeatures=[new a];this._currentMeasurement=null;this._meshAnalyzerMap=new Map;this._is2D=false};l.prototype.setCurrentFeatureIndex=function(e){if(e<1&&this._firstFeature){t.error("setCurrentFeatureIndex: first feature not null with index="+e)}if(e<2&&this._secondFeature){t.error("setCurrentFeatureIndex: second feature not null with index="+e)}var i=e-this._currentFeatureIndex;if(i===1){this._currentFeatureIndex++;this._vertexFeatures.push(new s);this._edgeFeatures.push(new r);this._faceFeatures.push(new a)}else if(i===-1){this._currentFeatureIndex--;this._vertexFeatures.pop();this._edgeFeatures.pop();this._faceFeatures.pop()}else if(e===0){this._currentFeatureIndex=0;this._vertexFeatures.splice(1);this._edgeFeatures.splice(1);this._faceFeatures.splice(1)}else if(i!==0){t.error("setCurrentFeatureIndex: "+this._currentFeatureIndex+" => "+e)}};l.prototype._createMeshAnalyzer=function(e){var t=null;var r=0;var a=0;var s=function(e){if(e.geometry&&e.geometry.isBufferGeometry){var a=e.geometry.getAttribute("position");var i=e.geometry.getIndex();if(a&&i){if(t){for(var n=0;n<i.count;n+=3){var u=(new THREE.Vector3).fromArray(a.array,i.array[n]*3);var o=(new THREE.Vector3).fromArray(a.array,i.array[n+1]*3);var h=(new THREE.Vector3).fromArray(a.array,i.array[n+2]*3);u.applyMatrix4(e.matrixWorld);o.applyMatrix4(e.matrixWorld);h.applyMatrix4(e.matrixWorld);t.addTriangle([u.x,u.y,u.z],[o.x,o.y,o.z],[h.x,h.y,h.z])}}else{r+=i.count}}}e.children.forEach(s)};for(var n=0;n<2;++n){s(e);if(n===0){t=new i(r/3,a)}}t.finishMeshBuilding();return t};l.prototype._createMeshAnalyzer2D=function(e){return new n(e,this._viewport.getCamera()._getViewBox())};l.prototype._getMeshAnalyzer=function(e){var t=this._meshAnalyzerMap.get(e);if(t!=null){return t}var r=this._is2D?this._createMeshAnalyzer2D(e):this._createMeshAnalyzer(e);this._meshAnalyzerMap.set(e,r);return r};l.prototype.show=function(t,r){this._viewport=t;this._surface=t.getMeasurementSurface();this._tool=r;this._vsm=e.byId(t.getViewStateManager());this._is2D=t.getScene().getMetadata().getName()==="sap.ui.vk.svg.Scene";this._settings=u.load();this._state=o.SearchingFirstFeature;this.setCurrentFeatureIndex(0)};l.prototype.hide=function(){if(this._surface!=null){var e=this._surface;for(var t=0,r=this._faceFeatures.length;t<r;++t){e.removeFeature(this._faceFeatures[t])}for(var a=0,s=this._edgeFeatures.length;a<s;++a){e.removeFeature(this._edgeFeatures[a])}for(var i=0,n=this._vertexFeatures.length;i<n;++i){e.removeFeature(this._vertexFeatures[i])}if(this._currentMeasurement!=null){e.removeMeasurement(this._currentMeasurement);this._currentMeasurement=null}}var u=this._vsm;var h=this._hoverPoint&&this._hoverPoint.nodeRef;if(h!=null&&u!=null){u.setOutliningStates([],[h],false,true)}this._viewport=null;this._surface=null;this._tool=null;this._vsm=null;this._settings=null;this._state=o.Off;this._currentFeature=null;this._firstFeature=null;this._secondFeature=null;this.setCurrentFeatureIndex(0);this._hoverPoint=null};l.prototype._computeSphereRadius=function(e,t){var r=this._is2D?5:3;if(this._is2D){var a=t._camera._worldToScreen(e[0],e[1]);var s=t._camera._screenToWorld(a.x+r,a.y);r=Math.abs(e[0]-s.x)}else{var i=t.getDomRef().getBoundingClientRect();var n=i.width*.5;var u=i.height*.5;var o=t.getCamera().getCameraRef();var h=(new THREE.Vector3).fromArray(e);var l=h.clone();l.project(o);var _=r/n;var c=r/u;r=0;for(var f=0;f<4;++f){var v=f%2?-1:1;var p=new THREE.Vector3(l.x+v*(f<2?_:0),l.y+v*(f>=2?c:0),l.z);p.unproject(o);var m=p.distanceTo(h);if(m>r){r=m}}}return r};l.prototype._replaceCurrentFeature=function(e,t,r){var a=false;if(e!==this._currentFeature){this._surface.removeFeature(this._currentFeature);this._surface.addFeature(e);this._currentFeature=e;a=true}else if(r!==e.getContext()||t!==e.getFeatureId()){a=true}if(a){e.setContext(r);e.setFeatureId(t)}return a};return l});
//# sourceMappingURL=MeasurementToolGizmo.js.map