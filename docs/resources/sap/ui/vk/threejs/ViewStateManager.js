/*!
* SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
*/
sap.ui.define(["../Core","../ViewStateManagerBase","../thirdparty/three","../cssColorToColor","../colorToCSSColor","../abgrToColor","../colorToABGR","./Scene","../ObjectType","../RotationType","./NodesTransitionHelper","./OutlineRenderer","./HighlightPlayer","../HighlightDisplayState","../Highlight","../AnimationTrackType","../AnimationTrackValueType","../AnimationMath","../NodeContentType","./ThreeUtils","sap/ui/core/Core"],function(t,e,i,r,n,a,o,s,l,u,c,h,f,d,p,y,v,g,_,m,A){"use strict";var w;var C=e.extend("sap.ui.vk.threejs.ViewStateManager",{metadata:{library:"sap.ui.vk"}});var b=C.getMetadata().getParent().getClass().prototype;C.prototype.init=function(){if(b.init){b.init.call(this)}this._nodeHierarchy=null;this._nodeStates=new Map;this._selectedNodes=new Set;this._outlineRenderer=new h(1);this._outlinedNodes=new Set;this.setOutlineColor("rgba(255, 0, 255, 1.0)");this.setOutlineWidth(1);this._visibilityTracker=new w;this._showSelectionBoundingBox=true;this._boundingBoxesScene=new i.Scene;this._selectionColor=new i.Color(12632064);this.setHighlightColor("rgba(255, 0, 0, 1.0)");this._joints=[];this._nodesTransitionHelper=new c;this._nodesTransitionHelper.setViewStateManager(this);this._highlightPlayer=new f;this._highlightPlayer.setViewStateManager(this);this._transitionPlayer=new f;this._transitionPlayer.setViewStateManager(this);t.getEventBus().subscribe("sap.ui.vk","activateView",this._onActivateView,this)};C.prototype._clearBoundingBoxScene=function(){var t=[];var e=[];m.getAllTHREENodes([this._boundingBoxesScene],t,e);t.forEach(function(t){m.disposeObject(t);t.parent.remove(t)});e.forEach(function(t){t.parent.remove(t)})};C.prototype.exit=function(){t.getEventBus().unsubscribe("sap.ui.vk","activateView",this._onActivateView,this);if(this._nodesTransitionHelper){this._nodesTransitionHelper.destroy()}if(this._outlineRenderer){this._outlineRenderer.dispose();this._outlineRenderer=null}if(this._boundingBoxesScene){this._clearBoundingBoxScene();this._boundingBoxesScene.dispose();this._boundingBoxesScene=null}};C.prototype._setContent=function(t){if(t===this._scene){return this}var e=null;if(t&&t instanceof s){e=t}this._setScene(e);if(e){var i=e.getInitialView();if(i){this._currentView=i;this._resetNodesMaterialAndOpacityByCurrentView(this._currentView)}}return this};C.prototype._setScene=function(t){if(this._boundingBoxesScene){this._clearBoundingBoxScene()}this._boundingBoxesScene=new i.Scene;this._setNodeHierarchy(t?t.getDefaultNodeHierarchy():null);if(t){t.setViewStateManager(this)}this._scene=t;if(this._scene){var e=this._scene.getInitialView();if(e){this.activateView(e)}}return this};C.prototype._setNodeHierarchy=function(t){var e=this._nodeHierarchy;if(this._nodeHierarchy){this._nodeHierarchy=null;this._nodeStates.clear();this._selectedNodes.clear();this._outlinedNodes.clear();this._visibilityTracker.clear()}if(t){this._nodeHierarchy=t;this._nodeHierarchy.attachNodeReplaced(this._handleNodeReplaced,this);this._nodeHierarchy.attachNodeUpdated(this._handleNodeUpdated,this);this._nodeHierarchy.attachNodeRemoving(this._handleNodeRemoving,this);this._initialState={visible:[],hidden:[]};var i=this;var r=t.findNodesByName();r.forEach(function(t){i._initialState[t.visible?"visible":"hidden"].push(t)});this.fireVisibilityChanged({visible:this._initialState.visible,hidden:this._initialState.hidden})}if(t!==e){this.fireNodeHierarchyReplaced({oldNodeHierarchy:e,newNodeHierarchy:t})}return this};C.prototype._getJointByChildNode=function(t){var e;if(this._jointCollection){for(var i=0;i<this._jointCollection.length;i++){if(this._jointCollection[i].node===t){e=this._jointCollection[i];break}}}return e};C.prototype._handleNodeReplaced=function(t){var e=t.getParameter("ReplacedNodeRef");var i=t.getParameter("ReplacementNodeRef");if(this.getSelectionState(e)){this.setSelectionState(i,true);this.setSelectionState(e,false)}};C.prototype._handleNodeUpdated=function(t){var e=t.getParameter("nodeRef");if(this.getSelectionState(e)){this.setSelectionState(e,false);this.setSelectionState(e,true)}};C.prototype._handleNodeRemoving=function(t){var e=t.getParameter("nodeRef");if(this._jointCollection){for(var i=0;i<this._jointCollection.length;i++){if(this._jointCollection[i].node===e){this._jointCollection[i].node=null;break}if(this._jointCollection[i].parent===e){this._jointCollection[i].parent=null;break}}}if(this.getSelectionState(e)){this.setSelectionState(e,false,true,true)}};C.prototype._renderOutline=function(t,e,r){var n=a(this._outlineColorABGR);var o=new i.Color(n.red/255,n.green/255,n.blue/255);this._outlineRenderer.render(t,e,r,Array.from(this._outlinedNodes),o,this._jointCollection)};C.prototype.getNodeHierarchy=function(){return this._nodeHierarchy};C.prototype.getVisibilityChanges=function(){return this.getShouldTrackVisibilityChanges()?this._visibilityTracker.getInfo(this.getNodeHierarchy()):null};C.prototype.getCurrentView=function(){var t=A.byId(this.getViewManager());if(!t){return null}var e=t.getActiveView();return e};C.prototype.resetNodeProperty=function(t,e){var r=this.getCurrentView();if(!r){return}var n=r.getNodeInfos();if(n){var a=[];a.push(t);if(this._jointCollection&&this._jointCollection.length>0){for(var o=0;o<this._jointCollection.length;o++){var s=this._jointCollection[o];if(!s.node||!s.parent){continue}var l=s.parent;if(l!==t){break}a.push(s.node)}}n.forEach(function(r){if(!a.includes(r.target)){return}if(!e||e!==y.Opacity){var o={nodeRefs:[],positions:[]};var s;var l;var u;if(r.transform){var c=new i.Vector3;var h=new i.Quaternion;var f=new i.Vector3;var d=x(r.transform);d.decompose(c,h,f);s=c.toArray();l=h.toArray();u=f.toArray()}else if(r[y.Scale]&&r[y.Rotate]&&r[y.Translate]){s=r[y.Translate].slice();l=r[y.Rotate].slice();u=r[y.Scale].slice()}if(s){o.nodeRefs.push(r.target);o.positions.push({translation:s,quaternion:l,scale:u});this.setTransformation(o.nodeRefs,o.positions)}}else{t._vkSetOpacity(r.opacity,this._jointCollection);var p={changed:t,opacity:n.opacity};this.fireOpacityChanged(p)}}.bind(this))}};C.prototype.getVisibilityComplete=function(){var t=this.getNodeHierarchy(),e=t.findNodesByName(),i=[],r=[];e.forEach(function(e){var n=t.createNodeProxy(e);var a=n.getVeId();t.destroyNodeProxy(n);if(a){if(this.getVisibilityState(e)){i.push(a)}else{r.push(a)}}},this);return{visible:i,hidden:r}};C.prototype.resetVisibility=function(){this.setVisibilityState(this._initialState.visible,true,false);this.setVisibilityState(this._initialState.hidden,false,false);this._visibilityTracker.clear()};C.prototype.getVisibilityState=function(t){if(Array.isArray(t)){return t.map(function(t){return t?t.visible:false})}return t?t.visible:false};C.prototype.setVisibilityState=function(t,e,i,r){if(!Array.isArray(t)){t=[t]}var n=Array.isArray(e);var a=[];var o=t;if(i){o=[];t.forEach(function(t,i){var r=this._collectNodesRecursively(t);o=o.concat(r);var s=a.length;a.length=s+r.length;a.fill(n?e[i]:e,s)},this)}else if(!n){a.length=o.length;a.fill(e)}else{a=e}var s=[];var l=new Set;var u=o.filter(function(t,e){if(t==null||t.userData.skipIt&&t.visible||l.has(t)){return false}l.add(t);var i=t?t.visible!=a[e]:false;if(i){s.push(a[e])}return i},this);if(u.length>0){var c={visible:[],hidden:[]};u.forEach(function(t,e){t.visible=s[e];c[t.visible?"visible":"hidden"].push(t);if(r&&t.visible){var i=t.parent;while(i){i.visible=true;i=i.parent}}},this);if(this.getShouldTrackVisibilityChanges()){u.forEach(this._visibilityTracker.trackNodeRef,this._visibilityTracker)}this.fireVisibilityChanged(c)}return this};C.prototype.enumerateSelection=function(t){this._selectedNodes.forEach(t);return this};C.prototype.enumerateOutlinedNodes=function(t){this._outlinedNodes.forEach(t);return this};C.prototype.getSelectionState=function(t){var e=this._selectedNodes;function i(t){return e.has(t)}return Array.isArray(t)?t.map(i):i(t)};C.prototype._getSelectionComplete=function(){var t=this.getNodeHierarchy(),e=[],i=[];function r(e){var i=t.createNodeProxy(e);var r=i.getVeId();t.destroyNodeProxy(i);return r}this._selectedNodes.forEach(function(t){var i=r(t);if(i){e.push(i)}});this._outlinedNodes.forEach(function(t){var e=r(t);if(e){i.push(e)}});return{selected:e,outlined:i}};C.prototype._isAChild=function(t,e){var i=t.parent;while(i){if(e.has(i)){return true}i=i.parent}return false};C.prototype._AddBoundingBox=function(t){if(t.userData.boundingBox===undefined){t.userData.boundingBox=new i.Box3;t._vkCalculateObjectOrientedBoundingBox()}if(!t.userData.boundingBox.isEmpty()&&this._boundingBoxesScene&&t.userData.boxHelper===undefined){var e=new i.Box3Helper(t.userData.boundingBox,16776960);e.material.color=this._selectionColor;this._boundingBoxesScene.add(e);e.parent=t;t.userData.boxHelper=e}};C.prototype._RemoveBoundingBox=function(t){if(t.userData.boundingBox!==undefined){delete t.userData.boundingBox}if(t.userData.boxHelper!==undefined){this._boundingBoxesScene.remove(t.userData.boxHelper);m.disposeObject(t.userData.boxHelper);delete t.userData.boxHelper}};C.prototype._updateBoundingBoxesIfNeeded=function(){var t=new Set;this._selectedNodes.forEach(function(e){var i=e.parent;while(i){if(this._selectedNodes.has(i)){t.add(i)}i=i.parent}}.bind(this));t.forEach(function(t){t._vkCalculateObjectOrientedBoundingBox()})};C.prototype._updateBoundingBoxes=function(){this._selectedNodes.forEach(function(t){if(t.userData.boundingBox){t._vkCalculateObjectOrientedBoundingBox()}})};C.prototype.setShowSelectionBoundingBox=function(t){this._showSelectionBoundingBox=t;if(this._showSelectionBoundingBox){this._selectedNodes.forEach(function(t){this._AddBoundingBox(t)}.bind(this))}else{this._selectedNodes.forEach(function(t){this._RemoveBoundingBox(t)}.bind(this))}this.fireSelectionChanged({selected:this._selectedNodes,unselected:[]})};C.prototype.getShowSelectionBoundingBox=function(){return this._showSelectionBoundingBox};C.prototype._isAncestorSelected=function(t){t=t.parent;while(t){if(this._selectedNodes.has(t)){return true}t=t.parent}return false};C.prototype._updateHighlightColor=function(t,e){var i=e||this._selectedNodes.has(t);var r=t._vkGetNodeContentType();if(r===_.Background||r===_.Symbol){return}else{t.userData.highlightColor=i?this._highlightColorABGR:undefined;t._vkUpdateMaterialColor();var n=t.children;for(var a=0,o=n.length;a<o;a++){var s=n[a].userData;if(s&&s.objectType===l.Hotspot){continue}this._updateHighlightColor(n[a],i)}}};C.prototype.setSelectionState=function(t,e,i,r){if(!t){return this}if(!Array.isArray(t)){t=[t]}t=(i||this.getRecursiveSelection()?this._collectNodesRecursively(t):t).filter(function(t,e,i){return i.indexOf(t)===e});if(this.getRecursiveSelection()&&!e){t=this._nodeHierarchy._appendAncestors(t)}var n=t.filter(function(t){return this._selectedNodes.has(t)!==e},this);if(n.length>0){n.forEach(function(t){if(t){this._selectedNodes[e?"add":"delete"](t);if(this._showSelectionBoundingBox){this[e?"_AddBoundingBox":"_RemoveBoundingBox"](t)}}},this);n.forEach(function(t){if(t){this._updateHighlightColor(t,e||this._isAncestorSelected(t))}},this);if(!r){this.fireSelectionChanged({selected:e?n:[],unselected:e?[]:n})}}return this};C.prototype.setSelectionStates=function(t,e,i,r){if(!Array.isArray(t)){t=[t]}if(!Array.isArray(e)){e=[e]}t=i||this.getRecursiveSelection()?this._collectNodesRecursively(t):t;e=i||this.getRecursiveSelection()?this._collectNodesRecursively(e):e;if(this.getRecursiveSelection()){e=this._nodeHierarchy._appendAncestors(e,t)}var n=t.filter(function(t){return this._selectedNodes.has(t)===false},this);var a=e.filter(function(t){return this._selectedNodes.has(t)===true},this);if(n.length>0||a.length>0){n.forEach(function(t){this._selectedNodes.add(t);this._updateHighlightColor(t,true);if(this._showSelectionBoundingBox){this._AddBoundingBox(t)}},this);a.forEach(function(t){this._selectedNodes.delete(t);if(this._showSelectionBoundingBox){this._RemoveBoundingBox(t)}},this);a.forEach(function(t){this._updateHighlightColor(t,this._isAncestorSelected(t))},this);if(!r){this.fireSelectionChanged({selected:n,unselected:a})}}return this};C.prototype.setOutlineColor=function(t){switch(typeof t){case"number":this._outlineColorABGR=t;break;case"string":if(sap.ui.core.CSSColor.isValid(t)){this._outlineColorABGR=o(r(t))}break;default:return this}this.fireOutlineColorChanged({outlineColor:n(a(this._outlineColorABGR)),outlineColorABGR:this._outlineColorABGR});return this};C.prototype.getOutlineColor=function(t){return t?this._outlineColorABGR:n(a(this._outlineColorABGR))};C.prototype.getOutliningState=function(t){var e=this._outlinedNodes;function i(t){return e.has(t)}return Array.isArray(t)?t.map(i):i(t)};C.prototype.setOutliningStates=function(t,e,i,r){if(!Array.isArray(t)){t=[t]}if(!Array.isArray(e)){e=[e]}t=i||this.getRecursiveOutlining()?this._collectNodesRecursively(t):t;e=i||this.getRecursiveOutlining()?this._collectNodesRecursively(e):e;if(this.getRecursiveOutlining()){e=this._nodeHierarchy._appendAncestors(e,t)}var n=t.filter(function(t){return this._outlinedNodes.has(t)===false},this);var a=e.filter(function(t){return this._outlinedNodes.has(t)===true},this);if(n.length>0||a.length>0){n.forEach(function(t){this._outlinedNodes.add(t)},this);a.forEach(function(t){this._outlinedNodes.delete(t)},this);if(!r){this.fireOutliningChanged({outlined:n,unoutlined:a})}}return this};C.prototype.setOutlineWidth=function(t){this._outlineWidth=t;this._outlineRenderer.setOutlineWidth(t);this.fireOutlineWidthChanged({width:t});return this};C.prototype.getOutlineWidth=function(){return this._outlineWidth};C.prototype._collectNodesRecursively=function(t){var e=[];var i=this._nodeHierarchy;(Array.isArray(t)?t:[t]).forEach(function t(r){e.push(r);i.enumerateChildren(r,t,false,true)});return e};C.prototype._getOpacity=function(t){return t.userData.opacity!==undefined?t.userData.opacity:null};C.prototype.getOpacity=function(t){if(Array.isArray(t)){return t.map(this._getOpacity,this)}else{return this._getOpacity(t)}};C.prototype.setOpacity=function(t,e,i){if(!Array.isArray(t)){t=[t]}var r=Array.isArray(e);if(e==null){e=undefined}else if(r){e.forEach(function(t,i){if(t==null){e[i]=undefined}})}var n=[];var a=t;if(!r){n.length=a.length;n.fill(e)}else{n=e}var o=[];var s=new Set;var l=a.filter(function(t,e){if(s.has(t)){return false}s.add(t);var i=t?t.userData.opacity!==n[e]:false;if(i){o.push(n[e])}return i},this);if(l.length>0){l.forEach(function(t,e){t._vkSetOpacity(o[e],this._jointCollection)},this);var u={changed:l,opacity:r?o:o[0]};this.fireOpacityChanged(u)}return this};C.prototype._getTintColorABGR=function(t){return t.userData.tintColor!==undefined?t.userData.tintColor:null};C.prototype._getTintColor=function(t){return t.userData.tintColor!==undefined?n(a(t.userData.tintColor)):null};C.prototype.getTintColor=function(t,e){var i=e?"_getTintColorABGR":"_getTintColor";if(Array.isArray(t)){return t.map(this[i],this)}else{return this[i](t)}};C.prototype.setTintColor=function(t,e,i){if(!Array.isArray(t)){t=[t]}var n=function(t){var e=null;switch(typeof t){case"number":e=t;break;case"string":if(sap.ui.core.CSSColor.isValid(t)){e=o(r(t))}break;default:e=undefined;break}return e};var a=Array.isArray(e);var s=[];var l=t;if(i){l=[];t.forEach(function(t,i){var r=this._collectNodesRecursively(t);l=l.concat(r);var n=s.length;s.length=n+r.length;s.fill(a?e[i]:e,n)},this)}else if(!a){s.length=l.length;s.fill(e)}else{s=e}var u=[];var c=new Set;var h=l.filter(function(t,e){if(c.has(t)){return false}c.add(t);var i=t?t.userData.tintColor!==n(s[e]):false;if(i){u.push(s[e])}return i},this);if(h.length>0){var f=[];h.forEach(function(t,e){var i=n(u[e]);t._vkSetTintColor(i);f.push(i)},this);var d={changed:h,tintColor:a?u:u[0],tintColorABGR:a?f:f[0]};this.fireTintColorChanged(d)}return this};C.prototype.setHighlightColor=function(t){switch(typeof t){case"number":this._highlightColorABGR=t;break;case"string":if(sap.ui.core.CSSColor.isValid(t)){this._highlightColorABGR=o(r(t))}break;default:return this}if(this._selectedNodes.size>0){this._selectedNodes.forEach(function(t){this._updateHighlightColor(t,true)},this)}this.fireHighlightColorChanged({highlightColor:n(a(this._highlightColorABGR)),highlightColorABGR:this._highlightColorABGR});return this};C.prototype.getHighlightColor=function(t){return t?this._highlightColorABGR:n(a(this._highlightColorABGR))};C.prototype.getRestTransformationUsingJoint=function(t){var e=this._getJointByChildNode(t);if(e&&e.translation&&e.scale&&e.quaternion){return e}else{return this.getRestTransformation(t)}};C.prototype.getRelativeTransformation=function(t){var e=function(t){var e=this.getRestTransformation(t);var r=[t.position.x-e.translation[0],t.position.y-e.translation[1],t.position.z-e.translation[2]];var n=(new i.Quaternion).fromArray(e.quaternion).inverse().premultiply(t.quaternion).toArray();var a=[t.scale.x/e.scale[0],t.scale.y/e.scale[1],t.scale.z/e.scale[2]];return{translation:r,quaternion:n,scale:a}}.bind(this);if(!Array.isArray(t)){return e(t)}var r=[];t.forEach(function(t){r.push(e(t))});return r};C.prototype.getTransformationWorld=function(t){var e=function(t){var e=new i.Vector3;var r=new i.Vector3;var n=new i.Quaternion;t.updateMatrixWorld();t.matrixWorld.decompose(e,n,r);return{translation:e.toArray(),quaternion:n.toArray(),scale:r.toArray()}};if(!Array.isArray(t)){return e(t)}var r=[];t.forEach(function(t){r.push(e(t))});return r};C.prototype.getTransformation=function(t){var e=function(t){return{translation:this.getTranslation(t),quaternion:this.getRotation(t,u.Quaternion),scale:this.getScale(t)}}.bind(this);if(!Array.isArray(t)){return e(t)}var i=[];t.forEach(function(t){i.push(e(t))});return i};C.prototype.getTranslation=function(t){var e=function(t){return t.position.toArray()};if(!Array.isArray(t)){return e(t)}var i=[];t.forEach(function(t){i.push(e(t))});return i};C.prototype.getScale=function(t){var e=function(t){return t.scale.toArray()};if(!Array.isArray(t)){return e(t)}var i=[];t.forEach(function(t){i.push(e(t))});return i};C.prototype._convertQuaternionToAngleAxis=function(t){if(t.w>1){t.normalize()}if(t.w>.9999&&t.x<1e-4&&t.y<1e-4&&t.z<1e-4){t.w=1;t.x=0;t.y=0;t.z=0}var e=2*Math.acos(t.w);var i;var r;var n;var a=Math.sqrt(1-t.w*t.w);if(a<1e-4){i=1;r=0;n=0}else{i=t.x/a;r=t.y/a;n=t.z/a}return[i,r,n,e]};C.prototype.getRotation=function(t,e){var r=function(t){var r=t.quaternion;var n;switch(e){case u.AngleAxis:n=this._convertQuaternionToAngleAxis(r);break;case u.Euler:var a=new i.Euler;a.setFromQuaternion(r);n=a.toArray();break;default:n=r.toArray()}return n};if(!Array.isArray(t)){return r(t)}var n=[];t.forEach(function(t){n.push(r(t))});return n};C.prototype.setTransformation=function(t,e){var r=Array.isArray(t);if(!Array.isArray(t)){t=[t]}var n={changed:[],transformation:[]};var a=function(t){return{position:t.position.toArray(),quaternion:t.quaternion.toArray(),scale:t.scale.toArray()}};if(!e){t.forEach(function(t){if(t.userData.position&&t.userData.quaternion&&t.userData.scale){t.position=t.userData.position;t.quaternion=t.userData.quaternion;t.scale=t.userData.scale;t.updateMatrix();delete t.userData.position;delete t.userData.quaternion;delete t.userData.scale}n.changed.push(t);n.transformation.push(a(t))},this)}else{if(!Array.isArray(e)){e=[e]}t.forEach(function(t,r){var o=t.userData;if(!o){return}if(!o.position){o.position=t.position.clone()}if(!o.quaternion){o.quaternion=t.quaternion.clone()}if(!o.scale){o.scale=t.scale.clone()}var s=e[r];if(s.transform){var l=x(s.transform);l.decompose(t.position,t.quaternion,t.scale)}else{t.position.fromArray(s.translation);t.scale.fromArray(s.scale);if(s.quaternion){t.quaternion.fromArray(s.quaternion)}else if(s.angleAxis){var u=new i.Vector3(s.angleAxis[0],s.angleAxis[1],s.angleAxis[2]);t.quaternion.setFromAxisAngle(u,s.angleAxis[3])}else if(s.euler){var c=new i.Euler;c.fromArray(s.euler[0],s.euler[1],s.euler[2],s.euler[3]);t.quaternion.setFromEuler(c)}}t.updateMatrix();n.changed.push(t);n.transformation.push(a(t))},this)}if(!r){n.changed=n.changed[0];n.transformation=n.transformation[0]}this.fireTransformationChanged(n);return this};C.prototype.getJoints=function(){return this._jointCollection};C.prototype.setJoints=function(t,e){this._jointCollection=[];this._playbackAssociatedWithJoints=null;if(!t){return this}var i=new Set;var r=new Map;t.forEach(function(t){if(!t.node||!t.parent){return}i.add(t.node);r.set(t.node,t)});while(i.size>0){var n=i.values().next().value;i.delete(n);var a=r.get(n);var o=[a];var s=[];var l=a.parent;while(l){a=r.get(l);if(a!==undefined){if(i.delete(l)){o.push(a)}if(s.length>0){a.nodesToUpdate=a.nodesToUpdate||[];while(s.length>0){var u=s.pop();if(a.nodesToUpdate.indexOf(u)>=0){break}a.nodesToUpdate.push(u)}}s.length=0;l=a.parent}else{s.push(l);l=l.parent}}while(o.length>0){this._jointCollection.push(o.pop())}}if(this._jointCollection&&this._jointCollection.length>0){this._playbackAssociatedWithJoints=e;this._jointCollection.forEach(function(t){if(!t.node||!t.parent){return}t.translation=null;t.scale=null;t.quaternion=null;t.opacity=null;if(t.node.userData){t.node.userData.offsetTranslation=null;t.node.userData.offsetQuaternion=null;t.node.userData.offsetScale=null;t.node.userData.originalRotationType=null;t.node.userData.offsetOpacity=null}});this._jointCollection.forEach(function(t){this._updateJointNode(t,this._playbackAssociatedWithJoints)}.bind(this))}return this};C.prototype._updateJointNode=function(t,e){if(!t.node||!t.parent){return}if(t.translation&&t.quaternion&&t.scale&&t.opacity){return}var r=new Map;if(this._jointCollection&&this._jointCollection.length>0){this._jointCollection.forEach(function(t){if(!t.node||!t.parent){return}r.set(t.node,t)})}var n,a,o,s,l,u;var c=t.node;var h=new i.Matrix4;var f,d=1;while(c){u=this.getRestOpacity(c);l=this.getRestTransformation(c);if(!l){c=c.parent;continue}n=new i.Vector3(l.translation[0],l.translation[1],l.translation[2]);a=new i.Vector3(l.scale[0],l.scale[1],l.scale[2]);o=new i.Quaternion(l.quaternion[0],l.quaternion[1],l.quaternion[2],l.quaternion[3]);f=u;if(e){var p=this._getEndPropertyInPreviousPlayback(c,y.Translate,e,true);if(p){n.x+=p[0];n.y+=p[1];n.z+=p[2]}var v=this._getEndPropertyInPreviousPlayback(c,y.Scale,e,true);if(v){a.x*=v[0];a.y*=v[1];a.z*=v[2]}var g=this._getEndPropertyInPreviousPlayback(c,y.Rotate,e,true);if(g){var _=new i.Quaternion(g[0],g[1],g[2],g[3]);o=_.multiply(o)}var m=this._getEndPropertyInPreviousPlayback(c,y.Opacity,e,true);if(m!=null){f*=m}}s=(new i.Matrix4).compose(n,o,a);h.premultiply(s);d*=f;c=c.parent}var A=t.parent;var w=new i.Matrix4;var C=1;while(A){var b=r.get(A);if(b){if(!b.translation){this._updateJointNode(b)}n=new i.Vector3(b.translation[0],b.translation[1],b.translation[2]);a=new i.Vector3(b.scale[0],b.scale[1],b.scale[2]);o=new i.Quaternion(b.quaternion[0],b.quaternion[1],b.quaternion[2],b.quaternion[3]);f=b.opacity;A=b.parent}else{u=this.getRestOpacity(A);l=this.getRestTransformation(A);if(!l){A=A.parent;continue}n=new i.Vector3(l.translation[0],l.translation[1],l.translation[2]);a=new i.Vector3(l.scale[0],l.scale[1],l.scale[2]);o=new i.Quaternion(l.quaternion[0],l.quaternion[1],l.quaternion[2],l.quaternion[3]);f=u;if(e){var S=this._getEndPropertyInPreviousPlayback(A,y.Translate,e,true);if(S){n.x+=S[0];n.y+=S[1];n.z+=S[2]}var x=this._getEndPropertyInPreviousPlayback(A,y.Scale,e,true);if(x){a.x*=x[0];a.y*=x[1];a.z*=x[2]}var T=this._getEndPropertyInPreviousPlayback(A,y.Rotate,e,true);if(T){var R=new i.Quaternion(T[0],T[1],T[2],T[3]);o=R.multiply(o)}var N=this._getEndPropertyInPreviousPlayback(A,y.Opacity,e,true);if(N!=null){f*=N}}A=A.parent}s=(new i.Matrix4).compose(n,o,a);w.premultiply(s);C*=f}var k=w.getInverse(w).multiply(h);k.decompose(n,o,a);t.translation=n.toArray();t.quaternion=o.toArray();t.scale=a.toArray();var V=function(t,e){if(t===e){return 1}else if(Math.abs(e)<1e-4){return 1}return t/e};t.opacity=V(d,C)};C.prototype._propagateOpacityToJointChildren=function(t,e){if(!t||!e||t.length!==e.length){return this}if(!this._jointCollection||!this._jointCollection.length){return this}var i=new Map;this._jointCollection.forEach(function(t){var e=i.get(t.parent);if(!e){e=[];i.set(t.parent,e)}e.push(t)});var r=function(t,e){if(t.opacity!=null&&t.node&&t.node.userData){t.node.userData.opacity=t.opacity*e;if(t.node.userData.offsetOpacity!=null){t.node.userData.opacity*=t.node.userData.offsetOpacity}}};t.forEach(function(t,n){var a=i.get(t);if(a){a.forEach(function(t){r(t,e[n])})}});return this};C.prototype._updateMaterialInNode=function(t){var e=t.target;for(var i=0,r=e.children.length;i<r;i++){var n=e.children[i];if(n.userData.animatedColor){n._vkUpdateMaterialColor()}}var a=t.materialId;if(e.userData.materialId!==a){e.userData.materialId=a;this._scene._setNodeMaterial(e,a)}};C.prototype.getSymbolNodes=function(t){var e=this.getCurrentView()||this._scene.getViews()[0];var i=e?e.getNodeInfos().reduce(function(e,i){if(i.target._vkGetNodeContentType()===_.Symbol&&i.target.parent){if(!t||t===i.target.userData.treeNode.sid){e.push(i.target)}}return e},[]):[];return i};var S={sphere:"360Image",plane:"2DImage"};C.prototype._getBackgroundNodeInfos=function(){var t=null,e=[];function i(e){if(e.visible){if(e._vkGetNodeContentType()===_.Background&&S[e.name]){t=e;return}var r=e.children;for(var n=0,a=r.length;n<a&&t===null;n++){i(r[n])}}}i(this._scene.getSceneRef());if(t){e=t.parent.children.filter(function(t){return t._vkGetNodeContentType()===_.Background})}return{current:t,all:e}};C.prototype.getBackgroundImageType=function(){var t=this._getBackgroundNodeInfos().current;return t?S[t.name]:null};C.prototype.setBackgroundImageType=function(t){var e=this._getBackgroundNodeInfos();var i=e.all.find(function(e){return t===S[e.name]});if(i&&!this.getVisibilityState(i)){if(e.current){e.current.visible=false}i.visible=true;this.setVisibilityState(e.all,false,false);this.setVisibilityState(i,true,false)}return i};function x(t){return(new i.Matrix4).set(t[0],t[1],t[2],t[3],t[4],t[5],t[6],t[7],t[8],t[9],t[10],t[11],0,0,0,1)}C.prototype._resetNodesStatusByCurrentView=function(t,e,r){var n=this.getNodeHierarchy();if(n){var a;if(t){a=t.getPlaybacks()}var o=t.getNodeInfos();if(o){this._nodesTransitionHelper.clear();var s={nodeRefs:[],positions:[]};var l=new i.Vector3;var u=new i.Quaternion;var c=new i.Vector3;o.forEach(function(t){if(t.target===null){return}if(t.transform){var e=x(t.transform);if(!g.equalMatrices(e,t.target.matrix,1e-6)){if((!a||!a.length)&&r){var i=n.createNodeProxy(t.target);this._nodesTransitionHelper.setNodeForDisplay(i,e)}else{e.decompose(l,u,c);s.nodeRefs.push(t.target);s.positions.push({translation:l.toArray(),quaternion:u.toArray(),scale:c.toArray()})}}}else if(t[y.Scale]&&t[y.Rotate]&&t[y.Translate]){s.nodeRefs.push(t.target);s.positions.push({translation:t[y.Translate].slice(),quaternion:t[y.Rotate].slice(),scale:t[y.Scale].slice()})}}.bind(this));if(t.userData&&t.userData.nodeStartDataByAnimation){t.userData.nodeStartDataByAnimation.forEach(function(t,e){if(t[y.Translate]&&t[y.Rotate]&&t[y.Scale]){s.nodeRefs.push(e);s.positions.push({translation:t[y.Translate].slice(),quaternion:t[y.Rotate].slice(),scale:t[y.Scale].slice()})}},this)}if(s.nodeRefs.length){this.setTransformation(s.nodeRefs,s.positions)}if(e){var h=[];var f=[];o.forEach(function(t){if(!t.target.userData.skipIt){(t.visible?h:f).push(t.target)}});this.setVisibilityState(n.getChildren()[0].children,false,true);if(this.getSymbolNodes().length){this.getSymbolNodes().forEach(function(t){t.traverse(function(t){t.visible=true})})}this.setVisibilityState(h,true,false);this.setVisibilityState(f,false,false);this._startViewChangeNodeTransition()}}}};C.prototype._startViewChangeNodeTransition=function(){this._nodesTransitionHelper.startDisplay(500);var t=true;this._nodesTransitionHelper.attachEventOnce("displayed",function(){t=false});var e=function(){if(t){this._nodesTransitionHelper.displayNodesMoving();window.requestAnimationFrame(e)}}.bind(this);window.requestAnimationFrame(e)};C.prototype._resetNodesMaterialAndOpacityByCurrentView=function(t){if(!t){return}var e=t.getNodeInfos();if(e){e.forEach(function(t){if(!t.target){return}this._updateMaterialInNode(t)}.bind(this));e.forEach(function(t){if(!t.target||!t.target.userData){return}t.target.userData.opacity=t.opacity});var i=this._scene.getSceneRef();i._vkSetOpacity(undefined,this._jointCollection)}this._selectedNodes.forEach(function(t){this._updateHighlightColor(t)}.bind(this))};C.prototype._onActivateView=function(t,e,i){var r=this.getViewManager();if(!r||i.source.getId()!==r){return}this.activateView(i.view,false,i.playViewGroup,i.notAnimateCameraChange)};C.prototype.activateView=function(e,i,r,n){this.fireViewStateApplying({view:e});this.setJoints(undefined);this._resetNodesMaterialAndOpacityByCurrentView(e);this._prepareTransition(e);this._resetNodesStatusByCurrentView(e,true,true);this._highlightPlayer.reset(e,this._scene);this.fireViewStateApplied({view:e,ignoreAnimationPosition:i,notAnimateCameraChange:n,playViewGroup:r});t.getEventBus().publish("sap.ui.vk","viewStateApplied",{source:this,view:e,ignoreAnimationPosition:i,notAnimateCameraChange:n,playViewGroup:r});return this};C.prototype.setHighlightDisplayState=function(t){if(t===d.playing){this._highlightPlayer.start(Date.now())}else if(t===d.stopped){this._highlightPlayer.stop()}else if(t===d.pausing){this._highlightPlayer.pause(Date.now())}this.fireHighlightColorChanged({highlightColor:n(a(this._highlightColorABGR)),highlightColorABGR:this._highlightColorABGR});return this};C.prototype._startHighlight=function(){this._highlightPlayer.start(Date.now());return this};C.prototype._playHighlight=function(){return this._highlightPlayer.play(Date.now())};C.prototype._prepareTransition=function(t){this._transitionPlayer.reset();this._transitionPlayer.fadeInNodes=[];this._transitionPlayer.fadeOutNodes=[];this._fadeInBackground=null;this._fadeOutBackground=null;var e=t.getNodeInfos();if(!e){return}var i=new Set;var r=new Set;e.forEach(function(t){(t.visible?i:r).add(t.target)});var n=this._transitionPlayer.fadeInNodes;var a=this._transitionPlayer.fadeOutNodes;var o=this._nodeHierarchy;var s=function(t,e,r){if(!t.userData.skipIt){e=e&&i.has(t);r=r&&t.visible}if(t.geometry&&e!==r){if(t.parent&&t.parent.userData.symbolContent){t.renderOrder=2}(e?n:a).push(t)}if(t._vkGetNodeContentType()===_.Background){if(e){this._fadeInBackground=t}else if(r){this._fadeOutBackground=t}}t.children.forEach(function(t){s(t,e,r)})}.bind(this);o.getChildren()[0].children.forEach(function(t){s(t,true,true)});if(this._fadeInBackground){this._fadeInBackground.traverse(function(t){if(t.material){t.renderOrder=-2}})}if(this._fadeOutBackground){this._fadeOutBackground.traverse(function(t){if(t.material){t.renderOrder=1}})}};C.prototype._startTransition=function(t){var e=this._transitionPlayer.fadeInNodes;var i=this._transitionPlayer.fadeOutNodes;if(e&&e.length){var r=new p("FadeIn",{duration:t/500,opacities:[0,1],cycles:1});this._transitionPlayer.addHighlights(r,e)}if(i&&i.length){var n=new p("FadeOut",{duration:t/500,opacities:[1,0],cycles:1,fadeOut:true});this._transitionPlayer.addHighlights(n,i)}if(e&&e.length||i&&i.length){this._transitionPlayer.start(Date.now());this._transitionPlayer.play(Date.now());return t}return 0};C.prototype._playTransition=function(){return this._transitionPlayer.play(Date.now())};C.prototype.updateNodesRestTransformation=function(t){for(var e=0;e<t.length;e++){this.updateRestTransformation(t[e],true);if(this._playbackAssociatedWithJoints&&e===t.length-1){var i=this._playbackAssociatedWithJoints.getSequence();if(i){i._fireSequenceChanged()}}}return this};C.prototype.updateRestTransformation=function(t,e){var i=this.getCurrentView();if(!i){return this}var r=i.getNodeInfos();if(r){r.forEach(function(e){if(e.target!==t){return}t.updateMatrix();var i=t.matrix.elements;var r=[i[0],i[4],i[8],i[12],i[1],i[5],i[9],i[13],i[2],i[6],i[10],i[14]];e.transform=r})}if(this._jointCollection&&this._jointCollection.length>0){this._jointCollection.forEach(function(e){if(!e.node||!e.parent){return}if(e.parent===t||e.node===t){e.translation=null;e.scale=null;e.quaternion=null;if(e.node.userData){e.node.userData.offsetTranslation=null;e.node.userData.offsetQuaternion=null;e.node.userData.offsetScale=null;e.node.userData.originalRotationType=null}}});this._jointCollection.forEach(function(e){if(!e.node||!e.parent){return}if(e.parent===t){this._updateJointNode(e,this._playbackAssociatedWithJoints);this.restoreRestTransformation(e.node)}}.bind(this));this._jointCollection.forEach(function(e){if(!e.node||!e.parent){return}if(e.node===t){this._updateJointNode(e,this._playbackAssociatedWithJoints)}},this);if(this._playbackAssociatedWithJoints&&!e){var n=this._playbackAssociatedWithJoints.getSequence();if(n){n._fireSequenceChanged()}}}return this};C.prototype.restoreRestTransformation=function(t){var e=this.getCurrentView();if(!e){return this}var i=e.getNodeInfos();if(i){i.forEach(function(e){if(e.target!==t){return}if(e.transform){var i=x(e.transform);i.decompose(t.position,t.quaternion,t.scale)}else if(e[y.Scale]&&e[y.Rotate]&&e[y.Translate]){t.position.set(e[y.Translate][0],e[y.Translate][1],e[y.Translate][2]);t.quaternion.set(e[y.Rotate][0],e[y.Rotate][1],e[y.Rotate][2],e[y.Rotate][3]);t.scale.set(e[y.Scale][0],e[y.Scale][1],e[y.Scale][2])}t.updateMatrix()})}var r={changed:[t],transformation:[{position:t.position.toArray(),quaternion:t.quaternion.toArray(),scale:t.scale.toArray()}]};this.fireTransformationChanged(r);return this};C.prototype.setRestTransformation=function(t,e,r,n){var a=this.getCurrentView();if(!a){return this}var o=a.getNodeInfos();if(o){o.forEach(function(a){if(a.target!==t){return}if(!e||!r||!n){if(a.transform){var o=new i.Vector3;var s=new i.Quaternion;var l=new i.Vector3;var u=x(a.transform);u.decompose(o,s,l);if(!e){e=[o.x,o.y,o.z]}if(!n){n=[l.x,l.y,l.z]}if(!r){r=[s.x,s.y,s.z,s.w]}}else if(a[y.Scale]&&a[y.Rotate]&&a[y.Translate]){if(!e){e=a[y.Translate].slice()}if(!n){n=a[y.Scale].slice()}if(!r){r=a[y.Rotate].slice()}}}var c=new i.Vector3(e[0],e[1],e[2]);var h=new i.Quaternion(r[0],r[1],r[2],r[3]);var f=new i.Vector3(n[0],n[1],n[2]);var d=new i.Matrix4;d.compose(c,h,f);var p=d.elements;a.transform=[p[0],p[4],p[8],p[12],p[1],p[5],p[9],p[13],p[2],p[6],p[10],p[14]]})}if(this._jointCollection&&this._jointCollection.length>0){this._jointCollection.forEach(function(e){if(!e.node||!e.parent){return}if(e.parent===t||e.node===t){e.translation=null;e.scale=null;e.quaternion=null;if(e.node.userData){e.node.userData.offsetTranslation=null;e.node.userData.offsetQuaternion=null;e.node.userData.offsetScale=null;e.node.userData.originalRotationType=null}}});this._jointCollection.forEach(function(e){if(!e.node||!e.parent){return}if(e.parent===t){this._updateJointNode(e,this._playbackAssociatedWithJoints);this.restoreRestTransformation(e.node)}},this);this._jointCollection.forEach(function(e){if(!e.node||!e.parent){return}if(e.node===t){this._updateJointNode(e,this._playbackAssociatedWithJoints)}},this);if(this._playbackAssociatedWithJoints){var s=this._playbackAssociatedWithJoints.getSequence();if(s){s._fireSequenceChanged()}}}return this};C.prototype.getRestOpacity=function(t){var e;var i=this.getCurrentView();if(i){e=i.getNodeInfos()}var r=1;if(e&&e.length){for(var n=0;n<e.length;n++){var a=e[n];if(a.target!==t){continue}if(a.opacity!==undefined&&a.opacity!==null){r=a.opacity}break}}return r};C.prototype.setRestOpacity=function(t,e){var i;var r=this.getCurrentView();if(r){i=r.getNodeInfos()}if(i){i.forEach(function(i){if(i.target!==t){return}i.opacity=e})}return this};C.prototype.restoreRestOpacity=function(t){var e;var i=this.getCurrentView();if(i){e=i.getNodeInfos()}if(e){e.forEach(function(e){if(e.target!==t){return}var i=1;if(e.opacity!==undefined){i=e.opacity}this.setOpacity(t,i)}.bind(this))}if(this._jointCollection&&this._jointCollection.length>0){this._jointCollection.forEach(function(e){if(!e.node||!e.parent){return}if(e.parent===t||e.node===t){e.opacity=null;if(e.node.userData){e.node.userData.offsetOpacity=null}}});this._jointCollection.forEach(function(e){if(!e.node||!e.parent){return}if(e.parent===t){this._updateJointNode(e,this._playbackAssociatedWithJoints);this.restoreRestOpacity(e.node)}},this);this._jointCollection.forEach(function(e){if(!e.node||!e.parent){return}if(e.node===t){this._updateJointNode(e,this._playbackAssociatedWithJoints)}},this);if(this._playbackAssociatedWithJoints){var r=this._playbackAssociatedWithJoints.getSequence();if(r){r._fireSequenceChanged()}}}return this};C.prototype.updateRestOpacity=function(t){var e;var i=this.getCurrentView();if(i){e=i.getNodeInfos()}if(e){e.forEach(function(e){if(e.target!==t){return}if(t.userData&&t.userData.opacity!==undefined&&t.userData.opacity!==null){e.opacity=t.userData.opacity}else{delete e.opacity}})}if(this._jointCollection&&this._jointCollection.length>0){this._jointCollection.forEach(function(e){if(!e.node||!e.parent){return}if(e.parent===t||e.node===t){e.opacity=null;if(e.node.userData){e.node.userData.offsetOpacity=null}}});this._jointCollection.forEach(function(e){if(!e.node||!e.parent){return}if(e.node===t){this._updateJointNode(e,this._playbackAssociatedWithJoints)}},this);if(this._playbackAssociatedWithJoints){var r=this._playbackAssociatedWithJoints.getSequence();if(r){r._fireSequenceChanged()}}}return this};C.prototype.getRestTransformationWorld=function(t){var e;var r=this.getCurrentView();if(r){e=r.getNodeInfos()}var n;if(e){var a=new i.Matrix4;while(t){for(var o=0;o<e.length;o++){var s=e[o];if(s.target!==t){continue}var l;if(s.transform){l=x(s.transform)}else if(s[y.Scale]&&s[y.Rotate]&&s[y.Translate]){var u=new i.Vector3(s[y.Translate][0],s[y.Translate][1],s[y.Translate][2]);var c=new i.Quaternion(s[y.Rotate][0],s[y.Rotate][1],s[y.Rotate][2],s[y.Rotate][3]);var h=new i.Vector3(s[y.Scale][0],s[y.Scale][1],s[y.Scale][2]);l=(new i.Matrix4).compose(u,c,h)}if(l){a.premultiply(l)}break}t=t.parent}var f=new i.Vector3;var d=new i.Quaternion;var p=new i.Vector3;a.decompose(f,d,p);n={};n.translation=f.toArray();n.quaternion=d.toArray();n.scale=p.toArray()}if(!n){n=this.getTransformationWorld(t)}return n};C.prototype.getRestTransformation=function(t){var e;var r=this.getCurrentView();if(r){e=r.getNodeInfos()}var n;if(e){e.forEach(function(e){if(e.target!==t){return}if(e.transform){var r=new i.Vector3;var a=new i.Quaternion;var o=new i.Vector3;var s=x(e.transform);s.decompose(r,a,o);n={};n.translation=r.toArray();n.quaternion=a.toArray();n.scale=o.toArray()}else if(e[y.Scale]&&e[y.Rotate]&&e[y.Translate]){n={};n.translation=e[y.Translate].slice();n.quaternion=e[y.Rotate].slice();n.scale=e[y.Scale].slice()}})}if(!n&&t){n={};n.translation=t.userData.position?t.userData.position.toArray():t.position.toArray();n.quaternion=t.userData.quaternion?t.userData.quaternion.toArray():t.quaternion.toArray();n.scale=t.userData.scale?t.userData.scale.toArray():t.scale.toArray();n.matrix=t.matrix.clone()}return n};C.prototype._addToTransformation=function(t,e,r,n,a,o){var s={};var l;if(e){s.translation=[];for(l=0;l<3;l++){s.translation.push(e[l]+t.translation[l])}}else{s.translation=t.translation}if(n){s.scale=[];for(l=0;l<3;l++){s.scale.push(n[l]*t.scale[l])}}else{s.scale=t.scale}if(r){var c=new i.Quaternion(t.quaternion[0],t.quaternion[1],t.quaternion[2],t.quaternion[3]);var h=new i.Quaternion(r[0],r[1],r[2],r[3]);if(a===u.Euler){var f=o?o[3]:6;var d=g.threeQuatToNeutralEuler(c,f);var p=o?o:g.threeQuatToNeutralEuler(h,f);d[0]+=p[0];d[1]+=p[1];d[2]+=p[2];s.quaternion=g.glMatrixQuatToNeutral(g.neutralEulerToGlMatrixQuat(d))}else{var y=(new i.Matrix4).makeRotationFromQuaternion(c);var v=(new i.Matrix4).makeRotationFromQuaternion(h);y.premultiply(v);c.setFromRotationMatrix(y);s.quaternion=[c.x,c.y,c.z,c.w]}}else{s.quaternion=t.quaternion}return s};C.prototype.setInterpolatedRelativeValues=function(t,e){if(!t.userData){t.userData={}}if(e.rtranslate){t.userData.offsetTranslation=e.rtranslate}else{t.userData.offsetTranslation=null}if(e.rscale){t.userData.offsetScale=e.rscale}else{t.userData.offsetScale=null}if(e.rrotate){t.userData.offsetQuaternion=e.rrotate;t.userData.originalRotationType=e.originalRotationType}else{t.userData.offsetQuaternion=null;t.userData.originalRotationType=null}if(e.Euler){t.userData.Euler=e.Euler}else{t.userData.Euler=null}if(e.ropacity!=null){t.userData.offsetOpacity=e.ropacity}else{t.userData.offsetOpacity=null}return this};C.prototype._setJointNodeMatrix=function(){if(this._jointCollection&&this._jointCollection.length>0){this._jointCollection.forEach(function(t){if(!t.node||!t.parent){return}var e=t.node;if(e.userData.skipUpdateJointNode){return}var r={};r.translation=t.translation.slice();r.scale=t.scale.slice();r.quaternion=t.quaternion.slice();var n=this._addToTransformation(r,e.userData.offsetTranslation,e.userData.offsetQuaternion,e.userData.offsetScale,e.userData.originalRotationType,e.userData.Euler);e.position.fromArray(n.translation);e.scale.fromArray(n.scale);e.quaternion.fromArray(n.quaternion);e.updateMatrix();var a=e.quaternion.clone();var o=new i.Matrix4;if(t.parent){t.parent.updateMatrixWorld();o=t.parent.matrixWorld.clone();e.matrixWorld.multiplyMatrices(t.parent.matrixWorld,e.matrix)}else{e.matrixWorld.copy(e.matrix)}var s=new i.Matrix4;if(e.parent){e.parent.updateWorldMatrix(true,false);s.copy(e.parent.matrixWorld);e.matrix.getInverse(e.parent.matrixWorld).multiply(e.matrixWorld)}else{e.matrix.copy(e.matrixWorld)}e.matrix.decompose(e.position,e.quaternion,e.scale);var l=[e.scale.x,e.scale.y,e.scale.z];this._adjustQuaternionAndScale(o,s,a,e.quaternion,n.scale,l);e.scale.x=l[0];e.scale.y=l[1];e.scale.z=l[2];if(t.nodesToUpdate){t.nodesToUpdate.forEach(function(t){if(t.matrixAutoUpdate){t.updateMatrix()}t.matrixWorld.multiplyMatrices(t.parent.matrixWorld,t.matrix)})}}.bind(this))}};C.prototype._getEndPropertyInLastPlayback=function(t,e){var i;var r=this.getCurrentView();if(!r){return i}var n=r.getPlaybacks();if(!n||!n.length){return i}for(var a=n.length-1;a>=0;a--){var o=n[a];var s=o.getSequence();if(s._convertedFromAbsolute){return i}i=o.getNodeBoundaryProperty(t,e,true);if(i){break}}return i};C.prototype._getEndPropertyInPreviousPlayback=function(t,e,i,r){var n;var a=this._getJointByChildNode(t);if(a&&!r){return n}var o=i.getSequence();if(o&&o._convertedFromAbsolute){return n}var s=this.getCurrentView();if(!s){return n}var l=s.getPlaybacks();for(var u=1;u<l.length;u++){var c=l[u];if(c!==i){continue}for(var h=u-1;h>=0;h--){var f=l[h];n=f.getNodeBoundaryProperty(t,e,true);if(n){break}}}return n};C.prototype._convertTracksToRelative=function(t,e){if(e&&t._conversionDoneForReversed||!e&&t._conversionDone){return this}t._convertedFromAbsolute=false;var r=this.getCurrentView();if(!r){return this}var n=t.getNodeAnimation();if(!n||!n.length){return this}var a=r.getNodeInfos();if(a){a.forEach(function(e){var r;for(var a=0;a<n.length;a++){if(e.target===n[a].nodeRef){r=n[a];break}}if(!r){return}var o=[0,0,0];var s=[1,1,1];var l=new i.Quaternion;var u=new i.Vector3;var c=new i.Vector3;if(e.transform){var h=x(e.transform);h.decompose(u,l,c);o=u.toArray();s=c.toArray()}else if(e[y.Scale]&&e[y.Rotate]&&e[y.Translate]){o=e[y.Translate].slice();l=new i.Quaternion(e[y.Rotate][0],e[y.Rotate][1],e[y.Rotate][2],e[y.Rotate][3]);s=e[y.Scale].slice()}else{e.target.matrix.decompose(u,l,c);o=u.toArray();s=c.toArray()}var f,d,p,_;var m=r[y.Translate];if(m&&m.getIsAbsoluteValue()){d=m.getKeysCount();for(f=0;f<d;f++){p=m.getKey(f);_=[p.value[0]-o[0],p.value[1]-o[1],p.value[2]-o[2]];m.updateKey(f,_,true)}m.setIsAbsoluteValue(false);t._convertedFromAbsolute=true}var A=r[y.Scale];if(A&&A.getIsAbsoluteValue()){d=A.getKeysCount();for(f=0;f<d;f++){p=A.getKey(f);_=[p.value[0]/s[0],p.value[1]/s[1],p.value[2]/s[2]];A.updateKey(f,_,true)}A.setIsAbsoluteValue(false);t._convertedFromAbsolute=true}var w=r[y.Opacity];if(w&&w.getIsAbsoluteValue()){var C=this.getRestOpacity(e.target);if(!C){C=1}d=w.getKeysCount();for(f=0;f<d;f++){p=w.getKey(f);_=p.value/C;w.updateKey(f,_,true)}w.setIsAbsoluteValue(false);t._convertedFromAbsolute=true}var b=r[y.Rotate];if(b&&b.getIsAbsoluteValue()){var S;var T=(new i.Matrix4).makeRotationFromQuaternion(l);var R=(new i.Matrix4).getInverse(T);var N=new i.Matrix4;var k=new i.Matrix4;d=b.getKeysCount();var V=b.getKeysType();for(f=0;f<d;f++){p=b.getKey(f);if(V===v.Quaternion){S=new i.Quaternion(p.value[0],p.value[1],p.value[2],p.value[3]);N.makeRotationFromQuaternion(S);k.multiplyMatrices(N,R);S.setFromRotationMatrix(k);_=S.toArray();b.updateKey(f,_,true)}else if(V===v.Euler){var B=p.value;var D=g.threeQuatToNeutralEuler(l,B[3]);_=[B[0]-D[0]+g.getModulatedAngularValue(B[0]),B[1]-D[1]+g.getModulatedAngularValue(B[1]),B[2]-D[2]+g.getModulatedAngularValue(B[2]),B[3]];b.updateKey(f,_,true)}else if(f===0){var E=new i.Vector3(p.value[0],p.value[1],p.value[2]);N.makeRotationAxis(E,p.value[3]);k.multiplyMatrices(N,R);S=(new i.Quaternion).setFromRotationMatrix(k);_=this._convertQuaternionToAngleAxis(S);b.updateKey(f,_,true);break}}b.setIsAbsoluteValue(false);t._convertedFromAbsolute=true}}.bind(this))}if(!e){t._conversionDone=true;t._conversionDoneForReversed=false}else{t._conversionDone=false;t._conversionDoneForReversed=true}return this};C.prototype._getTrackKeys=function(t){var e=[];var i=t.getKeysCount();for(var r=0;r<i;r++){var n=t.getKey(r);var a;if(Array.isArray(n.value)){a=n.value.slice()}else{a=n.value}e.push({time:n.time,value:a})}return e};C.prototype._setJointNodeOffsets=function(t,e){var r=this._getJointByChildNode(t);if(r){var n=new i.Matrix4;if(t.parent){n=t.parent.matrixWorld.clone()}var a=new i.Matrix4;t.updateMatrixWorld();var o=new i.Matrix4;if(r.parent){r.parent.updateMatrixWorld();o=r.parent.matrixWorld.clone();a.getInverse(r.parent.matrixWorld).multiply(t.matrixWorld)}else{a.copy(t.matrixWorld)}var s=new i.Vector3;var l=new i.Vector3;var u=new i.Quaternion;a.decompose(s,u,l);if(e===y.Translate){var c=s.toArray();t.userData.offsetTranslation=[c[0]-r.translation[0],c[1]-r.translation[1],c[2]-r.translation[2]]}else if(e===y.Scale){var h=l.toArray();this._adjustQuaternionAndScale(n,o,t.quaternion,u,t.scale.toArray(),h);t.userData.offsetScale=[h[0]/r.scale[0],h[1]/r.scale[1],h[2]/r.scale[2]]}else{this._adjustQuaternionAndScale(n,o,t.quaternion,u,t.scale.toArray(),l.toArray());var f=new i.Quaternion(r.quaternion[0],r.quaternion[1],r.quaternion[2],r.quaternion[3]);var d=(new i.Matrix4).makeRotationFromQuaternion(f);var p=(new i.Matrix4).getInverse(d);var v=(new i.Matrix4).makeRotationFromQuaternion(u);var g=(new i.Matrix4).multiplyMatrices(v,p);var _=(new i.Quaternion).setFromRotationMatrix(g);t.userData.offsetQuaternion=_.toArray()}}return this};C.prototype.setTranslationKey=function(t,e,r,n){var a=r.getSequence();if(!a){return null}var o;var s=new i.Vector3;t.matrix.decompose(s,new i.Quaternion,new i.Vector3);var l=this._getJointByChildNode(t);if(l){o=l.translation.slice();t.updateMatrixWorld();var u=new i.Matrix4;if(l.parent){l.parent.updateMatrixWorld();u.getInverse(l.parent.matrixWorld).multiply(t.matrixWorld)}else{u.matrix.copy(t.matrixWorld)}u.decompose(s,new i.Quaternion,new i.Vector3)}else{var c=this.getRestTransformation(t);o=c.translation}var h=s.toArray();var f=[h[0]-o[0],h[1]-o[1],h[2]-o[2]];var d=this._getEndPropertyInPreviousPlayback(t,y.Translate,r);if(d){f[0]-=d[0];f[1]-=d[1];f[2]-=d[2]}var p=a.getNodeAnimation(t,y.Translate);var g;if(!p){p=this._scene.createTrack(null,{trackValueType:v.Vector3,isAbsoluteValue:false});a.setNodeAnimation(t,y.Translate,p,true)}else{g=this._getTrackKeys(p)}p.insertKey(e,f,n);var _=this._getTrackKeys(p);return{KeyValue:f,absoluteValue:h,offset:d,PreviousTrack:g,CurrentTrack:_}};C.prototype._adjustQuaternionAndScale=function(t,e,r,n,a,o){function s(t,e,i,r){var n=Math.abs(t.dot(e));var a=Math.abs(t.dot(i));var o=Math.abs(t.dot(r));if(n>=a&&n>=o){return 0}else if(a>=n&&a>=o){return 1}else{return 2}}if(a[0]>0&&a[1]>0&&a[2]>0){return}var l=t.clone().multiply((new i.Matrix4).makeRotationFromQuaternion(r));var u=(new i.Matrix4).makeRotationFromQuaternion(n);var c=e.clone().multiply(u);var h=new i.Vector3;var f=new i.Vector3;var d=new i.Vector3;l.extractBasis(h,f,d);var p=[h,f,d];var y=new i.Vector3;var v=new i.Vector3;var g=new i.Vector3;c.extractBasis(y,v,g);var _=[1,1,1];for(var m=0;m<3;m++){var A=s(p[m],y,v,g);if(a[m]*o[A]<0){_[A]=-1;o[A]=-o[A]}}u.scale(new i.Vector3(_[0],_[1],_[2]));var w=(new i.Quaternion).setFromRotationMatrix(u);n.x=w.x;n.y=w.y;n.z=w.z;n.w=w.w};C.prototype.setScaleKey=function(t,e,r,n){var a=r.getSequence();if(!a){return null}var o;var s=t.scale.toArray();var l=t.quaternion.clone();var u=this._getJointByChildNode(t);if(u){var c=new i.Matrix4;if(t.parent){c=t.parent.matrixWorld.clone()}o=u.scale.slice();t.updateMatrixWorld();var h=new i.Matrix4;var f=new i.Matrix4;if(u.parent){u.parent.updateMatrixWorld();f=u.parent.matrixWorld.clone();h.getInverse(u.parent.matrixWorld).multiply(t.matrixWorld)}else{h.copy(t.matrixWorld)}var d=new i.Quaternion;var p=new i.Vector3;h.decompose(new i.Vector3,d,p);var g=p.toArray();this._adjustQuaternionAndScale(c,f,l,d,s,g);s=g}else{var _=this.getRestTransformation(t);o=_.scale}var m=[s[0]/o[0],s[1]/o[1],s[2]/o[2]];var A=this._getEndPropertyInPreviousPlayback(t,y.Scale,r);if(A){m[0]/=A[0];m[1]/=A[1];m[2]/=A[2]}var w=a.getNodeAnimation(t,y.Scale);var C;if(!w){w=this._scene.createTrack(null,{trackValueType:v.Vector3,isAbsoluteValue:false});a.setNodeAnimation(t,y.Scale,w,true)}else{C=this._getTrackKeys(w)}w.insertKey(e,m,n);var b=this._getTrackKeys(w);return{KeyValue:m,absoluteValue:s,offset:A,PreviousTrack:C,CurrentTrack:b}};C.prototype.setRotationKey=function(t,e,r,n,a){var o=n.getSequence();if(!o){return null}var s=36;var l=[r[0],r[1],r[2],s];var u=o.getNodeAnimation(t,y.Rotate);if(u&&u.getKeysType()!==v.Euler){return null}var c;if(!u){u=this._scene.createTrack(null,{trackValueType:v.Euler,isAbsoluteValue:false});o.setNodeAnimation(t,y.Rotate,u,true)}else{c=this._getTrackKeys(u)}u.insertKey(e,l,a);var h=this._getTrackKeys(u);var f=new i.Quaternion;var d=new i.Euler(r[0],r[1],r[2]);f.setFromEuler(d);var p=this._getEndPropertyInPreviousPlayback(t,y.Rotate,n);if(p){var g=new i.Quaternion(p[0],p[1],p[2],p[3]);f.multiply(g)}var _=this._getJointByChildNode(t);var m=new i.Quaternion;if(_){m.fromArray(_.quaternion)}else{var A=this.getRestTransformation(t);m.fromArray(A.quaternion)}f.multiply(m);return{KeyValue:l,absoluteValue:f.toArray(),offset:p,PreviousTrack:c,CurrentTrack:h}};C.prototype.setAxisAngleRotationKey=function(t,e,i,r,n){var a=r.getSequence();if(!a){return null}var o=a.getNodeAnimation(t,y.Rotate);if(o&&o.getKeysType()!==v.AngleAxis){if(!o.setKeysType(v.AngleAxis)){return null}}var s=[i[0],i[1],i[2],i[3]];var l;if(!o){o=this._scene.createTrack(null,{trackValueType:v.AngleAxis,isAbsoluteValue:false});a.setNodeAnimation(t,y.Rotate,o,true)}else{l=this._getTrackKeys(o)}o.insertKey(e,s,n);var u=this._getTrackKeys(o);return{KeyValue:s,PreviousTrack:l,CurrentTrack:u}};C.prototype.getTotalOpacity=function(t){return t._vkGetTotalOpacity(this._jointCollection)};C.prototype.setTotalOpacity=function(t,e){var i=1;var r=this._getJointByChildNode(t);if(r&&r.parent){i=r.parent._vkGetTotalOpacity(this._jointCollection)}else if(t.parent){i=t.parent._vkGetTotalOpacity(this._jointCollection)}if(!t.userData){t.userData={}}var n=this.getOpacity(t);if(i!==0){n=e/i}else{e=0}t._vkSetOpacity(n,this._jointCollection);var a={changed:t,opacity:n};this.fireOpacityChanged(a);return{opacity:n,totalOpacity:e}};C.prototype.setOpacityKey=function(t,e,i,r){var n=i.getSequence();if(!n){return null}var a=1;if(t.userData&&t.userData.opacity!==undefined&&t.userData.opacity!==null){a=t.userData.opacity}var o=this.getRestOpacity(t);if(!o&&n._convertedFromAbsolute){o=1}a/=o;var s=this._getEndPropertyInPreviousPlayback(t,y.Opacity,i);if(s){a/=s}var l=n.getNodeAnimation(t,y.Opacity);var u;if(!l){l=this._scene.createTrack(null,{trackValueType:v.Opacity});n.setNodeAnimation(t,y.Opacity,l,true)}else{u=this._getTrackKeys(l)}l.insertKey(e,a,r);var c=this._getTrackKeys(l);return{KeyValue:a,totalOpacity:this.getTotalOpacity(t),PreviousTrack:u,CurrentTrack:c}};w=function(){this._visibilityChanges=new Set};w.prototype.getInfo=function(t){var e=[];this._visibilityChanges.forEach(function(i){var r=t.createNodeProxy(i);var n=r.getVeId();t.destroyNodeProxy(r);if(n){e.push(n)}else{e.push(t.getScene().nodeRefToPersistentId(i))}});return e};w.prototype.clear=function(){this._visibilityChanges.clear()};w.prototype.trackNodeRef=function(t){if(this._visibilityChanges.has(t)){this._visibilityChanges.delete(t)}else{this._visibilityChanges.add(t)}};return C});
//# sourceMappingURL=ViewStateManager.js.map