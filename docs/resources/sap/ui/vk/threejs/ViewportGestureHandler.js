/*!
* SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
*/
sap.ui.define(["sap/base/Log","sap/ui/base/EventProvider","./PerspectiveCamera","./OrthographicCamera","../thirdparty/three","../getResourceBundle","../NodeContentType"],function(e,t,a,i,r,o,n){"use strict";var s=t.extend("sap.ui.vk.threejs.ViewportGestureHandler",{metadata:{library:"sap.ui.vk"},constructor:function(t){this._matProj=null;this._viewport=t;this._rect=null;this._evt={x:0,y:0,z:0,d:0,initd:0};this._gesture=false;this._viewport.attachEvent("resize",this,this._onresize);this._nomenu=false;var a=function(t){var a=t;var i=new THREE.Vector3;var r=new THREE.Vector2;var s=.001;var h=-Math.PI/2+s;var m=Math.PI/2-s;this.isTurnTableMode=true;this._timeIntervalForCameraAnimation=500;this._startTimeForCameraAnimation=0;this._newCamera=null;this._oldCamera=null;this._animationType=null;this._zoomedNodeRef=null;this._isZoomIn=true;this.beginGesture=function(e,t){var o=a.getScene();if(o==null){return}var n=o.getSceneRef();var s=a.getCamera().getCameraRef();var h=a.getRenderer().getSize(new THREE.Vector2);r.x=e/h.width*2-1;r.y=t/h.height*-2+1;a._gesturePoint={x:e,y:t};var m=s.userData.isRedlineActivated?null:a.hitTest(e,t,n,s);if(m){i.copy(m.point)}else{var l=new THREE.Box3;n._expandBoundingBox(l,true,true);if(!l.isEmpty()){l.getCenter(i)}else{i.setScalar(0)}}};this.endGesture=function(){};this.pan=function(e,t){if(a.getFreezeCamera()||a.getCamera()===null||e===0&&t===0){return}if(a._redlineHandler){a._redlineHandler.pan(e,t)}else if(a._isPanoramicActivated()){this.rotate(e,t);return}var r=a.getCamera().getCameraRef();var o=a.getRenderer().getSize(new THREE.Vector2);if(r.view&&r.view.enabled){r.view.offsetX-=e*r.view.width/r.view.fullWidth;r.view.offsetY-=t*r.view.height/r.view.fullHeight;r.updateProjectionMatrix()}else{var n=i.clone().project(r);n.x-=e*2/o.width;n.y+=t*2/o.height;n.unproject(r).sub(i);r.position.add(n);r.updateMatrixWorld()}a.fireCameraChanged({position:r.position.toArray()})};var l=[new THREE.Vector3(+1,0,0),new THREE.Vector3(-1,0,0),new THREE.Vector3(0,+1,0),new THREE.Vector3(0,-1,0),new THREE.Vector3(0,0,+1),new THREE.Vector3(0,0,-1)];this.rotate=function(e,t,r){if(a.getFreezeCamera()||a.getCamera()===null||e===0&&t===0){return}if(a._redlineHandler||a._isPlanarActivated()){this.pan(e,t);return}if(r!==undefined){this.isTurnTableMode=r}var o=a.getCamera().getCameraRef();var n=-.01;if(a._isPanoramicActivated()){var s=a.getRenderer().getSize(new THREE.Vector2);n=2/(s.x*o.projectionMatrix.elements[0]);i.copy(o.position)}var d=e*n,v=t*n;var p=o.position.clone().sub(i);var c=new THREE.Vector3,_=(new THREE.Vector3).setFromMatrixColumn(o.matrixWorld,1).normalize(),u=(new THREE.Vector3).setFromMatrixColumn(o.matrixWorld,0).normalize();o.getWorldDirection(c);c.normalize();var f=new THREE.Quaternion,C=new THREE.Quaternion;if(this.isTurnTableMode){var g=l[a._upAxis]||l[2];u.crossVectors(c,g).normalize();_.crossVectors(u,c);var w=Math.atan2(c.y,Math.sqrt(c.x*c.x+c.z*c.z));f.setFromAxisAngle(g,d);C.setFromAxisAngle(u,THREE.Math.clamp(v,h-w,m-w))}else{f.setFromAxisAngle(_,d);C.setFromAxisAngle(u,v)}f.multiply(C);p.applyQuaternion(f);c.applyQuaternion(f);_.applyQuaternion(f);p.add(i);if(!o.userData.rotate){o.position.copy(p)}o.up.copy(_);o.lookAt(p.add(c));o.updateMatrixWorld();a.fireCameraChanged({position:o.position.toArray(),quaternion:o.quaternion.toArray()})};this.zoom=function(t){if(t===0||t===1||a.getFreezeCamera()||a.getCamera()===null||a.getScene()===null){return}var n=a.getCamera().getCameraRef();var s=new THREE.Vector3;if(!n.userData.isRedlineActivated){var h=100;var m=new THREE.Box3;var l=new THREE.Vector3;var d=!a.getBackgroundProjection();a.getScene().getSceneRef()._expandBoundingBox(m,true,d);m.applyMatrix4(n.matrixWorldInverse);m.min.z=Math.max(m.min.z,n.near);m.max.z=Math.max(m.max.z,n.near);m.applyMatrix4(n.projectionMatrix);m.getSize(l);var v=a.getRenderer().getSize(new THREE.Vector2);var p=l.x*v.width*.5;var c=l.y*v.height*.5;if(p<h&&c<h&&t<1){return}}var _=a._redlineHandler;if(_){t=Math.min(Math.max(_._zoomFactor*t,1/8),32)/_._zoomFactor;_._zoomFactor*=t;_.zoom(t)}if(n.view&&n.view.enabled){var u=a.getDomRef();var f=a._gesturePoint.x/u.clientWidth;var C=a._gesturePoint.y/u.clientHeight;var g=1/t;n.view.offsetX+=f*n.view.width;n.view.offsetY+=C*n.view.height;n.view.width*=g;n.view.height*=g;n.view.offsetX-=f*n.view.width;n.view.offsetY-=C*n.view.height}else if(n.isPerspectiveCamera){if(a._isPanoramicActivated()){n.fov=Math.min(Math.max(5,n.fov/Math.pow(t,.5)),90)}else{s.set(r.x,r.y,1).unproject(n);s.sub(new THREE.Vector3(r.x,r.y,-1).unproject(n));var w=i.clone().sub(n.position).length()*(1-1/t);s.setLength(w);n.position.add(s)}}else if(n.isOrthographicCamera){s.set(r.x,r.y,1).unproject(n);s.sub(new THREE.Vector3(0,0,1).unproject(n));s.multiplyScalar(1-1/t);n.zoom*=t;n.position.add(s)}else{e.error(o().getText("VIEWPORTGESTUREHANDLER_MSG_UNSUPPORTEDCAMERATYPE"))}n.updateProjectionMatrix();n.updateMatrixWorld();var E={position:n.position.toArray()};if(n.isOrthographicCamera){E.zoom=n.zoom}a.fireCameraChanged(E)};this.animateCameraUpdate=function(){if(this._newCamera===null||this._oldCamera===null){return}if(a.getCamera()==null){this._newCamera=null;this._oldCamera=null;return}function e(e,t,a){a=THREE.Math.clamp((a-e)/(t-e),0,1);return a*a*a*(a*(a*6-15)+10)}var t=Math.min((Date.now()-this._startTimeForCameraAnimation)/this._timeIntervalForCameraAnimation,1);t=e(0,1,t);var i=a.getCamera().getCameraRef();if(i.view&&i.view.enabled){var r=i.view.width;var o=i.view.height;var n=i.view.offsetX+i.view.width*.5;var s=i.view.offsetY+i.view.height*.5;i.view.offsetX=THREE.Math.lerp(this._oldCamera.view.offsetX,this._newCamera.view.offsetX,t);i.view.offsetY=THREE.Math.lerp(this._oldCamera.view.offsetY,this._newCamera.view.offsetY,t);i.view.width=THREE.Math.lerp(this._oldCamera.view.width,this._newCamera.view.width,t);i.view.height=THREE.Math.lerp(this._oldCamera.view.height,this._newCamera.view.height,t);var h=i.view.offsetX+i.view.width*.5;var m=i.view.offsetY+i.view.height*.5;var l=a._redlineHandler;if(l){var d=r/i.view.width;var v=(n-h)*i.view.fullWidth/r;var p=(s-m)*i.view.fullHeight/o;l._zoomFactor*=d;l.pan(v,p);l.zoom(d,i.view.fullWidth*.5,i.view.fullHeight*.5)}}if(i.isOrthographicCamera&&this._newCamera.isOrthographicCamera&&this._oldCamera.isOrthographicCamera){i.left=THREE.Math.lerp(this._oldCamera.left,this._newCamera.left,t);i.right=THREE.Math.lerp(this._oldCamera.right,this._newCamera.right,t);i.top=THREE.Math.lerp(this._oldCamera.top,this._newCamera.top,t);i.bottom=THREE.Math.lerp(this._oldCamera.bottom,this._newCamera.bottom,t);if(this._transitionEffect==="zoomIn"){var c=Math.max(this._oldCamera.zoom,this._newCamera.zoom)*5;i.zoom=t<.5?THREE.Math.lerp(this._oldCamera.zoom,c,t*2):THREE.Math.lerp(c,this._newCamera.zoom,(t-.5)*2)}else{i.zoom=THREE.Math.lerp(this._oldCamera.zoom,this._newCamera.zoom,t)}}if(i.isPerspectiveCamera&&this._newCamera.isPerspectiveCamera&&this._oldCamera.isPerspectiveCamera){if(this._transitionEffect==="zoomIn"){var _=Math.min(this._oldCamera.fov,this._newCamera.fov)*.1;i.fov=t<.5?THREE.Math.lerp(this._oldCamera.fov,_,t*2):THREE.Math.lerp(_,this._newCamera.fov,(t-.5)*2)}else{i.fov=THREE.Math.lerp(this._oldCamera.fov,this._newCamera.fov,t)}}i.far=THREE.Math.lerp(this._oldCamera.far,this._newCamera.far,t);i.near=THREE.Math.lerp(this._oldCamera.near,this._newCamera.near,t);i.updateProjectionMatrix();i.position.lerpVectors(this._oldCamera.position,this._newCamera.position,t);i.scale.lerpVectors(this._oldCamera.scale,this._newCamera.scale,t);i.up.lerpVectors(this._oldCamera.up,this._newCamera.up,t);var u=this._oldCamera.getWorldDirection(new THREE.Vector3);var f=this._newCamera.getWorldDirection(new THREE.Vector3);var C=(new THREE.Vector3).lerpVectors(u,f,t);i.lookAt(C.add(i.position));if(t===1){this._newCamera=null;this._oldCamera=null;if(this._animationType==="zooming"&&this._zoomedNodeRef){a.fireNodeZoomed({zoomed:this._zoomedNodeRef,isZoomIn:this._isZoomIn})}a.cameraUpdateCompleted({position:i.position.toArray(),quaternion:i.quaternion.toArray()})}a.fireCameraChanged({position:i.position.toArray(),quaternion:i.quaternion.toArray()})};this.startCameraAnimation=function(e,t){this._startTimeForCameraAnimation=Date.now();this._timeIntervalForCameraAnimation=e!==undefined?e:500;this._transitionEffect=t};this.lookAtObject=function(e,t){if(e._vkGetNodeContentType()!==n.Background){this.prepareForCameraUpdateAnimation();var i=a.getCamera().getCameraRef();this._newCamera=i.clone();this._newCamera.lookAt(e.getWorldPosition(new THREE.Vector3));this._newCamera.up.set(0,1,0);this._newCamera.updateMatrixWorld();this.startCameraAnimation(t)}};this.zoomObject=function(e,t,i){if(a.getScene()==null){return}var r=new THREE.Box3;(t&&e?e:a.getScene().getSceneRef())._expandBoundingBox(r,true,true);if(e&&(e._vkGetNodeContentType()===n.Background||e._vkGetNodeContentType()===n.Symbol)){r.setFromObject(e)}var o=e&&e._vkGetNodeContentType()===n.Symbol?10:0;this.zoomBox(r,o,i,e,t)};this.zoomBox=function(e,t,i,r,o){this._zoomedNodeRef=r;this._isZoomIn=o;this._animationType="zooming";this._newCamera=a.getCamera().getCameraRef().clone();this._newCamera._vkZoomTo(e,t);this.startCameraAnimation(i)};this.prepareForCameraUpdateAnimation=function(){this._oldCamera=a.getCamera().getCameraRef().clone()};this.startAnimatingCameraUpdate=function(e,t,i){var r=a.getCamera().getCameraRef();if(!this._oldCamera){return 0}var o=!!i;var n=1e-4;if(r.isOrthographicCamera&&this._oldCamera.isOrthographicCamera){if(Math.abs(r.left-this._oldCamera.left)>n||Math.abs(r.right-this._oldCamera.right)>n||Math.abs(r.top-this._oldCamera.top)>n||Math.abs(r.bottom-this._oldCamera.bottom)>n||Math.abs(r.zoom-this._oldCamera.zoom)>n){o=true}}else if(r.isPerspectiveCamera&&this._oldCamera.isPerspectiveCamera){if(Math.abs(r.fov-this._oldCamera.fov)>n||Math.abs(r.aspect-this._oldCamera.aspect)>n){o=true}}if(!o){if(Math.abs(r.position.x-this._oldCamera.position.x)>n||Math.abs(r.position.y-this._oldCamera.position.y)>n||Math.abs(r.position.z-this._oldCamera.position.z)>n||Math.abs(r.scale.x-this._oldCamera.scale.x)>n||Math.abs(r.scale.y-this._oldCamera.scale.y)>n||Math.abs(r.scale.z-this._oldCamera.scale.z)>n||Math.abs(r.quaternion.x-this._oldCamera.quaternion.x)>n||Math.abs(r.quaternion.y-this._oldCamera.quaternion.y)>n||Math.abs(r.quaternion.z-this._oldCamera.quaternion.z)>n||Math.abs(r.quaternion.w-this._oldCamera.quaternion.w)>n){o=true}}if(!o){if(!t){a.cameraUpdateCompleted({position:r.position.toArray(),quaternion:r.quaternion.toArray()});return 0}else{e=500}}this._newCamera=a.getCamera().getCameraRef().clone();this.startCameraAnimation(e,i);return e}};this._cameraController=new a(t)}});s.prototype._activateRedline=function(){var e=this._viewport.getCamera().getCameraRef();e.userData.isRedlineActivated=true;var t=this._viewport.getDomRef();e.setViewOffset(t.clientWidth,t.clientHeight,0,0,t.clientWidth,t.clientHeight)};s.prototype._deactivateRedline=function(){var e=this._viewport&&this._viewport.getCamera();if(e){var t=e.getCameraRef();t.userData.isRedlineActivated=false;t.clearViewOffset()}};s.prototype.destroy=function(){this._viewport=null;this._rect=null;this._evt=null;this._gesture=false};s.prototype._getOffset=function(e){var t=e.getBoundingClientRect();var a={x:t.left+window.pageXOffset,y:t.top+window.pageYOffset};return a};s.prototype._inside=function(e){if(this._rect===null||true){var t=this._viewport.getIdForLabel();var a=document.getElementById(t);if(!a){return false}var i=this._getOffset(a);this._rect={x:i.x,y:i.y,w:a.offsetWidth,h:a.offsetHeight}}return e.x>=this._rect.x&&e.x<=this._rect.x+this._rect.w&&e.y>=this._rect.y&&e.y<=this._rect.y+this._rect.h};s.prototype._onresize=function(e){this._gesture=false;this._rect=null};s.prototype.beginGesture=function(t){if(this._inside(t)&&!this._gesture){this._gesture=true;var a=t.x-this._rect.x,i=t.y-this._rect.y;this._evt.x=a;this._evt.y=i;this._evt.d=t.d;this._evt.initd=t.d;this._evt.avgd=t.d;this._evt.avgx=0;this._evt.avgy=0;e.debug("Loco: beginGesture: "+a+", "+i);this._cameraController.beginGesture(a,i);t.handled=true;if(document.activeElement){try{document.activeElement.blur()}catch(e){}}var r=document.getElementById(this._viewport.getIdForLabel());r.focus()}this._nomenu=false};s.prototype.move=function(t){if(this._gesture){var a=t.x-this._rect.x,i=t.y-this._rect.y;var r=a-this._evt.x;var o=i-this._evt.y;var n=t.d-this._evt.d;this._evt.x=a;this._evt.y=i;this._evt.d=t.d;this._evt.avgx=this._evt.avgx*.99+r*.01;this._evt.avgy=this._evt.avgy*.99+o*.01;var s=1;if(this._evt.initd>0){s=1+n*(1/this._evt.initd)}else if(t.n===2){if(t.points[0].y>t.points[1].y){s=1-n*.005;if(s<.333){s=.333}}else{s=1+n*.005;if(s>3){s=3}}}if(this._evt.initd>0){var h=Math.sqrt(this._evt.avgx*this._evt.avgx+this._evt.avgy*this._evt.avgy);e.debug("AvgDist: "+h);if(Math.abs(t.d-this._evt.avgd)/this._evt.avgd<h/10){s=1}}s=THREE.Math.clamp(s,.88,1.12);this._evt.avgd=this._evt.avgd*.97+t.d*.03;switch(t.n){case 1:e.debug("Loco: Rotate: "+r+", "+o);this._cameraController.rotate(r,o);break;case 2:e.debug("Loco: Pan: "+r+", "+o);if(s!=0&&s!=1){e.debug("Loco: Zoom: "+s)}this._cameraController.pan(r,o);if(r<10&&o<10&&s!=0&&s!=1){this._cameraController.zoom(s)}break;default:break}this._nomenu=true;t.handled=true}};s.prototype.endGesture=function(t){if(this._gesture){var a=t.x-this._rect.x,i=t.y-this._rect.y;e.debug("Loco: endGesture: "+a+", "+i);this._cameraController.endGesture();this._gesture=false;t.handled=true}};s.prototype.click=function(t){if(this._inside(t)&&t.buttons<=1){var a=t.x-this._rect.x,i=t.y-this._rect.y;e.debug("Loco: click: "+a+", "+i);if(this._viewport){this._viewport.tap(a,i,false)}t.handled=true}};s.prototype.doubleClick=function(t){if(this._inside(t)&&t.buttons<=1){var a=t.x-this._rect.x,i=t.y-this._rect.y;e.debug("Loco: doubleClick: "+a+", "+i);if(this._viewport){this._viewport.tap(a,i,true)}t.handled=true}};s.prototype.contextMenu=function(e){if(this._inside(e)||this._nomenu||e.buttons===5){this._nomenu=false;e.handled=true}};s.prototype.keyEventHandler=function(e){};s.prototype.getViewport=function(){return this._viewport};s.prototype.activateCamera=function(e,t,r,o){var n=0;this._cameraController.prepareForCameraUpdateAnimation();if(this._viewport.getCamera().getCameraRef().isPerspectiveCamera!=e.isPerspectiveCamera){var s=e.isPerspectiveCamera?new a:new i;s.getCameraRef().copy(e);this._viewport.setCamera(s)}else{this._viewport.getCamera().getCameraRef().copy(e)}var h=this._viewport.getRenderer().getSize(new THREE.Vector2);this._viewport.getCamera().update(h.width,h.height);if(t>0){n=this._cameraController.startAnimatingCameraUpdate(t,r,o)}else{this._viewport.cameraUpdateCompleted({position:e.position.toArray(),quaternion:e.quaternion.toArray()})}return n};s.prototype.setView=function(t,i){var r=this._viewport.getCamera().getCameraRef();if(r.userData.isRedlineActivated){e.error("setView() method is disabled when Redlining is activated");return this}this._cameraController.prepareForCameraUpdateAnimation();if(t){r.quaternion.copy(t);r.updateMatrixWorld();r.up.setFromMatrixColumn(r.matrixWorld,1).normalize();this._cameraController.zoomObject(null,false,i)}else{r.copy(this._viewport._homeCamera?this._viewport._homeCamera:(new a).getCameraRef());var o=this._viewport.getRenderer().getSize(new THREE.Vector2);this._viewport.getCamera().update(o.width,o.height);this._cameraController.startAnimatingCameraUpdate(i)}return this};s.prototype.zoomTo=function(t,a,i,r,o,n){if(this._viewport._isPanoramicActivated()||this._viewport._isPlanarActivated()){e.error("zoomTo() method is disabled in navigation scene");return this}var s=this._viewport.getCamera().getCameraRef();this._cameraController.prepareForCameraUpdateAnimation();if(a){s.quaternion.copy(a);s.updateMatrixWorld();s.up.setFromMatrixColumn(s.matrixWorld,1).normalize()}this._cameraController.zoomBox(t,i,r,o,n);return this};s.prototype.zoomObject=function(e,t,a){if(this._viewport._isPanoramicActivated()){this._cameraController.lookAtObject(e,a)}else{this._cameraController.prepareForCameraUpdateAnimation();this._cameraController.zoomObject(e,t,a)}return this};s.prototype.animateCameraUpdate=function(){this._cameraController.animateCameraUpdate()};s.prototype.prepareForCameraUpdateAnimation=function(){this._cameraController.prepareForCameraUpdateAnimation()};s.prototype.startAnimatingCameraUpdate=function(e){this._cameraController.startAnimatingCameraUpdate(e)};return s});
//# sourceMappingURL=ViewportGestureHandler.js.map