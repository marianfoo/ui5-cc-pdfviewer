/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
 */
sap.ui.define(["../Core","../ViewportBase","sap/ui/core/ResizeHandler","sap/ui/events/KeyCodes","../Loco","../thirdparty/three","../ViewStateManager","./ViewportGestureHandler","./OrthographicCamera","./PerspectiveCamera","./NodesTransitionHelper","../Messages","sap/ui/base/ManagedObjectObserver","./ViewportRenderer","../CameraProjectionType","../CameraFOVBindingType","../VisibilityMode","../ZoomTo","../SelectionMode","../RenderMode","../getResourceBundle","../cssColorToColor","../ViewStateManager","./ViewStateManager","./v2/ViewStateManager","./HitTester","./Scene","./ContentDeliveryService","../SafeArea","../Annotation","../measurements/Surface","../NodeContentType","sap/base/Log","sap/ui/core/Core","../findIndexInArray"],function(e,t,i,r,a,n,o,s,h,l,d,c,u,g,f,p,v,_,m,y,w,C,R,S,E,b,T,k,x,M,V,H,B,A,L){"use strict";var O=t.extend("sap.ui.vk.threejs.Viewport",{metadata:{library:"sap.ui.vk",events:{cameraChanged:{parameters:{position:"float[]",quaternion:"float[]",zoom:"float"},enableEventBubbling:true},frameRenderingFinished:{}}}});var N=O.getMetadata().getParent().getClass().prototype;THREE.PropertyBinding.prototype.GetterByBindingType[0]=function(e,t){e[t]=this.targetObject[this.propertyName]};O.prototype.init=function(){if(N.init){N.init.call(this)}this._measurementSurface=new V;this._renderer=null;this._imageCanvas=null;this._canvas=null;this._registryEntry=null;this._width=1;this._height=1;this._resizeListenerId=null;this._handleResize=this._handleResize.bind(this);this._renderLoopRequestId=0;this._renderLoop=this._renderLoop.bind(this);this._shouldRenderFrame=true;this._clippingPlanes=[];this._hitTester=new b;this._scene=null;this._camera=new l;this._upAxis=2;var t=new THREE.Vector4;var i=new THREE.Vector4;this._updateColor(t,this.getBackgroundColorTop());this._updateColor(i,this.getBackgroundColorBottom());this._checkBackgroundColor();this._backgroundMaterial=new THREE.ShaderMaterial({uniforms:{topColor:{value:t},bottomColor:{value:i}},vertexShader:["varying float vPos;","void main() {","\tgl_Position = vec4(position, 1.0);","\tvPos = position.y * -0.5 + 0.5;","}"].join("\n"),fragmentShader:["uniform vec4 topColor;","uniform vec4 bottomColor;","varying float vPos;","void main() {","\tgl_FragColor = mix(topColor, bottomColor, vPos);","}"].join("\n"),side:THREE.DoubleSide,depthTest:false,depthWrite:false,blending:THREE.NoBlending});var r=new THREE.Geometry;r.vertices.push(new THREE.Vector3(-1,1,0),new THREE.Vector3(1,1,0),new THREE.Vector3(-1,-1,0),new THREE.Vector3(1,-1,0));r.faces.push(new THREE.Face3(0,2,1),new THREE.Face3(1,2,3));this._backgroundCamera=new THREE.Camera;this._backgroundScene=new THREE.Scene;this._backgroundScene.add(new THREE.Mesh(r,this._backgroundMaterial));this._underlayGroup=new THREE.Group;this._overlayGroup=new THREE.Group;this._xrayColor1=new THREE.Vector4(0,.75,1,.45);this._xrayColor2=new THREE.Vector4(0,0,1,0);this._xrayMaterial=new THREE.ShaderMaterial({uniforms:{color1:{value:this._xrayColor1},color2:{value:this._xrayColor2}},vertexShader:["#include <clipping_planes_pars_vertex>","varying vec3 vNormal;","void main() {","#include <begin_vertex>","#include <project_vertex>","#include <clipping_planes_vertex>","#include <beginnormal_vertex>","#include <defaultnormal_vertex>","\tvNormal = normalize( transformedNormal );","}"].join("\n"),fragmentShader:["#include <clipping_planes_pars_fragment>","uniform vec4 color1;","uniform vec4 color2;","varying vec3 vNormal;","void main() {","#include <clipping_planes_fragment>","\tgl_FragColor = mix(color1, color2, abs(normalize(vNormal).z));","}"].join("\n"),side:THREE.DoubleSide,depthWrite:false,depthFunc:THREE.LessDepth,blending:THREE.NormalBlending,clipping:true,transparent:true});this._viewportGestureHandler=new s(this);this._loco=new a(this);this._loco.addHandler(this._viewportGestureHandler,-1);this._zoomedObject=null;this._cdsLoader=null;this.attachCameraChanged(function(e){this.setShouldRenderFrame()});this._sceneObserver=new u(this.setShouldRenderFrame.bind(this));this._currentViewIndex=0;this._currentView=null;e.getEventBus().subscribe("sap.ui.vk","viewStateApplied",this._onViewStateApplied,this);A.attachLocalizationChanged(this._onLocalizationChanged,this)};O.prototype.cameraUpdateCompleted=function(e){this.fireViewFinished({viewIndex:this._currentViewIndex})};O.prototype.exit=function(){A.detachLocalizationChanged(this._onLocalizationChanged,this);e.getEventBus().unsubscribe("sap.ui.vk","viewStateApplied",this._onViewStateApplied,this);this._measurementSurface.destroy();this._measurementSurface=null;this._loco.removeHandler(this._viewportGestureHandler);this._viewportGestureHandler.destroy();if(this._resizeListenerId){i.deregister(this._resizeListenerId);this._resizeListenerId=null}this._stopRenderLoop();var t=this.getTools();for(var r=0;r<t.length;r++){var a=A.byId(t[r]);if(a){a.setActive(false)}}this._setContent(null);this.setCamera(null);this._backgroundCamera=null;this._backgroundMaterial=null;this._backgroundScene=null;this._loco=null;this._viewportGestureHandler=null;this._eyePointLight=null;this._hitTester=null;this._imageCanvas=null;if(this._cdsLoader){this._cdsLoader.detachSceneUpdated(this._handleCdsSceneUpdate,this)}if(N.exit){N.exit.call(this)}};O.prototype._onLocalizationChanged=function(e){var t=this._measurementSurface;if(t&&t.getMeasurements().length>0){t.update(this,this.getCamera())}};O.prototype.onSetViewStateManager=function(e){this._viewStateManager=e;e.attachVisibilityChanged(this._onVisibilityChanged,this);e.attachOpacityChanged(this.setShouldRenderFrame,this);e.attachTintColorChanged(this.setShouldRenderFrame,this);e.attachHighlightColorChanged(this.setShouldRenderFrame,this);e.attachTransformationChanged(this.setShouldRenderFrame,this);e.attachOutlineColorChanged(this.setShouldRenderFrame,this);e.attachOutlineWidthChanged(this.setShouldRenderFrame,this);e.attachOutliningChanged(this._onOutliningOrSelectionChanged,this);e.attachSelectionChanged(this._onOutliningOrSelectionChanged,this)};O.prototype.onUnsetViewStateManager=function(e){e.detachOutliningChanged(this._onOutliningOrSelectionChanged,this);e.detachSelectionChanged(this._onOutliningOrSelectionChanged,this);e.detachVisibilityChanged(this._onVisibilityChanged,this);e.detachOpacityChanged(this.setShouldRenderFrame,this);e.detachTintColorChanged(this.setShouldRenderFrame,this);e.detachHighlightColorChanged(this.setShouldRenderFrame,this);e.detachTransformationChanged(this.setShouldRenderFrame,this);e.detachOutlineColorChanged(this.setShouldRenderFrame,this);e.detachOutlineWidthChanged(this.setShouldRenderFrame,this);this._viewStateManager=null};O.prototype._startRenderLoop=function(){if(!this._renderLoopRequestId){this._renderLoopRequestId=window.requestAnimationFrame(this._renderLoop)}return this};O.prototype._stopRenderLoop=function(){if(this._renderLoopRequestId){window.cancelAnimationFrame(this._renderLoopRequestId);this._renderLoopRequestId=0}return this};O.prototype.setBackgroundColorTop=function(e){N.setBackgroundColorTop.call(this,e);if(this._backgroundMaterial!==null){this._updateColor(this._backgroundMaterial.uniforms.topColor.value,e);this._checkBackgroundColor()}return this};O.prototype.setBackgroundColorBottom=function(e){N.setBackgroundColorBottom.call(this,e);if(this._backgroundMaterial!==null){this._updateColor(this._backgroundMaterial.uniforms.bottomColor.value,e);this._checkBackgroundColor()}return this};O.prototype.setClippingPlanes=function(e){this._clippingPlanes=e;return this};O.prototype.onBeforeRendering=function(){if(this._resizeListenerId){i.deregister(this._resizeListenerId);this._resizeListenerId=null}this._stopRenderLoop()};O.prototype.onAfterRendering=function(){var e=this.getDomRef();if(this._canvas){e.append(this._canvas)}e.append(this._measurementSurface.getDomRef());this._resizeListenerId=i.register(this,this._handleResize);this._handleResize({size:{width:e.clientWidth,height:e.clientHeight}});this._startRenderLoop()};O.prototype._handleResize=function(e){if(!this._camera||!this._renderer){return false}if(this.getSafeArea()){this.getSafeArea().resize()}var t=e.size.width;var i=e.size.height;this._width=t;this._height=i;if(this._camera){this._camera.update(t,i)}var r=this._canvas;var a=this._renderer.domElement;if(r!==a){var n=window.devicePixelRatio;r.width=Math.floor(t*n);r.height=Math.floor(i*n);r.style.width=t+"px";r.style.height=i+"px"}J(this._registryEntry);var o=this._measurementSurface.getDomRef();o.style.width=t+"px";o.style.height=i+"px";this.fireResize({size:{width:t,height:i}});this.setShouldRenderFrame();return true};O.prototype.setScene=function(e){if(this._scene){var t=this._scene.getDefaultNodeHierarchy();t.detachChanged(this._clearAnnotations,this);t.detachNodeCreated(this._nodeCreatedHandler,this);q(this,this._scene)}this._scene=e;this._homeCamera=null;this._currentViewIndex=0;this._currentView=null;this._sceneObserver.disconnect();var i=this._getNativeScene();if(i){this._sceneObserver.observe(this._scene,{properties:["doubleSided"]});var r;for(var a=0;a<i.children.length;a++){r=i.children[a];if(r.private&&r.name==="DefaultLights"&&r.children.length){if(r.children[0]instanceof THREE.PointLight){this._eyePointLight=r.children[0]}}}}if(this._scene){this._scene.getDefaultNodeHierarchy().attachChanged(this._clearAnnotations,this);this._scene.getDefaultNodeHierarchy().attachNodeCreated(this._nodeCreatedHandler,this)}if(this._scene){var n=this._scene.getInitialView();if(n&&this._getViewStateManagerThreeJS()){this.activateView(n,false,true)}}this._clearAnnotations(true);this.setShouldRenderFrame();return this};O.prototype.getScene=function(){return this._scene};O.prototype._getNativeScene=function(){return this._scene?this._scene.getSceneRef():null};O.prototype._getNativeCamera=function(){return this._camera?this._camera.getCameraRef():null};O.prototype._clearAnnotations=function(e){if(e){this.destroyAnnotations()}else{this.getAnnotations().forEach(function(e){if(e.autoGenerated){this.removeAnnotation(e)}},this)}this._annotationsLoaded=false};O.prototype._nodeCreatedHandler=function(e){var t=e.getParameter("nodeRef");if(t._vkGetNodeContentType()==H.Annotation){var i=this.getCurrentView();if(i){i.getNodeInfos().push({target:t,visible:true})}}};O.prototype.setCamera=function(e){if(N.setCamera){N.setCamera.call(this,e)}var t=this.getCamera();if(t&&this._renderer){t.update(this._width,this._height);if(!this._homeCamera&&t.getCameraRef()){this._homeCamera=t.getCameraRef().clone()}}this.setShouldRenderFrame();return this};O.prototype.getRenderer=function(){return this._renderer};O.prototype._getViewStateManagerThreeJS=function(){if(this._viewStateManager){if(this._viewStateManager instanceof S){return this._viewStateManager}if(this._viewStateManager instanceof R&&this._viewStateManager._implementation instanceof S){return this._viewStateManager._implementation}}return null};O.prototype._updateColor=function(e,t){var i=C(t);e.color=new THREE.Color(i.red/255,i.green/255,i.blue/255);e.alpha=i.alpha;e.x=e.color.r*e.alpha;e.y=e.color.g*e.alpha;e.z=e.color.b*e.alpha;e.w=e.alpha};O.prototype._checkBackgroundColor=function(){var e=this.getBackgroundColorTop();if(e===this.getBackgroundColorBottom()){if(this._backgroundColor===null){this._backgroundColor=new THREE.Vector4}this._updateColor(this._backgroundColor,e)}else{this._backgroundColor=null}this.setShouldRenderFrame()};O.prototype._handleCdsSceneUpdate=function(){this.setShouldRenderFrame()};O.prototype._handleLoadingFinished=function(){this._clearAnnotations();this.getAnnotations();this.setShouldRenderFrame()};O.prototype.setShouldRenderFrame=function(){this._shouldRenderFrame=true;return this};O.prototype.shouldRenderFrame=function(){return this._shouldRenderFrame};O.prototype.setRenderMode=function(e){this.setProperty("renderMode",e,true);if(this._scene){switch(e){case y.LineIllustration:case y.ShadedIllustration:case y.SolidOutline:this._scene._createOutlineGeometry(e);break;default:this._scene._hideOutlineGeometry();break}}this.setShouldRenderFrame();return this};O.prototype.hitTest=function(e,t,i){var r=this._getNativeScene();var a=this._getNativeCamera();if(!a||!r){return null}var n=this._getViewStateManagerThreeJS();if(n&&n.applyNodeStates){n.applyNodeStates()}try{var o=this._canvas;return this._hitTester.hitTest(e-o.clientLeft,t-o.clientTop,o.clientWidth,o.clientHeight,this._renderer,r,a,this._clippingPlanes,i)}finally{if(n&&n.revertNodeStates){n.revertNodeStates()}}};O.prototype._isRedlineActivated=function(){var e=this._getNativeCamera();return e?e.userData.isRedlineActivated:false};var P={sphere:"spherical",plane:"planar"};O.prototype._onVisibilityChanged=function(e){function t(e){return e.visible&&e._vkGetNodeContentType()===H.Background&&P[e.name]!==undefined}function i(e){var r=e.find(t);for(var a=0;!r&&a<e.length;a++){r=i(e[a].children)}return r}var r=e.getParameter("visible");var a=r&&i(r);if(a!=null){this._backgroundNode=a}else if(this._backgroundNode!=null){var n=e.getParameter("hidden");if(this._backgroundNode===(n&&n.find(t))){this._backgroundNode=null}}this.setShouldRenderFrame()};O.prototype.getBackgroundProjection=function(){return P[this._backgroundNode&&this._backgroundNode.name]};O.prototype._isPanoramicActivated=function(){return this.getBackgroundProjection()==="spherical"};O.prototype._isPlanarActivated=function(){return this.getBackgroundProjection()==="planar"};O.prototype.tap=function(e,t,i){if(!i){if(this._viewStateManager){var r=this.hitTest(e,t);var a=r&&r.object;this.tapObject(a);if(a!==null){this.fireNodeClicked({nodeRef:a,x:e,y:t},true,true)}}}else if(!this.getFreezeCamera()){var n=this.hitTest(e,t);if(n&&(this._zoomedObject===null||this._zoomedObject!==n.object)){this._zoomedObject=n.object;this._viewportGestureHandler.zoomObject(this._zoomedObject,true)}else{this._viewportGestureHandler.zoomObject(this._zoomedObject,false);this._zoomedObject=null}}return this};O.prototype.tapObject=function(e){var t={picked:e?[e]:[]};this.fireNodesPicked(t);if(e&&e._vkGetNodeContentType()===H.Background){this.exclusiveSelectionHandler([]);return this}if(this.getSelectionMode()===m.Exclusive){this.exclusiveSelectionHandler(t.picked)}else if(this.getSelectionMode()===m.Sticky){this.stickySelectionHandler(t.picked)}return this};var F={x:-2,y:-2};var I=2;var z=5;O.prototype.onkeydown=function(e){if(!e.isMarked()){var t;switch(e.keyCode){case r.ARROW_LEFT:case r.ARROW_RIGHT:case r.ARROW_UP:case r.ARROW_DOWN:if(e.ctrlKey||e.altKey||e.metaKey){break}var i={x:0,y:0};switch(e.keyCode){case r.ARROW_LEFT:i.x=-1;break;case r.ARROW_RIGHT:i.x=+1;break;case r.ARROW_UP:i.y=-1;break;case r.ARROW_DOWN:i.y=+1;break;default:break}t=this._viewportGestureHandler._cameraController;t.beginGesture(F.x,F.y);if(e.shiftKey){t.pan(z*i.x,z*i.y)}else{t.rotate(I*i.x,I*i.y,true)}t.endGesture();this.setShouldRenderFrame();e.preventDefault();e.stopPropagation();break;case 189:case r.PLUS:case r.NUMPAD_MINUS:case r.NUMPAD_PLUS:t=this._viewportGestureHandler._cameraController;t.beginGesture(this.$().width()/2,this.$().height()/2);t.zoom(e.keyCode===r.PLUS||e.keyCode===r.NUMPAD_PLUS?1.02:.98);t.endGesture();this.setShouldRenderFrame();e.preventDefault();e.stopPropagation();break;default:break}}};O.prototype._onOutliningOrSelectionChanged=function(e){var t=this.getTools();for(var i=0;i<t.length;i++){var r=A.byId(t[i]);var a=r.getGizmoForContainer(this);if(a&&a.handleSelectionChanged){a.handleSelectionChanged(e)}}this.setShouldRenderFrame()};O.prototype.setSelectionRect=function(e){this.setShouldRenderFrame();if(!e){this._selectionRect=null;return}var t=e.x1/this._width*2-1;var i=e.y1/this._height*-2+1;var r=e.x2/this._width*2-1;var a=e.y2/this._height*-2+1;if(!this._selectionRect){var n=new THREE.Geometry;n.vertices.push(new THREE.Vector3(t,a,-1),new THREE.Vector3(r,a,-1),new THREE.Vector3(r,i,-1),new THREE.Vector3(t,i,-1));this._selectionRect=new THREE.LineLoop(n,new THREE.LineBasicMaterial({color:12632064,linewidth:window.devicePixelRatio}))}else{var o=this._selectionRect.geometry.vertices;o[0].set(t,a,-1);o[1].set(r,a,-1);o[2].set(r,i,-1);o[3].set(t,i,-1);this._selectionRect.geometry.verticesNeedUpdate=true}};O.prototype._renderLoop=function(){if(!this._renderer||!this.getDomRef()){this._renderLoopRequestId=0;return}if(this._viewportGestureHandler){this._viewportGestureHandler.animateCameraUpdate()}if(this.getCamera()){if(this.getCamera().getIsModified()){this.getCamera().setIsModified(false);this._shouldRenderFrame=true}}var e=this._getViewStateManagerThreeJS();if(e){this._shouldRenderFrame|=e._playTransition();this._shouldRenderFrame|=e._playHighlight()}if(this._shouldRenderFrame&&this.getAutoStartRendering()){this._shouldRenderFrame=false;if(e){e._setJointNodeMatrix()}this.render();var t=this.getAnnotations();if(t){t.forEach(function(e){e.update()})}this._measurementSurface.update(this,this.getCamera())}this._renderLoopRequestId=window.requestAnimationFrame(this._renderLoop)};function G(e,t,i,r){var a=new THREE.Vector2(r._width,r._height);var n=r.getBackgroundProjection();i.children.forEach(function(i){if(i.userData._vkDynamicObjects){i.userData._vkDynamicObjects.forEach(function(i){if(i.parent){i._vkUpdate(e,t,a,n)}})}})}function D(e,t,i,r,a){i.children.forEach(function(n){if(n.userData._vkDetailViews){n.userData._vkDetailViews.sort(function(e,t){return e.renderOrder-t.renderOrder});n.userData._vkDetailViews.forEach(function(n){if(n.node.visible){n.detailView._render(e,t,i,r,a)}})}})}O.prototype._updateWorldMatrixRecursive=function(e,t){if(e.visible===false){return}if(e.userData.renderStage){(e.userData.renderStage<0?this._underlayGroup:this._overlayGroup).children.push(e)}e.matrixAutoUpdate=false;if(e.matrixWorldNeedsUpdate||t){if(e.parent===null){e.matrixWorld.copy(e.matrix)}else{e.matrixWorld.multiplyMatrices(e.parent.matrixWorld,e.matrix)}e.matrixWorldNeedsUpdate=true;t=true}var i=e.children;for(var r=0,a=i.length;r<a;r++){this._updateWorldMatrixRecursive(i[r],t)}};function j(e,t){e.children.forEach(function(e){e.visible=t})}O.prototype.render=function(){var e=this._renderer;if(!e){return}var t=this._getViewStateManagerThreeJS();if(t&&t.applyNodeStates){t.applyNodeStates()}try{e.setViewport(0,0,this._canvas.width/window.devicePixelRatio,this._canvas.height/window.devicePixelRatio);var i=this._getNativeScene();var r=this._getNativeCamera();if(!i||!r){return}if(this._eyePointLight){this._eyePointLight.position.copy(r.position);this._eyePointLight.updateMatrix()}this._underlayGroup.children.length=0;this._overlayGroup.children.length=0;this._updateWorldMatrixRecursive(i,false);i.autoUpdate=false;var a=this.getTools();var n,o,s,h;if(this._camera.getUsingDefaultClipPlanes()||r.isOrthographicCamera&&r.zoom<=0){h=this._scene._computeBoundingBox(true,false,true);if(t){t._selectedNodes.forEach(function(e){e._expandBoundingBox(h,false,false,false)})}if(!h.isEmpty()){if(r.isOrthographicCamera&&r.zoom<=0){this._camera.adjustZoom(h)}if(this._camera.getUsingDefaultClipPlanes()){for(n=0;n<a.length;n++){o=A.byId(a[n]);s=o.getGizmoForContainer(this);if(s&&s.expandBoundingBox){s.expandBoundingBox(h)}}this._camera.adjustClipPlanes(h)}}}G(e,r,i,this);e.autoClear=false;if(this._backgroundColor!==null){e.setClearColor(this._backgroundColor.color,this._backgroundColor.alpha);e.clear(true,true,false)}else{e.render(this._backgroundScene,this._backgroundCamera);e.clearDepth()}if(this._underlayGroup.children.length>0){e.render(this._underlayGroup,r);e.clearDepth();j(this._underlayGroup,false)}j(this._overlayGroup,false);e.clippingPlanes=this._clippingPlanes;switch(this.getRenderMode()){case y.XRay:if(t){var l=i.children[i.children.length-1].clone();t._selectedNodes.forEach(function(t){if(t.visible){t.add(l);e.render(t,r);t.remove(l)}})}i.overrideMaterial=this._xrayMaterial;break;case y.LineIllustration:case y.ShadedIllustration:case y.SolidOutline:this._scene._outlineMaterial.linewidth=this._renderer.getPixelRatio();break;default:break}e.render(i,r);e.clippingPlanes=[];i.overrideMaterial=null;if(this._overlayGroup.children.length>0){j(this._overlayGroup,true);e.clearDepth();e.render(this._overlayGroup,r)}j(this._underlayGroup,true);D(e,r,i,h,this._eyePointLight);if(this.getShowSelectionBoundingBoxes()&&t){var d=t._boundingBoxesScene;if(d){t._updateBoundingBoxes();e.render(d,r)}}if(t){t._renderOutline(e,i,r)}for(n=0;n<a.length;n++){o=A.byId(a[n]);s=o.getGizmoForContainer(this);if(s&&s.render){s.render(this)}}if(this._selectionRect){e.render(this._selectionRect,this._backgroundCamera)}var c=this._registryEntry.webGLRenderer.domElement;var u=this._canvas;if(u!==c){var g=u.getContext("2d");var f=u.width;var p=u.height;g.drawImage(c,0,c.height-p,f,p,0,0,f,p)}}finally{if(t&&t.revertNodeStates){t.revertNodeStates()}}this.fireFrameRenderingFinished()};O.prototype.getImage=function(e,t,i,r,a){var n=this._getNativeScene();if(!n){return null}e=Math.min(e||16,2048);t=Math.min(t||16,2048);this._imageCanvas=this._imageCanvas||document.createElementNS("http://www.w3.org/1999/xhtml","canvas");var o=new THREE.WebGLRenderer({canvas:this._imageCanvas,preserveDrawingBuffer:true,antialias:true,alpha:true});o.setSize(e,t);var s=this.getBackgroundColorTop();var d=this.getBackgroundColorBottom();if(i&&!r){o.setClearColor(i,1)}else if(!i&&r){o.setClearColor(r,1)}else{if(i&&r){this.setBackgroundColorTop(i);this.setBackgroundColorBottom(r)}o.render(this._backgroundScene,this._backgroundCamera);o.autoClear=false}document.body.appendChild(o.domElement);var c=this.getCamera();var u=c instanceof l?new l:new h;u.getCameraRef().copy(c.getCameraRef());u.update(e,t);if(this._eyePointLight){this._eyePointLight.position.copy(u.getCameraRef().position);this._eyePointLight.updateMatrix();this._eyePointLight.updateMatrixWorld(true)}var g=[];var f=this._getViewStateManagerThreeJS();if(!a){if(f!==null){f.enumerateSelection(function(e){g.push(e)});f.setSelectionState(g,false,false,true)}}o.render(n,u.getCameraRef());var p=o.getContext().canvas.toDataURL();if(f!==null&&g.length>0){f.setSelectionState(g,true,false,true)}document.body.removeChild(o.domElement);o.dispose();if(d&&i){this.setBackgroundColorBottom(d)}if(s&&r){this.setBackgroundColorTop(s)}return p};O.prototype.getMaterialImage=function(e,t,i,r,a,n){t=THREE.Math.clamp(t||256,8,2048);i=THREE.Math.clamp(i||256,8,2048);this._imageCanvas=this._imageCanvas||document.createElementNS("http://www.w3.org/1999/xhtml","canvas");var o=new THREE.WebGLRenderer({canvas:this._imageCanvas,preserveDrawingBuffer:true,antialias:true,alpha:true});o.setSize(t,i);var s=this.getBackgroundColorTop();var l=this.getBackgroundColorBottom();if(r&&!a){o.setClearColor(r,1)}else if(!r&&a){o.setClearColor(a,1)}else if(r&&a){this.setBackgroundColorTop(r);this.setBackgroundColorBottom(a);o.render(this._backgroundScene,this._backgroundCamera);o.autoClear=false}else{o.setClearColor("#000000",0)}document.body.appendChild(o.domElement);var d=new h;var c=d.getCameraRef();d.update(t,i);var u=new THREE.SphereGeometry(1,64,32);var g=new THREE.Mesh(u);var f=new THREE.Box3;g._expandBoundingBox(f,false,false,false);c._vkZoomTo(f,n);d.adjustClipPlanes(f);var p=new THREE.PointLight;p.position.copy(c.position);p.position.y=-1;p.updateMatrix();p.updateMatrixWorld(true);g.add(p);var v=Array.isArray(e)?e:[e];var _=[];for(var m in v){g.material=v[m];o.render(g,c);_.push(o.getContext().canvas.toDataURL())}g.remove(p);document.body.removeChild(o.domElement);o.dispose();if(l&&r){this.setBackgroundColorBottom(l)}if(s&&a){this.setBackgroundColorTop(s)}return Array.isArray(e)?_:_[0]};O.prototype.getObjectImage=function(e,t,i,r,a,n,o){return this.getObjectImageEx(e,t,i,r,a,{quaternion:n,margin:o,includeOverlay:true})};O.prototype.getObjectImageEx=function(e,t,i,r,a,n){var o=this._getNativeScene();if(!o){return null}n=n||{};t=THREE.Math.clamp(t||256,8,2048);i=THREE.Math.clamp(i||256,8,2048);this._imageCanvas=this._imageCanvas||document.createElementNS("http://www.w3.org/1999/xhtml","canvas");var s=new THREE.WebGLRenderer({canvas:this._imageCanvas,preserveDrawingBuffer:true,antialias:true,alpha:true});s.setSize(t,i);var d=this.getBackgroundColorTop();var c=this.getBackgroundColorBottom();if(r&&!a){s.setClearColor(r,1)}else if(!r&&a){s.setClearColor(a,1)}else{if(r&&a){this.setBackgroundColorTop(r);this.setBackgroundColorBottom(a)}s.render(this._backgroundScene,this._backgroundCamera);s.autoClear=false}document.body.appendChild(s.domElement);var u=this._getViewStateManagerThreeJS();if(u&&u.applyNodeStates){u.applyNodeStates()}try{if(e==null){e=o.children.slice().filter(function(e){return e.name!=="DefaultLights"})}else if(!Array.isArray(e)){e=[e]}var g=this.getCamera();var f=g instanceof l?new l:new h;var p=f.getCameraRef();p.copy(g.getCameraRef());if(n.quaternion&&!n.useViewportCamera){p.quaternion.copy(n.quaternion);p.updateMatrixWorld();p.up.setFromMatrixColumn(p.matrixWorld,1).normalize()}f.update(t,i);if(!n.useViewportCamera){e[0].getWorldPosition(p.position);p.position.sub(p.getWorldDirection(new THREE.Vector3).multiplyScalar(1e3))}p.updateMatrixWorld();p.updateProjectionMatrix();var v=new THREE.Vector2;s.getSize(v);var _=[];e.forEach(function(e){e.traverseVisible(function(e){if(e._vkUpdate){e._vkUpdate(s,p,v);if(e._vkGetNodeContentType()===H.Symbol){e._vkSetOpacity(1)}}if(!n.includeOverlay&&e.userData.renderStage>0||!n.includeUnderlay&&e.userData.renderStage<0){_.push(e);e.visible=false}})});var m=new THREE.Scene;m.children=e;var y=new THREE.Box3;m._expandBoundingBox(y,false,false,false);if(!n.useViewportCamera){p._vkZoomTo(y,n.margin)}f.adjustClipPlanes(y);var w=o.children[o.children.length-1].clone();var C=w.children[0];C.position.copy(p.position);C.updateMatrix();C.updateMatrixWorld(true);m.add(w);var R=[];if(u!=null){u.enumerateSelection(function(e){R.push(e)});u.setSelectionState(R,false,false,true)}s.render(m,p);if(u!=null&&R.length>0){u.setSelectionState(R,true,false,true)}if(_.length>0){_.forEach(function(e){e.visible=true})}m.remove(w);m.children=[]}finally{if(u&&u.revertNodeStates){u.revertNodeStates()}}var S=s.getContext().canvas.toDataURL(n.type,n.encoderOptions);document.body.removeChild(s.domElement);s.dispose();if(c&&r){this.setBackgroundColorBottom(c)}if(d&&a){this.setBackgroundColorTop(d)}return S};O.prototype._setContent=function(e){N._setContent.apply(this,arguments);var t=null;var i;var r;if(this._scene){q(this,this._scene)}if(e){t=e;if(!(t instanceof T)){t=null}i=e.camera;if(i instanceof h){r=t._computeBoundingBox(true,true);var a=new THREE.Vector3;r.getCenter(a);var n=i.getTargetDirection();var o=i.getPosition();var s=[a.x-o[0],a.y-o[1],a.z-o[2]];var d=s[0]*n[0]+s[1]*n[1]+s[2]*n[2];if(d<0){var c=r.getSize().length()/2;c-=d;o[0]-=n[0]*c;o[1]-=n[1]*c;o[2]-=n[2]*c;i.setPosition(o)}}else if(!(i instanceof l)){i=new l;if(e.builders&&e.builders.length>0){r=t._computeBoundingBox(true,true);if(!r.isEmpty()){i.setFov(14.27);var u;if(e.upAxis===4){u=new THREE.Euler(THREE.Math.degToRad(90-30),0,THREE.Math.degToRad(55-90),"ZXY")}else{u=new THREE.Euler(THREE.Math.degToRad(-30),THREE.Math.degToRad(55-90),0,"YXZ")}this.setCamera(i);this._viewportGestureHandler.zoomTo(r,(new THREE.Quaternion).setFromEuler(u),0,0,null,false)}}}var g;if(e.loaders){for(g=0;g<e.loaders.length;g++){if(e.loaders[g]instanceof k){this._cdsLoader=e.loaders[g];this._cdsLoader.getSceneBuilder()._fireSceneUpdated=this.setShouldRenderFrame.bind(this);this._cdsLoader.attachSceneUpdated(this._handleCdsSceneUpdate,this);this._cdsLoader.attachLoadingFinished(this._handleLoadingFinished,this);this._cdsLoader.attachInitialViewCompleted(this.setShouldRenderFrame,this);break}}}if(e.builders){for(g=0;g<e.builders.length;g++){e.builders[g]._fireSceneUpdated=this.setShouldRenderFrame.bind(this);e.builders[g]._fireLoadingFinished=function(e){this.setRenderMode(this.getRenderMode())}.bind(this)}}}else if(this._cdsLoader){this._cdsLoader.detachSceneUpdated(this._handleCdsSceneUpdate,this);this._cdsLoader.detachLoadingFinished(this._handleLoadingFinished,this);this._cdsLoader.detachInitialViewCompleted(this.setShouldRenderFrame,this);this._cdsLoader=null}if(t){U(this,t)}this.setScene(t);if(i){this.setCamera(i)}if(e){if(e.backgroundTopColor!==undefined){this.setBackgroundColorTop(new THREE.Color(e.backgroundTopColor).getStyle())}if(e.backgroundBottomColor!==undefined){this.setBackgroundColorBottom(new THREE.Color(e.backgroundBottomColor).getStyle())}if(e.renderMode!==undefined){this.setRenderMode(e.renderMode)}this._upAxis=e.upAxis||2}if(this._measurementSurface!=null){this._measurementSurface.setScale(1)}return this};O.prototype.getCurrentView=function(){return this._currentView};O.prototype._onViewStateApplied=function(e,t,i){if(i.source!=this._getViewStateManagerThreeJS()||!this._scene){return}this._ignoreAnimationPosition=i.ignoreAnimationPosition;this.activateView(i.view,i.playViewGroup,i.notAnimateCameraChange)};O.prototype._activateSingleView=function(t,i,r){var a=this._scene.getViewGroups();var n=this;if(a){a.forEach(function(e){e.getViews().forEach(function(i){if(i===t){n._currentViewIndex=e.getViews().indexOf(i)}})})}this.fireViewActivated({viewIndex:this._currentViewIndex,view:t});e.getEventBus().publish("sap.ui.vk","viewActivated",{source:this,view:t,viewIndex:this._currentViewIndex});this._currentView=t;var o=t.getTopColor();if(o!=null){if(Array.isArray(o)&&o.length>2){this.setBackgroundColorTop(new THREE.Color(o[0],o[1],o[2]).getStyle())}else{this.setBackgroundColorTop(new THREE.Color(o).getStyle())}}var s=t.getBottomColor();if(s!=null){if(Array.isArray(s)&&s.length>2){this.setBackgroundColorBottom(new THREE.Color(s[0],s[1],s[2]).getStyle())}else{this.setBackgroundColorBottom(new THREE.Color(s).getStyle())}}if(t.renderMode!==undefined){this.setRenderMode(t.renderMode)}var h=t.getCamera();var l=this._getNativeScene();if(h){var d=h.getCameraRef();if(d.type==="OrthographicCamera"&&l){var c=h.getPosition();var u=this.getScene();if(u){var g=new THREE.Box3;if(l){l._expandBoundingBox(g,true,true)}var f=new THREE.Vector3;g.getCenter(f);var p=h.getTargetDirection();var v=[f.x-c[0],f.y-c[1],f.z-c[2]];var _=v[0]*p[0]+v[1]*p[1]+v[2]*p[2];if(_<0){var m=g.getSize().length()/2;m-=_;c[0]-=p[0]*m;c[1]-=p[1]*m;c[2]-=p[2]*m}}h.setPosition(c)}}var y=this._getViewStateManagerThreeJS();var w=t.flyToTime!=null?t.flyToTime:2e3;var C;if(y&&y._fadeOutBackground&&y._fadeInBackground&&y._fadeOutBackground!==y._fadeInBackground&&y._fadeOutBackground.name==="sphere"){C="zoomIn";h=h||this.getCamera()}var R=0;if(h){var S=i&&!t.hasAnimation();R=this._viewportGestureHandler.activateCamera(h.getCameraRef(),r?0:w,S,C)}else{this.cameraUpdateCompleted()}var E=0;if(!r){E=y._startTransition(R>0?R:w,t)}if(this.getSafeArea()){this.getSafeArea().resize()}setTimeout(function(){if(y){y.fireReadyForAnimation({view:t,ignoreAnimationPosition:this._ignoreAnimationPosition});e.getEventBus().publish("sap.ui.vk","readyForAnimation",{source:y,view:t,ignoreAnimationPosition:this._ignoreAnimationPosition});y._startHighlight()}}.bind(this),Math.max(E,R)+100)};O.prototype.resetCurrentView=function(){if(!this._currentView){return this}this._getViewStateManagerThreeJS()._resetNodesMaterialAndOpacityByCurrentView(this._currentView);this._getViewStateManagerThreeJS()._resetNodesStatusByCurrentView(this._currentView,true,true);this.setShouldRenderFrame();return this};O.prototype.activateView=function(e,t,i){if(this._isRedlineActivated()){B.error("activateView() method is disabled when Redlining is activated");return this}this._clearAnnotations();this._activateSingleView(e,t,i);return this};O.prototype.zoomTo=function(e,t,i,r){var a=this._getNativeScene();var n=this._getNativeCamera();if(!n||!a){return this}r=r||0;var o=new THREE.Box3;var s=null;var h=null;(Array.isArray(e)?e:[e]).forEach(function(e){switch(e){case _.All:a._expandBoundingBox(o,false,true);break;case _.Visible:a._expandBoundingBox(o,true,true);break;case _.Selected:var i=this._getViewStateManagerThreeJS();if(i){i.enumerateSelection(function(e){e._expandBoundingBox(o,false,true)})}break;case _.Node:if(!t){return this}h=t;if(Array.isArray(t)){t.forEach(function(e){e._expandBoundingBox(o,false,true)})}else{t._expandBoundingBox(o,false,true)}break;case _.Restore:B.error(w().getText("VIEWPORT_MSG_RESTORENOTIMPLEMENTED"));return this;case _.NodeSetIsolation:B.error(w().getText("VIEWPORT_MSG_NODESETISOLATIONNOTIMPLEMENTED"));return this;case _.RestoreRemoveIsolation:B.error(w().getText("VIEWPORT_MSG_RESTOREREMOVEISOLATIONNOTIMPLEMENTED"));return this;case _.ViewLeft:s=(new THREE.Quaternion).setFromAxisAngle(new THREE.Vector3(0,1,0),-Math.PI/2);break;case _.ViewRight:s=(new THREE.Quaternion).setFromAxisAngle(new THREE.Vector3(0,1,0),Math.PI/2);break;case _.ViewTop:s=(new THREE.Quaternion).setFromAxisAngle(new THREE.Vector3(1,0,0),-Math.PI/2);break;case _.ViewBottom:s=(new THREE.Quaternion).setFromAxisAngle(new THREE.Vector3(1,0,0),Math.PI/2);break;case _.ViewBack:s=(new THREE.Quaternion).setFromAxisAngle(new THREE.Vector3(0,1,0),Math.PI);break;case _.ViewFront:s=(new THREE.Quaternion).setFromAxisAngle(new THREE.Vector3(0,1,0),0);break;default:break}}.bind(this));if(!o.isEmpty()){this._viewportGestureHandler.zoomTo(o,s,r,i*1e3,h,h!==null)}return this};O.prototype.pan=function(e,t){this._viewportGestureHandler._cameraController.pan(e,t)};O.prototype.rotate=function(e,t,i){this._viewportGestureHandler._cameraController.rotate(e,t,i)};O.prototype.zoom=function(e){this._viewportGestureHandler._cameraController.zoom(e)};O.prototype.getViewInfo=function(e){var t={};if(e==null){e={}}if(e.camera==null){e.camera=true}var i=this._getNativeCamera();if(e.camera&&i){var r=i.rotation.clone();r.reorder("YXZ");t.camera={rotation:{yaw:THREE.Math.radToDeg(r.y),pitch:THREE.Math.radToDeg(r.x),roll:THREE.Math.radToDeg(r.z)},position:{x:i.position.x,y:i.position.y,z:i.position.z},projectionType:i.isOrthographicCamera?f.Orthographic:f.Perspective,bindingType:p.Vertical};var a=i.view;if(a&&a.enabled){t.camera.view={fullWidth:a.fullWidth,fullHeight:a.fullHeight,offsetX:a.offsetX,offsetY:a.offsetY,width:a.width,height:a.height}}if(t.camera.projectionType===f.Perspective){t.camera.fieldOfView=i.fov}else if(t.camera.projectionType===f.Orthographic){t.camera.zoomFactor=i.zoom}if(e.camera.matrices){t.camera.matrices={view:i.matrixWorldInverse.elements.slice(),projection:i.projectionMatrix.elements.slice()}}}if(e.visibility&&this._viewStateManager){var n=e.visibility.mode==null?v.Complete:e.visibility.mode;t.visibility={mode:n};if(n===v.Complete){var o=this._viewStateManager.getVisibilityComplete();t.visibility.visible=o.visible;t.visibility.hidden=o.hidden}else if(this._viewStateManager.getShouldTrackVisibilityChanges()){t.visibility.changes=this._viewStateManager.getVisibilityChanges()}else{B.warning(w().getText(c.VIT32.summary),c.VIT32.code,"sap.ui.vk.threejs.Viewport")}}var s=this._getViewStateManagerThreeJS();if(e.selection&&s){t.selection=s._getSelectionComplete()}return t};O.prototype.setViewInfo=function(e,t){var i=this._getNativeCamera();if(e.camera&&i){var r=e.camera;var a=r.projectionType===f.Orthographic?new THREE.OrthographicCamera:new THREE.PerspectiveCamera;a.userData=i.userData;a.aspect=i.aspect;a.position.copy(r.position);var n=r.rotation;a.quaternion.setFromEuler(new THREE.Euler(THREE.Math.degToRad(n.pitch),THREE.Math.degToRad(n.yaw),THREE.Math.degToRad(n.roll),"YXZ"));a.fov=r.fieldOfView||a.fov;a.zoom=r.zoomFactor||a.zoom;a.updateMatrix();a.up.setFromMatrixColumn(a.matrix,1).normalize();if(i.view&&i.view.enabled){var o=r.view||i.view;a.setViewOffset(o.fullWidth,o.fullHeight,o.offsetX,o.offsetY,o.width,o.height);if(i.isPerspectiveCamera){a.aspect=o.fullWidth/o.fullHeight;a.zoom=Math.min(a.aspect,1)}}this._viewportGestureHandler.activateCamera(a,(t||0)*1e3)}var s=new Map;if(e.visibility||e.selection){var h=this._viewStateManager.getNodeHierarchy();if(h){var l=h.findNodesByName();l.forEach(function(e){var t=h.createNodeProxy(e);var i=t.getVeId();h.destroyNodeProxy(t);if(i){s.set(i,e)}})}}if(e.visibility){switch(e.visibility.mode){case v.Complete:var d=e.visibility.visible,u=e.visibility.hidden;d.forEach(function(e){this._viewStateManager.setVisibilityState(s.get(e),true,false)},this);u.forEach(function(e){this._viewStateManager.setVisibilityState(s.get(e),false,false)},this);break;case v.Differences:this._viewStateManager.resetVisibility();e.visibility.changes.forEach(function(e){var t=s.get(e);if(t){this._viewStateManager.setVisibilityState(t,!this._viewStateManager.getVisibilityState(t),false)}},this);break;default:B.error(w().getText(c.VIT28.summary),c.VIT28.code,"sap.ui.vk.threejs.Viewport");break}}var g=this._getViewStateManagerThreeJS();var p=e.selection;if(p&&g){var _=g._getSelectionComplete();if(Array.isArray(p.selected)){var m=[];var y=[];p.selected.forEach(function(e){var t=s.get(e);if(t){m.push(t)}});_.selected.forEach(function(e){var t=s.get(e);if(t&&p.selected.indexOf(e)<0){y.push(t)}});g.setSelectionStates(m,y,false,false)}if(Array.isArray(p.outlined)){var C=[];var R=[];p.outlined.forEach(function(e){var t=s.get(e);if(t){C.push(t)}});_.outlined.forEach(function(e){var t=s.get(e);if(t&&p.outlined.indexOf(e)<0){R.push(t)}});g.setOutliningStates(C,R,false,false)}}this.setShouldRenderFrame();return this};O.prototype.queueCommand=function(e){if(this instanceof O){e()}return this};O.prototype.getOutputSize=function(){var e=this.getDomRef().getBoundingClientRect();var t=e.width;var i=e.height;var r;r=Math.min(t,i);return{left:(t-r)/2,top:(i-r)/2,sideLength:r}};O.prototype.projectToScreen=function(e,t,i,r){var a=this.getDomRef().getBoundingClientRect();var n=a.width/2;var o=a.height/2;var s=new THREE.Vector3(e,t,i).project(r.getCameraRef());return{x:n+s.x*n,y:o-s.y*o,depth:s.z}};O.prototype.getAnnotations=function(){if(this.getScene()==null||this._annotationsLoaded){return this.getAggregation("annotations")||[]}if(this.getScene().annotations){var e=[];var t=this.getCurrentView();if(t){t.getNodeInfos().forEach(function(t){if(t.target._vkGetNodeContentType()===H.Annotation){e.push(t)}})}this.getScene().annotations.forEach(function(i){var r=null;if(t){for(var a=0;a<e.length;a++){var n=e[a];if(n.target._vkPersistentId()===i.node._vkPersistentId()&&(n.annotationId===i.annotation.id||n.annotationId===undefined)){i.node.visible=n.visible;r=M.createAnnotation(i,this);r.autoGenerated=true;this.addAnnotation(r);break}}}else{r=M.createAnnotation(i,this);r.autoGenerated=true;this.addAnnotation(r)}if(r){var o=this._viewStateManager.getVisibilityState(i.node);r.setDisplay(o)}}.bind(this));var i=this.getAggregation("annotations")||[];var r=0;i.forEach(function(e){if(e.getAnimate()&&e.getAnimationDelay()===-1){e.setAnimationDelay(r++)}})}this._annotationsLoaded=true;return this.getAggregation("annotations")||[]};O.prototype.setBackgroundNode=function(e){var t=this._viewStateManager.getNodeHierarchy();var i;var r=t.findNodesByName().reduce(function(e,t){if(t._vkGetNodeContentType()===H.Background){if(this._viewStateManager.getVisibilityState(t)){i=t}e.push(t)}return e}.bind(this),[]);if(!e){this._viewStateManager.setVisibilityState(r,true,false);this._viewStateManager.setVisibilityState(i,false,false);this._viewportGestureHandler.setView(null,1e3)}else{var a=e.parametricContent;var n=a.materialId;var o=e.sceneId;var s=t.createNode(i&&i.parent,a.type,null,H.Background,{parametricContent:a});this._viewStateManager.setVisibilityState(r,false,false);r.push(s);if(this._cdsLoader){this._cdsLoader.assignMaterialToNodes(o,n,s.children)}var h=a.type==="plane"?(new THREE.Quaternion).setFromAxisAngle(new THREE.Vector3(0,1,0),0):null;this._viewportGestureHandler.setView(h,1e3)}return r};O.prototype.normalizeRectangle=function(e,t,i,r){var a=this.getSafeArea().getDomRef();if(a==null){a=this.getDomRef()}var n=window.getComputedStyle(a);var o=parseFloat(n.width);var s=parseFloat(n.left);var h=(e-s)/o-.5;var l=parseFloat(n.height);var d=parseFloat(n.top);var c=(t-d)/l-.5;return{x:h,y:c,width:i/o,height:r/l}};O.prototype.deNormalizeRectangle=function(e,t,i,r){var a=this.getSafeArea().getDomRef();if(a==null){a=this.getDomRef()}var n=window.getComputedStyle(a);var o=parseFloat(n.width);var s=parseFloat(n.left);var h=o/2;var l=s+h;var d=Math.abs(e)*2;if(e<0){d=1-d;d*=h;d+=s}else if(e>0){d*=h;d+=l}else{d=l}var c=Math.abs(i)*2*h;var u=parseFloat(n.height);var g=parseFloat(n.top);var f=u/2;var p=g+f;var v=Math.abs(t)*2;if(t<0){v=1-v;v*=f;v+=g}else if(t>0){v*=f;v+=p}else{v=p}var _=Math.abs(r)*2*f;return{x:d,y:v,width:c,height:_}};var W=[];function U(e,t){var i=L(W,function(e){return e.scene===t});if(i<0){var r=new THREE.WebGLRenderer({antialias:true,alpha:true});r.setPixelRatio(window.devicePixelRatio);r.setSize(1,1);r.shadowMap.enabled=true;e._registryEntry={scene:t,webGLRenderer:r,viewports:[e]};W.push(e._registryEntry);e._renderer=r;e._canvas=r.domElement;e.invalidate()}else{var a=W[i];var n=a.viewports;var o=n.indexOf(e);if(o<0){if(n.length==1){var s=n[0];s._canvas=document.createElement("canvas");s.invalidate()}n.push(e);e._registryEntry=a;e._renderer=a.webGLRenderer;e._canvas=document.createElement("canvas");e.invalidate()}}}function q(e,t){var i=L(W,function(e){return e.scene===t});if(i<0){return}var r=W[i];var a=r.viewports;var n=a.indexOf(e);if(n<0){return}a.splice(n,1);if(a.length==1){var o=a[0];o._canvas=r.webGLRenderer.domElement;o.invalidate()}else if(a.length===0){r.webGLRenderer.renderLists.dispose();r.webGLRenderer.dispose();W.splice(i,1)}e._registryEntry=null;e._canvas=null;e._renderer=null;e.invalidate()}function J(e){var t=0;var i=0;e.viewports.forEach(function(e){t=Math.max(t,e._width);i=Math.max(i,e._height)});e.webGLRenderer.setSize(t,i,true)}O.prototype.getMeasurementSurface=function(){return this._measurementSurface};return O});
//# sourceMappingURL=Viewport.js.map