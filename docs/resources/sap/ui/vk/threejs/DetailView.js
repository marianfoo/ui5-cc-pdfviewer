/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
 */
sap.ui.define(["../thirdparty/three","sap/ui/base/ManagedObject","../thirdparty/html2canvas","../DetailViewType","../DetailViewShape","./OrthographicCamera","./PerspectiveCamera"],function(e,t,r,i,a,o,n){"use strict";var s=t.extend("sap.ui.vk.threejs.DetailView",{metadata:{library:"sap.ui.vk",properties:{name:{type:"string",defaultValue:""},camera:{type:"any",defaultValue:null},type:{type:"sap.ui.vk.DetailViewType",defaultValue:i.DetailView},shape:{type:"sap.ui.vk.DetailViewShape",defaultValue:a.Box},borderWidth:{type:"float",defaultValue:2},backgroundColor:{type:"sap.ui.core.CSSColor",defaultValue:"#fff"},borderColor:{type:"sap.ui.core.CSSColor",defaultValue:"#000"},origin:{type:"any",defaultValue:new THREE.Vector2(0,0)},size:{type:"any",defaultValue:new THREE.Vector2(.5,.5)},attachmentPoint:{type:"any",defaultValue:null},metadata:{type:"any",defaultValue:{}},veId:{type:"any",defaultValue:{}},visibleNodes:{type:"any",defaultValue:null},targetNodes:{type:"any",defaultValue:null}}}});s.prototype.init=function(){if(t.prototype.init){t.prototype.init.call(this)}this._backgroundColor=new THREE.Color;this._node=new THREE.Group;var e=new THREE.MeshBasicMaterial({depthTest:false});this._line=new THREE.Mesh(new THREE.BufferGeometry,e);this._line.renderOrder=0;this._node.add(this._line);var r=new THREE.BufferGeometry;r.setIndex([0,1,2]);var i=new THREE.MeshBasicMaterial({color:this._backgroundColor,depthTest:false});this._triangle=new THREE.Mesh(r,i);this._triangle.renderOrder=1;this._node.add(this._triangle);this._billboard=new THREE.Mesh(new THREE.BufferGeometry,new THREE.MeshBasicMaterial({depthTest:false}));this._billboard.renderOrder=2;this._node.add(this._billboard);this._border=new THREE.Mesh(new THREE.BufferGeometry,e);this._border.renderOrder=3;this._node.add(this._border)};s.prototype.setCamera=function(e){if(e instanceof n||e instanceof o){this.setProperty("camera",e,true)}return this};s.prototype.setShape=function(e){this.setProperty("shape",e,true);return this};s.prototype.setBackgroundColor=function(e){this.setProperty("backgroundColor",e,true);this._backgroundColor.setStyle(e);this._triangle.material.color.copy(this._backgroundColor);return this};s.prototype.setBorderColor=function(e){this.setProperty("borderColor",e,true);this._border.material.map=null;return this};s.prototype.setBorderWidth=function(e){this.setProperty("borderWidth",e,true);this._border.material.map=null;return this};s.prototype.setOrigin=function(e){if(e instanceof THREE.Vector2){this.setProperty("origin",e,true)}return this};s.prototype.setSize=function(e){if(e instanceof THREE.Vector2){this.setProperty("size",e,true)}return this};var l=-.5,h=1.5,u=new THREE.Vector4,p=new THREE.Vector3,d=new THREE.Vector3,c=new THREE.Vector3,f=new THREE.Vector2,y=new THREE.Vector2,E=new THREE.Vector2,v=new THREE.Matrix4;function b(e,t){return Math.PI*(3*(e+t)-Math.sqrt((3*e+t)*(e+3*t)))}function _(e,t,r,i,a,o){var n=e[t],s=e[t+1],l=e[a],h=e[a+1],u=e[o],p=e[o+1],d=i-s,c=n-r;var f=((l-n)*d+(h-s)*c)/((l-u)*d+(h-p)*c);e[a]=l+(u-l)*f;e[a+1]=h+(p-h)*f}function g(e,t,r,i){f.set(e[r+1]-e[t+1],e[t]-e[r]).normalize().multiplyScalar(i);e[t]+=f.x;e[t+1]+=f.y;e[r]+=f.x;e[r+1]+=f.y}function m(e,t){var r=e.length;for(var i=0;i<6;i+=3){var a=i===0?t*l:t*h;var o=e[i],n=e[i+1];for(var s=i;s<r-6;s+=6){var u=e[s],p=e[s+1];e[s]=o;e[s+1]=n;o=e[s+6];n=e[s+7];g(e,s,s+6,a);if(s>i){_(e,s-6,u,p,s,s+6)}}}}s.prototype._createBoxViewport=function(e,t,r,i){var a=[-e,-t,0,e,-t,0,e,t,0,-e,t,0];var o=this._billboard.geometry;o.setIndex([0,1,2,0,2,3]);o.setAttribute("position",new THREE.Float32BufferAttribute(a,3));o.setAttribute("uv",new THREE.Float32BufferAttribute([0,0,1,0,1,1,0,1],2));if(this._border.visible){var n=[],s;for(s=0;s<a.length;s+=3){var l=a[s],h=a[s+1];n.push(l,h,0,l,h,0)}n.push(n[0],n[1],0,n[0],n[1],0);m(n,this._borderWidth);s=n.length-6;n[0]=n[s];n[s+1]=n[1];n[3]=n[s+3];n[s+4]=n[4];this._createBorderGeometry(this._border.geometry,n)}};s.prototype._createCircleViewport=function(e,t,r,i){var a=[0,0,0],o=[.5,.5],n=[];var s=THREE.Math.clamp(Math.round(b(e,t)/24),32,256);var l=2*Math.PI/s;for(var u=0;u<s;u++){var p=u*l,d=Math.cos(p),c=Math.sin(p);a.push(d*e,c*t,0);o.push(d*.5+.5,c*.5+.5);n.push(0,u+1,u+1<s?u+2:1)}var y=this._billboard.geometry;y.setIndex(n);y.setAttribute("position",new THREE.Float32BufferAttribute(a,3));y.setAttribute("uv",new THREE.Float32BufferAttribute(o,2));var E=this._borderWidth*h;this._createCircleBorder(a,e,t,r&&f.set(r.x/(e+E),r.y/(t+E)).length()>1?r:null,i)};s.prototype._createCircleBorder=function(e,t,r,i,o){var n=this._borderWidth,s=[],u,p,d;if(i&&(o!==a.Circle&&o!==a.CircleLine)){s.push(i.x,i.y,0,i.x,i.y,0);var c=Math.PI*.05;var y=Math.atan2(i.y*t,i.x*r)+c;var E=e.length/3-3;c=2*(Math.PI-c)/E;for(u=0;u<=E;u++){var v=y+u*c;p=Math.cos(v)*t;d=Math.sin(v)*r;s.push(p,d,0,p,d,0)}var b=[i.x,i.y,0,s[6],s[7],0,s[s.length-3],s[s.length-2],0];s.push(i.x,i.y,0,i.x,i.y,0);m(s,n);u=s.length-6;var _=f.set(s[9],s[10]).sub(i).length();var g=f.set(s[9]-s[u-3],s[10]-s[u-2]).length()*.5;var T=i.length();T=1-n*2*_/(g*T);s[u+0]=s[0]=i.x*T;s[u+1]=s[1]=i.y*T;s[u+3]=s[3]=i.x;s[u+4]=s[4]=i.y;var x=this._triangle.geometry;T=(1+T)*.5;b[0]*=T;b[1]*=T;x.setAttribute("position",new THREE.Float32BufferAttribute(b,3));this._triangle.visible=true;this._triangle.material.color.set(o===a.SolidPointer||o===a.SolidArrow?this.getBorderColor():this._backgroundColor)}else{this._line.visible=this._line.visible&&i!==null;for(u=3;u<e.length;u+=3){p=e[u];d=e[u+1];s.push(p,d,0,p,d,0)}s.push(s[0],s[1],0,s[0],s[1],0);m(s,n);u=s.length-6;s[u]=s[0]=e[3]+n*l;s[u+3]=s[3]=e[3]+n*h;s[u+1]=s[1]=e[4];s[u+4]=s[4]=e[4]}this._createBorderGeometry(this._border.geometry,s)};s.prototype._createBorderGeometry=function(e,t){var r,i=t.length/3;var a=[];for(r=2;r<i;r+=2){a.push(r-1,r,r-2,r+1,r,r-1)}var o=[];var n=this._borderU;for(r=0;r<i;r+=2){o.push(0,.5,n,.5)}e.setIndex(a);e.setAttribute("position",new THREE.Float32BufferAttribute(t,3));e.setAttribute("uv",new THREE.Float32BufferAttribute(o,2))};s.prototype._createLine=function(e){var t=[0,0,0,0,0,0,e.x,e.y,0,e.x,e.y,0];g(t,0,6,-this._borderWidth);g(t,3,9,this._borderWidth);this._createBorderGeometry(this._line.geometry,t)};s.prototype._updateGeometry=function(e,t,r){var i=this.getShape(),o=this.getAttachmentPoint(),n=this.getOrigin();this._border.visible=i!==a.BoxNoOutline;this._line.visible=i===a.BoxLine||i===a.CircleLine;this._triangle.visible=false;if(o){u.copy(o).applyMatrix4(r.matrixWorldInverse).applyMatrix4(r.projectionMatrix);o=u.w>0?o:null;var s=u.x/u.w*t.x/t.y,l=u.y/u.w;c.set(s-n.x,l-n.y,0).multiplyScalar(t.y)}switch(i){default:case a.Box:case a.BoxLine:case a.BoxNoOutline:this._createBoxViewport(e.x,e.y,o?c:null,i);break;case a.Circle:case a.CircleLine:case a.CirclePointer:case a.CircleArrow:case a.CircleBubbles:case a.SolidPointer:case a.SolidArrow:this._createCircleViewport(e.x,e.y,o?c:null,i);break}if(this._line.visible){this._createLine(c)}};s.prototype._updateBorderTexture=function(e){var t=Math.round(this.getBorderWidth()*e);this._borderWidth=t+2;var r=THREE.Math.ceilPowerOfTwo(this._borderWidth);this._borderU=this._borderWidth/r;this._borderWidth/=e;var i=new ArrayBuffer(r*4);var a=new Uint32Array(i);var o=new THREE.Color(this.getBorderColor());o=o.r*255|o.g*255<<8|o.b*255<<16|4278190080;a.fill(o&16777215);for(var n=1;n<=t;n++){a[n]=o}var s=new THREE.DataTexture(new Uint8Array(i),r,1,THREE.RGBAFormat,THREE.UnsignedByteType,THREE.UVMapping,THREE.ClampToEdgeWrapping,THREE.ClampToEdgeWrapping,THREE.LinearFilter,THREE.LinearFilter);s.needsUpdate=true;this._border.material.map=s;this._border.material.needsUpdate=true;this._line.material=this._border.material};function T(e){var t=e.elements;var r=t[15]===1;var i=2/t[0];var a=2/t[5];var o,n;if(r){o=-t[12]*i;n=-t[13]*a}else{o=t[8]*i;n=t[9]*a}var s=(i+o)*.5;var l=o-s;var h=(a+n)*.5;var u=n-h;return{left:l,top:h,right:s,bottom:u}}function x(e,t){var r=e.elements;var i=r[15]===1;r[0]=2/(t.right-t.left);r[5]=2/(t.top-t.bottom);if(i){r[12]=-(t.right+t.left)/(t.right-t.left);r[13]=-(t.top+t.bottom)/(t.top-t.bottom)}else{r[8]=(t.right+t.left)/(t.right-t.left);r[9]=(t.top+t.bottom)/(t.top-t.bottom)}}function w(e,t,r,i){var a=r.x/i.x;var o=r.y/i.y;u.copy(t).applyMatrix4(e.matrixWorldInverse).applyMatrix4(e.projectionMatrix);var n=(u.x/u.w-a)*.5+.5;var s=(u.y/u.w-o)*.5+.5;var l=T(e.projectionMatrix);var h={};h.left=THREE.Math.lerp(l.left,l.right,n);h.right=THREE.Math.lerp(l.left,l.right,n+a);h.top=THREE.Math.lerp(l.top,l.bottom,1-s-o);h.bottom=THREE.Math.lerp(l.top,l.bottom,1-s);x(e.projectionMatrix,h)}var R=new THREE.Vector2;s.prototype._render=function(e,t,r,a,o){e.getSize(R);var n=e.getPixelRatio(),s=this.getOrigin(),l=this._node,h=l.position;if(!this._border.material.map){this._updateBorderTexture(n)}y.copy(this.getSize()).multiplyScalar(R.y*.5);y.set(Math.round(y.x)<<1,Math.round(y.y)<<1);h.set(s.x*R.y/R.x,s.y,0).unproject(t);u.copy(h).applyMatrix4(t.matrixWorldInverse).applyMatrix4(t.projectionMatrix);var c=(u.x/u.w*.5+.5)*R.x,f=(u.y/u.w*.5+.5)*R.y;var b=u.w/(R.x*t.projectionMatrix.elements[0]);l.scale.setScalar(b);p.setFromMatrixColumn(t.matrixWorld,0).multiplyScalar(b*2*(Math.round(c)-c));d.setFromMatrixColumn(t.matrixWorld,1).multiplyScalar(b*2*(Math.round(f)-f));h.add(p).add(d);l.quaternion.copy(t.quaternion);l.updateMatrix();l.updateMatrixWorld();this._updateGeometry(y,R,t);E.copy(y).multiplyScalar(n);if(!this._renderTarget||this._renderTarget.width!==E.x||this._renderTarget.height!==E.y){this._renderTarget=new THREE.WebGLRenderTarget(E.x,E.y,{minFilter:THREE.LinearFilter,magFilter:THREE.NearestFilter,format:THREE.RGBFormat});this._billboard.material.map=this._renderTarget.texture;this._billboard.material.needsUpdate=true}var _;if(this.getType()===i.Cutaway){_=t;v.copy(_.projectionMatrix);w(_,h,y,R)}else{_=this.getCamera();_.adjustClipPlanes(a);_.update(y.x,y.y);_=_.getCameraRef()}var g=new Set;r.children.forEach(function(t){if(t.userData._vkDynamicObjects){t.userData._vkDynamicObjects.forEach(function(t){if(t.parent){if(t.userData.is2D||t.isBillboard){if(t.visible){g.add(t)}t.visible=false}else{t._vkUpdate(e,_,y)}}})}});if(o){o.position.copy(_.position);o.updateMatrix();o.updateMatrixWorld()}var m=this.getTargetNodes();var T=this.getTargetNodes();if(Array.isArray(T)){m.forEach(function(e){e.userData._visible=e.visible;e.visible=true})}if(Array.isArray(T)){T.forEach(function(e){e.userData._visible=e.visible;e.visible=false})}e.setClearColor(this._backgroundColor,1);e.setRenderTarget(this._renderTarget);e.clear();e.render(r,_);if(_===t){t.projectionMatrix.copy(v)}if(Array.isArray(m)){m.forEach(function(e){e.visible=e.userData._visible})}if(Array.isArray(T)){T.forEach(function(e){e.visible=e.userData._visible})}e.setRenderTarget(null);e.render(this._node,t);r.children.forEach(function(e){if(e.userData._vkDynamicObjects){e.userData._vkDynamicObjects.forEach(function(e){if(e.parent&&(e.userData.is2D||e.isBillboard)){e.visible=g.has(e)}})}})};return s});
//# sourceMappingURL=DetailView.js.map