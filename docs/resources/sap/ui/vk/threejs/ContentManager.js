/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
 */
sap.ui.define(["sap/base/Log","../thirdparty/three","../ContentManager","./Scene","../TransformationMatrix","./PerspectiveCamera","./OrthographicCamera","../Messages","../getResourceBundle","./ContentDeliveryService","./Viewport","./ViewStateManager"],function(e,t,r,a,o,n,i,s,d,l){"use strict";var u=r.extend("sap.ui.vk.threejs.ContentManager",{metadata:{library:"sap.ui.vk"}});var c=u.getMetadata().getParent().getClass().prototype;u.prototype.init=function(){if(c.init){c.init.call(this)}};u.prototype.exit=function(){if(this.defaultCdsLoader){this.defaultCdsLoader.destroy();this.defaultCdsLoader=null}if(this.defaultMataiLoader){this.defaultMataiLoader.destroy();this.defaultMataiLoader=null}if(c.exit){c.exit.call(this)}};u.prototype._handleContentChangesProgress=function(e){this.fireContentChangesProgress({phase:e.getParameter("phase"),source:e.getParameter("source"),percentage:e.getParameter("percentage")})};u.prototype._handleContentLoadingFinished=function(e){this.fireContentLoadingFinished({source:e.getParameter("source"),node:e.getParameter("node")})};function h(e){if(e&&e.isMesh){e.castShadow=true;e.receiveShadow=false}if(e&&e.children){for(var t=0;t<e.children.length;t++){h(e.children[t])}}}function f(e,t){if(e){var r=new THREE.Group;e.add(r);r.name="DefaultLights";r.private=true;var a=(new THREE.Box3).setFromObject(e);var o=new THREE.Vector3;a.getSize(o);var n=o.length();var i=new THREE.PointLight;i.color.setRGB(.72,.72,.81);a.getCenter(i.position);i.visible=true;i.private=true;r.add(i);var s=[new THREE.Color(.2,.2,.2),new THREE.Color(.32,.32,.36),new THREE.Color(.36,.36,.36)];var d=[new THREE.Vector3(2,1.5,.5),new THREE.Vector3(-2,-1.1,2.5),new THREE.Vector3(-.04,-.01,-2)];for(var l=0,u=s.length;l<u;l++){var c=new THREE.DirectionalLight;c.color.copy(s[l]);c.position.copy(d[l]);c.private=true;r.add(c)}if(t){h(e);var f=new THREE.DirectionalLight;f.color.setRGB(.5,.5,.5);f.position.set(0,1,0);f.castShadow=true;f.shadow.mapSize.width=512;f.shadow.mapSize.height=512;var g=2e3;f.shadow.camera.left=-g;f.shadow.camera.right=g;f.shadow.camera.top=g;f.shadow.camera.bottom=-g;f.shadow.camera.far=3500;f.shadow.bias=-1e-4;f.private=true;r.add(f);var p=new THREE.PlaneBufferGeometry(a.getSize().x,a.getSize().z);var C=new THREE.ShadowMaterial;C.opacity=.2;var v=new THREE.Mesh(p,C);v.rotation.x=-Math.PI/2;v.position.x=a.getCenter().x;v.position.y=a.min.y-n*.1;v.position.z=a.getCenter().z;e.add(v);v.receiveShadow=true}}}u.prototype.loadContent=function(t,r){var o=this;var n=function(){o.fireContentChangesStarted();var t=new THREE.Scene,n=new a(t);o._loadContentResources(n,r).then(function(t){e.info("Content loading resolved");if(t&&t.length>0&&t[0].initialView){n.setInitialView(t[0].initialView)}for(var r=0;r<t.length;r++){if(t[r].camera){n.camera=t[r].camera;break}}if(t.length>0){var a=t[0];n.backgroundTopColor=a.backgroundTopColor;n.backgroundBottomColor=a.backgroundBottomColor;n.renderMode=a.renderMode;n.upAxis=a.upAxis;n.annotations=a.annotations}for(var i=0;i<t.length;i++){if(t[i].loader){n.loaders=n.loaders||[];n.loaders.push(t[i].loader)}if(t[i].builder){n.builders=n.builders||[];n.builders.push(t[i].builder)}}if(n.loaders){o._initSceneWithCDSLoaderIfExists(n,n.loaders)}f(n.getSceneRef(),false);o.fireContentChangesFinished({content:n})},function(t){e.info("Content loading rejected:",t);var r;if(typeof t==="string"){r=t}else if(t.errorText){r=t.errorText}else if(t.message){r=t.message}r=r||d().getText(s.VIT37.summary);e.error(d().getText("CONTENTMANAGER_MSG_CONTENTRESOURCESFAILEDTOLOAD"),r);o.fireContentChangesFinished({content:null,failureReason:[{error:t,errorMessage:r}]})})};n();return this};u.prototype._findLoader=function(e){if(e._contentManagerResolver&&e._contentManagerResolver.settings&&e._contentManagerResolver.settings.loader){return Promise.resolve(e._contentManagerResolver.settings.loader)}if(e.getSource()){var t=e.getSourceType().toLowerCase();var r=this;switch(t){case"stream":{if(this.defaultCdsLoader==null){return new Promise(function(e){var t="sap/ui/vk/threejs/ContentDeliveryService";sap.ui.require([t],function(t){e(r.defaultCdsLoader=new t({authorizationHandler:r._authorizationHandler}))})})}return Promise.resolve(this.defaultCdsLoader)}case"vds4":{if(this.defaultMataiLoader==null){return new Promise(function(e){var t="sap/ui/vk/matai/MataiLoader";sap.ui.require([t],function(t){e(r.defaultMataiLoader=new t)})})}return Promise.resolve(this.defaultMataiLoader)}default:break}}return Promise.resolve(null)};u.prototype._loadContentResources=function(e,t){var r=[];t.forEach(function t(a,n){var i=new THREE.Group;i.name=n.getName();i.sourceId=n.getSourceId();n._shadowContentResource={nodeProxy:e.getDefaultNodeHierarchy().createNodeProxy(i)};var s=n.getLocalMatrix();if(s){i.applyMatrix4((new THREE.Matrix4).fromArray(o.convertTo4x4(s)))}a.add(i);var d=this;r.push(this._findLoader(n).then(function(e){if(e){if(e.attachContentChangesProgress){e.attachContentChangesProgress(d._handleContentChangesProgress,d)}if(e.attachContentLoadingFinished){e.attachContentLoadingFinished(d._handleContentLoadingFinished,d)}}if(typeof e==="function"){return e(i,n,d._authorizationHandler,d._retryCount)}else if(e&&e.load){return e.load(i,n,d._authorizationHandler,d._retryCount)}else{return Promise.resolve({node:i,contentResource:n})}}));n.getContentResources().forEach(t.bind(this,i))}.bind(this,e.getSceneRef()));return Promise.all(r)};u.prototype._initSceneWithCDSLoaderIfExists=function(e,t){if(t){var r;for(var a=0;a<t.length;a++){if(t[a]instanceof l){r=t[a].getSceneBuilder();break}}if(r){e.setSceneBuilder(r);e.getDefaultNodeHierarchy().attachNodeRemoving(function(e){var t=e.getParameter("nodeRef");if(t.userData.treeNode&&t.userData.treeNode.sid){r.decrementResourceCountersForDeletedTreeNode(t.userData.treeNode.sid)}});return true}}return false};u.prototype.destroyContent=function(e){if(e){e.destroy()}if(e.loaders&&Array.isArray(e.loaders)&&e.loaders.length>0){if(e.loaders[0]._loader&&e.loaders[0]._loader.sceneBuilder){e.loaders[0]._loader.removeContext(e.loaders[0]._loader.currentSceneInfo.id);e.loaders[0]._loader.sceneBuilder.cleanup()}if(e.loaders[0].detachContentChangesProgress){e.loaders[0].detachContentChangesProgress(this._handleContentChangesProgress,this)}if(e.loaders[0].detachContentLoadingFinished){e.loaders[0].detachContentLoadingFinished(this._handleContentLoadingFinished,this)}}else if(e.builders&&Array.isArray(e.builders)){e.builders.forEach(function(e){if(e){e.cleanup()}})}return this};u.prototype.createOrthographicCamera=function(){return new i};u.prototype.createPerspectiveCamera=function(){return new n};return u});
//# sourceMappingURL=ContentManager.js.map