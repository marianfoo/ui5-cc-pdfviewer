/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
 */
sap.ui.define(["../thirdparty/three","sap/base/Log","./BBoxSubdivider","./UsageCounter","../totara/TotaraUtils","./OrthographicCamera","./PerspectiveCamera","./DetailView","./AnimationHelper","./Thrustline","../View","./Billboard","./Callout","../BillboardCoordinateSpace","../BillboardTextEncoding","../BillboardStyle","../BillboardBorderLineStyle","../BillboardHorizontalAlignment","../LeaderLineMarkStyle","../DetailViewType","../DetailViewShape","../AnimationPlayback","../AnimationRotateType","../RenderMode","./Material","./MaterialType","./SphericalMapMaterial","../ObjectType","./MarchingCubes","./ParametricGenerators","../NodeContentType","./ThreeExtensions","sap/base/util/uid","./ThreeUtils","sap/base/assert","../colorToCSSColor"],function(e,t,a,i,r,n,s,o,d,l,u,h,c,p,f,m,v,g,y,_,w,D,I,b,S,M,T,C,x,A,k,N,O,R,V,P){"use strict";var E=function(e,t,a,i){this._rootNode=e;this._contentResource=t;this._resolve=a;this._reject=i;this._callouts=new Map;this._cameras=new Map;this._images=new Map;this._imageIdsAndTileWidths=new Map;this._imageTextures=new Map;this._geometries=new Map;this._meshNodes=new Map;this._meshSubmeshes=new Map;this._geometryMeshes=new Map;this._materialMeshes=new Map;this._materialClones=new Map;this._joints=[];this._annotations=new Map;this._imageAddedToMaterialHandlers=[];if(e){this._nodes=new Map;this._tracks=new Map;this._trackIdSequenceNodeMap=new Map;this._viewGroups=new Map;this._views=new Map}else{this._nodes=null;this._tracks=null;this._trackIdSequenceNodeMap=null;this._viewGroups=null;this._views=null}this._currentSceneId=null;this._sceneIdTreeNodesMap=new Map;this._sceneIdRootNodeMap=new Map;this._animationHelper=new d(this);if(t){var r=t.getNodeProxy();var n=r.getNodeHierarchy();this._vkScene=n.getScene();var s=t.getSource();if(s&&s.name){this._sceneIdTreeNodesMap.set(s.name,this._nodes);this._sceneIdRootNodeMap.set(s.name,e);this._currentSceneId=s.name}if(this._rootNode){this._rootNode.userData.skipIt=!t.getName()}}this._viewThumbnails=new Map;this._thrustlines=new Map;this._animations=new Map;this._animationTracks=new Map;this._jointNodesMap=new Map;this._jointParentsMap=new Map;this._upAxis=2;this._voxelThreshold=0};E.prototype.getVoxelThreshold=function(){return this._voxelThreshold};E.prototype.setVoxelThreshold=function(e){this._voxelThreshold=e;return this};var B=[b.Default,b.Default,b.Default,b.LineIllustration,b.SolidOutline,b.ShadedIllustration];E.prototype.setScene=function(e){this._vkScene.setSceneBuilder(this);var t=this._cameras.get(e.cameraId);this._upAxis=e.upAxis;this._resolve({node:this._rootNode,camera:t,backgroundTopColor:e.backgroundTopColor,backgroundBottomColor:e.backgroundBottomColor,upAxis:e.upAxis,annotations:this._annotations,contentResource:this._contentResource,builder:this})};E.prototype.setRootNode=function(e,t,a,i){this._rootNode=e;this._nodes=new Map;this._nodes.set(t,e);this._tracks=new Map;this._trackIdSequenceNodeMap=new Map;this._sequenceIdToPlaybacks=new Map;this._viewGroups=new Map;this._views=new Map;if(a){this._sceneIdTreeNodesMap.set(a,this._nodes);this._sceneIdRootNodeMap.set(a,e);this._currentSceneId=a}if(i){this._vkScene=i}return this};E.prototype._resetCurrentScene=function(e){if(e&&e!==this._currentSceneId){var t=this._sceneIdTreeNodesMap.get(e);if(t){this._nodes=t}else{this._nodes=null}var a=this._sceneIdRootNodeMap.get(e);if(a){this._rootNode=a}else{this._rootNode=null}this._currentSceneId=e}};E.prototype.getNode=function(e,t){if(t){this._resetCurrentScene(t);if(this._nodes){return this._nodes.get(e)}}else{var a=this._sceneIdTreeNodesMap.values();var i=a.next();while(!i.done){var r=i.value.get(e);if(r){return r}i=a.next()}}return null};E.prototype.hasMesh=function(e){return this._meshSubmeshes.has(e)};E.prototype.hasImage=function(e){return this._images.has(e)};E.prototype.hasAnnotation=function(e){return this._annotations.has(e)};E.prototype.setNodePersistentId=function(e,t,a){if(!e.userData.treeNode){e.userData.treeNode={}}var i=null;if(e.userData.treeNode.sid){i=e.userData.treeNode.sid;delete e.userData.treeNode.sid}this._resetCurrentScene(a);e.userData.treeNode.sid=t;if(this._nodes){if(i){this._nodes.delete(i)}this._nodes.set(t,e);return true}return false};E.prototype.setAnnotationPersistentId=function(e,t,a){this._resetCurrentScene(a);if(this._annotations){var i=this._annotations.get(e.id);if(i){this._annotations.delete(e.id);i.annotation.id=t;this._annotations.set(t,i);return true}}return false};var L=function(t){var a=new e.Matrix4;if(t.length===3){a.setPosition((new e.Vector3).fromArray(t))}else if(t.length===12){a.set(t[0],t[3],t[6],t[9],t[1],t[4],t[7],t[10],t[2],t[5],t[8],t[11],0,0,0,1)}else if(t.length===16){a.set(t[0],t[4],t[8],t[12],t[1],t[5],t[9],t[13],t[2],t[6],t[10],t[14],t[3],t[7],t[11],t[15])}else{throw"Invalid matrix format"}return a};var H={r:.0235,g:.0235,b:.0235};var q={r:.0602,g:.0602,b:.0602};E.prototype._createTemporaryMaterial=function(t,a){var i=new S(a||M.MeshPhongMaterial);var r=i.getMaterialRef();r.userData.defaultHighlightingEmissive=H;r.userData.defaultHighlightingSpecular=q;r.userData.materialUsed=0;r.userData.materialId=t;r.userData.toBeUpdated=true;if(this._vkScene.getDoubleSided()){r.side=e.DoubleSide;r.userData.originalMaterialSide=e.FrontSide}this._vkScene.setMaterial(t,i);var n=this._materialMeshes.get(t);if(n){n.forEach(function(e){this._updateMeshSubmeshesMaterial(e,t,r)},this)}return r};E.prototype._getMaterialRef=function(e){var t=this._vkScene.getMaterial(e);return t?t.getMaterialRef():null};E.prototype.checkMaterialExists=function(e,t){if(this._getMaterialRef(e)===null){if(t){this._createTemporaryMaterial(e)}return false}return true};E.prototype.materialNeeded=function(e){return true};E.prototype.attachImageAddedToMaterial=function(e,t){this._imageAddedToMaterialHandlers.push({func:e,listener:t});return this};E.prototype.detachImageAddedToMaterial=function(e,t){for(var a=0;a<this._imageAddedToMaterialHandlers.length;a++){var i=this._imageAddedToMaterialHandlers[a];if(i.func===e&&i.listener===t){this._imageAddedToMaterialHandlers.splice(a,1);return this}}return this};E.prototype.fireImageAddedToMaterial=function(e){var t=this._imageAddedToMaterialHandlers.slice();t.forEach(function(t){t.func.call(t.listener,e)});return this};E.prototype._attachMaterialClone=function(e,t){r.pushElementIntoMapArray(this._materialClones,e,t)};E.prototype._addDynamicObject=function(e,t,a){var i=this._rootNode.userData;if(!i._vkDynamicObjects){i._vkDynamicObjects=[]}if(i._vkDynamicObjects.indexOf(e)<0){i._vkDynamicObjects.push(e)}e._vkUpdate=t;if(a){e.userData.is2D=true}};E.prototype.createNode=function(t,a){this._resetCurrentScene(a);var i=new e.Group;this._nodes.set(t.sid,i);var r;var n=this._jointNodesMap.get(t.sid);if(n&&n.length){for(r=0;r<n.length;r++){n[r].node=i}}var s=this._jointParentsMap.get(t.sid);if(s&&s.length){for(r=0;r<s.length;r++){s[r].parent=i}}var o=this._nodes.get(t.parentId);(o||this._rootNode).add(i);var d=i.userData;d.treeNode=t;if(t.closed){d.closed=true}if(t.selectable===false){d.selectable=false}if(t.visualisable===false&&t.contentType!=="SYMBOL"){d.skipIt=true}if(t.metadata){d.metadata=t.metadata}if(t.veids){d.veids=t.veids}if(t.usageIds){d.usageIds=t.usageIds}if(t.sid){d.nodeId=t.sid}if(t.name){i.name=t.name}if(t.visible!==undefined){i.visible=!!t.visible}if(o){var l;if(d.skipIt||o.name&&i.name===o.name+" offset geometry"){d.skipIt=true}else{l=o;while(l){if(l.userData.closed){d.skipIt=true;d.skipItClosed=true}l=l.parent}}if(o.userData.symbolContent){d.skipIt=true;if(d.skipItClosed===true){d.skipItClosed=false}d.symbolContent=true}if(i.visible&&!d.skipIt&&this._contentResource){l=o;while(l){l.visible=true;l=l.parent}}}if(t.renderOrder){i.renderOrder=t.renderOrder}if(t.renderMethod){d.renderMethod=t.renderMethod}if(t.renderStage){d.renderStage=t.renderStage}d.opacity=t.opacity;if(t.transform){i.applyMatrix4(L(t.transform));if(!isFinite(i.quaternion.x)||!isFinite(i.quaternion.y)||!isFinite(i.quaternion.z)||!isFinite(i.quaternion.w)){i.quaternion.set(0,0,0,1)}}i.updateMatrixWorld(true);if(t.transformType){d.transformType=t.transformType;switch(t.transformType){case"ORTHO2D":d.originalTransform={p:i.position.clone(),q:i.quaternion.clone(),s:i.scale.clone()};this._addDynamicObject(i,h.prototype._ortho2DUpdate,true);break;case"BILLBOARD_VIEW":this._addDynamicObject(i,h.prototype._billboardViewUpdate,false);break;case"LOCK_TOVIEWPORT":this._addDynamicObject(i,h.prototype._lockToViewportUpdate,true);break;default:break}}if(t.materialId){d.materialId=t.materialId}if(t.geometryType){d.geometryType=t.geometryType}if(t.meshId){this.setMeshNode(t.sid,t.meshId)}if(t.parametricId){this.setParametricNode(t.sid,t.parametricId,t.visible)}if(i.parent.userData.objectType===C.Hotspot){d.objectType=C.Hotspot}else if(i.parent.userData.objectType===C.PMI){d.objectType=C.PMI}else if(t.contentType==="HOTSPOT"){d.objectType=C.Hotspot}else if(t.contentType==="PMI"){d.objectType=C.PMI}if(t.contentType==="REFERENCE"){i._vkSetNodeContentType(k.Reference)}else if(t.contentType==="ANNOTATION"){i._vkSetNodeContentType(k.Annotation)}else if(t.contentType==="BACKGROUND"){i._vkSetNodeContentType(k.Background)}else if(t.contentType==="SYMBOL"){i._vkSetNodeContentType(k.Symbol);d.symbolContent=true}return i};E.prototype.removeNode=function(e){this._nodes.delete(e._vkPersistentId());this._annotations.forEach(function(t){if(t.node===e){this._annotations.delete(t.annotation.id)}}.bind(this));e.children.forEach(this.removeNode,this)};E.prototype.hasNode=function(e){return this._nodes.has(e._vkPersistentId())};function G(t,a,r){var n;if(t.isPolyline){var s=null;if(a&&a.type===M.LineBasicMaterial){s=a}else{s=new e.LineBasicMaterial({color:16711680,linewidth:1});if(a){s.color.copy(a.color);s.userData.materialId=a.userData.materialId}}n=new e.LineSegments(t,s)}else{n=new e.Mesh(t,a)}if(t.isPositionQuantized){j(n,r.boundingBox)}i.increaseGeometryUsed(t);return n}E.prototype.getChildNodeIds=function(e,t,a){this._resetCurrentScene(t);var i=this._nodes.get(e);var r=[];if(!i){return r}if(i&&i.children){for(var n=0;n<i.children.length;n++){var s=i.children[n];if(s.userData.treeNode&&s.userData.treeNode.sid){r.push(s.userData.treeNode.sid)}else if(a&&s.userData.submeshInfo&&s.userData.submeshInfo.id){r.push(s.userData.submeshInfo.id)}}}return r};function W(e){for(var t=0;t<e.length;t++){if(e[t].type==="box"&&e[t].data){return e[t]}}return null}function z(e){if(Array.isArray(e)){for(var t=0;t<e.length;t++){if(e[t].type===undefined||e[t].type==="mesh"||e[t].type==="line"){return e[t]}}}return null}function j(e,t){if(t&&t.length===6){e.position.set((t[3]+t[0])*.5,(t[4]+t[1])*.5,(t[5]+t[2])*.5);e.scale.set(Math.max(t[3]-t[0],Number.EPSILON),Math.max(t[4]-t[1],Number.EPSILON),Math.max(t[5]-t[2],Number.EPSILON));e.updateMatrix()}}E.prototype.insertSubmesh=function(t,i){var n=this._getMaterialRef(t.materialId)||this._createTemporaryMaterial(t.materialId);var s,o;if(t.lods){var d=z(t.lods);if(!d){return false}o=this._geometries.get(d.id);if(o){s=G(o,n,d);if(o.userData&&o.userData.noNormal&&t.materialId){this.updateMaterialForGeometryWithoutNormal(t.materialId)}}else{var l=true;var u=d.boundingBox;if(u&&i){var h=(u[3]-u[0])/(i[3]-i[0]);var c=(u[4]-u[1])/(i[4]-i[1]);var p=(u[5]-u[2])/(i[5]-i[2]);l=h>this._voxelThreshold||c>this._voxelThreshold||p>this._voxelThreshold}var f;var m=l&&W(t.lods);if(m&&m.data){var v=r.base64ToUint8Array(m.data);var g=a.unpackSubDividedBoundingBox(v);f=x.march(g)}s=new e.Mesh(f?f:new e.BoxBufferGeometry(1,1,1),n);if(u&&u.length===6){var y=new e.Matrix4;y.scale(new e.Vector3(Math.max(u[3]-u[0],Number.EPSILON),Math.max(u[4]-u[1],Number.EPSILON),Math.max(u[5]-u[2],Number.EPSILON)));y.setPosition(new e.Vector3((u[3]+u[0])*.5,(u[4]+u[1])*.5,(u[5]+u[2])*.5));s.geometry.applyMatrix4(y)}s.userData.geometryId=d.id;s.userData.lodInfo=d;r.pushElementIntoMapArray(this._geometryMeshes,d.id,t.meshId)}}else{return false}if(t.transform){s.applyMatrix4(L(t.transform))}s.updateMatrixWorld(true);s.userData.submeshId=t.id;s.userData.initialMaterialId=t.materialId;s.userData.meshId=t.meshId;s.userData.materialId=t.materialId;s.userData.submeshInfo=t;r.pushElementIntoMapArray(this._materialMeshes,t.materialId,t.meshId);r.pushElementIntoMapArray(this._meshSubmeshes,t.meshId,s);var _=this._meshNodes.get(t.meshId);if(_){_.forEach(function(a){var i=s instanceof e.Mesh?s._vkClone():s.clone();if(a.userData.transformType==="ORTHO2D"){i.position.setScalar(0);i.scale.setScalar(1)}i.userData.skipIt=true;i.renderOrder=a.renderOrder;if(a.userData.materialId){R.disposeMaterial(i.material);i.material=this._getMaterialRef(a.userData.materialId)||s.material;i.userData.materialId=a.userData.materialId}if(i.material&&a.userData&&a.userData.geometryType&&(a.userData.geometryType==="PLANE"||a.userData.geometryType==="SURFACE")){i.material.side=e.DoubleSide;if(this._vkScene.getDoubleSided()){if(!i.material.userData){i.material.userData={}}i.material.userData.originalMaterialSide=e.DoubleSide}}a.add(i);i.updateMatrixWorld(true);U(a,t.materialId,this._materialClones)}.bind(this))}return true};function F(e,t,a,r){for(var n=0;n<e.length;n++){var s=e[n];if(t&&s.userData.geometryId===t&&s.geometry!==a){if(s.type==="Mesh"&&!a.isPolyline){if(s.geometry){R.disposeGeometry(s)}s.geometry=a;if(a.isPositionQuantized&&!(s.parent&&s.parent.userData.transformType==="ORTHO2D")){j(s,s.userData.lodInfo.boundingBox)}s.updateMatrixWorld(true);i.increaseGeometryUsed(a)}else{var o=G(a,s.material,s.userData.lodInfo);o.position.copy(s.position);o.quaternion.copy(s.quaternion);o.scale.copy(s.scale);o.matrix.copy(s.matrix);o.updateMatrixWorld(true);o.userData=s.userData;o.renderOrder=s.renderOrder;o.parent=s.parent;e[n]=o;s.parent=null}}}}E.prototype._setSubmeshMaterial=function(e,t,a){i.increaseMaterialUsed(t);e.material=t;e.userData.materialId=a;delete e.userData.originalMaterial;e._vkUpdateMaterialOpacity();if(e.material!==t){r.pushElementIntoMapArray(this._materialClones,a,e.material)}};E.prototype._updateMaterial=function(e,t,a){e.children.forEach(function(e){if(e.material&&e.userData.materialId===t){this._setSubmeshMaterial(e,a,t)}}.bind(this))};E.prototype._updateMeshSubmeshesMaterial=function(e,t,a){var i=this._meshSubmeshes.get(e);if(i){i.forEach(function(e){if(e.material&&e.material.userData.materialId===t){e.material=a}})}};function U(e,t,a){e.children.forEach(function(e){if(e.material&&(!t||t===e.material.userData.materialId)){var i=e.material;e._vkUpdateMaterialOpacity();if(e.material!==i){r.pushElementIntoMapArray(a,e.material.userData.materialId,e.material)}}})}function K(t,a){var i=new Float32Array(t.length);var r=new e.Vector3;var n=new e.Vector3;var s=new e.Vector3;var o=new e.Vector3;var d,l;for(d=0,l=a.length;d<l;d+=3){var u=[a[d]*3,a[d+1]*3,a[d+2]*3];r.fromArray(t,u[0]);n.fromArray(t,u[1]).sub(r);s.fromArray(t,u[2]).sub(r);o.crossVectors(n,s).normalize();for(var h=0;h<3;h++){var c=u[h];i[c]+=o.x;i[c+1]+=o.y;i[c+2]+=o.z}}for(d=0,l=i.length;d<l;d+=3){o.fromArray(i,d).normalize().toArray(i,d)}return i}E.prototype.setGeometry=function(t){var a=new e.BufferGeometry;var i=t.data;var r=new e.BufferAttribute(new Uint16Array(i.indices),1);var n=new e.BufferAttribute(new Float32Array(i.points),3);a.setIndex(r);a.setAttribute("position",n);if(!t.isPolyline){if(!i.normals||i.normals.length!==n.array){i.normals=K(n.array,r.array)}var s=new e.BufferAttribute(new Float32Array(i.normals),3);a.setAttribute("normal",s);if(i.uvs&&i.uvs.length*3===i.points.length*2){a.setAttribute("uv",new e.BufferAttribute(new Float32Array(t.data.uvs),2))}}else{a.isPolyline=true}a.computeBoundingBox();a.computeBoundingSphere();a.isPositionQuantized=t.isPositionQuantized;a.userData.geometryId=t.id;a.userData.geometryUsed=0;this._geometries.set(t.id,a);var o=this._geometryMeshes.get(t.id);if(o){for(var d=0;d<o.length;d++){var l=o[d];var u=this._meshNodes.get(l);if(u){for(var h=0;h<u.length;h++){F(u[h].children,t.id,a)}}var c=this._meshSubmeshes.get(l);if(c){F(c,t.id,a)}}}if(this._fireSceneUpdated){this._fireSceneUpdated()}return this};E.prototype.setMeshNode=function(t,a){var i=this._nodes.get(t);if(i){r.pushElementIntoMapArray(this._meshNodes,a,i);var n=this._meshSubmeshes.get(a);if(n){n.forEach(function(t){var a=t instanceof e.Mesh?t._vkClone():t.clone();if(i.userData.transformType==="ORTHO2D"){a.position.setScalar(0);a.scale.setScalar(1)}a.userData.skipIt=true;a.renderOrder=i.renderOrder;if(i.userData.materialId){R.disposeMaterial(a.material);a.material=this._getMaterialRef(i.userData.materialId)||t.material;a.userData.materialId=i.userData.materialId}i.add(a)}.bind(this));U(i,null,this._materialClones)}}};E.prototype.setParametricNode=function(e,t,a){var i=this._nodes.get(e);if(i){i.userData.parametricVisible=a!==undefined?a:true}};E.prototype.progress=function(e){t.log("reading progress:",e)};E.prototype.loadingFinished=function(e){if(this._fireLoadingFinished){this._fireLoadingFinished(e)}};E.prototype.getGeometry=function(e){return this._geometries.get(e)};var Q={rect:m.RectangularShape,circle:m.CircularShape,none:m.None,textGlow:m.TextGlow};var Y={none:v.None,solid:v.Solid,dash:v.Dash,dot:v.Dot,dashdot:v.DashDot,dashdotdot:v.DashDotDot};var J={left:g.Left,center:g.Center,right:g.Right};var X={none:y.None,point:y.Point,arrow:y.Arrow};var Z=new e.Color;function $(t){var a=new e.Matrix4;var i=new e.Matrix4;var r=t;while(r&&r.userData.originalTransform){V(r.userData.transformType==="ORTHO2D");var n=r.userData.originalTransform;a.compose(n.p,n.q,n.s);i.premultiply(a);r=r.parent}i.decompose(t.position,t.quaternion,t.scale)}E.prototype.createAnnotation=function(a,i){this._resetCurrentScene(i);var r=this._nodes.get(a.nodeId);if(!r){t.warning("Annotation node not found",a);return}if(r.userData.originalTransform){$(r)}var n=a.type;if(n===undefined){this.createLegacyAnnotation(a,r);return}if(n==="html"){a.id=a.id||O();var s=[];if(a.leaderLines){a.leaderLines.forEach(function(e){if(e.start&&e.start.sid){s.push(this._nodes.get(e.start.sid))}},this)}this._annotations.set(a.id,{annotation:a,node:r,attachment:a.attachment&&a.attachment.sid?this._nodes.get(a.attachment.sid):null,targetNodes:s});return}var o=a.label||{};var d=a.text||{};var l=o.colour||[1,1,1,1];var u=o.borderColour||[0,0,0,1];var p={node:r,renderOrder:r.renderOrder||0,style:Q[o.shape]||m.RectangularShape,width:o.width||64,height:o.height||64,backgroundColor:Z.fromArray(l).getStyle(),backgroundOpacity:l[3],borderColor:Z.fromArray(u).getStyle(),borderOpacity:u[3],borderWidth:o.borderColour?o.borderWidth||0:0,borderLineStyle:Y[o.borderLineStyle]||v.Solid,horizontalAlignment:J[d.align]};if(d.html){p.encoding=f.HtmlText;p.text=d.html}else{p.encoding=f.PlainText;p.text=d.text;p.font=d.fontFace||"Arial";p.fontSize=Math.abs(d.fontSize)||16;p.fontWeight=Math.min(d.fontWeight,900);p.fontItalic=d.fontItalic;p.textColor=Z.fromArray(d.colour||[0,0,0]).getStyle()}if(n==="text"){var g=r.position;p.position=new e.Vector3(g.x*2,g.y*2,g.z);var y=new h(p);y.setText(p.text);this._addDynamicObject(r,y._update.bind(y),true)}else if(n==="note"){var _=a.attachment||{};p.position=(new e.Vector3).fromArray(_.position||[0,0,0]);p.anchorNode=this._nodes.get(_.sid)||this._rootNode;p.depthTest=false;var w=new c(p);w.setText(p.text);this._callouts.set(a.id,w);this._addDynamicObject(r,w._update.bind(w),false)}else{t.warning("Unsupported annotation type",a)}};var ee=[m.RectangularShape,m.CircularShape,m.None,m.TextGlow];var te=[p.Viewport,p.Screen,p.World];var ae=[v.None,v.Solid,v.Dash,v.Dot,v.DashDot,v.DashDotDot];var ie=[y.None,y.Point,y.Arrow];var re=[g.Left,g.Center,g.Right];function ne(e){var t=e.toString(16);if(e.length>=3){t=(e[0]*255<<16|e[1]*255<<8|e[2]*255).toString(16)}return"#"+"000000".substring(t.length)+t}function se(e){if(!e){return false}for(var t=0,a=e.length;t<a;t++){if(!isFinite(e[t])){return false}}return true}E.prototype.createLegacyAnnotation=function(a,i){var r=a.position;if(!se(r)){t.warning("Incorrect annotation position",a);return}a.coordinateSpace|=0;var n=a.backgroundOpacity;if(!n){n=a.backgroundColour?a.backgroundColour[3]:0}var s=a.borderOpacity;if(!s){s=a.borderColour?a.borderColour[3]:0}var o={node:i,coordinateSpace:te[a.coordinateSpace],style:ee[a.shape||0],width:a.width,height:a.height,backgroundColor:a.backgroundColour?ne(a.backgroundColour):"#fff",backgroundOpacity:n,borderColor:a.borderColour?ne(a.borderColour):"#000",borderOpacity:s,borderWidth:a.borderWidth,borderLineStyle:ae[a.borderLineStyle]};if(a.encoding!==undefined){o.encoding=a.encoding?f.HtmlText:f.PlainText;o.font=a.font;o.fontSize=a.fontSize;o.fontWeight=Math.min(a.fontWeight,900);o.fontItalic=a.fontItalic;o.textColor=ne(a.textColour);o.link=a.link;o.horizontalAlignment=re[a.textHorizontalAlignment];o.position=(new e.Vector3).fromArray(r)}else if(a.fontFace){o.encoding=f.PlainText;o.font=a.fontFace;o.fontSize=Math.abs(a.fontSize);o.fontWeight=Math.min(a.fontWeight,900);o.textColor=ne(a.textColour)}else{o.encoding=f.HtmlText}if(a.coordinateSpace<2){if(!o.positions){o.position=new e.Vector3(r[0]*2-1,r[1]*-2+1,r[2])}o.renderOrder=(a.order|0)+1e3;var d=new h(o);d.setText(a.text);this._addDynamicObject(i,d._update.bind(d),true)}else{o.anchorNode=this._nodes.get(a.sid)||this._rootNode;if(!o.position){o.position=(new e.Vector3).fromArray(r)}o.depthTest=false;o.renderOrder=a.order|0;if(a.alwaysOnTop){o.renderOrder=1}var l=new c(o);l.setText(a.text);this._callouts.set(a.id,l);this._addDynamicObject(i,l._update.bind(l),false)}};function oe(e){while(e){if(e.userData.transformType){return e.userData.transformType}e=e.parent}}E.prototype.createImageNote=function(a,i){this._resetCurrentScene(i);var r=this._nodes.get(a.nodeId);if(!r){t.warning("Image annotation node not found",a);return}if(r.userData.originalTransform){$(r)}if(a.type==="image"){var n=a.label||{};var s=n.materialId;var o=this._getMaterialRef(s);if(!o){t.warning("Image annotation material not found",a);return}if(n.projection==="spherical"){r.position.setScalar(0);r.scale.setScalar(1);n.width=-1;n.height=-1;r.userData.transformType="LOCK_TOVIEWPORT";r.userData.renderStage=-1;var d=o;o=new T({upAxis:this._upAxis,map:d.map,color:d.color});o.userData=d.userData;this._vkScene.getMaterial(s)._nativeMaterial=o}o.depthTest=false;o.depthWrite=false;o.blending=e.CustomBlending;o.side=e.DoubleSide;if(r.userData.renderStage===undefined){if(a.order){r.userData.renderStage=Math.sign(a.order)}else if(a.order===undefined&&oe(r)!==undefined){r.userData.renderStage=1}}switch(r.userData.transformType){case"ORTHO2D":case"LOCK_TOVIEWPORT":var l=new h({node:r,renderOrder:r.renderOrder||0,coordinateSpace:p.Screen,position:new e.Vector3(r.position.x,r.position.y,0),width:(n.width||200)*r.scale.x*.5,height:(n.height||200)*r.scale.y*.5});l.setMaterial(o);r.position.setScalar(0);r.scale.setScalar(1);this._addDynamicObject(r,l._update.bind(l),true);break;case"BILLBOARD_VIEW":default:var u=new e.Mesh(h.prototype._planeGeometry,o);u.scale.set(n.width,n.height,1);u.updateMatrix();r.add(u);break}}else{this.createLegacyImageNote(a,r)}};E.prototype.createLegacyImageNote=function(t,a){var i=(new e.Vector3).fromArray(t.position);var r=t.width;var n=t.height;if(!t.properlyAligned){i.x+=t.width*.5;i.y+=t.height*.5;i.applyMatrix4(a.matrix);r=t.width*.5*a.matrix.elements[0];n=t.height*.5*a.matrix.elements[5]}var s=this._getMaterialRef(t.labelMaterialId);s.depthTest=false;s.depthWrite=false;s.blending=e.CustomBlending;if(oe(a)==="LOCK_TOVIEWPORT"){var o=new h({node:a,coordinateSpace:p.Screen,renderOrder:(t.order|0)+1e3,position:i,width:r,height:n});o.setMaterial(s);this._addDynamicObject(a,o._update.bind(o),true)}else{var d=new e.Mesh(h.prototype._planeGeometry,s);d.renderOrder=(t.order|0)+1e3;d.position.copy(i);d.scale.set(r*2,n*2,1);d.updateMatrix();a.add(d);a.scale.setScalar(1);a.updateMatrix()}};E.prototype.insertLeaderLine=function(a,i){this._resetCurrentScene(i);var r=this._callouts.get(a.annotationId);if(r){var n=this._getMaterialRef(a.materialId);if(!n){t.warning("Leader line material not found",a);return}var s=[];var o=a.points;for(var d=0,l=o.length;d<l;d++){s.push((new e.Vector3).fromArray(o[d]))}var u;if(a.start){var h=a.start||{};var c=a.end||{};var p=a.extension||{};u=this._nodes.get(a.start.sid)||this._rootNode;r.addLeaderLine(s,u,n,X[h.style]||y.None,X[c.style]||y.None,h.size,p.length||0)}else{u=this._nodes.get(a.startPointSid)||this._rootNode;r.addLeaderLine(s,u,n,ie[a.startPointHeadStyle],ie[a.endPointHeadStyle],a.pointHeadConstant,a.extensionLength)}}};E.prototype._findDetailViewNodes=function(e){var a=[];if(e){e.forEach(function(e){var i=this._nodes.get(e);if(i){a.push(i)}else{t.warning("Unknown detailView node reference",e)}}.bind(this))}return a};E.prototype.createDetailView=function(a,i){this._resetCurrentScene(i);var r=this._nodes.get(a.nodeId);if(!r){t.warning("Detail view node not found",a);return}var n=a.label;if(!n){this.createLegacyDetailView(a,r);return}var s=a.attachment;var d={name:a.name,camera:n.camera?this.createCamera(n.camera):null,type:a.cutaway?_.Cutaway:_.DetailView,borderWidth:n.borderWidth||0,backgroundColor:Z.fromArray(n.colour||[1,1,1]).getStyle(),borderColor:Z.fromArray(n.borderColour||[1,1,1]).getStyle(),origin:new e.Vector2(r.position.x*2-1+r.scale.x,r.position.y*-2+1-r.scale.x),size:new e.Vector2(r.scale.x,r.scale.y),attachmentPoint:(new e.Vector3).fromArray(s.position||[0,0,0]),veId:a.veid,visibleNodes:this._findDetailViewNodes(a.visibleNodes),targetNodes:this._findDetailViewNodes(a.targetNodes)};if(n.shape==="rect"){d.shape=!n.leaderStyle||n.leaderStyle==="none"?w.Box:w.BoxLine}else{d.shape={none:w.Circle,line:w.CircleLine,pointer:w.CirclePointer,arrow:w.CircleArrow,bubbles:w.CircleBubbles}[n.leaderStyle]||w.Circle}var l=new o(d);if(!this._rootNode.userData._vkDetailViews){this._rootNode.userData._vkDetailViews=[]}this._rootNode.userData._vkDetailViews.push({detailView:l,node:r,renderOrder:a.renderOrder||r.renderOrder||0})};E.prototype.createLegacyDetailView=function(t,a){if(!t.properlyAligned){if(!t.shape){t.shape=t.leaderStyle?w.BoxLine:w.Box}else{t.shape=[w.Circle,w.CircleLine,w.CirclePointer,w.CircleArrow,w.CircleBubbles][t.leaderStyle||0]}t.type=t.cutaway?_.Cutaway:_.DetailView;t.camera=t.camera?this.createCamera(t.camera):null;t.origin=new e.Vector2(a.position.x*2-1+a.scale.x,a.position.y*-2+1-a.scale.x);t.size=new e.Vector2(a.scale.x,a.scale.y);t.renderOrder=a.renderOrder}else{t.type=[_.DetailView,_.Cutaway][t.type];t.shape=[w.Box,w.Circle,w.CircleLine,w.CirclePointer,w.CircleArrow,w.CircleBubbles,w.BoxLine,w.BoxNoOutline,w.SolidPointer,w.SolidArrow][t.shape];t.camera=this._cameras.get(t.cameraId);t.origin=(new e.Vector2).fromArray(t.origin);t.size=(new e.Vector2).fromArray(t.size)}var i=new o({name:t.name,camera:t.camera,type:t.type,shape:t.shape,borderWidth:t.borderWidth||0,backgroundColor:t.backgroundColour?ne(t.backgroundColour):"#fff",borderColor:t.borderColour?ne(t.borderColour):"#000",origin:t.origin,size:t.size,attachmentPoint:(new e.Vector3).fromArray(t.attachment),metadata:t.metadata,veId:t.veid,visibleNodes:this._findDetailViewNodes(t.visibleNodes),targetNodes:this._findDetailViewNodes(t.targetNodes)});if(!this._rootNode.userData._vkDetailViews){this._rootNode.userData._vkDetailViews=[]}this._rootNode.userData._vkDetailViews.push({detailView:i,node:a,renderOrder:t.renderOrder||0})};E.prototype.insertThrustline=function(t){var a=this._nodes.get(t.thrustlineId);if(a&&!this._thrustlines.get(t.thrustlineId)){var i=new l({node:a,principleAxis:(new e.Vector3).fromArray(t.principleAxis),material:this._getMaterialRef(t.materialId)});var r=[];var n=0;var s=0;var o=0;for(var d=0;d<t.itemCount;d++){var u={};u.target=this._nodes.get(t.targets[d]);u.majorAxisIndex=t.itemMajorAxisesIndices[d];var h;u.basisAxises=[];o=n+t.itemBasisAxisesCounts[d];for(h=n;h<o;h++){var c={};c.x=t.itemBasisAxisesCoordinates[h*3];c.y=t.itemBasisAxisesCoordinates[h*3+1];c.z=t.itemBasisAxisesCoordinates[h*3+2];u.basisAxises.push(c)}n=o;u.dimension={};u.dimension.x=t.itemDimensionsCoordinates[d*3];u.dimension.y=t.itemDimensionsCoordinates[d*3+1];u.dimension.z=t.itemDimensionsCoordinates[d*3+2];u.center={};u.center.x=t.itemCentersCoordinates[d*3];u.center.y=t.itemCentersCoordinates[d*3+1];u.center.z=t.itemCentersCoordinates[d*3+2];u.boundPoints=[];o=s+t.itemBoundPointsCounts[d];for(h=s;h<o;h++){var p={};p.x=t.itemBoundPointsCoordinates[h*3];p.y=t.itemBoundPointsCoordinates[h*3+1];p.z=t.itemBoundPointsCoordinates[h*3+2];u.boundPoints.push(p)}s=o;r.push(u)}i.setItems(r);var f=0;var m=[];for(var v=0;v<t.segmentCount;v++){var g={};g.startItemIndex=t.segmentsStartItemIndices[v];g.endItemIndex=t.segmentsEndItemIndices[v];g.startBoundIndex=t.segmentsStartBoundIndices[v];g.endBoundIndex=t.segmentsEndBoundIndices[v];g.ratios=[];o=f+t.segmentRatioCounts[v];for(var y=0;y<o;y++){var _={};_.x=t.segmentRatiosCoordinates[y*2];_.y=t.segmentRatiosCoordinates[y*2+1];g.ratios.push(_)}f=o;m.push(g)}i.setSegments(m);this._thrustlines.set(t.thrustlineId,i);this._addDynamicObject(a,i._update.bind(i),false)}};E.prototype.updateViewsForReplacedNodes=function(e){var t=new Map;e.forEach(function(e){var a=this._nodes.get(e.sid);if(a){t.set(e.sid,a)}},this);function a(e,t){var a=e.getNodeInfos();a.forEach(function(e){var a=e.target;if(a&&a.userData&&a.userData.treeNode&&a.userData.treeNode.sid){var i=t.get(a.userData.treeNode.sid);if(i){e.target=i;i.updateMatrixWorld()}}})}function i(t,a){var i;var r=t.getPlaybacks();for(var n=0;n<r.length;n++){var s=r[n];var o=s.getSequence();if(o){var d=false;var l=o.getNodeAnimation();for(var u=0;u<l.length;u++){var h=l[u];var c=h.nodeRef;if(c&&c.userData&&c.userData.treeNode&&c.userData.treeNode.sid){i=a.get(c.userData.treeNode.sid);if(i){o.removeNodeAnimation(c,null,true);for(var p in h){if(p==="nodeRef"){continue}o.setNodeAnimation(i,p,h[p],true)}d=true}}}var f=o.getJoint();for(var m=0;f&&m<f.length;m++){var v=f[m];if(v.parentSid){i=a.get(v.parentSid);if(i){v.parent=i;d=true}}if(v.nodeSid){i=a.get(v.nodeSid);if(i){v.node=i;d=true}}}if(d){o._fireSequenceChanged()}}}e.forEach(function(e){var t=e.target;if(t&&t.userData&&t.userData.treeNode&&t.userData.treeNode.sid){var i=a.get(t.userData.treeNode.sid);if(i){e.target=i;i.updateMatrixWorld()}}})}this._views.forEach(function(e,r){a(e,t);i(e,t)})};E.prototype._decrementResourceCounters=function(e){e.traverse(function(e){if(e.isMesh){i.decreaseMaterialUsed(e.material);i.decreaseGeometryUsed(e.geometry)}})};E.prototype.decrementResourceCountersForDeletedTreeNode=function(e,t){this._resetCurrentScene(t);var a=this;e=[].concat(e);e.forEach(function(e){var t=a._nodes.get(e);if(t){a._decrementResourceCounters(t);a._nodes.delete(e)}});return this};E.prototype.remove=function(e,t){this._resetCurrentScene(t);var a=this;e=[].concat(e);e.forEach(function(e){var i=a._nodes.get(e);if(i){a._decrementResourceCounters(i);if(i.parent){i.parent.remove(i)}a._nodes.delete(e);for(var r=0;r<i.children.length;r++){var n=i.children[r];if(n.userData&&n.userData.treeNode&&n.userData.treeNode.sid){a.remove(n.userData.treeNode.sid,t)}}}});return this};E.prototype.resourcesCleanUp=function(){var e=this._geometries;e.forEach(function(e){var t=e.userData.geometryUsed;if(t<=0){e.dispose()}});return this};E.prototype.createCamera=function(t,a){this._resetCurrentScene(a);var i=t.near||1;var r=t.far||2e5;if(t.origin.length===3&&t.origin[0]===0&&t.origin[1]===0&&t.origin[2]===0){t.ortho=false;t.rotate=true}var o;if(t.ortho){o=new e.OrthographicCamera(-1,1,1,-1,i,r);o.zoom=t.zoom||-1}else{o=new e.PerspectiveCamera(e.Math.radToDeg(t.fov),1,i,r)}if(t.origin){o.position.fromArray(t.origin)}if(t.up){o.up.fromArray(t.up);if(t.notUseDirectionVector){o.up.sub(o.position)}o.up.normalize()}if(t.rotate){o.userData.rotate=t.rotate;o.up.set(0,1,0)}if(t.target){var d=(new e.Vector3).fromArray(t.target);if(!t.notUseDirectionVector){d.add(o.position)}o.lookAt(d)}this._rootNode.userData.camera=o;var l=null;if(o.isOrthographicCamera){l=new n}else if(o.isPerspectiveCamera){l=new s}l.setCameraRef(o);l.setUsingDefaultClipPlanes(true);var u=t.id;if(u){this._cameras.set(u,l)}this._rootNode.userData.camera=l;return l};E.prototype.insertCamera=function(e,t,a){this._resetCurrentScene(a);var i=this._nodes.get(e);var r=this._cameras.get(t);if(i&&r){(i||this._rootNode).add(r.parent?r.clone():r)}return this};E.prototype.getCamera=function(e){return this._cameras.get(e)};E.prototype.updateMaterialForGeometryWithoutNormal=function(t){var a=this._getMaterialRef(t);if(a&&a.emissive){a.emissive.copy(a.color);a.side=e.DoubleSide;if(this._vkScene.getDoubleSided()){if(!a.userData){a.userData={}}a.userData.originalMaterialSide=e.DoubleSide}}return this};E.prototype.createMaterial=function(t){var a=[];var i=t.id;var n=this._getMaterialRef(i);var s;if(t.lineWidth>0){if(!n||!n.isLineBasicMaterial){s=new S(M.LineBasicMaterial);n=s.getMaterialRef();this._vkScene.setMaterial(i,s)}n.color=new e.Color(t.lineColour[0],t.lineColour[1],t.lineColour[2]);n.linewidth=t.lineWidth;n.userData.lineStyle={width:t.lineWidth,haloWidth:t.lineHaloWidth||0,endCapStyle:t.lineEndRound?1:0,dashPattern:t.lineDashPattern||[],dashPatternScale:t.lineDashPatternScale,widthCoordinateSpace:t.lineWidthCoordinateSpace};n.userData.materialInfo=t;n.userData.materialId=i;return a}var o=null;if(t.textureEmissive){if(!n||!n.isMeshBasicMaterial){o=n;n=this._createTemporaryMaterial(i,M.MeshBasicMaterial)}}if(!n){n=this._createTemporaryMaterial(i)}delete n.userData.toBeUpdated;n.userData.materialInfo=t;if(t.diffuseColour){n.color.fromArray(t.diffuseColour)}if(t.specularColour&&n.specular){n.specular.fromArray(t.specularColour)}var d=true;if(t.emissiveColour){if(n.emissive){n.emissive.fromArray(t.emissiveColour);if(n.emissive.r!==0||n.emissive.g!==0||n.emissive.b!==0){d=false;n.depthFunc=e.LessDepth}}else{n.color.fromArray(t.emissiveColour)}}if(d&&t.ambientColour&&n.emissive){n.emissive.fromArray(t.ambientColour);n.emissive.multiplyScalar(.2)}if(n.opacity!==undefined){n.opacity=t.opacity;n.transparent=t.opacity<.99;if(n.transparent){n.side=e.DoubleSide}}var l=n.glossiness?n.glossiness:0;var u=n.specularLevel?n.specularLevel:0;n.shininess=l*2+u*3;n.userData.defaultHighlightingEmissive=H;n.userData.defaultHighlightingSpecular=q;n.userData.imageIdsToAddAsTexture=new Set;var h,c;if(t.textureDiffuse){c=t.textureDiffuse;h=c[0]||c;n.userData.imageIdsToAddAsTexture.add(h.imageId)}else if(t.textureDecal){c=t.textureDecal;h=c[0]||c;n.userData.imageIdsToAddAsTexture.add(h.imageId)}if(t.textureBump){c=t.textureBump;h=c[0]||c;n.userData.imageIdsToAddAsTexture.add(h.imageId)}if(t.textureEmissive){c=t.textureEmissive;h=c[0]||c;n.userData.imageIdsToAddAsTexture.add(h.imageId)}if(t.textureAmbientOcclusion){c=t.textureAmbientOcclusion;h=c[0]||c;n.userData.imageIdsToAddAsTexture.add(h.imageId)}if(t.textureReflection){c=t.textureReflection;h=c[0]||c;n.userData.imageIdsToAddAsTexture.add(h.imageId)}if(n.userData.imageIdsToAddAsTexture.size===0){delete n.userData.imageIdsToAddAsTexture}a=this.updateTextureMaps(i);if(a.length>0){n.userData.imageIdsToLoad=new Set;for(var p=0;p<a.length;p++){var f=a[p];r.pushElementIntoMapArray(this._imageTextures,f.imageId,{textureType:f.textureType,materialId:i});n.userData.imageIdsToLoad.add(f.imageId)}}var m=this._materialMeshes.get(i);if(m){for(var v=0;v<m.length;v++){var g=m[v];var y=this._meshNodes.get(g);if(y){for(var _=0;_<y.length;_++){this._updateMaterial(y[_],i,n)}}if(o){this._updateMeshSubmeshesMaterial(g,i,n)}}}if(o){R.disposeMaterial(o)}return a};E.prototype.getMaterial=function(e){return this._getMaterialRef(e)};var de=function(e){var t="";try{var a=32768;var i=0;var r=e.length;var n;while(i<r){n=e.slice(i,Math.min(i+a,r));t+=String.fromCharCode.apply(null,n);i+=a}}catch(e){t=""}return t};E.prototype.createImage=function(e){if(e.binaryData.length<32){t.warning("SceneBuilder.createImage()","Can't create image from empty data");return this}var a=new DataView(e.binaryData.buffer);var i=true;if(a.getUint8(0,true)===parseInt("0xFF",16)&&a.getUint8(1,true)===parseInt("0xD8",16)){i=false}var r=de(e.binaryData);var n="data:image/"+(i?"png":"jpeg")+";base64,"+btoa(r);this._images.set(e.id,n);var s=this._imageTextures.get(e.id);if(s){this._imageTextures.delete(e.id);for(var o=0;o<s.length;o++){var d=s[o];this.updateTextureMap(d.materialId,d.textureType)}}return this};var le=new e.TextureLoader;var ue={Diffuse:0,Bump:1,Opacity:2,Reflection:3,Refraction:4,Specular:5,Ambient:6,Emissive:7,SpecularLevel:8,Glossiness:9,AmbientOcclusion:10,Decal:11};E.prototype.updateTextureMaps=function(e){var t=[];var a=this._getMaterialRef(e);if(!a){return t}var i=a.userData.materialInfo;if(!i){return t}if(i.textureDiffuse){var r=this.updateTextureMap(e,ue.Diffuse);if(r.imageId){t.push(r)}}else if(i.textureDecal){var n=this.updateTextureMap(e,ue.Decal);if(n.imageId){t.push(n)}}if(i.textureBump){var s=this.updateTextureMap(e,ue.Bump);if(s.imageId){t.push(s)}}if(i.textureEmissive){var o=this.updateTextureMap(e,ue.Emissive);if(o.imageId){a[a.emissive?"emissive":"color"].setRGB(1,1,1);t.push(o)}}if(i.textureAmbientOcclusion){var d=this.updateTextureMap(e,ue.AmbientOcclusion);if(d.imageId){t.push(d)}}if(i.textureReflection){var l=this.updateTextureMap(e,ue.Reflection);if(l.imageId){t.push(l)}}return t};E.prototype.updateTextureMap=function(t,a){var i={textureType:a,imageId:null};var r=this._getMaterialRef(t);if(!r){return i}var n=r.userData.materialInfo;if(!n){return i}var s=null;switch(a){case ue.Diffuse:s=n.textureDiffuse;break;case ue.Decal:s=n.textureDecal;break;case ue.Bump:s=n.textureBump;break;case ue.Reflection:s=n.textureReflection;break;case ue.Emissive:s=n.textureEmissive;break;case ue.AmbientOcclusion:s=n.textureAmbientOcclusion;break;default:break}if(!s){return i}var o=s[0]||s;var d=this._images.get(o.imageId);if(!d){i.imageId=o.imageId;return i}if(r.userData.imageIdsToLoad){r.userData.imageIdsToLoad.delete(o.imageId);if(r.userData.imageIdsToLoad.size===0){delete r.userData.imageIdsToLoad}}if(r.userData.parametricType==="sphere"){o.uvHorizontalScale=-1}var l=o.influence!==undefined?o.influence:0;function u(t,i){switch(a){case ue.Diffuse:case ue.Decal:t.map=i;t.transparent|=d.startsWith("data:image/png");break;case ue.Bump:t.bumpMap=i;t.bumpScale=l;break;case ue.Opacity:t.alphaMap=i;break;case ue.Reflection:i.mapping=e.EquirectangularReflectionMapping;t.envMap=i;t.combine=e.AddOperation;t.reflectivity=l;break;case ue.Emissive:t[t.emissiveMap!==undefined?"emissiveMap":"map"]=i;if(t.isSphericalMapMaterial){i.minFilter=e.LinearFilter}break;case ue.AmbientOcclusion:t.aoMap=i;break;default:}t.needsUpdate=true}le.load(d,function(a){a.wrapS=o.uvHorizontalTilingEnabled?e.RepeatWrapping:e.ClampToEdgeWrapping;a.wrapT=o.uvVerticalTilingEnabled?e.RepeatWrapping:e.ClampToEdgeWrapping;a.magFilter=o.filterMode===1?e.NearestFilter:e.LinearFilter;a.minFilter=o.filterMode===1?e.NearestFilter:e.LinearMipMapLinearFilter;a.anisotropy=4;var i=o.uvHorizontalOffset||0;var n=o.uvVerticalOffset||0;a.repeat.set(o.uvHorizontalScale||1,o.uvVerticalScale||1);a.center.set(-i,-n);a.offset.set(i,n);a.rotation=-o.uvRotationAngle;if(r.isMeshBasicMaterial){a.generateMipmaps=false;a.minFilter=o.filterMode===1?e.NearestFilter:e.LinearFilter}u(r,a);if(r.userData.imageIdsToAddAsTexture&&o.imageId){r.userData.imageIdsToAddAsTexture.delete(o.imageId);if(r.userData.imageIdsToAddAsTexture.size===0){delete r.userData.imageIdsToAddAsTexture}}var s=this._materialClones.get(t);if(s){s.forEach(function(e){u(e,a)})}this.fireImageAddedToMaterial({materialId:t});if(this._fireSceneUpdated){this._fireSceneUpdated()}}.bind(this));return i};E.prototype.insertPlayback=function(e,t,a){this._resetCurrentScene(a);var i=this._vkScene.findSequence(e.sequenceId);var n=new D(e.id,{sequence:i,timeScale:e.speed?1/e.speed:1,preDelay:e.preDelay?e.preDelay:0,postDelay:e.postDelay?e.postDelay:0,repeats:e.repeat?Math.abs(e.repeat):0,reversed:e.reversed?true:false,startTime:e.start?e.start:0});var s=this._views.get(t);if(s){s.addPlayback(n)}if(!i){r.pushElementIntoMapArray(this._sequenceIdToPlaybacks,e.sequenceId,n)}return this};E.prototype.insertSequence=function(e,t){var a=this._vkScene.findSequence(e.id);if(a){return this}var i;if(e.endTime){if(e.startTime){i=e.endTime-e.startTime}else{i=e.endTime}}else{i=1}a=this._vkScene.createSequence(e.id,{name:e.name,duration:i});if(Array.isArray(e.joints)){e.joints.forEach(function(e){var t=this._joints[e];if(t){a.setJoint(t,true)}}.bind(this))}if(e.nodes&&e.nodes.length>0){for(var n=0;n<e.nodes.length;n++){var s=e.nodes[n];if(s.empty){s.type=s.binding;var o=this._nodes.get(s.sid);this._animationHelper.insertEmptyTrack(s,a,o,this._vkScene);continue}r.pushElementIntoMapArray(this._trackIdSequenceNodeMap,s.trackId,{sequenceId:e.id,targetId:s.sid,type:s.binding,pivot:s.pivot,isAbsoluteValue:s.isAbsoluteValue})}}var d=this._sequenceIdToPlaybacks.get(e.id);if(d){d.forEach(function(e){e.setSequence(a)})}return this};E.prototype.insertTracks=function(e){this._animationHelper.insertTracks(e,this._trackIdSequenceNodeMap,this._nodes,this._vkScene);return this};E.prototype.insertJoints=function(e,t){this._resetCurrentScene(t);this._joints=[];e.forEach(function(e){var t=this._nodes.get(e.childSid);var a=this._nodes.get(e.parentSid);var i={id:e.id,node:t,parent:a,translation:new Float32Array(e.t?e.t:[0,0,0]),quaternion:new Float32Array(e.q?e.q:[0,0,0,1]),scale:new Float32Array(e.s?e.s:[1,1,1])};if(!t){var r=this._jointNodesMap.get(e.childSid);if(!r){r=[]}r.push(i);this._jointNodesMap.set(e.childSid,r)}if(!a){var n=this._jointParentsMap.get(e.parentSid);if(!n){n=[]}n.push(i);this._jointParentsMap.set(e.parentSid,n)}this._joints.push(i)}.bind(this));return this};E.prototype.finalizeAnimation=function(){var e=this._rootNode;if(e){while(e.parent){e=e.parent}e.userData.tracks=this._tracks}return this};E.prototype.finalizePlaybacks=function(){var e=this._rootNode;if(e){while(e.parent){e=e.parent}}else{return this}if(!e.userData.animationNodeOriginalData){e.userData.animationNodeOriginalData=new Map}var t;var a=this._viewGroups.entries();var i=a.next();while(!i.done){t=i.value[1];i=a.next();var r=[];for(var n=0;n<t.getViews().length;n++){if(t.getViews()[n].id){var s=this._views.get(t.getViews()[n].id);if(s){r.push(s)}}}}return this};E.prototype.finalizeViewGroups=function(e){this._resetCurrentScene(e);var t=this._viewGroups.entries();var a=t.next();while(!a.done){var i=a.value[1];var r=a.value[0];if(!i||!i.views||!i.views.length){a=t.next();continue}i.removeViews();for(var n=0;n<i.views.length;n++){var s=i.views[n].id;var o=this._views.get(s);if(o&&o.userData.viewInfo.thumbnailId&&!o.thumbnailData){var d=this._images.get(o.userData.viewInfo.thumbnailId);if(d){o.thumbnailData=d}}if(o){o.viewGroupId=r;i.addView(o)}}a=t.next()}return this};E.prototype.insertViewGroup=function(e,t){this._resetCurrentScene(t);var a=this._viewGroups.get(e.id);if(!a){a=this._vkScene.createViewGroup({viewGroupId:e.id,name:e.name,description:e.description});this._viewGroups.set(e.id,a)}else{a.setViewGroupId(e.id);a.setName(e.name);a.setDescription(e.description)}a.type=e.type;a.metadata=e.metadata;a.veids=e.veids;a.views=e.views;a.sceneId=e.sceneId;return this};E.prototype.getViewGroup=function(e,t){this._resetCurrentScene(t);var a=this._viewGroups.get(e);var i=[];if(a&&a.views){for(var r=0;r<a.views.length;r++){var n=a.views[r].id;var s=this._views.get(n);if(s){i.push(s)}}}return i};E.prototype.insertView=function(e,t){this._resetCurrentScene(t);if(e.description){var a=new RegExp("^<[^>]*?>");if(a.test(e.description)){var i=new RegExp("(^(<[^>]*?>s*)+)|((<[^>]*?>s*)+$)","g");var r=e.description.replace(i,"");if(!r){e.description=r}}}var n=this._vkScene.createView({viewId:e.viewId,name:e.name,description:e.description?'<pre class="sapVizKitViewGalleryStepDescriptionPre">'+e.description+"</pre>":e.description,aspectRatio:e.safeAreaAspectRatio,autoPlayAnimation:e.autoPlayAnimation});n.userData={};n.userData.viewInfo=e;if(e.thumbnailId){var s=this._images.get(e.thumbnailId);if(s){n.thumbnailData=s}else{this._viewThumbnails.set(e.thumbnailId,n)}}if(e.animatedThumbnailId){var o=this._images.get(e.animatedThumbnailId);if(o){n.animatedThumbnailData=o;n.tileWidth=this._imageIdsAndTileWidths.get(e.animatedThumbnailId)}}if(e.cameraId){n.setCamera(this._cameras.get(e.cameraId))}n.type=e.type;n.flyToTime=e.flyToTime;n.preDelay=e.preDelay;n.postDelay=e.postDelay;n.navigationMode=e.navigationMode;var d=this._getSavedColor(e.topColour,localStorage.getItem("color.backgroundTop"));if(d!=null){n.setTopColor(d)}var l=this._getSavedColor(e.bottomColour,localStorage.getItem("color.backgroundBottom"));if(l!=null){n.setBottomColor(l)}n.renderMode=B[e.renderMethod];n.dimension=e.dimension;n.query=e.query;n.metadata=e.metadata;n.veids=e.veids;n.viewGroupId=e.viewGroupId;n.id=e.viewId;this._views.set(e.viewId,n);if(n.viewGroupId){var u=this._viewGroups.get(n.viewGroupId);if(u){u.addView(n)}}return this};E.prototype.setModelViewVisibilitySet=function(e){var a=this._views.get(e.viewId);var i=new Set;var r=[];e.visibleNodes.forEach(function(e){var a=this._nodes.get(e);if(a){i.add(a);r.push({target:a,visible:true})}else{t.warning("Unknown modelView visible node reference",e)}}.bind(this));Array.from(i).forEach(function(e){e=e.parent;while(e&&!i.has(e)){i.add(e);r.push({target:e,visible:true});e=e.parent}});if(a){a.updateNodeInfos(r)}};E.prototype.recordHighlightedNodeInView=function(e,t,a,i){this._resetCurrentScene(i);var r=this._views.get(a);if(!r){return this}var n=this._nodes.get(t);if(!n){return this}r.addHighlightedNodes(e,n);return this};E.prototype.insertHighlightStyle=function(e){var t=this._vkScene.getHighlight(e.id);if(t){return this}if(e.duration>0){if(e.colours&&e.colours.length===1&&(!e.opacities||e.opacities.length===1)){var a=e.colours[0];e.colours.push([a[0],a[1],a[2],0])}else if(!e.colours&&e.opacities&&e.opacities.length===1){e.opacities.push(0)}}this._vkScene.createHighlight(e.id,e);return this};E.prototype.insertModelViewHighlight=function(t){var a=this._views.get(t.viewId);if(a){var i=[];t.highlightNodes.forEach(function(e){var t=this._nodes.get(e);if(t){i.push(t)}else{}}.bind(this));var r={duration:t.duration,cycles:t.cycles};if(!t.id){t.id=e.Math.generateUUID().toLowerCase()}var n=new e.Color(t.color1).toArray();var s=new e.Color(t.color2).toArray();n[3]=(t.color1>>>24&255)/255;s[3]=(t.color2>>>24&255)/255;r.colours=[n,s];r.opacities=[t.opacity1,t.opacity2];this._vkScene.createHighlight(t.id,r);a.addHighlightedNodes(t.id,i)}};E.prototype.createThumbnail=function(e){var t=this._viewThumbnails.get(e.imageId);if(t){t.thumbnailData="data:image/"+"jpeg"+";base64,"+window.btoa(String.fromCharCode.apply(null,e.data));if(this._fireThumbnailLoaded){this._fireThumbnailLoaded({modelView:t})}}};E.prototype.highlightStyleExists=function(e){var t=this._vkScene.getHighlight(e);return t!==undefined};E.prototype.getView=function(e,t){this._resetCurrentScene(t);return this._views.get(e)};E.prototype.getSequence=function(e){return this._vkScene.findSequence(e)};E.prototype.setViewCamera=function(e,t,a){this._resetCurrentScene(a);var i=this._cameras.get(e);var r=this._views.get(t);if(i&&r){r.setCamera(i)}return this};E.prototype.setViewNodeInfos=function(e,t,a){this._resetCurrentScene(a);var i=this._views.get(t);i.setNodeInfos(e);return this};E.prototype.setViewThumbnail=function(e,t,a,i){this._resetCurrentScene(a);var r=this._views.get(t);var n=this._images.get(e);if(i){this._imageIdsAndTileWidths.set(e,i)}if(r&&n){if(r.userData!==undefined){if(r.userData.viewInfo.thumbnailId===e){r.thumbnailData=n}else if(r.userData.viewInfo.animatedThumbnailId===e){r.animatedThumbnailData=n;r.tileWidth=i}}}return this};E.prototype.cleanup=function(){this._rootNode=null;this._currentSceneId=null;this._contentResource=null;this._resolve=null;this._reject=null;if(this._vkScene){this._vkScene.clearMaterials()}this._callouts.forEach(function(e){e.destroy()});this._callouts.clear();this._cameras.forEach(function(t){if(!t instanceof e.Camera){t.destroy()}});this._cameras.clear();this._images.clear();this._imageIdsAndTileWidths.clear();this._imageTextures.clear();this._geometries.clear();this._meshNodes.clear();this._meshSubmeshes.clear();this._geometryMeshes.clear();this._materialMeshes.clear();this._materialClones.clear();this._joints=[];this._annotations.clear();this._imageAddedToMaterialHandlers=[];if(this._nodes){this._nodes.clear()}if(this._tracks){this._tracks.clear()}if(this._trackIdSequenceNodeMap){this._trackIdSequenceNodeMap.clear()}if(this._viewGroups){this._viewGroups.clear()}if(this._views){this._views.clear()}this._sceneIdTreeNodesMap.clear();this._sceneIdRootNodeMap.clear();this._viewThumbnails.clear();this._thrustlines.clear();this._animations.clear();this._animationTracks.clear();this._jointNodesMap.clear();this._jointParentsMap.clear()};E.prototype.insertAnimationGroup=function(e){var t=this._vkScene.findSequence(e.animationGroupRef.toString());if(!t){var a;if(e.endTime){a=e.endTime-e.startTime;if(!e.startTime){e.startTime=0}}t=this._vkScene.createSequence(e.animationGroupRef.toString(),{name:e.name,duration:a});if(!t.userData){t.userData={}}t.userData.animations=[]}if(e.modelViewRef){var i=this._views.get(e.modelViewRef);if(i){var r=this._vkScene.findSequence(e.animationGroupRef.toString());var n=new D({sequence:r,timeScale:e.playbackSpeed?1/e.playbackSpeed:1,preDelay:e.playbackPreDelay?e.playbackPreDelay:0,postDelay:e.playbackPostDelay?e.playbackPostDelay:0,repeat:e.playbackRepeat?Math.abs(e.playbackRepeat):0,reversed:e.playbackReversed?true:false,startTime:0});i.addPlayback(n)}}};E.prototype.insertAnimation=function(e){var t=this._animations.get(e.animationRef);if(!t){t={};t.type=e.animationType;t.targetRefs=[];t.targetPivots=[];t.sequenceId=e.animationGroupRef.toString();t.trackIds=new Set;t.tracks=[];this._animations.set(e.animationRef,t)}if(e.animationGroupRef){var a=this._vkScene.findSequence(e.animationGroupRef.toString());if(!a.userData.animations.includes(e.animationRef)){a.userData.animations.push(e.animationRef)}}};E.prototype.insertAnimationTarget=function(e){var t=this._animations.get(e.animationRef);if(t){if(!t.targetRefs.includes(e.targetRef)){t.targetRefs.push(e.targetRef);t.targetPivots.push({x:e.targetPivotX,y:e.targetPivotY,z:e.targetPivotZ})}}};E.prototype.insertAnimationTrack=function(e){var t=this._animationTracks.get(e.animationTrackRef);var a=e.animationRef;if(!t){delete e.animationRef;t=e;this._animationTracks.set(e.animationTrackRef,t)}if(!a){return}var i=this._animations.get(a);if(!i||!i.sequenceId){return}if(i.trackIds.has(t.animationTrackRef)){return}i.trackIds.add(t.animationTrackRef);for(var n=0;i.targetRefs&&n<i.targetRefs.length;n++){var s=i.targetRefs[n];var o=i.targetPivots[n];var d=this._nodes.get(s);if(!d){continue}var l;if(o.x!==0||o.y!==0||o.z!==0){l=[o.x,o.y,o.z]}var u=["OPACITY","COLOUR","TRANSLATE","SCALE","ROTATE"][t.type]||"";r.pushElementIntoMapArray(this._trackIdSequenceNodeMap,e.animationTrackRef,{sequenceId:i.sequenceId,targetId:s,type:u,pivot:l,isAbsoluteValue:true});var h={};h.times=Array.prototype.slice.call(t.times);h.values=Array.prototype.slice.call(t.values);h.id=e.animationTrackRef;h.cyclicInfo={};h.cyclicInfo.cyclicStart=t.cyclicStart;h.cyclicInfo.cyclicEnd=t.cyclicEnd;var c;if(i.type===0){if(t.dataType===0){if(t.values.length!==t.keyCount||t.times.length!==t.keyCount){continue}if(t.type===3){h.values=[];for(c=0;c<t.keyCount;c++){h.values.push(t.values[c]);h.values.push(t.values[c]);h.values.push(t.values[c])}}}else if(t.dataType===1||t.dataType===3){if(t.values.length!==3*t.keyCount||t.times.length!==t.keyCount){continue}}else if(t.dataType===4||t.dataType===5||t.dataType===6){if(t.values.length!==4*t.keyCount||t.times.length!==t.keyCount){continue}if(t.dataType===4){h.rotateType=I.AngleAxis}else if(t.dataType===6){h.rotateType=I.Euler}else{h.rotateType=I.Quaternion;for(var p=3;p<h.values.length;p=p+4){h.values[p]=-h.values[p]}}}}i.tracks.push(h)}};E.prototype.setAnimationTracks=function(e){var t=this._animations.get(e);if(t){this._animationHelper.insertTracks(t.tracks,this._trackIdSequenceNodeMap,this._nodes,this._vkScene)}};E.prototype.setAnimationPlaybacks=function(e){var t=this._viewGroups.get(e.viewGroupId);this._animationHelper.setInitialNodePositionsFromSubsequentViews(t.getViews(),this._vkScene);this._animationHelper.setInitialNodePositionsFromPreviousViews(t.getViews(),this._vkScene);this._animationHelper.setInitialNodePositionsFromCurrenetViews(t.getViews(),this._vkScene);this._animationHelper.setPlaybackStartTimes(t.getViews(),this._vkScene);this._animationHelper.buildViewsInitialState(t.getViews(),this._vkScene)};E.prototype.getSphere=function(e,t,a){var i=A.generateSphere(t,a);if(e.userData&&e.userData.nodeContentType){i.userData.nodeContentType=e.userData.nodeContentType}i.userData.skipIt=true;i.renderOrder=e.renderOrder;e.add(i)};E.prototype.getPlane=function(e,t,a){var i=A.generatePlane(t,a);if(e.userData&&e.userData.nodeContentType){i.userData.nodeContentType=e.userData.nodeContentType}i.userData.skipIt=true;i.renderOrder=e.renderOrder;e.add(i)};E.prototype.preferMeshes=function(){return true};E.prototype.setParametricContent=function(e,a,i){this._resetCurrentScene(i);var r={sphere:this.getSphere.bind(this),plane:this.getPlane.bind(this)};if(a.type in r===false){t.warning("Attempt to load unknown parametric type: "+a.type);return}var n=a.type;var s=this.getNode(e,this.sceneId);var o=a.materialID;var d=null;if(o){d=this._getMaterialRef(o)||this._createTemporaryMaterial(o);if(s.userData.parametricVisible){d.userData.parametricType=n}}r[n](s,a,d)};E.prototype.insertFillStyle=function(e){};E.prototype.insertLineStyle=function(e){};E.prototype.insertTextStyle=function(e){};E.prototype._getSavedColor=function(e,t){if(e&&e.length>2){return P({red:Math.floor(e[0]*255),green:Math.floor(e[1]*255),blue:Math.floor(e[2]*255),alpha:e.length>3?e[3]:1})}else if(t){return t}return undefined};return E});
//# sourceMappingURL=SceneBuilder.js.map