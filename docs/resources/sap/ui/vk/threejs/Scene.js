/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
 */
sap.ui.define(["../Scene","./NodeHierarchy","../RenderMode","./ThreeExtensions","./ThreeUtils","sap/base/util/uid"],function(e,t,i,r,a,n){"use strict";var o=e.extend("sap.ui.vk.threejs.Scene",{metadata:{library:"sap.ui.vk"},constructor:function(t){e.call(this);this._id=n();this._scene=t;this._sceneBuilder=null;this._defaultNodeHierarchy=null;this._currentViewStateManager=null;this._animationSequenceMap=new Map;this._initialView=null;this._materialMap=new Map}});o.prototype.init=function(){this._outlineColor=new THREE.Vector4(0,0,0,1);this._outlineMaterial=new THREE.ShaderMaterial({uniforms:{color:{value:this._outlineColor}},vertexShader:["attribute vec3 normal1;","attribute vec3 normal2;","#include <clipping_planes_pars_vertex>","uniform vec4 color;","varying vec4 vColor;","void main() {","\t#include <begin_vertex>","\t#include <project_vertex>","\t#include <clipping_planes_vertex>","\tvec3 eyeDirection = mvPosition.xyz;","\tvec3 n1 = normalMatrix * normal1;","\tvec3 n2 = normalMatrix * normal2;","\tvColor = color;","\tvColor.a *= step(dot(eyeDirection, n1) * dot(eyeDirection, n2), 0.0);","}"].join("\n"),fragmentShader:["#include <clipping_planes_pars_fragment>","varying vec4 vColor;","void main() {","\t#include <clipping_planes_fragment>","\tif (vColor.a < ALPHATEST) discard;","\tgl_FragColor = vColor;","}"].join("\n"),depthWrite:false,depthFunc:THREE.LessEqualDepth,polygonOffset:true,polygonOffsetFactor:-4,blending:THREE.NormalBlending,alphaTest:.01,clipping:true});this._solidWhiteMaterial=new THREE.MeshBasicMaterial({color:16777215})};o.prototype.clearThreeScene=function(){if(!this._scene){return}var e=[];var t=[];a.getAllTHREENodes([this._scene],e,t);var i=new Map;var r=new Map;e.forEach(function(e){if(e instanceof THREE.Mesh){if(!i.has(e.geometry.uuid)){a.disposeGeometry(e);i.set(e.geometry.uuid,true)}if(e.material){if(!r.has(e.material.uuid)){a.disposeMaterial(e.material);r.set(e.material.uuid,true)}}if(e.userData&&e.userData.originalMaterial&&e.userData.originalMaterial.uuid!==e.material.uuid&&!r.has(e.userData.originalMaterial.uuid)){a.disposeMaterial(e.userData.originalMaterial);r.set(e.userData.originalMaterial.uuid,true)}}e.parent.remove(e)});t.forEach(function(e){e.parent.remove(e)});i.clear();r.clear()};o.prototype.destroy=function(){this.clearThreeScene();if(this._defaultNodeHierarchy){this._defaultNodeHierarchy.destroy();this._defaultNodeHierarchy=null}a.disposeMaterial(this._solidWhiteMaterial);a.disposeMaterial(this._outlineMaterial);this._sceneBuilder=null;if(this._scene){this._scene.dispose()}this._scene=null;this._currentViewStateManager=null;this._animationSequenceMap.clear();this._materialMap.clear();e.prototype.destroy.call(this)};o.prototype.setDoubleSided=function(e){this.setProperty("doubleSided",e,true);this._scene.traverse(function(t){if(t.material!==undefined){var i=t.userData;var r=THREE.FrontSide;var a;if(i.originalMaterial){if(i.originalMaterial.userData===undefined){i.originalMaterial.userData={}}a=i.originalMaterial.userData;if(a.originalMaterialSide===undefined){a.originalMaterialSide=i.originalMaterial.side}r=a.originalMaterialSide}else{if(t.material.userData===undefined){t.material.userData={}}a=t.material.userData;if(a.originalMaterialSide===undefined){a.originalMaterialSide=t.material.side}r=a.originalMaterialSide}t.material.side=e?THREE.DoubleSide:r}});return this};o.prototype.setViewStateManager=function(e){this._currentViewStateManager=e;return this};o.prototype.getViewStateManager=function(){return this._currentViewStateManager};o.prototype.getId=function(){return this._id};o.prototype.getDefaultNodeHierarchy=function(){if(!this._defaultNodeHierarchy){this._defaultNodeHierarchy=new t(this)}return this._defaultNodeHierarchy};o.prototype._computeBoundingBox=function(e,t,i){var r=new THREE.Box3;if(this._scene){this._scene._expandBoundingBox(r,e,t,i)}return r};o.prototype.getSceneRef=function(){return this._scene};o.prototype.setSceneBuilder=function(e){this._sceneBuilder=e};o.prototype.getSceneBuilder=function(){return this._sceneBuilder};o.prototype.nodeRefToPersistentId=function(e){return Array.isArray(e)?e.map(function(e){return e._vkPersistentId()}):e._vkPersistentId()};o.prototype.persistentIdToNodeRef=function(e){var t=this._sceneBuilder;if(Array.isArray(e)){return e.map(function(e){return t?t.getNode(e):null})}else{return t?t.getNode(e):null}};o.prototype.setNodePersistentId=function(e,t,i){return this._sceneBuilder?this._sceneBuilder.setNodePersistentId(e,t,i):false};o.prototype.setAnnotationPersistentId=function(e,t,i){return this._sceneBuilder?this._sceneBuilder.setAnnotationPersistentId(e,t,i):false};o.prototype.enumerateMaterials=function(){if(!this._defaultNodeHierarchy){return[]}var e=this._defaultNodeHierarchy.createNodeProxy(this._scene);if(e){return e.enumerateMaterials(true)}else{return[]}};var l=0;function s(e,t){var i=e.x-t.x;if(i<-l){return true}if(i>l){return false}var r=e.y-t.y;if(r<-l){return true}if(r>l){return false}return e.z-t.z<-l}function u(e,t,i){if(t<i){var r=c(e,t,i);u(e,t,r-1);u(e,r+1,i)}return e}function c(e,t,i){var r=e[i],a=t;for(var n=t;n<i;n++){if(s(e[n],r)){f(e,n,a);a++}}f(e,i,a);return a}function f(e,t,i){if(t!=i){var r=e[t];e[t]=e[i];e[i]=r}}var d=new THREE.Vector3;function h(e){e.computeBoundingBox();e.boundingBox.getSize(d);l=Math.max(d.x,d.y,d.z)*1e-4;var t=e.vertices,i=t.length,r=e.faces.length;if(i===0||r===0){return}var a,n;for(a=0;a<i;a++){t[a].index=a}u(t,0,t.length-1);var o=[],c=[];o.push(t[0]);c[t[0].index]=o.length-1;for(a=1;a<i;a++){if(s(o[o.length-1],t[a])){o.push(t[a])}c[t[a].index]=o.length-1}e.vertices=o;for(a=0,r=e.faces.length,n=0;a<r;a++){var f=e.faces[a];var h=e.faces[n];h.a=c[f.a];h.b=c[f.b];h.c=c[f.c];if(h.a!==h.b&&h.b!==h.c&&h.c!==h.a){n++}}e.faces.length=n}function p(e,t){THREE.BufferGeometry.call(this);this.type="OutlineGeometry";var i=Math.cos(THREE.Math.DEG2RAD*(t!==undefined?t:1));var r={},a,n;var o,l=["a","b","c"];var s=new THREE.Vector3;var u;if(e.isBufferGeometry){u=new THREE.Geometry;u.fromBufferGeometry(e)}else{u=e.clone()}h(u);u.computeFaceNormals();var c=u.vertices;var f=u.faces;for(var d=0,p=f.length;d<p;d++){var m=f[d];for(var v=0,y=2;v<3;y=v++){a=m[l[y]];n=m[l[v]];o=Math.min(a,n)+","+Math.max(a,n);if(r[o]===undefined){r[o]={index1:a,index2:n,face1:d,face2:undefined}}else{r[o].face2=d}}}var M=[];var _=[];var g=[];for(o in r){var E=r[o];if(E.face2===undefined||f[E.face1].normal.dot(f[E.face2].normal)<=i&&s.copy(c[E.index2]).sub(c[E.index1]).cross(f[E.face1].normal).dot(f[E.face2].normal)>0){var x=c[E.index1];M.push(x.x,x.y,x.z);x=c[E.index2];M.push(x.x,x.y,x.z);var B=f[E.face1].normal;_.push(B.x,B.y,B.z);_.push(B.x,B.y,B.z);if(E.face2!==undefined){var S=f[E.face2].normal;g.push(S.x,S.y,S.z);g.push(S.x,S.y,S.z)}else{g.push(0,0,0);g.push(0,0,0)}}}this.setAttribute("position",new THREE.Float32BufferAttribute(M,3));this.setAttribute("normal1",new THREE.Float32BufferAttribute(_,3));this.setAttribute("normal2",new THREE.Float32BufferAttribute(g,3))}p.prototype=Object.create(THREE.BufferGeometry.prototype);p.prototype.constructor=p;function m(e){return e===null||e.min.x>=e.max.x&&e.min.y>=e.max.y&&e.min.z>=e.max.z}function v(e){var t=null;if(e.isMesh&&e.geometry&&!m(e.geometry.boundingBox)&&!e.userData.skipIt){t=e.geometry;if(t.isBufferGeometry){t=(new THREE.Geometry).fromBufferGeometry(t)}}for(var i=0,r=e.children.length;i<r;i++){var a=e.children[i];if(a.isMesh&&a.geometry&&!m(a.geometry.boundingBox)&&a.userData.skipIt){if(t===null){t=new THREE.Geometry}var n=a.geometry;if(n.isBufferGeometry){n=(new THREE.Geometry).fromBufferGeometry(n)}t.merge(n,a.matrix)}}return t}function y(e,t){var i=e.userData;if(i.defaultMaterial===undefined){i.defaultMaterial=i.originalMaterial||e.material}e.material=t;i.originalMaterial=null;e._vkUpdateMaterialColor();e._vkUpdateMaterialOpacity()}function M(e){var t=e.userData;if(t.defaultMaterial){e.material=t.defaultMaterial;delete t.defaultMaterial;t.originalMaterial=null;e._vkUpdateMaterialColor();e._vkUpdateMaterialOpacity()}}o.prototype._createOutlineGeometry=function(e){if(this._scene){this._scene._vkTraverseMeshNodes(function(t){if(t.isOutline){t.visible=true}else{if(!t.hasOutline){var r;try{r=v(t)}catch(e){r=null}if(r!==null){t.hasOutline=true;var a=new p(r);a.boundingBox=new THREE.Box3;var n=new THREE.LineSegments(a,this._outlineMaterial);n.isOutline=true;n.renderOrder=t.renderOrder+.5;t.add(n)}}if(t.isMesh&&t.material&&!t.material.isLineBasicMaterial&&!t.material.isLineMaterial){switch(e){case i.LineIllustration:y(t,this._solidWhiteMaterial);break;case i.ShadedIllustration:var o=(t.userData.defaultMaterial||t.userData.originalMaterial||t.material).clone();if(o.emissive){o.color.multiplyScalar(.5);o.emissive.multiplyScalar(.5).addScalar(.5)}else{o.color.multiplyScalar(.5).addScalar(.5)}y(t,o);break;default:M(t);break}}}}.bind(this))}};o.prototype._hideOutlineGeometry=function(){if(this._scene){this._scene._vkTraverseMeshNodes(function(e){if(e.isOutline){e.visible=false}if(e.isMesh){M(e)}})}};o.prototype.getInitialView=function(){return this._initialView};o.prototype.setInitialView=function(e){this._initialView=e};o.prototype.getMaterial=function(e){return this._materialMap.get(e)};o.prototype.setMaterial=function(e,t){this._materialMap.set(e,t)};o.prototype.clearMaterials=function(){this._materialMap.forEach(function(e,t){e.destroy()});this._materialMap.clear()};o.prototype._getNativeMaterial=function(e){var t=e?this._materialMap.get(e):null;return t?t.getMaterialRef():null};o.prototype._setNodeMaterial=function(e,t){var i=this._getNativeMaterial(t);e.children.forEach(function(e){if(e.material){if(i){if(e.userData.materialId!==t){this._sceneBuilder._setSubmeshMaterial(e,i,t)}}else{var r=e.userData.initialMaterialId;if(r&&e.userData.materialId!==r){var a=this._getNativeMaterial(r);if(a){this._sceneBuilder._setSubmeshMaterial(e,a,r)}}}}}.bind(this))};return o});
//# sourceMappingURL=Scene.js.map