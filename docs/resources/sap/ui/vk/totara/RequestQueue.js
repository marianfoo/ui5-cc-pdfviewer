/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
 */
sap.ui.define(["./TotaraUtils","./Command","../IncludeUsageIdType","sap/base/Log"],function(t,e,i,s){"use strict";function h(t){this.getBatchSize=t;this.globalList=new Set;this.requestedList=[];this.waitingList=new Map}h.prototype.push=function(t,e){if(!this.globalList.has(t)){this.globalList.add(t);this.requestedList.push(e||t);this.waitingList.set(t,e)}};h.prototype.setBatchSizeInfo=function(t){this.batchSizeInfo=t};h.prototype.fetchBatch=function(){var t=this.getBatchSize?this.getBatchSize:1;if(typeof this.getBatchSize==="function"){t=this.getBatchSize()}var e=0;var i=[];for(var s=0;s<t&&this.requestedList.length>0;s++){var h=this.requestedList.pop();var n=h.id?h.id:h;e+=n.toString().length+(s==0||!this.batchSizeInfo?0:this.batchSizeInfo.separatorLength);if(this.batchSizeInfo&&e>this.batchSizeInfo.maxBatchStringLength){this.requestedList.push(n);break}i.push(n)}return i};h.prototype.pop=function(t){var e=this.requestedList.indexOf(t);if(e>-1){this.requestedList.splice(e,1)}return this.waitingList.delete(t)};h.prototype.isReady=function(t){return this.globalList.has(t)&&!this.waitingList.has(t)};h.prototype.clear=function(t){this.globalList.clear();this.requestedList=[];this.waitingList.clear()};h.prototype.isEmpty=function(){return this.requestedList.length===0};h.prototype.isWaiting=function(){return this.waitingList.size>0};h.prototype.isInitialViewCompleted=function(){var t=this.requestedList.filter(function(t){return t.isInitial});var e=[];this.waitingList.forEach(function(t,i){if(t&&t.isInitial){e.push(i)}});return t.length===0&&e.length===0};function n(t,e){h.call(this,t);this.getMaxBatchDataSize=e;this.priorityMap=new Map}n.prototype=Object.create(h.prototype);n.prototype.constructor=n;n.prototype.push=function(t,e,i,s){if(!this.globalList.has(t)){i=i||1;this.globalList.add(t);this.requestedList.push(s||t);this.waitingList.set(t,s);this.priorityMap.set(t,{p:e,s:i})}};n.prototype.clear=function(){h.prototype.clear.call(this);this.priorityMap.clear()};n.prototype.setBatchSizeInfo=function(t){this.batchSizeInfo=t};n.prototype.fetchBatch=function(){var t=this.priorityMap;this.requestedList.sort(function(e,i){return t.get(e.id?e.id:e).p-t.get(i.id?i.id:i).p});var e=[];var i=0;var s=this.getBatchSize?this.getBatchSize():1;var h=0;var n=this.getMaxBatchDataSize?this.getMaxBatchDataSize():1024*1024;var a=n>>1;for(var r=0;r<s&&this.requestedList.length>0;r++){var o=this.requestedList.pop();var c=o.id?o.id:o;h+=c.toString().length+(r==0||!this.batchSizeInfo?0:this.batchSizeInfo.separatorLength);var p=t.get(c).s;if(this.batchSizeInfo&&h>this.batchSizeInfo.maxBatchStringLength||i>a&&i+p>n){this.requestedList.push(c);break}i+=p;t.delete(c);e.push(c)}return e};var a=function(e,i){this.context=e;this.sceneId=i;this.token=e.token||t.generateToken();var s=e.loader;this.meshes=new h(s.getMeshesBatchSize.bind(s));this.materials=new h(s.getMaterialsBatchSize.bind(s));this.textures=new h;this.geometries=new n(s.getGeometriesBatchSize.bind(s),s.getGeometriesMaxBatchDataSize.bind(s));this.geomMeshes=new n(s.getGeomMeshesBatchSize.bind(s),s.getGeomMeshesMaxBatchDataSize.bind(s));this.annotations=new h(s.getAnnotationsBatchSize.bind(s));this.parametric=new h(s.getParametricsBatchSize.bind(s));this.views=new h;this.thumbnails=new h;this.tracks=new h(s.getTracksBatchSize.bind(s));this.sequences=new h(s.getSequencesBatchSize.bind(s));this.highlights=new h};a.prototype.isEmpty=function(){return this.meshes.isEmpty()&&this.annotations.isEmpty()&&this.parametric.isEmpty()&&this.materials.isEmpty()&&this.textures.isEmpty()&&this.geometries.isEmpty()&&this.geomMeshes.isEmpty()&&this.views.isEmpty()&&this.thumbnails.isEmpty()&&this.tracks.isEmpty()&&this.sequences.isEmpty()&&this.highlights.isEmpty()};a.prototype.isWaitingForContent=function(){return this.meshes.isWaiting()||this.textures.isWaiting()||this.materials.isWaiting()||this.geometries.isWaiting()||this.geomMeshes.isWaiting()||this.annotations.isWaiting()||this.parametric.isWaiting()||this.views.isWaiting()||this.thumbnails.isWaiting()||this.tracks.isWaiting()||this.sequences.isWaiting()||this.highlights.isWaiting()};a.prototype.clearContent=function(){this.meshes.clear();this.annotations.clear();this.parametric.clear();this.materials.clear();this.textures.clear();this.geometries.clear();this.geomMeshes.clear();this.views.clear();this.thumbnails.clear();this.tracks.clear();this.sequences.clear();this.highlights.clear()};a.prototype.createGetContentCommand=function(e,i,s){var h={sceneId:this.sceneId,ids:i.map(function(t){return parseInt(t,10)}),token:this.token};return t.createRequestCommand(e,s?Object.assign(h,s):h)};a.prototype.generateRequestCommand=function(){var i;var h=null;if(!this.meshes.isEmpty()){i=this.meshes.fetchBatch();throw new Error("Command "+e.getMesh+" is not implemented")}else if(!this.annotations.isEmpty()){i=this.annotations.fetchBatch();h={method:e.getAnnotation,parameters:{sceneId:this.sceneId,annotationIds:i}}}else if(!this.parametric.isEmpty()){i=this.parametric.fetchBatch();throw new Error("Command "+e.getParametric+" is not implemented")}else if(!this.materials.isEmpty()){i=this.materials.fetchBatch();h={method:e.getMaterial,parameters:{sceneId:this.sceneId,materialIds:i}}}else if(!this.geometries.isEmpty()){i=this.geometries.fetchBatch();throw new Error("Command "+e.getGeometry+" is not implemented")}else if(!this.geomMeshes.isEmpty()){i=this.geomMeshes.fetchBatch();var n=i.map(function(t){return t.id?t.id:t});h=this.createGetContentCommand(e.getGeomMesh,n);h.sceneId=this.sceneId;h.meshIds=n}else if(!this.textures.isEmpty()){i=this.textures.requestedList.splice(0,1);s.info("Requesting texture: "+i[0].imageId);h=this.createGetContentCommand(e.getImage,[i[0].imageId]);h.sceneId=this.sceneId;h=Object.assign(h,i[0])}else if(!this.sequences.isEmpty()){i=this.sequences.fetchBatch();throw new Error("Command "+e.getSequence+" is not implemented")}else if(!this.tracks.isEmpty()){i=this.tracks.fetchBatch();throw new Error("Command "+e.getTrack+" is not implemented")}else if(!this.views.isEmpty()){i=this.views.requestedList.splice(0,1);h={method:e.getView,parameters:{sceneId:this.sceneId,viewId:i[0].viewId,query:t.configureSceneViewQuery(this.context)}}}else if(!this.highlights.isEmpty()){i=this.highlights.requestedList.splice(0,1);throw new Error("Command "+e.getHighlightStyle+" is not implemented")}else if(!this.thumbnails.isEmpty()){i=this.thumbnails.requestedList.splice(0,1);h=this.createGetContentCommand(e.getImage,[i[0].imageId]);h.sceneId=this.sceneId;h=Object.assign(h,i[0])}return h};return a});
//# sourceMappingURL=RequestQueue.js.map