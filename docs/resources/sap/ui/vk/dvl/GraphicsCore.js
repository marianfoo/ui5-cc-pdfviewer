/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
 */
sap.ui.define(["sap/ui/base/EventProvider","../thirdparty/html2canvas","../ve/dvl","./Scene","../ContentResource","../DownloadManager","./ViewStateManager","../DvlException","../Messages","sap/ui/thirdparty/URI","./GraphicsCoreApi","./checkResult","./getPointer","./getJSONObject","../getResourceBundle","../utf8ArrayBufferToString","sap/base/assert","sap/base/util/uid","sap/base/Log","sap/ui/core/Core"],function(e,t,r,n,o,s,i,a,c,u,d,l,h,v,f,p,_,g,y,S){"use strict";function m(e){return e instanceof File?"local":"remote"}function w(e){return e instanceof File?e.name:e}var C=function(e){Object.defineProperties(this,{source:{value:e,writable:false,enumerable:true},_refCount:{value:0,writable:true,enumerable:false}})};C.prototype.isInUse=function(){return this._refCount>0};C.prototype.addRef=function(){++this._refCount;return this};C.prototype.release=function(){--this._refCount;_(this._refCount>=0,"Too many calls to SourceDatum.release().");return this};C.prototype.destroy=function(){};var D=function(e,t,r){C.call(this,e);Object.defineProperties(this,{content:{value:r,writable:false,enumerable:true},vdsSourceDatum:{value:t,writable:false,enumerable:true}})};D.prototype=Object.create(C.prototype);D.prototype.constructor=D;D.prototype.destroy=function(){_(this.vdsSourceDatum,"VDSL source without VDS reference");if(this.vdsSourceDatum){this.vdsSourceDatum.release()}C.prototype.destroy.call(this)};var R=function(e,t,r){Object.defineProperties(this,{dvlSceneId:{value:e,writable:false,enumerable:true},sourceDatum:{value:t,writable:false,enumerable:true},root:{value:!!r,writable:false,enumerable:true},_refCount:{value:0,writable:true,enumerable:false}})};R.prototype.isInUse=function(){return this._refCount>0};R.prototype.addRef=function(){++this._refCount;return this};R.prototype.release=function(){--this._refCount;_(this._refCount>=0,"Too many calls to DvlSceneDatum.release().");return this};R.prototype.destroy=function(){if(this.sourceDatum){this.sourceDatum.release()}};var L=function(e,t){Object.defineProperties(this,{source:{value:e.getSource()},sourceType:{value:e.getSourceType()},sourceId:{value:e.getSourceId(),writable:true},name:{value:e.getName()},localMatrix:{value:e.getLocalMatrix(),writable:true},password:{value:e.getPassword()},children:{value:e.getContentResources().map(function(e){return new L(e)})},dvlSceneDatum:{value:null,writable:true},nodeProxy:{value:null,writable:true},fake:{value:!!t},sourceProperties:{value:null,writable:true}});e._shadowContentResource=this};L.prototype.destroy=function(){if(this.dvlSceneDatum){this.dvlSceneDatum.release()}};var I=function(e,t){Object.defineProperties(this,{vkScene:{value:e},shadowContentResource:{value:t}})};var P=e.extend("sap.ui.vk.dvl.GraphicsCore",{metadata:{library:"sap.ui.vk",publicMethods:["attachSceneLoadingFinished","attachSceneLoadingProgress","attachSceneLoadingStarted","buildSceneTree","buildSceneTreeAsync","createViewStateManager","destroyScene","destroyViewStateManager","detachSceneLoadingFinished","detachSceneLoadingProgress","detachSceneLoadingStarted","getApi","loadContentResourcesAsync","showDebugInfo","updateSceneTree","updateSceneTreeAsync"]},constructor:function(t,r){e.apply(this);var n=jQuery.extend({},t,{filePackagePrefixURL:sap.ui.require.toUrl("sap/ui/vk/ve")+"/"});this._dvlClientId=g();var o=this;this._initialized=new Promise(function(e){o._initResolve=e});sap.ve.dvl.createRuntime(n).then(function(e){o._dvl=e;o._dvl.CreateCoreInstance(o._dvlClientId);l(o._dvl.Core.Init(o._DVLMajorVersion,o._DVLMinorVersion));var t=S;t.attachLocalizationChanged(o._onlocalizationChanged,o);l(o._dvl.Core.SetLocale(t.getConfiguration().getLanguageTag()));o._canvas=o._createRenderingCanvasAndContext(r);o._rendererId=h(o._dvl.Core.CreateRenderer());o._dvl.Renderer.SetOptionF(sap.ve.dvl.DVLRENDEROPTIONF.DVLRENDEROPTIONF_DPI,96*window.devicePixelRatio,o._rendererId);o._initResolve()});this._sourceData=[];this._dvlSceneData=[];this._vkSceneData=[];this._viewports=[];this._renderLoopRequestId=null;this._renderLoop=this._renderLoop.bind(this);this._viewStateManagers=[];this._authorizationHandler=null;this._retryCount=1},_DVLMajorVersion:7,_DVLMinorVersion:6});P.create=function(e,t){return new Promise(function(r,n){try{var o=new P(e,t);o._initialized.then(function(){r(o)})}catch(e){n(e)}})};P.prototype.destroy=function(){S.detachLocalizationChanged(this._onlocalizationChanged,this);var t=this._viewports.slice();t.reverse();t.forEach(function(e){e.control.setGraphicsCore(null)});this._viewports=null;this._cleanupVkSceneData();this._vkSceneData=null;this._cleanupDvlSceneData();_(this._dvlSceneData.length===0,"Not all DVL scenes are destroyed when sap.ui.vk.dvl.Scene objects are destroyed.");this._dvlSceneData=null;this._cleanupSourceData();_(this._sourceData.length===0,"Not all sources are deleted.");this._sourceData=null;this._viewStateManagers.slice().forEach(this.destroyViewStateManager.bind(this));this._viewStateManagers=null;this._webGLContext=null;this._canvas=null;this._dvl.Core.DeleteRenderer(this._rendererId);this._rendererId=null;this._dvl.Core.Release();this._dvl=null;e.prototype.destroy.apply(this)};P.prototype._createRenderingCanvasAndContext=function(e){var t=document.createElement("canvas");t.id=g();this._webGLContext=this._dvl.Core.CreateWebGLContext(t,e);return t};P.prototype._getCanvas=function(){return this._canvas};P.prototype._getWebGLContext=function(){return this._webGLContext};P.prototype._getDvl=function(){return this._dvl};P.prototype._getDvlClientId=function(){return this._dvlClientId};P.prototype._findSourceData=function(e){var t=Object.getOwnPropertyNames(e);return this._sourceData.filter(function(r){return t.every(function(t){return e[t]===r[t]})})};P.prototype._destroySourceDatum=function(e){if(!(e instanceof D)){this._dvl.Core.DeleteFileByUrl(w(e.source),m(e.source))}e.destroy();return this};P.prototype._cleanupSourceData=function(){var e=false;for(var t=this._sourceData.length-1;t>=0;--t){var r=this._sourceData[t];if(!r.isInUse()){var n=r instanceof D?r.vdsSourceDatum:null;this._sourceData.splice(t,1);this._destroySourceDatum(r);if(n&&!n.isInUse()){e=true}}}if(e){this._cleanupSourceData()}return this};P.prototype._findDvlSceneData=function(e){var t=Object.getOwnPropertyNames(e);return this._dvlSceneData.filter(function(r){return t.every(function(t){return e[t]===r[t]})})};P.prototype._destroyDvlSceneDatum=function(e){this._dvl.Scene.Release(e.dvlSceneId);e.destroy();return this};P.prototype._cleanupDvlSceneData=function(){for(var e=this._dvlSceneData.length-1;e>=0;--e){var t=this._dvlSceneData[e];if(!t.isInUse()){this._dvlSceneData.splice(e,1);this._destroyDvlSceneDatum(t)}}};P.prototype._findVkSceneData=function(e){var t=Object.getOwnPropertyNames(e);return this._vkSceneData.filter(function(r){return t.every(function(t){return e[t]===r[t]})})};P.prototype._cleanupVkSceneData=function(){for(var e=this._vkSceneData.length-1;e>=0;--e){this.destroyScene(this._vkSceneData[e].vkScene)}};P.prototype._destroyShadowContentResource=function(e,t){if(t.children){t.children.forEach(this._destroyShadowContentResource.bind(this,e))}if(t.nodeProxy){var r=e.getDefaultNodeHierarchy();try{r.removeNode(t.nodeProxy.getNodeRef())}catch(e){var n="Failed to delete node with ID = "+t.nodeProxy.getNodeRef()+".";if(e instanceof a){n+=" Error code: "+e.code+". Message: "+e.message+"."}y.error(n)}r.destroyNodeProxy(t.nodeProxy)}t.destroy()};P.prototype._filterContentResources=function(e,t){var r=[];e.forEach(function e(n){if(t(n)){r.push(n)}n.getContentResources().forEach(e)});return r};P.prototype._getContentResourcesWithMissingPasswords=function(e){var t=this._dvl.Library;return this._filterContentResources(e,function(e){var r=e.getSource();try{return r&&v(t.RetrieveInfo(w(r),m(r))).flags&sap.ve.dvl.DVLFILEFLAG.ENCRYPTED&&!e.getPassword()}catch(e){y.warning("Failed to get information from Emscripten virtual file system about file '"+w(r)+"'");return false}})};P.prototype._getContentResourcesWithEncryptedVds3=function(e){var t=this._dvl.Library;return this._filterContentResources(e,function(e){var r=e.getSource();if(r){try{var n=v(t.RetrieveInfo(w(r),m(r)));return n.major<=3&&n.flags&sap.ve.dvl.DVLFILEFLAG.ENCRYPTED}catch(e){y.warning("Failed to get information from Emscripten virtual file system about file '"+w(r)+"'");return false}}else{return false}})};P.prototype._collectAndCheckSourceProperties=function(e){var t=e.dvlSceneDatum.sourceDatum;if(!t){return this}try{if(t instanceof D){t=t.vdsSourceDatum}var r=v(this._dvl.Library.RetrieveInfo(w(t.source),m(t.source)));e.sourceProperties={version:{major:r.major,minor:r.minor}};if(r.flags&(sap.ve.dvl.DVLFILEFLAG.PAGESCOMPRESSED|sap.ve.dvl.DVLFILEFLAG.WHOLEFILECOMPRESSED)){e.sourceProperties.compressed=true}if(r.flags&sap.ve.dvl.DVLFILEFLAG.ENCRYPTED){e.sourceProperties.encrypted=true}}catch(t){y.warning("Failed to get information from Emscripten virtual file system about file '"+w(e.source)+"'")}return this};P.prototype.loadContentResourcesAsync=function(e,t,r){var n=this,o=[],i=new Map;e.forEach(function e(t){var r=t.getSource();if(r&&o.indexOf(r)<0&&n._findSourceData({source:r}).length===0){o.push(r);var s=t.getSource();var a;if(s instanceof Object){a=s.name}else{a=s}if(t.getSourceType()==="vdsl"||t.getSourceType()==="vds"&&a.split(".").pop()==="vdsl"){i.set(r,{})}}t.getContentResources().forEach(e)});var a=[];if(o.length>0){var d;var l=new s(o,null,this._authorizationHandler,this._retryCount).attachItemSucceeded(function(e){var t=e.getParameter("source");var r=e.getParameter("response");if(i.has(t)){var n=p(r);if(n.trim().length===0){d=d||[];d.push({source:t,status:c.VIT22.code,statusText:f().getText(c.VIT22.summary)});y.error(f().getText(c.VIT22.summary),c.VIT22.code,"sap.ui.vk.dvl.GraphicsCore");return}else{var s=n.split(/\n|\r\n/);var h=s[0].match(/^file=(.+)$/);if(!h){d=d||[];d.push({source:t,status:c.VIT23.code,statusText:f().getText(c.VIT23.summary)});y.error(f().getText(c.VIT23.summary),c.VIT23.code,"sap.ui.vk.dvl.GraphicsCore");return}else{var v=i.get(t);v.content=s;var _=h[1];var g=_;var S=new u(g);if(S.is("relative")){if(t instanceof File){d=d||[];d.push({source:t,status:c.VIT24.code,statusText:f().getText(c.VIT24.summary)});y.error(f().getText(c.VIT24.summary),c.VIT24.code,"sap.ui.vk.dvl.GraphicsCore");return}else{var w=new u(t);_=S.absoluteTo(w).href()}}v.referencedSource=_;v.content[0]=v.content[0].replace(g,this._dvl.Core.GetFilename(v.referencedSource,"remote"));if(o.indexOf(v.referencedSource)<0&&this._findSourceData({source:v.referencedSource}).length===0){o.push(v.referencedSource);l.queue(v.referencedSource)}}}}else{var D=t instanceof File;var R=D?t.name:t;var L=m(t);this._dvl.Core.CreateFileFromArrayBuffer(r,R,L);a.push(new C(t))}},this).attachAllItemsCompleted(function(e){Array.prototype.push.apply(this._sourceData,a);i.forEach(function(e,t){var r=this._findSourceData({source:e.referencedSource})[0];if(r){var n=new D(t,r,e.content.join("\n"));this._sourceData.push(n);r.addRef()}}.bind(this));if(t){t(d)}},this).attachItemFailed(function(e){d=d||[];d.push({source:e.getParameter("source"),status:e.getParameter("status"),statusText:e.getParameter("statusText")})},this);if(r){l.attachItemProgress(r,this)}l.start()}else if(t){t()}return this};P.prototype._buildPlaceholders=function(e,t,r,n){var o=[];n.forEach(function t(r,n,s){var i=e.createNode(r,s.name,n);s.nodeProxy=e.createNodeProxy(i);if(s.localMatrix){s.nodeProxy.setLocalMatrix(s.localMatrix)}if(s.source){o.push(s)}s.children.forEach(t.bind(this,i,null))}.bind(this,t,r));return o};P.prototype._updatePlaceholders=function(e,t,r){var n=this,o=e.getDefaultNodeHierarchy(),s=[];(function t(r,i,a){function c(e,t){if(!e&&!t){return true}else if(!!e^!!t){return false}else{return e.source===t.getSource()&&e.sourceType===t.getSourceType()&&e.name===t.getName()&&e.password===t.getPassword()}}function u(e,t){t._shadowContentResource=e;e.sourceId=t.getSourceId();e.localMatrix=t.getLocalMatrix();if(e.nodeProxy){e.nodeProxy.setLocalMatrix(e.localMatrix)}}var d=0;var l=jQuery.sap.arrayDiff(r,i,c,true);l.forEach(function(c){for(;d<c.index;++d){t(r[d].children,i[d].getContentResources(),r[d].nodeProxy.getNodeRef());u(r[d],i[d])}if(c.type==="delete"){n._destroyShadowContentResource(e,r[c.index]);r.splice(c.index,1)}else if(c.type==="insert"){var l;if(d<r.length&&r[d].nodeProxy){l=r[d].nodeProxy.getNodeRef()}var h=new L(i[c.index]);s=s.concat(n._buildPlaceholders(o,a,l,[h]));r.splice(c.index,0,h);++d}});for(;d<r.length;++d){t(r[d].children,i[d].getContentResources(),r[d].nodeProxy&&r[d].nodeProxy.getNodeRef());u(r[d],i[d])}})(t.fake?t.children:[t],r,null);return s};P.prototype._loadAndMergeContentResource=function(e,t){if(t.source){var r=this._findSourceData({source:t.source})[0];if(!r){y.warning("Failed to load content resource with sourceId '"+t.sourceId+"' due to failed downloading from URL '"+w(t.source)+"'.")}else{var n=t.nodeProxy.getNodeRef();var o=this._findDvlSceneData({sourceDatum:r,root:false})[0];if(!o){try{o=new R(h(r instanceof D?this._dvl.Core.LoadSceneFromVDSL(r.content,t.password):this._dvl.Core.LoadSceneByUrl(w(t.source),t.password,m(t.source))),r,false)}catch(e){y.error(f().getText(c.VIT34.summary)+": "+w(t.source),c.VIT34.code,"sap.ui.vk.dvl.GraphicsCore");return}this._dvlSceneData.push(o);r.addRef()}t.dvlSceneDatum=o;o.addRef();this._collectAndCheckSourceProperties(t);this._dvl.Renderer.ResetView(sap.ve.dvl.DVLRESETVIEWFLAG.CAMERA,this._rendererId);this._dvl.Scene.Merge(e._dvlSceneRef,o.dvlSceneId,n)}}};P.prototype.buildSceneTree=function(e){if(e.length===0){return null}var t;var r;var s=e.map(function(e){return new L(e)});if(s.length===1&&s[0].name==null){r=s[0];if(r.source){var i=this._findSourceData({source:r.source})[0];try{t=new R(h(i instanceof D?this._dvl.Core.LoadSceneFromVDSL(i.content,r.password):this._dvl.Core.LoadSceneByUrl(w(r.source),r.password,m(r.source))),i,true)}catch(e){y.error(f().getText(c.VIT34.summary)+": "+w(r.source),c.VIT34.code,"sap.ui.vk.dvl.GraphicsCore");return null}i.addRef()}else{t=new R(this._dvl.Core.CreateEmptyScene(),null,true)}}else{var a=new o({sourceType:"vds",sourceId:g()});r=new L(a,true);a.destroy();a=null;Array.prototype.push.apply(r.children,s);s=[r];t=new R(this._dvl.Core.CreateEmptyScene(),null,true)}this._dvlSceneData.push(t);r.dvlSceneDatum=t;t.addRef();this._collectAndCheckSourceProperties(r);var u=new n(this,t.dvlSceneId);this._vkSceneData.push(new I(u,r));this._buildPlaceholders(u.getDefaultNodeHierarchy(),null,null,r.children).forEach(this._loadAndMergeContentResource.bind(this,u.getDefaultNodeHierarchy()));return u};P.prototype.updateSceneTree=function(e,t,r){if(t.length===0){return null}var n;var o=this._getContentResourcesWithEncryptedVds3(t);if(o.length>0){y.error(f().getText(c.VIT25.summary),c.VIT25.code,"sap.ui.vk.dvl.GraphicsCore");n=n||{};n.contentResourcesWithEncryptedVds3=o}var s=this._getContentResourcesWithMissingPasswords(t);if(s.length>0){y.error(f().getText(c.VIT21.summary),c.VIT21.code,"sap.ui.vk.dvl.GraphicsCore");n=n||{};n.contentResourcesWithMissingPasswords=s}if(n&&r){r(n)}if(!e){return this.buildSceneTree(t)}var i=this._findVkSceneData({vkScene:e})[0].shadowContentResource;var a=!!i.source;var u=t.length===1&&!!t[0].getSource();if(!(a&&u&&i.source===t[0].getSource()||!a&&!u&&i.fake===t.length>1)||!i.fake&&t.length===1&&i.name!==t[0].getName()){return this.buildSceneTree(t)}this._updatePlaceholders(e,i,t).forEach(this._loadAndMergeContentResource.bind(this,e.getDefaultNodeHierarchy()));e.getDefaultNodeHierarchy().fireChanged();return e};P.prototype._loadDvlSceneAsync=function(e,t){return new Promise(function(r,n){var o;var s=function(t){o();this.fireSceneLoadingFinished({source:e.source,sceneId:t.sceneId});r(t.sceneId)};var i=function(t){o();var r=t.errorMessage;if(r==null){r=sap.ve.dvl.DVLRESULT.getDescription?sap.ve.dvl.DVLRESULT.getDescription(t.errorCode):""}var s={source:e.source,errorCode:t.errorCode,errorMessage:r};this.fireSceneLoadingFinished(s);n(s)};var c=function(t,r){this.fireSceneLoadingProgress({source:w(e.source),percentage:r});return true}.bind(this);o=function(){this._dvl.Client.NotifyFileLoadProgress=null;this._dvl.Client.detachSceneFailed(i,this);this._dvl.Client.detachSceneLoaded(s,this)}.bind(this);this._dvl.Client.attachSceneLoaded(s,this);this._dvl.Client.attachSceneFailed(i,this);this._dvl.Client.NotifyFileLoadProgress=c;this.fireSceneLoadingStarted({source:w(e.source)});try{l(e instanceof D?this._dvl.Core.LoadSceneFromVDSLAsync(e.content,t):this._dvl.Core.LoadSceneByUrlAsync(w(e.source),t,m(e.source)))}catch(e){o();i.call(this,{errorCode:e instanceof a?e.code:sap.ve.dvl.DVLRESULT.FAIL,errorMessage:e instanceof a?null:e})}}.bind(this))};var b=function(e,t){return new Promise(function(r){(function n(o){if(o>=e.length){r()}else{t(e[o]).catch(function(){}).then(function(){n(o+1)})}})(0)})};P.prototype._loadAndMergeContentResourcesAsync=function(e,t){var r,n=this;return b(t,function(t){if(t.source){var o=n._findSourceData({source:t.source})[0];if(!o){var s="Failed to load content resource with sourceId '"+t.sourceId+"' due to failed downloading from URL '"+w(t.source)+"'.";y.warning(s);r=r||[];r.push({errorMessage:s,source:t.source});return Promise.reject()}return function(){var e=n._findDvlSceneData({sourceDatum:o,root:false})[0];if(e){return Promise.resolve(e)}else{return n._loadDvlSceneAsync(o,t.password).then(function(t){e=new R(t,o,false);n._dvlSceneData.push(e);o.addRef();return Promise.resolve(e)},function(e){r=r||[];r.push(e);return Promise.reject()})}}().then(function(r){t.dvlSceneDatum=r;r.addRef();n._collectAndCheckSourceProperties(t);var o=t.nodeProxy.getNodeRef();n._dvl.Renderer.ResetView(sap.ve.dvl.DVLRESETVIEWFLAG.CAMERA,n._rendererId);n._dvl.Scene.Merge(e._dvlSceneRef,r.dvlSceneId,o);return Promise.resolve()})}return Promise.resolve()}).then(function(){return Promise.resolve(r)})};P.prototype.buildSceneTreeAsync=function(e){if(e.length===0){return Promise.resolve(null)}var t=e.map(function(e){return new L(e)});return function(){var e;if(t.length===1&&t[0].name==null){e=t[0];if(e.source){var r=this._findSourceData({source:e.source})[0];if(r){return this._loadDvlSceneAsync(r,e.password).then(function(t){var n=new R(t,r,true);r.addRef();return Promise.resolve({shadowContentResource:e,dvlSceneDatum:n})})}else{return Promise.reject({errorMessage:"Failed to download the root content resource.",source:e.source})}}return Promise.resolve({shadowContentResource:e,dvlSceneDatum:new R(this._dvl.Core.CreateEmptyScene(),null,true)})}else{var n=new o({sourceType:"vds",sourceId:g()});e=new L(n,true);n.destroy();n=null;Array.prototype.push.apply(e.children,t);t=[e];return Promise.resolve({shadowContentResource:e,dvlSceneDatum:new R(this._dvl.Core.CreateEmptyScene(),null,true)})}}.call(this).then(function(e){this._dvlSceneData.push(e.dvlSceneDatum);e.shadowContentResource.dvlSceneDatum=e.dvlSceneDatum;e.dvlSceneDatum.addRef();this._collectAndCheckSourceProperties(e.shadowContentResource);var t=new n(this,e.dvlSceneDatum.dvlSceneId);this._vkSceneData.push(new I(t,e.shadowContentResource));var r=t.getDefaultNodeHierarchy();return this._loadAndMergeContentResourcesAsync(r,this._buildPlaceholders(t.getDefaultNodeHierarchy(),null,null,e.shadowContentResource.children)).then(function(e){return Promise.resolve({scene:t,failureReason:e})})}.bind(this))};P.prototype.updateSceneTreeAsync=function(e,t){if(t.length===0){return Promise.resolve(null)}var r=this._getContentResourcesWithEncryptedVds3(t);if(r.length>0){y.error(f().getText(c.VIT25.summary),c.VIT25.code,"sap.ui.vk.dvl.GraphicsCore")}var n=this._getContentResourcesWithMissingPasswords(t);if(n.length>0){y.error(f().getText(c.VIT21.summary),c.VIT21.code,"sap.ui.vk.dvl.GraphicsCore")}if(!e){return this.buildSceneTreeAsync(t)}var o=this._findVkSceneData({vkScene:e})[0].shadowContentResource;var s=!!o.source;var i=t.length===1&&!!t[0].getSource();if(!(s&&i&&o.source===t[0].getSource()||!s&&!i&&o.fake===t.length>1)||!o.fake&&t.length===1&&o.name!==t[0].getName()){return this.buildSceneTreeAsync(t)}return new Promise(function(r,n){var s=e.getDefaultNodeHierarchy();this._loadAndMergeContentResourcesAsync(s,this._updatePlaceholders(e,o,t)).then(function(t){r({scene:e,failureReason:t});s.fireChanged()})}.bind(this))};P.prototype.destroyScene=function(e){var t;for(t=0;t<this._vkSceneData.length;++t){if(this._vkSceneData[t].vkScene===e){break}}if(t===this._vkSceneData.length){y.warning("Scene with id '"+e.getId()+"' is not created by this GraphicsCore.");return this}var r=this._vkSceneData.splice(t,1)[0];this._destroyShadowContentResource(e,r.shadowContentResource);e.destroy();return this};var T=function(e,t,r){_(Array.isArray(e),"The first parameter must be an array.");_(typeof t==="function","The second parameter must be a function.");for(var n=0,o=e.length;n<o;++n){if(t.call(r,e[n],n,e)){return n}}return-1};var V=function(e,t){return T(e,function(e){return e.control===t})};var E=function(e,t){return T(e,function(e){return e.rendererId===t})};P.prototype._registerViewport=function(e){_(e,"The viewportControl parameter must not be null.");if(V(this._viewports,e)>=0){return false}var t={control:e,canvas:null,rendererId:null};if(this._viewports.length===0){t.canvas=this._canvas;t.rendererId=this._rendererId;this._startRenderLoop()}else{if(this._viewports.length===1){var r=this._viewports[0];r.control._setCanvas(r.canvas=document.createElement("canvas"));this._dvl.Client.attachFrameFinished(this._handleFrameFinished,this)}t.canvas=document.createElement("canvas");t.rendererId=this._dvl.Core.CreateRenderer()}e._setCanvas(t.canvas);e._setRenderer(t.rendererId);e.attachResize(this._handleViewportResize,this);this._viewports.push(t);return true};P.prototype._deregisterViewport=function(e){_(e,"The viewportControl parameter must not be null.");var t=V(this._viewports,e);if(t<0){return false}_(t>0||this._viewports.length===1,"The first registered viewport control must be deregistered last.");var r=this._viewports.splice(t,1)[0];if(this._viewports.length===0){this._stopRenderLoop()}else{if(this._viewports.length===1){this._dvl.Client.detachFrameFinished(this._handleFrameFinished,this);var n=this._viewports[1-t];n.control._setCanvas(n.canvas=this._canvas)}this._dvl.Core.DeleteRenderer(r.rendererId)}e.detachResize(this._handleViewportResize,this);e._setRenderer(null);e._setCanvas(null);return true};P.prototype._getViewportCount=function(){return this._viewports.length};P.prototype._handleViewportResize=function(e){if(this._viewports.length>1){this._canvas.width=Math.max.apply(null,this._viewports.map(function(e){return e.canvas.width}));this._canvas.height=Math.max.apply(null,this._viewports.map(function(e){return e.canvas.height}))}};P.prototype._startRenderLoop=function(){if(!this._renderLoopRequestId){this._renderLoopRequestId=window.requestAnimationFrame(this._renderLoop)}return this};P.prototype._stopRenderLoop=function(){if(this._renderLoopRequestId){window.cancelAnimationFrame(this._renderLoopRequestId);this._renderLoopRequestId=null}return this};P.prototype._renderLoop=function(){var e;return function(){var t=this._viewports.length>1;this._viewports.forEach(function(r){var n=r.canvas,o=r.rendererId;this._dvl.Renderer._processCommandQueue(o);if(n.width>0&&n.height>0&&this._dvl.Renderer.ShouldRenderFrame(o)){if(t&&e!==o){this._dvl.Renderer.SetDimensions(n.width,n.height,o)}r.control.renderFrame();e=o}},this);this._renderLoopRequestId=window.requestAnimationFrame(this._renderLoop)}}();P.prototype._handleFrameFinished=function(e){_(this._viewports.length>1,"Method _handleFrameFinished should be only called when there are multiple viewports.");if(this._viewports.length>1){var t=E(this._viewports,e.rendererId);if(t>=0){var r=this._viewports[t].canvas,n=r.getContext("2d"),o=r.width,s=r.height;n.drawImage(this._canvas,0,this._canvas.height-s,o,s,0,0,o,s)}}};P.prototype.createViewStateManager=function(e,t){var r=new i;r._setNodeHierarchy(e).setShouldTrackVisibilityChanges(t);this._viewStateManagers.push(r);return r};P.prototype.destroyViewStateManager=function(e){var t=this._viewStateManagers.indexOf(e);if(t>=0){this._viewStateManagers.splice(t,1)[0].destroy()}return this};P.prototype.showDebugInfo=function(e){this._viewports.forEach(function(t){t.control.setShowDebugInfo(e)});return this};P.prototype.getApi=function(e){switch(e){case d.LegacyDvl:return this._dvl;default:return null}};P.prototype.collectGarbage=function(){this._cleanupDvlSceneData();this._cleanupSourceData();return this};P.prototype._onlocalizationChanged=function(e){if(e.getParameter("changes").language){l(this._dvl.Core.SetLocale(S.getConfiguration().getLanguageTag()))}};P.prototype.getDecryptionHandler=function(){return this._dvl.Client.getDecryptionHandler()};P.prototype.setDecryptionHandler=function(e){this._dvl.Client.setDecryptionHandler(e);return this};P.prototype.setAuthorizationHandler=function(e){this._authorizationHandler=e;return this};P.prototype.setRetryCount=function(e){this._retryCount=Math.max(e,0);return this};P.prototype.attachSceneLoadingFinished=function(e,t,r){return this.attachEvent("sceneLoadingFinished",e,t,r)};P.prototype.detachSceneLoadingFinished=function(e,t){return this.detachEvent("sceneLoadingFinished",e,t)};P.prototype.fireSceneLoadingFinished=function(e,t,r){return this.fireEvent("sceneLoadingFinished",e,t,r)};P.prototype.attachSceneLoadingProgress=function(e,t,r){return this.attachEvent("sceneLoadingProgress",e,t,r)};P.prototype.detachSceneLoadingProgress=function(e,t){return this.detachEvent("sceneLoadingProgress",e,t)};P.prototype.fireSceneLoadingProgress=function(e,t,r){return this.fireEvent("sceneLoadingProgress",e,t,r)};P.prototype.attachSceneLoadingStarted=function(e,t,r){return this.attachEvent("sceneLoadingStarted",e,t,r)};P.prototype.detachSceneLoadingStarted=function(e,t){return this.detachEvent("sceneLoadingStarted",e,t)};P.prototype.fireSceneLoadingStarted=function(e,t,r){return this.fireEvent("sceneLoadingStarted",e,t,r)};return P});
//# sourceMappingURL=GraphicsCore.js.map