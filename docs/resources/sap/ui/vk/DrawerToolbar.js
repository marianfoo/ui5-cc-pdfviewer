/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
 */
sap.ui.define(["./library","./DrawerToolbarRenderer","sap/ui/core/Control","sap/ui/core/IconPool","sap/ui/Device","sap/m/VBox","sap/m/FlexAlignContent","sap/m/FlexAlignItems","sap/m/FlexItemData","sap/m/FlexRendertype","sap/m/OverflowToolbar","sap/ui/core/Icon","sap/m/Button","sap/m/ButtonType","sap/m/ToolbarDesign","sap/m/ToolbarSeparator","sap/m/ToggleButton","sap/m/MenuButton","./tools/RectSelectTool","./tools/CrossSectionTool","sap/m/Menu","sap/m/MenuItem","./ZoomTo","./getResourceBundle","./ToggleMenuButton","./ToggleMenuItem","./Viewport","./DrawerToolbarButton","sap/ui/base/ManagedObjectObserver","sap/ui/core/Core","./tools/HighlightMeasurementTool","./tools/CalibrateDistanceMeasurementTool","./tools/DeleteMeasurementTool","./tools/DistanceMeasurementTool","./tools/AngleMeasurementTool","./tools/AreaMeasurementTool"],function(e,t,n,s,i,a,o,r,l,u,c,m,_,h,d,g,T,p,f,v,w,I,E,M,b,S,y,x,R,V,C,D,O,A,B,P){"use strict";var F=n.extend("sap.ui.vk.DrawerToolbar",{metadata:{library:"sap.ui.vk",properties:{expanded:{type:"boolean",defaultValue:true}},aggregations:{content:{type:"sap.ui.core.Control",multiple:true,forwarding:{getter:"_getToolbar",aggregation:"content",forwardBinding:true}}},associations:{viewport:{type:"sap.ui.vk.ViewportBase",multiple:false}},events:{expanded:{parameters:{expand:{type:"boolean"}}}}},constructor:function(e,t){n.apply(this,arguments)}});var N=[{name:"show",unicode:"e900"},{name:"hide",unicode:"e901"},{name:"turntable",unicode:"e902"},{name:"orbit",unicode:"e903"},{name:"pan",unicode:"e904"},{name:"zoom",unicode:"e905"},{name:"fit-to-view",unicode:"e906"},{name:"rectangular-selection",unicode:"e907"},{name:"predefined-views",unicode:"e93c"},{name:"cross-section",unicode:"e913"},{name:"cross-section-x",unicode:"e914"},{name:"cross-section-y",unicode:"e916"},{name:"cross-section-z",unicode:"e915"},{name:"reverse-direction",unicode:"e917"},{name:"distance-measurement",unicode:"e92b"},{name:"angle-measurement",unicode:"e926"},{name:"area-measurement",unicode:"e963"},{name:"settings",unicode:"e909"},{name:"calibrate-distance",unicode:"e968"}];var H="vk-icons";var L="vk-icons";N.forEach(function(e){s.addIcon(e.name,H,L,e.unicode)});var k="sap-icon://vk-icons/";F.prototype.init=function(){if(n.prototype.init){n.prototype.init.apply(this)}this._measurementsToggleButton=null;this._distanceMeasurementItem=null;this._angleMeasurementItem=null;this._areaMeasurementItem=null;this._deleteMeasurementItem=null;this._measurementSettingsItem=null;this._calibrateDistanceMeasurementItem=null;this._itemsVisibility=new Map;this._itemsVisibilityObserver=new R(this._itemVisibilityChanged.bind(this));this._toolbar=new c({width:"auto",design:d.Solid,layoutData:new l({growFactor:0,shrinkFactor:0}),content:this.createButtons()});this._toolbar.ontouchstart=function(e){e.setMarked()};this._toolbarObserver=new R(this._toolbarContentChanged.bind(this));this._toolbarObserver.observe(this._toolbar,{aggregations:["content"]});this._container=new a({renderType:u.Bare,alignContent:o.Center,alignItems:r.Center,items:[this._toolbar,new m({src:"sap-icon://navigation-up-arrow",noTabStop:true,press:function(e){this._toggleExpanded()}.bind(this),layoutData:new l({growFactor:0,shrinkFactor:0})}).addStyleClass("drawerToolbarIcon")]});this._rectSelectTool=new f;this._distanceMeasurementTool=new A({enabled:[function(e){if(this._measurementsToggleButton.getDefaultItem()===this._distanceMeasurementItem.getId()){this._measurementsToggleButton.setPressed(e.getParameter("enabled"))}},this]});this._angleMeasurementTool=new B({enabled:[function(e){if(this._measurementsToggleButton.getDefaultItem()===this._angleMeasurementItem.getId()){this._measurementsToggleButton.setPressed(e.getParameter("enabled"))}},this]});this._areaMeasurementTool=new P({enabled:[function(e){if(this._measurementsToggleButton.getDefaultItem()===this._areaMeasurementItem.getId()){this._measurementsToggleButton.setPressed(e.getParameter("enabled"))}},this]});this._deleteMeasurementTool=new O({enabled:[function(e){if(this._measurementsToggleButton.getDefaultItem()===this._deleteMeasurementItem.getId()){this._measurementsToggleButton.setPressed(e.getParameter("enabled"));if(this._getViewport().getMeasurementSurface().getMeasurements().length===0){this._measurementsToggleButton.setDefaultItem(this._distanceMeasurementItem)}}},this]});this._calibrateDistanceMeasurementTool=new D({enabled:[function(e){if(this._measurementsToggleButton.getDefaultItem()===this._calibrateDistanceMeasurementItem.getId()){var t=e.getParameter("enabled");this._measurementsToggleButton.setPressed(t);if(!t){this._measurementsToggleButton.setDefaultItem(this._distanceMeasurementItem)}}},this]});this._highlightMeasurementTool=new C;var e=[this._distanceMeasurementTool,this._angleMeasurementTool,this._areaMeasurementTool,this._deleteMeasurementTool,this._calibrateDistanceMeasurementTool];function t(t){var n=e.find(function(e){return e.getActive()});this._highlightMeasurementTool.setActive(n==null,this._getViewport())}e.forEach(function(e){e.attachEnabled(t,this)},this)};F.prototype.exit=function(){this._distanceMeasurementTool.destroy();this._distanceMeasurementTool=null;this._angleMeasurementTool.destroy();this._angleMeasurementTool=null;this._highlightMeasurementTool.destroy();this._highlightMeasurementTool=null;this._areaMeasurementTool.destroy();this._areaMeasurementTool=null;this._deleteMeasurementTool.destroy();this._deleteMeasurementTool=null;this._calibrateDistanceMeasurementTool.destroy();this._calibrateDistanceMeasurementTool=null;this._measurementsToggleButton=null;this._distanceMeasurementItem=null;this._angleMeasurementItem=null;this._areaMeasurementItem=null;this._deleteMeasurementItem=null;this._measurementSettingsItem=null;this._calibrateDistanceMeasurementItem=null;this._toolbarObserver.disconnect();this._toolbarObserver=null;this._toolbar.destroy();this._toolbar=null};F.prototype._toolbarContentChanged=function(){var e=this._toolbar.getContent();for(var t=0;t<e.length;t++){if(e[t].getMetadata().getName()=="sap.m.ToolbarSeparator"){if(e[t-1]==undefined||e[t+1]==undefined||e[t-1].getMetadata().getName()=="sap.m.ToolbarSeparator"){this._toolbar.removeContent(t)}}}};F.prototype._itemVisibilityChanged=function(e){if(!this._ignoreVisiblityChange){this._itemsVisibility.set(e.object,e.current)}};function U(e){return e?e.getMetadata().getName()==="sap.ui.vk.threejs.Viewport":false}function z(e){return e?e.getMetadata().getName()==="sap.ui.vk.svg.Viewport":false}function G(e){return e?e.getMetadata().getName()==="sap.ui.vk.NativeViewport":false}F.prototype._getViewport=function(){var e=V.byId(this.getViewport());e=e instanceof y&&e.getImplementation()||e;return e&&(U(e)||z(e)||G(e))?e:null};F.prototype._getViewStateManager=function(){var e=V.byId(this.getViewport());var t=e.getViewStateManager();if(t){return V.byId(t)}return null};var W=[null,(new THREE.Quaternion).setFromAxisAngle(new THREE.Vector3(0,1,0),0),(new THREE.Quaternion).setFromAxisAngle(new THREE.Vector3(0,1,0),Math.PI),(new THREE.Quaternion).setFromAxisAngle(new THREE.Vector3(0,1,0),-Math.PI/2),(new THREE.Quaternion).setFromAxisAngle(new THREE.Vector3(0,1,0),Math.PI/2),(new THREE.Quaternion).setFromAxisAngle(new THREE.Vector3(1,0,0),-Math.PI/2),(new THREE.Quaternion).setFromAxisAngle(new THREE.Vector3(1,0,0),Math.PI/2)];F.prototype.createButtons=function(){var e=this;var t=M();var n=new b({type:h.Transparent,tooltip:t.getText("CROSS_SECTION_TOOLTIP"),items:[new S({icon:k+"cross-section-x",text:t.getText("CROSS_SECTION_X"),key:0}),new S({icon:k+"cross-section-y",text:t.getText("CROSS_SECTION_Y"),key:1}),new S({icon:k+"cross-section-z",text:t.getText("CROSS_SECTION_Z"),key:2}),new S({icon:k+"reverse-direction",text:t.getText("CROSS_SECTION_REVERSE"),startsSection:true,toggleable:false,press:function(t){var n=e._getViewport();if(n&&e._crossSectionTool&&e._crossSectionTool.getActive()){e._crossSectionTool.setFlip(!e._crossSectionTool.getFlip())}}})],itemToggled:function(t){var n=e._getViewport();if(n&&e._crossSectionTool){var s=t.getParameter("newItem");e._crossSectionTool.setActive(s!=null,n);if(s){var i=parseInt(s.getKey(),10);if(i>=0&&i<3){e._crossSectionTool.setAxis(i)}}}}});n.vitId=x.CrossSection;var s=new T({icon:k+"turntable",type:h.Transparent,tooltip:t.getText("TURNTABLE_TOOLTIP"),press:function(t){var n=e._getViewport();if(n){e._activateGesture(n,0)}}});s.vitId=x.Turntable;var i=new T({icon:k+"orbit",type:h.Transparent,tooltip:t.getText("ORBIT_TOOLTIP"),pressed:false,press:function(t){var n=e._getViewport();if(n){e._activateGesture(n,1)}}});i.vitId=x.Orbit;var a=new T({icon:k+"pan",type:h.Transparent,tooltip:t.getText("PAN_TOOLTIP"),press:function(t){var n=e._getViewport();if(n){e._activateGesture(n,2)}}});a.vitId=x.Pan;var o=new T({icon:k+"zoom",type:h.Transparent,tooltip:t.getText("ZOOM_TOOLTIP"),press:function(){var t=e._getViewport();if(t){e._activateGesture(t,3)}}});o.vitId=x.Zoom;this._activeGesture=-1;this._gestureButtons=[s,i,a,o];var r=new _({icon:k+"show",type:h.Transparent,tooltip:t.getText("SHOW_TOOLTIP"),press:function(){var t=e._getViewStateManager();if(t){var n=[];t.enumerateSelection(function(e){n.push(e)});t.setVisibilityState(n,true,false)}}});r.vitId=x.Show;var l=new _({icon:k+"hide",type:h.Transparent,tooltip:t.getText("HIDE_TOOLTIP"),press:function(){var t=e._getViewStateManager();if(t){var n=[];t.enumerateSelection(function(e){n.push(e)});t.setVisibilityState(n,false,false)}}});l.vitId=x.Hide;var u=new _({icon:k+"fit-to-view",type:h.Transparent,tooltip:t.getText("FIT_TO_VIEW"),press:function(){var t=V.byId(e.getViewport());t=t instanceof y&&t.getImplementation()||t;if(t){t.zoomTo(E.All,null,.5,0)}}});u.vitId=x.FitToView;this._rectSelectionButton=new T({icon:k+"rectangular-selection",type:h.Transparent,tooltip:t.getText("RECTANGULAR_SELECTION_TOOLTIP")});this._rectSelectionButton.vitId=x.RectangularSelection;var c=new p({icon:k+"predefined-views",activeIcon:k+"predefined-views",type:h.Transparent,tooltip:t.getText("PREDEFINED_VIEW_MENUBUTTONTOOLTIP"),menu:new w({items:[new I({text:t.getText("PREDEFINED_VIEW_INITIAL")}),new I({text:t.getText("PREDEFINED_VIEW_FRONT"),startsSection:true}),new I({text:t.getText("PREDEFINED_VIEW_BACK")}),new I({text:t.getText("PREDEFINED_VIEW_LEFT")}),new I({text:t.getText("PREDEFINED_VIEW_RIGHT")}),new I({text:t.getText("PREDEFINED_VIEW_TOP")}),new I({text:t.getText("PREDEFINED_VIEW_BOTTOM")})]}).attachItemSelected(function(t){var n=e._getViewport();if(n){var s=t.getParameters("item").item;var i=this.indexOfItem(s);n._viewportGestureHandler.setView(W[i],1e3)}})});c.vitId=x.PredefinedViews;var m=new T({icon:"sap-icon://full-screen",type:h.Transparent,tooltip:t.getText("VIEWER_FULLSCREENBUTTONTOOLTIP"),press:function(t){var n=e._getViewport();var s=function(e){return!!(e.fullScreen||e.webkitIsFullScreen||e.mozFullScreen||e.msFullscreenElement)};if(this.getPressed()){if(!s(document)){if(!e._fullScreenHandler){e._fullScreenHandler=function(t){var i=s(document);if(!i){document.removeEventListener("fullscreenchange",e._fullScreenHandler);document.removeEventListener("mozfullscreenchange",e._fullScreenHandler);document.removeEventListener("webkitfullscreenchange",e._fullScreenHandler);document.removeEventListener("MSFullscreenChange",e._fullScreenHandler);this.setPressed(false);n.removeStyleClass("sapVizKitViewerFullScreen")}}.bind(this)}var i=document.getElementsByTagName("body")[0];if(i.requestFullscreen){document.addEventListener("fullscreenchange",e._fullScreenHandler);i.requestFullscreen()}else if(i.webkitRequestFullScreen){document.addEventListener("webkitfullscreenchange",e._fullScreenHandler);i.webkitRequestFullscreen()}else if(i.mozRequestFullScreen){document.addEventListener("mozfullscreenchange",e._fullScreenHandler);i.mozRequestFullScreen()}else if(i.msRequestFullscreen){document.addEventListener("MSFullscreenChange",e._fullScreenHandler);i.msRequestFullscreen()}}n.addStyleClass("sapVizKitViewerFullScreen")}else{if(s(document)){if(document.cancelFullScreen){document.cancelFullScreen()}else if(document.msExitFullscreen){document.msExitFullscreen()}else if(document.mozCancelFullScreen){document.mozCancelFullScreen()}else if(document.webkitCancelFullScreen){document.webkitCancelFullScreen()}}n.removeStyleClass("sapVizKitViewerFullScreen")}}});m.vitId=x.FullScreen;this._distanceMeasurementItem=new S({icon:k+"distance-measurement",text:t.getText("MEASUREMENTS_DISTANCE_MENUITEM")});this._angleMeasurementItem=new S({icon:k+"angle-measurement",text:t.getText("MEASUREMENTS_ANGLE_MENUITEM")});this._areaMeasurementItem=new S({icon:k+"area-measurement",text:t.getText("MEASUREMENTS_AREA_MENUITEM")});this._deleteMeasurementItem=new S({icon:"sap-icon://delete",text:t.getText("MEASUREMENTS_DELETE_MENUITEM")});this._calibrateDistanceMeasurementItem=new S({icon:k+"calibrate-distance",text:t.getText("MEASUREMENTS_CALIBRATE_DISTANCE_MENUITEM")});this._measurementSettingsItem=new S({startsSection:true,icon:k+"settings",text:t.getText("MEASUREMENTS_SETTINGS_MENUITEM"),toggleable:false});this._measurementsToggleButton=new b({type:h.Transparent,tooltip:t.getText("MEASUREMENTS_TOOLTIP"),items:[this._distanceMeasurementItem,this._angleMeasurementItem,this._areaMeasurementItem,this._deleteMeasurementItem,this._calibrateDistanceMeasurementItem,this._measurementSettingsItem],itemToggled:function(t){var n=e._getViewport();var s=t.getParameter("oldItem");var i=t.getParameter("newItem");if(s===e._distanceMeasurementItem){e._distanceMeasurementTool.setActive(false,n)}else if(s===e._angleMeasurementItem){e._angleMeasurementTool.setActive(false,n)}else if(s===e._areaMeasurementItem){e._areaMeasurementTool.setActive(false,n)}else if(s===e._deleteMeasurementItem){e._deleteMeasurementTool.setActive(false,n)}else if(s===e._calibrateDistanceMeasurementItem){e._calibrateDistanceMeasurementTool.setActive(false,n)}var a=n.getTools();var o;if(i===e._distanceMeasurementItem){o=e._distanceMeasurementTool}else if(i===e._angleMeasurementItem){o=e._angleMeasurementTool}else if(i===e._areaMeasurementItem){o=e._areaMeasurementTool}else if(i===e._deleteMeasurementItem){o=e._deleteMeasurementTool}else if(i===e._calibrateDistanceMeasurementItem){o=e._calibrateDistanceMeasurementTool}if(o!=null){if(a.indexOf(o.getId())<0){n.addTool(o)}o.setActive(true,n)}},itemSelected:function(t){var n=e._getViewport();var s=t.getParameter("item");if(s===e._measurementSettingsItem){e._distanceMeasurementTool.setActive(false,n);e._angleMeasurementTool.setActive(false,n);e._areaMeasurementTool.setActive(false,n);e._deleteMeasurementTool.setActive(false,n);e._calibrateDistanceMeasurementTool.setActive(false,n);e._distanceMeasurementTool.showSettingsDialog(n)}},beforeMenuOpen:function(){var t=e._getViewport();var n=t.getMeasurementSurface();var s=n.getMeasurements().length>0;e._deleteMeasurementItem.setEnabled(s);var i=n.getMeasurements().some(function(e){return e.isDistance});e._calibrateDistanceMeasurementItem.setEnabled(i)}});this._measurementsToggleButton.vitId=x.Measurements;var d=new g;d.vitId=x.MeasurementsSeparator;var f=new g;var v=new g;var R=new g;var C=new g;this._itemsShowHideSelect=[r,l,R,this._rectSelectionButton,C];this._items3D=[this._gestureButtons[0],this._gestureButtons[1],n,f,c,v];this._itemPan=this._gestureButtons[2];var D=[r,l,R,this._gestureButtons[0],this._gestureButtons[1],this._gestureButtons[2],this._gestureButtons[3],new g,this._measurementsToggleButton,d,u,new g,this._rectSelectionButton,C,n,f,c,v,m];D.forEach(function(e){this._itemsVisibility.set(e,true);this._itemsVisibilityObserver.observe(e,{properties:["visible"]})}.bind(this));return D};var q=["drawerToolbarIconTurntable","drawerToolbarIconOrbit","drawerToolbarIconPan","drawerToolbarIconZoom"];var K=function(e,t){this.viewport=e;this._toolbar=t;this._mode=1;this._gesture=false;this._x=0;this._y=0};function Q(e,t){q.forEach(function(n,s){if(e.hasStyleClass(n)&&s!==t){e.removeStyleClass(n)}else if(s===t){e.addStyleClass(n)}})}function Z(e){var t=e.viewport;var n=e._mode;var s=t.hasStyleClass(q[n])?n:-1;e._isScrolling=true;if(s!==3){Q(t,3);setTimeout(function(){e._isScrolling=false;Q(t,s)},500)}}K.prototype.beginGesture=function(e){this._gesture=true;if(this._mode<3){this._x=e.points[0].x;this._y=e.points[0].y}else{this._x=e.x;this._y=e.y}if(e.scroll){Z(this)}if(this._toolbar._rectSelectionButton.getPressed()||e.event&&(i.os.macintosh?e.event.metaKey:e.event.ctrlKey)){var t=this.viewport.getDomRef().getBoundingClientRect();this._selectionRect={x1:this._x-t.left,y1:this._y-t.top,x2:this._x-t.left,y2:this._y-t.top}}};K.prototype.endGesture=function(){this._gesture=false;if(this._selectionRect&&(this._selectionRect.x1!==this._selectionRect.x2||this._selectionRect.y1!==this._selectionRect.y2)){this._toolbar._rectSelectTool._select(this._selectionRect.x1,this._selectionRect.y1,this._selectionRect.x2,this._selectionRect.y2,this.viewport,this.viewport.getScene(),this.viewport.getCamera());this._selectionRect=null;this.viewport.setSelectionRect(null)}else if(!this._isScrolling){Q(this.viewport,-1)}};K.prototype.move=function(e){if(this._gesture){if(e.n==1){var t=e.points[0];if(this._selectionRect){var n=this.viewport.getDomRef().getBoundingClientRect();this._selectionRect.x2=t.x-n.left;this._selectionRect.y2=t.y-n.top;this.viewport.setSelectionRect(this._selectionRect)}else{Q(this.viewport,this._mode);var s=t.x-this._x;var i=t.y-this._y;switch(this._mode){case 0:this.viewport.rotate(s,i,true);break;case 1:this.viewport.rotate(s,i,false);break;case 2:this.viewport.pan(s,i);break;case 3:this.viewport.zoom(1+i*.005);break;default:break}this._x=t.x;this._y=t.y}e.handled=true}else if(e.n==2&&!this._isScrolling){Q(this.viewport,2)}}};K.prototype.hover=function(){};K.prototype.getViewport=function(){return this.viewport};F.prototype._activateGesture=function(e,t){this._activeGesture=t;this._gestureButtons.forEach(function(e,n){e.setPressed(n===t)});if(!this._cameraHandler||this._cameraHandler.getViewport()!=e){this._cameraHandler=new K(e,this);e._loco.addHandler(this._cameraHandler,0)}this._cameraHandler._mode=t};F.prototype._getToolbar=function(){return this._toolbar};F.prototype._toggleExpanded=function(){var e=!this.getExpanded();this.setExpanded(e);this.fireExpanded({expand:e})};F.prototype.setExpanded=function(e){this.setProperty("expanded",e,true);var t=this.getDomRef();if(t){if(!e){t.classList.add("drawerToolbarCollapsed");t.classList.remove("drawerToolbarExpanded");this._container.addStyleClass("vboxCollapsed")}else{t.classList.add("drawerToolbarExpanded");t.classList.remove("drawerToolbarCollapsed");this._container.removeStyleClass("vboxCollapsed")}}return this};F.prototype.onBeforeRendering=function(){var e=this._getViewport();this._container.setVisible(!!e);if(e){var t=U(e)&&!e._redlineHandler&&!e._isPlanarActivated();var n=U(e)&&e._isPanoramicActivated();var s=G(e);this._ignoreVisiblityChange=true;this._itemsShowHideSelect.forEach(function(e){e.setVisible(!s&&this._itemsVisibility.get(e))}.bind(this));this._items3D.forEach(function(e){e.setVisible(t&&this._itemsVisibility.get(e))}.bind(this));this._itemPan.setVisible(!n&&this._itemsVisibility.get(this._itemPan));this._ignoreVisiblityChange=false;if(t){this._crossSectionTool=this._crossSectionTool||new v;e.addTool(this._crossSectionTool)}this._activateGesture(e,Math.max(this._activeGesture,t?0:2))}};return F});
//# sourceMappingURL=DrawerToolbar.js.map