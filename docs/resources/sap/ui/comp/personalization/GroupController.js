/*!
 * SAPUI5
 * (c) Copyright 2009-2022 SAP SE. All rights reserved.
 */
sap.ui.define(["./BaseController","sap/m/library","sap/ui/comp/library","./Util","sap/m/P13nConditionPanel"],function(e,t,o,r,n){"use strict";var a=t.P13nConditionOperation;var p=e.extend("sap.ui.comp.personalization.GroupController",{constructor:function(o,r){e.apply(this,arguments);this.setType(t.P13nPanelType.group);this.setItemType(t.P13nPanelType.group+"Items")},metadata:{events:{afterGroupModelDataChange:{}}}});p.prototype.setTable=function(t){e.prototype.setTable.apply(this,arguments);if(this.getTableType()===o.personalization.TableType.AnalyticalTable||this.getTableType()===o.personalization.TableType.Table||this.getTableType()===o.personalization.TableType.TreeTable){t.detachGroup(this._onGroup,this);t.attachGroup(this._onGroup,this)}};p.prototype.getColumn2Json=function(e,t,r){if(this.getTableType()!==o.personalization.TableType.AnalyticalTable){return null}if(!e.getGrouped()){return null}return{columnKey:t,isGrouped:e.getGrouped(),operation:e.getSortOrder&&e.getSortOrder()==="Ascending"?a.GroupAscending:a.GroupDescending,showIfGrouped:e.getShowIfGrouped?e.getShowIfGrouped():false}};p.prototype.getAdditionalData2Json=function(e,t){if(this.getTableType()!==o.personalization.TableType.AnalyticalTable){return}if(!e.group.groupItems.length){return}t.getGroupedColumns().forEach(function(t,o){if(typeof t==="string"){t=sap.ui.getCore().byId(t)}var n=r.getIndexByKey("columnKey",r.getColumnKey(t),e.group.groupItems);if(n>-1&&o===n){return}var a=e.group.groupItems.splice(n,1);e.group.groupItems.splice(o,0,a)})};p.prototype.getColumn2JsonTransient=function(e,t,o,n){if(!r.isGroupable(e)){return null}return{columnKey:t,text:o,tooltip:n!==o?n:undefined}};p.prototype.handleIgnore=function(e,t){e.sort.sortItems.splice(t,1)};p.prototype.syncJson2Table=function(e){var t=this.getColumnMap();var r=this.getTable();var n;this.fireBeforePotentialTableChange();if(this.getTableType()===o.personalization.TableType.TreeTable){return}else if(this.getTableType()===o.personalization.TableType.AnalyticalTable){var a=true;for(var p in t){n=t[p];if(!n){return}if(n.getGrouped()){n.setGrouped(false,a);n.setShowIfGrouped(false)}}e.group.groupItems.forEach(function(e){n=t[e.columnKey];if(!n){return}n.setGrouped(true,a);n.setShowIfGrouped(e.showIfGrouped)})}else if(this.getTableType()===o.personalization.TableType.Table||this.getTableType()===o.personalization.TableType.AnalyticalTable||this.getTableType()===o.personalization.TableType.TreeTable){if(e.group.groupItems.length>0){e.group.groupItems.some(function(e){n=t[e.columnKey];if(n){r.setGroupBy(n);return true}})}else{r.setGroupBy(null)}}this.fireAfterPotentialTableChange()};p.prototype.getDataSuiteFormat2Json=function(e){var t=this.createControlDataStructure();if(!e.GroupBy||!e.GroupBy.length){return t}t.group.groupItems=e.GroupBy.map(function(e){return{columnKey:e,operation:a.GroupAscending,showIfGrouped:false}});return t};p.prototype.getDataSuiteFormatSnapshot=function(e){var t=this.getUnionData(this.getControlDataInitial(),this.getControlData());if(!t.group||!t.group.groupItems||!t.group.groupItems.length){return}e.GroupBy=t.group.groupItems.map(function(e){return e.columnKey})};p.prototype._onGroup=function(e){this.fireBeforePotentialTableChange();this._updateInternalModel(e.getParameter("groupedColumns"));this.fireAfterPotentialTableChange();this.fireAfterGroupModelDataChange()};p.prototype._setGroup=function(e,t){this.fireBeforePotentialTableChange();if(e){this._updateInternalModel([t])}else{this._updateInternalModel([])}this.fireAfterPotentialTableChange();this.fireAfterGroupModelDataChange()};p.prototype._updateInternalModel=function(e){this.getInternalModel().setProperty("/controlData/group/groupItems",[]);var t=this.getControlData();e.forEach(function(e){if(typeof e==="string"){e=sap.ui.getCore().byId(e)}var o=r.getColumnKey(e);var n=r.getIndexByKey("columnKey",o,t.group.groupItems);n=n>-1?n:t.group.groupItems.length;this.getInternalModel().setProperty("/controlData/group/groupItems/"+n+"/",{columnKey:o,showIfGrouped:e.getShowIfGrouped?e.getShowIfGrouped():false})},this);this.updateControlDataBaseFromJson(t)};p.prototype.getPanel=function(){if(!r.hasGroupableColumns(this.getColumnMap())){return null}return new Promise(function(e){sap.ui.require(["sap/m/P13nGroupPanel","sap/m/P13nItem","sap/m/P13nGroupItem"],function(t,r,n){return e(new t({maxGroups:this.getTableType()===o.personalization.TableType.AnalyticalTable?"-1":"1",containerQuery:true,items:{path:"$sapmP13nPanel>/transientData/group/groupItems",template:new r({columnKey:"{$sapmP13nPanel>columnKey}",text:"{$sapmP13nPanel>text}",tooltip:"{$sapmP13nPanel>tooltip}"})},groupItems:{path:"$sapmP13nPanel>/controlDataReduce/group/groupItems",template:new n({columnKey:"{$sapmP13nPanel>columnKey}",operation:"{$sapmP13nPanel>operation}",showIfGrouped:"{$sapmP13nPanel>showIfGrouped}"})},beforeNavigationTo:this.setModelFunction(),updateGroupItem:function(){this.fireAfterPotentialModelChange({json:this.getControlDataReduce()})}.bind(this),addGroupItem:function(e){if(!e.getParameter("groupItemData")){return}var t=e.getParameter("index");var o=e.getParameter("groupItemData");var r={columnKey:o.getColumnKey(),operation:o.getOperation(),showIfGrouped:o.getShowIfGrouped()};var n=this.getControlDataReduce();if(t>-1){n.group.groupItems.splice(t,0,r)}else{n.group.groupItems.push(r)}this.setControlDataReduce2Model(n);this.fireAfterPotentialModelChange({json:n})}.bind(this),removeGroupItem:function(e){var t=e.getParameter("index");if(t<0){return}var o=this.getControlDataReduce();o.group.groupItems.splice(t,1);this.setControlDataReduce2Model(o);this.fireAfterPotentialModelChange({json:o})}.bind(this)}))}.bind(this))}.bind(this))};p.prototype.retrieveAdaptationUI=function(e){if(!r.hasGroupableColumns(this.getColumnMap())){return null}return new Promise(function(e){sap.ui.require(["sap/m/p13n/GroupPanel"],function(t){var r=this.getAdaptationData();var n=this.getTableType()===o.personalization.TableType.AnalyticalTable;var a=new t({queryLimit:n?undefined:1,enableShowField:n});this.oPanel=a;a.setP13nData(r);a.attachChange(function(e){var t=t=e.getParameter("item");var o=a.getP13nData(true);var r=this.getControlDataReduce();r.group.groupItems=o.map(function(e){return{isGrouped:true,columnKey:e.name,operation:e.descending?"GroupDescending":"GroupAscending",showIfGrouped:t.name===e.name?t.showIfGrouped:true}});this.setControlDataReduce2Model(r);this.fireAfterPotentialModelChange({json:r})}.bind(this));e(a)}.bind(this))}.bind(this))};p.prototype._transformAdaptationData=function(t,o){var r=e.prototype._transformAdaptationData.apply(this,arguments);r.grouped=!!t;r.showIfGrouped=t?t.showIfGrouped:true;return r};p.prototype._sortAdaptationData=function(e){this._getP13nBuilder().sortP13nData({visible:"grouped",position:"position"},e)};p.prototype._getPresenceAttribute=function(){return"grouped"};p.prototype.getChangeType=function(e,t){if(!t||!t.group||!t.group.groupItems){return o.personalization.ChangeType.Unchanged}var r=JSON.stringify(e.group.groupItems)!==JSON.stringify(t.group.groupItems);return r?o.personalization.ChangeType.ModelChanged:o.personalization.ChangeType.Unchanged};p.prototype.getChangeData=function(e,t){if(!e||!e.group||!e.group.groupItems){return this.createControlDataStructure()}if(!t||!t.group||!t.group.groupItems){return{group:r.copy(e.group)}}if(JSON.stringify(e.group.groupItems)!==JSON.stringify(t.group.groupItems)){return{group:r.copy(e.group)}}return null};p.prototype.getUnionData=function(e,t){if(!t||!t.group||!t.group.groupItems){return{group:r.copy(e.group)}}return{group:r.copy(t.group)}};p.prototype.isGroupSelected=function(e,t){var o=-1;e.groupItems.some(function(e,r){if(e.columnKey===t){o=r;return true}});return o>-1};p.prototype.exit=function(){e.prototype.exit.apply(this,arguments);if(this.getTable()&&(this.getTableType()===o.personalization.TableType.AnalyticalTable||this.getTableType()===o.personalization.TableType.Table||this.getTableType()===o.personalization.TableType.TreeTable)){this.getTable().detachGroup(this._onGroup,this)}};return p});
//# sourceMappingURL=GroupController.js.map