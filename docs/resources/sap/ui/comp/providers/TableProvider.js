/*!
 * SAPUI5
 * (c) Copyright 2009-2022 SAP SE. All rights reserved.
 */
sap.ui.define(["sap/ui/comp/odata/MetadataAnalyser","./ControlProvider","sap/ui/comp/util/FormatUtil","sap/ui/Device","sap/ui/comp/odata/FiscalMetadata"],function(t,e,i,a,n){"use strict";var o=function(e){if(e){this._oParentODataModel=e.model;this.sEntitySet=e.entitySet;this._sIgnoredFields=e.ignoredFields;this._sInitiallyVisibleFields=e.initiallyVisibleFields;this.isEditableTable=e.isEditableTable;this._smartTableId=e.smartTableId;this._isAnalyticalTable=e.isAnalyticalTable;this._isMobileTable=e.isMobileTable;this.useSmartField=e.useSmartField;this.useSmartToggle=e.useSmartToggle;this.useUTCDateTime=e.useUTCDateTime==="true";this._bSkipAnnotationParse=e.skipAnnotationParse==="true";this._sLineItemQualifier=e.lineItemQualifier;this._sPresentationVariantQualifier=e.presentationVariantQualifier;this.enableInResultForLineItem=e.enableInResultForLineItem==="true";this._oSemanticKeyAdditionalControl=e._semanticKeyAdditionalControl;this._bShowDetailsButton=e.showDetailsButton;this._bEnableAutoColumnWidth=e.enableAutoColumnWidth;this._bPreserveDecimals=e.preserveDecimals;this._oCustomizeConfigTextInEditModeSource=e.textInEditModeSource;this._oCustomizeConfigIgnoreInsertRestrictions=e.ignoreInsertRestrictions;try{var i=function(t){switch(typeof t){case"string":return JSON.parse(t);case"object":if(t==null){return undefined}return t;default:return undefined}};this._oDateFormatSettings=i(e.dateFormatSettings);this._oCurrencyFormatSettings=i(e.currencyFormatSettings);this._oDefaultDropDownDisplayBehaviour=e.defaultDropDownDisplayBehaviour}catch(t){}}if(!this._oDateFormatSettings){this._oDateFormatSettings={}}if(!this._oDateFormatSettings.hasOwnProperty("UTC")){this._oDateFormatSettings["UTC"]=true}this._aODataFieldMetadata=[];this._aTableViewMetadata=[];this._aIgnoredFields=[];this._aInitiallyVisibleFields=[];this._oMetadataAnalyser=new t(this._oParentODataModel);this._oSemanticObjectController=e.semanticObjectController;this._intialiseMetadata()};o.prototype._intialiseMetadata=function(){var t=[],i=-1,a,n,o,s,r,l,d;this._aODataFieldMetadata=this._oMetadataAnalyser.getFieldsByEntitySetName(this.sEntitySet);d=this._oMetadataAnalyser.getEntityTypeNameFromEntitySetName(this.sEntitySet);if(!this._bSkipAnnotationParse){this._oPresentationVariant=this._oMetadataAnalyser.getPresentationVariantAnnotation(d,this._sPresentationVariantQualifier);if(this._oPresentationVariant){this._oLineItemAnnotation=this._oPresentationVariant.lineItemAnnotation}if(!this._oLineItemAnnotation){this._oLineItemAnnotation=this._oMetadataAnalyser.getLineItemAnnotation(d,this._sLineItemQualifier)}}if(this._isMobileTable){this._oSemanticKeyAnnotation=this._oMetadataAnalyser.getSemanticKeyAnnotation(d)}if(!this._isAnalyticalTable){this._addLineItemNavigationFields(d)}l=this._oMetadataAnalyser.getEntityContainerAttribute("supported-formats");if(l){this._bSupportsExcelExport=l.indexOf("xlsx")>-1;this._oPdfAnnotation=l.indexOf("pdf")>-1&&this._oMetadataAnalyser.getPDFSupportedAnnotation();this._bSupportsPDFExport=this._oParentODataModel.isA("sap.ui.model.odata.v2.ODataModel")&&this._oPdfAnnotation}if(!this._oDefaultDropDownDisplayBehaviour){this._oDefaultDropDownDisplayBehaviour=this._oMetadataAnalyser.getTextArrangementValue(d)}this._generateArrays();this._oControlProvider=new e({metadataAnalyser:this._oMetadataAnalyser,model:this._oParentODataModel,fieldsMetadata:this._aODataFieldMetadata,lineItemAnnotation:this._oLineItemAnnotation,semanticKeyAnnotation:this._oSemanticKeyAnnotation,_semanticKeyAdditionalControl:this._oSemanticKeyAdditionalControl,processDataFieldDefault:true,isMobileTable:this._isMobileTable,isAnalyticalTable:this._isAnalyticalTable,smartTableId:this._smartTableId,dateFormatSettings:this._oDateFormatSettings,currencyFormatSettings:this._oCurrencyFormatSettings,defaultDropDownDisplayBehaviour:this._oDefaultDropDownDisplayBehaviour,useSmartField:this.useSmartField,useSmartToggle:this.useSmartToggle,useUTCDateTime:this.useUTCDateTime,enableDescriptions:true,entitySet:this.sEntitySet,semanticObjectController:this._oSemanticObjectController,preserveDecimals:this._bPreserveDecimals,textInEditModeSource:this._oCustomizeConfigTextInEditModeSource,ignoreInsertRestrictions:this._oCustomizeConfigIgnoreInsertRestrictions});this._oFieldSemanticObjectMap={};if(this._aODataFieldMetadata){n=this._aODataFieldMetadata.length}for(a=0;a<n;a++){o=this._aODataFieldMetadata[a];if(this._aIgnoredFields.indexOf(o.name)>-1||!o.visible){continue}if(o.type.indexOf("Edm.")===0){s=this._oControlProvider.getFieldViewMetadata(o,this.isEditableTable);this._enrichWithTableViewMetadata(s,i++);t.push(s);if(s.semanticObject){this._oFieldSemanticObjectMap[s.name]=s.semanticObject}}}r=function(t,e){return t.index-e.index};this._aTableViewMetadata=t.sort(r);if(this._isAnalyticalTable&&this._mDimensionFromText){this._aTableViewMetadata.forEach(function(t){var e=this._mDimensionFromText[t.name];if(e&&t.aggregationRole!=="dimension"){if(!t.additionalProperty){t.additionalProperty=e}else{t.additionalProperty+=","+e}}}.bind(this))}};o.prototype._addLineItemNavigationFields=function(t){var e,i,a,n;if(this._aODataFieldMetadata&&this._oLineItemAnnotation){e=this._oLineItemAnnotation.fields;if(e){i=e.length}while(i--){a=e[i];if(a&&a.indexOf("/")>=0){n=this._oMetadataAnalyser.extractNavigationPropertyField(a,this.sEntitySet);if(n){n.name=n.parentPropertyName+"/"+n.name;if(n.description){n.description=n.parentPropertyName+"/"+n.description}if(n.unit){n.unit=n.parentPropertyName+"/"+n.unit}this._aODataFieldMetadata.push(n)}}}}};o.prototype.getFieldSemanticObjectMap=function(){return this._oFieldSemanticObjectMap};o.prototype.getTableViewMetadata=function(){return this._aTableViewMetadata};o.prototype.getSupportsExcelExport=function(){return this._bSupportsExcelExport};o.prototype.getExportCapabilities=function(t){var e={};if(t.indexOf("UI5Client")>-1){e["XLSX"]={}}if(this._bSupportsPDFExport&&t=="UI5ClientPDF"){e["PDF"]={};Object.assign(e["PDF"],this._oPdfAnnotation)}return e};o.prototype.getMultiUnitBehaviorEnabled=function(){return this._oMetadataAnalyser.getMultiUnitBehaviorEnabled()};o.prototype.getIsUTCDateHandlingEnabled=function(){return this._oDateFormatSettings?this._oDateFormatSettings.UTC:false};o.prototype.getRequestAtLeastFields=function(){return this._oPresentationVariant&&this._oPresentationVariant.requestAtLeastFields?this._oPresentationVariant.requestAtLeastFields:[]};o.prototype.isLineItemDefaultImportance=function(e){if(e.importance!="High"){return false}var i=this._oLineItemAnnotation&&this._oLineItemAnnotation.annotation||[];return i.some(function(i){return i.Value&&i.Value.Path==e.name&&!t.hasImportance(i)})};o.prototype.getFieldMetadata=function(t,e){var i=this._aTableViewMetadata.concat(this._aODataFieldMetadata).find(function(e){return e.name==t});if(!i&&t&&t.includes("/")){try{i=this._oMetadataAnalyser.extractNavigationPropertyField(t,this.sEntitySet)}catch(t){}}if(i){if(!i.modelType){this._oControlProvider.createModelTypeInstance(i)}if(e&&!i.hasOwnProperty("additionalProperty")){i.additionalProperty=this._getAdditionalProperty(i).join(",")}}return i};o.prototype._generateArrays=function(){if(this._sIgnoredFields){this._aIgnoredFields=this._sIgnoredFields.split(",")}if(this._sInitiallyVisibleFields){this._aInitiallyVisibleFields=this._sInitiallyVisibleFields.split(",")}};o.prototype._getAdditionalProperty=function(t){var e=[];if(t.isMeasureField&&t.unit){e.push(t.unit)}else if(t.description){e.push(t.description)}if(t.criticality){e.push(t.criticality)}if(t.criticalityRepresentation){e.push(t.criticalityRepresentation)}if(t.linkProperties&&t.linkProperties.length){e=e.concat(t.linkProperties)}if(t.fieldControlProperty){e.push(t.fieldControlProperty)}if(t.timezone){e.push(t.timezone)}return e};o.prototype._enrichWithTableViewMetadata=function(t,e){var a=[],o,s,r,l;var d=function(t){var e,i;if(t&&t.indexOf("/")>-1){i=t.split("/");i.pop();e=i.join("/")}return e};this._updateLabel(t);t.importance=this._getFieldImportance(t)||t.importance;t.isInitiallyVisible=this._isInitiallyVisible(t);t.index=this._getIndex(t,e);if(!t.width){l=this._getLineItemFieldWidth(t);if(l){t.width=l}else if(!this._isMobileTable&&!this._bEnableAutoColumnWidth){t.width=i.getWidth(t)}}o=this._getAdditionalProperty(t);r=o.length;if(r){t.additionalProperty=o.join(",")}while(r--){s=d(o[r]);if(s){a.push(s)}}if(t.parentPropertyName){a.push(t.parentPropertyName)}t.navigationProperty=a.join(",");this._setSortOrder(t);if(t.isFiscalDate){n.updateViewMetadata(t)}if(this._isAnalyticalTable){t.summed=t.aggregationRole==="measure";this._setInResult(t);this._setGroupBy(t);this._mapDimensionFromTextProperty(t)}};o.prototype._isInitiallyVisible=function(t){var e=false;if(this._oLineItemAnnotation&&this._oLineItemAnnotation.fields){e=this._oLineItemAnnotation.fields.indexOf(t.name)>-1;if(e&&!a.system.desktop&&!this._bShowDetailsButton){var i=t.importance;if(i){if(a.system.tablet){e=i==="High"||i==="Medium"}else if(a.system.phone){e=i==="High"}}}}if(!e&&this._aInitiallyVisibleFields){e=this._aInitiallyVisibleFields.indexOf(t.name)>-1}return e};o.prototype._setInResult=function(t){if(this._oPresentationVariant){if(this._oPresentationVariant.requestAtLeastFields&&this._oPresentationVariant.requestAtLeastFields.indexOf(t.name)>-1){t.inResult=true}}else if(this.enableInResultForLineItem){if(this._oLineItemAnnotation&&this._oLineItemAnnotation.fields&&this._oLineItemAnnotation.fields.indexOf(t.name)>-1){t.inResult=true}}};o.prototype._setSortOrder=function(t){var e;if(this._oPresentationVariant&&this._oPresentationVariant.sortOrderFields){e=this._oPresentationVariant.sortOrderFields.length;for(var i=0;i<e;i++){if(this._oPresentationVariant.sortOrderFields[i].name===t.name){t.sorted=true;t.sortOrder=this._oPresentationVariant.sortOrderFields[i].descending?"Descending":"Ascending";break}}}};o.prototype._setGroupBy=function(t){if(this._oPresentationVariant&&this._oPresentationVariant.groupByFields&&this._oPresentationVariant.groupByFields.indexOf(t.name)>=0){t.grouped=true}};o.prototype._getFieldImportance=function(t){var e=null;if(this._oLineItemAnnotation&&this._oLineItemAnnotation.importance){e=this._oLineItemAnnotation.importance[t.name]}return e};o.prototype._getLineItemFieldWidth=function(t){var e=null;if(this._oLineItemAnnotation&&this._oLineItemAnnotation.width){e=this._oLineItemAnnotation.width[t.name]}return e};o.prototype._mapDimensionFromTextProperty=function(t){if(!t.description||t.aggregationRole!=="dimension"){return}if(!this._mDimensionFromText){this._mDimensionFromText={}}this._mDimensionFromText[t.description]=t.name};o.prototype._getIndex=function(t,e){var i=-1,a=0,n=0;if(this._oLineItemAnnotation&&this._oLineItemAnnotation.fields){a=this._oLineItemAnnotation.fields.length;i=this._oLineItemAnnotation.fields.indexOf(t.name)}if(i<0&&this._aInitiallyVisibleFields){n=this._aInitiallyVisibleFields.length;i=this._aInitiallyVisibleFields.indexOf(t.name);if(i>-1){i+=a}}if(i>-1){return i}return e+a+n};o.prototype._updateLabel=function(t){var e;if(this._oLineItemAnnotation&&this._oLineItemAnnotation.labels){e=this._oLineItemAnnotation.labels[t.name]}if(e){t.label=e;if(t.template&&t.template.setSemanticObjectLabel){t.template.setSemanticObjectLabel(t.label)}}};o.prototype.getFieldLabel=function(t,e){if(!e){return null}var i;if(e.indexOf("/")>-1){i=this._oMetadataAnalyser.extractNavigationPropertyField(e,t)}else{i=this._oMetadataAnalyser.getFieldsByEntitySetName(t).find(function(t){return t.name==e})}if(!i){return null}return i["com.sap.vocabularies.Common.v1.Label"]&&i["com.sap.vocabularies.Common.v1.Label"]["String"]||i["fieldLabel"]||null};o.prototype.destroy=function(){if(this._oMetadataAnalyser&&this._oMetadataAnalyser.destroy){this._oMetadataAnalyser.destroy()}this._oMetadataAnalyser=null;if(this._oControlProvider&&this._oControlProvider.destroy){this._oControlProvider.destroy()}this._mDimensionFromText=null;this._oControlProvider=null;this._aODataFieldMetadata=null;this._aTableViewMetadata=null;this._aIgnoredFields=null;this._aInitiallyVisibleFields=null;this._sIgnoredFields=null;this._sInitiallyVisibleFields=null;this.bIsDestroyed=true};return o},true);
//# sourceMappingURL=TableProvider.js.map