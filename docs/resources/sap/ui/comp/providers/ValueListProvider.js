/*!
 * SAPUI5
 * (c) Copyright 2009-2022 SAP SE. All rights reserved.
 */
sap.ui.define(["sap/ui/core/library","sap/ui/comp/library","sap/m/library","sap/ui/comp/odata/MetadataAnalyser","sap/ui/comp/util/DateTimeUtil","sap/ui/core/SeparatorItem","sap/m/GroupHeaderListItem","sap/m/Column","sap/m/ColumnListItem","sap/m/Text","sap/m/Token","./BaseValueListProvider","sap/ui/core/ListItem","sap/ui/model/Filter","sap/ui/model/Sorter","sap/ui/model/json/JSONModel","sap/ui/model/FilterOperator","sap/ui/comp/util/FormatUtil","sap/ui/comp/historyvalues/HistoryValuesProvider","sap/ui/comp/historyvalues/HistoryOptOutProvider","sap/ui/comp/historyvalues/Constants","sap/m/ComboBox","sap/m/MultiComboBox","sap/m/Select","sap/base/util/deepEqual","sap/ui/Device","sap/base/Log","sap/base/util/values","sap/m/Label","sap/base/strings/whitespaceReplacer","sap/ui/comp/smartfilterbar/FilterProviderUtils"],function(t,e,i,o,s,n,r,a,l,h,u,d,g,p,c,m,f,_,y,S,C,v,F,P,b,V,I,D,A,w,H){"use strict";var T=e.smartfilterbar.DisplayBehaviour;var R=i.PopinDisplay;var L=i.WrappingType;var M=t.ValueState;var B=sap.ui.getCore().getLibraryResourceBundle("sap.ui.comp").getText("SEARCH_FIELD_VALIDATION_WARNING_MESSAGE");var N={Recommendations:10,RecentlyUsed:20,Others:30};var x="list";var E=d.extend("sap.ui.comp.providers.ValueListProvider",{constructor:function(t){if(t){this.sAggregationName=t.aggregation;this.bTypeAheadEnabled=!!t.typeAheadEnabled;this.bEnableShowTableSuggestionValueHelp=t.enableShowTableSuggestionValueHelp===undefined?true:t.enableShowTableSuggestionValueHelp;this.dropdownItemKeyType=t.dropdownItemKeyType;this.sDeferredGroupId=t.deferredGroupId;this._fieldHistoryEnabled=t.fieldHistoryEnabled;this._fieldHistoryEnabledInitial=t.fieldHistoryEnabledInitial}this._aRecommendations=[];this._oRecommendationListPromise=Promise.resolve();this._oResourceBundle=sap.ui.getCore().getLibraryResourceBundle("sap.ui.comp");this._groupHeaderFactory=this._groupHeaderFactory.bind(this);this._pendingValidationCount=0;d.apply(this,arguments);this._onInitialise()}});E.prototype._onInitialise=function(){if(!this.bTypeAheadEnabled){this.oAfterRenderingEventDelegate={onAfterRendering:this._onMetadataInitialised};this.oControl.addEventDelegate(this.oAfterRenderingEventDelegate,this)}else if(this.oControl.attachSuggest){this._fSuggest=function(t){this.oControl=t.getSource();if(!this.bInitialised){return}if(!this.isDisableSearchMatchesPatternWarning()&&this.oControl.getValueState&&this.oControl.getValueState()===M.Warning&&this.oControl.getValueStateText&&this.oControl.getValueStateText()===B){return}if(!this._oTemplate||!this.oControl.data("_hassuggestionTemplate")){this._createSuggestionTemplate()}var e=t.getParameter("suggestValue");this._fetchData(e)}.bind(this);this.oControl.attachSuggest(this._fSuggest);if(!this.oFilterModel){var t=this;var e=this.oControl.setParent;this.oControl.setParent=function(i,o,s){var n=this.getParent();var r=e.apply(this,arguments);i=this.getParent();var a=!(i&&n===null);if(i!==n&&a){t.unbindAggregation()}return r}}this._handleSelect()}this.oControl.setModel(new m,x);this._setupHistoryValues();this._setupRecommendations()};E.prototype._onMetadataInitialised=function(){if(this.bInitialised){if(this.oAfterRenderingEventDelegate){this.oControl.removeEventDelegate(this.oAfterRenderingEventDelegate)}if(this.oPrimaryValueListAnnotation){this._oPresentationVariant=this._handlePresentationVariantSortOrderAnnotation();if(this.sAggregationName&&this.sAggregationName=="suggestionRows"){this._createSuggestionTemplate()}else{this._createDropDownTemplate()}this._fetchData();if(this._isControlDropdown()){if(this.mOutParams&&Object.keys(this.mOutParams).length>1){this._handleOutParameters()}if(this.mInParams&&Object.keys(this.mInParams).length>1){this._handleInParameters()}}}else{I.error("ValueListProvider","Missing primary ValueListAnnotation for "+(this._sFullyQualifiedFieldName||this.sFieldName))}if(this.oAfterRenderingEventDelegate){delete this.oAfterRenderingEventDelegate}}};E.prototype._onAnnotationLoad=function(t){var e=d.prototype._onAnnotationLoad.call(this,t);if(!this._isControlSupportedForHistory(this.oControl)){return e}if(this._shouldHaveRecommendations()||this._shouldHaveHistory()){this._setupSuggestionInteractions()}if(this.sContext==="SmartFilterBar"&&this._hasNotValidatedSingleField(this.sFieldName)){this._validateInput(this.oFilterProvider._oNotValidatedSingleFields[this.sFieldName]);this.oFilterProvider._oNotValidatedSingleFields[this.sFieldName]=""}return e};E.prototype._isSortable=function(t){if(this.oPrimaryValueListAnnotation){for(var e=0;e<this.oPrimaryValueListAnnotation.valueListFields.length;e++){if(this.oPrimaryValueListAnnotation.valueListFields[e].name===t){return this.oPrimaryValueListAnnotation.valueListFields[e].sortable!==false}}return false}return false};E.prototype._createDropDownTemplate=function(){this._oTemplate=new g({key:{path:this._resolveSuggestionBindingPath(this.sKey),type:this.dropdownItemKeyType},text:{parts:[{path:this._resolveSuggestionBindingPath(this.sKey),type:this.dropdownItemKeyType},{path:this._resolveSuggestionBindingPath(this.sDescription)}],formatter:function(t,e){var i=_.getFormatterFunctionFromDisplayBehaviour(this.sDDLBDisplayBehaviour),o=i(t,e);return w(o)}.bind(this)}});if(this._oRecommendationListAnnotation){this._oTemplate.bindProperty("additionalText",{path:this._resolveSuggestionBindingPath(this._oRecommendationListAnnotation.rankProperty)})}this._oSorter=null;var t=this._isSortable(this.sKey),e=this._isSortable(this.sDescription);if(this._oPresentationVariant){if(this._oPresentationVariant._bIsPresentationVariantSortPathInVHDEntityType&&this._oPresentationVariant._bIsPresentationVariantSortOrderPropertySortable){this._oSorter=new c(this._oPresentationVariant.sPresentationVariantSortPath,this._oPresentationVariant.sortOrderFields[0].descending)}else{I.error("ValueListProvider","Is Presentation Variant SortOrder property path part of EntityType = "+this._oPresentationVariant._bIsPresentationVariantSortPathInVHDEntityType+". Is property sortable ="+this._oPresentationVariant._bIsPresentationVariantSortOrderPropertySortable)}}else{if(this.sDDLBDisplayBehaviour===T.idOnly||this.sDDLBDisplayBehaviour===T.idAndDescription||this.sDDLBDisplayBehaviour===T.descriptionAndId){if(t){this._oSorter=new c(this.sKey)}}else{if(e){this._oSorter=new c(this.sDescription)}else if(this.sDescription!==this.sKey&&t){this._oSorter=new c(this.sKey)}}}};E.prototype._createSuggestionTemplate=function(){var t=0,e=0,i=0,o=this._aHighImportanceCols||this._aRecommendationCols||this._aCols;this._oTemplate=new l;if(o){this.oControl.removeAllSuggestionColumns();e=o.length;for(t=0;t<e;t++){var s=false,n="1px",r=o[t].suggestionsWidth;if(V.system.phone){r=undefined;if(t>=2){s=true;n=(t+1)*10+"rem"}}this.oControl.addSuggestionColumn(new a({header:new A({wrapping:true,wrappingType:L.Hyphenated,text:o[t].label}),demandPopin:s,popinDisplay:R.Inline,minScreenWidth:n,width:r}));var h={path:this._resolveSuggestionBindingPath(o[t].template),type:o[t].oType,formatter:function(t){return w(t)}};if(Array.isArray(o[t].template)){h={parts:[{path:this._resolveSuggestionBindingPath(o[t].template[0])},{path:this._resolveSuggestionBindingPath(o[t].template[1])}],formatter:function(t,e,i){var o=_.getFormatterFunctionFromDisplayBehaviour(t),s=o(e,i);return w(s)}.bind(this,o[t].displayBehaviour)}}this._oTemplate.addCell(new A({wrapping:true,text:h}));if(r){i+=parseFloat(r.substring(0,r.length-2))}}if(i>0){this.oControl.setProperty("maxSuggestionWidth",i+e+"em",true)}if(e===1){this.oControl._setSeparateSuggestions(false)}}this.oControl.data("_hassuggestionTemplate",true);if(this.oControl&&this.oControl._oSuggestionTable){this.oControl._oSuggestionTable.addStyleClass("sapUiCompValueListProviderTable")}};E.prototype._handleRowSelect=function(t,e,i){var o,s,n,r=i&&typeof i.getPath==="function"&&i.getPath()||"";if(t){o=t[this.sKey];s=t[this.sDescription]}if(o||o===""){if(this.oControl.addToken){s=w(_.getFormattedExpressionFromDisplayBehaviour(this.sTokenDisplayBehaviour,o,s));n=new u;n.setKey(o);n.setText(s);n.setTooltip(s);n.data("row",t);if(e){e(n)}if(this.oControl.getValue()===""){this.oControl.setValue("")}delete this.oControl.__sValidationText}else{if(this.sContext==="SmartField"&&this._selectedODataRowHandler){this._selectedODataRowHandler(o,t,r)}this.setValue(o);if(this.sContext==="SmartFilterBar"||this.sContext==="mdcFilterPanel"){this.oControl.setValue(_.getFormattedExpressionFromDisplayBehaviour(this.sSingleFieldDisplayBehaviour,o,s));this.oControl.setValueState("None");this.oFilterProvider.oModel.setProperty("/"+this.sFieldName,o);this.oFilterProvider._setSingleInputsTextArrangementFieldData(this.sFieldName,o,s);if(!this.oFilterProvider._oSingleFieldSetFromFilterData[this.sFieldName]){this.oControl.fireChange({value:o,validated:true})}delete this.oFilterProvider._oSingleFieldSetFromFilterData[this.sFieldName]}if(this.sContext!=="SmartFilterBar"){this.oControl.fireChange({value:o,validated:true})}}}if(this.fnAsyncWritePromise){this.fnAsyncWritePromise().then(this._calculateAndSetFilterOutputData.bind(this,[t]))}else{this._calculateAndSetFilterOutputData([t])}};E.prototype._multiInputValidator=function(t){if(!this.bInitialised){return}if(this._aValidators){var e;this._aValidators.some(function(i){e=i(t);return e},this);if(e){return e}}var i=t.suggestionObject,o,s=t.text;if(i){var n=this._getSuggestionsModelName(),r=i.getBindingContext(n);o=r.getObject();this._handleRowSelect(o,t.asyncCallback,r)}else if(s){this._validateInput(s,t.asyncCallback)}};E.prototype._validateInput=function(t,e){var i,o=[],s=this.oControl,n;if(this.sDisplayFormat==="UpperCase"){t=t.toUpperCase()}if(s.__sValidationText!==t){s.__sValidationText=t;if(t===this._truncateSearchText(t)||this.sContext==="SmartFilterBar"&&this._fieldViewMetadata.filterRestriction==="single"){s.__bValidatingToken=true;this._calculateFilterInputData();if(this.mFilterInputData&&this.aFilterField){o=H.generateFilters(this.aFilterField,this.mFilterInputData)}o.push(new p(this.sKey,f.EQ,t));if(this.bSupportBasicSearch){n={"search-focus":this.sKey}}this._pendingValidationCount++;i=new Promise(function(t,i){this.oODataModel.read("/"+this.sValueListEntitySetName,{filters:o,urlParameters:n,success:function(i){if(!this.oControl||!this._pendingValidationCount&&!this.oControl.hasOwnProperty("__bValidatingToken")){return}var o=i;delete this.oControl.__bValidatingToken;this._pendingValidationCount--;if(i){if(i.results&&i.results.length>=1){if(i.results.length===1){o=i.results[0]}if(this.sContext==="SmartFilterBar"&&this._fieldViewMetadata.filterRestriction==="single"&&i.results.length>1){o=i.results[0]}if(this.oControl.data("__validationError")){this.oControl.data("__validationError",null);this.oControl.setValueState("None")}}else{this.oControl.setValueState("Error");this.oControl.data("__validationError",true)}if(o&&o[this.sKey]){s._pendingAutoTokenGeneration=true;this._handleRowSelect(o,e);s._pendingAutoTokenGeneration=false}}this._afterTokenValidate();t()}.bind(this),error:function(){if(this.oControl.data("__validationError")){this.oControl.setValueState("None")}delete this.oControl.__bValidatingToken;this._afterTokenValidate();t()}.bind(this)})}.bind(this));this._addValidationPromise(i)}}else{if(s.data("__validationError")){s.setValueState(M.Error)}}};E.prototype._validateStringSingleWithValueList=function(t){var e;if(t.getParameter("validated")){return}e=t.getParameter("value");if(e===""||e===undefined){return}this._validateInput(e)};E.prototype._afterTokenValidate=function(){if(this.oFilterProvider&&this.oFilterProvider._oSmartFilter&&this.oFilterProvider._oSmartFilter.bIsSearchPending&&this.oFilterProvider._oSmartFilter.search){if(this.oFilterProvider._oSmartFilter.getLiveMode&&this.oFilterProvider._oSmartFilter.getLiveMode()){return}this.oFilterProvider._oSmartFilter.search()}};E.prototype._onSuggestionItemSelected=function(t){var e,i=t.getParameter("selectedRow");if(i){var o=this._getSuggestionsModelName();e=i.getBindingContext(o);this._handleRowSelect(e.getObject(),null,e)}};E.prototype._setFilterOutputDataFromSelectedRow=function(t){var e,i,o;if(t){e=this._getSuggestionsModelName();i=t.getBindingContext(e);o=i.getObject();this._calculateAndSetFilterOutputData([o])}};E.prototype._onMultiComboBoxItemSelected=function(t){if(!t.getParameter("selected")){return}var e=t.getParameter("changedItem");this._setFilterOutputDataFromSelectedRow(e)};E.prototype._onComboBoxItemSelected=function(t){var e=t.getParameter("value"),i=t.getParameter("newValue"),o=t.getParameter("filterChangeReason");if(o&&!e&&!i){return}var s=this.oControl.getSelectedItem();this._setFilterOutputDataFromSelectedRow(s)};E.prototype._handleSelect=function(){if(this.oControl.addValidator){this._aValidators=this.oControl&&this.oControl.isA("sap.m.MultiInput")?this.oControl.getValidators().slice():[];this.oControl.removeAllValidators();this._fValidator=this._multiInputValidator.bind(this);this.oControl.addValidator(this._fValidator)}else if(this.oControl.attachSuggestionItemSelected){this.oControl.attachSuggestionItemSelected(this._onSuggestionItemSelected,this);if(this.sContext==="SmartFilterBar"&&this._fieldViewMetadata&&this._fieldViewMetadata.hasValueListAnnotation){this.oControl.attachChange(this._validateStringSingleWithValueList,this)}}if(this.oControl.setRowResultFunction){this.oControl.setRowResultFunction(function(t){var e,i="",o=this._getSuggestionsModelName();if(t){e=t.getBindingContext(o)}if(e&&this.sKey){i=e.getProperty(this.sKey)}return i}.bind(this))}};E.prototype._filterDropdownRowsByInParameters=function(){this._calculateFilterInputData();if(this.mFilterInputData&&this.aFilterField){this.oControl.setBusy(true);this._fetchData();this._mLastFilterInputData=this.mFilterInputData;if(!this.oControl.isA("sap.m.Select")){this._cleanupControlSelection()}}};E.prototype.isInSmartFilterBar=function(){return!!this.oFilterModel};E.prototype.isDisableSearchMatchesPatternWarning=function(){if(this._disableSearchMatchesPatternWarning===undefined&&this.isInSmartFilterBar()&&this.oFilterProvider&&this.oFilterProvider._oSmartFilter){this._disableSearchMatchesPatternWarning=this.oFilterProvider._oSmartFilter.getDisableSearchMatchesPatternWarning()}return this._disableSearchMatchesPatternWarning};E.prototype._isControlDropdown=function(t){if(!t){t=this.oControl}return!!(t.isA("sap.m.MultiComboBox")||t.isA("sap.m.ComboBox"))||t.isA("sap.m.Select")};E.prototype._cleanupControlSelection=function(){if(this.oControl.isA("sap.m.MultiComboBox")){this.oControl.setSelectedKeys(null);if(this.isInSmartFilterBar()){this.oFilterModel.setProperty("/"+this.sFieldName+"/items",[])}}else{this.oControl.setSelectedKey(null);this.oControl.clearSelection()}};E.prototype._openDropdown=function(){if(this.oControl.isA("sap.m.MultiComboBox")){F.prototype.open.apply(this.oControl,arguments)}else if(this.oControl.isA("sap.m.ComboBox")){v.prototype.open.apply(this.oControl,arguments)}else if(this.oControl.isA("sap.m.Select")){P.prototype.open.apply(this.oControl,arguments)}};E.prototype._handleOutParameters=function(){if(this.oControl.isA("sap.m.MultiComboBox")){this.oControl.attachSelectionChange(this._onMultiComboBoxItemSelected,this)}else if(this.oControl.isA("sap.m.ComboBox")||this.oControl.isA("sap.m.Select")){this.oControl.attachChange(this._onComboBoxItemSelected,this)}};E.prototype._handleInParameters=function(){this.oControl.setBusyIndicatorDelay(0);this._calculateFilterInputData();this._mLastFilterInputData=this.mFilterInputData;this.oControl.open=function(){this._calculateFilterInputData();if(b(this._mLastFilterInputData,this.mFilterInputData)){this._openDropdown();return}this._filterDropdownRowsByInParameters();this._openDropdown()}.bind(this);this.oControl.addEventDelegate({onmousedown:function(t){if(this.oControl.getArrowIcon&&t.target===this.oControl.getArrowIcon().getFocusDomRef()){this._bSkipFocusIn=true}}.bind(this),onmouseup:function(t){if(this._bSkipFocusIn&&(this.oControl.getArrowIcon&&t.target===this.oControl.getArrowIcon().getFocusDomRef())){this.oControl.open()}this._bSkipFocusIn=false}.bind(this),onfocusin:function(t){if(this._bSkipFocusIn){return t}setTimeout(function(){this._calculateFilterInputData();if(b(this._mLastFilterInputData,this.mFilterInputData)){return}this._filterDropdownRowsByInParameters()}.bind(this));return t}.bind(this)})};E.prototype._primaryValueListAnnotationChanged=function(t){var e=this.oControl,i=this._oMetadataAnalyser,o,s,n=[],r=e.getBindingContext()&&e.getBindingContext().getPath();if(r){o=e.getModel()&&e.getModel().getContext(r);s=i.getPropertyContextByPath(this._sFullyQualifiedFieldName);n=i._getODataValueListRelevantQualifiers(s,o)}if(n.length>0&&(!n.includes(this.oPrimaryValueListAnnotation.qualifier)||n.includes("")&&this.oPrimaryValueListAnnotation.qualifier!=="")){i.getValueListAnnotationLazy(this._sFullyQualifiedFieldName,r).then(function(i){if(e.oParent&&e.oParent._oFactory){e.oParent._oFactory._initValueList(i)}this._onAnnotationLoad(i);this._rebindInnerControlSuggestions();this._fetchData(t)}.bind(this));return true}return false};E.prototype._fetchData=function(t){var e={},i=[],s=this._getBindingLength(),n="",r,a;if(o.hasValueListRelevantQualifiers(this._fieldViewMetadata)&&this._primaryValueListAnnotationChanged(t)){return}t=t||"";if(this.bTypeAheadEnabled){if(t&&this.sDisplayFormat==="UpperCase"){t=t.toUpperCase()}if(this.bSupportBasicSearch){if(this._shouldHaveRecommendations()||this._shouldHaveHistory()){e={"search-focus":this.sKey,search:t}}else{e.custom={"search-focus":this.sKey,search:t}}}this._calculateFilterInputData();if(this.mFilterInputData&&this.aFilterField){i=H.generateFilters(this.aFilterField,this.mFilterInputData,{dateSettings:this._oDateFormatSettings})}if(!this.bSupportBasicSearch){if(this._fieldViewMetadata&&this._fieldViewMetadata.filterType==="numc"){i.push(new p(this.sKey,f.Contains,t))}else{n=this._truncateSearchText(t);if(n===t){i.push(new p(this.sKey,f.StartsWith,n))}else{this.oControl.closeSuggestions();return}}}s=10}e["$top"]=s;e["$skip"]=0;if(!this.sValueListEntitySetName){I.error("ValueListProvider","Empty sValueListEntitySetName for "+this.sAggregationName+" binding! (missing primaryValueListAnnotation)")}if(this.sDeferredGroupId){e["batchGroupId"]=this.sDeferredGroupId}if(this.aSelect&&this.aSelect.length){e["$select"]=this.aSelect.toString()}if(!(this._shouldHaveRecommendations()||this._shouldHaveHistory())||!this._isControlSupportedForHistory(this.oControl)){if(this.bTypeAheadEnabled&&this.bEnableShowTableSuggestionValueHelp){a={dataReceived:function(t){var e=t.getSource(),i;if(e){i=e.getLength();if(i&&i<=s){this.oControl.setShowTableSuggestionValueHelp(false)}else{this.oControl.setShowTableSuggestionValueHelp(true)}}}.bind(this)}}else if(this.bTypeAheadEnabled){this.oControl.setShowTableSuggestionValueHelp(false)}if(this.aSelect&&this.aSelect.length){e["select"]=this.aSelect.toString();delete e["$select"]}if(this._isControlDropdown(this.oControl)&&(this.mInParams&&Object.keys(this.mInParams).length>1||this.mConstParams&&Object.keys(this.mConstParams).length>=1)){if(!a){a={dataReceived:function(){this.oControl.setBusy(false)}.bind(this)}}this._calculateFilterInputData();if(this.mFilterInputData&&this.aFilterField){i=H.generateFilters(this.aFilterField,this.mFilterInputData,{dateSettings:this._oDateFormatSettings})}}this.oControl.bindAggregation(this.sAggregationName,{path:"/"+this.sValueListEntitySetName,length:s,parameters:e,filters:i,sorter:this._oSorter,events:a,template:this._oTemplate,templateShareable:true});return}this._bindInnerControlSuggestions();var l=this;r=new Promise(function(t,o){if(!l.sValueListEntitySetName){t({results:[]})}l.oODataModel.read("/"+l.sValueListEntitySetName,{urlParameters:e,filters:i,sorters:l._oSorter&&[l._oSorter],success:function(e){t(e)},error:function(t){o(t)}})});var h=Promise.resolve([]);if(this._shouldHaveHistory()){h=l._oHistoryValuesProvider.getFieldData()}Promise.all([r,this._oRecommendationListPromise,h]).then(function(t){var e=[],i=[],o=[],n=[],r=l._getSuggestionsModelName(),a=l.oControl;if(!a){return}var h=a.getModel(r);if(Array.isArray(t[0]&&t[0].results)){i=l._addSuggestionsToGroup(t[0].results,N.Others)}if(Array.isArray(t[1]&&t[1].results)){o=l._addSuggestionsToGroup(t[1].results,N.Recommendations)}if(l._shouldHaveHistory()&&Array.isArray(t[2])){n=l._addSuggestionsToGroup(t[2],N.RecentlyUsed);n=l._parseHistoryJsonDates(n)}e=e.concat(o).concat(n).concat(i);e=l._getDistinctSuggestions(e);e=e.filter(l._filterSuggestionsWithInParams.bind(l,l.mFilterInputData));l._showSuggestionsMoreButton(i.length>=s);if(l.oControl.isA("sap.m.MultiInput")){l.oControl._oSuggPopover._oProposedItem=null}h.setData(e)})};E.prototype._sortRecommendations=function(t,e){var i=this._oRecommendationListAnnotation.rankProperty,o=parseFloat(t[i]),s=parseFloat(e[i]);return s-o};E.prototype._showSuggestionsMoreButton=function(t){if(!this.bTypeAheadEnabled){return}if(this.bEnableShowTableSuggestionValueHelp){this.oControl.setShowTableSuggestionValueHelp(t)}else{this.oControl.setShowTableSuggestionValueHelp(false)}};E.prototype._addSuggestionsToGroup=function(t,e){if(!t){return[]}return t.map(function(t){var i={};i[C.getSuggestionsGroupPropertyName()]=e;return Object.assign({},t,i)})};E.prototype._groupHeaderFactory=function(t){var e=this._getGroupHeaderTitle(t.key);if(this._isControlDropdown()){return new n({key:C.getHistoryPrefix()+t.key+".key",text:e})}return new r({title:e})};E.prototype._getGroupHeaderTitle=function(t){switch(t){case N.Recommendations:return this._oResourceBundle.getText("VALUELIST_RECOMMENDATIONS_TITLE");case N.RecentlyUsed:return this._oResourceBundle.getText("VALUELIST_RECENTLY_USED_TITLE");default:return this._oResourceBundle.getText("VALUELIST_OTHERS_TITLE")}};E.prototype._getGroupHeaderSorter=function(){if(this._groupHeaderSorter){return this._groupHeaderSorter}this._groupHeaderSorter=new c({path:C.getSuggestionsGroupPropertyName(),descending:false,group:function(t){return t.getProperty(C.getSuggestionsGroupPropertyName())}});return this._groupHeaderSorter};E.prototype._getDistinctSuggestions=function(t){var e={},i=[],o=this._aHighImportanceCols||this._aCols,s=o&&o.map(function(t){return t.template});if(!s&&t.length>0){s=Object.keys(t[0])}t.forEach(function(t){var o=s.reduce(function(e,i){e.push([i,t[i]]);return e},[]);var n=o.toString();if(!e[n]){i.push(t);e[n]=true}},this);return i};E.prototype._resolveRecommendationListAnnotationData=function(t){var e=t.fieldsToDisplay,i,o,s;this._aRecommendationCols=[];this.aRecommendationSelect=[];for(var n=0;n<e.length;n++){i=e[n];o=this._getColumnConfigFromField(i);if(i.visible){this._aRecommendationCols.push(o);this.aRecommendationSelect.push(i.name)}}if(this._aHighImportanceCols&&this._oRecommendationListAnnotation){s=this._oRecommendationListAnnotation.rankField[0];s=this._getColumnConfigFromField(s);this._aHighImportanceCols.push(s)}};E.prototype._setupRecommendations=function(){if(!this._shouldHaveRecommendations()||!this._isControlSupportedForHistory(this.oControl)){return}this._resolveRecommendationListAnnotationData(this._getRecommendationListAnnotation());this._fetchRecommendations()};E.prototype._shouldHaveRecommendations=function(){return o.isRecommendationList(this._fieldViewMetadata)};E.prototype._getRecommendationListAnnotation=function(){if(!this._oRecommendationListAnnotation){var t=this._oMetadataAnalyser._getRecommendationListAnnotation(this._sFullyQualifiedFieldName);this._oRecommendationListAnnotation=this._oMetadataAnalyser._enrichRecommendationListAnnotation(t)}return this._oRecommendationListAnnotation};E.prototype._fetchRecommendations=function(){var t=this;this._oRecommendationListPromise=new Promise(function(e,i){t.oODataModel.read("/"+t._oRecommendationListAnnotation.path,{urlParameters:{$skip:0,$top:5,$select:t.aRecommendationSelect.toString()},sorter:t._oSorter,success:function(i){var o=t._addSuggestionsToGroup(i.results,N.Recommendations),s=t._getSuggestionsModelName(),n=t.oControl.getModel(s),r=n.getData(),a=o.sort(t._sortRecommendations.bind(t));t._aRecommendations=a;if(Array.isArray(r)){a=[].concat(r).concat(a)}n.setData(a);t._showSuggestionsMoreButton(false);e(i)},error:function(t){i(t)}})})};E.prototype._createHistoryValuesProvider=function(){return new y(this.oControl,this._sFullyQualifiedFieldName)};E.prototype._createHistoryOptOutProvider=function(){return S.createOptOutSettingPage()};E.prototype._setupHistoryValues=function(){if(!this._shouldHaveHistory()||!this._isControlSupportedForHistory(this.oControl)){return}this._oHistoryValuesProvider=this._createHistoryValuesProvider();this._createHistoryOptOutProvider();this._oHistoryValuesProvider.getHistoryEnabled().then(function(t){if(!t||!this._oHistoryValuesProvider){return}this._oHistoryValuesProvider.attachChangeListener();this._oHistoryValuesProvider.attachEvent("fieldUpdated",this._onHistoryFieldUpdated,this);this._oHistoryValuesProvider.getFieldData().then(this._onHistoryDataInitialized.bind(this))}.bind(this))};E.prototype._onHistoryDataInitialized=function(t){this._updateModelHistoryData(t);return t};E.prototype._onHistoryFieldUpdated=function(t){var e=t.getParameter("fieldData")||[];if(this.oControl.isA("sap.m.Input")){setTimeout(function(){this._updateModelHistoryData(e);this.oControl&&this.oControl._oSuggPopover._oPopover.close()}.bind(this));return}this._updateModelHistoryData(e);if(this.oControl.isA("sap.m.ComboBox")){setTimeout(function(){this.oControl&&this.oControl._oSuggestionPopover._oPopover.close()}.bind(this))}};E.prototype._updateModelHistoryData=function(t){if(!this.oControl){return}t=this._parseHistoryJsonDates(t);var e=[],i=this._addSuggestionsToGroup(t,N.RecentlyUsed),o=this._getSuggestionsModelName(),s=this.oControl.getModel(o),n=s.getData();if(!Array.isArray(n)){n=[]}e=this._getDistinctSuggestions(e.concat(i).concat(n));s.setData(e);this._showSuggestionsMoreButton(false)};E.prototype._shouldHaveHistory=function(){if(!this._fieldHistoryEnabled||!this._fieldViewMetadata||!this._sFullyQualifiedFieldName||!this.oControl||this._isControlDropdown()&&(this._fieldHistoryEnabledInitial||this._fieldHistoryEnabledInitial===undefined)&&this._fieldHistoryEnabled){return false}var t=window["sap-ushell-config"],e,i,s;if(t){e=t.apps}if(e){i=e.inputFieldHistory}if(i){s=i.enabled}return sap.ushell&&sap.ushell.Container&&s&&!o.isPotentiallySensitive(this._fieldViewMetadata)};E.prototype._bindInnerControlSuggestions=function(){if(this.sAggregationName&&this.oControl.isBound(this.sAggregationName)){return}this._rebindInnerControlSuggestions()};E.prototype._rebindInnerControlSuggestions=function(){if(this.sAggregationName&&this.sAggregationName==="suggestionRows"){this._createSuggestionTemplate()}else{this._createDropDownTemplate()}var t={path:this._getSuggestionsModelName()+">/",template:this._oTemplate,templateShareable:true,length:this._getBindingLength()};t.groupHeaderFactory=this._groupHeaderFactory;t.sorter=this._getGroupHeaderSorter();if(this.sAggregationName){this.oControl.bindAggregation(this.sAggregationName,t)}};E.prototype._setupSuggestionInteractions=function(){if(this.sAggregationName==="suggestionRows"){this._setupInputSuggestionInteractions();return}this._setupComboBoxSuggestionInteractions()};E.prototype._setupInputSuggestionInteractions=function(){var t=this.oControl;t.setFilterSuggests(true);t.setFilterFunction(function(t,e){var i=this._getSuggestionsModelName(),o=e.getBindingContext(i).getObject(),s=o[this.sKey],n=o[this.sDescription],r=_.getFormatterFunctionFromDisplayBehaviour(this.sDDLBDisplayBehaviour),a=r(s,n);t=t.replace(/\*$/,"");t=t.replace(/^\*/,"");var l=Object.keys(o).some(function(e){var i=o[e]+"";return i.toLowerCase().indexOf(t.toLowerCase())!==-1});var h=a.toLowerCase().indexOf(t.toLowerCase())!==-1;return l||h}.bind(this));t.attachLiveChange(function(t){var e=t.getParameter("value"),i=[N.RecentlyUsed,N.Recommendations];if(e===""){this.oControl._oSuggPopover._oPopover.close();this._showInitialSuggestions(i)}},this);t.addEventDelegate({onmousedown:function(e){if(this.oControl.getAggregation("_suggestionPopup")&&this.oControl.getAggregation("_suggestionPopup").isOpen()||e.target.tagName!=="INPUT"){return}this._bindInnerControlSuggestions();if(this._oHistoryValuesProvider){this._oHistoryValuesProvider.getFieldData().then(function(e){this._updateModelHistoryData(e);this._showInitialSuggestions("suggestionRows",t.getValue())}.bind(this))}},onkeyup:function(e){this._bindInnerControlSuggestions();if(e.keyCode!==9){return}if(this._oHistoryValuesProvider){this._oHistoryValuesProvider.getFieldData().then(function(e){this._updateModelHistoryData(e);this._showInitialSuggestions("suggestionRows",t.getValue())}.bind(this))}}},this);if(t.isA("sap.m.MultiInput")||!this._shouldHaveRecommendations()){return}t.attachSuggestionItemSelected(function(t){var e=this._getSuggestionsModelName(),i=t.getParameter("selectedRow"),o;if(i){var s=i.getBindingContext(e).getObject();o=s&&s[this.sKey]}if(this._isNotRecommendationItemSelected("suggestionRows",o)){this._setControlValueState(M.Warning)}else{this._setControlValueState(M.None)}},this)};E.prototype._setupComboBoxSuggestionInteractions=function(){var t=this.oControl;t.setShowSecondaryValues(true);t.addEventDelegate({onmousedown:function(e){if(this.oControl.getPicker()&&this.oControl.getPicker().isOpen()||e.target.tagName!=="INPUT"){return}this._bindInnerControlSuggestions();setTimeout(function(){this._showInitialSuggestions("items",t.getValue())}.bind(this))},onkeyup:function(e){this._bindInnerControlSuggestions();if(e.keyCode!==9){return}setTimeout(function(){this._showInitialSuggestions("items",t.getValue())}.bind(this))}},this);if(t.isA("sap.m.MultiComboBox")||!this._shouldHaveRecommendations()){return}t.attachChange(function(t){if(this._isNotRecommendationItemSelected("items",t.getParameter("value"))){this._setControlValueState(M.Warning)}else{this._setControlValueState(M.None)}},this)};E.prototype._isNotRecommendationItemSelected=function(t,e){return this._findSuggestionItemGroup(t,e)!==N.Recommendations};E.prototype._findSuggestionItemGroup=function(t,e){var i=this.oControl.getBinding(t),o=i?i.getCurrentContexts():[],s;for(var n=0;n<o.length;n++){var r=o[n].getObject(),a=r[this.sKey],l=r[this.sDescription];if(a===e||l===e){s=r;break}}return s?s[C.getSuggestionsGroupPropertyName()]:null};E.prototype._setControlValueState=function(t){this.oControl.setValueState(t?t:M.None);this.oControl.setValueStateText(" ")};E.prototype._showInitialSuggestions=function(t,e){var i=this,o=[N.RecentlyUsed,N.Recommendations],s=[N.RecentlyUsed],n=[];if(this._isNotRecommendationItemSelected(t,e)){n=o}else if(this._shouldHaveHistory()){n=s}this._calculateFilterInputData();this.oControl.showItems(function(t,e){var o=i._getSuggestionsModelName(),s=e.getBindingContext(o),r=s?s.getObject():{},a=r[C.getSuggestionsGroupPropertyName()];return i._filterSuggestionsWithInParams(i.mFilterInputData,r)&&n.indexOf(a)!==-1})};E.prototype._filterSuggestionsWithInParams=function(t,e){if(!t||t.length===0){return true}return Object.keys(t).every(function(i){var o=e[i];var s=t[i];if(!o){return true}if(typeof s==="string"){return s===o}if(typeof s==="object"&&s.items&&s.items.length>0){return s.items.some(function(t){return t.key===o})}return true})};E.prototype._getSuggestionsModelName=function(){var t;if(!this._isControlSupportedForHistory(this.oControl)){return t}if(this._shouldHaveRecommendations()||this._shouldHaveHistory()){t=x}return t};E.prototype._resolveSuggestionBindingPath=function(t){var e=this._getSuggestionsModelName();if(e){t=e+">"+t}return t};E.prototype._isControlSupportedForHistory=function(t){if(!t){return false}if(t.isA("sap.ui.comp.smartfield.DisplayComboBox")){return false}if(t.isA("sap.m.ComboBox")||t.isA("sap.m.MultiComboBox")||t.isA("sap.m.Input")||t.isA("sap.m.MultiInput")){return true}return false};E.prototype._getBindingLength=function(){var t=300;if(this.oODataModel&&this.oODataModel.iSizeLimit&&this.oODataModel.iSizeLimit>t){t=this.oODataModel.iSizeLimit}return t};E.prototype._parseHistoryJsonDates=function(t){return t.map(function(t){return Object.keys(t).reduce(function(e,i){if(s._hasJsonDateString(t[i])){e[i]=s._parseJsonDateString(t[i])}else{e[i]=t[i]}return e},{})})};E.prototype._truncateSearchText=function(t){var e=-1;if(this._sMaxLength){e=parseInt(this._sMaxLength)}else if(this._fieldViewMetadata&&this._fieldViewMetadata.maxLength){e=parseInt(this._fieldViewMetadata.maxLength)}if(e>-1&&t.length>e){t=t.substr(0,e)}return t};E.prototype._handlePresentationVariantSortOrderAnnotation=function(){var t,e,i=this.oPrimaryValueListAnnotation.valueListEntityName;if(!this._oMetadataAnalyser){this._oMetadataAnalyser=new o(this.oODataModel);this._bCleanupMetadataAnalyser=true}t=this._oMetadataAnalyser._getPresentationVariantQualifierForVHD(i);e=this._oMetadataAnalyser.getPresentationVariantAnnotation(i,t);if(e&&e.sortOrderFields.length!==0){e.sPresentationVariantSortPath=e.sortOrderFields[0].name;this._oMetadataAnalyser._getEntityDefinition(i).property.forEach(function(t){if(t.name===e.sPresentationVariantSortPath){e._bIsPresentationVariantSortPathInVHDEntityType=true}});this.oPrimaryValueListAnnotation.fields.forEach(function(t){if(t.name===e.sPresentationVariantSortPath&&t.sortable===true){e._bIsPresentationVariantSortOrderPropertySortable=true}})}return e};E.prototype._hasNotValidatedSingleField=function(t){return this.oFilterProvider&&this.oFilterProvider._oNotValidatedSingleFields&&this.oFilterProvider._oNotValidatedSingleFields[t]};E.prototype.unbindAggregation=function(){if(this.oControl){this.oControl.unbindAggregation(this.sAggregationName)}return this};E.prototype.destroy=function(){if(this.oControl){if(this.oControl.detachSuggest&&this._fSuggest){this.oControl.detachSuggest(this._fSuggest);this._fSuggest=null}if(this.oControl.removeValidator&&this._fValidator){this.oControl.removeValidator(this._fValidator);this._fValidator=null}else if(this.oControl.detachSuggestionItemSelected){this.oControl.detachSuggestionItemSelected(this._onSuggestionItemSelected,this)}if(this.oControl.detachChange){this.oControl.detachChange(this._validateStringSingleWithValueList,this)}this.oControl.unbindAggregation(this.sAggregationName);this.oControl.data("_hassuggestionTemplate",false);delete this.oControl.__sValidationText;delete this.oControl.__bValidatingToken}if(this._oHistoryValuesProvider){this._oHistoryValuesProvider.destroy();this._oHistoryValuesProvider=null}d.prototype.destroy.apply(this,arguments);if(this.oJsonModel){this.oJsonModel.destroy();this.oJsonModel=null}if(this._oTemplate){this._oTemplate.destroy()}this._oTemplate=null;this.sAggregationName=null;this.bTypeAheadEnabled=null;this._oSorter=null};return E});
//# sourceMappingURL=ValueListProvider.js.map