/*!
 * SAPUI5
 * (c) Copyright 2009-2022 SAP SE. All rights reserved.
 */
sap.ui.define(["sap/ui/base/Object","./Constants","./Utils","./HistoryGlobalDataService"],function(t,i,e,a){"use strict";var n="en";var r;var s=t.extend("sap.ui.comp.historyvalues.HistoryAppDataService",{constructor:function(){t.apply(this,arguments);this._initialize()}});s.prototype._initialize=function(){this._initializeAppContainerId=this._initializeAppContainerId.bind(this);this._initializeAppData=this._initializeAppData.bind(this);this._sContainerId="";this._sItemId=i.getHistoryPrefix()+"appData";this._oPersonalizer=null;this._sAppId=i.getHistoryPrefix()+e.getAppInfo().id;this._oData={};this._oDataReadyPromise=this._getHistoryGlobalDataService().getApps().then(this._initializeAppContainerId).then(this._initializeAppData)};s.prototype._getHistoryGlobalDataService=function(){return a.getInstance()};s.prototype._initializeAppContainerId=function(t){this._sContainerId=t[this._sAppId];if(!this._sContainerId){this._createAndSaveContainerId(t)}return this._sContainerId};s.prototype._initializeAppData=function(){return this._getPersonalizer().getPersData().then(function(t){this._oData=t||this._getDefaultData();return this._oData}.bind(this))};s.prototype._getPersonalizer=function(){if(this._oPersonalizer){return this._oPersonalizer}var t=sap.ushell.Container.getService("Personalization"),i={keyCategory:t.constants.keyCategory.FIXED_KEY,writeFrequency:t.constants.writeFrequency.LOW,clientStorageAllowed:false,validity:Infinity},e={container:this._sContainerId,item:this._sItemId};this._oPersonalizer=t.getPersonalizer(e,i);return this._oPersonalizer};s.prototype._createAndSaveContainerId=function(t){this._sContainerId=this._createContainerId();t[this._sAppId]=this._sContainerId;this._getHistoryGlobalDataService().setApps(t)};s.prototype._createContainerId=function(){var t="xxxxxxxx.xxxx.4xxx.yxxx.xxxxxxxxxxxx".replace(/[xy]/g,function(t){var i=Math.random()*16|0;if(t==="y"){i=i&3|8}return i.toString(16)});return i.getShortHistoryPrefix()+t};s.prototype._getDefaultData=function(){return{}};s.prototype._isDataReady=function(){return this._oDataReadyPromise};s.prototype._getHistoryEnabled=function(){return this._getHistoryGlobalDataService().getHistoryEnabled()};s.prototype.getFieldData=function(t){return this._isDataReady().then(this._getHistoryEnabled.bind(this)).then(function(e){if(!e){return[]}var a=[],n=this._getLanguage();if(this._isDefaultLanguage(n)){a=this._oData[t]||[]}else{var r=i.getHistoryPrefix()+n;if(!this._oData[r]){a=[]}else{a=this._oData[r][t]||[]}}return a.slice()}.bind(this))};s.prototype.setFieldData=function(t,e){return this._isDataReady().then(this._getHistoryEnabled.bind(this)).then(function(a){if(!a){return false}var n=this._getLanguage();if(this._isDefaultLanguage(n)){this._oData[t]=e}else{var r=i.getHistoryPrefix()+n;if(!this._oData[r]){this._oData[r]={}}this._oData[r][t]=e}return this._getPersonalizer().setPersData(this._oData)}.bind(this))};s.prototype._getLanguage=function(){var t=sap.ui.getCore().getConfiguration().getLanguage()||n;var i=t.match(/[a-z]+/i);if(i[0]){t=i[0].toLowerCase()}return t};s.prototype._isDefaultLanguage=function(t){return t===n};s.prototype.destroy=function(){t.prototype.destroy.apply(this,arguments);this._sContainerId="";this._sItemId="";this._oPersonalizer=null;this._sAppId="";this._oData={};this._oDataReadyPromise=null};return{getInstance:function(){var t=i.getHistoryPrefix()+e.getAppInfo().id;if(!r){r=new s}if(r._sAppId!==t){r.destroy();r=new s}return r}}});
//# sourceMappingURL=HistoryAppDataService.js.map