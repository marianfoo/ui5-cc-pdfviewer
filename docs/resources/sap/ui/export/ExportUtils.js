/*!
 * SAPUI5
 * (c) Copyright 2009-2022 SAP SE. All rights reserved.
 */
sap.ui.define(["./library","sap/base/Log","sap/ui/core/Core","sap/ui/core/Fragment","sap/ui/core/library","sap/ui/core/syncStyleClass","sap/ui/model/json/JSONModel","sap/ui/model/resource/ResourceModel","sap/ui/util/openWindow","sap/ui/VersionInfo","sap/ui/core/format/DateFormat"],function(e,t,r,a,i,n,o,l,s,u,f){"use strict";var p=i.ValueState;var c=i.CalendarType;var d=e.FileType;var g=e.EdmType;var y=e.Destination;var m=null;var v=null;var h;var S=r.getLibraryResourceBundle("sap.ui.export",true);var b="sap.ui.export.ExportUtils";var T=/[\\\/\?\*:\[\]]/g;u.load().then(function(e){var t=/^[0-9]+\.[0-9]+/.exec(e.version);m=t?t[0]:null});r.attachLocalizationChanged(function(){v=null});function w(e,t,r,a){var i=Object.keys(r);var n={fileName:"Standard",fileTypeCollection:[],fileType:"XLSX",destinationCollection:[{key:y.LOCAL,text:t.getText("DESTINATION_LOCAL")}],destination:y.LOCAL,paperSize:"DIN_A4",orientation:"LANDSCAPE",splitCells:false,includeFilterSettings:false,addDateTime:false,doEnableAccessibility:false,pdfArchive:false,capabilities:r,fitToPage:false,paperSizeCollection:[{key:"DIN_A4",text:t.getText("PAPER_SIZE_A4")},{key:"US_LETTER",text:t.getText("PAPER_SIZE_US_LETTER")}],orientationCollection:[{key:"LANDSCAPE",text:t.getText("ORIENTATION_LAND")},{key:"PORTRAIT",text:t.getText("ORIENTATION_PORT")}],fontSize:10,signature:false,signatureReason:""};i.forEach(function(e){var r,a;r=e.toUpperCase();a=r+"_FILETYPE";n.fileTypeCollection.push({key:r,text:t.getText(a)})});if(a){n.destinationCollection.push({key:"REMOTE",text:t.getText("DESTINATION_REMOTE")})}var o=Object.assign({},n,e||{});if(!o.fileTypeCollection.some(function(e){return e.key===o.fileType})){o.fileType=o.fileTypeCollection[0].key}return o}function E(e){var t={};["fileName","fileType","paperSize","orientation","splitCells","includeFilterSettings","addDateTime","doEnableAccessibility","fitToPage","fontSize","signature","signatureReason","pdfArchive","destination"].forEach(function(r){t[r]=e[r]});return t}var _={_INTERCEPTSERVICE:"sap/ushell/cloudServices/interceptor/InterceptService",interceptUrl:function(e){var t=sap.ui.require(_._INTERCEPTSERVICE);if(t){var r=t.getInstance();if(r&&r.interceptUrl){e=r.interceptUrl(e)}}return e},fetchDataSource:function(){var e;if(_._oDataSource){return Promise.resolve(_._oDataSource)}e=r.getConfiguration().getFileShareSupport();if(!e){return Promise.resolve()}return new Promise(function(t){sap.ui.require([e],function(e){e.getDataSource().then(function(e){_._oDataSource=e;t(e)}).catch(function(){t()})})})},normalizeUrl:function(e){return e?new URL(e,document.baseURI).toString():e},getExportSettingsViaDialog:function(e,t,i,s,u){return new Promise(function(f,c){var g;if(typeof i==="object"){u=s;s=i}else if(typeof i==="function"){u=i}else if(typeof s==="function"){u=s}S.then(function(m){var v=new o;v.setData(w(e,m,t,i));a.load({name:"sap.ui.export.fragments.SettingsDialog",type:"XML",controller:{isPDF:function(e){return e===d.PDF},isSpreadsheet:function(e){return e===d.XLSX||e===d.GSHEET},isDestinationEnabled:function(e){return e===d.XLSX},hasDestinations:function(e){return e.length>1},formatExportButton:function(e){return e===y.LOCAL?m.getText("EXPORT_BUTTON"):m.getText("DIALOG_BUTTON_CLOUD_DESTINATION")},onCancel:function(){g._bSuccess=false;g.close()},onExport:function(){g._bSuccess=true;g.close()},onFileNameChange:function(e){var t=e.getSource();var a=e.getParameter("value");var i=/[\\/:|?"*<>]/;var n=r.byId("exportSettingsDialog-exportButton");var o=i.test(a);if(o){t.setValueState(p.Error);t.setValueStateText(m.getText("FILENAME_ERROR"))}else if(a.length>100){t.setValueState(p.Warning);t.setValueStateText(m.getText("FILENAME_WARNING"))}else{t.setValueState(p.None);t.setValueStateText(null)}n.setEnabled(!o)},onFileTypeChange:function(e){var t=e.getParameter("selectedItem");if(!t){return}switch(t.getKey()){case d.PDF:v.setProperty("/includeFilterSettings",false);v.setProperty("/destination",y.LOCAL);break;case d.GSHEET:v.setProperty("/destination",y.REMOTE);break;default:r.byId("exportSettingsDialog-signatureReason").setVisible(false);r.byId("exportSettingsDialog-signatureReasonLabel").setVisible(false)}},onFontSizeChange:function(e){var t=e.getSource();var a=e.getParameter("value");var i=/[^\d]/g;var n=r.byId("exportSettingsDialog-exportButton");var o=i.test(a);if(o){t.setValueState(p.Error);t.setValueStateText(m.getText("NUMBER_ERROR"))}else{t.setValueState(p.None);t.setValueStateText(null)}n.setEnabled(!o)},onAfterClose:function(){if(g._bSuccess){f(E(v.getData()))}else{c(null)}g.destroy();g=null}}}).then(function(e){g=e;g.setModel(v);g.setModel(new l({bundle:m}),"i18n");if(s){n("sapUiSizeCompact",s,g)}g.open();if(u){u(g)}})})})},_getFormattedFilterValue:function(e){return e instanceof Date?e.toISOString():e},_getReadableFilterValue:function(e){switch(e.op||e.name){case"==":return"="+_._getFormattedFilterValue(e.right.value);case">":case"<":case"!=":case"<=":case">=":return e.op+_._getFormattedFilterValue(e.right.value);case"between":return _._getFormattedFilterValue(e.args[1].value)+"..."+_._getFormattedFilterValue(e.args[2].value);case"contains":return"*"+e.args[1].value+"*";case"endswith":return"*"+e.args[1].value;case"startswith":return e.args[1].value+"*";default:throw Error("getReadableFilter")}},_parseFilter:function(e){switch(e.type){case"Logical":return _._parseLogical(e);case"Binary":return _._parseBinary(e);case"Unary":return _._parseUnary(e);case"Call":return _._parseCall(e);default:throw Error("Filter type "+e.type+" not supported")}},_parseLogical:function(e){var t,r;if(e.op=="&&"&&e.left.type==="Binary"&&e.right.type==="Binary"&&e.left.op===">="&&e.right.op==="<="&&e.left.left.path===e.right.left.path){return _._parseCall({args:[{path:e.left.left.path,type:"Reference"},{type:"Literal",value:e.left.right.value},{type:"Literal",value:e.right.right.value}],name:"between",type:"Call"})}t=_._parseFilter(e.left).concat(_._parseFilter(e.right));if(e.op==="||"&&t.length){r=t[0].key;if(t.every(function(e){return e.key===r})){t=[{key:r,value:t.reduce(function(e,t){var r=e?"; ":"";return e+r+t.value},"")}]}}return t},_parseBinary:function(e){if(!e.left||e.left.type!="Reference"||!e.right||e.right.type!="Literal"){return[]}return[{key:e.left.path,value:_._getReadableFilterValue(e)}]},_parseUnary:function(e){var t;if(!e.arg){return[]}t=_._parseFilter(e.arg);t[0].value="!"+t[0].value;return t},_parseCall:function(e){if(!e.args||e.args.length<2){return[]}return[{key:e.args[0].path,value:_._getReadableFilterValue(e)}]},parseFilterConfiguration:function(e,r){return new Promise(function(a,i){S.then(function(n){var o,l;o={name:n.getText("FILTER_HEADER"),items:[]};if(!e||!(e.isA("sap.ui.model.ListBinding")||e.isA("sap.ui.model.TreeBinding"))){t.error("A ListBinding is required for parsing the filter settings");i();return null}var s=e.getFilterInfo();if(s){o.items=_._parseFilter(s)}if(typeof r==="function"){o.items.forEach(function(e){l=r(e.key);e.key=l&&typeof l==="string"?l:e.key})}o.items.sort(function(e,t){var r=e.key.toLowerCase();var a=t.key.toLowerCase();if(r>a){return 1}if(r<a){return-1}return 0});a(o);return n})})},parseTechnicalConfiguration:function(){var e,t,r;e=[];r=sap.ushell&&sap.ushell.Container;return _.getResourceBundle().then(function(r){t=r;e.push({name:t.getText("TECHNICAL_INFORMATION"),items:[{key:t.getText("CREATED_TIME"),value:f.getDateTimeWithTimezoneInstance().format(new Date)}]})}).then(function(){return r&&typeof r.getServiceAsync==="function"?r.getServiceAsync("UserInfo"):undefined}).then(function(r){if(r&&r.getFullName()){e[0].items.unshift({key:t.getText("USER_NAME"),value:r.getFullName()})}return e})},saveAsFile:function(e,t){var r,a,i;if(!(e instanceof Blob)){return}r=document.createElementNS("http://www.w3.org/1999/xhtml","a");a="download"in r;if(a){i=function(e,t){r.download=t;r.href=URL.createObjectURL(e);r.dispatchEvent(new MouseEvent("click"))}}if(typeof i==="undefined"){i=function(e){var t=new FileReader;t.onloadend=function(){var e,r;r=t.result.replace(/^data:[^;]*;/,"data:attachment/file;");e=s(r,"_blank");if(!e){window.location.href=r}};t.readAsDataURL(e)}}i(e,t)},validateSettings:function(e){_._validateDataSource(e.dataSource);_.validateFileSettings(e);if(typeof e.showProgress!=="boolean"){e.showProgress=true}_._validateWorkbook(e.workbook);if(typeof e.worker!=="boolean"){e.worker=true}_._validateScaleCustomizing(e.customizing,"currency");_._validateScaleCustomizing(e.customizing,"unit")},validateFileSettings:function(e){e.fileType=d[e.fileType]?e.fileType:d.XLSX;e.fileName=_.validateFileName(e.fileName,e.fileType)},validateFileName:function(e,r){var a;e=e||"export";a="."+r.toLowerCase();if(!e.endsWith(a)&&r!==d.GSHEET){e+=a;t.info(b+": fileName was missing the proper file extension - extension has been added")}return e},_validateDataSource:function(e){var r;if(!e||typeof e!=="object"){throw new Error(b+": dataSource has not been specified")}e.type=typeof e.type==="string"&&e.type.toLowerCase()||"odata";if(e.type==="array"&&!Array.isArray(e.data)){t.warning(b+": Defined type does not match the provided data")}if(Array.isArray(e.data)){e.count=e.data.length}if(e.type==="odata"){if(typeof e.dataUrl!=="string"||e.dataUrl.length===0){throw new Error(b+": Unable to export data. No dataUrl provided.")}if(e.dataUrl){e.dataUrl=_.normalizeUrl(e.dataUrl)}if(e.serviceUrl){e.serviceUrl=_.normalizeUrl(e.serviceUrl)}}if(typeof e.count!=="number"||e.count<0||isNaN(e.count)||e.count%1!==0){t.info(b+": Invalid value for dataSource.count - value will be ignored");e.count=null}if(typeof e.useBatch!=="boolean"){e.useBatch=false;t.info(b+': Parameter useBatch not provided. Applying default value "false"')}else if(e.useBatch===true){if(typeof e.serviceUrl!=="string"||e.serviceUrl.length===0){e.useBatch=false;t.warning(b+": serviceUrl is required for OData batch requests")}if(typeof e.headers!=="object"){e.useBatch=false;t.warning(b+": headers are required for OData batch requests.")}}r=e.sizeLimit;if(!r||isNaN(r)||r%1!==0){var a=5e3,i=200;r=e.count?Math.round(e.count/(i*5))*i:i;r=Math.min(a,Math.max(r,i));e.sizeLimit=r;t.info(b+": No valid sizeLimit provided. sizeLimit is set to "+r)}},_validateWorkbook:function(e){if(!(e instanceof Object)||!Array.isArray(e.columns)){throw new Error(b+"column configuration is not provided. Export is not possible")}e.columns=e.columns.filter(function(e,a){var i;if(!(e instanceof Object)){t.error(b+": Column "+a+" skipped due to invalid configuration");return false}if(Array.isArray(e.property)&&e.type!==g.String&&e.type!=null){t.warning(b+": Type "+e.type+" does not support an array of properties");e.property=e.property[0]}if(typeof e.property!=="string"&&!Array.isArray(e.property)){t.error(b+": Column "+a+" skipped due to missing mandatory property");return false}e.label=e.label||(e.property instanceof Array?e.property[0]:e.property);i=e.width;if(typeof i==="string"){var n;n=i.toLowerCase();i=parseFloat(n);if(n.indexOf("em")>0){i=i*2}else if(n.indexOf("px")>0){i=i/8}}if(isNaN(i)||i<1){i=10}e.width=Math.round(i);_._validateType(e,a);_._validateString(e,"textAlign");if(e.textAlign){var o=(e.textAlign+"").toLowerCase();if(["begin","end"].indexOf(o)>-1){var l=["left","right"];o=(r.getConfiguration().getRTL()?l.reverse():l)[["begin","end"].indexOf(o)]}if(o!==""&&["left","right","center"].indexOf(o)==-1){t.warning(b+": Incorrect column alignment value "+o+' on column "'+(e.label||e.property)+'". Default alignment is used.');o=""}e.textAlign=o}["autoScale","delimiter","displayTimezone","displayUnit","utc","wrap"].forEach(function(t){_._validateProperty(e,t,"boolean")});["inputFormat","unit","unitProperty","template","trueValue","falseValue","timezone","timezoneProperty"].forEach(function(t){_._validateString(e,t)});if(e.template&&!Array.isArray(e.property)&&typeof e.inputFormat!=="string"){t.warning(b+': Template is not applicable on a single property without inputFormat - value will be discarded on column "'+(e.label||e.property)+'".');delete e.template}if(typeof e.calendar==="string"&&[c.Gregorian,c.Islamic,c.Japanese].indexOf(e.calendar)<0){t.warning(b+': Unsupported calendar "'+e.calendar+'" on column "'+(e.label||e.property)+'". Value will be discarded.');delete e.calendar}if(e.type===g.Boolean&&(e.trueValue===null||e.falseValue===null)){t.warning(b+': The properties trueValue and falseValue have to be assigned correctly on column "'+(e.label||e.property)+'". Values will be discarded.');delete e.trueValue;delete e.falseValue}if(e.autoScale===true&&(e.type!==g.Number||!e.unit&&!e.unitProperty)){t.warning(b+": autoScale cannot be taken into account due to invalid configuration.");delete e.autoScale}if(e.type===g.DateTime){if(!e.timezone){e.timezone=e.utc===false?(new Intl.DateTimeFormat).resolvedOptions().timeZone:"UTC"}if(e.property===e.timezoneProperty||typeof e.timezoneProperty==="string"&&e.timezoneProperty.split(",").length>1){t.warning(b+": Property timezoneProperty is invalid.");delete e.timezoneProperty}}else if(typeof e.utc==="boolean"){t.warning(b+": Property utc is only supported for type DateTime.");delete e.utc}var s=e.scale;if(e.type===g.Number&&isNaN(s)&&s!=="variable"){t.warning(b+": scale parameter for numerical column configuration is missing.")}if(typeof s==="string"){s=parseInt(s)}if(isNaN(s)){s=null}e.scale=s;if(e.valueMap&&typeof e.valueMap!=="object"){t.warning(b+': Invalid value for property "valueMap" on column "'+(e.label||e.property)+'". Value will be discarded.');delete e.valueMap}return true});_._validateWorkbookContext(e.context);_._validateString(e,"hierarchyLevel")},_validateType:function(e){var r,a;if(typeof e.type!=="string"){e.type=g.String;return}if(!g[e.type]){a=g.String;for(r in g){if(r.toLowerCase()==e.type.toLowerCase()){a=r}}t.warning(b+": Unsupported column type "+e.type+' on column "'+(e.label||e.property)+'". EdmType.'+a+" is applied.");e.type=a}switch(e.type){case g.Date:if(!e.format&&!e.calendar){_._validateString(e,"format",_.getFormatSettings().datePattern);_._validateString(e,"calendar",_.getFormatSettings().calendar)}break;case g.DateTime:if(!e.format&&!e.calendar){_._validateString(e,"format",_.getFormatSettings().dateTimePattern);_._validateString(e,"calendar",_.getFormatSettings().calendar)}break;case g.Time:_._validateString(e,"format",_.getFormatSettings().timePattern);break;case g.Number:break;case g.Currency:if(!e.unitProperty){t.warning(b+': Missing unitProperty for type Currency on column "'+(e.label||e.property)+'". Type is reverted to "String".');e.type=g.String}break;case g.Enumeration:if(!e.valueMap||typeof e.valueMap!=="object"){t.warning(b+': Invalid valueMap for type Enumeration on column "'+(e.label||e.property)+'". Type is reverted to "String".');e.type=g.String}break;default:}},_validateWorkbookContext:function(e){if(!(e instanceof Object)){return}_._validateString(e,"application","SAP UI5");_._validateString(e,"version",m);_._validateString(e,"title");_._validateString(e,"modifiedBy");_._validateString(e,"sheetName","SAPUI5 Spreadsheet Export",31,T);_._validateString(e,"metaSheetName","Metadata",31,T);if(e.metainfo){if(!Array.isArray(e.metainfo)){t.warning(b+': Invalid value for property "metainfo". Value will be discarded.');e.metainfo=null}else{e.metainfo.filter(function(e,r){if(typeof e.name!=="string"||e.name.length===0){t.warning(b+": Invalid name for metainfo group at index "+r+". Entry will be discarded.");return false}return true})}}},_validateString:function(e,r,a,i,n){var o;_._validateProperty(e,r,"string",a);o=e[r];if(typeof o==="string"&&(typeof n==="string"||n instanceof RegExp)){o=o.replace(n,"")}if(typeof o==="string"&&i&&o.length>i){t.warning(b+": The value of "+r+" exceeds the max length of "+i+" and will be truncated.");o=o.slice(0,i)}e[r]=o},_validateProperty:function(e,r,a,i){var n=e[r];if(n!=null&&typeof n!==a){t.warning(b+': Invalid value for property "'+r+". Value will be discarded.");n=null}if(n==null&&typeof i!=="undefined"){n=i}if(n==null){delete e[r]}else{e[r]=n}},_validateScaleCustomizing:function(e,r){var a,i;if(!e){return}i=e[r];if(!(i instanceof Object)||Array.isArray(i)){t.warning(b+": Invalid scale customizing for "+r+".");e[r]={}}else{for(a in i){if(!(i[a]instanceof Object)){t.warning(b+": Key "+a+" has been removed from customizing.");delete i[a]}else if(typeof i[a].scale!=="number"||i[a].scale<0){t.warning(b+": Key "+a+" has been removed from customizing due to invalid scale.");delete i[a]}}}},getExportInstance:function(e){var t,r;r=typeof e.fileType==="string"?e.fileType.toUpperCase():e.fileType;switch(r){case d.PDF:t="sap/ui/export/PortableDocument";break;default:t="sap/ui/export/Spreadsheet"}return new Promise(function(r){sap.ui.require([t],function(t){r(new t(e))})})},getCountFromBinding:function(e){var t;if(typeof e.getCount==="function"){t=e.getCount()}else if(!e.isA("sap.ui.model.TreeBinding")&&typeof e.isLengthFinal==="function"&&e.isLengthFinal()){t=e.getLength()}if(typeof t!=="number"||t<0||isNaN(t)){t=null}return t},splitColumns:function(e,t){var r=[];if(typeof t!=="function"){t=function(){}}e.forEach(function(e){var a,i,n,o;if(Array.isArray(e.property)&&e.property.length>1){i=Object.assign({},e);i.property=e.property[0];i.label=t(i.property)||e.label;delete i.template;a=[i];e.property.slice(1).forEach(function(r,i){o=t(r);n={property:r,label:o||e.label+" ("+(i+1)+")"};a.push(n)})}if(e.unitProperty&&e.displayUnit!==false){i=Object.assign({},e);o=t(e.unitProperty);a=[i,{property:e.unitProperty,label:o||e.label+" (1)"}];if(i.type===g.Currency){i.displayUnit=false}if(i.type===g.Number){delete i.unitProperty}}if(e.timezoneProperty&&e.displayTimezone!==false){i=Object.assign({},e);o=t(e.timezoneProperty);a=[i,{property:e.timezoneProperty,label:o||e.label+" (1)"}];i.displayTimezone=false}r.push(a||e)});return r.flat()},getResourceBundle:function(){if(!h){return r.getLibraryResourceBundle("sap.ui.export",true).then(function(e){h=e;return h})}return Promise.resolve(h)},getFormatSettings:function(){if(!v){var e,t;t={};e=r.getConfiguration().getFormatSettings();t.calendar=r.getConfiguration().getCalendarType();t.datePattern=e.getDatePattern("medium");t.timePattern=e.getTimePattern("medium");t.delimiter=!!e.getNumberSymbol("group");if(typeof t.datePattern==="string"){t.datePattern=t.datePattern.toLowerCase()}if(typeof t.timePattern==="string"){t.timePattern=t.timePattern.toLowerCase().replace(/ a+/," AM/PM")}if(t.datePattern&&t.timePattern){t.dateTimePattern=t.datePattern+" "+t.timePattern}v=t}return v}};return _},true);
//# sourceMappingURL=ExportUtils.js.map