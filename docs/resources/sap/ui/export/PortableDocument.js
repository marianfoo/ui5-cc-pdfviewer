/*!
 * SAPUI5
 * (c) Copyright 2009-2022 SAP SE. All rights reserved.
 */
sap.ui.define(["sap/base/Log","sap/m/MessageToast","sap/ui/core/Core","sap/ui/export/ExportBase","sap/ui/export/ExportUtils","sap/ui/model/odata/v4/ODataModel"],function(e,t,r,o,n,i){"use strict";var a=o.extend("sap.ui.export.PortableDocument",{constructor:function(e){o.call(this,e);["paperSize","orientation","font","fontSize","doEnableAccessibility","fitToPage","signature","signatureReason","pdfArchive"].forEach(function(t){if(typeof e[t]!=="undefined"){this._mSettings[t]=e[t]}}.bind(this))}});a.prototype.processDataSource=function(t){var r=null;var o=typeof t;if(!t){return null}if(o!="object"){e.error("Spreadsheet#processDataSource: Unable to apply data source of type "+o);return null}if(t.dataUrl&&t.serviceUrl){r=t}if(t.isA&&t.isA(["sap.ui.model.ListBinding","sap.ui.model.TreeBinding"])){r=this.createDataSourceFromBinding(t)}return r};a.prototype.createDataSourceFromBinding=function(t){var r=null;if(t.isA("sap.ui.model.ClientListBinding")){e.error("Unable to create dataSource configuration due to not supported Binding: "+t.getMetadata().getName())}if(t.isA("sap.ui.model.ClientTreeBinding")){e.error("Unable to create dataSource configuration due to not supported Binding: "+t.getMetadata().getName())}if(typeof t.getDownloadUrl==="function"){var o=t.getModel(),i=n.interceptUrl(t.getDownloadUrl("pdf")),a=n.interceptUrl(o.sServiceUrl),s=o.isA("sap.ui.model.odata.v4.ODataModel");var u=new URL(i,document.baseURI);u.hash="";this._oModel=o;u.search=u.search.split("&").filter(function(e){return e.indexOf("$format")==-1}).join("&");r={type:"odata",version:s?4:2,dataUrl:u.toString(),serviceUrl:a.split("/").slice(0,-5).join("/")+"/default/iwbep/common/0001/",headers:s?o.getHttpHeaders(true):o.getHeaders()}}return r};a.prototype._createDocumentDescription=function(e){var t=e.workbook;var r,o;r={Title:t.context.title,Format:{PaperSize:e.paperSize,Orientation:e.orientation,FontSize:Number(e.fontSize),FitToPage:{IsEnabled:e.fitToPage,MinimumFontSize:4}},PDFStandard:{DoEnableAccessibility:e.doEnableAccessibility,UsePDFAConformance:e.pdfArchive},Signature:{DoSign:e.signature,Reason:e.signatureReason},CoverPage:[],TableColumns:[]};o=t.context.metainfo;if(o instanceof Array){if(e.dataSource.version==2){o.forEach(function(e){e.items.forEach(function(t){var o={Title:e.name,Name:t.key,Value:t.value};r["CoverPage"].push(o)})})}else{o.forEach(function(e){var t={Title:e.name,Content:[]};e.items.forEach(function(e){t["Content"].push({Name:e.key,Value:e.value})});r["CoverPage"].push(t)})}}t.columns.filter(function(e,t,r){var o=Array.isArray(e.property)?e.property[0]:e.property;return r.findIndex(function(e){var t=Array.isArray(e.property)?e.property[0]:e.property;return o===t})===t}).forEach(function(e){r["TableColumns"].push({Name:Array.isArray(e.property)?e.property[0]:e.property,Header:e.label})});return r};a.prototype._getEntitySetName=function(e){var t=e&&e.version||2;return t==4?"MyDocumentDescriptions":"SAP__MyDocumentDescriptions"};a.prototype._getModel=function(e){var t=e.version||2;return t===4?new i({serviceUrl:e.serviceUrl,synchronizationMode:"None"}):this._oModel};a.prototype.setDefaultExportSettings=function(e){var t=e&&e.workbook&&e.workbook.context;if(!(t instanceof Object)){t=e.workbook.context={}}if(typeof t.title==="string"&&t.title){return Promise.resolve()}return r.getLibraryResourceBundle("sap.ui.export",true).then(function(e){t.title=e.getText("XLSX_DEFAULT_TITLE")})};a.prototype.postDocumentDescription=function(e,t){var r,o,n;o=this._getModel(t);n="/"+this._getEntitySetName(t);if(!o||!o.isA(["sap.ui.model.odata.v4.ODataModel","sap.ui.model.odata.v2.ODataModel"])){return Promise.reject("Unsupported Model")}return new Promise(function(t,i){if(o.isA("sap.ui.model.odata.v4.ODataModel")){r=o.bindList(n);r.attachCreateCompleted(function(e){var r=e.getParameter("success");if(r){t(e.getParameter("context").getObject()["Id"])}else{i()}});r.create(e)}else{var a=o.bUseBatch;o.setUseBatch(false);o.create(n,e,{success:function(e){o.setUseBatch(a);t(e["Id"])},error:function(e){o.setUseBatch(a);i(e)}})}})};a.prototype.createBuildPromise=function(e){var t=this;var o;var i;var a=r.getLibraryResourceBundle("sap.ui.export");i=new sap.m.BusyDialog("PDFExportBusyDialog",{title:a.getText("PROGRESS_TITLE"),text:a.getText("PDF_GENERATION_IN_PROGRESS"),showCancelButton:true,close:function(e){if(e.getParameter("cancelPressed")){t.cancel()}i.destroy();i=null}});o=t._createDocumentDescription(e);i.open();return t.postDocumentDescription(o,e.dataSource).then(function(r){return i&&t.sendRequest(e.dataSource.dataUrl,r).then(function(t){n.saveAsFile(t,e.fileName)}).catch(function(e){if(e===null){return}sap.m.MessageToast.show("Error during PDF export!")}).finally(function(){i&&i.close()})})};a.prototype.sendRequest=function(e,t){return new Promise(function(r,o){var n=this.request=new XMLHttpRequest;n.open("GET",e);n.responseType="blob";n.setRequestHeader("Accept",this.getMimeType());n.setRequestHeader("SAP-Document-Description-Id",t);n.addEventListener("abort",function(){o(null)});n.addEventListener("error",function(){o("Error occured while requesting data")});n.addEventListener("load",function(){var e=n.status;if(e>=200&&e<400){r(n.response)}else{o(n.response)}});n.send()}.bind(this))};a.prototype.getMimeType=function(){return"application/pdf"};a.prototype.cancel=function(){if(this.request&&this.request.readyState!=XMLHttpRequest.DONE){this.request.abort();this.request=null}};a.prototype.destroy=function(){o.prototype.destroy.apply(this,arguments);this._oModel=null};return a});
//# sourceMappingURL=PortableDocument.js.map