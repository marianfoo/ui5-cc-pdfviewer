/*!
 * OpenUI5
 * (c) Copyright 2009-2023 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/base/util/restricted/_difference","sap/base/util/merge","sap/base/Log","sap/ui/core/util/reflection/JsControlTreeModifier","sap/ui/dt/ElementUtil","sap/ui/dt/OverlayRegistry","sap/ui/fl/apply/api/DelegateMediatorAPI","sap/ui/rta/plugin/additionalElements/AdditionalElementsUtils","sap/ui/rta/Utils"],function(e,t,n,r,a,i,o,l,g){"use strict";var s={};function u(){var e=[];var t=o.getKnownDefaultDelegateLibraries();t.forEach(function(t){var r=sap.ui.getCore().loadLibrary(t,{async:true}).then(function(){return Promise.resolve(t)}).catch(function(e){n.warning("Required library not available: ",e);return Promise.resolve()});e.push(r)});return Promise.all(e)}function d(e,t,n){return n.hasChangeHandler(e.changeType,e.element).then(function(n){if(n){return{aggregationName:e.aggregation,addPropertyActionData:{designTimeMetadata:t,action:e,delegateInfo:{payload:e.delegateInfo.payload||{},delegate:e.delegateInfo.instance,modelType:e.delegateInfo.modelType,requiredLibraries:e.delegateInfo.requiredLibraries}}}}return undefined})}function c(e,t,r){var a=l.getParents(e,t,r);var i=a.parentOverlay&&a.parentOverlay.getDesignTimeMetadata();var o=i?i.getActionDataFromAggregations("addODataProperty",a.parent):[];if(o.length>0){n.error("Outdated addODataProperty action in designtime metadata in "+i.getData().designtimeModule+" or propagated or via instance specific designtime metadata.")}var g=i?i.getActionDataFromAggregations("add",a.parent):[];g.forEach(function(e){if(e["custom"]){n.error("Outdated custom add action in designtime metadata in "+i.getData().designtimeModule+" or propagated or via instance specific designtime metadata.")}})}function f(e,t,n){var r=e.getElement();if(!r){return[]}var o=a.getAggregation(r,t,n).filter(function(t){var r=i.getOverlay(t);if(!n.hasStableId(r)){return false}var a=e.getRelevantContainer(true);var o=i.getOverlay(a);var l=e;var g=false;do{g=!l.getElementVisibility();if(g){break}if(l===o){break}else{l=l.getParentElementOverlay()}}while(l);if(g){return true}return r.getElementVisibility()===false},this);return o.map(function(e){return{element:e,sourceAggregation:t}})}function v(e,t){return t.sParentAggregationName}function m(e,t,n,r){var a=n.changeType&&r.hasStableId(e);if(a&&e!==t.relevantContainerOverlay){a=r.hasStableId(t.relevantContainerOverlay)}return a}function p(t,n,a,l){function g(t,g){var s=g.changeOnRelevantContainer?n.relevantContainer:n.parent;var u=i.getOverlay(s);var d=m(u,n,g,a);if(d){g.element=s;return o.getDelegateForControl({control:n.relevantContainer,modifier:r,supportsDefault:g.supportsDefaultDelegate}).then(function(r){if(r&&r.names&&r.names.length){var a=o.getRequiredLibrariesForDefaultDelegate({delegateName:r.names,control:n.relevantContainer});if(e(a,l.filter(Boolean)).length===0){g.delegateInfo=r;t.push(g)}}return t})}return t}return t.reduce(function(e,t){return e.then(function(e){return g(e,t)})},Promise.resolve([]))}function h(e,t,n,r,a){var i=e.reduce(function(e,t){var n=[];r.forEach(function(e){n=n.concat(f.call(this,t,e,a))}.bind(this),[]);return t?e.concat(n):e}.bind(this),[]);var o={elements:[],controlTypeNames:[]};var l=i.reduce(function(e,t){return e.then(function(e){return A(e,t,a,n)})},Promise.resolve(o));return l.then(function(e){if(e.elements.length>0){t[n]={reveal:e}}return t})}function A(e,t,n,r){var o=t.element;var s;var u;var d=false;var c=Promise.resolve(false);var f=t.sourceAggregation;var m=i.getOverlay(o);if(m){s=m.getDesignTimeMetadata();u=s&&s.getAction("reveal",o);if(u&&u.changeType){var p=o;if(u.changeOnRelevantContainer){p=m.getRelevantContainer()}c=n.hasChangeHandler(u.changeType,p).then(function(e){if(a.isElementValid(o)){var t=l.getParents(true,m,n);if(e){if(u.changeOnRelevantContainer){d=n.hasStableId(t.relevantContainerOverlay)&&n.hasStableId(t.parentOverlay)}else{d=true}if(!u.getAggregationName){u.getAggregationName=v}if(d&&f!==r){var i=t.parentOverlay.getAggregationOverlay(r);return g.checkTargetZone(i,m,n)}}}return d})}}return c.then(function(t){if(t){e.elements.push({element:o,designTimeMetadata:s,action:u,sourceAggregation:f,targetAggregation:r});var n=s.getName(o);if(n){e.controlTypeNames.push(n)}}return e})}s.getActions=function(e,n,r,a){var i=e?"asSibling":"asChild";if(!a&&n._mAddActions){return Promise.resolve(n._mAddActions[i])}var o=this._getRevealActions(e,n,r);var l=this._getAddViaDelegateActions(e,n,r);return Promise.all([o,l,c(e,n,r)]).then(function(e){var r=t(e[0],e[1]);n._mAddActions=n._mAddActions||{asSibling:{},asChild:{}};n._mAddActions[i]=r;return r})};s.getActionsOrUndef=function(e,t){var n=e?"asSibling":"asChild";return t._mAddActions&&t._mAddActions[n]};s._getRevealActions=function(e,t,n){var r=l.getParents(e,t,n);var o=[r.parentOverlay];if(r.relevantContainer!==r.parent){o=a.findAllSiblingsInContainer(r.parent,r.relevantContainer).map(function(e){return i.getOverlay(e)}).filter(function(e){return e})}var g=[];if(r.parentOverlay){g=r.parentOverlay.getAggregationOverlays().filter(function(e){return!e.getDesignTimeMetadata().isIgnored(r.parent)}).map(function(e){return e.getAggregationName()});return g.reduce(function(e,t){return e.then(function(e){return h(o,e,t,g,n)})},Promise.resolve({}))}return Promise.resolve({})};s._getAddViaDelegateActions=function(e,t,n){var r=l.getParents(e,t,n);var a=r.parentOverlay&&r.parentOverlay.getDesignTimeMetadata();return Promise.resolve().then(function(){var e=a?a.getActionDataFromAggregations("add",r.parent,undefined,"delegate"):[];if(e.length){return u().then(p.bind(this,e,r,n))}return[]}.bind(this)).then(function(e){return e.reduce(function(e,t){return e.then(function(e){return d.call(this,t,a,n).then(function(t){if(t){t.addPropertyActionData.relevantContainer=r.relevantContainer;if(!e[t.aggregationName]){e[t.aggregationName]={}}e[t.aggregationName].addViaDelegate=t.addPropertyActionData}return e})}.bind(this))}.bind(this),Promise.resolve({}))}.bind(this))};return s});
//# sourceMappingURL=ActionExtractor.js.map