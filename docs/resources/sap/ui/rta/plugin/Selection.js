/*!
 * OpenUI5
 * (c) Copyright 2009-2023 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/rta/plugin/Plugin","sap/ui/rta/Utils","sap/ui/dt/OverlayRegistry","sap/ui/events/KeyCodes","sap/base/util/restricted/_intersection","sap/m/InstanceManager"],function(e,t,i,s,r,a){"use strict";var o=e.extend("sap.ui.rta.plugin.Selection",{metadata:{library:"sap.ui.rta",properties:{multiSelectionRequiredPlugins:{type:"string[]"},isActive:{type:"boolean",defaultValue:true}},associations:{},events:{elementEditableChange:{parameters:{editable:{type:"boolean"}}}}}});function n(e){e.preventDefault();e.stopPropagation()}function l(e,t){var i=t.slice();e.forEach(function(e){i=r(i,e.getEditableByPlugins())});return i.length>0}function c(e){return e.every(function(t){return t.getRelevantContainer()===e[0].getRelevantContainer()})}function u(e){return e.every(function(t){return t.getParentElementOverlay()===e[0].getParentElementOverlay()})}function v(e){return e.every(function(t){return t.getElement().getMetadata().getName()===e[0].getElement().getMetadata().getName()})}o.prototype.init=function(){this._multiSelectionValidator=this._multiSelectionValidator.bind(this);e.prototype.init.apply(this,arguments)};o.prototype._checkDeveloperMode=function(e,t){if(t){var i=this.getCommandFactory().getFlexSettings().developerMode;if(i&&this.hasStableId(e)){e.setEditable(true);e.setSelectable(true);this.fireElementEditableChange({editable:true});return true}}return false};o.prototype.setIsActive=function(e){this.setProperty("isActive",e);if(e===false){this._deselectOverlays()}};o.prototype.getIsActive=function(){return this.getProperty("isActive")&&this.getDesignTime()&&!this.getDesignTime().getBusyPlugins().length};o.prototype.registerElementOverlay=function(e){var t=e.getDesignTimeMetadata();if(!t.markedAsNotAdaptable()&&!this._checkDeveloperMode(e,t)){e.attachEditableChange(this._onEditableChange,this);this._adaptSelectable(e)}e.attachBrowserEvent("click",this._selectOverlay,this);e.attachBrowserEvent("contextmenu",this._selectOverlay,this);e.attachBrowserEvent("keydown",this._onKeyDown,this);e.attachBrowserEvent("mousedown",this._onMouseDown,this);e.attachBrowserEvent("mouseover",this._onMouseover,this);e.attachBrowserEvent("mouseleave",this._onMouseleave,this)};o.prototype._onEditableChange=function(e){var t=e.getSource();this._adaptSelectable(t)};o.prototype._adaptSelectable=function(e){var t=e.getEditable();if(e.getSelectable()!==t){e.setSelectable(t);if(!t){this._removePreviousHover()}this.fireElementEditableChange({editable:t})}};o.prototype.deregisterElementOverlay=function(e){e.detachBrowserEvent("click",this._selectOverlay,this);e.detachBrowserEvent("contextmenu",this._selectOverlay,this);e.detachBrowserEvent("keydown",this._onKeyDown,this);e.detachBrowserEvent("mousedown",this._onMouseDown,this);e.detachBrowserEvent("mouseover",this._onMouseover,this);e.detachBrowserEvent("mouseleave",this._onMouseleave,this);e.detachEditableChange(this._onEditableChange,this)};o.prototype._setFocusOnOverlay=function(e,t){if(e&&e.getSelectable()){e.focus();t.stopPropagation()}};o.prototype._onKeyDown=function(e){if(!this.getIsActive()){return}var i=t.getFocusedOverlay();if(e.keyCode===s.ENTER){this._selectOverlay(e)}else if(e.keyCode===s.ARROW_UP&&e.shiftKey===false&&e.altKey===false){if(i){var r=t.getFocusableParentOverlay(i);this._setFocusOnOverlay(r,e);e.preventDefault()}}else if(e.keyCode===s.ARROW_DOWN&&e.shiftKey===false&&e.altKey===false){if(i){var a=t.getFirstFocusableDescendantOverlay(i);this._setFocusOnOverlay(a,e);e.preventDefault()}}else if(e.keyCode===s.ARROW_LEFT&&e.shiftKey===false&&e.altKey===false){if(i){var o=t.getPreviousFocusableSiblingOverlay(i);this._setFocusOnOverlay(o,e);e.preventDefault()}}else if(e.keyCode===s.ARROW_RIGHT&&e.shiftKey===false&&e.altKey===false){if(i){var n=t.getNextFocusableSiblingOverlay(i);this._setFocusOnOverlay(n,e);e.preventDefault()}}else if(e.keyCode===s.ESCAPE){if(i){this._deselectOverlays()}}};o.prototype._deselectOverlays=function(){this.getDesignTime().getSelectionManager().reset()};o.prototype._selectOverlay=function(e){var t=i.getOverlay(e.currentTarget.id);if(!this.getIsActive()){if(t.isRoot()){n(e)}return}var s=e.metaKey||e.ctrlKey;var r=e.type==="contextmenu";if(t&&t.getSelectable()){if(t.isSelected()){if(!r){this.getDesignTime().getSelectionManager().remove(t)}}else if(s){this.getDesignTime().getSelectionManager().add(t)}else{this.getDesignTime().getSelectionManager().set(t)}n(e)}else if(t&&t.isRoot()){n(e)}};o.prototype._onMouseDown=function(e){if(!this.getIsActive()){var t=i.getOverlay(e.currentTarget.id);if(t.isRoot()){n(e)}a.getOpenPopovers().forEach(function(e){if(e._bOpenedByChangeIndicator){e.close()}});return}};o.prototype._onMouseover=function(e){var t=i.getOverlay(e.currentTarget.id);if(!this.getIsActive()){if(t.isRoot()){n(e)}return}if(t.isSelectable()){if(t!==this._oHoverTarget){this._removePreviousHover();this._oHoverTarget=t;t.addStyleClass("sapUiRtaOverlayHover")}n(e)}};o.prototype._onMouseleave=function(e){var t=i.getOverlay(e.currentTarget.id);if(!this.getIsActive()){if(t.isRoot()){n(e)}return}if(t.isSelectable()){this._removePreviousHover();n(e)}};o.prototype._removePreviousHover=function(){if(this._oHoverTarget){this._oHoverTarget.removeStyleClass("sapUiRtaOverlayHover")}delete this._oHoverTarget};o.prototype.setDesignTime=function(){if(this.getDesignTime()){this.getDesignTime().getSelectionManager().removeValidator(this._multiSelectionValidator)}e.prototype.setDesignTime.apply(this,arguments);if(this.getDesignTime()){this.getDesignTime().getSelectionManager().addValidator(this._multiSelectionValidator)}};o.prototype._multiSelectionValidator=function(e){return e.length===1||l(e,this.getMultiSelectionRequiredPlugins())&&c(e)&&(u(e)||v(e))};return o});
//# sourceMappingURL=Selection.js.map