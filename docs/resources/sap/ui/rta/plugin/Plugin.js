/*!
 * OpenUI5
 * (c) Copyright 2009-2023 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/dt/Plugin","sap/ui/fl/write/api/ChangesWriteAPI","sap/ui/dt/OverlayRegistry","sap/ui/dt/OverlayUtil","sap/ui/fl/changeHandler/JsControlTreeModifier","sap/ui/rta/util/hasStableId"],function(e,t,i,n,a,r){"use strict";function s(e,t,i){var n=i;if(typeof this.getActionName()==="string"){if(this.isResponsibleElementActionAvailable(i)){n=this.getResponsibleElementOverlay(i)}}var a=n.getElement()&&n.getDesignTimeMetadata()&&!n.getDesignTimeMetadata().markedAsNotAdaptable()&&this._isEditable(n,Object.assign({sourceElementOverlay:i},e));if(a&&typeof a.then==="function"){a.then(function(e){this._handleModifyPluginList(i,e)}.bind(this));t.push(a)}else{this._handleModifyPluginList(i,a)}return t}var l=e.extend("sap.ui.rta.plugin.Plugin",{metadata:{abstract:true,library:"sap.ui.rta",properties:{commandFactory:{type:"object",multiple:false}},events:{elementModified:{command:{type:"sap.ui.rta.command.BaseCommand"}}}}});l.prototype._isEditable=function(){};l.prototype.executeWhenVisible=function(e,t){var i=function(n){if(n.getSource().getGeometry()&&n.getSource().getGeometry().visible){e.detachEvent("geometryChanged",i,this);t()}};var n=e.getGeometry();if(e.getElementVisibility()&&(!n||!n.visible)){e.attachEvent("geometryChanged",i,this)}else{t()}};var o=function(e){var t=e.getParameters();var i;var n=e.getSource();if(t.type==="propertyChanged"&&t.name==="visible"){i=this._getRelevantOverlays(n);if(t.value===true){this.executeWhenVisible(n,function(){this.evaluateEditable(i,{onRegistration:false})}.bind(this))}else{this.evaluateEditable(i,{onRegistration:false})}}else if(t.type==="afterRendering"){if(this.getDesignTime().getStatus()==="synced"){this.evaluateEditable([n],{onRegistration:false})}else{this.getDesignTime().attachEventOnce("synced",function(){this.evaluateEditable([n],{onRegistration:false})},this)}}else if(t.type==="insertAggregation"||t.type==="removeAggregation"){i=this._getRelevantOverlays(n,t.name);this.evaluateEditable(i,{onRegistration:false})}else if(t.type==="addOrSetAggregation"){if(this.getDesignTime().getStatus()==="synced"){i=this._getRelevantOverlays(n,t.name);this.evaluateEditable(i,{onRegistration:false})}else{this.getDesignTime().attachEventOnce("synced",function(){i=this._getRelevantOverlays(n,t.name);this.evaluateEditable(i,{onRegistration:false})},this)}}};l.prototype._getRelevantOverlays=function(e,t){var i=e.getRelevantOverlays();if(i.length===0){var a=[];if(!e.getIsPartOfTemplate()){a=n.findAllOverlaysInContainer(e);if(t){var r=e.getAggregationOverlay(t);var s=r?r.getChildren():[];s=s.filter(function(e){return a.indexOf(e)===-1});a=a.concat(s)}}e.setRelevantOverlays(a);return a}return i};l.prototype.evaluateEditable=function(e,t){if(!t.onRegistration&&this.getDesignTime()&&this.getDesignTime().getBusyPlugins().length){return}this.setProcessingStatus(true);var i=e.reduce(s.bind(this,t),[]);if(i.length){Promise.all(i).then(function(){this.setProcessingStatus(false)}.bind(this)).catch(function(){this.setProcessingStatus(false)}.bind(this))}else{this.setProcessingStatus(false)}};l.prototype._handleModifyPluginList=function(e,t){if(t!==undefined&&t!==null){if(typeof t==="boolean"){this._modifyPluginList(e,t)}else{this._modifyPluginList(e,t.asChild,false);this._modifyPluginList(e,t.asSibling,true)}}};l.prototype._modifyPluginList=function(e,t,i){if(t){this.addToPluginsList(e,i)}else{this.removeFromPluginsList(e,i)}};l.prototype._retrievePluginName=function(e){var t=this.getMetadata().getName();if(e!==undefined){t+=e?".asSibling":".asChild"}return t};l.prototype._isEditableByPlugin=function(e,t){var i=this._retrievePluginName(t);var n=e.getEditableByPlugins();return n.indexOf(i)>-1};l.prototype.registerElementOverlay=function(e){this.executeWhenVisible(e,function(){this.evaluateEditable([e],{onRegistration:true});e.attachElementModified(o,this)}.bind(this))};l.prototype.deregisterElementOverlay=function(e){this.removeFromPluginsList(e);this.removeFromPluginsList(e,true);this.removeFromPluginsList(e,false);e.detachElementModified(o,this)};l.prototype.hasStableId=function(e){return r(e)};l.prototype.getVariantManagementReference=function(e){var t;if(e.getVariantManagement){t=e.getVariantManagement()}return t};l.prototype.checkAggregationsOnSelf=function(e,t,n,a){var r=e.getDesignTimeMetadata();var s=e.getElement();var l=r.getActionDataFromAggregations(t,s,undefined,a);var o=l.filter(function(e){if(e&&n){return e.aggregation===n}return true})[0];var g=o?o.changeType:null;var u=o&&o.changeOnRelevantContainer;if(u){s=e.getRelevantContainer();var h=i.getOverlay(s);if(!this.hasStableId(h)){return Promise.resolve(false)}}if(g){return this.hasChangeHandler(g,s)}return Promise.resolve(false)};l.prototype.removeFromPluginsList=function(e,t){var i=this._retrievePluginName(t);e.removeEditableByPlugin(i);if(!e.getEditableByPlugins().length){e.setEditable(false)}};l.prototype.addToPluginsList=function(e,t){var i=this._retrievePluginName(t);var n=e.getEditableByPlugins();if(n.indexOf(i)===-1){e.addEditableByPlugin(i);e.setEditable(true)}};l.prototype.hasChangeHandler=function(e,i,n){return t.getChangeHandler({changeType:e,element:i,modifier:a,layer:this.getCommandFactory().getFlexSettings().layer,controlType:n}).then(function(){return true}).catch(function(){return false})};l.prototype.isAvailable=function(e){return e.every(function(e){return this._isEditableByPlugin(e)},this)};l.prototype._checkRelevantContainerStableID=function(e,t){if(e.changeOnRelevantContainer){var n=t.getRelevantContainer();var a=i.getOverlay(n);if(!this.hasStableId(a)){return false}}return true};l.prototype._checkChangeHandlerAndStableId=function(e){var t=this.getAction(e);if(t&&t.changeType){var i=t.changeOnRelevantContainer?e.getRelevantContainer():e.getElement();return this.hasChangeHandler(t.changeType,i).then(function(i){return i&&this._checkRelevantContainerStableID(t,e)&&this.hasStableId(e)}.bind(this))}return Promise.resolve(false)};return l});
//# sourceMappingURL=Plugin.js.map