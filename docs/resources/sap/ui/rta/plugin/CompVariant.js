/*!
 * OpenUI5
 * (c) Copyright 2009-2023 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/m/MessageBox","sap/base/util/restricted/_omit","sap/base/util/isEmptyObject","sap/ui/dt/OverlayRegistry","sap/ui/dt/Util","sap/ui/rta/plugin/Plugin","sap/ui/rta/plugin/RenameHandler","sap/ui/rta/Utils","sap/ui/fl/write/api/ContextSharingAPI"],function(t,e,a,n,i,r,s,o,l){"use strict";var c=r.extend("sap.ui.rta.plugin.CompVariant",{metadata:{library:"sap.ui.rta",properties:{oldValue:{type:"string"}}}});function d(t,e,a,n){var r=t.getDesignTimeMetadata();var s=n||t.getElement();return this.getCommandFactory().getCommandFor(s,e,a,r).then(function(t){this.fireElementModified({command:t})}.bind(this)).catch(function(t){throw i.createError(e,t,"sap.ui.rta.plugin.CompVariant")})}function g(t){return t.getElement().getAllVariants()}function u(t){this.startEdit(t[0])}c.prototype.startEdit=function(t){var e=t.getDesignTimeMetadata().getData().variantRenameDomRef;s.startEdit.call(this,{overlay:t,domRef:e,pluginMethodName:"plugin.CompVariant.startEdit"})};c.prototype.stopEdit=function(t){s._stopEdit.call(this,t,"plugin.CompVariant.stopEdit")};c.prototype._emitLabelChangeEvent=function(){var t=this._oEditedOverlay;var e=t.getElement().getPresentVariantId();var a=s._getCurrentEditableFieldText.call(this);var n={newVariantProperties:{}};n.newVariantProperties[e]={name:a};d.call(this,t,"compVariantUpdate",n)};function p(t){var n=t[0].getElement();var i=Object.assign({isComp:true},this.getCommandFactory().getFlexSettings());var r={layer:this.getCommandFactory().getFlexSettings().layer,contextSharingComponentContainer:l.createComponent(i),rtaStyleClass:o.getRtaStyleClassName()};n.openManageViewsDialogForKeyUser(r,function(i){if(!a(i)){d.call(this,t[0],"compVariantUpdate",{newVariantProperties:e(i,["default"]),newDefaultVariantId:i.default,oldDefaultVariantId:n.getDefaultVariantId()})}}.bind(this))}function m(t){return g(t[0]).length>1}function h(t,e){var a=t[0].getElement();d.call(this,t[0],"compVariantSwitch",{targetVariantId:e.eventItem.getParameters().item.getProperty("key"),sourceVariantId:a.getPresentVariantId()})}function V(t){var e=t[0].getElement();e.getPresentVariantContent().then(function(a){var n={onlySave:true,newVariantProperties:{}};n.newVariantProperties[e.getPresentVariantId()]={content:a};d.call(this,t[0],"compVariantUpdate",n)}.bind(this))}function f(t){return t[0].getElement().currentVariantGetModified()}function C(t,e){var a=t[0].getElement();var n=Object.assign({isComp:true},this.getCommandFactory().getFlexSettings());var i=l.createComponent(n);return new Promise(function(n){a.openSaveAsDialogForKeyUser(o.getRtaStyleClassName(),function(i){if(i){d.call(this,t[0],"compVariantSaveAs",{newVariantProperties:{default:i.default,executeOnSelection:i.executeOnSelection,content:i.content,type:i.type,text:i.text,contexts:i.contexts},previousDirtyFlag:a.getModified(),previousVariantId:a.getPresentVariantId(),previousDefault:a.getDefaultVariantId(),activateAfterUndo:!!e})}n(i)}.bind(this),i)}.bind(this))}function v(t,e,a){var i=sap.ui.getCore().getLibraryResourceBundle("sap.ui.rta");if(a===i.getText("BTN_CREATE_NEW_VIEW")){C.call(this,[n.getOverlay(t)],true).then(function(a){if(!a){t.activateVariant(e)}})}else{t.activateVariant(e)}}function A(e){var a=sap.ui.getCore().getLibraryResourceBundle("sap.ui.rta");var n=e[0];var i=n.getElementInstance();var r=this.getAction(n);return r.handler(i,{styleClass:o.getRtaStyleClassName()}).then(function(e){if(e&&e.length){var r=e[0].changeSpecificData.content.persistencyKey;var s=i.getVariantManagement();var l=s.getAllVariants();var c=l.find(function(t){return t.getVariantId()===s.getPresentVariantId()});if(c.isEditEnabled(this.getCommandFactory().getFlexSettings().layer)){d.call(this,n,"compVariantContent",{variantId:e[0].changeSpecificData.content.key,newContent:e[0].changeSpecificData.content.content,persistencyKey:r},i.getVariantManagement())}else{t.warning(a.getText("MSG_CHANGE_READONLY_VARIANT"),{onClose:v.bind(this,s,c.getVariantId()),actions:[a.getText("BTN_CREATE_NEW_VIEW"),t.Action.CANCEL],emphasizedAction:a.getText("BTN_CREATE_NEW_VIEW"),styleClass:o.getRtaStyleClassName()})}}}.bind(this))}c.prototype._isEditable=function(t){return this.hasStableId(t)&&!!this.getAction(t)};c.prototype.getMenuItems=function(t){var e=t[0];var a=e.getElement();var n=[];if(this.isAvailable([e])){if(this.getAction(e).changeType==="variantContent"){n.push({id:"CTX_COMP_VARIANT_CONTENT",text:this.getActionText(e,this.getAction(e)),handler:A.bind(this),enabled:true,rank:250,icon:"sap-icon://key-user-settings"})}else{var i=this.getCommandFactory().getFlexSettings().layer;var r=sap.ui.getCore().getLibraryResourceBundle("sap.ui.rta");var s=g(e);var o=s.find(function(t){return t.getVariantId()===a.getPresentVariantId()});if(o.isRenameEnabled(i)){n.push({id:"CTX_COMP_VARIANT_RENAME",text:r.getText("CTX_RENAME"),handler:u.bind(this),enabled:true,rank:210,icon:"sap-icon://edit"})}if(o.isEditEnabled(i)){n.push({id:"CTX_COMP_VARIANT_SAVE",text:r.getText("CTX_VARIANT_SAVE"),handler:V.bind(this),enabled:f,rank:220,icon:"sap-icon://save"})}n.push({id:"CTX_COMP_VARIANT_SAVE_AS",text:r.getText("CTX_VARIANT_SAVEAS"),handler:C.bind(this),enabled:true,rank:230,icon:"sap-icon://duplicate"});n.push({id:"CTX_COMP_VARIANT_MANAGE",text:r.getText("CTX_VARIANT_MANAGE"),handler:p.bind(this),enabled:true,rank:240,icon:"sap-icon://action-settings"});var l=s.map(function(t){var e=a.getPresentVariantId()===t.getVariantId();var n={id:t.getVariantId(),text:t.getText("variantName"),icon:e?"sap-icon://accept":"blank",enabled:!e};return n});n.push({id:"CTX_COMP_VARIANT_SWITCH",text:r.getText("CTX_VARIANT_SWITCH"),handler:h.bind(this),enabled:m,submenu:l,rank:250,icon:"sap-icon://switch-views"})}}return n};c.prototype.getActionName=function(){return"compVariant"};return c});
//# sourceMappingURL=CompVariant.js.map