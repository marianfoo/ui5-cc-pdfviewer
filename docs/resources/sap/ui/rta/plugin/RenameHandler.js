/*!
 * OpenUI5
 * (c) Copyright 2009-2023 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/base/BindingParser","sap/ui/thirdparty/jquery","sap/ui/Device","sap/ui/rta/plugin/Plugin","sap/ui/dt/Overlay","sap/ui/dt/ElementUtil","sap/ui/dt/OverlayRegistry","sap/ui/rta/Utils","sap/ui/dt/DOMUtil","sap/ui/events/KeyCodes","sap/ui/dt/OverlayUtil"],function(e,jQuery,t,i,a,s,o,r,l,n,d){"use strict";var h="Â ";function c(t,i){if(i===t){throw Error("sameTextError")}var a;var s;try{a=e.complexParser(t,undefined,true)}catch(e){s=true}if(a&&typeof a==="object"||s){throw Error(sap.ui.getCore().getLibraryResourceBundle("sap.ui.rta").getText("RENAME_BINDING_ERROR_TEXT"))}}var u={errorStyleClass:"sapUiRtaErrorBg",validators:{noEmptyText:{validatorFunction:function(e){return e!==h},errorMessage:sap.ui.getCore().getLibraryResourceBundle("sap.ui.rta").getText("RENAME_EMPTY_ERROR_TEXT")}},_manageClickEvent:function(e){var t=e.getSource?e.getSource():e;if(t.isSelected()&&this.isRenameAvailable(t)&&this.isRenameEnabled([t])){t.attachBrowserEvent("click",u._onClick,this)}else{t.detachBrowserEvent("click",u._onClick,this)}},_setEditableFieldPosition:function(){if(this._$editableField){this._$editableField.offset({left:this._$oEditableControlDomRef.offset().left});this._$editableField.offset({top:this._$oEditableControlDomRef.offset().top});this._oEditedOverlay.setSelected(true);this._$editableField.focus()}},startEdit:function(e){this.setBusy(true);this._oEditedOverlay=e.overlay;var i=e.overlay.getElement();var n=this._oEditedOverlay.getDesignTimeMetadata();var h=n.getAssociatedDomRef(i,e.domRef);if(!r.isElementInViewport(h)){h.get(0).scrollIntoView()}this._$oEditableControlDomRef=jQuery(h);var c=typeof e.getTextMutators==="function"?e.getTextMutators(i):{getText:function(){return this._$oEditableControlDomRef.text()}.bind(this),setText:function(e){this._$oEditableControlDomRef.text(e)}.bind(this)};this._fnGetControlText=c.getText;this._fnSetControlText=c.setText;var f=0;var _=o.getOverlay(h instanceof jQuery?h.get(0).id:h.id);if(!_){_=this._oEditedOverlay;var v=jQuery(s.getDomRef(i));var b=this._$oEditableControlDomRef.parent();var g=parseInt(v.outerWidth());if(!isNaN(g)){var E=parseInt(this._$oEditableControlDomRef.outerWidth());var p=parseInt(b.outerWidth());f=g-E;if(f<0&&p){if(b.get(0).id!==v.get(0).id&&b.children(":visible").length===1&&b.children(":visible").get(0).id===this._$oEditableControlDomRef.get(0).id&&g>p){f=g-p}else{f=0}}}}var y=jQuery("<div class='sapUiRtaEditableField'></div>").css({"white-space":"nowrap",overflow:"hidden",width:"calc(100% - ("+f+"px))"}).appendTo(_.$());this._$editableField=jQuery("<div contentEditable='true'></div>").appendTo(y);var m=this._fnGetControlText();if(m===""){this._fnSetControlText("_?_");this._$editableField.text("")}else{this._$editableField.text(m)}this.setOldValue(u._getCurrentEditableFieldText.call(this));l.copyComputedStyle(this._$oEditableControlDomRef,this._$editableField);this._$editableField.children().remove();this._$editableField.css("visibility","hidden");this._$editableField.css({"-moz-user-modify":"read-write","-webkit-user-modify":"read-write","-ms-user-modify":"read-write","user-modify":"read-write","user-select":"text","-webkit-user-select":"text","text-overflow":"clip","white-space":"nowrap"});if(t.browser.name==="ed"&&i.getMetadata().getName()==="sap.ui.fl.variants.VariantManagement"){this._$editableField.css({"line-height":"normal"})}a.getMutationObserver().ignoreOnce({target:this._$oEditableControlDomRef.get(0)});this._$editableField.one("focus",u._onEditableFieldFocus.bind(this));this._$editableField.on("blur",u._onEditableFieldBlur.bind(this));this._$editableField.on("keydown",u._onEditableFieldKeydown.bind(this));this._$editableField.on("dragstart",u._stopPropagation.bind(this));this._$editableField.on("drag",u._stopPropagation.bind(this));this._$editableField.on("dragend",u._stopPropagation.bind(this));this._$editableField.on("click",u._stopPropagation.bind(this));this._$editableField.on("mousedown",u._stopPropagation.bind(this));this._$oEditableControlDomRef.css("visibility","hidden");y.offset({left:this._$oEditableControlDomRef.offset().left});u._setEditableFieldPosition.apply(this);this._$editableField.css("visibility","");this._$editableField.trigger("focus");this._aOverlaysWithScrollbar=d.findParentOverlaysWithScrollbar(_);this._aOverlaysWithScrollbar.forEach(function(e){e.attachScrollSynced(u._setEditableFieldPosition,this)}.bind(this));e.overlay.setSelected(true);sap.ui.getCore().getEventBus().publish("sap.ui.rta",e.pluginMethodName,{overlay:e.overlay,editableField:this._$editableField})},_setDesignTime:function(e){this._aSelection=[];var t=this.getDesignTime();if(t){t.getSelectionManager().detachChange(u._onDesignTimeSelectionChange,this)}i.prototype.setDesignTime.apply(this,arguments);if(e){e.getSelectionManager().attachChange(u._onDesignTimeSelectionChange,this);this._aSelection=this.getSelectedOverlays()}},_onDesignTimeSelectionChange:function(e){var t=e.getParameter("selection");this._aSelection.forEach(u._manageClickEvent,this);t.forEach(u._manageClickEvent,this);this._aSelection=t},_stopPropagation:function(e){e.stopPropagation()},_preventDefault:function(e){e.preventDefault()},_onEditableFieldFocus:function(e){var t=e.target;var i=document.createRange();i.selectNodeContents(t);var a=window.getSelection();a.removeAllRanges();a.addRange(i)},_stopEdit:function(e,t){var i;this.setBusy(false);if(this._fnGetControlText()==="_?_"){this._fnSetControlText("")}this._oEditedOverlay.$().find(".sapUiRtaEditableField").remove();a.getMutationObserver().ignoreOnce({target:this._$oEditableControlDomRef.get(0)});this._$oEditableControlDomRef.css("visibility","visible");if(e){i=this._oEditedOverlay;i.setSelected(true);i.focus()}this._aOverlaysWithScrollbar.forEach(function(e){e.detachScrollSynced(u._setEditableFieldPosition,this)}.bind(this));delete this._$editableField;delete this._$oEditableControlDomRef;delete this._oEditedOverlay;delete this._bBlurOrKeyDownStarted;delete this._fnGetControlText;delete this._fnSetControlText;sap.ui.getCore().getEventBus().publish("sap.ui.rta",t,{overlay:i})},_onEditableFieldBlur:function(){return u._handlePostRename.call(this,false)},_handlePostRename:function(e,t){if(!this._bBlurOrKeyDownStarted){this._oEditedOverlay.removeStyleClass(u.errorStyleClass);this._bBlurOrKeyDownStarted=true;if(t){u._preventDefault.call(this,t);u._stopPropagation.call(this,t)}return Promise.resolve().then(u._validateNewText.bind(this)).then(this._emitLabelChangeEvent.bind(this)).catch(function(e){if(e.message==="sameTextError"){return}throw e}).then(function(t){this.stopEdit(e);if(typeof t==="function"){t()}}.bind(this)).catch(function(t){return u._handleInvalidRename.call(this,t.message,e)}.bind(this))}return Promise.resolve()},_handleInvalidRename:function(e,t){return r.showMessageBox("error",e,{titleKey:"RENAME_ERROR_TITLE"}).then(function(){var e=this._oEditedOverlay;e.setIgnoreEnterKeyUpOnce(false);e.addStyleClass(u.errorStyleClass);this.stopEdit(t);this.startEdit(e)}.bind(this))},_validateNewText:function(){var e;var t=u._getCurrentEditableFieldText.call(this);c(t,this.getOldValue());var i=this.getResponsibleElementOverlay(this._oEditedOverlay);var a=this.getAction(i);var s=a&&a.validators||[];s.some(function(i){var a;if(typeof i==="string"&&u.validators[i]){a=u.validators[i]}else{a=i}if(!a.validatorFunction(t)){e=a.errorMessage;return true}});if(e){throw Error(e)}},_onEditableFieldKeydown:function(e){switch(e.keyCode){case n.ENTER:this._oEditedOverlay.setIgnoreEnterKeyUpOnce(true);return u._handlePostRename.call(this,true,e);case n.ESCAPE:this._oEditedOverlay.removeStyleClass(u.errorStyleClass);this.stopEdit(true);u._preventDefault.call(this,e);break;case n.DELETE:u._stopPropagation.call(this,e);break;default:}return Promise.resolve()},_getCurrentEditableFieldText:function(){var e=this._$editableField.text().trim();return e===""?h:e},_onClick:function(e){var t=sap.ui.getCore().byId(e.currentTarget.id);if(this.isRenameEnabled([t])&&!e.metaKey&&!e.ctrlKey){this.startEdit(t);u._preventDefault.call(this,e)}},_exit:function(){if(this._$oEditableControlDomRef){this.stopEdit(false)}}};return u},true);
//# sourceMappingURL=RenameHandler.js.map