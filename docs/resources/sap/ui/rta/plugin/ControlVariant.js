/*!
 * OpenUI5
 * (c) Copyright 2009-2023 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/rta/plugin/Plugin","sap/ui/rta/plugin/RenameHandler","sap/ui/rta/Utils","sap/ui/dt/ElementOverlay","sap/ui/dt/OverlayRegistry","sap/ui/dt/OverlayUtil","sap/ui/dt/Util","sap/ui/fl/Utils","sap/ui/fl/Layer","sap/ui/fl/variants/VariantManagement","sap/ui/fl/write/api/ContextSharingAPI","sap/ui/base/ManagedObject","sap/base/Log"],function(t,e,a,n,i,r,o,s,g,l,u,c,m){"use strict";n.prototype._variantManagement=undefined;n.prototype.getVariantManagement=function(){return this._variantManagement};n.prototype.setVariantManagement=function(t){this._variantManagement=t};n.prototype.hasVariantManagement=function(){return!!this._variantManagement};function d(t){var e=t.getElement().getManageDialog();if(e&&!e.bIsDestroyed){e.destroy()}}var p=t.extend("sap.ui.rta.plugin.ControlVariant",{metadata:{library:"sap.ui.rta",properties:{oldValue:"string"},associations:{},events:{}}});p.prototype.registerElementOverlay=function(a){var n=a.getElement();var r;t.prototype.registerElementOverlay.apply(this,arguments);if(n instanceof l){var o=n.getFor();var g;var u=s.getAppComponentForControl(n);var m=n.getId();r=u.getLocalId(m)||m;a.setVariantManagement(r);if(!o||Array.isArray(o)&&o.length===0){return}g=!Array.isArray(o)?[o]:o;g.forEach(function(t){var e=t instanceof c?t:sap.ui.getCore().byId(t);var a=i.getOverlay(e);this._propagateVariantManagement(a,r)}.bind(this));a.attachEvent("editableChange",e._manageClickEvent,this);d(a)}else if(!a.getVariantManagement()){r=this._getVariantManagementFromParent(a);if(r){a.setVariantManagement(r);a.attachEvent("editableChange",e._manageClickEvent,this)}}};p.prototype._isPersonalizationMode=function(){return this.getCommandFactory().getFlexSettings().layer===g.USER};p.prototype._propagateVariantManagement=function(t,e){var a=[];t.setVariantManagement(e);a=r.getAllChildOverlays(t);a.forEach(function(t){a=a.concat(this._propagateVariantManagement(t,e))}.bind(this));return a};p.prototype._getVariantManagementFromParent=function(t){var e=t.getVariantManagement();if(!e&&t.getParentElementOverlay()){return this._getVariantManagementFromParent(t.getParentElementOverlay())}return e};p.prototype.deregisterElementOverlay=function(a){if(this._isVariantManagementControl(a)){d(a)}a.detachEvent("editableChange",e._manageClickEvent,this);a.detachBrowserEvent("click",e._onClick,this);this.removeFromPluginsList(a);t.prototype.deregisterElementOverlay.apply(this,arguments)};p.prototype._getVariantModel=function(t){var e=s.getAppComponentForControl(t);return e?e.getModel(s.VARIANT_MODEL_NAME):undefined};p.prototype._isEditable=function(t){if(this._isPersonalizationMode()){return false}return this._isVariantManagementControl(t)&&this.hasStableId(t)};p.prototype._isVariantManagementControl=function(t){var e=t.getElement();var a=e.getAssociation("for");return!!(a&&e instanceof l)};p.prototype.isVariantSwitchAvailable=function(t){return this._isVariantManagementControl(t)};p.prototype.isVariantSwitchEnabled=function(t){var e=t[0];var a=[];if(this._isVariantManagementControl(e)){var n=e.getElement();var i=e.getVariantManagement?e.getVariantManagement():undefined;if(!i){return false}var r=this._getVariantModel(n);if(r){a=r.getData()[i].variants.reduce(function(t,e){if(e.visible){return t.concat(e)}return t},[])}var o=a.length>1;return o}return false};p.prototype.setDesignTime=function(t){e._setDesignTime.call(this,t)};p.prototype.isRenameAvailable=function(t){return this._isVariantManagementControl(t)};p.prototype.isRenameEnabled=function(t){return this._isVariantManagementControl(t[0])};p.prototype.isVariantSaveAvailable=function(t){return this._isVariantManagementControl(t)};p.prototype.isVariantSaveEnabled=function(t){var e=t[0];var a=e.getElement();var n=this._getVariantModel(a);var i=e.getVariantManagement();return n.oData[i]&&n.oData[i].modified};p.prototype.isVariantSaveAsAvailable=function(t){return this._isVariantManagementControl(t)};p.prototype.isVariantSaveAsEnabled=function(t){return this._isVariantManagementControl(t[0])};p.prototype.isVariantConfigureAvailable=function(t){return this._isVariantManagementControl(t)};p.prototype.isVariantConfigureEnabled=function(t){return this._isVariantManagementControl(t[0])};p.prototype.switchVariant=function(t,e,a){var n=t.getDesignTimeMetadata();var i=t.getElement();this.getCommandFactory().getCommandFor(i,"switch",{targetVariantReference:e,sourceVariantReference:a},n).then(function(t){this.fireElementModified({command:t})}.bind(this)).catch(function(t){throw o.createError("ControlVariant#switchVariant",t,"sap.ui.rta")})};p.prototype.renameVariant=function(t){this.startEdit(t[0])};p.prototype.startEdit=function(t){var a=t.getDesignTimeMetadata().getData().variantRenameDomRef;e.startEdit.call(this,{overlay:t,domRef:a,pluginMethodName:"plugin.ControlVariant.startEdit"})};p.prototype.stopEdit=function(t){e._stopEdit.call(this,t,"plugin.ControlVariant.stopEdit")};p.prototype.createSaveCommand=function(t){var e=t[0];var a=e.getElement();var n=e.getDesignTimeMetadata();var i=this._getVariantModel(a);var r=e.getVariantManagement();return this.getCommandFactory().getCommandFor(a,"save",{model:i},n,r).then(function(t){this.fireElementModified({command:t})}.bind(this))};p.prototype.createSaveAsCommand=function(t){var e=t[0];var a=e.getElement();var n=e.getDesignTimeMetadata();var i=this._getVariantModel(a);var r=e.getVariantManagement();var o=i.getCurrentVariantReference(r);return this.getCommandFactory().getCommandFor(a,"saveAs",{sourceVariantReference:o,model:i},n,r).then(function(t){this.fireElementModified({command:t})}.bind(this))};p.prototype._emitLabelChangeEvent=function(){var t=e._getCurrentEditableFieldText.call(this);var a=this._oEditedOverlay;var n=a.getDesignTimeMetadata();var i=a.getElement();var r=a.getVariantManagement();return this._createSetTitleCommand({text:t,element:i,designTimeMetadata:n,variantManagementReference:r}).then(function(t){this.fireElementModified({command:t})}.bind(this))};p.prototype._createSetTitleCommand=function(t){this._$oEditableControlDomRef.text(t.text);return this.getCommandFactory().getCommandFor(t.element,"setTitle",{newText:t.text},t.designTimeMetadata,t.variantManagementReference).catch(function(t){m.error("Error during rename: ",t)})};p.prototype._prepareOverlayForValueState=function(t,e){t.getValueState=function(){return"Error"};t.getValueStateText=function(){return e};t.getDomRefForValueStateMessage=function(){return this.$()}};p.prototype.configureVariants=function(t){var e=t[0];var n=e.getElement();var i=e.getVariantManagement();var r=this._getVariantModel(n);var s=e.getDesignTimeMetadata();var g=this.getCommandFactory().getFlexSettings();return r.manageVariants(n,i,g.layer,a.getRtaStyleClassName(),u.createComponent(g)).then(function(t){if(t.length>0){return this.getCommandFactory().getCommandFor(n,"configure",{control:n,changes:t},s,i)}return undefined}.bind(this)).then(function(t){if(t){this.fireElementModified({command:t})}}.bind(this)).catch(function(t){throw o.createError("ControlVariant#configureVariants",t,"sap.ui.rta")})};p.prototype.getMenuItems=function(t){var e=t[0];var a=[];if(this.isRenameAvailable(e)){a.push({id:"CTX_VARIANT_SET_TITLE",text:sap.ui.getCore().getLibraryResourceBundle("sap.ui.rta").getText("CTX_RENAME"),handler:this.renameVariant.bind(this),enabled:this.isRenameEnabled.bind(this),rank:210,icon:"sap-icon://edit"})}if(this.isVariantSaveAvailable(e)){a.push({id:"CTX_VARIANT_SAVE",text:sap.ui.getCore().getLibraryResourceBundle("sap.ui.rta").getText("CTX_VARIANT_SAVE"),handler:this.createSaveCommand.bind(this),enabled:this.isVariantSaveEnabled.bind(this),rank:220,icon:"sap-icon://save"})}if(this.isVariantSaveAsAvailable(e)){a.push({id:"CTX_VARIANT_SAVEAS",text:sap.ui.getCore().getLibraryResourceBundle("sap.ui.rta").getText("CTX_VARIANT_SAVEAS"),handler:this.createSaveAsCommand.bind(this),enabled:this.isVariantSaveAsEnabled.bind(this),rank:225,icon:"sap-icon://duplicate"})}if(this.isVariantConfigureAvailable(e)){a.push({id:"CTX_VARIANT_MANAGE",text:sap.ui.getCore().getLibraryResourceBundle("sap.ui.rta").getText("CTX_VARIANT_MANAGE"),handler:this.configureVariants.bind(this),enabled:this.isVariantConfigureEnabled.bind(this),startSection:true,rank:230,icon:"sap-icon://action-settings"})}if(this.isVariantSwitchAvailable(e)){var n=this._getVariantModel(e.getElement());var i=e.getVariantManagement();var r=n.getData()[i].variants.reduce(function(t,e){if(e.visible){var a=n.getData()[i].currentVariant===e.key;var r={id:e.key,text:e.title,icon:a?"sap-icon://accept":"blank",enabled:!a};return t.concat(r)}return t},[]);a.push({id:"CTX_VARIANT_SWITCH_SUBMENU",text:sap.ui.getCore().getLibraryResourceBundle("sap.ui.rta").getText("CTX_VARIANT_SWITCH"),handler:function(t,e){var a=e.eventItem.getParameters().item.getProperty("key");var r=t[0];var o=n.getData()[i].currentVariant;return this.switchVariant(r,a,o)}.bind(this),enabled:this.isVariantSwitchEnabled.bind(this),submenu:r,rank:240,icon:"sap-icon://switch-views"})}return a};p.prototype.getActionName=function(){return"controlVariant"};return p});
//# sourceMappingURL=ControlVariant.js.map