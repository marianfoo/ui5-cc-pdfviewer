/*!
 * OpenUI5
 * (c) Copyright 2009-2023 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/base/util/includes","sap/base/util/values","sap/base/util/restricted/_omit","sap/base/Log","sap/ui/base/ManagedObject","sap/ui/core/util/reflection/JsControlTreeModifier","sap/ui/dt/ElementUtil","sap/ui/fl/write/api/ChangesWriteAPI","sap/ui/fl/Utils","sap/ui/fl/changeHandler/common/ChangeCategories","sap/ui/rta/util/changeVisualization/ChangeStates"],function(e,t,n,i,o,a,r,s,d,g,u){"use strict";var c=o.extend("sap.ui.rta.util.changeVisualization.ChangeIndicatorRegistry",{metadata:{properties:{changeCategories:{type:"object",defaultValue:[]},rootControlId:{type:"string"}}},constructor:function(){o.prototype.constructor.apply(this,arguments);this._oRegisteredChanges={};this._oChangeIndicators={}}});c.prototype.exit=function(){this.reset()};c.prototype.getAllRegisteredChanges=function(){return t(this._oRegisteredChanges||{}).map(function(e){return Object.assign({},e)})};c.prototype.getRegisteredChangeIds=function(){return Object.keys(this._oRegisteredChanges||{})};c.prototype.getRegisteredChange=function(e){return this._oRegisteredChanges[e]&&Object.assign({},this._oRegisteredChanges[e])};c.prototype.getSelectorsWithRegisteredChanges=function(){var e={};function i(t,i,o,a){if(e[t]===undefined){e[t]=[]}e[t].push(Object.assign({id:o.change.getId(),dependent:a,affectedElementId:i,descriptionPayload:o.visualizationInfo.descriptionPayload||{}},n(o,["visualizationInfo"])))}t(this._oRegisteredChanges).forEach(function(e){e.visualizationInfo.displayElementIds.forEach(function(t,n){i(t,e.visualizationInfo.affectedElementIds[n],e,false)});e.visualizationInfo.dependentElementIds.forEach(function(t){i(t,t,e,true)})});return e};c.prototype.getChangeIndicator=function(e){return this._oChangeIndicators[e]};c.prototype.getChangeIndicators=function(){return t(this._oChangeIndicators||{})};c.prototype.registerChange=function(t,n,i){var o=d.getAppComponentForControl(r.getElementInstance(this.getRootControlId()));return f(t,o).then(function(o){var a=this.getChangeCategories();var r;if(n==="settings"&&e(Object.keys(a),o.descriptionPayload.category)){r=o.descriptionPayload.category}else{r=Object.keys(a).find(function(t){return e(a[t],n)});if(!r){r=g.OTHER}}var s;var d=[];if(i){d=i.getData().draftFilenames}if(t.getState()==="NEW"){s=[u.DIRTY,u.DRAFT]}else if(d&&d.includes(t.getFileName())){s=[u.DRAFT]}else{s=[u.ACTIVATED]}this._oRegisteredChanges[t.getId()]={change:t,commandName:n,changeCategory:r,changeStates:s,visualizationInfo:o}}.bind(this))};function f(e,t){function n(e){if(!e){return undefined}return e.map(function(e){var n=typeof e.getId==="function"?e:a.bySelector(e,t);return n&&n.getId()}).filter(Boolean)}return h(t,e).then(function(t){var i=t||{};var o=n(i.affectedControls||[e.getSelector()]);return{affectedElementIds:o,dependentElementIds:n(i.dependentControls)||[],displayElementIds:n(i.displayControls)||o,updateRequired:i.updateRequired,descriptionPayload:i.descriptionPayload||{}}})}function h(e,t){var n=a.bySelector(t.getSelector(),e);if(n){return s.getChangeHandler({changeType:t.getChangeType(),element:n,modifier:a,layer:t.getLayer()}).then(function(n){if(n&&typeof n.getChangeVisualizationInfo==="function"){return n.getChangeVisualizationInfo(t,e)}return undefined}).catch(function(e){i.error(e);return undefined})}return Promise.resolve()}c.prototype.registerChangeIndicator=function(e,t){this._oChangeIndicators[e]=t};c.prototype.reset=function(){Object.keys(this._oRegisteredChanges).forEach(function(e){this.removeRegisteredChange(e)}.bind(this));t(this._oChangeIndicators).forEach(function(e){e.destroy()});this._oChangeIndicators={}};c.prototype.removeRegisteredChange=function(e){delete this._oRegisteredChanges[e]};c.prototype.removeOutdatedRegisteredChanges=function(){this.getAllRegisteredChanges().forEach(function(e){if(e.visualizationInfo&&e.visualizationInfo.updateRequired){this.removeRegisteredChange(e.change.getId())}}.bind(this))};return c});
//# sourceMappingURL=ChangeIndicatorRegistry.js.map