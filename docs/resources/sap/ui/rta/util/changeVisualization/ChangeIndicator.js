/*!
 * OpenUI5
 * (c) Copyright 2009-2023 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/core/Fragment","sap/ui/model/json/JSONModel","sap/ui/core/Control","sap/ui/core/format/DateFormat","sap/ui/events/KeyCodes","sap/ui/rta/util/changeVisualization/commands/getCommandVisualization","sap/ui/fl/Utils","sap/ui/fl/util/resolveBinding","sap/ui/rta/util/changeVisualization/ChangeVisualizationUtils","sap/ui/core/Core","sap/ui/rta/util/changeVisualization/ChangeCategories"],function(e,t,i,o,a,r,n,s,l,p,g){"use strict";var h=i.extend("sap.ui.rta.util.changeVisualization.ChangeIndicator",{metadata:{library:"sap.ui.rta",properties:{changes:{type:"array",defaultValue:[]},posX:{type:"int"},posY:{type:"int"},overlayId:{type:"string"},selectorId:{type:"string"}},aggregations:{_popover:{type:"sap.m.Popover",multiple:false,visibility:"hidden"}},events:{selectChange:{parameters:{changeId:{type:"string"}}},keyPress:{parameters:{originalEvent:{type:"object"}}}}},renderer:{apiVersion:2,render:function(e,t){e.openStart("div",t);e.class("sapUiRtaChangeIndicator");e.class("sapUiRtaChangeIndicatorChange");if(t.getChanges().length>4){e.class("sapUiRtaChangeIndicatorColorDark")}else if(t.getChanges().length>1){e.class("sapUiRtaChangeIndicatorColorMedium")}else{e.class("sapUiRtaChangeIndicatorColorLight")}e.openEnd();e.close("div")}},constructor:function(){this._oDetailModel=new t;this._oDetailModel.setDefaultBindingMode("OneWay");i.prototype.constructor.apply(this,arguments);this._fnHoverTrue=this._toggleHoverStyleClasses.bind(this,true);this._fnHoverFalse=this._toggleHoverStyleClasses.bind(this,false);this._bEventAttachedToElement=false}});function c(e,t){e[t]("click",this._onSelect,this);e[t]("tap",this._onSelect,this);e[t]("keydown",this._onKeyDown,this);e[t]("mouseout",this._fnHoverFalse);e[t]("focusout",this._fnHoverFalse);e[t]("mouseover",this._fnHoverTrue);e[t]("focusin",this._fnHoverTrue)}function d(e){var t=e.getDomRef();var i=p.byId(e.getOverlayId()).getDomRef().offsetHeight;var o=t.offsetHeight;if(i<o*5){e.addStyleClass("sapUiRtaChangeIndicatorVerticallyCentered")}}function u(e,t,i){var o=p.byId(e.affectedElementId);var a=Object.keys(e.descriptionPayload||{}).reduce(function(t,i){var a=e.descriptionPayload[i];var r=n.isBinding(a);var l=r?s(a,o):a;t[i]=l;return t},{});var g={appComponent:n.getAppComponentForControl(o)};var h=p.byId(i);var c=h.getDesignTimeMetadata().getLabel(o);var d=r(e);var u=d&&d.getDescription(a,c,g)||{};var v=e.commandName;var f;var y;if(v==="settings"&&a.description){u.descriptionText=a.description;u.descriptionTooltip=a.descriptionTooltip}else if(e.changeCategory==="other"){v="other"}if(u.descriptionText){f=u.descriptionText;y=u.descriptionTooltip||""}else{c=c&&"'"+c+"'";var C=l.shortenString(c);var _="TXT_CHANGEVISUALIZATION_CHANGE_"+v.toUpperCase();f=t.getText(_,C);y=t.getText(_,c)}y=f.length<y.length?y:null;var m=u&&u.buttonText;var I=t.getText("TXT_CHANGEVISUALIZATION_OVERVIEW_"+e.changeCategory.toUpperCase());return{description:f,tooltip:y,buttonText:m,iconTooltip:I}}function v(e,t){var i=e.change.getCreation();var a=new Date(i);var r=t.getText("TXT_CHANGEVISUALIZATION_CREATED_IN_SESSION_DATE");return{fullDate:i?o.getDateTimeInstance().format(a):r,relativeDate:i?o.getDateTimeInstance({relative:"true"}).format(a):r}}function f(e,t){var i=p.getLibraryResourceBundle("sap.ui.rta");var o=u(t,i,e);var a=v(t,i);return{id:t.id,change:t,description:o.description,descriptionTooltip:o.tooltip,fullDate:a.fullDate,relativeDate:a.relativeDate,detailButtonText:o.buttonText,icon:g.getIconForCategory(t.changeCategory),iconTooltip:o.iconTooltip}}h.prototype.init=function(){this._iOldTabIndex=0;c.call(this,this,"attachBrowserEvent")};h.prototype.setVisible=function(e){i.prototype.setVisible.apply(this,arguments);var t=p.byId(this.getOverlayId());if(t){if(e&&!this._bEventAttachedToElement){c.call(this,t,"attachBrowserEvent");this._bEventAttachedToElement=true}if(!e){c.call(this,t,"detachBrowserEvent");this._bEventAttachedToElement=false;if(this.getAggregation("_popover")){this.getAggregation("_popover").destroy()}}}return this};h.prototype.focus=function(){if(this.getDomRef()){i.prototype.focus.apply(this,arguments);this._bScheduledForFocus=false;return}this._bScheduledForFocus=true};h.prototype.setOverlayId=function(e){var t=this.getDomRef();if(t){t.parentNode.removeChild(t)}this.placeAt(p.getStaticAreaRef());this.setProperty("overlayId",e);return this};h.prototype.onAfterRendering=function(){var e=p.getElementById(this.getOverlayId());if(e){e.getDomRef().appendChild(this.getDomRef());d(this)}this.getDomRef().tabIndex=this._iOldTabIndex;if(this._bScheduledForFocus){this.focus();this._toggleHoverStyleClasses(true)}};h.prototype.exit=function(){var e=this.getDomRef();var t=p.byId(this.getOverlayId());if(e){e.parentNode.removeChild(e)}if(t){if(this.getAggregation("_popover")){this.getAggregation("_popover").destroy()}c.call(this,t,"detachBrowserEvent")}c.call(this,this,"detachBrowserEvent")};h.prototype.setChanges=function(e){this.setProperty("changes",e);this._oDetailModel.setData((e||[]).reverse().map(f.bind(this,this.getOverlayId())))};h.prototype._onSelect=function(e){this.focus();e.stopPropagation();this._openDetailPopover()};h.prototype._onKeyDown=function(e){if(e.keyCode===a.ENTER){this._onSelect(e)}this.fireKeyPress({originalEvent:e})};h.prototype._toggleHoverStyleClasses=function(e,t){if(t){t.stopPropagation();t.preventDefault()}var i=p.byId(this.getOverlayId());if(i.getMetadata().getName()!=="sap.ui.dt.ElementOverlay"){return}var o=e?"addStyleClass":"removeStyleClass";i[o]("sapUiRtaChangeIndicatorHovered");this[o]("sapUiRtaHover")};h.prototype._openDetailPopover=function(){if(!this.getAggregation("_popover")){this._iOldTabIndex=this.getDomRef().getAttribute("tabindex");e.load({name:"sap.ui.rta.util.changeVisualization.ChangeIndicatorPopover",controller:this}).then(function(e){e._bOpenedByChangeIndicator=true;this.setAggregation("_popover",e);e.setModel(this._oDetailModel,"details");e.openBy(this)}.bind(this))}else{if(this.getAggregation("_popover").isOpen()){return this.getAggregation("_popover").close()}this.getAggregation("_popover").openBy(this)}};h.prototype._showDependentElements=function(e){this.getAggregation("_popover").close();var t=this.getChanges().length>1?e.getSource().getBindingContext("details").getObject().id:this.getChanges()[0].id;this.fireSelectChange({changeId:t})};return h});
//# sourceMappingURL=ChangeIndicator.js.map