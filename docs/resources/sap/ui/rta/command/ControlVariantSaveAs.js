/*!
 * OpenUI5
 * (c) Copyright 2009-2023 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/rta/command/BaseCommand","sap/ui/rta/library","sap/ui/core/util/reflection/JsControlTreeModifier","sap/ui/rta/Utils","sap/ui/fl/Utils","sap/ui/fl/write/api/ContextSharingAPI"],function(e,t,a,n,r,i){"use strict";var o=e.extend("sap.ui.rta.command.ControlVariantSaveAs",{metadata:{library:"sap.ui.rta",properties:{sourceVariantReference:{type:"string"},sourceDefaultVariant:{type:"string"},model:{type:"object"},newVariantParameters:{type:"object"}},associations:{},events:{}}});o.prototype.prepare=function(e){this.oVariantManagementControl=this.getElement();this.oAppComponent=r.getAppComponentForControl(this.oVariantManagementControl);this.sVariantManagementReference=a.getSelector(this.oVariantManagementControl,this.oAppComponent).id;this.oModel=this.getModel();this.setSourceDefaultVariant(this.oModel.getData()[this.sVariantManagementReference].defaultVariant);this.sLayer=e.layer;function t(e,a){var n=e.getParameters();this.setNewVariantParameters(n);this.oVariantManagementControl.detachSave(t,this);this.oVariantManagementControl.detachCancel(o,this);a.resolve(true)}function o(e,a){this.oVariantManagementControl.detachSave(t,this);this.oVariantManagementControl.detachCancel(o,this);a.resolve(false)}return new Promise(function(a){this.oVariantManagementControl.attachSave({resolve:a},t,this);this.oVariantManagementControl.attachCancel({resolve:a},o,this);this.oVariantManagementControl.openSaveAsDialogForKeyUser(n.getRtaStyleClassName(),i.createComponent(e))}.bind(this)).then(function(e){return e})};o.prototype.getPreparedChange=function(){if(!this._aPreparedChanges){return undefined}return this._aPreparedChanges};o.prototype.execute=function(){var e=this.getSourceVariantReference();this._aControlChanges=this.oModel.getVariant(e,this.sVariantManagementReference).controlChanges;var a=this.getNewVariantParameters();a.layer=this.sLayer;a.newVariantReference=this.sNewVariantReference;a.generator=t.GENERATOR_NAME;return this.oModel._handleSave(this.oVariantManagementControl,a).then(function(e){this._aPreparedChanges=e;this._oVariantChange=e[0];this.sNewVariantReference=this._oVariantChange.getId();this._aPreparedChanges.forEach(function(e){if(e.getFileType()==="change"){e.assignedToVariant=true}});this.getModel().checkDirtyStateForControlModels([this.sVariantManagementReference])}.bind(this))};o.prototype.undo=function(){if(this._oVariantChange){this._aPreparedChanges.forEach(function(e){if(e.getFileType()==="ctrl_variant_management_change"){this.oModel.oFlexController.deleteChange(e,this.oAppComponent)}}.bind(this));var e={variant:this._oVariantChange,sourceVariantReference:this.getSourceVariantReference(),variantManagementReference:this.sVariantManagementReference,component:this.oAppComponent};return this.oModel.removeVariant(e,true).then(function(){this._aControlChanges.forEach(function(e){this.oModel.oFlexController.addPreparedChange(e,this.oAppComponent);var t=sap.ui.getCore().byId(a.getControlIdBySelector(e.getSelector(),this.oAppComponent));this.oModel.oFlexController.applyChange(e,t)}.bind(this));this.oModel.getData()[this.sVariantManagementReference].defaultVariant=this.getSourceDefaultVariant();this.oModel.getData()[this.sVariantManagementReference].originalDefaultVariant=this.getSourceDefaultVariant();this._aPreparedChanges=null;this._oVariantChange=null;this.getModel().checkUpdate(true)}.bind(this))}return Promise.resolve()};return o});
//# sourceMappingURL=ControlVariantSaveAs.js.map