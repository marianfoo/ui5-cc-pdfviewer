/*!
 * OpenUI5
 * (c) Copyright 2009-2023 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/base/ManagedObject","sap/ui/rta/command/FlexCommand","sap/ui/rta/command/AppDescriptorCommand","sap/ui/fl/Utils","sap/ui/fl/Change","sap/ui/dt/ElementUtil","sap/base/Log","sap/ui/fl/write/api/PersistenceWriteAPI"],function(e,t,n,a,o,r,i,s){"use strict";var d=e.extend("sap.ui.rta.command.LREPSerializer",{metadata:{library:"sap.ui.rta",associations:{rootControl:{type:"sap.ui.core.Control"}},properties:{commandStack:{type:"object"}},aggregations:{}}});function m(e){return r.getElementInstance(e)}d.prototype._lastPromise=Promise.resolve();d.prototype.setCommandStack=function(e){if(this.getCommandStack()){this.getCommandStack().removeCommandExecutionHandler(this._fnHandleCommandExecuted)}this.setProperty("commandStack",e);e.addCommandExecutionHandler(this._fnHandleCommandExecuted)};d.prototype.init=function(){this._fnHandleCommandExecuted=this.handleCommandExecuted.bind(this)};d.prototype.exit=function(){this.getCommandStack().removeCommandExecutionHandler(this._fnHandleCommandExecuted)};d.prototype._isPersistedChange=function(e){return!!this.getCommandStack()._aPersistedChanges&&this.getCommandStack()._aPersistedChanges.indexOf(e.getId())!==-1};d.prototype.handleCommandExecuted=function(e){return function(e){var a=e;this._lastPromise=this._lastPromise.catch(function(){}).then(function(){var e=this.getCommandStack().getSubCommands(a.command);if(a.undo){var r=[];e.forEach(function(e){if(!(e instanceof t||e instanceof n)||e.getRuntimeOnly()){return}var a=e.getPreparedChange();var o=e.getAppComponent();if(o){r.push(s.remove({change:a,selector:o}))}});return Promise.all(r)}var i=[];e.forEach(function(e){if(e.getRuntimeOnly()){return}if(e instanceof t){var a=e.getAppComponent();if(a){var r=e.getPreparedChange();if(r.getState()===o.states.DELETED){r.setState(o.states.NEW)}if(!this._isPersistedChange(r)){s.add({change:e.getPreparedChange(),selector:a})}}}else if(e instanceof n){i.push(e.createAndStoreChange())}}.bind(this));return Promise.all(i)}.bind(this));return this._lastPromise}.bind(this)(e)};d.prototype.needsReload=function(){this._lastPromise=this._lastPromise.catch(function(){}).then(function(){var e=this.getCommandStack().getAllExecutedCommands();return e.some(function(e){return!!e.needsReload})}.bind(this));return this._lastPromise};d.prototype.saveCommands=function(e){this._lastPromise=this._lastPromise.catch(function(e){i.error(e)}).then(function(){var t=m(this.getRootControl());if(!t){throw new Error("Can't save commands without root control instance!")}return s.save({selector:t,skipUpdateCache:false,draft:!!e.saveAsDraft,layer:e.layer,removeOtherLayerChanges:!!e.removeOtherLayerChanges,version:e.version,condenseAnyLayer:e.condenseAnyLayer})}.bind(this)).then(function(){i.info("UI adaptation successfully transfered changes to layered repository");this.getCommandStack().removeAllCommands()}.bind(this));return this._lastPromise};d.prototype._triggerUndoChanges=function(){var e=this.getCommandStack();var t=[];var n=e.getAllExecutedCommands();n.forEach(function(e){t.push(e.undo.bind(e))});t=t.reverse();return a.execPromiseQueueSequentially(t,false,true)};d.prototype.clearCommandStack=function(){var e=this.getCommandStack();e.detachCommandExecuted(this.handleCommandExecuted.bind(this));return this._triggerUndoChanges().then(function(){e.removeAllCommands();e.attachCommandExecuted(this.handleCommandExecuted.bind(this));return true}.bind(this))};return d});
//# sourceMappingURL=LREPSerializer.js.map