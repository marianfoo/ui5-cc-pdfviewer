/*!
 * OpenUI5
 * (c) Copyright 2009-2023 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/rta/command/BaseCommand","sap/ui/rta/library","sap/ui/core/util/reflection/JsControlTreeModifier","sap/ui/fl/Utils","sap/base/Log","sap/base/util/merge","sap/ui/fl/write/api/ChangesWriteAPI","sap/base/util/values"],function(e,t,n,r,o,a,i,p){"use strict";var s=e.extend("sap.ui.rta.command.FlexCommand",{metadata:{library:"sap.ui.rta",properties:{changeType:{type:"string"},jsOnly:{type:"boolean",defaultValue:false},selector:{type:"object"},variantIndependent:{type:"boolean",defaultValue:false}},associations:{},events:{}}});s.prototype.getElementId=function(){var e=this.getElement();return e?e.getId():this.getSelector().id};s.prototype.getAppComponent=function(){var e=this.getElement();return e?r.getAppComponentForControl(e):this.getSelector().appComponent};s.prototype.prepare=function(e,t,n){var a;if(!this.getSelector()&&e&&e.templateSelector){a={id:e.templateSelector,appComponent:this.getAppComponent(),controlType:r.getControlType(sap.ui.getCore().byId(e.templateSelector))};this.setSelector(a)}else if(!this.getSelector()&&this.getElement()){a={id:this.getElement().getId(),appComponent:this.getAppComponent(),controlType:r.getControlType(this.getElement())};this.setSelector(a)}return this._createChange(e,t,n).then(function(e){this._oPreparedChange=e;return true}.bind(this)).catch(function(e){o.error(e.message||e.name);return false})};s.prototype.getPreparedChange=function(){return this._oPreparedChange};s.prototype.execute=function(){var e=this.getPreparedChange();return this._applyChange(e)};s.prototype._getChangeSpecificData=function(){var e=this.getMetadata().getProperties();var t={changeType:this.getChangeType()};p(e).filter(function(e){return e.group==="content"}).forEach(function(e){t[e.name]=e.get(this)},this);return t};s.prototype._createChange=function(e,t,n){return this._createChangeFromData(this._getChangeSpecificData(),e,t,n)};s.prototype._createChangeFromData=function(e,o,p,s){if(o){e=a({},e,o)}e.jsOnly=this.getJsOnly();var g=this.getAppComponent().getModel(r.VARIANT_MODEL_NAME);var c;if(g&&p){c=g.getCurrentVariantReference(p)}if(c&&!this.getVariantIndependent()){var l={variantManagementReference:p,variantReference:c};e=Object.assign({},e,l)}e.command=s;e.generator=o.generator||t.GENERATOR_NAME;return i.create({changeSpecificData:e,selector:this._validateControlForChange(o)}).then(function(e){if(o&&o.originalSelector){e.addDependentControl(o.originalSelector,"originalSelector",{modifier:n,appComponent:this.getAppComponent()});e.setSelector(Object.assign(e.getSelector(),n.getSelector(this.getSelector().id,this.getAppComponent())));e.setContent(Object.assign({},e.getContent(),o.content))}return e}.bind(this))};s.prototype.undo=function(){var e=this.getElement()||n.bySelector(this.getSelector());var t=this.getPreparedChange();return i.revert({change:t,element:e})};s.prototype._applyChange=function(e){var t=e.change||e;var o=this.getAppComponent();var a=n.bySelector(t.getSelector(),o);var p={modifier:n,appComponent:o,view:r.getViewForControl(a)};return i.apply(Object.assign({change:t,element:a},p)).then(function(e){if(!e.success){return Promise.reject(e.error)}return undefined})};s.prototype._validateControlForChange=function(e){if(e&&e.originalSelector&&e.content&&e.content.boundAggregation){return{id:e.originalSelector,appComponent:this.getAppComponent(),controlType:r.getControlType(sap.ui.getCore().byId(e.originalSelector))}}return this.getElement()||this.getSelector()};return s});
//# sourceMappingURL=FlexCommand.js.map