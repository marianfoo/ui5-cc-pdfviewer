/*!
 * OpenUI5
 * (c) Copyright 2009-2023 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/base/ManagedObject","sap/ui/core/postmessage/Bus","sap/base/util/uid","sap/base/util/merge","sap/ui/rta/util/ServiceEventBus","sap/ui/thirdparty/URI"],function(e,t,s,i,r,n){"use strict";var a="sap.ui.rta.service.receiver";var o="pending";var u="accepted";var h="declined";var c=e.extend("sap.ui.rta.Client",{metadata:{library:"sap.ui.rta",properties:{window:"object",origin:"string"}},_bInit:false,constructor:function(){e.apply(this,arguments);if(!this.getWindow()){throw new TypeError("sap.ui.rta.Client: window parameter is required")}if(!this.getOrigin()){throw new TypeError("sap.ui.rta.Client: origin parameter is required")}this._oPostMessageBus=t.getInstance();this._sStatus=o;this._mPendingRequests={};this._aRequestQueue=[];this._oServiceEventBus=null;this._mEventHandlerIds={};this._oPostMessageBus.subscribeOnce(a,t.event.READY,function(e){if(!this._isValidMessage(e)){return}this._oPostMessageBus.subscribeOnce(a,t.event.ACCEPTED,function(e){if(!this._isValidMessage(e)){return}this._sStatus=u;var t=this._aRequestQueue.slice();this._aRequestQueue=[];t.forEach(this._sendRequest,this);this._oPostMessageBus.subscribe(a,"getService",this._receiverMethods,this);this._oPostMessageBus.subscribe(a,"callMethod",this._receiverMethods,this);this._oPostMessageBus.subscribe(a,"subscribe",this._receiverMethods,this);this._oPostMessageBus.subscribe(a,"unsubscribe",this._receiverMethods,this);this._oPostMessageBus.subscribe(a,"event",this._receiverEvents,this)},this);this._oPostMessageBus.subscribeOnce(a,t.event.DECLINED,function(e){if(!this._isValidMessage(e)){return}this._sStatus=h;var t=this._aRequestQueue.slice();this._aRequestQueue=[];t.forEach(function(e){e.reject(new Error("sap.ui.rta.Client.getService(): connection to RuntimeAuthoring instance has been refused"))})},this);this._oPostMessageBus.publish({target:this.getWindow(),origin:this.getOrigin(),channelId:a,eventId:t.event.CONNECT,data:sap.ui.getCore().getLibraryResourceBundle("sap.ui.rta").getText("SERVICE_NAME")})},this);this._bInit=true}});c.prototype.destroy=function(){this._oPostMessageBus.unsubscribe(a,"getService",this._receiverMethods,this);this._oPostMessageBus.unsubscribe(a,"callMethod",this._receiverMethods,this);this._oPostMessageBus.unsubscribe(a,"subscribe",this._receiverMethods,this);this._oPostMessageBus.unsubscribe(a,"unsubscribe",this._receiverMethods,this);this._oPostMessageBus.unsubscribe(a,"event",this._receiverEvents,this);e.prototype.destroy.apply(this,arguments)};c.prototype.getService=function(e){if(typeof e!=="string"){throw new TypeError("sap.ui.rta.Client.getService(): invalid service name specified")}return this._sendRequest(this._createRequest({target:this.getWindow(),origin:this.getOrigin(),channelId:a,eventId:"getService",data:{arguments:[e]}}))};c.prototype._createRequest=function(e){var t=s();var i={id:t,request:{target:e.target,origin:e.origin,channelId:a,eventId:e.eventId,data:{id:t,type:"request",body:e.data}}};i.promise=new Promise(function(e,t){i.resolve=e;i.reject=t});return i};c.prototype._sendRequest=function(e){switch(this._sStatus){case u:this._mPendingRequests[e.id]=e;this._oPostMessageBus.publish(e.request);break;case o:this._aRequestQueue.push(e);break;case h:e.reject(new Error("sap.ui.rta.Client.getService(): connection to RuntimeAuthoring instance has been refused"));break}return e.promise};c.prototype._isValidMessage=function(e){return this.getWindow()===e.source&&this.getOrigin()===e.origin};c.prototype._receiverMethods=function(e){if(!this._isValidMessage(e)){return}var t=e.data;if(t.type!=="response"){return}var s=this._mPendingRequests[t.id];switch(e.eventId){case"getService":var n=s.request.data.body.arguments[0];var o=t.body.methods||[];var u=t.body.events;var h=i(o.reduce(function(t,s){t[s]=function(){return this._sendRequest(this._createRequest({target:e.source,origin:e.origin,channelId:a,eventId:"callMethod",data:{service:n,method:s,arguments:Array.prototype.slice.call(arguments)}}))}.bind(this);return t}.bind(this),{}),t.body.properties);if(Array.isArray(u)&&u.length>0){if(!this._oServiceEventBus){this._oServiceEventBus=new r}i(h,{attachEvent:function(t,s,i){if(typeof t!=="string"||!t){throw new TypeError("sap.ui.rta.Client: sEventName must be a non-empty string when calling attachEvent() for a service")}if(typeof s!=="function"){throw new TypeError("sap.ui.rta.Client: fnFunction must be a function when calling attachEvent() for a service")}var r=this._oServiceEventBus.getChannel(n);var o=!r||!r.hasListeners(t);this._oServiceEventBus.subscribe(n,t,s,i);if(o){this._sendRequest(this._createRequest({target:e.source,origin:e.origin,channelId:a,eventId:"subscribe",data:{service:n,event:t}})).then(function(e){this._mEventHandlerIds[n+","+t]=e.id;this._checkIfEventAlive(n,t)}.bind(this))}}.bind(this),detachEvent:function(e,t,s){if(typeof e!=="string"||!e){throw new TypeError("sap.ui.rta.Client: sEventName must be a non-empty string when calling detachEvent() for a service")}if(typeof t!=="function"){throw new TypeError("sap.ui.rta.Client: fnFunction must be a function when calling detachEvent() for a service")}this._oServiceEventBus.unsubscribe(n,e,t,s);this._checkIfEventAlive(n,e)}.bind(this),attachEventOnce:function(e,t,s){function i(){h.detachEvent(e,i);t.apply(s,arguments)}h.attachEvent(e,i)}})}s.resolve(h);delete this._mPendingRequests[t.id];break;case"callMethod":if(t.status==="success"){s.resolve(t.body)}else{s.reject(t.body)}delete this._mPendingRequests[t.id];break;case"subscribe":case"unsubscribe":s.resolve(t.body);delete this._mPendingRequests[t.id];break}};c.prototype._checkIfEventAlive=function(e,t){var s=this._oServiceEventBus.getChannel(e);var i=this._mEventHandlerIds[e+","+t];if((!s||!s.hasListeners(t))&&i){this._sendRequest(this._createRequest({target:this.getWindow(),origin:this.getOrigin(),channelId:a,eventId:"unsubscribe",data:{service:e,event:t,id:i}}))}};c.prototype._receiverEvents=function(e){if(!this._isValidMessage(e)){return}var t=e.data.body;this._oServiceEventBus.publish(t.service,t.event,t.data)};c.prototype.setWindow=function(e){if(this._bInit){throw new TypeError("sap.ui.rta.Client: Window parameter cannot be changed at runtime; recreate instance of the Client.")}if(!e){throw new TypeError("sap.ui.rta.Client: Window parameter is required")}if(e===window){throw new TypeError("sap.ui.rta.Client: Window object has to be different from the one where Client is running")}this.setProperty("window",e);return this};c.prototype.setOrigin=function(e){if(this._bInit){throw new TypeError("sap.ui.rta.Client: Cannot change origin parameter at runtime; recreate instance of the Client.")}if(!e){throw new TypeError("sap.ui.rta.Client: Origin parameter is required")}if(typeof e!=="string"){throw new TypeError("sap.ui.rta.Client: Origin parameter has to be a string")}if(new n(e).origin()!==e){throw new TypeError("sap.ui.rta.Client: Origin string is invalid")}this.setProperty("origin",e);return this};return c});
//# sourceMappingURL=Client.js.map