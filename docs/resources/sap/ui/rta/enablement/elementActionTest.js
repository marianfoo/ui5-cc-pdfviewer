/*!
 * OpenUI5
 * (c) Copyright 2009-2023 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/core/UIComponent","sap/ui/core/ComponentContainer","sap/ui/core/mvc/XMLView","sap/ui/rta/command/CommandFactory","sap/ui/rta/util/changeVisualization/ChangeVisualization","sap/ui/dt/DesignTime","sap/ui/dt/DesignTimeStatus","sap/ui/dt/OverlayRegistry","sap/ui/fl/ChangePersistence","sap/ui/model/Model","sap/ui/fl/registry/Settings","sap/ui/fl/write/api/PersistenceWriteAPI","sap/ui/fl/Cache","sap/ui/fl/Layer","sap/ui/thirdparty/sinon-4","sap/ui/fl/library"],function(e,t,n,i,o,a,r,s,h,c,u,d,l,m,f){"use strict";function g(p,C){if(g._only&&p.indexOf(g._only)<0){return}if(typeof C.xmlView==="string"){C.xmlView={viewContent:C.xmlView}}var v=f.createSandbox();C.before=C.before||function(){};C.after=C.after||function(){};QUnit.module(p,function(){QUnit.test("When using the 'elementActionTest' function to test if your control is ready for UI adaptation at runtime",function(e){e.ok(C.afterAction,"then you implement a function to check if your action has been successful: See the afterAction parameter.");e.ok(C.afterUndo,"then you implement a function to check if the undo has been successful: See the afterUndo parameter.");e.ok(C.afterRedo,"then you implement a function to check if the redo has been successful: See the afterRedo parameter.");e.ok(C.xmlView,"then you provide an XML view to test on: See the.xmlView parameter.");var t=(new DOMParser).parseFromString(C.xmlView.viewContent,"application/xml").documentElement;e.ok(t.tagName.match("View$"),"then you use the sap.ui.core.mvc View tag as the first tag in your view");e.ok(C.action,"then you provide an action: See the action parameter.");e.ok(C.action.name,"then you provide an action name: See the action.name parameter.");e.ok(C.action.controlId||C.action.control,"then you provide the control or control's id to operate the action on: See the action.controlId.")})});var y="sap.ui.rta.control.enabling.comp";var b=false;var w=true;var V=e.extend(y,{metadata:{interfaces:["sap.ui.core.IAsyncContentCreation"],manifest:{"sap.app":{id:y,type:"application"}}},createContent:function(){var e=Object.assign({},C.xmlView);e.id=this.createId("view");if(e.async===undefined){e.async=this.getComponentData().async}e.definition=e.viewContent;this.oViewPromise=n.create(e);return this.oViewPromise}});function P(e){this.oUiComponent=new V({id:"comp",componentData:{async:e}});return this.oUiComponent.oViewPromise.then(function(){this.oUiComponentContainer=new t({component:this.oUiComponent,height:"100%"});this.oUiComponentContainer.placeAt(C.placeAt||"qunit-fixture");this.oView=this.oUiComponent.getRootControl();if(C.model instanceof c){this.oView.setModel(C.model)}sap.ui.getCore().applyChanges();return C.model&&C.model.getMetaModel()&&C.model.getMetaModel().loaded()}.bind(this))}function U(e){var t=[].concat(C.previousActions||[],C.action);var n=[];return t.reduce(function(t,i){return t.then(I.bind(this,e,i)).then(function(e){n.push(e);return e.execute()})}.bind(this),Promise.resolve()).then(function(){return n})}function I(e,t){return Promise.resolve().then(function(){var n;var o;var r;if(typeof t.control==="function"){n=t.control(this.oView)}else{n=this.oView.byId(t.controlId)}var h=t.name;return n.getMetadata().loadDesignTime(n).then(function(){if(t.parameter){if(typeof t.parameter==="function"){o=t.parameter(this.oView)}else{o=t.parameter}}else{o={}}sap.ui.getCore().applyChanges();this.oDesignTime=new a({rootElements:[this.oView]});return new Promise(function(i){this.oDesignTime.attachEventOnce("synced",function(){var a=s.getOverlay(n);r=a.getDesignTimeMetadata();var c=r.getAction("getResponsibleElement",n);var u;if(t.name==="move"){var d=s.getOverlay(o.movedElements[0].element||o.movedElements[0].id);var l=d.getRelevantContainer();n=l;r=d.getParentAggregationOverlay().getDesignTimeMetadata()}else if(t.name==="addODataProperty"){e.ok(false,"addODataProperty action is deprecated. Use addViaDelegate action instead.")}else if(Array.isArray(t.name)){var m=r.getActionDataFromAggregations(t.name[0],n,undefined,t.name[1]);e.equal(m.length,1,"there should be only one aggregation with the possibility to do an add "+t.name[1]+" action");u=a.getAggregationOverlay(m[0].aggregation);r=u.getDesignTimeMetadata();h="addDelegateProperty"}else if(c){if(t.name==="reveal"){n=t.revealedElement(this.oView);a=s.getOverlay(t.revealedElement(this.oView));r=a.getDesignTimeMetadata()}else{n=c;a=s.getOverlay(n);r=a.getDesignTimeMetadata();i(n.getMetadata().loadDesignTime(n))}}i()}.bind(this))}.bind(this))}.bind(this)).then(function(){var e=new i({flexSettings:{layer:C.layer||m.CUSTOMER}});return e.getCommandFor(n,h,o,r)}).then(function(t){e.ok(t,"then the registration for action to change type, the registration for change and control type to change handler is available and "+C.action.name+" is a valid action");return t})}.bind(this)).catch(function(e){throw new Error(e)})}function x(e){return e.reduce(function(e,t){return e.then(t.execute.bind(t))},Promise.resolve())}function E(e){var t=e.slice().reverse();return t.reduce(function(e,t){return e.then(t.undo.bind(t))},Promise.resolve())}function A(e){e.forEach(function(e){e.destroy()})}function D(e,t,n){var i={remainingCommands:[],deletedCommands:[]};if(t.length===1){i.remainingCommands.push(t[0]);return Promise.resolve(i)}var o=t.map(function(e){return e.getPreparedChange()});return d._condense({selector:e,changes:o}).then(function(e){if(C.changesAfterCondensing!==undefined){n.equal(e.length,C.changesAfterCondensing,"after condensing the amount of changes is correct")}var o=e.map(function(e){return e.getId()});t.forEach(function(e){if(o.indexOf(e.getPreparedChange().getId())>-1){i.remainingCommands.push(e)}else{i.deletedCommands.push(e)}});return i})}function k(e,t,n){if(!C.changeVisualization){return Promise.resolve()}var i=new o({rootControlId:e.getId(),isActive:true});v.stub(i,"_updateChangeIndicators");var a=t.map(function(e){return e.getPreparedChange()});v.stub(i,"_collectChanges").resolves(a);return i._updateChangeRegistry().then(function(){return i._selectChangeCategory("all")}).then(function(){var t=i._oChangeIndicatorRegistry;var o=t.getSelectorsWithRegisteredChanges();var a=C.changeVisualization.displayElementId;var r=a?e.createId(a):e.getId();n.ok(o[r]&&o[r].length,"there is a change indicator at the correct element");var s=t.getAllRegisteredChanges()[0];var h=C.changeVisualization.info;function c(t){return t.map(function(t){return e.createId(t)})}if(h.affectedControls){var u=c(h.affectedControls);n.deepEqual(u,s.visualizationInfo.affectedElementIds,"then the affected control ids are correct")}if(h.dependentControls){var d=c(h.dependentControls);n.deepEqual(d,s.visualizationInfo.dependentElementIds,"then the dependent control ids are correct")}if(h.displayControls){var l=c(h.displayControls);n.deepEqual(l,s.visualizationInfo.displayElementIds,"then the display control ids are correct")}if(h.descriptionPayload){n.deepEqual(h.descriptionPayload,s.visualizationInfo.descriptionPayload,"then the descriptionPayload is correct")}})}function M(e){var t=[];e.forEach(function(e){var n=e.getPreparedChange();if(e.getAppComponent){t.push(d.remove({change:n,selector:e.getAppComponent()}))}});return Promise.all(t)}function S(e){var t=[];v.stub(h.prototype,"getChangesForComponent").resolves(t);v.stub(h.prototype,"getCacheKey").resolves("etag-123");return P.call(this,b).then(T.bind(this,e,t))}function T(e,t){var n=[].concat(C.previousActions||[],C.action);var i=[];return n.reduce(function(n,o){return n.then(I.bind(this,e,o)).then(function(e){i.push(e);t.push(e.getPreparedChange());this.oUiComponentContainer.destroy();return P.call(this,w)}.bind(this))}.bind(this),Promise.resolve()).then(function(){this.aCommands=i}.bind(this))}if(!C.jsOnly){QUnit.module(p+" on async views",{before:function(e){this.hookContext={};return C.before.call(this.hookContext,e)},after:function(e){return C.after.call(this.hookContext,e)},beforeEach:function(){v.stub(u,"getInstance").resolves({_oSettings:{}})},afterEach:function(){this.oUiComponentContainer.destroy();this.oDesignTime.destroy();A(this.aCommands);v.restore()}},function(){QUnit.test("When applying the change directly on the XMLView",function(e){return S.call(this,e).then(function(){return k(this.oView,this.aCommands,e)}.bind(this)).then(function(){return C.afterAction(this.oUiComponent,this.oView,e)}.bind(this))});QUnit.test("When executing on XML and reverting the change in JS (e.g. variant switch)",function(e){return S.call(this,e).then(function(){return E(this.aCommands)}.bind(this)).then(function(){return M(this.aCommands)}.bind(this)).then(function(){sap.ui.getCore().applyChanges();C.afterUndo(this.oUiComponent,this.oView,e)}.bind(this))});QUnit.test("When executing on XML, reverting the change in JS (e.g. variant switch) and applying again",function(e){return S.call(this,e).then(function(){return D(this.oView,this.aCommands,e)}.bind(this)).then(function(e){this.aRemainingCommands=e.remainingCommands;return E(this.aCommands)}.bind(this)).then(function(){return M(this.aCommands)}.bind(this)).then(function(){return x(this.aRemainingCommands)}.bind(this)).then(function(){sap.ui.getCore().applyChanges();C.afterRedo(this.oUiComponent,this.oView,e)}.bind(this))})})}function O(e){if(e.getStatus()!==r.SYNCED){return new Promise(function(t){e.attachEventOnce("synced",t)})}return Promise.resolve()}QUnit.module(p,{before:function(e){this.hookContext={};return C.before.call(this.hookContext,e)},after:function(e){return C.after.call(this.hookContext,e)},beforeEach:function(e){v.stub(h.prototype,"getChangesForComponent").returns(Promise.resolve([]));v.stub(h.prototype,"getCacheKey").returns(l.NOTAG);v.stub(u,"getInstance").returns(Promise.resolve({_oSettings:{}}));return P.call(this,b).then(U.bind(this,e)).then(function(e){this.aCommands=e}.bind(this))},afterEach:function(){this.oDesignTime.destroy();this.oUiComponentContainer.destroy();A(this.aCommands);v.restore()}},function(){QUnit.test("When executing the underlying command on the control at runtime",function(e){return O(this.oDesignTime).then(function(){return k(this.oView,this.aCommands,e)}.bind(this)).then(function(){sap.ui.getCore().applyChanges();return C.afterAction(this.oUiComponent,this.oView,e)}.bind(this))});QUnit.test("When executing and undoing the command",function(e){return O(this.oDesignTime).then(E.bind(null,this.aCommands)).then(M.bind(null,this.aCommands)).then(function(){sap.ui.getCore().applyChanges();return C.afterUndo(this.oUiComponent,this.oView,e)}.bind(this))});QUnit.test("When executing, undoing and redoing the command",function(e){return O(this.oDesignTime).then(D.bind(this,this.oView,this.aCommands,e)).then(function(e){this.aRemainingCommands=e.remainingCommands;return E(this.aCommands)}.bind(this)).then(M.bind(null,this.aCommands)).then(function(){return x(this.aRemainingCommands)}.bind(this)).then(function(){sap.ui.getCore().applyChanges();return C.afterRedo(this.oUiComponent,this.oView,e)}.bind(this))})})}g.skip=function(){};g.only=function(e){g._only=e};return g});
//# sourceMappingURL=elementActionTest.js.map