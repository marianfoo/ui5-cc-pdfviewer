/*!
 * OpenUI5
 * (c) Copyright 2009-2023 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/base/ManagedObject","sap/ui/dt/ElementOverlay","sap/ui/dt/AggregationOverlay","sap/ui/dt/OverlayRegistry","sap/ui/dt/SelectionManager","sap/ui/dt/ElementDesignTimeMetadata","sap/ui/dt/AggregationDesignTimeMetadata","sap/ui/dt/ElementUtil","sap/ui/dt/Overlay","sap/ui/dt/OverlayUtil","sap/ui/dt/MetadataPropagationUtil","sap/ui/dt/Util","sap/ui/dt/TaskManager","sap/ui/dt/TaskRunner","sap/base/Log","sap/base/util/isPlainObject","sap/base/util/merge","sap/ui/dt/SelectionMode","sap/base/util/includes","sap/ui/dt/DesignTimeStatus","sap/base/util/restricted/_curry","sap/base/util/restricted/_difference","sap/base/util/isEmptyObject"],function(e,t,a,r,n,i,s,o,l,g,d,c,h,y,u,p,m,v,f,E,O,_,b){"use strict";var S=e.extend("sap.ui.dt.DesignTime",{metadata:{library:"sap.ui.dt",properties:{designTimeMetadata:{type:"object"},enabled:{type:"boolean",defaultValue:true},scope:{type:"string",defaultValue:"default"}},associations:{rootElements:{type:"sap.ui.core.Element",multiple:true}},aggregations:{plugins:{type:"sap.ui.dt.Plugin",multiple:true}},events:{addRootElement:{parameters:{element:{type:"sap.ui.core.Element"}}},addPlugin:{parameters:{plugin:{type:"sap.ui.dt.Plugin"}}},enabledChanged:{parameters:{value:{type:"boolean"}}},elementOverlayCreated:{parameters:{elementOverlay:{type:"sap.ui.dt.ElementOverlay"}}},elementOverlayDestroyed:{parameters:{elementOverlay:{type:"sap.ui.dt.ElementOverlay"}}},elementOverlayAdded:{parameters:{id:{type:"string"},targetIndex:{type:"int"},targetId:{type:"string"},targetAggregation:{type:"string"}}},elementOverlayMoved:{parameters:{id:{type:"string"},targetIndex:{type:"int"},targetId:{type:"string"},targetAggregation:{type:"string"}}},elementOverlayEditableChanged:{parameters:{id:{type:"string"},elementId:{type:"string"},editable:{type:"boolean"}}},elementPropertyChanged:{parameters:{id:{type:"string"},name:{type:"string"},oldValue:{type:"any"},value:{type:"any"}}},syncing:{},synced:{},syncFailed:{}}},constructor:function(){this._sStatus=E.SYNCED;this._mPendingOverlays={};this._oTaskManager=new h({complete:function(e){if(e.getSource().isEmpty()){this._registerElementOverlays();if(this._oTaskManager.isEmpty()&&this._sStatus!==E.SYNCED){this._sStatus=E.SYNCED;setTimeout(function(){if(this._sStatus===E.SYNCED){this.fireSynced()}}.bind(this),0)}}}.bind(this),add:function(e){if(e.getSource().count()===1){this._sStatus=E.SYNCING;this.fireSyncing()}}.bind(this)});this._oTaskRunner=new y({taskManager:this._oTaskManager,taskType:"applyStyles"}).run();this._oSelectionManager=new n;this._aOverlaysCreatedInLastBatch=[];e.apply(this,arguments);this.getRootElements().forEach(this._createOverlaysForRootElement,this);this.attachEvent("addRootElement",function(e){this._createOverlaysForRootElement(e.getParameter("element"))},this);this.getPlugins().forEach(function(e){e.attachEvent("processingStatusChange",this._onProcessingStatusChange,this)},this);this.attachEvent("addPlugin",function(e){var t=e.getParameter("plugin");t.attachEvent("processingStatusChange",this._onProcessingStatusChange,this)},this);this.attachEvent("enabledChanged",function(e){var t=e.getParameter("value");var a=l.getOverlayContainer();a[t?"show":"hide"]();this.getRootElements().forEach(function(e){var a=r.getOverlay(e);a.setVisible(t);if(t){this._oTaskManager.add({type:"applyStyles",callbackFn:a.applyStyles.bind(a,true),overlayId:a.getId()})}}.bind(this))},this)}});S.prototype._onProcessingStatusChange=function(e){if(e.getParameter("processing")){this._oTaskManager.add({type:"pluginInProcess",plugin:e.getSource().getMetadata().getName()})}else{this._oTaskManager.completeBy({type:"pluginInProcess",plugin:e.getSource().getMetadata().getName()})}};S.prototype._onApplyStylesRequired=function(e){var t=e.getParameters();var a=e.getSource();this._oTaskManager.add({type:"applyStyles",callbackFn:a.applyStyles.bind(a,t.bForceScrollbarSync,t.bSkipForceCalculation),overlayId:a.getId()},"overlayId")};S.prototype._removeOverlayFromSyncingBatch=function(e){var t=this._aOverlaysCreatedInLastBatch.indexOf(e);if(t!==-1){this._aOverlaysCreatedInLastBatch.splice(t,1)}};S.prototype._registerElementOverlays=function(){var e=this._aOverlaysCreatedInLastBatch.slice();if(!e.length){return}var t=this._oTaskManager.add({type:"registerElementOverlays"});var a=this.getPlugins();e.forEach(function(e){r.register(e);e.attachBeforeDestroy(function(e){r.deregister(e.getSource())})});e.forEach(function(e){a.forEach(function(t){try{t.callElementOverlayRegistrationMethods(e)}catch(r){var a=c.propagateError(r,"DesignTime#_registerElementOverlays",c.printf("registerElementOverlay() method of the plugin {0} has failed for overlay with id='{1}' (element id='{2}')",t.getMetadata().getName(),e.getId(),e.getElement().getId()));u.error(c.errorToString(a))}})},this);e.forEach(function(e){try{this.fireElementOverlayCreated({elementOverlay:e})}catch(a){var t=c.propagateError(a,"DesignTime#_registerElementOverlays",c.printf('One of the listeners of elementOverlayCreated event failed while precessing the overlay with id="{0}" for element with id="{1}"',e.getId(),e.getElement().getId()));u.error(c.errorToString(t))}},this);this._aOverlaysCreatedInLastBatch=[];this._oTaskManager.complete(t)};S.prototype.exit=function(){this._bDestroyPending=true;this.getPlugins().forEach(function(e){e.destroy()});this._oSelectionManager.destroy();this._oTaskManager.destroy();this._destroyAllOverlays();this._aOverlaysCreatedInLastBatch=[];delete this._bDestroyPending};S.prototype.getSelection=function(){return this.getSelectionManager().get()};S.prototype.getSelectionManager=function(){return this._oSelectionManager};S.prototype.getPlugins=function(){return this.getAggregation("plugins")||[]};S.prototype.getBusyPlugins=function(){return this.getPlugins().filter(function(e){return e.isBusy()})};S.prototype.waitForBusyPlugins=function(){var e=this.getBusyPlugins();return Promise.all(e.map(function(e){return e.waitForBusyAction()}))};S.prototype.addPlugin=function(e){this.addAggregation("plugins",e);this.fireAddPlugin({plugin:e});e.setDesignTime(this);return this};S.prototype.insertPlugin=function(e,t){this.insertAggregation("plugins",e,t);this.fireAddPlugin({plugin:e});e.setDesignTime(this);return this};S.prototype.removePlugin=function(e){this.getPlugins().forEach(function(t){if(t===e){e.setDesignTime(null);e.detachEvent("processingStatusChange",this._onProcessingStatusChange,this)}}.bind(this));this.removeAggregation("plugins",e);return this};S.prototype.removeAllPlugins=function(){this.getPlugins().forEach(function(e){e.setDesignTime(null);e.detachEvent("processingStatusChange",this._onProcessingStatusChange,this)}.bind(this));this.removeAllAggregation("plugins");return this};S.prototype.getRootElements=function(){return(this.getAssociation("rootElements")||[]).map(function(e){return o.getElementInstance(e)})};S.prototype.getDesignTimeMetadataFor=function(e){var t;if(typeof e==="string"){t=e;u.error("sap.ui.dt.DesignTime#getDesignTimeMetadataFor / Function getDesignTimeMetadataFor() should be called with element instance")}else{t=e.getMetadata().getName()}return(this.getDesignTimeMetadata()||{})[t]};S.prototype.addRootElement=function(e){this.addAssociation("rootElements",e);this.fireAddRootElement({element:e})};S.prototype._createOverlaysForRootElement=function(e){var t=this._oTaskManager.add({type:"createOverlay",element:e,root:true});this.createOverlay({element:o.getElementInstance(e),root:true,visible:this.getEnabled()}).then(function(e){l.getOverlayContainer().append(e.render());this._oTaskManager.add({type:"applyStyles",callbackFn:e.applyStyles.bind(e),overlayId:e.getId()},"overlayId");this._oTaskManager.complete(t);return e}.bind(this),function(a){var r=c.propagateError(a,"DesignTime#_createOverlaysForRootElement",c.printf("Root element with id = '{0}' initialization is failed",e.getId()));u.error(c.errorToString(r));this._oTaskManager.cancel(t);this.fireSyncFailed({error:r})}.bind(this))};S.prototype.removeRootElement=function(e){this.removeAssociation("rootElements",e);this._destroyOverlaysForElement(o.getElementInstance(e));return this};S.prototype.removeAllRootElement=function(){this.removeAssociation("rootElements");this._destroyAllOverlays();return this};S.prototype.getElementOverlays=function(){var e=[];this._iterateRootElements(function(t){e=e.concat(this._getAllElementOverlaysIn(t))},this);return e};function T(e,t){if(e){t.setIsRoot(true)}}S.prototype.createOverlay=function(e){var t=Object.assign({},p(e)?e:{element:e});var a=this._oTaskManager.add({type:"createOverlay"});if(!t.element||!o.isElementValid(t.element)){this._oTaskManager.cancel(a);return this._rejectCreateOverlay(t.element)}var n=t.element.getId();var i=r.getOverlay(n);if(i){T(t.root,i);this._oTaskManager.complete(a);return Promise.resolve(i)}else if(n in this._mPendingOverlays){this._oTaskManager.complete(a);return this._mPendingOverlays[n]}if(typeof t.root==="undefined"){t.root=true}this._mPendingOverlays[n]=this._createElementOverlay(t).then(function(e){return this._createChildren(e,t).then(function(){this.attachEventOnce("synced",function(){delete this._mPendingOverlays[n]},this);if(this.bIsDestroyed){e.detachEvent("destroyed",this._onElementOverlayDestroyed,this);e.destroy();this._oTaskManager.cancel(a);return Promise.reject(c.createError("DesignTime#createOverlay","while creating overlay, DesignTime instance has been destroyed"))}else if(e.bIsDestroyed){this._oTaskManager.cancel(a);return Promise.reject(c.createError("DesignTime#createOverlay","while creating children overlays, its parent overlay has been destroyed"))}this._aOverlaysCreatedInLastBatch.push(e);this._oTaskManager.complete(a);return e}.bind(this))}.bind(this)).catch(function(e){var t=c.propagateError(e,"DesignTime#createOverlay",c.printf("Failed attempt to create overlay for '{0}'",n));delete this._mPendingOverlays[n];this._oTaskManager.cancel(a);return Promise.reject(t)}.bind(this));return this._mPendingOverlays[n]};S.prototype._rejectCreateOverlay=function(t){var a;if(!t){a="Cannot create overlay — no element is specified."}else if(t.bIsDestroyed){a="Cannot create overlay — the element is already destroyed."}else if(t instanceof e&&!o.isElementInTemplate(t)){a="Element is in a bound aggregation, but not found in the binding template. Skipping overlay creation for element with id='"+t.getId()+"'. Please report to CA-UI5-FL-RTA component."}else{a=c.printf("Cannot create overlay without a valid element. Expected a descendant of sap.ui.core.Element or sap.ui.core.Component, but {0} was given",c.getObjectType(t))}return Promise.reject(c.createError("DesignTime#createOverlay",a))};S.prototype._createAggregationOverlay=function(e,t,n,i){return new a({aggregationName:e,element:t,visible:!i,isPartOfTemplate:i,designTimeMetadata:new s({data:n}),init:function(e){var t=e.getSource();t.attachEvent("destroyed",this._onAggregationOverlayDestroyed,this);t.attachEvent("applyStylesRequired",this._onApplyStylesRequired,this)}.bind(this),beforeDestroy:function(e){var t=e.getSource();r.deregister(t);t.detachEvent("applyStylesRequired",this._onApplyStylesRequired,this)}.bind(this)})};S.prototype._createElementOverlay=function(e){var a=e.element;function r(e){return new t(e)}return new Promise(function(t,n){r({element:a,isRoot:e.root,visible:typeof e.visible!=="boolean"||e.visible,isPartOfTemplate:e.isPartOfTemplate,metadataScope:this.getScope(),designTimeMetadata:this.getDesignTimeMetadataFor(a)instanceof i?this.getDesignTimeMetadataFor(a):O(function(e,t,a,r){r=m({},r,e);this._mMetadataOriginal=r;if(t){r=d.propagateMetadataToElementOverlay(r,t,a)}return r})(this.getDesignTimeMetadataFor(a),e.parentMetadata,a),init:function(e){var a=e.getSource();t(e.getSource());a.attachEvent("destroyed",this._onElementOverlayDestroyed,this);a.attachEvent("elementDestroyed",this._onElementDestroyed,this);a.attachEvent("selectionChange",this._onElementOverlaySelectionChange,this);a.attachEvent("elementModified",this._onElementModified,this);a.attachEvent("editableChange",this._onEditableChanged,this);a.attachEvent("applyStylesRequired",this._onApplyStylesRequired,this)}.bind(this),initFailed:function(e,t){var a=t.getSource();var r=c.propagateError(t.getParameter("error"),"DesignTime#_createElementOverlay",c.printf("Can't create overlay properly (id='{0}') for '{1}'",a.getId(),e));a.detachEvent("destroyed",this._onElementOverlayDestroyed,this);a.detachEvent("elementDestroyed",this._onElementDestroyed,this);a.detachEvent("applyStylesRequired",this._onApplyStylesRequired,this);a.destroy();n(r)}.bind(this,a.getId())})}.bind(this))};function I(e,t){var a=e.getElement();return t.reduce(function(e,t){var r=o.getAggregationBindingTemplate(a,t);if(r){e[t]=r}return e},{})}S.prototype._createChildren=function(e,t){var a=e.getAggregationNames();var r=t.parentMetadata;var n=I(e,a);var i=Object.keys(n);var s=t.isPartOfTemplate!==undefined;var o=!b(n);var l=o&&!s;var g=l?true:t.isPartOfTemplate;var d=l?false:t.isPartOfTemplate;if(o&&g&&!l){a=_(a,i)}return this._createChildrenOverlays(e,r,i,g,n).then(this._createChildrenOverlays.bind(this,e,r,a,d))};S.prototype._createChildrenOverlays=function(e,a,n,i,s){var l=!b(s);if(l&&!i){return Promise.resolve()}return Promise.all(n.map(function(n){var g=e.getElement();var c=g.getMetadata().getName();var h=d.propagateMetadataToAggregationOverlay(e.getDesignTimeMetadata().getAggregation(n),g,a);var y=this._createAggregationOverlay(n,g,h,l);r.register(y);var p;if(l){p=[s[n]]}else{p=o[y.isAssociation()?"getAssociationInstances":"getAggregation"](g,n)}return Promise.all(p.map(function(t,a){return this.createOverlay({element:a,root:false,parentMetadata:h,isPartOfTemplate:i}).catch(function(r){var i=this._enrichChildCreationError(r,a,t,n);if(!g.isDestroyed()&&!e.isDestroyed()){u[i.severity](i.message)}return i.errorObject}.bind(this))}.bind(this,c))).then(function(e){e.map(function(e){if(e instanceof t&&!e.bIsDestroyed&&!e.getParent()){y.addChild(e,true)}},this);return y}.bind(this))},this)).then(function(t){t.forEach(function(t){if(e.bIsDestroyed){t.destroy()}else if(l){e.addAggregationBindingTemplateOverlay(t)}else{e.addChild(t,true)}})})};S.prototype._enrichChildCreationError=function(e,t,a,r){var n="error";var i=c.errorToString(e);if(e.message.includes("Cannot create overlay without a valid element")){n="warning";e=c.createError("DesignTime#_createChildren",c.printf(["Child element in aggregation '{0}' of {1} must be a descendant of sap.ui.core.Element or ","sap.ui.core.Component, but {2} was give. Consider ignoring the aggregation '{0}' ","in the .designtime configuration of the control."].join(""),r,a,c.getObjectType(t)));i=e.toString()}else if(e.message.startsWith("Element is in a bound aggregation")){n="error";i=e.toString()}return{errorObject:e,severity:n,message:i}};S.prototype._destroyOverlaysForElement=function(e){var t=r.getOverlay(e);if(t){t.destroy()}};S.prototype._destroyAllOverlays=function(){this._iterateRootElements(function(e){this._destroyOverlaysForElement(e)},this)};S.prototype._onElementOverlayDestroyed=function(e){if(this._bDestroyPending){return}var t=e.getSource();this._oTaskManager.cancelBy({type:"applyStyles",overlayId:t.getId()},"overlayId");this._removeOverlayFromSyncingBatch(t);var a=t.getAssociation("element");if(a in this._mPendingOverlays){delete this._mPendingOverlays[a];return}if(!r.hasOverlays()){l.destroyMutationObserver();l.removeOverlayContainer()}if(t.isSelected()){this.getSelectionManager().remove(t)}this.fireElementOverlayDestroyed({elementOverlay:t})};S.prototype._onElementDestroyed=function(e){var t=e.getParameter("targetId");this.removeRootElement(t)};S.prototype._onAggregationOverlayDestroyed=function(e){this._oTaskManager.cancelBy({type:"applyStyles",overlayId:e.getSource().getId()},"overlayId");if(!r.hasOverlays()){l.removeOverlayContainer()}};S.prototype._onElementOverlaySelectionChange=function(e){var t=e.getSource();var a=e.getParameter("selected");if(a){if(this.getSelectionManager().getSelectionMode()===v.Multi){this.getSelectionManager().add(t)}else{this.getSelectionManager().set(t)}if(!f(this.getSelectionManager().get(),t)){t.setSelected(false)}}else{this.getSelectionManager().remove(t)}};S.prototype._onElementModified=function(e){var t=m({},e.getParameters());var a=e.getSource();t.type=!t.type?e.getId():t.type;switch(t.type){case"addOrSetAggregation":case"insertAggregation":this._onAddAggregation(t.value,t.target,t.name);break;case"setParent":setTimeout(function(){if(!this.bIsDestroyed){this._checkIfOverlayShouldBeDestroyed(t.target)}}.bind(this),0);break;case"propertyChanged":t.id=e.getSource().getId();delete t.type;delete t.target;if(this.getStatus()===E.SYNCING){this.attachEventOnce("synced",t,function(){if(!a.bIsDestroyed){this.fireElementPropertyChanged(arguments[1])}},this)}else{this.fireElementPropertyChanged(t)}break;default:break}};S.prototype._onEditableChanged=function(e){var t=m({},e.getParameters());var a=e.getSource();t.id=a.getId();if(this.getStatus()===E.SYNCING){this.attachEventOnce("synced",t,function(){if(!a.bIsDestroyed){this.fireElementOverlayEditableChanged(arguments[1])}},this)}else{this.fireElementOverlayEditableChanged(t)}};S.prototype._onAddAggregation=function(e,t,a){if(o.isElementValid(e)){var n=r.getOverlay(t);var i=n&&n.getAggregationOverlay(a);if(!i){var s=function(r){var n=r.getParameter("elementOverlay");if(n.getElement().getId()===t.getId()){var i=n.getAggregationOverlay(a);this.detachElementOverlayCreated(s,this);this._addAggregation(e,i)}};this.attachElementOverlayCreated(s,this)}else{this._addAggregation(e,i)}}};S.prototype._addAggregation=function(e,t){var a=r.getOverlay(e);if(!a&&t&&t.getElement()){var n=this._oTaskManager.add({type:"createChildOverlay",element:e});this.createOverlay({element:e,root:false,parentMetadata:t.getDesignTimeMetadata().getData()}).then(function(e){var a=t.insertChild(null,e);if(a===true){this._oTaskManager.add({type:"applyStyles",callbackFn:e.applyStyles.bind(e),overlayId:e.getId()},"overlayId");var r=t.indexOfAggregation("children",e);this.attachEventOnce("synced",e,function(){if(!e.bIsDestroyed){this.fireElementOverlayAdded({id:e.getId(),targetIndex:r,targetId:t.getId(),targetAggregation:t.getAggregationName()})}},this)}this._oTaskManager.complete(n)}.bind(this)).catch(function(a,r,i){this._oTaskManager.cancel(n);var s=c.propagateError(i,"DesignTime#_onAddAggregation",c.printf("Failed to add new element overlay (elementId='{0}') into aggregation overlay (id='{1}')",a,r));if(!e.bIsDestroyed&&!t.bIsDestroyed){u.error(c.errorToString(s))}}.bind(this,e.getId(),t.getId()))}else{if(a&&!this._isElementInRootElements(a)&&a.isRoot()){a.setIsRoot(false)}if(t){t.insertChild(null,a)}else{u.error("No parentAggregationOverlay exists during addAggregation");return}a.setDesignTimeMetadata(d.propagateMetadataToElementOverlay(a._mMetadataOriginal,t.getDesignTimeMetadata().getData(),e));this.fireElementOverlayMoved({id:a.getId(),targetIndex:t.indexOfAggregation("children",a),targetId:t.getId(),targetAggregation:t.getAggregationName()})}};S.prototype._checkIfOverlayShouldBeDestroyed=function(e){var t=r.getOverlay(e);if(!e.bIsDestroyed&&t&&(!this._isElementInRootElements(e)||e.sParentAggregationName==="dependents")){t.destroy()}};S.prototype._isElementInRootElements=function(e){var t=false;this._iterateRootElements(function(a){if(o.hasAncestor(e,a)){t=true;return false}return undefined});return t};S.prototype._iterateRootElements=function(e,t){var a=this.getRootElements();a.forEach(function(a){var r=o.getElementInstance(a);e.call(t||this,r)},this)};S.prototype._getAllElementOverlaysIn=function(e){var t=[];var a=r.getOverlay(e);if(a){g.iterateOverlayElementTree(a,function(e){if(e.getDesignTimeMetadata()){t.push(e)}})}return t};S.prototype.setEnabled=function(e){e=!!e;if(this.getEnabled()!==e){this.setProperty("enabled",e);this.fireEnabledChanged({value:e})}};S.prototype.getStatus=function(){return this._sStatus};return S});
//# sourceMappingURL=DesignTime.js.map