/*!
 * OpenUI5
 * (c) Copyright 2009-2023 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/mdc/field/FieldHelpBase","sap/ui/mdc/condition/Condition","sap/ui/mdc/condition/FilterOperatorUtil","sap/ui/mdc/enum/OutParameterMode","sap/ui/mdc/enum/ConditionValidated","sap/ui/mdc/condition/FilterConverter","sap/ui/base/ManagedObjectObserver","sap/ui/base/SyncPromise","sap/base/util/ObjectPath","sap/base/util/deepEqual","sap/base/util/merge","sap/ui/model/resource/ResourceModel","sap/ui/model/Context","sap/ui/Device","sap/m/library","sap/m/VariantItem","sap/ui/core/library","sap/ui/mdc/util/loadModules","sap/ui/events/KeyCodes"],function(e,t,i,a,r,n,s,l,o,h,u,d,f,g,c,p,v,_,m){"use strict";var b;var y;var C;var F;var P;var O;var S;var I;var D;var A=c.ButtonType;var B=v.OpenState;var T=e.extend("sap.ui.mdc.field.FieldValueHelp",{metadata:{library:"sap.ui.mdc",properties:{delegate:{type:"object",group:"Data",defaultValue:{name:"sap/ui/mdc/field/FieldValueHelpDelegate"}},filterFields:{type:"string",defaultValue:""},keyPath:{type:"string",defaultValue:""},descriptionPath:{type:"string",defaultValue:""},showConditionPanel:{type:"boolean",defaultValue:false},title:{type:"string",group:"Appearance",defaultValue:""},noDialog:{type:"boolean",group:"Appearance",defaultValue:false},caseSensitive:{type:"boolean",defaultValue:true},_enableOK:{type:"boolean",group:"Appearance",defaultValue:true,visibility:"hidden"}},aggregations:{content:{type:"sap.ui.mdc.field.FieldValueHelpContentWrapperBase",multiple:false},suggestContent:{type:"sap.ui.mdc.field.FieldValueHelpContentWrapperBase",multiple:false},dialogContent:{type:"sap.ui.mdc.field.FieldValueHelpContentWrapperBase",multiple:false},filterBar:{type:"sap.ui.mdc.filterbar.FilterBarBase",multiple:false},inParameters:{type:"sap.ui.mdc.field.InParameter",group:"Data",multiple:true},outParameters:{type:"sap.ui.mdc.field.OutParameter",group:"Data",multiple:true},_dialog:{type:"sap.m.Dialog",multiple:false,visibility:"hidden"},_filterBar:{type:"sap.ui.mdc.filterbar.FilterBarBase",multiple:false,visibility:"hidden"},collectiveSearchItems:{type:"sap.ui.core.Item",multiple:true,singularName:"collectiveSearchItem"}},defaultAggregation:"content",events:{dataRequested:{}}}});T._init=function(){e._init.apply(this,arguments);b=undefined;y=undefined;C=undefined;F=undefined;P=undefined};T.prototype.init=function(){e.prototype.init.apply(this,arguments);this._oObserver=new s(M.bind(this));this._oObserver.observe(this,{properties:["filterValue","conditions","showConditionPanel","filterFields"],aggregations:["content","suggestContent","dialogContent","filterBar","_filterBar","inParameters","collectiveSearchItems"]});this.setBindingContext(null);this._oConditions={}};T.prototype.exit=function(){e.prototype.exit.apply(this,arguments);if(this._oManagedObjectModel){this._oManagedObjectModel.destroy();delete this._oManagedObjectModel}this._oObserver.disconnect();this._oObserver=undefined;delete this._oConditions;if(this._iUpdateTimer){clearTimeout(this._iUpdateTimer);this._iUpdateTimer=null}if(this._iFilterTimer){clearTimeout(this._iFilterTimer);this._iFilterTimer=null}if(this._iSearchFieldTimer){clearTimeout(this._iSearchFieldTimer);this._iSearchFieldTimer=null}if(this._oCollectiveSearchSelect){this._oCollectiveSearchSelect.destroy();delete this._oCollectiveSearchSelect}if(this._oResourceBundleM){this._oResourceBundleM=null}if(this._oResourceBundle){this._oResourceBundle=null}};T.prototype.invalidate=function(t){if(t){var i=Te.call(this,true);var a=Te.call(this,false);var r=this.getAggregation("_dialog");if(i&&t===i||a&&t===a){var n=this.getAggregation("_popover");if(r&&r.isOpen()){var s=r.getContent()[0];s.invalidate(t)}else if(n&&n.isOpen()){n.invalidate(t)}return}var l=this._getFilterBar();if(r&&t===r||l&&t===l){if(t.bOutput&&!this._bIsBeingDestroyed){var o=this.getParent();if(o){o.invalidate(this)}}return}}e.prototype.invalidate.apply(this,arguments)};T.prototype.connect=function(t){e.prototype.connect.apply(this,arguments);Se.call(this);ve.call(this,this.getShowConditionPanel());return this};T.prototype.getIcon=function(){if(this.getNoDialog()){return"sap-icon://slim-arrow-down"}else{return"sap-icon://value-help"}};T.prototype._createPopover=function(){var t=e.prototype._createPopover.apply(this,arguments);var i=function(e){this.fireSwitchToValueHelp()}.bind(this);if(t){t.addDelegate({onsapshow:i});var a=Te.call(this,true);if(a){l.resolve(a.initialize(true)).then(function(){if(a.enableShowAllItems()){_(["sap/m/Button","sap/m/Toolbar","sap/m/ToolbarSpacer"]).then(function(e){var r=e[0];var n=e[1];var s=e[2];var l=Ie.apply(this);var o=new r(this.getId()+"-showAllItems",{text:l.getText("INPUT_SUGGESTIONS_SHOW_ALL"),press:i});var h=[new s(this.getId()+"-Spacer")].concat(o);var u=new n(this.getId()+"-TB",{content:h,visible:!a.getAllItemsShown()}).setModel(this._oFooterModel,"$config");t.setFooter(u)}.bind(this))}}.bind(this))}t._getAllContent=function(){var e=this.getParent();var t=[];if(e){var i=Oe.call(e);if(i){t.push(i)}}return t};if(this._bNavigate){this.navigate(this._iStep)}}return t};T.prototype._handleAfterOpen=function(t){e.prototype._handleAfterOpen.apply(this,arguments);var i=Te.call(this,true);if(i){i.fieldHelpOpen(true)}};T.prototype.open=function(t){if(this.getNoDialog()&&!t){t=true}Se.call(this);if(this._bOpenAfterPromise){this._bSuggestion=t;return}var i=Te.call(this,t);var a=function(){if(this._bOpenAfterPromise){delete this._bOpenAfterPromise;this.open(this._bSuggestion);delete this._bSuggestion}}.bind(this);var r=this._bOpen?this._callContentRequest(!!t,a):this._fireOpen(!!t,a);delete this._bOpen;if(!r){this._bSuggestion=t;if(t){this._getPopover()}else{de.call(this)}this._bOpenAfterPromise=true;return}this._bOpenHandled=true;i=Te.call(this,t);if(i&&i.getFilterEnabled()&&!this._bNavigateRunning){this._bApplyFilter=false;if(!i.isSuspended()||t||this.getFilterValue()){this._bApplyFilter=true}be.call(this)}if(this._bUpdateFilterAfterClose){this._bUpdateFilterAfterClose=false;$.call(this,this.getFilterValue())}if(t){if(!i){this._bOpenIfContent=true}else{i.fieldHelpOpen(t);if(!this.getFilterValue()&&!this._bNavigateRunning){ae.call(this,true)}e.prototype.open.apply(this,[t])}}else{var n=this.getAggregation("_popover");if(n){if(n.isOpen()){this.close();this._bSwitchToDialog=true}n.$().remove()}var s=de.call(this);if(s){Pe.call(this);Be.call(this,true);me.call(this);var l=s.getContent()[0];l.setShowTokenizer(this.getMaxConditions()!==1&&!!i);l.setFormatOptions(this._getFormatOptions());l.bindProperty("conditions",{path:"$help>/conditions"});if(i){i.fieldHelpOpen(false);k.call(this)}this._aOldConditions=this.getConditions();s.open();this._bDialogOpen=true}else{this._bOpen=true}}this._bOpenHandled=false;return};T.prototype.toggleOpen=function(t){if(this.getNoDialog()&&!t){t=true}if(t){e.prototype.toggleOpen.apply(this,[t])}else if(this._bOpen||this._bOpenIfContent||this._bOpenAfterPromise){delete this._bOpen;delete this._bSuggestion;delete this._bOpenIfContent;delete this._bOpenAfterPromise}else{var i=de.call(this);if(i){if(i.isOpen()){var a=i.oPopup.getOpenState();if(a!=="CLOSED"&&a!=="CLOSING"){this.close()}else{this._bReopen=true}}else{this.open(t)}}else{this.open(t)}}};T.prototype.close=function(){if(!this._bDialogOpen){e.prototype.close.apply(this,arguments)}else{var t=this.getAggregation("_dialog");if(t){this._bClosing=true;t.close();var i=t.getContent()[0];i.unbindProperty("conditions",true);if(i._oDefineConditionPanel){i._oDefineConditionPanel.cleanUp()}}this._bReopen=false;this._bSwitchToDialog=false;delete this._bOpen;delete this._bOpenAfterPromise}};T.prototype.isOpen=function(t){var i=e.prototype.isOpen.apply(this,arguments);if(!i&&(!t||!this._bClosing)){var a=this.getAggregation("_dialog");if(a){i=a.isOpen()}}return i};T.prototype.getDomRef=function(){if(!this._bDialogOpen){return e.prototype.getDomRef.apply(this,arguments)}else{var t=this.getAggregation("_dialog");if(t){return t.getDomRef()}}};function V(){var e=this._getFilterBar();var t;if(e){t=e.getInternalConditions()}else{t=this._oConditions}var i=false;for(var a in t){if(t[a].length>0){Fe.call(this,a);i=true}}if(i){ae.call(this,true)}}T.prototype._handleAfterClose=function(t){var i=this.getAggregation("_dialog");var a=!i||t.getSource()!==i;var r=Te.call(this,a);if(r){if(!r.getAsyncKeyText()){V.call(this)}r.fieldHelpClose()}if(!this.isOpen()){this._bApplyFilter=false}this._bNavigateRunning=false;e.prototype._handleAfterClose.apply(this,arguments)};function M(e){if(e.object==this){var t;if(e.name==="content"){ue.call(this,e.mutation,e.child,e.name)}if(e.name==="suggestContent"){ue.call(this,e.mutation,e.child,e.name)}if(e.name==="dialogContent"){ue.call(this,e.mutation,e.child,e.name)}if(e.name==="filterBar"){if(e.mutation==="insert"&&this.getAggregation("_filterBar")){this.destroyAggregation("_filterBar");delete this._oSearchField}_e.call(this,e.mutation,e.child,false)}if(e.name==="_filterBar"){_e.call(this,e.mutation,e.child,true)}if(e.name==="conditions"){K.call(this,e.current)}if(e.name==="filterValue"){if(this._bClosing){this._bUpdateFilterAfterClose=true}else{$.call(this,e.current)}}if(e.name==="showConditionPanel"){ve.call(this,e.current)}if(e.name==="filterFields"){t=this.getAggregation("_dialog");if(t){if(t.isOpen()){if(e.current){Pe.call(this)}else if(this.getAggregation("_filterBar")){this.destroyAggregation("_filterBar")}}}}if(e.name==="inParameters"){L.call(this,e.child,e.mutation)}if(e.name==="collectiveSearchItems"){Be.call(this,false)}}else if(e.object.isA("sap.ui.mdc.field.InParameter")){if(e.name==="value"){G.call(this,e.object.getHelpPath(),e.current,e.old,e.object.getUseConditions(),e.object.getInitialValueFilterEmpty())}if(e.name==="helpPath"){Q.call(this,e.current,e.old,e.object.getValue(),e.object.getUseConditions(),e.object.getInitialValueFilterEmpty())}}}T.prototype.openByTyping=function(){if(!this._bDetermineSearchSupportedCalled&&!this.isOpen()&&!this._bOpen&&!this._bOpenIfContent&&!this._bOpenAfterPromise){if(!this.bDelegateInitialized&&!this.bDelegateLoading){this.initControlDelegate()}if(this.bDelegateInitialized){return x.call(this)}else{this._bDetermineSearchSupportedCalled=true;return this.awaitControlDelegate().then(function(){return x.call(this)}.bind(this))}}return!!this.getFilterFields()};function x(){this.fireOpen({suggestion:true});this._bDetermineSearchSupportedCalled=true;var e=this.getControlDelegate().determineSearchSupported(this.getPayload(),this);if(e instanceof Promise){return e.then(function(){return!!this.getFilterFields()}.bind(this))}else{return!!this.getFilterFields()}}T.prototype.isFocusInHelp=function(){if(!this.getNoDialog()){var e=this.getAggregation("_dialog");if(e&&e.isOpen()||this._bDialogRequested&&this._bOpen||this._bOpenAfterPromise&&!this._bSuggestion){return true}}if(this._bFocusPopover){return true}return false};T.prototype.removeFocus=function(){var e=Te.call(this,true);if(e){e.removeFocus()}};T.prototype.navigate=function(e){var t=Te.call(this,true);var i=this.getAggregation("_popover");Se.call(this);if(!i||!i.isOpen()){var a=function(){this.navigate(e)}.bind(this);var r=this._bNavigate?this._callContentRequest(true,a):this._fireOpen(true,a);if(!r){t=Te.call(this,true);this._bNavigate=false;this._iStep=null;if(t){this._getPopover()}return}}this._bNavigate=false;this._iStep=null;t=Te.call(this,true);if(t){i=this._getPopover();this._bApplyFilter=true;this._bNavigateRunning=true;be.call(this);ae.call(this,true)}if(!i){this._bNavigate=true;this._iStep=e;return}if(t){t.navigate(e,i.isOpen())}};function w(e){var t=this._getPopover();var i=e.getParameter("disableFocus");var a=e.getParameter("key");var r=e.getParameter("description");var n=e.getParameter("inParameters");var s=e.getParameter("outParameters");var l=e.getParameter("leave");var o=e.getParameter("itemId");var h;if(l){this.fireNavigate({key:undefined,value:undefined,condition:undefined,itemId:undefined,leaveFocus:l});return}if(a===undefined&&!i){this._bFocusPopover=true}if(!t.isOpen()){this._bOpenHandled=true;this.open(true);this._bOpenHandled=false}this._bNavigateRunning=false;if(a===undefined){this._bFocusPopover=false;return}if(n){n=J.call(this,n)}if(s){s=Y.call(this,s)}h=this._createCondition(a,r,n,s);this.setProperty("conditions",[h],true);this.fireNavigate({value:r,key:a,condition:h,itemId:o,leaveFocus:l})}T.prototype._getTextOrKey=function(e,t,i,a,r,n,s,o,h,u,d){var g="";var c=Te.call(this,true);if(c){var p=c.getListBinding();if(!p){this.fireDataRequested()}if(i&&!i.getModel()){return null}d=d||this.getCaseSensitive();var v=this.oBindingContexts[undefined];var _=this.getInParameters();var m=false;if(i&&f.hasChanged(v,i)){m=true}var b=R.call(this,_,m,i,v,s,o);g=l.resolve().then(function(){return E.call(this,b)}.bind(this)).then(function(){return l.resolve().then(function(){if(i&&!i.getModel()){return null}else if(u){return c.getKeyAndText(h,e,ie.call(this,a,_,false,b,i,true),ie.call(this,r,this.getOutParameters(),true,undefined,undefined,true),d)}else if(t){return c.getTextForKey(e,ie.call(this,a,_,false,b,i,true),ie.call(this,r,this.getOutParameters(),true,undefined,undefined,true),n,d)}else{return c.getKeyForText(e,ie.call(this,undefined,_,false,b,i,true),n,d)}}.bind(this)).then(function(e){H.call(this,b,m);return N.call(this,e)}.bind(this)).unwrap()}.bind(this)).unwrap()}return g};function R(e,t,i,a,r,n){var s=[];for(var l=0;l<e.length;l++){var o=e[l];var u=o.getBinding("value");if(o.getUseConditions()&&r){var d=this.getModel(n);if(d!==r){s.push(r.bindProperty("/"+o.getFieldPath()))}}else if(u){var f=u.getPath();var g=u.getContext();if(t&&u.isRelative()&&(g===a||!g&&a)){if(i.getProperty(f)===undefined){var c=u.getModel();s.push(c.bindProperty(f,i))}}else if(!g&&u.isRelative()||g&&g.getProperty(f)===undefined||u.getValue()===undefined||g&&!h(o.validateProperty("value",g.getProperty(f)),o.getValue())){s.push(u)}}}return s}function H(e,t){if(!t){return}for(var i=0;i<e.length;i++){e[i].destroy()}}function E(e){if(e.length===0){return null}if(!this.bDelegateInitialized&&!this.bDelegateLoading){this.initControlDelegate()}if(this.bDelegateInitialized){return this.getControlDelegate().checkBindingsPending(this.getPayload(),e)}else{return this.awaitControlDelegate().then(function(){return this.getControlDelegate().checkBindingsPending(this.getPayload(),e)}.bind(this))}}function N(e){if(e&&typeof e==="object"){e=u({},e);if(e.inParameters){e.inParameters=J.call(this,e.inParameters)}if(e.outParameters){e.outParameters=Y.call(this,e.outParameters)}}return e}T.prototype._isTextOrKeyRequestSupported=function(){var e=Te.call(this,true);return!!e};T.prototype.isUsableForValidation=function(){var e=Te.call(this,true);return!!e};function U(e){var t=e.getParameter("selectedItems");var i=e.getParameter("itemPress");var a;var n=this.getConditions();var s;var l=0;var o=0;var u=false;var d=this.getMaxConditions();var f=this._getOperator();for(l=n.length-1;l>=0;l--){s=n[l];s.inParameters=ee.call(this,s.inParameters);s.outParameters=te.call(this,s.outParameters);if(s.operator===f.name&&s.validated===r.Validated){u=false;for(o=0;o<t.length;o++){a=t[o];if(s.values[0]===a.key&&(!s.inParameters||!a.inParameters||h(s.inParameters,a.inParameters))&&(!s.outParameters||!a.outParameters||h(s.outParameters,a.outParameters))){u=true;if(s.values[1]!==a.description&&a.description){if(s.values.length===1){s.values.push(a.description)}else{s.values[1]=a.description}}break}}if(!u){n.splice(l,1)}}}for(l=0;l<t.length;l++){a=t[l];u=false;for(o=0;o<n.length;o++){s=n[o];if(s.operator===f.name&&s.validated===r.Validated&&s.values[0]===a.key&&(!s.inParameters||h(s.inParameters,a.inParameters))&&(!s.outParameters||h(s.outParameters,a.outParameters))){u=true;s.inParameters=a.inParameters;s.outParameters=a.outParameters;break}}if(!u){s=this._createCondition(a.key,a.description,a.inParameters,a.outParameters);n.push(s)}}if(d>0&&n.length>d){n.splice(0,n.length-d)}for(l=0;l<n.length;l++){s=n[l];if(s.inParameters){s.inParameters=J.call(this,s.inParameters)}else{delete s.inParameters}if(s.outParameters){s.outParameters=Y.call(this,s.outParameters)}else{delete s.outParameters}}if(this._bDialogOpen){this.setProperty("conditions",n,true)}else{var g=false;var c=false;if(this.getMaxConditions()===1||i){this.close();c=true}if(this.getMaxConditions()===1){g=true}this.setProperty("conditions",n,true);this.fireSelect({conditions:n,add:g,close:c})}}function q(e){var t=e.getParameter("contentChange");var i=e.getSource();var a;if(i.enableShowAllItems()){a=this.getAggregation("_popover");var r=a&&a.getFooter();if(r){r.setVisible(!i.getAllItemsShown())}}if(t){a=a||this.getAggregation("_popover");var n=this.getAggregation("_dialog");if(a&&this._bOpenIfContent){i=Te.call(this,true);if(i){var s=this._getField();if(s){i.fieldHelpOpen(true);a.openBy(this._getControlForSuggestion());ae.call(this)}this._bOpenIfContent=false}}else if(n){i=Te.call(this,false);if(i){var l=n.getContent()[0];he.call(this,l,i.getDialogContent());if(!this._bApplyFilter&&!this._bClosing&&(this.isOpen()||this._bOpen)&&!i.isSuspended()){this._bApplyFilter=true}}}}if(!i||!i.getAsyncKeyText()){this.fireDataUpdate()}}function K(e){var t=false;for(var a=0;a<e.length;a++){var r=e[a];if(!r.validated){i.checkConditionValidated(r);t=true}}if(t){this.setConditions(e)}else{k.call(this)}}function k(){if(!this._oField){return}j.call(this,Te.call(this,true));j.call(this,Te.call(this,false))}function j(e){if(e){var t=this._getOperator();var i=this.getConditions();var a=[];for(var n=0;n<i.length;n++){var s=i[n];if(s.operator===t.name&&s.validated===r.Validated){a.push({key:s.values[0],description:s.values[1],inParameters:ee.call(this,s.inParameters),outParameters:te.call(this,s.outParameters)})}}if(!h(a,e.getSelectedItems())){e.setSelectedItems(a)}}}function $(e){var i=this.getFilterFields();if(!i){return}var a=ye.call(this,i);var n=a.length>0?a[0].values[0]:"";if(e===n){return}Fe.call(this,i);e=e.trim();if(e){this._bOwnFilterChange=false;var s=t.createCondition("StartsWith",[e],undefined,undefined,r.NotValidated);Ce.call(this,i,s)}ae.call(this,true)}function L(e,t){var i=e.getHelpPath();var a=false;if(t==="remove"){this._oObserver.unobserve(e);if(this._getField()&&this.isOpen()){a=W.call(this,i)}}else{this._oObserver.observe(e,{properties:true});if(this._getField()&&this.isOpen()){var r=e.getValue();var n=e.getUseConditions();var s=e.getInitialValueFilterEmpty();a=W.call(this,i);a=z.call(this,i,r,n,s)||a;k.call(this)}}ae.call(this,true)}function z(e,i,a,n){var s;var l=false;if(e&&(i||n&&!a)){if(a){if(Array.isArray(i)){for(var o=0;o<i.length;o++){s=u({},i[o]);if(s.inParameters){s.inParameters=ee.call(this,s.inParameters,true)}if(s.outParameters){s.outParameters=te.call(this,s.outParameters,false,true)}Ce.call(this,e,s);l=true}}}else{if(!i&&n){s=t.createCondition("Empty",[]);s.isEmpty=false}else{s=t.createItemCondition(i);s.validated=r.Validated}Ce.call(this,e,s);l=true}}return l}function W(e){var t=false;if(e&&ye.call(this,e).length>0){Fe.call(this,e);t=true}return t}function G(e,t,i,a,r){if(this._bNoInOutFilterUpdate){return}if(!this._iUpdateTimer){this._iUpdateTimer=setTimeout(function(){this._iUpdateTimer=undefined;this.fireDataUpdate()}.bind(this),0)}if(!this._getField()||!this.isOpen()){return}var n=false;n=W.call(this,e);n=z.call(this,e,t,a,r)||n;k.call(this);ae.call(this,true)}function Q(e,t,i,a,r){if(!this._getField()||!this.isOpen()){return}var n=false;n=W.call(this,t);n=z.call(this,e,i,a,r)||n;ae.call(this,true)}function X(){var e=this.getInParameters();var t=false;for(var i=0;i<e.length;i++){var a=e[i];var r=a.getHelpPath();var n=a.getValue();var s=a.getUseConditions();var l=a.getInitialValueFilterEmpty();t=W.call(this,r)||t;t=z.call(this,r,n,s,l)||t}if(t||this._bApplyFilter&&this._bPendingFilterUpdate){this._bPendingFilterUpdate=false;ae.call(this,true)}}T.prototype.onFieldChange=function(){var e=this.getOutParameters();Se.call(this);var n=R.call(this,e,false);l.resolve().then(function(){return E.call(this,n)}.bind(this)).then(function(){if(this.bIsDestroyed){return}var n=this.getConditions();for(var s=0;s<n.length;s++){var l=n[s];if(l.outParameters){for(var o in l.outParameters){for(var h=0;h<e.length;h++){var u=e[h];var d=u.getValue();var f=u.getUseConditions();var g=true;if(u.getMode()===a.WhenEmpty){if(f){g=!d||Array.isArray(d)&&d.length===0}else{g=!d}}if(g){if(f){var c;if(!u.getHelpPath()){c=t.createCondition("EQ",[u.getFixedValue()],undefined,undefined,r.NotValidated)}else if(u.getFieldPath()===o){c=t.createCondition("EQ",[l.outParameters[o]],undefined,undefined,r.Validated)}else{continue}if(!d){d=[]}if(!Array.isArray(d)){throw new Error("Value on OutParameter must be an array "+u)}if(i.indexOfCondition(c,d)<0){c.validated=r.Validated;d.push(c);u.setValue(d)}}else if(!u.getHelpPath()){u.setValue(u.getFixedValue())}else if(u.getFieldPath()===o){u.setValue(l.outParameters[o])}}}}}}}.bind(this)).unwrap()};function J(e){return Z.call(this,e,this.getInParameters())}function Y(e){return Z.call(this,e,this.getOutParameters())}function Z(e,t){if(!e||t.length===0){return null}var i={};for(var a=0;a<t.length;a++){var r=t[a];var n=r.getHelpPath();var s=r.getFieldPath();if(n&&s){for(var l in e){if(n===l){i[s]=e[l];break}}}else if(!n&&s&&r.getFixedValue){i[s]=r.getFixedValue()}}return i}function ee(e,t){return ie.call(this,e,this.getInParameters(),false,undefined,undefined,false,t)}function te(e,t,i){return ie.call(this,e,this.getOutParameters(),t,undefined,undefined,false,i)}function ie(e,i,a,s,l,o,h){var d;var f;var g;var c;var p=0;var v;if(i.length>0){if(!e){if(!a){var _=this.getBindingContext();for(p=0;p<i.length;p++){f=i[p];g=h?"conditions/"+f.getHelpPath():f.getHelpPath();var m=f.getValue();var b=f.getUseConditions();var y=f.getInitialValueFilterEmpty();var C=0;if(s||l){var F=f.getBinding("value");var P=false;if(F||b){c=f.getFieldPath();for(C=0;C<s.length;C++){if(F&&F.getPath()===s[C].getPath()||b&&s[C].getPath()==="/"+c){m=s[C].getValue();P=true;break}}if(!P&&!b&&l&&F&&F.isRelative()&&(!F.getContext()||F.getContext()!==l&&F.getContext()===_)){m=l.getProperty(F.getPath())}}}if(g){if(!d){d={}}if(o){d[g]=[];if(b){if(!m){m=[]}for(C=0;C<m.length;C++){v=u({},m[C]);if(v.inParameters){v.inParameters=ee.call(this,v.inParameters,true)}if(v.outParameters){v.outParameters=te.call(this,v.outParameters,false,true)}d[g].push(v)}}else{if(!m&&y){v=t.createCondition("Empty",[]);v.isEmpty=false}else if(m){v=t.createItemCondition(m);v.validated=r.Validated}if(v){d[g].push(v)}}v=undefined}else{if(b){if(m&&m.length>0){d[g]=m[0].values[0]}}else{d[g]=m}}}}}}else{for(var O in e){for(p=0;p<i.length;p++){f=i[p];g=h?"conditions/"+f.getHelpPath():f.getHelpPath();c=f.getFieldPath();if(c&&(c===O||c==="conditions/"+O)&&g){if(!d){d={}}if(o){d[g]=[];v=t.createItemCondition(e[O]);v.validated=r.Validated;d[g].push(v)}else{d[g]=e[O]}}}}}if(o){var S=this._getTypesForConditions(d);var I=n.createFilters(d,S);d=I}}return d}function ae(e){if(e){if(!this._iFilterTimer){this._iFilterTimer=setTimeout(function(){this._iFilterTimer=undefined;ae.call(this)}.bind(this),0)}return}else if(this._iFilterTimer){clearTimeout(this._iFilterTimer);this._iFilterTimer=undefined}if(!this.isOpen()&&!this._bNavigateRunning&&!this._bOpen||this._bClosing&&!this._bSwitchToDialog||!this._bApplyFilter){this._bPendingFilterUpdate=true;return}if(this._bFilterWaitingForBinding){return}var t=this.getInParameters();var i=R.call(this,t,false);var a=E.call(this,i);if(a instanceof Promise){a.then(function(){this._bFilterWaitingForBinding=false;ae.call(this,true)}.bind(this));this._bFilterWaitingForBinding=true;return}var r=this.getAggregation("_dialog");var s=(!r||!r.isOpen())&&!(this._bClosing&&this._bSwitchToDialog);var l=Te.call(this,s);if(l){var o=this._getFilterBar();var h;if(o){h=o.getInternalConditions()}else{h=this._oConditions}var u=this._getTypesForConditions(h);var d=n.createFilters(h,u,undefined,this.getCaseSensitive());var f=[];var g=h["$search"];var c;if(d){f.push(d)}if(g&&g.length>0){c=g[0].values[0]}l.applyFilters(f,c,o)}}T.prototype._getTypesForConditions=function(e){var t=this.getFilterBar();var i=this.getInParameters();var a;var r;if(t){a=n.createConditionTypesMapFromFilterBar(e,t)}else{a={};for(r in e){a[r]={type:null}}}for(r in a){if(!a[r].type){for(var s=0;s<i.length;s++){var l=i[s];if(l.getHelpPath()===r){a[r].type=l.getDataType();break}}}}return a};T.prototype.getMaxConditions=function(){if(this._oField&&this._oField.getMaxConditionsForHelp){return this._oField.getMaxConditionsForHelp()}else if(this._oField&&this._oField.getMaxConditions){return this._oField.getMaxConditions()}else{return 1}};T.prototype.getDisplay=function(){if(this._oField&&this._oField.getDisplay){return this._oField.getDisplay()}};T.prototype.getRequired=function(){if(this._oField&&this._oField.getRequired){return this._oField.getRequired()}else{return false}};T.prototype.getDataType=function(){if(this._oField.getDataType){return this._oField.getDataType()}else{return"sap.ui.model.type.String"}};T.prototype._getFormatOptions=function(){if(this._oField&&this._oField._getFormatOptions){return this._oField._getFormatOptions()}else{return{}}};T.prototype._getKeyPath=function(){var e=this.getKeyPath();if(!e&&this._oField&&this._oField.getFieldPath&&this._oField.getFieldPath()){e=this._oField.getFieldPath()}return e};T.prototype._getFilterBar=function(){var e=this.getFilterBar();if(!e){e=this.getAggregation("_filterBar")}return e};T.prototype.clone=function(t,i){var a=[this.getContent(),this.getSuggestContent(),this.getDialogContent()];var r=this.getFilterBar();var n=0;var s;for(n=0;n<a.length;n++){s=a[n];if(s){s.detachEvent("navigate",w,this);s.detachEvent("selectionChange",U,this);s.detachEvent("dataUpdate",q,this)}}if(r){r.detachEvent("search",me,this)}var l=e.prototype.clone.apply(this,arguments);for(n=0;n<a.length;n++){s=a[n];if(s){s.attachEvent("navigate",w,this);s.attachEvent("selectionChange",U,this);s.attachEvent("dataUpdate",q,this)}}if(r){r.attachEvent("search",me,this)}return l};function re(){var e;if((!b||!y||!C||!F||!P||!O||!S||!I||!D)&&!this._bDialogRequested){b=sap.ui.require("sap/m/Dialog");y=sap.ui.require("sap/m/Button");C=sap.ui.require("sap/ui/mdc/field/ValueHelpPanel");F=sap.ui.require("sap/ui/mdc/field/DefineConditionPanel");P=sap.ui.require("sap/ui/model/base/ManagedObjectModel");O=sap.ui.require("sap/ui/mdc/filterbar/vh/FilterBar");S=sap.ui.require("sap/ui/mdc/FilterField");I=sap.ui.require("sap/ui/mdc/filterbar/vh/CollectiveSearchSelect");D=sap.ui.require("sap/ui/core/Item");if(!b||!y||!C||!F||!P||!O||!S||!I||!D){sap.ui.require(["sap/m/Dialog","sap/m/Button","sap/ui/mdc/field/ValueHelpPanel","sap/ui/mdc/field/DefineConditionPanel","sap/ui/model/base/ManagedObjectModel","sap/ui/mdc/filterbar/vh/FilterBar","sap/ui/mdc/FilterField","sap/ui/mdc/filterbar/vh/CollectiveSearchSelect","sap/ui/core/Item"],le.bind(this));this._bDialogRequested=true}}if(b&&y&&C&&F&&P&&O&&S&&I&&D&&!this._bDialogRequested){if(!this._oResourceBundle){this._oResourceBundle=sap.ui.getCore().getLibraryResourceBundle("sap.ui.mdc")}var t=new y(this.getId()+"-ok",{text:this._oResourceBundle.getText("valuehelp.OK"),enabled:"{$help>/_enableOK}",type:A.Emphasized,press:fe.bind(this)});var i=new y(this.getId()+"-cancel",{text:this._oResourceBundle.getText("valuehelp.CANCEL"),press:ge.bind(this)});this._oManagedObjectModel=new P(this);var a=oe.call(this);e=new b(this.getId()+"-dialog",{contentHeight:ne(),contentWidth:se(),horizontalScrolling:false,verticalScrolling:false,title:"{$help>/title}",stretch:g.system.phone,resizable:true,draggable:true,content:[a],afterOpen:ce.bind(this),afterClose:pe.bind(this),buttons:[t,i]}).setModel(this._oManagedObjectModel,"$help");e.isPopupAdaptationAllowed=function(){return false};e.addStyleClass("sapMdcValueHelpTitle");this.setAggregation("_dialog",e,true);this.setModel(new d({bundleName:"sap/ui/mdc/messagebundle",async:false}),"$i18n");ve.call(this,this.getShowConditionPanel())}return e}function ne(){if(g.system.desktop){return"700px"}if(g.system.tablet){return g.orientation.landscape?"600px":"600px"}}function se(){if(g.system.desktop){return"1080px"}if(g.system.tablet){return g.orientation.landscape?"920px":"600px"}}function le(e,t,i,a,r,n,s,l,o){b=e;y=t;C=i;F=a;P=r;O=n;S=s;I=l;D=o;this._bDialogRequested=false;if(!this._bIsBeingDestroyed){re.call(this);if(this._bOpen){this.open()}}}function oe(){var e=Te.call(this,false);var t=this._getFilterBar();var i=new C(this.getId()+"-VHP",{height:"100%",showFilterbar:!!t,formatOptions:this._getFormatOptions(),inputOK:"{$help>/_enableOK}"});i.setModel(this._oManagedObjectModel,"$help");if(e){e.initialize(false);he.call(this,i,e.getDialogContent())}if(t){i.setFilterbar(t)}return i}function he(e,t){e.setTable(t)}function ue(e,t,i){var a=this.getAggregation("_popover");var r=this.getAggregation("_dialog");if(e==="remove"){t.detachEvent("navigate",w,this);t.detachEvent("selectionChange",U,this);t.detachEvent("dataUpdate",q,this);t=undefined}else{t.attachEvent("navigate",w,this);t.attachEvent("selectionChange",U,this);t.attachEvent("dataUpdate",q,this);k.call(this)}this.fireDataUpdate();if(this._bNavigate){this.navigate(this._iStep)}else if(a){a.invalidate();var n=this.getFilterValue();if(n){$.call(this,n)}X.call(this);if(t&&this._bOpenIfContent){t.initialize(true);var s=this._getField();if(s){t.fieldHelpOpen(true);a.openBy(this._getControlForSuggestion())}this._bOpenIfContent=false}}else if(t&&this._bOpenIfContent){this._bOpenIfContent=false;this.open(true)}if(r&&i!=="suggestContent"&&!(i==="content"&&this.getDialogContent())){if(t){t.initialize(false);var l=r.getContent()[0];l.setShowTokenizer(this.getMaxConditions()!==1);he.call(this,l,t.getDialogContent());if(r.isOpen()||this._bOpen){t.fieldHelpOpen(false)}}}}function de(){var e=this.getAggregation("_dialog");if(!e){e=re.call(this)}return e}function fe(e){this.close();var a=this.getConditions();a=t._removeEmptyConditions(a);a=t._removeInitialFlags(a);i.updateConditionsValues(a);this.setProperty("conditions",a,true);this._bOK=true}function ge(e){this.close();this.setProperty("conditions",this._aOldConditions,true)}function ce(e){this._bSwitchToDialog=false}function pe(e){var t=this.getConditions();this._bDialogOpen=false;this._aOldConditions=undefined;this._handleAfterClose(e);if(this._bOK){this.fireSelect({conditions:t,add:false,close:true})}this._bOK=undefined;this.setProperty("_enableOK",true,true)}function ve(e){var t=this.getAggregation("_dialog");if(t&&this._oField){var i=t.getContent()[0];if(e){if(!i._oDefineConditionPanel){var a=new F(this.getId()+"-DCP",{label:"{$help>/title}"});i.setDefineConditions(a)}}else{i.setDefineConditions()}}}function _e(e,t,i){if(e==="remove"){t.detachEvent("search",me,this);if(!i){var a=t.getBasicSearchField();if(a&&a._bCreadedByFVH){t.setBasicSearchField()}if(t.getCollectiveSearch&&t.getCollectiveSearch()){t.setCollectiveSearch()}}t=undefined}else{t.attachEvent("search",me,this);Be.call(this,false)}var r=this.getAggregation("_dialog");if(r){var n=r.getContent()[0];n.setFilterbar(t);n.setShowFilterbar(!!t);if(this.isOpen()){be.call(this);if(!i||e==="remove"){Pe.call(this,e==="remove")}}}}function me(e){var t=this._getFilterBar();if(t){var i=this.getFilterFields();if(i&&!this._bUpdateFilterAfterClose){var a=ye.call(this,i);var r=a.length>0?a[0].values[0]:"";if(r!==this.getFilterValue()){this.setProperty("filterValue",r,true)}}if(this._bApplyFilter||!this._bApplyFilter&&(e||t.getLiveMode())){this._bApplyFilter=true;ae.call(this,true)}}}function be(){var e=this._getFilterBar();if(e){e.setInternalConditions(Object.keys(e.getConditions()).reduce(function(e,t){e[t]=[];return e},{}))}$.call(this,this.getFilterValue());X.call(this)}function ye(e){var t=this._getFilterBar();var i;if(t){i=t.getInternalConditions()}else{i=this._oConditions}return i[e]||[]}function Ce(e,t){var i=this._getFilterBar();var a;if(i){a=i.getInternalConditions()}else{a=this._oConditions}if(!a[e]){a[e]=[]}a[e].push(t);if(i){i.setInternalConditions(a)}}function Fe(e){var t=this._getFilterBar();var i;if(t){i=t.getInternalConditions()}else{i=this._oConditions}if(i[e]&&i[e].length>0){i[e]=[]}if(t){t.setInternalConditions(i)}}function Pe(e){if(e){if(!this._iSearchFieldTimer){this._iSearchFieldTimer=setTimeout(function(){this._iSearchFieldTimer=undefined;Pe.call(this,false)}.bind(this),0)}return}else if(this._iSearchFieldTimer){clearTimeout(this._iSearchFieldTimer);this._iSearchFieldTimer=null}var t=this.getFilterFields();var i=Te.call(this,false);if(t&&i){var a=this._getFilterBar();if(!a){a=new O(this.getId()+"-FB",{liveMode:!i.isSuspended(),showGoButton:false});a.setInternalConditions(this._oConditions);this._oConditions={};this.setAggregation("_filterBar",a,true)}if(!a.getBasicSearchField()){if(!this._oSearchField){this._oSearchField=new S(this.getId()+"-search",{conditions:"{$filters>/conditions/"+t+"}",placeholder:"{$i18n>filterbar.SEARCH}",label:"{$i18n>filterbar.SEARCH}",maxConditions:1,width:"50%"});this._oSearchField._bCreadedByFVH=true}else{this._oSearchField.setConditions([])}a.setBasicSearchField(this._oSearchField)}}if(this._oSearchField&&!this._oSearchField.getParent()){this._oSearchField.destroy();delete this._oSearchField}}function Oe(){var e=Te.call(this,true);if(e){return e.getSuggestionContent()}}function Se(){var e=this._oField?this._oField.getBindingContext():null;this.setBindingContext(e);var t=this._getFormatOptions();if(t.conditionModel&&this.getModel(t.conditionModelName)!==t.conditionModel){this.setModel(t.conditionModel,t.conditionModelName)}}function Ie(){if(!this._oResourceBundleM){this._oResourceBundleM=sap.ui.getCore().getLibraryResourceBundle("sap.m")}return this._oResourceBundleM}T.prototype.getScrollDelegate=function(){var t=this.getAggregation("_dialog");if(t&&(t.isOpen()||t.oPopup.getOpenState()===B.OPENING)){var i=Te.call(this,false);var a=i&&i.getDialogContent();if(a&&a.getScrollDelegate){return a.getScrollDelegate()}else{return undefined}}else{return e.prototype.getScrollDelegate.apply(this,arguments)}};T.prototype._fireOpen=function(t){if(!this._bOpenHandled){return e.prototype._fireOpen.apply(this,arguments)}return true};T.prototype.getRoleDescription=function(e){if(!e||e===1){return null}else if(!Te.call(this,false)&&this.getShowConditionPanel()&&!this.getNoDialog()){return null}else{var t=Ie.apply(this);return t.getText("MULTICOMBOBOX_ARIA_ROLE_DESCRIPTION")}};T.prototype.getAriaHasPopup=function(){if(this.getNoDialog()){return"listbox"}else if(this.getShowConditionPanel()){return"dialog"}else{return"listbox"}};T.prototype.getValueHelpEnabled=function(){if(this.getNoDialog()){return false}else{return true}};T.prototype._getContenRequestProperties=function(e){var t={};var i=this.getCollectiveSearchItems();if(i.length>0){var a=this.getAggregation("_dialog");if(a&&a.isOpen()&&this._oCollectiveSearchSelect){var r=this._oCollectiveSearchSelect.getSelectedItemKey();t.collectiveSearchKey=r}else{t.collectiveSearchKey=i[0].getKey()}}return t};function De(){if(!this._oCollectiveSearchSelect){var e=new p(this.getId()+"-collSearchItem",{key:"{$help>key}",text:"{$help>text}",textDirection:"{$help>textDirection}"});this._oCollectiveSearchSelect=new I(this.getId()+"-collSearch",{title:"{$i18n>COL_SEARCH_SEL_TITLE}",items:{path:"$help>/collectiveSearchItems",template:e},select:Ae.bind(this)}).setModel(this._oManagedObjectModel,"$help")}return this._oCollectiveSearchSelect}function Ae(e){var t=function(){ae.call(this,true)}.bind(this);this.setProperty("filterValue","",true);var i=this._callContentRequest(false,t);if(i){t()}}function Be(e){var t=this.getAggregation("_dialog");var i=this._getFilterBar();if(t&&i){var a=this.getCollectiveSearchItems();if(a.length<=1){if(i.getCollectiveSearch&&i.getCollectiveSearch()){i.setCollectiveSearch()}}else{if(i.getCollectiveSearch&&!i.getCollectiveSearch()){i.setCollectiveSearch(De.call(this))}if(e&&this._oCollectiveSearchSelect){this._oCollectiveSearchSelect.setSelectedItemKey(a[0].getKey())}}}}function Te(e){var t;if(e){t=this.getSuggestContent()}else{t=this.getDialogContent()}if(!t){t=this.getContent()}return t}return T});
//# sourceMappingURL=FieldValueHelp.js.map