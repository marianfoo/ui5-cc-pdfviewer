/*!
 * OpenUI5
 * (c) Copyright 2009-2023 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/mdc/field/FieldValueHelpContentWrapperBase","sap/ui/model/ChangeReason","sap/ui/model/Filter","sap/ui/model/FormatException","sap/ui/model/ParseException","sap/ui/model/FilterType","sap/ui/model/FilterOperator","sap/ui/model/FilterProcessor","sap/ui/base/ManagedObjectObserver","sap/base/strings/capitalize","sap/m/library","sap/base/util/deepEqual","sap/base/Log","sap/ui/base/SyncPromise"],function(e,t,i,a,r,s,n,o,l,h,u,p,d,f){"use strict";var g=e.extend("sap.ui.mdc.field.FieldValueHelpTableWrapperBase",{metadata:{library:"sap.ui.mdc",aggregations:{table:{type:"sap.ui.core.Control",multiple:false}},defaultAggregation:"table"}});g.prototype.init=function(){e.prototype.init.apply(this,arguments);this._oObserver=new l(this._observeChanges.bind(this));this._oObserver.observe(this,{properties:["selectedItems"],aggregations:["table"]});this._bTableResolved=false;this._oTablePromise=new Promise(function(e){this._oTablePromiseResolve=e}.bind(this));this._oResourceBundle=sap.ui.getCore().getLibraryResourceBundle("sap.ui.mdc");this._oPromises={};this._oTableDelegate={onsapprevious:this._handleTableEvent,onsapnext:this._handleTableEvent,cellClick:this._handleTableEvent};this._iRunningTableSelectionUpdates=0};g.prototype.exit=function(){this._sTableWidth=null;this._oObserver.disconnect();this._oObserver=undefined;if(this._oTableModificationPromise){this._oTableModificationPromise=null}delete this._oTablePromise;delete this._oTablePromiseResolve;delete this._bTableResolved;this._iRunningTableSelectionUpdates=null;e.prototype.exit.apply(this,arguments)};g.prototype.invalidate=function(t){if(t){var i=this._getWrappedTable();if(i&&t===i){if(t.bOutput&&!this._bIsBeingDestroyed){var a=this.getParent();if(a){a.invalidate(this)}}return}}e.prototype.invalidate.apply(this,arguments)};g.prototype.getDialogContent=function(){return this._getWrappedTable()};g.prototype.getSuggestionContent=function(){return this._getWrappedTable()};g.prototype.fieldHelpOpen=function(t){e.prototype.fieldHelpOpen.apply(this,arguments);var i=this._getWrappedTable();if(i){this._adjustTable(t);this._updateSelectedItems()}return this};g.prototype.fieldHelpClose=function(){e.prototype.fieldHelpClose.apply(this,arguments);var t=this._getWrappedTable();if(t){t.removeStyleClass("sapMListFocus")}return this};g.prototype.removeFocus=function(){e.prototype.removeFocus.apply(this,arguments);var t=this._getWrappedTable();if(t){t.removeStyleClass("sapMListFocus")}return this};g.prototype.navigate=function(e,t){var i=this._getWrappedTable();if(!this._isTableReady(i)){if(i&&!this._bTableResolved&&!this._bNavigationDelayed){this._bNavigationDelayed=true;this._oTablePromise.then(function(){this.fireNavigate({disableFocus:true});this._bNavigationDelayed=false}.bind(this))}this._bNavigate=true;this._iStep=e;return}var a=this.getSelectedItems();var r=a&&a[0];var s=r&&this._getTableItemByKey(r.key);if(this._getMaxConditions()!==1){this._bShouldRebind=false;this.fireNavigate();i.focus();return}i.addStyleClass("sapMListFocus");var n=this._getTableItems();var o=n.length;var l=0;var h=false;if(s){l=n.indexOf(s);l=l+e}else if(e>=0){l=e-1}else{l=o+e}var u;if(l<0){l=0;u=true;h=true}else if(l>=o-1){l=o-1;u=false}else{u=e>=0}while(n[l]&&n[l].isA("sap.m.GroupHeaderListItem")){if(u){l++}else{l--}}var p=n[l];if(p){var d=this._getDataFromItem(p);var g=p===s;if(!g){this._modifyTableSelection(n,p,true,undefined,true)}f.resolve(this._handleScrolling(p)).then(function(e){var t=p.getId&&p.getId();if(g){if(!this.getParent().isOpen()){this.fireNavigate({key:d.key,description:d.description,inParameters:d.inParameters,outParameters:d.outParameters,itemId:t,leave:h})}else if(h){this.fireNavigate({key:undefined,value:undefined,condition:undefined,itemId:undefined,leave:h})}return}this._bNoTableUpdate=true;this.setSelectedItems([{key:d.key,description:d.description,inParameters:d.inParameters,outParameters:d.outParameters}]);this._bNoTableUpdate=false;if(!t&&p.isA("sap.ui.model.Context")){var i=this._getTableItems(false,true).find(function(e){return e.getBindingContext()===p});t=i&&i.getId()}if(t){this.fireNavigate({key:d.key,description:d.description,inParameters:d.inParameters,outParameters:d.outParameters,itemId:t,leave:h})}else{this.fireNavigate({disableFocus:true})}}.bind(this))}};g.prototype.getTextForKey=function(e,t,i,a,r){return c.call(this,[e],["key"],t,i,a,r)};g.prototype.getKeyForText=function(e,t,i,a){return c.call(this,[e],["description"],t,undefined,i,a)};g.prototype.getKeyAndText=function(e,t,i,a,r){return c.call(this,[e,t],["key","description"],i,a,false,r)};function c(e,t,i,s,n,o){if((e[0]===null||e[0]===undefined||t[0]==="description"&&e[0]==="")&&(e.length===1||!e[1])){return null}return b.call(this).then(function(l){var h=t.length>1||t[0]==="description"?r:a;var u=[t[0]==="description"?this._getDescriptionPath:this._getKeyPath];if(t.length>1){u.push(t[1]==="description"?this._getDescriptionPath:this._getKeyPath)}if(l&&this._getKeyPath()){var p=this._getTableItems();var d=v.call(this,e,p,u,i,s,h,o);if(d){return d}}if(n){throw new h(this._oResourceBundle.getText("valuehelp.VALUE_NOT_EXIST",[e[0]]))}else{return this.loadData(u,e,i,s,h,o)}}.bind(this)).unwrap()}function v(e,t,a,r,s,l,h){var u=0;var p=[];for(u=0;u<a.length;u++){p.push(a[u].call(this));if(!p[u]){throw new Error("path for filter missing")}}var d=function(e,t){var i=e.isA("sap.ui.model.Context")?e:e.getBindingContext();return i.getProperty(t)};var f;var g=[];for(u=0;u<e.length;u++){g.push(new i({path:p[u],operator:n.EQ,value1:e[u],caseSensitive:h}))}if(g.length===1){f=g[0]}else{f=new i({filters:g,and:false})}if(r||s){g=[f];if(r){g.push(r)}if(s){g.push(s)}f=new i({filters:g,and:true})}var c=o.apply(t,f,d);if(c.length===1){var _=this._getDataFromItem(c[0]);return{key:_.key,description:_.description,inParameters:_.inParameters,outParameters:_.outParameters}}else if(c.length>1){if(!h){return v.call(this,e,t,a,r,s,l,true)}throw m.call(this,l,true,e[0])}}g.prototype.loadData=function(e,t,a,r,s,o){var l="";var h=0;for(h=0;h<e.length;h++){l=l+e[h].call(this)}if(this._oPromises[l]&&this._oPromises[l][t[0]]){return this._oPromises[l][t[0]]}if(!this._oPromises[l]){this._oPromises[l]={}}this._oPromises[l][t[0]]=new Promise(function(u,p){this._oTablePromise.then(function(d){var f=l;l="";for(h=0;h<e.length;h++){l=l+e[h].call(this)}if(!l){p(new Error("missing FieldPath"));return}if(l!==f){if(!this._oPromises[l]){this._oPromises[l]={}}this._oPromises[l][t[0]]=this._oPromises[f][t[0]];delete this._oPromises[f][t[0]]}var g=this.getListBinding();var c=g.getModel();var v=g.getPath();var _;var b=g.getContext();var y=[];for(h=0;h<e.length;h++){y.push(new i({path:e[h].call(this),operator:n.EQ,value1:t[h],caseSensitive:o}))}if(y.length===1){_=y[0]}else{_=new i({filters:y,and:false})}y=[];if(a){y.push(a)}if(r){if(a){var P=r.aFilters?r.aFilters:[r];var T=a.aFilters?a.aFilters:[a];for(h=0;h<P.length;h++){var S=P[h];var I=false;for(var F=0;F<T.length;F++){var C=T[F];if(C.sPath===S.sPath&&C.oValue1===S.oValue1&&C.oValue2===S.oValue2){I=true;break}}if(!I){y.push(S)}}}else{y.push(r)}}if(y.length>0){y.push(_);_=new i({filters:y,and:true})}try{var x=c.bindList(v,b);var D=function(){var e=x.getContexts();if(e.length===1){var i=this._getDataFromContext(e[0]);var a={key:i.key,description:i.description,inParameters:i.inParameters,outParameters:i.outParameters};u(a)}else if(t[0]===""&&e.length===0){u(null)}else{var r=m.call(this,s,e.length>1,t[0]);p(r)}setTimeout(function(){x.destroy()},0);delete this._oPromises[l][t[0]]};var B=this._getDelegate();if(B.delegate){B.delegate.executeFilter(B.payload,x,_,D.bind(this),2)}}catch(e){p(e)}}.bind(this))}.bind(this));return this._oPromises[l][t[0]]};function m(e,t,i){var a;if(t){a=this._oResourceBundle.getText("valuehelp.VALUE_NOT_UNIQUE",[i])}else{a=this._oResourceBundle.getText("valuehelp.VALUE_NOT_EXIST",[i])}var r=new e(a);r._bNotUnique=t;return r}g.prototype.getAsyncKeyText=function(){return true};g.prototype.applyFilters=function(e,t,i){var a=this.getListBinding();var r=this._getDelegate();if(!a){this._oTablePromise.then(function(a){if(!this._bIsBeingDestroyed){this.applyFilters(e,t,i)}}.bind(this));return}var n=true;var o;try{o=a.getFilterInfo()}catch(e){d.info("ValueHelp-Filter: getFilterInfo threw error")}if(!e){e=[]}if(e.length===0&&!o){n=false}if(r.delegate&&r.delegate.isSearchSupported(r.payload,a)){if(!a.isSuspended()&&n){a.suspend()}t=r.delegate.adjustSearch(r.payload,this._bSuggestion,t);r.delegate.executeSearch(r.payload,a,t);d.info("ValueHelp-Search: "+t)}if(n){a.filter(e,s.Application);d.info("ValueHelp-Filter: "+_.call(this,e))}if(a.isSuspended()){a.resume()}};g.prototype.isSuspended=function(){var e=this.getListBinding();if(!e){return true}return e.isSuspended()};function _(e){var t;if(!e){return""}if(Array.isArray(e)){t="";e.forEach(function(e,i,a){t+=_.call(this,e);if(a.length-1!=i){t+=" or "}},this);return"("+t+")"}else if(e._bMultiFilter){t="";var i=e.bAnd;e.aFilters.forEach(function(e,a,r){t+=_.call(this,e);if(r.length-1!=a){t+=i?" and ":" or "}},this);return"("+t+")"}else{t=e.sPath+" "+e.sOperator+" '"+e.oValue1+"'";if(e.sOperator==="BT"){t+="...'"+e.oValue2+"'"}return t}}g.prototype.clone=function(t,i){this._handleEvents();var a=e.prototype.clone.apply(this,arguments);this._handleEvents(true);return a};g.prototype._observeChanges=function(e){if(e.name==="table"){this._handleTableChanged.call(this,e.mutation,e.child)}if(e.name==="selectedItems"){this._updateSelectedItems.call(this)}};g.prototype._handleTableChanged=function(e,t){if(e==="remove"){this._handleEvents();t.removeDelegate(this._oTableDelegate);t.removeStyleClass("sapMComboBoxList");t=undefined;this._oTablePromise=new Promise(function(e){this._oTablePromiseResolve=function(){e();this._bTableResolved=true}}.bind(this))}else{this._handleEvents(true);t.addDelegate(this._oTableDelegate,true,this);this._updateSelectedItems();if(this._bNavigate){this._bNavigate=false;this.navigate(this._iStep)}t.addStyleClass("sapMComboBoxList")}this.fireDataUpdate({contentChange:true})};g.prototype._handleModelContextChange=function(e){var t=this._getWrappedTable();if(this.getListBinding()){this._oTablePromiseResolve(t)}};g.prototype._adjustTable=function(e){var t=this.getTable();if(t&&this.getParent()){if(e){if(this._sTableWidth){t.setWidth(this._sTableWidth)}}else if(t.getWidth()!=="100%"){this._sTableWidth=t.getWidth();t.setWidth("100%")}}};g.prototype._fireSelectionChange=function(e){var t=[];var i=this._getWrappedTable();if(i){var a=this.getSelectedItems();var r;var s;if(a.length>0){var n=this._getTableItems();for(var o=0;o<n.length;o++){r=n[o];s=this._getDataFromItem(r);if(!s){throw new Error("Key of item cannot be determined"+this)}for(var l=a.length-1;l>=0;l--){var h=a[l];if(h.key===s.key&&(!s.inParameters||!h.inParameters||p(h.inParameters,s.inParameters))&&(!s.outParameters||!h.outParameters||p(h.outParameters,s.outParameters))){a.splice(l,1);break}}if(!a.length){break}}}if(a.length>0){t=a}a=this._getTableItems(true);for(var u=0;u<a.length;u++){r=a[u];s=this._getDataFromItem(r);if(!s){throw new Error("Key of item cannot be determined"+this)}t.push({key:s.key,description:s.description,inParameters:s.inParameters,outParameters:s.outParameters})}}this._bNoTableUpdate=true;this.setSelectedItems(t);this._bNoTableUpdate=false;this.fireSelectionChange({selectedItems:t,itemPress:e})};g.prototype._handleUpdateFinished=function(e){if(!this.getParent()){return}this._updateSelectedItems.call(this);if(this._bNavigate){this._bNavigate=false;this.navigate(this._iStep)}if(e.getParameter("reason")!==h(t.Filter)){this.fireDataUpdate({contentChange:false})}};g.prototype._handleBusyStateChanged=function(e){this._bBusy=e.getParameter("busy")};g.prototype._updateSelectedItems=function(){if(this._bNoTableUpdate){return}var e=[];var t=this._getWrappedTable();if(this._isTableReady(t)&&this._getKeyPath()){var i=this.getSelectedItems();var a=this._getTableItems();var r=false;this._iRunningTableSelectionUpdates=this._iRunningTableSelectionUpdates+1||1;for(var s=0;s<a.length;s++){var n=a[s];if(n){var o=false;if(i.length>0){var l=this._getDataFromItem(n);for(var h=0;h<i.length;h++){var u=i[h];if(l.key===u.key&&(!l.inParameters||!u.inParameters||p(u.inParameters,l.inParameters))&&(!l.outParameters||!u.outParameters||p(u.outParameters,l.outParameters))){o=true;if(l.description!==u.description){u.description=l.description;r=true}break}}}e.push(this._modifyTableSelection(a,n,o,s))}}if(r){this._bNoTableUpdate=true;this.setSelectedItems(i);this._bNoTableUpdate=false}this._oTableModificationPromise=Promise.all(e).then(function(){this._iRunningTableSelectionUpdates=this._iRunningTableSelectionUpdates-1}.bind(this))}};g.prototype._getDataFromItem=function(e,t,i){var a=e.isA("sap.ui.model.Context")?e:e.getBindingContext();return a&&this._getDataFromContext.call(this,a,t,i)};g.prototype._getDataFromContext=function(e,t,i){var a=this._getKeyPath();var r=this._getDescriptionPath();var s;var n;if(!a){throw new Error("KeyPath missing")}if(!t){t=this._getInParameters()}if(!i){i=this._getOutParameters()}var o=t.length>0?{}:null;var l=i.length>0?{}:null;var h;if(e){s=a?e.getProperty(a):undefined;n=r?e.getProperty(r):undefined;var u=0;for(u=0;u<t.length;u++){h=t[u];o[h]=e.getProperty(h)}for(u=0;u<i.length;u++){h=i[u];l[h]=e.getProperty(h)}}if(s===null||s===undefined){return false}return{key:s,description:n,inParameters:o,outParameters:l}};g.prototype._isTableReady=function(){var e=this._getWrappedTable();var t=e&&this.getListBinding();if(!e||!t){return false}if(t&&(t.isSuspended()||t.getLength()===0)){return false}return true};function b(){return f.resolve().then(function(){var e=this.getListBinding();var t=this._getListBindingInfo();var i=this._getDelegate();if(e&&i.delegate){return i.delegate.checkListBindingPending(i.payload,e,t)}else{return false}}.bind(this)).catch(function(e){throw e})}g.prototype._handleItemPress=function(e){};g.prototype._handleSelectionChange=function(e,t){};g.prototype._getTableItems=function(e,t){return[]};g.prototype._getTableItemByKey=function(e,t){var i=this._getTableItems(undefined,t);return i&&i.find(function(t){var i=this._getDataFromItem(t);return i.key===e}.bind(this))};g.prototype._handleTableEvent=function(e){};g.prototype._modifyTableSelection=function(e,t,i,a,r){};g.prototype._getWrappedTable=function(){return this.getTable()};g.prototype._handleEvents=function(e){};g.prototype._handleScrolling=function(e){};g.prototype.getListBinding=function(){};g.prototype._getListBindingInfo=function(){};return g});
//# sourceMappingURL=FieldValueHelpTableWrapperBase.js.map