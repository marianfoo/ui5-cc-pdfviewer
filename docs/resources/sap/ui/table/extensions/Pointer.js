/*!
 * OpenUI5
 * (c) Copyright 2009-2023 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["./ExtensionBase","../utils/TableUtils","../library","sap/ui/Device","sap/ui/core/Popup","sap/base/Log","sap/ui/thirdparty/jquery","sap/ui/dom/jquery/scrollLeftRTL","sap/ui/dom/jquery/control"],function(e,t,i,o,n,l,jQuery){"use strict";var s=i.SelectionMode;var r=["sapMBtnBase","sapMInputBase","sapMLnk","sapMSlt","sapMCb","sapMRI","sapMSegBBtn","sapUiIconPointer","sapMBtnIcon","sapMObjStatusActive"];var a={_getEventPosition:function(e,t){var i;function o(i){if(!t._isTouchEvent(i)){return null}var o=["touches","targetTouches","changedTouches"];for(var n=0;n<o.length;n++){var l=o[n];if(e[l]&&e[l][0]){return e[l][0]}if(e.originalEvent[l]&&e.originalEvent[l][0]){return e.originalEvent[l][0]}}return null}i=o(e)||e;return{x:i.pageX,y:i.pageY}},_skipClick:function(e,i,o){if(!o.isOfType(t.CELLTYPE.DATACELL|t.CELLTYPE.ROWACTION)){return false}if(e.isMarked()){return true}var n=i.control(0);if(n){var l=n.$();if(l.length){for(var s=0;s<r.length;s++){if(l.hasClass(r[s])){return typeof n.getEnabled==="function"?n.getEnabled():true}}}}return false},_handleClickSelection:function(e,i,o){t.toggleRowSelection(o,i,null,function(t){var i=o._getSelectionPlugin();var n=o.getSelectionMode();if(n===s.Single){if(!i.isIndexSelected(t)){i.setSelectedIndex(t)}else{i.clearSelection()}}else if(e.shiftKey){var l=i.getSelectedIndex();if(l>=0){i.addSelectionInterval(l,t)}else if(i.getSelectedCount()===0){i.setSelectedIndex(t)}}else if(!o._legacyMultiSelection){if(!i.isIndexSelected(t)){i.addSelectionInterval(t,t)}else{i.removeSelectionInterval(t,t)}}else{o._legacyMultiSelection(t,e)}return true})}};var d={initColumnResizing:function(e,t){if(e._bIsColumnResizerMoving){return}e._bIsColumnResizerMoving=true;e._bColumnResizerMoved=false;e._iColumnResizeStart=a._getEventPosition(t,e).x;e.$().toggleClass("sapUiTableResizing",true);var i=jQuery(document);var o=e._isTouchEvent(t);e._$colResize=e.$("rsz");i.on((o?"touchend":"mouseup")+".sapUiTableColumnResize",d.exitColumnResizing.bind(e));i.on((o?"touchmove":"mousemove")+".sapUiTableColumnResize",d.onMouseMoveWhileColumnResizing.bind(e));e._disableTextSelection()},exitColumnResizing:function(e){var i=a._getEventPosition(e,this).x;var o=this._getVisibleColumns()[this._iLastHoveredVisibleColumnIndex];var n=this.$().find('th[data-sap-ui-colid="'+o.getId()+'"]');var l=n[0].offsetWidth;var s=i-(n.offset().left+(this._bRtlMode?0:l));var r=Math.round(l+s*(this._bRtlMode?-1:1));var u=Math.max(r,t.Column.getMinColumnWidth());d._resizeColumn(this,this._iLastHoveredVisibleColumnIndex,this._bColumnResizerMoved?u:null)},onMouseMoveWhileColumnResizing:function(e){var t=a._getEventPosition(e,this).x;var i=this.$().find(".sapUiTableCnt").offset().left;var o=Math.floor(t-i);if(!this._bColumnResizerMoved&&Math.abs(t-this._iColumnResizeStart)>=5){this._bColumnResizerMoved=true}this._$colResize.css("left",o+"px");this._$colResize.toggleClass("sapUiTableColRszActive",true);if(this._isTouchEvent(e)){e.stopPropagation();e.preventDefault()}},_cleanupColumResizing:function(e){if(e._$colResize){e._$colResize.toggleClass("sapUiTableColRszActive",false);e._$colResize=null}e._bIsColumnResizerMoving=false;e.$().toggleClass("sapUiTableResizing",false);e._enableTextSelection();var t=jQuery(document);t.off("touchmove.sapUiTableColumnResize");t.off("touchend.sapUiTableColumnResize");t.off("mousemove.sapUiTableColumnResize");t.off("mouseup.sapUiTableColumnResize")},_resizeColumn:function(e,i,o){var n=e._getVisibleColumns();var l;if(i>=0&&i<n.length){l=n[i];if(o!=null){t.Column.resizeColumn(e,e.indexOfColumn(l),o)}}d._cleanupColumResizing(e);l.focus()},doAutoResizeColumn:function(e,t){var i=e._getVisibleColumns(),o;if(t>=0&&t<i.length){o=i[t];if(!o.getAutoResizable()||!o.getResizable()){return}var n=d._calculateAutomaticColumnWidth.apply(e,[o,t]);if(n){d._resizeColumn(e,t,n)}}},_calculateAutomaticColumnWidth:function(e,i){e=e||this.getColumns()[i];var o=this.$();var n=jQuery("<div>").addClass("sapUiTableHiddenSizeDetector sapUiTableHeaderDataCell sapUiTableDataCell");o.append(n);var l=o.find('td[data-sap-ui-colid = "'+e.getId()+'"]:not([colspan])').filter(function(e,t){return t.style.display!="none"}).children().clone();l.removeAttr("id");var s=n.append(l).width()+4;s=Math.min(s,o.find(".sapUiTableCnt").width());s=Math.max(s+4,t.Column.getMinColumnWidth());n.remove();return s},initColumnTracking:function(e){e.$().find(".sapUiTableCtrlScr, .sapUiTableCtrlScrFixed").on("mousemove",function(e){var t=this.getDomRef();if(!t||this._bIsColumnResizerMoving){return}var i=e.clientX,o=t.getBoundingClientRect(),n=0,l=this._bRtlMode?1e4:-1e4;for(var s=0;s<this._aTableHeaders.length;s++){var r=this._aTableHeaders[s].getBoundingClientRect();if(this._bRtlMode){if(i<r.right-5&&i>=r.left){n=s;l=r.left-o.left;break}}else{if(i>r.left+5&&i<=r.right){n=s;l=r.right-o.left;break}}}var a=this._getVisibleColumns()[n];if(a&&a.getResizable()){this.$("rsz").css("left",l+"px");this._iLastHoveredVisibleColumnIndex=n}}.bind(e))}};var u={initReordering:function(e,i,o){var l=e.getColumns()[i],s=l.$(),r=e.$();e._disableTextSelection();r.addClass("sapUiTableDragDrop");var a=s.clone();a.find("*").addBack(a).removeAttr("id").removeAttr("data-sap-ui").removeAttr("tabindex");a.attr("id",e.getId()+"-roghost").addClass("sapUiTableColReorderGhost").css({left:-1e4,top:-1e4,"z-index":n.getNextZIndex()});a.toggleClass(t.getContentDensity(e),true);a.appendTo(document.body);e._$ReorderGhost=e.getDomRef("roghost");r.find("td[data-sap-ui-colid='"+l.getId()+"']").toggleClass("sapUiTableColReorderFade",true);var d=jQuery("<div id='"+e.getId()+"-roind' class='sapUiTableColReorderIndicator'><div class='sapUiTableColReorderIndicatorArrow'></div><div class='sapUiTableColReorderIndicatorInner'></div></div>");d.appendTo(e.getDomRef("sapUiTableCnt"));e._$ReorderIndicator=e.getDomRef("roind");e._iDnDColIndex=i;var f=jQuery(document),h=e._isTouchEvent(o);f.on((h?"touchend":"mouseup")+".sapUiColumnMove",u.exitReordering.bind(e));f.on((h?"touchmove":"mousemove")+".sapUiColumnMove",u.onMouseMoveWhileReordering.bind(e))},onMouseMoveWhileReordering:function(e){var i=a._getEventPosition(e,this),o=i.x,n=i.y,l=this._iNewColPos;this._iNewColPos=this._iDnDColIndex;e.preventDefault();var s=u.findColumnForPosition(this,o);if(!s||!s.id){this._iNewColPos=l;return}var r=40,d=this.getDomRef("sapUiTableColHdrScr"),f=jQuery(d),h=d.getBoundingClientRect(),c=f.outerWidth(),C=this._bRtlMode?f.scrollLeftRTL():f.scrollLeft();this._bReorderScroll=false;if(o>h.left+c-r&&C+c<d.scrollWidth){this._bReorderScroll=true;u.doScroll(this,!this._bRtlMode);u.adaptReorderMarkerPosition(this,s,false)}else if(o<h.left+r&&C>0){this._bReorderScroll=true;u.doScroll(this,this._bRtlMode);u.adaptReorderMarkerPosition(this,s,false)}jQuery(this._$ReorderGhost).css({left:o+5,top:n+5});if(this._bReorderScroll||!s){return}if(s.before||s.after&&s.index==this._iDnDColIndex){this._iNewColPos=s.index}else if(s.after&&s.index!=this._iDnDColIndex){this._iNewColPos=s.index+1}if(!t.Column.isColumnMovableTo(this.getColumns()[this._iDnDColIndex],this._iNewColPos)){this._iNewColPos=l}else{u.adaptReorderMarkerPosition(this,s,true)}},exitReordering:function(e){var i=this._iDnDColIndex;var o=this._iNewColPos;var n=jQuery(document);n.off("touchmove.sapUiColumnMove");n.off("touchend.sapUiColumnMove");n.off("mousemove.sapUiColumnMove");n.off("mouseup.sapUiColumnMove");this._bReorderScroll=false;this.$().removeClass("sapUiTableDragDrop");delete this._iDnDColIndex;delete this._iNewColPos;jQuery(this._$ReorderGhost).remove();delete this._$ReorderGhost;jQuery(this._$ReorderIndicator).remove();delete this._$ReorderIndicator;this.$().find(".sapUiTableColReorderFade").removeClass("sapUiTableColReorderFade");this._enableTextSelection();t.Column.moveColumnTo(this.getColumns()[i],o)},findColumnForPosition:function(e,t){var i,o,n,l,s,r,a;for(var d=0;d<e._aTableHeaders.length;d++){i=e._aTableHeaders[d];o=jQuery(i);n=i.getBoundingClientRect();l=o.outerWidth();s={left:n.left,center:n.left+l/2,right:n.left+l,width:l,index:parseInt(o.attr("data-sap-ui-headcolindex")),id:o.attr("data-sap-ui-colid")};r=t>=s.left&&t<=s.center;a=t>=s.center&&t<=s.right;if(r||a){s.before=e._bRtlMode?a:r;s.after=e._bRtlMode?r:a;return s}}return null},doScroll:function(e,t){if(e._mTimeouts.horizontalReorderScrollTimerId){window.clearTimeout(e._mTimeouts.horizontalReorderScrollTimerId);e._mTimeouts.horizontalReorderScrollTimerId=null}if(e._bReorderScroll){var i=t?30:-30;if(e._bRtlMode){i=-1*i}e._mTimeouts.horizontalReorderScrollTimerId=setTimeout(u.doScroll.bind(e,e,t),60);var o=e.$("sapUiTableColHdrScr");var n=e._bRtlMode?"scrollLeftRTL":"scrollLeft";o[n](o[n]()+i)}},adaptReorderMarkerPosition:function(e,t,i){if(!t||!e._$ReorderIndicator){return}var o=t.left-e.getDomRef().getBoundingClientRect().left;if(e._bRtlMode&&t.before||!e._bRtlMode&&t.after){o=o+t.width}jQuery(e._$ReorderIndicator).css({left:o+"px"}).toggleClass("sapUiTableColReorderIndicatorActive",i)}};var f={ROWAREAS:[".sapUiTableRowSelectionCell",".sapUiTableRowActionCell",".sapUiTableCtrlFixed > tbody > .sapUiTableTr",".sapUiTableCtrlScroll > tbody > .sapUiTableTr"],initRowHovering:function(e){var t=e.$();for(var i=0;i<f.ROWAREAS.length;i++){f._initRowHoveringForArea(e,t,f.ROWAREAS[i])}},_initRowHoveringForArea:function(e,t,i){t.find(i).on("mouseenter",function(){f._onHover(e,t,i,this)}).on("mouseleave",function(){f._onUnhover(e,t,i,this)})},_onHover:function(e,t,i,o){var n=t.find(i).index(o);var l=e.getRows()[n];if(l){l._setHovered(true)}},_onUnhover:function(e,t,i,o){var n=t.find(i).index(o);var l=e.getRows()[n];if(l){l._setHovered(false)}}};var h={onmousedown:function(e){var i=this._getPointerExtension();var n=t.getCell(this,e.target);var l=t.getCellInfo(n);var s=jQuery(e.target);var r;var u;var f;this._getKeyboardExtension().initItemNavigation();if(e.button===0){if(e.target===this.getDomRef("rsz")){e.preventDefault();e.stopPropagation();d.initColumnResizing(this,e)}else if(s.hasClass("sapUiTableColResizer")){var h=s.closest(".sapUiTableHeaderCell").attr("data-sap-ui-colindex");this._iLastHoveredVisibleColumnIndex=this._getVisibleColumns().indexOf(this.getColumns()[h]);d.initColumnResizing(this,e)}else if(l.isOfType(t.CELLTYPE.COLUMNHEADER)){r=this.getColumns()[l.columnIndex];u=r.getAggregation("menu");f=u&&u.bOpen;if(!f){i._bShowMenu=true;this._mTimeouts.delayedMenuTimerId=setTimeout(function(){delete i._bShowMenu},200)}if(this.getEnableColumnReordering()&&!(this._isTouchEvent(e)&&s.hasClass("sapUiTableColDropDown"))){this._getPointerExtension().doReorderColumn(l.columnIndex,e)}}if(o.browser.firefox&&(e.metaKey||e.ctrlKey)||s.closest(".sapUiTableHSb",this.getDomRef()).length===1||s.closest(".sapUiTableVSb",this.getDomRef()).length===1){e.preventDefault()}}if(e.button===2){if(a._skipClick(e,s,l)){i._bShowDefaultMenu=true;return}if(l.isOfType(t.CELLTYPE.COLUMNHEADER)){r=this.getColumns()[l.columnIndex];u=r.getAggregation("menu");f=u&&u.bOpen;if(!f){i._bShowMenu=true}else{i._bHideMenu=true}}else if(l.isOfType(t.CELLTYPE.ANYCONTENTCELL)){i._bShowMenu=true}else{i._bShowDefaultMenu=true}}},onmouseup:function(e){clearTimeout(this._mTimeouts.delayedColumnReorderTimerId)},ondblclick:function(e){if(o.system.desktop&&e.target===this.getDomRef("rsz")){e.preventDefault();d.doAutoResizeColumn(this,this._iLastHoveredVisibleColumnIndex)}},onclick:function(e){clearTimeout(this._mTimeouts.delayedColumnReorderTimerId);if(e.isMarked()){return}var i=jQuery(e.target);var o=t.getCell(this,e.target);var n=t.getCellInfo(o);var s=this.getRows()[n.rowIndex];if(!n.isOfType(t.CELLTYPE.ANY)){return}if(n.isOfType(t.CELLTYPE.COLUMNHEADER)){var r=this._getPointerExtension();var d=this.getColumns()[n.columnIndex];if(r._bShowMenu&&!d._isMenuOpen()){t.Menu.openContextMenu(this,e.target);delete r._bShowMenu}}else if(s&&s.isSummary()){e.preventDefault()}else if(i.hasClass("sapUiTableGroupMenuButton")){t.Menu.openContextMenu(this,e.target,e)}else if(i.hasClass("sapUiTableGroupIcon")||i.hasClass("sapUiTableTreeIcon")){s.toggleExpandedState()}else{if(a._skipClick(e,i,n)){return}if(n.isOfType(t.CELLTYPE.COLUMNROWHEADER)){window.getSelection().empty()}var u=window.getSelection().toString();if(!e.shiftKey&&u.length>0&&u!=="\n"){l.debug("DOM Selection detected -> Click event on table skipped, Target: "+e.target);return}if(!this._findAndfireCellEvent(this.fireCellClick,e)){if(n.isOfType(t.CELLTYPE.COLUMNROWHEADER)){this._getSelectionPlugin().onHeaderSelectorPress()}else{a._handleClickSelection(e,o,this)}}else{e.preventDefault()}}},oncontextmenu:function(e){var i=this._getPointerExtension();if(i._bShowDefaultMenu){e.setMarked("handledByPointerExtension");delete i._bShowDefaultMenu}else if(i._bShowMenu){var o=t.Menu.openContextMenu(this,e.target,e);if(o){e.preventDefault()}e.setMarked("handledByPointerExtension");delete i._bShowMenu}else if(i._bHideMenu){e.setMarked("handledByPointerExtension");e.preventDefault();delete i._bHideMenu}}};var c=e.extend("sap.ui.table.extensions.Pointer",{_init:function(i,o,n){this._delegate=h;t.addDelegate(i,this._delegate,i);i._iLastHoveredVisibleColumnIndex=0;i._bIsColumnResizerMoving=false;i._iFirstReorderableIndex=o==e.TABLETYPES.TREE?1:0;return"PointerExtension"},_attachEvents:function(){var e=this.getTable();if(e){d.initColumnTracking(e);f.initRowHovering(e)}},_detachEvents:function(){var e=this.getTable();if(e){var t=e.$();t.find(".sapUiTableCtrlScr, .sapUiTableCtrlScrFixed").off();t.find(".sapUiTableCtrl > tbody > tr").off();t.find(".sapUiTableRowSelectionCell").off()}},_debug:function(){this._ExtensionHelper=a;this._ColumnResizeHelper=d;this._ReorderHelper=u;this._ExtensionDelegate=h;this._RowHoverHandler=f;this._KNOWNCLICKABLECONTROLS=r},doAutoResizeColumn:function(e){var t=this.getTable();if(t){d.doAutoResizeColumn(t,e)}},doReorderColumn:function(e,i){var o=this.getTable();if(o&&t.Column.isColumnMovable(o.getColumns()[e])){o._mTimeouts.delayedColumnReorderTimerId=setTimeout(function(){u.initReordering(this,e,i)}.bind(o),200)}},destroy:function(){var t=this.getTable();if(t){t.removeEventDelegate(this._delegate)}this._delegate=null;e.prototype.destroy.apply(this,arguments)}});return c});
//# sourceMappingURL=Pointer.js.map